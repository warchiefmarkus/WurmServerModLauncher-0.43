/*       */ package com.wurmonline.server.creatures;
/*       */ import com.wurmonline.common.BuildProperties;
/*       */ import com.wurmonline.communication.SimpleConnectionListener;
/*       */ import com.wurmonline.communication.SocketConnection;
/*       */ import com.wurmonline.math.Vector3f;
/*       */ import com.wurmonline.mesh.Tiles;
/*       */ import com.wurmonline.server.Constants;
/*       */ import com.wurmonline.server.Eigc;
/*       */ import com.wurmonline.server.EigcClient;
/*       */ import com.wurmonline.server.FailedException;
/*       */ import com.wurmonline.server.Features;
/*       */ import com.wurmonline.server.Items;
/*       */ import com.wurmonline.server.LoginHandler;
/*       */ import com.wurmonline.server.LoginServerWebConnection;
/*       */ import com.wurmonline.server.Message;
/*       */ import com.wurmonline.server.MiscConstants;
/*       */ import com.wurmonline.server.NoSuchItemException;
/*       */ import com.wurmonline.server.NoSuchPlayerException;
/*       */ import com.wurmonline.server.Players;
/*       */ import com.wurmonline.server.Point;
/*       */ import com.wurmonline.server.Point4f;
/*       */ import com.wurmonline.server.Server;
/*       */ import com.wurmonline.server.ServerEntry;
/*       */ import com.wurmonline.server.ServerTweaksHandler;
/*       */ import com.wurmonline.server.Servers;
/*       */ import com.wurmonline.server.Team;
/*       */ import com.wurmonline.server.TimeConstants;
/*       */ import com.wurmonline.server.WurmCalendar;
/*       */ import com.wurmonline.server.WurmHarvestables;
/*       */ import com.wurmonline.server.WurmId;
/*       */ import com.wurmonline.server.banks.Bank;
/*       */ import com.wurmonline.server.banks.Banks;
/*       */ import com.wurmonline.server.behaviours.ActionEntry;
/*       */ import com.wurmonline.server.behaviours.Actions;
/*       */ import com.wurmonline.server.behaviours.BehaviourDispatcher;
/*       */ import com.wurmonline.server.behaviours.BuildAllMaterials;
/*       */ import com.wurmonline.server.behaviours.BuildMaterial;
/*       */ import com.wurmonline.server.behaviours.BuildStageMaterials;
/*       */ import com.wurmonline.server.behaviours.CargoTransportationMethods;
/*       */ import com.wurmonline.server.behaviours.CaveWallBehaviour;
/*       */ import com.wurmonline.server.behaviours.CreatureBehaviour;
/*       */ import com.wurmonline.server.behaviours.Fish;
/*       */ import com.wurmonline.server.behaviours.FishEnums;
/*       */ import com.wurmonline.server.behaviours.Methods;
/*       */ import com.wurmonline.server.behaviours.MethodsFishing;
/*       */ import com.wurmonline.server.behaviours.MethodsItems;
/*       */ import com.wurmonline.server.behaviours.MethodsStructure;
/*       */ import com.wurmonline.server.behaviours.NoSuchActionException;
/*       */ import com.wurmonline.server.behaviours.NoSuchBehaviourException;
/*       */ import com.wurmonline.server.behaviours.Seat;
/*       */ import com.wurmonline.server.behaviours.Terraforming;
/*       */ import com.wurmonline.server.behaviours.Vehicle;
/*       */ import com.wurmonline.server.behaviours.Vehicles;
/*       */ import com.wurmonline.server.bodys.Wound;
/*       */ import com.wurmonline.server.combat.CombatMove;
/*       */ import com.wurmonline.server.deities.Deities;
/*       */ import com.wurmonline.server.deities.Deity;
/*       */ import com.wurmonline.server.economy.Change;
/*       */ import com.wurmonline.server.economy.Economy;
/*       */ import com.wurmonline.server.economy.MonetaryConstants;
/*       */ import com.wurmonline.server.endgames.EndGameItems;
/*       */ import com.wurmonline.server.epic.CollectedValreiItem;
/*       */ import com.wurmonline.server.epic.EpicServerStatus;
/*       */ import com.wurmonline.server.epic.EpicXmlWriter;
/*       */ import com.wurmonline.server.epic.ValreiFightHistory;
/*       */ import com.wurmonline.server.epic.ValreiFightHistoryManager;
/*       */ import com.wurmonline.server.epic.ValreiMapData;
/*       */ import com.wurmonline.server.highways.ClosestVillage;
/*       */ import com.wurmonline.server.highways.HighwayPos;
/*       */ import com.wurmonline.server.highways.MethodsHighways;
/*       */ import com.wurmonline.server.highways.Node;
/*       */ import com.wurmonline.server.highways.Route;
/*       */ import com.wurmonline.server.highways.Routes;
/*       */ import com.wurmonline.server.intra.PlayerTransfer;
/*       */ import com.wurmonline.server.items.CreationEntryCreator;
/*       */ import com.wurmonline.server.items.CreationWindowMethods;
/*       */ import com.wurmonline.server.items.DbItem;
/*       */ import com.wurmonline.server.items.Ingredient;
/*       */ import com.wurmonline.server.items.IngredientGroup;
/*       */ import com.wurmonline.server.items.Item;
/*       */ import com.wurmonline.server.items.ItemFactory;
/*       */ import com.wurmonline.server.items.ItemTemplate;
/*       */ import com.wurmonline.server.items.ItemTemplateFactory;
/*       */ import com.wurmonline.server.items.ItemTypes;
/*       */ import com.wurmonline.server.items.NoSuchTemplateException;
/*       */ import com.wurmonline.server.items.NotOwnedException;
/*       */ import com.wurmonline.server.items.Recipe;
/*       */ import com.wurmonline.server.items.Recipes;
/*       */ import com.wurmonline.server.items.RecipesByPlayer;
/*       */ import com.wurmonline.server.items.Trade;
/*       */ import com.wurmonline.server.items.TradingWindow;
/*       */ import com.wurmonline.server.items.WurmColor;
/*       */ import com.wurmonline.server.items.WurmMail;
/*       */ import com.wurmonline.server.kingdom.King;
/*       */ import com.wurmonline.server.kingdom.Kingdom;
/*       */ import com.wurmonline.server.kingdom.Kingdoms;
/*       */ import com.wurmonline.server.players.Achievement;
/*       */ import com.wurmonline.server.players.AchievementTemplate;
/*       */ import com.wurmonline.server.players.Achievements;
/*       */ import com.wurmonline.server.players.Ban;
/*       */ import com.wurmonline.server.players.Cults;
/*       */ import com.wurmonline.server.players.Friend;
/*       */ import com.wurmonline.server.players.KingdomIp;
/*       */ import com.wurmonline.server.players.MapAnnotation;
/*       */ import com.wurmonline.server.players.PendingAccount;
/*       */ import com.wurmonline.server.players.Player;
/*       */ import com.wurmonline.server.players.PlayerInfo;
/*       */ import com.wurmonline.server.players.PlayerInfoFactory;
/*       */ import com.wurmonline.server.players.PlayerJournal;
/*       */ import com.wurmonline.server.players.PlayerState;
/*       */ import com.wurmonline.server.players.SteamIdBan;
/*       */ import com.wurmonline.server.players.Titles;
/*       */ import com.wurmonline.server.players.WurmRecord;
/*       */ import com.wurmonline.server.questions.AlertServerMessageQuestion;
/*       */ import com.wurmonline.server.questions.ChangeEmailQuestion;
/*       */ import com.wurmonline.server.questions.GMForceSpawnRiftLootQuestion;
/*       */ import com.wurmonline.server.questions.InGameVoteQuestion;
/*       */ import com.wurmonline.server.questions.NewsInfo;
/*       */ import com.wurmonline.server.questions.NoSuchQuestionException;
/*       */ import com.wurmonline.server.questions.PersonalGoalsListQuestion;
/*       */ import com.wurmonline.server.questions.PortalQuestion;
/*       */ import com.wurmonline.server.questions.Question;
/*       */ import com.wurmonline.server.questions.Questions;
/*       */ import com.wurmonline.server.questions.RedeemQuestion;
/*       */ import com.wurmonline.server.questions.RemoveItemQuestion;
/*       */ import com.wurmonline.server.questions.SimplePopup;
/*       */ import com.wurmonline.server.questions.SkillProgressQuestion;
/*       */ import com.wurmonline.server.questions.SuicideQuestion;
/*       */ import com.wurmonline.server.questions.TeamManagementQuestion;
/*       */ import com.wurmonline.server.questions.TitleCompoundQuestion;
/*       */ import com.wurmonline.server.questions.TitleQuestion;
/*       */ import com.wurmonline.server.questions.TransferQuestion;
/*       */ import com.wurmonline.server.questions.VillageJoinQuestion;
/*       */ import com.wurmonline.server.questions.VillageTeleportQuestion;
/*       */ import com.wurmonline.server.questions.WurmInfo;
/*       */ import com.wurmonline.server.questions.WurmInfo2;
/*       */ import com.wurmonline.server.skills.Affinities;
/*       */ import com.wurmonline.server.skills.Affinity;
/*       */ import com.wurmonline.server.skills.NoSuchSkillException;
/*       */ import com.wurmonline.server.skills.Skill;
/*       */ import com.wurmonline.server.skills.SkillSystem;
/*       */ import com.wurmonline.server.sounds.Sound;
/*       */ import com.wurmonline.server.sounds.SoundPlayer;
/*       */ import com.wurmonline.server.spells.SpellEffect;
/*       */ import com.wurmonline.server.statistics.ChallengeSummary;
/*       */ import com.wurmonline.server.steam.SteamId;
/*       */ import com.wurmonline.server.structures.Blocking;
/*       */ import com.wurmonline.server.structures.BlockingResult;
/*       */ import com.wurmonline.server.structures.BridgePart;
/*       */ import com.wurmonline.server.structures.BridgePartEnum;
/*       */ import com.wurmonline.server.structures.Door;
/*       */ import com.wurmonline.server.structures.Fence;
/*       */ import com.wurmonline.server.structures.FenceGate;
/*       */ import com.wurmonline.server.structures.Floor;
/*       */ import com.wurmonline.server.structures.NoSuchStructureException;
/*       */ import com.wurmonline.server.structures.NoSuchWallException;
/*       */ import com.wurmonline.server.structures.RoofFloorEnum;
/*       */ import com.wurmonline.server.structures.Structure;
/*       */ import com.wurmonline.server.structures.Structures;
/*       */ import com.wurmonline.server.structures.Wall;
/*       */ import com.wurmonline.server.support.Ticket;
/*       */ import com.wurmonline.server.support.TicketAction;
/*       */ import com.wurmonline.server.support.Tickets;
/*       */ import com.wurmonline.server.support.Trello;
/*       */ import com.wurmonline.server.tutorial.Mission;
/*       */ import com.wurmonline.server.tutorial.PlayerTutorial;
/*       */ import com.wurmonline.server.utils.CreatureLineSegment;
/*       */ import com.wurmonline.server.utils.StringUtil;
/*       */ import com.wurmonline.server.villages.Citizen;
/*       */ import com.wurmonline.server.villages.NoSuchVillageException;
/*       */ import com.wurmonline.server.villages.PvPAlliance;
/*       */ import com.wurmonline.server.villages.RecruitmentAd;
/*       */ import com.wurmonline.server.villages.RecruitmentAds;
/*       */ import com.wurmonline.server.villages.Village;
/*       */ import com.wurmonline.server.villages.VillageRecruitee;
/*       */ import com.wurmonline.server.villages.VillageRole;
/*       */ import com.wurmonline.server.villages.Villages;
/*       */ import com.wurmonline.server.webinterface.WCGmMessage;
/*       */ import com.wurmonline.server.webinterface.WcAddFriend;
/*       */ import com.wurmonline.server.webinterface.WcCAHelpGroupMessage;
/*       */ import com.wurmonline.server.webinterface.WcDemotion;
/*       */ import com.wurmonline.server.webinterface.WcGVHelpMessage;
/*       */ import com.wurmonline.server.webinterface.WcGetHeroes;
/*       */ import com.wurmonline.server.webinterface.WcGlobalIgnore;
/*       */ import com.wurmonline.server.webinterface.WcGlobalModeration;
/*       */ import com.wurmonline.server.webinterface.WcKingdomChat;
/*       */ import com.wurmonline.server.webinterface.WcMgmtMessage;
/*       */ import com.wurmonline.server.webinterface.WcOpenEpicPortal;
/*       */ import com.wurmonline.server.webinterface.WcRefreshCommand;
/*       */ import com.wurmonline.server.webinterface.WcResetCommand;
/*       */ import com.wurmonline.server.webinterface.WcSetPower;
/*       */ import com.wurmonline.server.webinterface.WcTradeChannel;
/*       */ import com.wurmonline.server.zones.Den;
/*       */ import com.wurmonline.server.zones.Dens;
/*       */ import com.wurmonline.server.zones.ErrorChecks;
/*       */ import com.wurmonline.server.zones.NoSuchZoneException;
/*       */ import com.wurmonline.server.zones.TilePoller;
/*       */ import com.wurmonline.server.zones.VolaTile;
/*       */ import com.wurmonline.server.zones.Water;
/*       */ import com.wurmonline.server.zones.Zone;
/*       */ import com.wurmonline.server.zones.Zones;
/*       */ import com.wurmonline.server.zones.ZonesUtility;
/*       */ import com.wurmonline.shared.constants.CounterTypes;
/*       */ import com.wurmonline.shared.constants.ObjectTypeConstants;
/*       */ import com.wurmonline.shared.constants.PlayerOnlineStatus;
/*       */ import com.wurmonline.shared.constants.ProtoConstants;
/*       */ import com.wurmonline.shared.constants.StructureConstants;
/*       */ import com.wurmonline.shared.constants.StructureConstantsEnum;
/*       */ import com.wurmonline.shared.constants.StructureTypeEnum;
/*       */ import com.wurmonline.shared.constants.ValreiConstants;
/*       */ import com.wurmonline.shared.constants.WallConstants;
/*       */ import com.wurmonline.shared.util.ItemTypeUtilites;
/*       */ import com.wurmonline.shared.util.MulticolorLineSegment;
/*       */ import com.wurmonline.shared.util.StringUtilities;
/*       */ import java.awt.Color;
/*       */ import java.io.BufferedReader;
/*       */ import java.io.ByteArrayOutputStream;
/*       */ import java.io.DataOutputStream;
/*       */ import java.io.File;
/*       */ import java.io.FileReader;
/*       */ import java.io.IOException;
/*       */ import java.io.UnsupportedEncodingException;
/*       */ import java.math.BigInteger;
/*       */ import java.nio.ByteBuffer;
/*       */ import java.sql.Date;
/*       */ import java.text.DateFormat;
/*       */ import java.text.DecimalFormat;
/*       */ import java.util.ArrayList;
/*       */ import java.util.Collection;
/*       */ import java.util.Date;
/*       */ import java.util.HashMap;
/*       */ import java.util.HashSet;
/*       */ import java.util.Iterator;
/*       */ import java.util.LinkedList;
/*       */ import java.util.List;
/*       */ import java.util.Map;
/*       */ import java.util.NoSuchElementException;
/*       */ import java.util.Optional;
/*       */ import java.util.Properties;
/*       */ import java.util.Set;
/*       */ import java.util.StringTokenizer;
/*       */ import java.util.logging.Level;
/*       */ import java.util.logging.Logger;
/*       */ import java.util.regex.Matcher;
/*       */ import java.util.regex.Pattern;
/*       */ import javax.annotation.Nullable;
/*       */ 
/*       */ public abstract class Communicator implements SimpleConnectionListener, ProtoConstants, StructureConstants, ObjectTypeConstants, TimeConstants, MiscConstants, ItemTypes, CounterTypes, MonetaryConstants {
/*       */   public Player player;
/*       */   private boolean ready = false;
/*   251 */   private static boolean gchatdisabled = Servers.localServer.isChallengeServer();
/*       */   
/*       */   protected boolean justLoggedIn = true;
/*       */   
/*       */   private SocketConnection connection;
/*       */   
/*       */   private static boolean acceptsBoatTransfers = true;
/*       */   
/*   259 */   private static final Logger logger = Logger.getLogger(Communicator.class.getName());
/*       */   
/*   261 */   private static final Logger chatlogger = Logger.getLogger("Chat");
/*       */   
/*   263 */   private MovementScheme ticker = null;
/*       */   
/*   265 */   private int messagesReceived = 0;
/*       */   
/*   267 */   private static final int firstBorder = (1 << Constants.meshSize) - 40;
/*       */   
/*   269 */   private static final int secondBorder = (1 << Constants.meshSize) - 20;
/*       */   
/*   271 */   private static final int finalBorder = (1 << Constants.meshSize) - 2;
/*       */   
/*       */   private static final int serverBorderStart = 0;
/*       */   
/*   275 */   private static final int serverBorderEnd = 1 << Constants.meshSize;
/*       */   
/*   277 */   private static final float maxMapSize = (((1 << Constants.meshSize) - 1) * 4);
/*       */ 
/*       */   
/*       */   private static final String DARK_SHADOW_STRING = "You see dark shadows moving beneath the waves.";
/*       */ 
/*       */   
/*       */   private static final String ENORMOUS_SHARK_STRING = "An enourmous shark scouts you from below.";
/*       */   
/*       */   private static final String IMPOS_CURRENT_STRING = "The currents work against you and you get nowhere.";
/*       */   
/*       */   private static final String FINAL_CURRENT_STRING = "You head out to sea.";
/*       */   
/*       */   private static final String UNAVAILABLE_SERVER_STRING = "The waves are too high to keep going in that direction right now. (The server is unavailable)";
/*       */   
/*       */   private static final String HIC = "*hic*";
/*       */   
/*       */   private static final String BURP = "*burp*";
/*       */   
/*       */   private static final String HIC2 = "*HIC*";
/*       */   
/*       */   private static final String BURP2 = "*BURP*";
/*       */   
/*       */   private static final String HRR = "HRR";
/*       */   
/*       */   private static final String HSS = "HSS";
/*       */   
/*       */   private static final String UUH = "UUH";
/*       */   
/*       */   private static final String GHH = "GHH*";
/*       */   
/*   307 */   protected static final byte[] local = ":Local".getBytes();
/*       */   
/*   309 */   protected static final byte[] event = ":Event".getBytes();
/*       */   
/*   311 */   protected static final byte[] system = ":System".getBytes();
/*       */   
/*   313 */   protected static final byte[] help = ":Help".getBytes();
/*       */   
/*   315 */   protected static final byte[] team = "Team".getBytes();
/*       */   
/*   317 */   protected static final byte[] friends = ":Friends".getBytes();
/*       */   
/*   319 */   protected static final byte[] village = "Village".getBytes();
/*       */   
/*   321 */   protected static final byte[] alliance = "Alliance".getBytes();
/*   322 */   protected static final byte[] combat = ":Combat".getBytes();
/*       */   
/*   324 */   private static final byte[] deaths = ":Deaths".getBytes();
/*       */   
/*   326 */   private static final byte[] logs = ":Logs".getBytes();
/*       */   
/*   328 */   private long timeMod = 0L;
/*       */   
/*       */   public static final String GM = "GM";
/*       */   
/*   332 */   protected static final byte[] gms = "GM".getBytes();
/*       */   
/*       */   public static final String MGMT = "MGMT";
/*       */   
/*   336 */   private static final byte[] mgmt = "MGMT".getBytes();
/*       */   
/*   338 */   private static final byte[] pas = "CA HELP".getBytes();
/*       */   
/*   340 */   private long lastToggledPA = 0L;
/*       */   
/*       */   private ServerEntry lastTargetServerChecked;
/*       */   
/*       */   private boolean shouldSendTradeAgree = false;
/*       */   
/*       */   private boolean tradeAgreeToSend = false;
/*       */   
/*   348 */   private static byte[] myIp = Server.getInstance().getExternalIp();
/*       */   
/*   350 */   private final byte[] reportedIp = new byte[] { 0, 0, 0, 0 };
/*       */ 
/*       */   
/*       */   private boolean setCheatedIp = false;
/*       */   
/*       */   private int ipPointer;
/*       */   
/*   357 */   private final DateFormat df = DateFormat.getTimeInstance();
/*       */   
/*   359 */   private long newSeed = (Server.rand.nextInt() & Integer.MAX_VALUE);
/*       */   
/*   361 */   private int newSeedPointer = 0;
/*       */   
/*       */   private boolean invulnerable = true;
/*       */   
/*   365 */   private static final DecimalFormat twoDecimals = new DecimalFormat("##0.00");
/*       */   
/*   367 */   private PlayerMove currentmove = null;
/*       */   
/*   369 */   private int availableMoves = 0;
/*       */ 
/*       */ 
/*       */   
/*   373 */   private int newHeightOffset = -10000;
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private boolean changeHeightImmediately = false;
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private boolean setWeather = false;
/*       */ 
/*       */ 
/*       */   
/*   387 */   private int moves = 0;
/*       */   
/*       */   private boolean receivedTicks = false;
/*       */   
/*   391 */   private int lastLayer = 0;
/*       */   
/*   393 */   private long[] subjectIds = null;
/*       */   
/*   395 */   private Set<Item> coins = null;
/*       */   
/*   397 */   private Item subjectItem = null;
/*       */   
/*       */   private boolean shouldSendWeather = false;
/*       */   
/*   401 */   private static int numcommands = 0;
/*       */   
/*   403 */   private static int prevcommand = 0;
/*       */   
/*   405 */   private static int lastcommand = 0;
/*       */   
/*   407 */   private static long commandAction = 0L;
/*       */   
/*   409 */   private int commandsThisSecond = 0;
/*       */   
/*   411 */   private static String commandMessage = "";
/*       */   
/*   413 */   private byte wroteip = 0;
/*       */   
/*       */   private static final float woundMultiplier = 0.0015259022F;
/*       */   
/*   417 */   private static final int emptyRock = Tiles.encode((short)-100, Tiles.Tile.TILE_CAVE_WALL.id, (byte)0);
/*       */ 
/*       */   
/*       */   private byte[] passengerData;
/*       */   
/*       */   private byte[] vehicleData;
/*       */   
/*   424 */   public long lastChangedEmail = 0L;
/*       */ 
/*       */ 
/*       */   
/*       */   protected static final String CHARSET_ENCODING_FOR_COMMS = "UTF-8";
/*       */ 
/*       */ 
/*       */   
/*       */   private static final String THE = "The ";
/*       */ 
/*       */   
/*       */   private float lastX;
/*       */ 
/*       */   
/*       */   private float lastY;
/*       */ 
/*       */   
/*       */   private float lastZ;
/*       */ 
/*       */   
/*   444 */   private int lastCounts = 0;
/*       */   
/*   446 */   private int numberSpeedModsSent = 0;
/*       */   
/*       */   private static boolean hasCreated = false;
/*       */   
/*   450 */   private int spamSeconds = 0;
/*       */ 
/*       */   
/*       */   private static final long snipeTime = 900000L;
/*       */   
/*   455 */   private static int muteMsgRed = 255;
/*   456 */   private static int muteMsgGreen = 201;
/*   457 */   private static int muteMsgBlue = 14;
/*       */   
/*       */   private boolean receivedBridgeChange = false;
/*   460 */   private long newBridgeId = -10L;
/*       */   
/*   462 */   public String macAddr = "Not reported";
/*       */   
/*       */   private boolean sentFirstWarning;
/*       */   
/*       */   private boolean sentSecondWarning;
/*       */   
/*   468 */   long lastTicked = System.currentTimeMillis();
/*       */ 
/*       */ 
/*       */   
/*       */   public final void resetCounters() {
/*   473 */     float diffMod = (float)(System.currentTimeMillis() - this.lastTicked) / 1000.0F;
/*   474 */     this.lastTicked = System.currentTimeMillis();
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/*   480 */     setAvailableMoves((int)(25.0F * diffMod));
/*   481 */     this.messagesReceived = 0;
/*   482 */     if (this.commandsThisSecond > 50) {
/*   483 */       logWarn(this.player.getName() + " number of commands sent:" + this.commandsThisSecond);
/*       */     }
/*   485 */     if (this.numberSpeedModsSent > 10)
/*       */     {
/*   487 */       logWarn(this.player.getName() + " number of speedmods sent:" + this.numberSpeedModsSent);
/*       */     }
/*   489 */     this.numberSpeedModsSent = 0;
/*   490 */     if (this.commandsThisSecond > 10) {
/*   491 */       this.spamSeconds++;
/*       */     } else {
/*   493 */       this.spamSeconds--;
/*   494 */     }  if (this.spamSeconds >= 3)
/*       */     {
/*   496 */       if (this.player != null) {
/*       */         
/*   498 */         logInfo(this.player.getName() + " SPAMMING " + this.commandsThisSecond + ". This is second " + this.spamSeconds + ". Disconnecting.");
/*       */         
/*   500 */         this.player.logoutIn(5, "Spamming the server.");
/*       */       } 
/*       */     }
/*   503 */     this.commandsThisSecond = 0;
/*   504 */     numcommands = 0;
/*   505 */     lastcommand = 0;
/*   506 */     prevcommand = 0;
/*   507 */     commandAction = 0L;
/*   508 */     commandMessage = "";
/*       */   }
/*       */ 
/*       */   
/*       */   public void tickSecond() {
/*   513 */     resetCounters();
/*   514 */     if (this.shouldSendTradeAgree)
/*   515 */       reallySendTradeAgree(); 
/*   516 */     checkSendWeather();
/*   517 */     this.player.getMovementScheme().setErrors(0);
/*       */   }
/*       */ 
/*       */   
/*       */   public Communicator(Player aPlayer, SocketConnection conn) {
/*   522 */     this.player = aPlayer;
/*   523 */     this.connection = conn;
/*   524 */     this.ticker = aPlayer.getMovementScheme();
/*   525 */     if (aPlayer.isFighting()) {
/*   526 */       this.invulnerable = false;
/*       */     }
/*       */   }
/*       */   
/*       */   Communicator() {
/*   531 */     this.player = null;
/*   532 */     this.connection = null;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public SocketConnection getConnection() {
/*   541 */     return this.connection;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public final void resetConnection() {
/*   549 */     this.connection = null;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public final void resetTicker() {
/*   557 */     this.ticker = null;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void setReady(boolean aReady) {
/*   567 */     this.ready = aReady;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void disconnect() {
/*   577 */     if (this.connection != null) {
/*       */       
/*       */       try {
/*       */         
/*   581 */         this.connection.disconnect();
/*   582 */         this.connection.closeChannel();
/*   583 */         if (this.player != null)
/*   584 */           this.player.setLink(false); 
/*   585 */         this.ticker = null;
/*       */         
/*   587 */         if (this.currentmove != null)
/*   588 */           this.currentmove.clear(false, this.ticker, this.player, null); 
/*   589 */         this.currentmove = null;
/*       */       }
/*   591 */       catch (Exception ex) {
/*       */         
/*   593 */         logInfo("Problem while disconnecting player: " + this.player + " - " + ex.getMessage(), ex);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   protected ByteBuffer getBuffer() {
/*   607 */     return this.connection.getBuffer();
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   protected void flushConnectionOrAddToQueue(ByteBuffer aByteBuffer) throws IOException {
/*   623 */     this.connection.flush();
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void movePlayer() {
/*   631 */     if (this.currentmove == null) {
/*       */       
/*   633 */       this.moves--;
/*       */       return;
/*       */     } 
/*   636 */     this.moves--;
/*   637 */     this.currentmove.setHandled(true);
/*   638 */     if (!this.player.isDead()) {
/*       */       
/*       */       try {
/*   641 */         if (!this.player.isTeleporting() && !this.player.getMovementScheme().isIntraTeleporting() && 
/*   642 */           !this.player.isTransferring()) {
/*       */           
/*   644 */           float oldPosX = this.player.getStatus().getPositionX();
/*   645 */           float oldPosY = this.player.getStatus().getPositionY();
/*   646 */           float oldPosZ = this.player.getStatus().getPositionZ();
/*   647 */           float oldRot = this.player.getStatus().getRotation();
/*       */           
/*   649 */           if ((this.player.vehicle == -10L || this.player.isVehicleCommander()) && (oldPosX != this.currentmove
/*   650 */             .getNewPosX() || oldPosY != this.currentmove.getNewPosY() || oldPosZ != this.currentmove
/*   651 */             .getNewPosZ())) {
/*       */ 
/*       */ 
/*       */             
/*   655 */             if (this.currentmove.getNewPosX() <= 0.0F || this.currentmove.getNewPosY() >= maxMapSize || this.currentmove
/*   656 */               .getNewPosY() <= 0.0F || this.currentmove.getNewPosX() >= maxMapSize) {
/*       */ 
/*       */               
/*   659 */               this.player.getStatus().getPosition().setBridgeId(-10L);
/*   660 */               this.player.getMovementScheme().setBridgeId(-10L);
/*   661 */               this.player.intraTeleport(oldPosX, oldPosY, oldPosZ, oldRot, this.lastLayer, "out of bounds: " + this.currentmove
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                   
/*   667 */                   .getNewPosX() + ',' + this.currentmove
/*   668 */                   .getNewPosY() + " vehicle=" + this.player.vehicle + " commander=" + this.player
/*   669 */                   .isVehicleCommander());
/*   670 */               this.player.setKickedOffBoat(true);
/*       */               return;
/*       */             } 
/*   673 */             int oldTileX = (int)oldPosX >> 2;
/*   674 */             int oldTileY = (int)oldPosY >> 2;
/*   675 */             int newTileX = (int)this.currentmove.getNewPosX() >> 2;
/*   676 */             int newTileY = (int)this.currentmove.getNewPosY() >> 2;
/*       */             
/*   678 */             int diffTileX = newTileX - oldTileX;
/*   679 */             int diffTileY = newTileY - oldTileY;
/*       */ 
/*       */             
/*   682 */             if (diffTileX != 0 || diffTileY != 0) {
/*       */               
/*   684 */               if (Math.abs(diffTileX) > 1 || Math.abs(diffTileY) > 1)
/*       */               {
/*   686 */                 if (!this.justLoggedIn) {
/*       */                   
/*   688 */                   this.player.intraTeleport(oldPosX, oldPosY, oldPosZ, oldRot, this.lastLayer, "many tiles - x:" + diffTileX + ", y:" + diffTileY + " nposx=" + this.currentmove
/*   689 */                       .getNewPosX() + ", nposy=" + this.currentmove
/*   690 */                       .getNewPosY());
/*       */ 
/*       */ 
/*       */                   
/*       */                   return;
/*       */                 } 
/*       */               }
/*       */ 
/*       */ 
/*       */               
/*   700 */               boolean nextToSurface = (this.lastLayer < 0);
/*   701 */               if (nextToSurface) {
/*       */ 
/*       */                 
/*   704 */                 nextToSurface = false;
/*   705 */                 if (this.player.getMovementScheme().getTextureForTile(oldTileX, oldTileY, this.lastLayer, -10L) == Tiles.Tile.TILE_CAVE_EXIT.id && 
/*   706 */                   Tiles.isSolidCave(Tiles.decodeType(Server.caveMesh.getTile(diffTileX + oldTileX, diffTileY + oldTileY)))) {
/*       */ 
/*       */ 
/*       */ 
/*       */                   
/*   711 */                   nextToSurface = true;
/*   712 */                   if (this.currentmove.getLayer() >= 0 && this.player.getLayer() < 0 && this.lastLayer < 0) {
/*       */                     
/*   714 */                     this.player.intraTeleport(oldPosX, oldPosY, oldPosZ, oldRot, this.lastLayer, "illegal exit");
/*       */ 
/*       */                     
/*       */                     return;
/*       */                   } 
/*       */                 } 
/*       */               } 
/*       */               
/*   722 */               if (nextToSurface) {
/*       */ 
/*       */ 
/*       */                 
/*   726 */                 BlockingResult result = Blocking.getBlockerBetween((Creature)getPlayer(), oldPosX, oldPosY, this.currentmove
/*   727 */                     .getNewPosX(), this.currentmove.getNewPosY(), this.player.getPositionZ(), 
/*   728 */                     Zones.calculateHeight(this.currentmove.getNewPosX(), this.currentmove.getNewPosY(), true), true, true, false, 6, -1L, this.player
/*   729 */                     .getBridgeId(), this.player.getBridgeId(), true);
/*       */                 
/*   731 */                 if (result != null) {
/*       */ 
/*       */ 
/*       */ 
/*       */                   
/*   736 */                   this.player.intraTeleport(oldPosX, oldPosY, oldPosZ, oldRot, this.lastLayer, "blocked by " + result
/*   737 */                       .getFirstBlocker().getName());
/*       */ 
/*       */                   
/*       */                   return;
/*       */                 } 
/*       */               } 
/*       */               
/*   744 */               if (!this.player.getMovementScheme().isFlying() || this.player.getPower() <= 1) {
/*       */                 
/*   746 */                 BlockingResult result = Blocking.getBlockerBetween((Creature)getPlayer(), (2 + oldTileX * 4), (2 + oldTileY * 4), this.currentmove
/*   747 */                     .getNewPosX(), this.currentmove.getNewPosY(), this.player
/*   748 */                     .getPositionZ(), this.player.getPositionZ(), this.player.isOnSurface(), this.player
/*   749 */                     .isOnSurface(), false, 6, -1L, this.player.getBridgeId(), this.player
/*   750 */                     .getBridgeId(), this.player.followsGround());
/*   751 */                 if (result != null) {
/*       */                   
/*   753 */                   this.player.intraTeleport(oldPosX, oldPosY, oldPosZ, oldRot, this.lastLayer, "blocked by " + result
/*   754 */                       .getFirstBlocker().getName());
/*       */ 
/*       */ 
/*       */ 
/*       */                   
/*       */                   return;
/*       */                 } 
/*       */               } 
/*       */ 
/*       */ 
/*       */ 
/*       */               
/*   766 */               if (checkLegalTileMove(newTileX, newTileY, diffTileX, diffTileY)) {
/*       */ 
/*       */                 
/*   769 */                 if (!this.player.isDead()) {
/*       */                   
/*   771 */                   if (this.player.getVehicle() == -10L)
/*   772 */                     this.player.transferCounter = 30; 
/*   773 */                   if (!this.player.isTransferring()) {
/*       */                     
/*   775 */                     this.player.intraTeleport(oldPosX, oldPosY, oldPosZ, oldRot, this.lastLayer, "at transfer border");
/*   776 */                     this.player.setKickedOffBoat(true);
/*       */                   } 
/*       */                 } 
/*       */                 
/*       */                 return;
/*       */               } 
/*       */             } 
/*   783 */             float diffX = this.currentmove.getNewPosX() - oldPosX;
/*   784 */             float diffY = this.currentmove.getNewPosY() - oldPosY;
/*   785 */             float diffZ = this.currentmove.getNewPosZ() - oldPosZ;
/*       */ 
/*       */             
/*   788 */             this.player.getStatus().setRotation(this.currentmove.getNewRot());
/*       */ 
/*       */ 
/*       */             
/*   792 */             if (Math.abs(diffZ) > 10.0F)
/*       */             {
/*   794 */               if (diffX != 0.0F || diffY != 0.0F) {
/*       */                 
/*   796 */                 if (diffTileX == 0 && diffTileY == 0) {
/*       */                   
/*   798 */                   boolean setvisible = this.player.isVisible();
/*   799 */                   this.player.setVisible(false);
/*   800 */                   this.player.getStatus().setPositionX(this.currentmove.getNewPosX());
/*   801 */                   this.player.getStatus().setPositionY(this.currentmove.getNewPosY());
/*   802 */                   this.player.getStatus().setPositionZ(this.currentmove.getNewPosZ());
/*       */                   
/*   804 */                   if (setvisible) {
/*   805 */                     this.player.setVisible(true);
/*       */                   }
/*       */                   
/*       */                   return;
/*       */                 } 
/*   810 */                 this.player.destroyVisionArea();
/*       */ 
/*       */                 
/*       */                 try {
/*   814 */                   Zone z = Zones.getZone(this.player.getTileX(), this.player.getTileY(), this.player.isOnSurface());
/*   815 */                   z.deleteCreature((Creature)this.player, true);
/*       */                 }
/*   817 */                 catch (NoSuchZoneException nsz) {
/*       */                   
/*   819 */                   sendAlertServerMessage("You are out of bounds. Disconnecting in 5.");
/*   820 */                   this.player.logoutIn(5, "You were out of bounds.");
/*       */                   return;
/*       */                 } 
/*   823 */                 this.player.getStatus().setPositionX(this.currentmove.getNewPosX());
/*   824 */                 this.player.getStatus().setPositionY(this.currentmove.getNewPosY());
/*   825 */                 this.player.getStatus().setPositionZ(this.currentmove.getNewPosZ());
/*       */                 
/*   827 */                 this.player.createVisionArea();
/*   828 */                 this.player.getVisionArea().getSurface().initialize();
/*   829 */                 this.player.getVisionArea().getUnderGround().initialize();
/*       */ 
/*       */ 
/*       */                 
/*       */                 try {
/*   834 */                   Zone z = Zones.getZone(this.player.getTileX(), this.player.getTileY(), this.player.isOnSurface());
/*   835 */                   z.addCreature(this.player.getWurmId());
/*       */                 }
/*   837 */                 catch (NoSuchZoneException nsz) {
/*       */                   
/*   839 */                   sendAlertServerMessage("You are out of bounds. Disconnecting in 5.");
/*   840 */                   this.player.logoutIn(5, "You were out of bounds.");
/*       */ 
/*       */ 
/*       */ 
/*       */                   
/*       */                   return;
/*       */                 } 
/*       */               } else {
/*   848 */                 boolean setvisible = this.player.isVisible();
/*   849 */                 this.player.setVisible(false);
/*   850 */                 this.player.getStatus().setPositionX(this.currentmove.getNewPosX());
/*   851 */                 this.player.getStatus().setPositionY(this.currentmove.getNewPosY());
/*   852 */                 this.player.getStatus().setPositionZ(this.currentmove.getNewPosZ());
/*   853 */                 if (setvisible) {
/*   854 */                   this.player.setVisible(true);
/*       */                 }
/*       */               }
/*       */             
/*       */             }
/*       */             else
/*       */             {
/*   861 */               this.player.getStatus().setPositionX(this.currentmove.getNewPosX());
/*   862 */               this.player.getStatus().setPositionY(this.currentmove.getNewPosY());
/*   863 */               this.player.getStatus().setPositionZ(this.currentmove.getNewPosZ());
/*   864 */               this.player.moved(diffX, diffY, diffZ, diffTileX, diffTileY);
/*       */             }
/*       */           
/*   867 */           } else if (this.currentmove.getNewRot() != oldRot) {
/*       */ 
/*       */             
/*   870 */             this.player.getStatus().setRotation(this.currentmove.getNewRot());
/*   871 */             this.player.moved(0.0F, 0.0F, 0.0F, 0, 0);
/*       */           }
/*       */         
/*       */         } 
/*   875 */       } catch (Exception exception) {}
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private boolean checkMoveChanges() {
/*   885 */     return CommuincatorMoveChangeChecker.checkMoveChanges(this.currentmove, this.ticker, this.player, null);
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public static void attemptMuting(Player player, PlayerInfo pinf, boolean global, boolean ignoring) {
/*   898 */     boolean mute = false;
/*   899 */     if (player.isPaying())
/*       */     {
/*   901 */       if (System.currentTimeMillis() > (player.getSaveFile()).nextAvailableMute) {
/*       */         
/*   903 */         int hours = 1;
/*       */         
/*   905 */         if (System.currentTimeMillis() - (player.getSaveFile()).nextAvailableMute < 1800000L)
/*   906 */           hours = 2; 
/*   907 */         if (System.currentTimeMillis() - (player.getSaveFile()).nextAvailableMute < 900000L)
/*   908 */           hours = 3; 
/*   909 */         (player.getSaveFile()).nextAvailableMute = System.currentTimeMillis() + hours * 900000L + 900000L;
/*   910 */         mute = true;
/*   911 */         if (!global)
/*       */         {
/*   913 */           attemptMuting(player.getKingdomId(), pinf);
/*       */         }
/*       */       } 
/*       */     }
/*       */     
/*   918 */     if (global) {
/*       */ 
/*       */ 
/*       */       
/*   922 */       WcGlobalIgnore wgi = new WcGlobalIgnore(WurmId.getNextWCCommandId(), player.getWurmId(), player.getName(), pinf.wurmId, pinf.getName(), false, mute, false, ignoring, false, player.getKingdomId());
/*   923 */       if (Servers.isThisLoginServer()) {
/*   924 */         wgi.sendToServer(pinf.getCurrentServer());
/*       */       } else {
/*   926 */         wgi.sendToLoginServer();
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public static void attemptMuting(byte ignorerKingdom, PlayerInfo pinf) {
/*       */     try {
/*   943 */       Player online = Players.getInstance().getPlayer(pinf.wurmId);
/*   944 */       if (online.getKingdomId() == ignorerKingdom && online.getPower() <= 1 && !online.mayMute())
/*       */       {
/*   946 */         if (!pinf.isMute())
/*       */         {
/*   948 */           if (online.isActiveInChat() || online.isActiveInLocalChat())
/*       */           {
/*   950 */             if (System.currentTimeMillis() - pinf.startedReceivingMutes > 180000L) {
/*       */               
/*   952 */               pinf.startedReceivingMutes = System.currentTimeMillis();
/*   953 */               pinf.mutesReceived = 1;
/*       */             } else {
/*       */               
/*   956 */               pinf.mutesReceived = (short)(pinf.mutesReceived + 1);
/*   957 */             }  int sameKingdom = Players.getInstance().getOnlinePlayersFromKingdom(ignorerKingdom);
/*   958 */             int required = Math.max(5, (sameKingdom - 1) / 10);
/*   959 */             if (pinf.mutesReceived > required)
/*       */             {
/*   961 */               Message mess = new Message(null, (byte)3, ":Event", "Hi! You have received a one hour automated mute because a lot of people decided to ignore you at the same time. This system is new and under development so please don't take it too seriously.");
/*       */ 
/*       */ 
/*       */ 
/*       */               
/*   966 */               mess.setReceiver(online.getWurmId());
/*   967 */               Server.getInstance().addMessage(mess);
/*   968 */               online.mute(true, "One hour automated system mute by public opinion.", System.currentTimeMillis() + 3600000L);
/*       */ 
/*       */               
/*   971 */               Message mess2 = new Message(null, (byte)3, ":Event", "We understand that it may be frustrating and the reasons may not be that you misbehaved. That this system is used or abused for various reasons is expected at this point as people figure how it works.");
/*       */ 
/*       */ 
/*       */ 
/*       */               
/*   976 */               mess2.setReceiver(online.getWurmId());
/*   977 */               Server.getInstance().addMessage(mess2);
/*   978 */               Message mess3 = new Message(null, (byte)3, ":Event", "Eventually we hope that the novelty of this system should go away and people will start ignoring only when they have good reason to. If we are wrong we will have to remove this feature.");
/*       */ 
/*       */ 
/*       */ 
/*       */               
/*   983 */               mess3.setReceiver(online.getWurmId());
/*   984 */               Server.getInstance().addMessage(mess3);
/*       */               
/*   986 */               Players.addMgmtMessage("Opinion", "mutes " + pinf.getName() + " for 1 hour.");
/*   987 */               Message messM = new Message((Creature)online, (byte)9, "MGMT", "<" + online.getName() + "> is muted 1 hour by public opinion.", muteMsgRed, muteMsgGreen, muteMsgBlue);
/*       */               
/*   989 */               Server.getInstance().addMessage(messM);
/*       */             }
/*   991 */             else if (pinf.mutesReceived >= required * 0.75D)
/*       */             {
/*   993 */               Players.addMgmtMessage("Opinion", "has reached 75% for muting " + pinf.getName() + " for 1 hour.");
/*   994 */               Message mess = new Message((Creature)online, (byte)9, "MGMT", "<" + online.getName() + "> has reached 75% of being muted 1 hour by public opinion.", muteMsgRed, muteMsgGreen, muteMsgBlue);
/*       */ 
/*       */               
/*   997 */               Server.getInstance().addMessage(mess);
/*       */             }
/*       */           
/*       */           }
/*       */         
/*       */         }
/*       */       }
/*  1004 */     } catch (NoSuchPlayerException noSuchPlayerException) {}
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public boolean pollNextMove() {
/*  1019 */     if (this.ticker != null) {
/*       */       
/*  1021 */       if (this.currentmove != null) {
/*       */         
/*  1023 */         checkMoveChanges();
/*       */         
/*  1025 */         if ((this.currentmove.getBm() & 0xF) > 0)
/*       */         {
/*  1027 */           if (this.invulnerable) {
/*       */             
/*  1029 */             setInvulnerable(false);
/*  1030 */             sendNormalServerMessage("You are no longer invulnerable.");
/*       */           } 
/*       */         }
/*  1033 */         boolean moved = false;
/*  1034 */         if (!this.currentmove.isHandled()) {
/*       */           
/*  1036 */           moved = true;
/*       */           
/*       */           try {
/*  1039 */             this.lastLayer = this.player.getLayer();
/*  1040 */             if (this.player.vehicle == -10L || this.player.isVehicleCommander()) {
/*       */               
/*  1042 */               if (this.player.isVehicleCommander()) {
/*       */                 
/*  1044 */                 float maxDepth = -2500.0F;
/*  1045 */                 float maxHeight = 2500.0F;
/*  1046 */                 float maxDiff = 2000.0F;
/*  1047 */                 Vehicle vehic = Vehicles.getVehicleForId(this.player.getVehicle());
/*  1048 */                 if (vehic != null) {
/*       */                   
/*  1050 */                   maxDepth = vehic.maxDepth;
/*  1051 */                   maxHeight = vehic.maxHeight;
/*  1052 */                   maxDiff = vehic.maxHeightDiff;
/*       */                 } 
/*  1054 */                 this.ticker.movestep(maxDiff, this.currentmove.getNewPosX(), this.currentmove.getNewPosZ(), this.currentmove
/*  1055 */                     .getNewPosY(), maxDepth, maxHeight, this.currentmove.getNewRot(), this.currentmove
/*  1056 */                     .getBm(), this.currentmove.getLayer());
/*       */               } else {
/*       */                 
/*  1059 */                 this.ticker.movestep(2000.0F, this.currentmove.getNewPosX(), this.currentmove.getNewPosZ(), this.currentmove
/*  1060 */                     .getNewPosY(), -2500.0F, 2500.0F, this.currentmove.getNewRot(), this.currentmove.getBm(), this.currentmove
/*  1061 */                     .getLayer());
/*  1062 */               }  if (!this.ticker.isAborted()) {
/*  1063 */                 movePlayer();
/*       */               }
/*       */             } else {
/*  1066 */               movePlayer();
/*       */             } 
/*  1068 */           } catch (Exception e) {
/*       */             
/*  1070 */             if (this.currentmove != null)
/*  1071 */               this.currentmove.setHandled(true); 
/*  1072 */             this.moves--;
/*  1073 */             float lOldPosX = this.player.getStatus().getPositionX();
/*  1074 */             float lOldPosY = this.player.getStatus().getPositionY();
/*  1075 */             float lOldPosZ = this.player.getStatus().getPositionZ();
/*  1076 */             float lOldRot = this.player.getStatus().getRotation();
/*  1077 */             boolean iteleport = true;
/*  1078 */             if (lOldPosX < 0.0F) {
/*       */               
/*  1080 */               lOldPosX = 2.0F;
/*  1081 */               iteleport = false;
/*       */             } 
/*  1083 */             if (lOldPosY < 0.0F) {
/*       */               
/*  1085 */               lOldPosY = 2.0F;
/*  1086 */               iteleport = false;
/*       */             } 
/*  1088 */             if (lOldPosY > Zones.worldMeterSizeY) {
/*       */               
/*  1090 */               lOldPosY = Zones.worldMeterSizeY - 2.0F;
/*  1091 */               iteleport = false;
/*       */             } 
/*  1093 */             if (lOldPosX > Zones.worldMeterSizeX) {
/*       */               
/*  1095 */               lOldPosX = Zones.worldMeterSizeX - 2.0F;
/*  1096 */               iteleport = false;
/*       */             } 
/*  1098 */             CommuincatorMoveChangeChecker.checkWeather(this.currentmove, this.ticker);
/*  1099 */             CommuincatorMoveChangeChecker.checkWindMod(this.currentmove, this.player, logger);
/*  1100 */             CommuincatorMoveChangeChecker.checkMountSpeed(this.currentmove, this.player, logger);
/*  1101 */             CommuincatorMoveChangeChecker.checkHeightOffsetChanged(this.currentmove, this.player);
/*  1102 */             if (iteleport) {
/*  1103 */               this.player.intraTeleport(lOldPosX, lOldPosY, lOldPosZ, lOldRot, this.lastLayer, "failed move");
/*       */             } else {
/*       */               
/*  1106 */               this.player.setTeleportPoints(lOldPosX, lOldPosY, this.lastLayer, 0);
/*  1107 */               this.player.startTeleporting();
/*  1108 */               CommuincatorMoveChangeChecker.checkClimb(this.currentmove, this.ticker);
/*  1109 */               sendNormalServerMessage("You feel a slight tingle in your spine.");
/*  1110 */               sendTeleport(false);
/*       */             } 
/*  1112 */             return false;
/*       */           } 
/*       */         } 
/*  1115 */         if (this.currentmove != null) {
/*       */           
/*  1117 */           if (this.currentmove.getSameMoves() > 0) {
/*       */             
/*  1119 */             moved = true;
/*  1120 */             if (this.player.vehicle == -10L || this.player.isVehicleCommander())
/*       */             {
/*  1122 */               if (this.player.isVehicleCommander()) {
/*       */                 
/*  1124 */                 float maxDepth = -2500.0F;
/*  1125 */                 float maxHeight = 2500.0F;
/*  1126 */                 float maxDiff = 2000.0F;
/*  1127 */                 Vehicle vehic = Vehicles.getVehicleForId(this.player.getVehicle());
/*  1128 */                 if (vehic != null) {
/*       */                   
/*  1130 */                   maxDepth = vehic.maxDepth;
/*  1131 */                   maxHeight = vehic.maxHeight;
/*  1132 */                   maxDiff = vehic.maxHeightDiff;
/*       */                 } 
/*  1134 */                 for (int x = 0; x < this.currentmove.getSameMoves(); x++)
/*       */                 {
/*  1136 */                   this.moves--;
/*  1137 */                   this.ticker.movestep(maxDiff, this.currentmove.getNewPosX(), this.currentmove.getNewPosZ(), this.currentmove
/*  1138 */                       .getNewPosY(), maxDepth, maxHeight, this.currentmove.getNewRot(), this.currentmove
/*  1139 */                       .getBm(), this.currentmove.getLayer());
/*       */ 
/*       */                   
/*  1142 */                   if (this.currentmove == null)
/*       */                   {
/*  1144 */                     return true;
/*       */                   }
/*       */                 }
/*       */               
/*       */               } else {
/*       */                 
/*  1150 */                 for (int x = 0; x < this.currentmove.getSameMoves(); x++) {
/*       */                   
/*  1152 */                   this.moves--;
/*  1153 */                   this.ticker.movestep(2000.0F, this.currentmove.getNewPosX(), this.currentmove.getNewPosZ(), this.currentmove
/*  1154 */                       .getNewPosY(), -2500.0F, 2500.0F, this.currentmove.getNewRot(), this.currentmove
/*  1155 */                       .getBm(), this.currentmove.getLayer());
/*       */ 
/*       */                   
/*  1158 */                   if (this.currentmove == null)
/*       */                   {
/*  1160 */                     return true;
/*       */                   }
/*       */                 } 
/*       */               } 
/*       */             }
/*  1165 */             this.currentmove.resetSameMoves();
/*  1166 */             this.currentmove.setHandled(true);
/*       */           } 
/*  1168 */           setNextMove();
/*       */         } 
/*  1170 */         return moved;
/*       */       } 
/*       */ 
/*       */       
/*  1174 */       checkMoveChanges();
/*  1175 */       return false;
/*       */     } 
/*       */     
/*  1178 */     return false;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private boolean isVillageInviteMessage(String message) {
/*  1185 */     String[] parts = message.split(" ");
/*  1186 */     if (parts.length > 0)
/*       */     {
/*  1188 */       if (parts[0].equalsIgnoreCase("/vinvite") || parts[0].equalsIgnoreCase("/villageinvite"))
/*  1189 */         return true; 
/*       */     }
/*  1191 */     return false;
/*       */   }
/*       */ 
/*       */   
/*       */   private boolean isChangingServerNorth(int aNewTileX, int aNewTileY) {
/*  1196 */     if (aNewTileY < 40)
/*       */     {
/*  1198 */       if (aNewTileX >= 0 && aNewTileX <= serverBorderEnd) {
/*       */         
/*  1200 */         ServerEntry entry = Servers.getDestinationFor((Creature)this.player);
/*  1201 */         if (entry != Servers.localServer) {
/*       */           
/*  1203 */           this.lastTargetServerChecked = entry;
/*  1204 */           return true;
/*       */         } 
/*  1206 */         if (Servers.localServer.serverNorth != null && Servers.localServer.serverNorth
/*  1207 */           .isAvailable(this.player.getPower(), this.player.isReallyPaying())) {
/*       */           
/*  1209 */           if (!Servers.mayEnterServer((Creature)this.player, Servers.localServer.serverNorth))
/*  1210 */             return false; 
/*  1211 */           this.lastTargetServerChecked = Servers.localServer.serverNorth;
/*  1212 */           return true;
/*       */         } 
/*       */       } 
/*       */     }
/*  1216 */     return false;
/*       */   }
/*       */ 
/*       */   
/*       */   private boolean isChangingServerSouth(int aNewTileX, int aNewTileY) {
/*  1221 */     if (aNewTileY > firstBorder)
/*       */     {
/*  1223 */       if (aNewTileX >= 0 && aNewTileX <= serverBorderEnd) {
/*       */         
/*  1225 */         ServerEntry entry = Servers.getDestinationFor((Creature)this.player);
/*  1226 */         if (entry != Servers.localServer) {
/*       */           
/*  1228 */           this.lastTargetServerChecked = entry;
/*  1229 */           return true;
/*       */         } 
/*  1231 */         if (Servers.localServer.serverSouth != null && Servers.localServer.serverSouth
/*  1232 */           .isAvailable(this.player.getPower(), this.player.isReallyPaying())) {
/*       */           
/*  1234 */           if (!Servers.mayEnterServer((Creature)this.player, Servers.localServer.serverSouth))
/*  1235 */             return false; 
/*  1236 */           this.lastTargetServerChecked = Servers.localServer.serverSouth;
/*  1237 */           return true;
/*       */         } 
/*       */       } 
/*       */     }
/*  1241 */     return false;
/*       */   }
/*       */ 
/*       */   
/*       */   private boolean isChangingServerWest(int aNewTileX, int aNewTileY) {
/*  1246 */     if (aNewTileX < 40)
/*       */     {
/*  1248 */       if (aNewTileY >= 0 && aNewTileY <= serverBorderEnd) {
/*       */         
/*  1250 */         ServerEntry entry = Servers.getDestinationFor((Creature)this.player);
/*  1251 */         if (entry != Servers.localServer) {
/*       */           
/*  1253 */           this.lastTargetServerChecked = entry;
/*  1254 */           return true;
/*       */         } 
/*  1256 */         if (Servers.localServer.serverWest != null && Servers.localServer.serverWest
/*  1257 */           .isAvailable(this.player.getPower(), this.player.isReallyPaying())) {
/*       */           
/*  1259 */           if (!Servers.mayEnterServer((Creature)this.player, Servers.localServer.serverWest))
/*  1260 */             return false; 
/*  1261 */           this.lastTargetServerChecked = Servers.localServer.serverWest;
/*  1262 */           return true;
/*       */         } 
/*       */       } 
/*       */     }
/*       */     
/*  1267 */     return false;
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private boolean isChangingServerEast(int aNewTileX, int aNewTileY) {
/*  1273 */     if (aNewTileX > firstBorder)
/*       */     {
/*  1275 */       if (aNewTileY >= 0 && aNewTileY <= serverBorderEnd) {
/*       */         
/*  1277 */         ServerEntry entry = Servers.getDestinationFor((Creature)this.player);
/*  1278 */         if (entry != Servers.localServer) {
/*       */           
/*  1280 */           this.lastTargetServerChecked = entry;
/*  1281 */           return true;
/*       */         } 
/*  1283 */         if (Servers.localServer.serverEast != null && Servers.localServer.serverEast
/*  1284 */           .isAvailable(this.player.getPower(), this.player.isReallyPaying())) {
/*       */           
/*  1286 */           if (!Servers.mayEnterServer((Creature)this.player, Servers.localServer.serverEast))
/*  1287 */             return false; 
/*  1288 */           this.lastTargetServerChecked = Servers.localServer.serverEast;
/*  1289 */           return true;
/*       */         } 
/*       */       } 
/*       */     }
/*       */     
/*  1294 */     return false;
/*       */   }
/*       */ 
/*       */   
/*       */   private boolean mayLeaveWithVehicle() {
/*  1299 */     if (!Servers.localServer.PVPSERVER) {
/*       */ 
/*       */ 
/*       */ 
/*       */       
/*  1304 */       Vehicle vehic = Vehicles.getVehicleForId(this.player.getVehicle());
/*  1305 */       if (vehic != null) {
/*       */         
/*       */         try {
/*       */           
/*  1309 */           Item ivehic = Items.getItem(this.player.getVehicle());
/*  1310 */           if (ivehic.getLockId() == -10L) {
/*  1311 */             return true;
/*       */           }
/*  1313 */           if (!ivehic.isGuest((Creature)this.player) || !ivehic.mayCommand((Creature)this.player)) {
/*       */             
/*  1315 */             this.player.getCommunicator().sendNormalServerMessage("You may not leave the server with this boat. You need to be explicitly specified in the boat's permissions.");
/*       */             
/*  1317 */             return false;
/*       */           } 
/*       */ 
/*       */ 
/*       */           
/*  1322 */           for (Seat seat : vehic.getSeats())
/*       */           {
/*  1324 */             if (seat.isOccupied() && seat.type == 1 && 
/*  1325 */               !ivehic.isGuest(seat.getOccupant())) {
/*       */               
/*       */               try {
/*       */                 
/*  1329 */                 Creature c = Server.getInstance().getCreature(seat.occupant);
/*  1330 */                 if (!ivehic.mayPassenger(c))
/*       */                 {
/*  1332 */                   this.player.getCommunicator().sendNormalServerMessage("You may not leave the server with this boat as one of your passengers will not have passenger permission on new server.");
/*       */ 
/*       */                   
/*  1335 */                   return false;
/*       */                 }
/*       */               
/*  1338 */               } catch (NoSuchCreatureException|NoSuchPlayerException noSuchCreatureException) {}
/*       */             
/*       */             }
/*       */           
/*       */           }
/*       */ 
/*       */         
/*       */         }
/*  1346 */         catch (NoSuchItemException noSuchItemException) {}
/*       */       }
/*       */     } 
/*       */ 
/*       */ 
/*       */     
/*  1352 */     return true;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private boolean isChangingServer(int aNewTileX, int aNewTileY) {
/*  1364 */     if (this.player.wasKickedOffBoat())
/*  1365 */       return false; 
/*  1366 */     if (!mayLeaveWithVehicle()) {
/*  1367 */       return false;
/*       */     }
/*  1369 */     return (isChangingServerNorth(aNewTileX, aNewTileY) || isChangingServerEast(aNewTileX, aNewTileY) || 
/*  1370 */       isChangingServerWest(aNewTileX, aNewTileY) || isChangingServerSouth(aNewTileX, aNewTileY));
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private boolean checkVehicle(int aNewTileX, int aNewTileY, boolean leaving) {
/*  1376 */     boolean ok = true;
/*  1377 */     if (this.player.isVehicleCommander()) {
/*       */       
/*  1379 */       Vehicle vehic = Vehicles.getVehicleForId(this.player.getVehicle());
/*  1380 */       if (vehic != null) {
/*       */         
/*  1382 */         ServerEntry targetserver = Servers.localServer;
/*  1383 */         if (vehic.hasDestinationSet()) {
/*       */           
/*  1385 */           targetserver = vehic.getDestinationServer();
/*       */         }
/*  1387 */         else if (isChangingServerNorth(aNewTileX, aNewTileY)) {
/*       */           
/*  1389 */           targetserver = Servers.localServer.serverNorth;
/*       */         }
/*  1391 */         else if (isChangingServerEast(aNewTileX, aNewTileY)) {
/*       */           
/*  1393 */           targetserver = Servers.localServer.serverEast;
/*       */         }
/*  1395 */         else if (isChangingServerSouth(aNewTileX, aNewTileY)) {
/*       */           
/*  1397 */           targetserver = Servers.localServer.serverSouth;
/*       */         }
/*  1399 */         else if (isChangingServerWest(aNewTileX, aNewTileY)) {
/*       */           
/*  1401 */           targetserver = Servers.localServer.serverWest;
/*       */         } 
/*  1403 */         if (!Servers.mayEnterServer((Creature)this.player, targetserver)) {
/*       */           
/*  1405 */           if (leaving) {
/*       */             
/*  1407 */             this.player.getCommunicator().sendAlertServerMessage("You may not enter that server now.");
/*  1408 */             this.player.disembark(true);
/*  1409 */             this.player.setKickedOffBoat(true);
/*       */           } 
/*  1411 */           return false;
/*       */         } 
/*       */         
/*  1414 */         if (!Servers.isThisAnEpicOrChallengeServer())
/*       */         {
/*  1416 */           if (targetserver.PVPSERVER && vehic.hasDestinationSet() && vehic.isPvPBlocking()) {
/*       */             
/*  1418 */             this.player.getCommunicator().sendAlertServerMessage("You or a passenger has PvP travel blocked. This option may be toggled in the profile.", (byte)2);
/*       */             
/*  1420 */             if (leaving) {
/*       */               
/*  1422 */               this.player.disembark(true);
/*  1423 */               this.player.setKickedOffBoat(true);
/*       */             } 
/*  1425 */             return false;
/*       */           } 
/*       */         }
/*       */ 
/*       */         
/*  1430 */         if (!targetserver.PVPSERVER && targetserver.HOMESERVER && (!Servers.localServer.EPIC || 
/*  1431 */           Server.getInstance().isPS())) {
/*       */           
/*  1433 */           vehic.alertPassengersOfKingdom(targetserver, true);
/*       */         }
/*  1435 */         else if (targetserver.PVPSERVER && !targetserver.HOMESERVER && (!Servers.localServer.EPIC || 
/*  1436 */           Server.getInstance().isPS())) {
/*       */           
/*  1438 */           vehic.alertPassengersOfKingdom(targetserver, true);
/*  1439 */           vehic.alertAllPassengersOfEnemies(targetserver);
/*       */         } 
/*  1441 */         if (!vehic.creature)
/*       */         {
/*  1443 */           if (!Servers.localServer.PVPSERVER)
/*       */           {
/*  1445 */             if (!vehic.checkPassengerPermissions((Creature)this.player)) {
/*       */               
/*  1447 */               if (leaving) {
/*       */                 
/*  1449 */                 this.player.disembark(true);
/*  1450 */                 this.player.setKickedOffBoat(true);
/*       */               } 
/*  1452 */               return false;
/*       */             } 
/*       */           }
/*       */         }
/*       */         
/*  1457 */         if (vehic.seats != null)
/*       */         {
/*  1459 */           for (int x = 0; x < vehic.seats.length; x++) {
/*       */             
/*  1461 */             if (vehic.seats[x] != null && (vehic.seats[x]).occupant > 0L && (vehic.seats[x]).occupant != this.player
/*  1462 */               .getWurmId()) {
/*       */               
/*       */               try {
/*       */                 
/*  1466 */                 Creature c = Server.getInstance().getCreature((vehic.seats[x]).occupant);
/*  1467 */                 if (c.isPlayer()) {
/*       */                   
/*  1469 */                   if (!leaving) {
/*  1470 */                     PlayerTransfer.willItemsTransfer((Player)c, false, targetserver.id);
/*       */                   }
/*  1472 */                   if (!Servers.mayEnterServer(c, targetserver))
/*       */                   {
/*  1474 */                     if (!leaving)
/*       */                     {
/*  1476 */                       c.getCommunicator().sendAlertServerMessage("You can not leave in that direction and will end up in the water!");
/*       */                       
/*  1478 */                       sendAlertServerMessage(c.getName() + " may not leave in that direction and will end up in the water!");
/*       */                     
/*       */                     }
/*       */                     else
/*       */                     {
/*  1483 */                       c.disembark(true);
/*  1484 */                       c.setKickedOffBoat(true);
/*       */                     }
/*       */                   
/*       */                   }
/*       */                 } 
/*  1489 */               } catch (Exception exception) {}
/*       */             }
/*       */           } 
/*       */         }
/*       */ 
/*       */ 
/*       */         
/*  1496 */         if (!vehic.creature) {
/*       */           
/*       */           try {
/*       */             
/*  1500 */             Item ivehic = Items.getItem(vehic.wurmid);
/*  1501 */             Item[] items = ivehic.getAllItems(true);
/*       */             
/*  1503 */             for (int x = 0; x < items.length; x++)
/*       */             {
/*  1505 */               if (!items[x].willLeaveServer(false, false, (this.player.getPower() > 0)))
/*       */               {
/*  1507 */                 sendAlertServerMessage("The " + items[x].getName() + " in the " + ivehic.getName() + " will not leave the server.");
/*       */               }
/*       */             }
/*       */           
/*       */           }
/*  1512 */           catch (NoSuchItemException noSuchItemException) {}
/*       */ 
/*       */         
/*       */         }
/*       */ 
/*       */       
/*       */       }
/*       */       else {
/*       */ 
/*       */ 
/*       */         
/*  1523 */         ok = false;
/*       */       } 
/*       */     } 
/*  1526 */     return ok;
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private String createDraggedTransferData(ServerEntry targetserver, Item dragged, int aNewTileX, int aNewTileY, LinkedList<Creature> passengers) {
/*  1532 */     Item[] items = dragged.getAllItems(true);
/*  1533 */     for (Item item : items) {
/*       */       
/*  1535 */       if (!item.willLeaveServer(true, false, (this.player.getPower() > 0)))
/*       */       {
/*  1537 */         sendAlertServerMessage("The " + item.getName() + " in the " + dragged.getName() + " will not leave the server.");
/*       */       }
/*       */     } 
/*       */     
/*  1541 */     LoginServerWebConnection lsw = new LoginServerWebConnection(targetserver.id);
/*  1542 */     ByteArrayOutputStream bos = new ByteArrayOutputStream();
/*  1543 */     ByteArrayOutputStream bos2 = new ByteArrayOutputStream();
/*       */ 
/*       */     
/*       */     try {
/*  1547 */       DataOutputStream dos2 = new DataOutputStream(bos2);
/*  1548 */       Vehicle vehic = Vehicles.getVehicleForId(dragged.getWurmId());
/*  1549 */       if (vehic != null) {
/*       */         
/*  1551 */         dos2.writeInt(passengers.size());
/*  1552 */         for (Iterator<Creature> it = passengers.iterator(); it.hasNext(); ) {
/*       */           
/*  1554 */           Creature c = it.next();
/*  1555 */           dos2.writeLong(c.getWurmId());
/*  1556 */           dos2.writeInt(vehic.getSeatPosForPassenger(c.getWurmId()));
/*       */         } 
/*       */       } else {
/*       */         
/*  1560 */         dos2.writeInt(0);
/*  1561 */       }  dos2.flush();
/*  1562 */       dos2.close();
/*  1563 */       this.passengerData = bos2.toByteArray();
/*  1564 */       DataOutputStream dos = new DataOutputStream(bos);
/*  1565 */       dos.writeInt(items.length + 1);
/*  1566 */       PlayerTransfer.sendItem(dragged, dos, false);
/*  1567 */       for (int x = 0; x < items.length; x++)
/*       */       {
/*  1569 */         PlayerTransfer.sendItem(items[x], dos, false);
/*       */       }
/*  1571 */       dos.flush();
/*  1572 */       dos.close();
/*  1573 */       this.vehicleData = bos.toByteArray();
/*  1574 */       String result = lsw.sendVehicle(this.passengerData, this.vehicleData, this.player.getWurmId(), dragged.getWurmId(), targetserver.id, aNewTileX, aNewTileY, 0, dragged
/*  1575 */           .getRotation());
/*  1576 */       if (result.isEmpty()) {
/*       */         
/*  1578 */         for (Item item : items) {
/*       */           
/*  1580 */           if (!item.isTransferred())
/*       */           {
/*  1582 */             Items.destroyItem(item.getWurmId(), false, true);
/*       */           }
/*       */         } 
/*  1585 */         Items.destroyItem(dragged.getWurmId());
/*  1586 */         sendSafeServerMessage("You drift away with the " + dragged.getName() + '.');
/*  1587 */         if (!dragged.isTransferred())
/*  1588 */           Items.destroyItem(dragged.getWurmId(), false, true); 
/*       */       } 
/*  1590 */       return result;
/*       */     }
/*  1592 */     catch (IOException iox) {
/*       */       
/*  1594 */       return "Error: " + iox.getMessage();
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private String createVehicleTransferData(ServerEntry targetserver, int aNewTileX, int aNewTileY, LinkedList<Creature> passengers) {
/*  1601 */     Vehicle vehic = Vehicles.getVehicleForId(this.player.getVehicle());
/*  1602 */     if (vehic != null) {
/*       */       
/*  1604 */       if (!vehic.creature) {
/*       */         
/*       */         try {
/*       */           
/*  1608 */           Item ivehic = Items.getItem(vehic.wurmid);
/*  1609 */           Item[] items = ivehic.getAllItems(true);
/*       */ 
/*       */ 
/*       */           
/*  1613 */           for (int x = 0; x < items.length; x++) {
/*       */             
/*  1615 */             if (!items[x].willLeaveServer(true, false, (this.player.getPower() > 0)))
/*       */             {
/*  1617 */               sendAlertServerMessage("The " + items[x].getName() + " in the " + ivehic.getName() + " will not leave the server.");
/*       */             }
/*       */           } 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */           
/*  1625 */           boolean anchored = false;
/*  1626 */           Item anchor = null;
/*  1627 */           Item keepnet = null;
/*  1628 */           Item boatLock = null;
/*  1629 */           if (ivehic.isBoat()) {
/*       */             
/*  1631 */             if (ivehic.getData() != -1L) {
/*       */               
/*       */               try {
/*       */ 
/*       */                 
/*  1636 */                 anchor = Items.getItem(ivehic.getData());
/*  1637 */                 anchor.setTransferred(false);
/*  1638 */                 anchored = true;
/*       */               }
/*  1640 */               catch (NoSuchItemException noSuchItemException) {}
/*       */             }
/*       */ 
/*       */ 
/*       */             
/*  1645 */             if (ivehic.getExtra() != -1L) {
/*       */               
/*       */               try {
/*       */ 
/*       */                 
/*  1650 */                 keepnet = Items.getItem(ivehic.getExtra());
/*  1651 */                 keepnet.setTransferred(false);
/*  1652 */                 logInfo(this.player.getName() + " has a keepnet.");
/*       */               }
/*  1654 */               catch (NoSuchItemException noSuchItemException) {}
/*       */             }
/*       */ 
/*       */ 
/*       */             
/*  1659 */             if (ivehic.getLockId() != -10L) {
/*       */               
/*       */               try {
/*       */                 
/*  1663 */                 boatLock = Items.getItem(ivehic.getLockId());
/*  1664 */                 boatLock.setTransferred(false);
/*       */               }
/*  1666 */               catch (NoSuchItemException noSuchItemException) {}
/*       */             }
/*       */           } 
/*       */ 
/*       */           
/*  1671 */           LoginServerWebConnection lsw = new LoginServerWebConnection(targetserver.id);
/*  1672 */           ByteArrayOutputStream bos = new ByteArrayOutputStream();
/*  1673 */           ByteArrayOutputStream bos2 = new ByteArrayOutputStream();
/*       */ 
/*       */           
/*       */           try {
/*  1677 */             DataOutputStream dos2 = new DataOutputStream(bos2);
/*       */ 
/*       */             
/*  1680 */             ivehic.setLastOwnerId(this.player.getWurmId());
/*       */             
/*  1682 */             dos2.writeInt(passengers.size());
/*  1683 */             for (Iterator<Creature> it = passengers.iterator(); it.hasNext(); ) {
/*       */               
/*  1685 */               Creature c = it.next();
/*  1686 */               dos2.writeLong(c.getWurmId());
/*  1687 */               dos2.writeInt(vehic.getSeatPosForPassenger(c.getWurmId()));
/*       */             } 
/*       */ 
/*       */             
/*  1691 */             dos2.flush();
/*  1692 */             dos2.close();
/*  1693 */             this.passengerData = bos2.toByteArray();
/*       */             
/*  1695 */             DataOutputStream dos = new DataOutputStream(bos);
/*       */ 
/*       */ 
/*       */ 
/*       */             
/*  1700 */             Set<Item> itemsToSend = new HashSet<>();
/*       */             
/*  1702 */             itemsToSend.add(ivehic);
/*       */             
/*  1704 */             if (anchored)
/*       */             {
/*  1706 */               itemsToSend.add(anchor);
/*       */             }
/*  1708 */             if (keepnet != null)
/*       */             {
/*  1710 */               itemsToSend.add(keepnet);
/*       */             }
/*  1712 */             if (boatLock != null)
/*  1713 */               itemsToSend.add(boatLock); 
/*  1714 */             for (int i = 0; i < items.length; i++) {
/*       */               
/*  1716 */               if (!items[i].isTransferred() && !items[i].isArtifact())
/*       */               {
/*  1718 */                 itemsToSend.add(items[i]);
/*       */               }
/*       */             } 
/*  1721 */             dos.writeInt(itemsToSend.size());
/*  1722 */             for (Item item : itemsToSend)
/*       */             {
/*  1724 */               PlayerTransfer.sendItem(item, dos, false);
/*       */             }
/*       */             
/*  1727 */             dos.flush();
/*  1728 */             dos.close();
/*       */             
/*  1730 */             this.vehicleData = bos.toByteArray();
/*       */             
/*  1732 */             itemsToSend.clear();
/*  1733 */             String result = lsw.sendVehicle(this.passengerData, this.vehicleData, this.player.getWurmId(), ivehic
/*  1734 */                 .getWurmId(), targetserver.id, aNewTileX, aNewTileY, 0, ivehic.getRotation());
/*       */ 
/*       */             
/*  1737 */             logInfo(this.player.getName() + " RECEIVED RESULT " + result);
/*  1738 */             if (result.isEmpty()) {
/*       */               
/*  1740 */               for (int j = 0; j < items.length; j++) {
/*       */                 
/*  1742 */                 if (!items[j].isTransferred() && !items[j].isArtifact())
/*  1743 */                   Items.destroyItem(items[j].getWurmId(), false, true); 
/*       */               } 
/*  1745 */               sendSafeServerMessage("You drift away on the " + ivehic.getName() + '.');
/*  1746 */               if (!ivehic.isTransferred())
/*  1747 */                 Items.destroyItem(ivehic.getWurmId(), false, true); 
/*       */             } 
/*  1749 */             return result;
/*       */           }
/*  1751 */           catch (IOException iox) {
/*       */             
/*  1753 */             return "Error: " + iox.getMessage();
/*       */           }
/*       */         
/*  1756 */         } catch (NoSuchItemException ex) {
/*       */           
/*  1758 */           return "Error: " + ex.getMessage();
/*       */         } 
/*       */       }
/*       */ 
/*       */       
/*  1763 */       return "Creatures don't transfer";
/*       */     } 
/*       */ 
/*       */     
/*  1767 */     return "This shouldn't happen, really";
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private boolean checkLegalTileMove(int aNewTileX, int aNewTileY, int aDiffTileX, int aDiffTileY) {
/*  1773 */     if ((aNewTileX > 20 && aNewTileX < 30) || (aNewTileY > 20 && aNewTileY < 30) || (aNewTileY > firstBorder && aNewTileY < secondBorder) || (aNewTileX > firstBorder && aNewTileX < secondBorder)) {
/*       */ 
/*       */ 
/*       */       
/*  1777 */       boolean send = false;
/*  1778 */       if ((aNewTileX > 20 && aNewTileX < 30) || (aNewTileY > 20 && aNewTileY < 30)) {
/*       */         
/*  1780 */         if (aDiffTileX < 0 || aDiffTileY < 0) {
/*  1781 */           send = true;
/*       */         }
/*  1783 */       } else if ((aNewTileY > firstBorder && aNewTileY < secondBorder) || (aNewTileX > firstBorder && aNewTileX < secondBorder)) {
/*       */ 
/*       */         
/*  1786 */         if (aDiffTileX > 0 || aDiffTileY > 0) {
/*  1787 */           send = true;
/*       */         }
/*       */       } 
/*  1790 */       if (send && (!this.sentFirstWarning || Server.rand.nextInt(20) == 0)) {
/*       */         
/*  1792 */         this.sentFirstWarning = true;
/*  1793 */         this.sentSecondWarning = false;
/*       */         
/*  1795 */         this.player.clearDestination();
/*  1796 */         boolean mayTakeVehicle = mayLeaveWithVehicle();
/*  1797 */         if (isChangingServer(aNewTileX, aNewTileY))
/*       */         {
/*  1799 */           if (mayTakeVehicle) {
/*       */             
/*  1801 */             sendAlertServerMessage("If you keep going in this direction you will end up on " + this.lastTargetServerChecked
/*  1802 */                 .getName() + ".");
/*  1803 */             if (this.player.isVehicleCommander() && this.player.getVehicle() != -10L) {
/*       */               
/*  1805 */               Vehicle boat = Vehicles.getVehicleForId(this.player.getVehicle());
/*  1806 */               boat.notifyAllPassengers("The " + Vehicle.getVehicleName(boat) + " will soon leave this island, and take you to " + this.lastTargetServerChecked
/*  1807 */                   .getName() + ".", false, true);
/*       */             } 
/*       */           } 
/*  1810 */           PlayerTransfer.willItemsTransfer(this.player, false, this.lastTargetServerChecked.getId());
/*  1811 */           checkVehicle(aNewTileX, aNewTileY, false);
/*       */         }
/*       */         else
/*       */         {
/*  1815 */           if (this.player.getVehicle() == -10L)
/*       */           {
/*  1817 */             this.player.sendPopup("Turn around!", "You see dark shadows moving beneath the waves.");
/*       */           }
/*  1819 */           sendAlertServerMessage("You see dark shadows moving beneath the waves.");
/*       */         }
/*       */       
/*       */       } 
/*  1823 */     } else if ((aNewTileX > 1 && aNewTileX <= 20) || (aNewTileY > 1 && aNewTileY <= 20) || (aNewTileY >= secondBorder && aNewTileY < finalBorder) || (aNewTileX >= secondBorder && aNewTileX < finalBorder)) {
/*       */ 
/*       */ 
/*       */       
/*  1827 */       this.player.setKickedOffBoat(false);
/*  1828 */       boolean send = false;
/*  1829 */       if ((aNewTileX > 1 && aNewTileX <= 20) || (aNewTileY > 1 && aNewTileY <= 20)) {
/*       */         
/*  1831 */         if (aDiffTileX < 0 || aDiffTileY < 0) {
/*  1832 */           send = true;
/*       */         }
/*  1834 */       } else if ((aNewTileY >= secondBorder && aNewTileY < finalBorder) || (aNewTileX >= secondBorder && aNewTileX < finalBorder)) {
/*       */ 
/*       */         
/*  1837 */         if (aDiffTileX > 0 || aDiffTileY > 0) {
/*  1838 */           send = true;
/*       */         }
/*       */       } 
/*  1841 */       boolean mayTakeVehicle = mayLeaveWithVehicle();
/*       */ 
/*       */       
/*  1844 */       if (aNewTileY == 10 && aDiffTileY < 0) {
/*       */         
/*  1846 */         boolean avail = (isChangingServerNorth(aNewTileX, aNewTileY) && mayTakeVehicle);
/*  1847 */         sendAvailServer((byte)0, avail);
/*       */       } 
/*  1849 */       if (aNewTileX == 10 && aDiffTileX < 0) {
/*       */         
/*  1851 */         boolean avail = (isChangingServerWest(aNewTileX, aNewTileY) && mayTakeVehicle);
/*  1852 */         sendAvailServer((byte)6, avail);
/*       */       } 
/*  1854 */       if (aNewTileX == serverBorderEnd - 10 && aDiffTileX > 0) {
/*       */         
/*  1856 */         boolean avail = (isChangingServerEast(aNewTileX, aNewTileY) && mayTakeVehicle);
/*  1857 */         sendAvailServer((byte)2, avail);
/*       */       } 
/*  1859 */       if (aNewTileY == serverBorderEnd - 10 && aDiffTileY > 0) {
/*       */         
/*  1861 */         boolean avail = (isChangingServerSouth(aNewTileX, aNewTileY) && mayTakeVehicle);
/*  1862 */         sendAvailServer((byte)4, avail);
/*       */       } 
/*       */ 
/*       */       
/*  1866 */       if (aNewTileY == 12 && aDiffTileY > 0)
/*       */       {
/*  1868 */         sendAvailServer((byte)0, true);
/*       */       }
/*  1870 */       if (aNewTileX == 12 && aDiffTileX > 0)
/*       */       {
/*  1872 */         sendAvailServer((byte)6, true);
/*       */       }
/*  1874 */       if (aNewTileX == serverBorderEnd - 12 && aDiffTileX < 0)
/*       */       {
/*  1876 */         sendAvailServer((byte)2, true);
/*       */       }
/*  1878 */       if (aNewTileY == serverBorderEnd - 12 && aDiffTileY < 0)
/*       */       {
/*  1880 */         sendAvailServer((byte)4, true);
/*       */       }
/*       */       
/*  1883 */       if (send && (!this.sentSecondWarning || Server.rand.nextInt(10) == 0)) {
/*       */         
/*  1885 */         this.sentSecondWarning = true;
/*  1886 */         this.sentFirstWarning = false;
/*  1887 */         if (isChangingServer(aNewTileX, aNewTileY)) {
/*       */           
/*  1889 */           if (mayTakeVehicle) {
/*       */             
/*  1891 */             sendAlertServerMessage("You will soon leave this island, and end up on " + this.lastTargetServerChecked
/*  1892 */                 .getName() + ".");
/*  1893 */             if (this.player.isVehicleCommander() && this.player.getVehicle() != -10L) {
/*       */               
/*  1895 */               Vehicle boat = Vehicles.getVehicleForId(this.player.getVehicle());
/*  1896 */               boat.notifyAllPassengers("The " + Vehicle.getVehicleName(boat) + " will soon leave this island, and take you to " + this.lastTargetServerChecked
/*  1897 */                   .getName() + ".", false, true);
/*       */             } 
/*       */           } 
/*  1900 */           PlayerTransfer.willItemsTransfer(this.player, false, 0);
/*  1901 */           checkVehicle(aNewTileX, aNewTileY, false);
/*       */ 
/*       */         
/*       */         }
/*  1905 */         else if (this.player.getPositionZ() < 0.0F || this.player.getVehicle() != -10L) {
/*       */           
/*  1907 */           if (this.player.getVehicle() == -10L) {
/*       */             
/*  1909 */             this.player.sendPopup("Turn around!", "An enourmous shark scouts you from below.");
/*       */           } else {
/*       */             
/*  1912 */             sendAlertServerMessage("An enourmous shark scouts you from below.");
/*       */           }
/*       */         
/*       */         } 
/*       */       } 
/*  1917 */     } else if (aNewTileX <= 1 || aNewTileY <= 1 || aNewTileY >= finalBorder || aNewTileX >= finalBorder) {
/*       */ 
/*       */ 
/*       */       
/*  1921 */       if (!this.player.isDead())
/*       */       {
/*  1923 */         if (isChangingServer(aNewTileX, aNewTileY)) {
/*       */           
/*  1925 */           if (!this.player.isTransferring())
/*       */           {
/*  1927 */             boolean ok = true;
/*       */             
/*  1929 */             this.player.getMovementScheme().haltSpeedModifier();
/*  1930 */             ok = checkVehicle(aNewTileX, aNewTileY, true);
/*  1931 */             if (ok) {
/*       */               
/*  1933 */               ServerEntry targetserver = Servers.localServer;
/*  1934 */               if ((Features.Feature.BOAT_DESTINATION.isEnabled() || this.player.getPower() >= 2) && this.player
/*  1935 */                 .isVehicleCommander()) {
/*       */                 
/*  1937 */                 Vehicle boat = Vehicles.getVehicleForId(this.player.getVehicle());
/*  1938 */                 if (boat != null) {
/*       */                   
/*  1940 */                   if (boat.hasDestinationSet())
/*       */                   {
/*  1942 */                     if (!Servers.localServer.PVPSERVER || (Servers.localServer.PVPSERVER && boat
/*  1943 */                       .getPlotCourseCooldowns() <= 0L)) {
/*  1944 */                       targetserver = boat.getDestinationServer();
/*       */                     }
/*       */                   }
/*  1947 */                 } else if (this.player.getDestination() != null) {
/*  1948 */                   targetserver = this.player.getDestination();
/*       */                 } 
/*       */               } 
/*  1951 */               int targetTileX = aNewTileX;
/*  1952 */               int targetTileY = aNewTileY;
/*  1953 */               if (isChangingServerNorth(aNewTileX, aNewTileY)) {
/*       */                 
/*  1955 */                 if (targetserver == Servers.localServer)
/*  1956 */                   targetserver = Servers.localServer.serverNorth; 
/*  1957 */                 targetTileY = (1 << targetserver.meshSize) - 40;
/*  1958 */                 if (targetserver.meshSize < Constants.meshSize) {
/*       */                   
/*  1960 */                   int diff = Constants.meshSize - targetserver.meshSize;
/*  1961 */                   if (diff > 1)
/*       */                   {
/*  1963 */                     targetTileX /= 4;
/*       */                   }
/*       */                   else
/*       */                   {
/*  1967 */                     targetTileX /= 2;
/*       */                   }
/*       */                 
/*  1970 */                 } else if (targetserver.meshSize > Constants.meshSize) {
/*       */                   
/*  1972 */                   int diff = targetserver.meshSize - Constants.meshSize;
/*  1973 */                   if (diff > 1) {
/*       */                     
/*  1975 */                     targetTileX *= 4;
/*       */                   }
/*       */                   else {
/*       */                     
/*  1979 */                     targetTileX *= 2;
/*       */                   } 
/*       */                 } 
/*       */                 
/*  1983 */                 int maxLimit = (1 << targetserver.meshSize) - 40;
/*  1984 */                 targetTileX = Math.min(targetTileX, maxLimit);
/*  1985 */                 targetTileX = Math.max(targetTileX, 40);
/*       */               }
/*  1987 */               else if (isChangingServerEast(aNewTileX, aNewTileY)) {
/*       */                 
/*  1989 */                 if (targetserver == Servers.localServer)
/*  1990 */                   targetserver = Servers.localServer.serverEast; 
/*  1991 */                 targetTileX = 40;
/*  1992 */                 if (targetserver.meshSize < Constants.meshSize) {
/*       */                   
/*  1994 */                   int diff = Constants.meshSize - targetserver.meshSize;
/*  1995 */                   if (diff > 1) {
/*  1996 */                     targetTileY /= 4;
/*       */                   } else {
/*  1998 */                     targetTileY /= 2;
/*       */                   }
/*       */                 
/*  2001 */                 } else if (targetserver.meshSize > Constants.meshSize) {
/*       */                   
/*  2003 */                   int diff = targetserver.meshSize - Constants.meshSize;
/*  2004 */                   if (diff > 1) {
/*  2005 */                     targetTileY *= 4;
/*       */                   } else {
/*  2007 */                     targetTileY *= 2;
/*       */                   } 
/*       */                 } 
/*  2010 */                 int maxLimit = (1 << targetserver.meshSize) - 40;
/*  2011 */                 targetTileY = Math.min(targetTileY, maxLimit);
/*  2012 */                 targetTileY = Math.max(targetTileY, 40);
/*       */               }
/*  2014 */               else if (isChangingServerSouth(aNewTileX, aNewTileY)) {
/*       */                 
/*  2016 */                 if (targetserver == Servers.localServer)
/*  2017 */                   targetserver = Servers.localServer.serverSouth; 
/*  2018 */                 targetTileY = 40;
/*  2019 */                 if (targetserver.meshSize < Constants.meshSize) {
/*       */                   
/*  2021 */                   int diff = Constants.meshSize - targetserver.meshSize;
/*  2022 */                   if (diff > 1) {
/*  2023 */                     targetTileX /= 4;
/*       */                   } else {
/*  2025 */                     targetTileX /= 2;
/*       */                   } 
/*  2027 */                 } else if (targetserver.meshSize > Constants.meshSize) {
/*       */                   
/*  2029 */                   int diff = targetserver.meshSize - Constants.meshSize;
/*  2030 */                   if (diff > 1) {
/*  2031 */                     targetTileX *= 4;
/*       */                   } else {
/*  2033 */                     targetTileX *= 2;
/*       */                   } 
/*       */                 } 
/*  2036 */                 int maxLimit = (1 << targetserver.meshSize) - 40;
/*  2037 */                 targetTileX = Math.min(targetTileX, maxLimit);
/*  2038 */                 targetTileX = Math.max(targetTileX, 40);
/*       */               }
/*  2040 */               else if (isChangingServerWest(aNewTileX, aNewTileY)) {
/*       */                 
/*  2042 */                 if (targetserver == Servers.localServer)
/*  2043 */                   targetserver = Servers.localServer.serverWest; 
/*  2044 */                 targetTileX = (1 << targetserver.meshSize) - 40;
/*  2045 */                 if (targetserver.meshSize < Constants.meshSize) {
/*       */                   
/*  2047 */                   int diff = Constants.meshSize - targetserver.meshSize;
/*  2048 */                   if (diff > 1)
/*       */                   {
/*  2050 */                     targetTileY /= 4;
/*       */                   }
/*       */                   else
/*       */                   {
/*  2054 */                     targetTileY /= 2;
/*       */                   }
/*       */                 
/*  2057 */                 } else if (targetserver.meshSize > Constants.meshSize) {
/*       */                   
/*  2059 */                   int diff = targetserver.meshSize - Constants.meshSize;
/*  2060 */                   if (diff > 1) {
/*       */                     
/*  2062 */                     targetTileY *= 4;
/*       */                   }
/*       */                   else {
/*       */                     
/*  2066 */                     targetTileY *= 2;
/*       */                   } 
/*       */                 } 
/*       */                 
/*  2070 */                 int maxLimit = (1 << targetserver.meshSize) - 40;
/*  2071 */                 targetTileY = Math.min(targetTileY, maxLimit);
/*  2072 */                 targetTileY = Math.max(targetTileY, 40);
/*       */               } 
/*  2074 */               if (targetserver.isAvailable(this.player.getPower(), this.player.isReallyPaying())) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                 
/*  2082 */                 sendAlertServerMessage("You head out to sea.");
/*       */                 
/*  2084 */                 if (this.player.isVehicleCommander() && this.player.getVehicle() != -10L) {
/*       */                   
/*  2086 */                   this.player.setDestination(targetserver);
/*  2087 */                   Vehicle vessel = Vehicles.getVehicleForId(this.player.getVehicle());
/*  2088 */                   if (vessel.hasDestinationSet())
/*       */                   {
/*  2090 */                     Server.getInstance().broadCastAction("The " + Vehicle.getVehicleName(vessel) + " sails off on a course to " + vessel
/*  2091 */                         .getDestinationServer().getName() + ".", (Creature)this.player, 6);
/*       */                   }
/*       */                 } 
/*       */ 
/*       */                 
/*  2096 */                 LinkedList<Creature> passengers = new LinkedList<>();
/*  2097 */                 if (this.player.isVehicleCommander())
/*       */                 {
/*  2099 */                   Vehicle vehic = Vehicles.getVehicleForId(this.player.getVehicle());
/*  2100 */                   if (vehic != null)
/*       */                   {
/*  2102 */                     if (vehic.seats != null)
/*       */                     {
/*  2104 */                       for (int x = 0; x < vehic.seats.length; x++) {
/*       */                         
/*  2106 */                         if (vehic.seats[x] != null && (vehic.seats[x]).occupant > 0L) {
/*       */                           
/*       */                           try {
/*       */                             
/*  2110 */                             Creature c = Server.getInstance().getCreature((vehic.seats[x]).occupant);
/*       */                             
/*  2112 */                             if (Servers.mayEnterServer(c, targetserver))
/*       */                             {
/*  2114 */                               c.setDestination(targetserver);
/*  2115 */                               passengers.add(c);
/*       */                             }
/*       */                             else
/*       */                             {
/*  2119 */                               c.disembark(true);
/*  2120 */                               c.setKickedOffBoat(true);
/*       */                             }
/*       */                           
/*  2123 */                           } catch (Exception ex) {
/*       */                             
/*  2125 */                             logWarn(ex.getMessage(), ex);
/*       */                           } 
/*       */                         }
/*       */                       } 
/*       */                     }
/*       */                   }
/*  2131 */                   if (createVehicleTransferData(targetserver, targetTileX, targetTileY, passengers)
/*  2132 */                     .isEmpty())
/*       */                   {
/*       */ 
/*       */ 
/*       */ 
/*       */                     
/*  2138 */                     for (Creature c : passengers)
/*       */                     {
/*  2140 */                       if (c.getSecondsPlayed() > 900.0F) {
/*  2141 */                         c.achievement(68);
/*       */                       }
/*  2143 */                       c.sendTransfer(Server.getInstance(), targetserver.INTRASERVERADDRESS, 
/*  2144 */                           Integer.parseInt(targetserver.INTRASERVERPORT), targetserver.INTRASERVERPASSWORD, targetserver.id, targetTileX, targetTileY, true, false, (byte)0);
/*       */                     
/*       */                     }
/*       */                   
/*       */                   }
/*       */                 }
/*  2150 */                 else if (this.player.getDraggedItem() != null)
/*       */                 {
/*  2152 */                   Vehicle vehic = Vehicles.getVehicleForId(this.player.getDraggedItem().getWurmId());
/*  2153 */                   if (vehic != null)
/*       */                   {
/*  2155 */                     if (vehic.seats != null)
/*       */                     {
/*  2157 */                       for (int x = 0; x < vehic.seats.length; x++) {
/*       */                         
/*  2159 */                         if (vehic.seats[x] != null && (vehic.seats[x]).occupant > 0L) {
/*       */                           
/*       */                           try {
/*       */ 
/*       */                             
/*  2164 */                             Creature c = Server.getInstance().getCreature((vehic.seats[x]).occupant);
/*       */                             
/*  2166 */                             if (Servers.mayEnterServer(c, targetserver)) {
/*  2167 */                               passengers.add(c);
/*       */                             } else {
/*       */                               
/*  2170 */                               c.getCommunicator().sendAlertServerMessage("Suddenly, strong winds and waves throw you overboard!");
/*       */                               
/*  2172 */                               c.disembark(true);
/*       */                             }
/*       */                           
/*  2175 */                           } catch (Exception exception) {}
/*       */                         }
/*       */                       } 
/*       */                     }
/*       */                   }
/*       */ 
/*       */                   
/*  2182 */                   if (createDraggedTransferData(targetserver, this.player.getDraggedItem(), targetTileX, targetTileY, passengers)
/*  2183 */                     .isEmpty())
/*       */                   {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                     
/*  2191 */                     this.player.sendTransfer(Server.getInstance(), targetserver.INTRASERVERADDRESS, 
/*  2192 */                         Integer.parseInt(targetserver.INTRASERVERPORT), targetserver.INTRASERVERPASSWORD, targetserver.id, targetTileX, targetTileY, true, false, (byte)0);
/*       */ 
/*       */                     
/*  2195 */                     for (Iterator<Creature> it = passengers.iterator(); it.hasNext();)
/*       */                     {
/*  2197 */                       ((Creature)it.next()).sendTransfer(Server.getInstance(), targetserver.INTRASERVERADDRESS, 
/*  2198 */                           Integer.parseInt(targetserver.INTRASERVERPORT), targetserver.INTRASERVERPASSWORD, targetserver.id, targetTileX, targetTileY, true, false, (byte)0);
/*       */                     }
/*       */                   }
/*       */                 
/*       */                 }
/*       */                 else
/*       */                 {
/*  2205 */                   this.player.sendTransfer(Server.getInstance(), targetserver.INTRASERVERADDRESS, 
/*  2206 */                       Integer.parseInt(targetserver.INTRASERVERPORT), targetserver.INTRASERVERPASSWORD, targetserver.id, targetTileX, targetTileY, true, false, (byte)0);
/*       */                 }
/*       */               
/*       */               } else {
/*       */                 
/*  2211 */                 this.player.getCommunicator().sendNormalServerMessage("The waves are too high to keep going in that direction right now. (The server is unavailable)");
/*  2212 */                 if (this.player.getVehicle() != -10L) {
/*       */                   
/*  2214 */                   sendAlertServerMessage("The winds die down suddenly and the boat stops moving.");
/*       */                 } else {
/*       */                   
/*  2217 */                   sendAlertServerMessage("You swim against the waves and may do nothing else for a while.");
/*       */                 } 
/*       */               } 
/*       */             } else {
/*  2221 */               this.player.getMovementScheme().resumeSpeedModifier();
/*       */             }
/*       */           
/*       */           }
/*       */         
/*  2226 */         } else if (this.player.getVehicle() != -10L) {
/*       */           
/*  2228 */           sendAlertServerMessage("Suddenly, strong winds and waves throw you overboard!");
/*       */         }
/*       */         else {
/*       */           
/*  2232 */           sendAlertServerMessage("The currents work against you and you get nowhere.");
/*       */         } 
/*       */       }
/*       */ 
/*       */       
/*  2237 */       return true;
/*       */     } 
/*  2239 */     return false;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void setInvulnerable(boolean invuln) {
/*  2248 */     this.invulnerable = invuln;
/*  2249 */     this.player.refreshAttitudes();
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private boolean canResetInactivity(byte cmd) {
/*  2261 */     switch (cmd) {
/*       */       
/*       */       case -32:
/*       */       case -24:
/*       */       case -23:
/*       */       case 36:
/*       */       case 43:
/*       */       case 51:
/*       */       case 62:
/*       */       case 79:
/*       */       case 97:
/*       */       case 99:
/*       */       case 106:
/*       */       case 120:
/*       */       case 126:
/*  2276 */         return true;
/*       */     } 
/*  2278 */     return false;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void reallyHandle(int num, ByteBuffer byteBuffer) {
/*  2289 */     if (!this.player.hasLink()) {
/*       */       
/*  2291 */       byteBuffer.clear();
/*       */       return;
/*       */     } 
/*  2294 */     byte cmd = byteBuffer.get();
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/*       */     try {
/*  2302 */       if (canResetInactivity(cmd)) {
/*  2303 */         this.player.resetInactivity(false);
/*       */       }
/*  2305 */       numcommands++;
/*       */       
/*  2307 */       switch (cmd) {
/*       */         case -29:
/*       */         case 9:
/*       */         case 29:
/*       */         case 32:
/*       */         case 36:
/*       */         case 42:
/*       */         case 43:
/*       */         case 99:
/*       */           break;
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */         
/*       */         default:
/*  2323 */           lastcommand = cmd;
/*  2324 */           this.commandsThisSecond++;
/*  2325 */           if (this.commandsThisSecond > 10);
/*       */           break;
/*       */       } 
/*       */ 
/*       */       
/*  2330 */       if (prevcommand != lastcommand) {
/*  2331 */         prevcommand = lastcommand;
/*       */       }
/*  2333 */       this.player.receivedCmd(cmd);
/*       */       
/*  2335 */       switch (cmd) {
/*       */         
/*       */         case 9:
/*  2338 */           reallyHandle_CMD_NOT_MOVE_CREATURE();
/*       */           break;
/*       */         
/*       */         case 32:
/*  2342 */           reallyHandle_CMD_SPEEDMODIFIER(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -29:
/*       */         case 36:
/*  2347 */           reallyHandle_CMD_MOVE_CREATURE(byteBuffer, cmd);
/*       */           break;
/*       */         case 31:
/*  2350 */           reallyHandle_CMD_STATE(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -16:
/*  2354 */           reallyHandle_CMD_EMPTY(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 126:
/*  2358 */           reallyHandle_CMD_REQUEST_ACTIONS(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -23:
/*  2362 */           reallyHandle_CMD_REQUEST_SELECT(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -46:
/*  2366 */           reallyHandle_CMD_ITEM_CREATION_LIST(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 97:
/*  2370 */           reallyHandle_CMD_ACTION(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 29:
/*  2374 */           reallyHandle_CMD_MORE_ITEMS(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 62:
/*  2378 */           reallyHandle_CMD_TOGGLE_SWITCH(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 99:
/*  2382 */           reallyHandle_CMD_MESSAGE(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -32:
/*  2386 */           reallyHandle_CMD_EQUIP_ITEM(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 43:
/*  2390 */           reallyHandle_CMD_MOVE_INVENTORY(byteBuffer);
/*       */           break;
/*       */ 
/*       */         
/*       */         case 120:
/*  2395 */           reallyHandle_CMD_CLOSE_INVENTORY_WINDOW(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 15:
/*  2399 */           reallyHandle_CMD_FORM_RESPONSE(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 106:
/*  2403 */           reallyHandle_CMD_BML_FORM(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 79:
/*  2407 */           reallyHandle_CMD_CLIMB(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 46:
/*  2411 */           reallyHandle_CMD_WEATHER_UPDATE();
/*       */           break;
/*       */         
/*       */         case 117:
/*  2415 */           reallyHandle_CMD_WINDIMPACT(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 60:
/*  2419 */           reallyHandle_CMD_MOUNTSPEED(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 59:
/*  2423 */           reallyHandle_CMD_AVAILABLE_SERVER(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 41:
/*  2427 */           reallyHandle_CMD_ERROR(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 16:
/*  2431 */           reallyHandle_CMD_FATAL_ERROR(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 8:
/*  2435 */           this.player.setLink(false);
/*       */           break;
/*       */         
/*       */         case 4:
/*  2439 */           logInfo(this.player.getName() + " sent client quit");
/*  2440 */           this.player.setLink(false);
/*       */           break;
/*       */         
/*       */         case -21:
/*  2444 */           reallyHandle_CMD_SET_BRIDGE(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 51:
/*  2448 */           reallyHandle_CMD_TELEPORT(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -15:
/*  2452 */           reallyHandle_CMD_LOGIN(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 42:
/*  2456 */           reallyHandle_CMD_SET_TRADE_AGREE(byteBuffer);
/*       */           break;
/*       */         
/*       */         case 121:
/*  2460 */           if (this.player.isTrading()) {
/*  2461 */             this.player.getTrade().end((Creature)this.player, true);
/*       */           }
/*       */           break;
/*       */         case 52:
/*  2465 */           reallyHandle_CMD_NEW_FACE(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -8:
/*       */         case -3:
/*       */         case -2:
/*       */         case -1:
/*       */         case 104:
/*       */         case 123:
/*  2474 */           reallyHandle_EIGC(cmd, byteBuffer);
/*       */           break;
/*       */         
/*       */         case 57:
/*  2478 */           reallyHandle_CMD_TAB_CLOSED(byteBuffer);
/*       */           break;
/*       */         case -22:
/*  2481 */           reallyHandle_CMD_TAB_SELECTED(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -34:
/*  2485 */           reallyHandle_CMD_TICKET_ADD(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -35:
/*  2489 */           reallyHandle_CMD_CREATION_WINDOW(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -43:
/*  2493 */           reallyHandle_CMD_MAP_ANNOTATIONS(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -42:
/*  2497 */           reallyHandle_CMD_SEND_WINDOW_TYPE_DATA(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -20:
/*  2501 */           reallyHandle_CMD_SERVERPORTAL(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -6:
/*  2505 */           reallyHandle_CMD_VERIFY_CLIENT_VERSION(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -25:
/*  2509 */           reallyHandle_CMD_BRIDGE(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -24:
/*  2513 */           this.player.getMovementScheme().setFlying((byteBuffer.get() == 1 && this.player.getPower() > 0));
/*       */           break;
/*       */         
/*       */         case -26:
/*  2517 */           reallyHandle_CMD_PERMISSIONS(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -55:
/*  2521 */           reallyHandle_CMD_COOKBOOK(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -62:
/*  2525 */           reallyHandle_CMD_VALREIFIGHT(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -63:
/*  2529 */           reallyHandle_CMD_PLACE_ITEM(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -66:
/*  2533 */           reallyHandle_CMD_OPENCLOSE_WINDOW(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -64:
/*  2537 */           reallyHandle_CMD_FISH(byteBuffer);
/*       */           break;
/*       */         
/*       */         case -39:
/*  2541 */           reallyHandle_CMD_PERSONAL_GOAL_LIST(byteBuffer);
/*       */           break;
/*       */       } 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/*  2573 */     } catch (NoSuchItemException nsi) {
/*       */       
/*  2575 */       logInfo("Unable to find dragged item", (Throwable)nsi);
/*       */     }
/*  2577 */     catch (Exception ex2) {
/*       */       
/*  2579 */       logInfo(this.player.getName() + "- communication failed: ", ex2);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_SPEEDMODIFIER(ByteBuffer byteBuffer) {
/*  2585 */     boolean mountSpeedChanged = (byteBuffer.get() != 0);
/*  2586 */     short mountSpeed = byteBuffer.getShort();
/*  2587 */     if (mountSpeedChanged)
/*       */     {
/*  2589 */       if (!this.player.getMovementScheme().removeMountSpeed(mountSpeed))
/*       */       {
/*  2591 */         if (mountSpeed != 0) {
/*       */           
/*  2593 */           logger.log(Level.WARNING, this.player.getName() + " failed to locate ms=" + mountSpeed);
/*  2594 */           mountSpeedChanged = false;
/*       */         } 
/*       */       }
/*       */     }
/*  2598 */     boolean windImpactChanged = (byteBuffer.get() != 0);
/*  2599 */     byte windImpact = byteBuffer.get();
/*  2600 */     if (windImpactChanged)
/*       */     {
/*  2602 */       if (!this.player.getMovementScheme().removeWindMod(windImpact))
/*       */       {
/*  2604 */         if (windImpact != 0) {
/*       */           
/*  2606 */           logger.log(Level.WARNING, this.player.getName() + " failed to locate wind impact=" + windImpact);
/*  2607 */           windImpactChanged = false;
/*       */         } 
/*       */       }
/*       */     }
/*  2611 */     boolean moveSpeedChanged = (byteBuffer.get() != 0);
/*  2612 */     float moveSpeed = byteBuffer.getFloat();
/*  2613 */     if (moveSpeedChanged)
/*       */     {
/*  2615 */       if (!this.player.getMovementScheme().removeSpeedMod(moveSpeed))
/*       */       {
/*  2617 */         if (moveSpeed != 0.0F) {
/*       */           
/*  2619 */           logger.log(Level.WARNING, this.player.getName() + " failed to locate movespeed=" + moveSpeed);
/*  2620 */           moveSpeedChanged = false;
/*       */         } 
/*       */       }
/*       */     }
/*  2624 */     boolean weatherReceived = (byteBuffer.get() != 0);
/*       */     
/*  2626 */     boolean climbChanged = (byteBuffer.get() != 0);
/*  2627 */     boolean isClimbing = (byteBuffer.get() != 0);
/*       */     
/*  2629 */     if (climbChanged) {
/*       */       
/*  2631 */       if (!isClimbing)
/*       */       {
/*  2633 */         this.player.sentClimbing = 0L;
/*       */       }
/*  2635 */       if (this.player.getVehicle() != -10L)
/*       */       {
/*  2637 */         if (isClimbing) {
/*       */           
/*  2639 */           sendClimb(false);
/*  2640 */           sendNormalServerMessage("You can not climb now.");
/*  2641 */           sendToggle(0, false);
/*       */           return;
/*       */         } 
/*       */       }
/*  2645 */       if (!this.player.isStunned()) {
/*       */         
/*  2647 */         if (this.currentmove != null && this.ready) {
/*       */           
/*  2649 */           this.currentmove.getLast().setToggleClimb(true);
/*  2650 */           this.currentmove.getLast().setClimbing(isClimbing);
/*       */         } else {
/*       */           
/*  2653 */           this.ticker.setServerClimbing(isClimbing);
/*       */         } 
/*       */       } else {
/*       */         
/*  2657 */         sendClimb(false);
/*  2658 */         sendNormalServerMessage("You can not climb right now.");
/*  2659 */         sendToggle(0, false);
/*       */       } 
/*       */     } 
/*  2662 */     if (this.currentmove != null && this.ready) {
/*       */       
/*  2664 */       if (mountSpeedChanged)
/*  2665 */         this.currentmove.getLast().setNewMountSpeed(mountSpeed); 
/*  2666 */       if (windImpactChanged)
/*  2667 */         this.currentmove.getLast().setNewWindMod(windImpact); 
/*  2668 */       if (moveSpeedChanged)
/*  2669 */         this.currentmove.getLast().setNewSpeedMod(moveSpeed); 
/*  2670 */       if (weatherReceived) {
/*  2671 */         this.currentmove.getLast().setWeatherChange(true);
/*       */       }
/*       */     } else {
/*       */       
/*  2675 */       if (!stillLoggingIn() && this.ticker != null) {
/*  2676 */         logger.log(Level.INFO, this.player.getName() + " Changing without currentmove at " + this.ticker.getX() + "," + this.ticker.getY() + " last=" + this.ticker.xOld + "," + this.ticker.yOld + ": windImpactChanged=" + windImpactChanged + "(" + windImpact + "), mountSpeedChanged=" + mountSpeedChanged + "(" + mountSpeed + "), moveSpeedChanged=" + moveSpeedChanged + " (" + moveSpeed + "), weatherReceived=" + weatherReceived);
/*       */       }
/*  2678 */       if (this.currentmove != null) {
/*       */         
/*  2680 */         if (checkMoveChanges())
/*  2681 */           logger.log(Level.WARNING, "Move changes for not ready handled."); 
/*  2682 */         this.currentmove.clear(true, this.ticker, this.player, null);
/*       */       } 
/*  2684 */       this.moves = 0;
/*  2685 */       this.currentmove = null;
/*  2686 */       if (mountSpeedChanged)
/*       */       {
/*  2688 */         this.ticker.setMountSpeed(mountSpeed);
/*       */       }
/*  2690 */       if (windImpactChanged)
/*  2691 */         this.ticker.setWindMod(windImpact); 
/*  2692 */       if (moveSpeedChanged)
/*  2693 */         this.ticker.setSpeedModifier(moveSpeed); 
/*  2694 */       if (weatherReceived) {
/*       */         
/*  2696 */         this.ticker.diffWindX = Server.getWeather().getXWind();
/*  2697 */         this.ticker.diffWindY = Server.getWeather().getYWind();
/*  2698 */         this.ticker.setWindRotation(Server.getWeather().getWindRotation());
/*  2699 */         this.ticker.setWindStrength(Server.getWeather().getWindPower());
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_WINDIMPACT(ByteBuffer byteBuffer) {
/*  2714 */     logger.log(Level.WARNING, this.player.getName() + " Not used!");
/*  2715 */     byte nn = byteBuffer.get();
/*  2716 */     this.player.getMovementScheme().removeWindMod(nn);
/*       */     
/*  2718 */     if (this.currentmove != null && this.ready) {
/*       */       
/*  2720 */       this.currentmove.getLast().setNewWindMod(nn);
/*       */     } else {
/*       */       
/*  2723 */       this.ticker.setWindMod(nn);
/*       */     } 
/*       */   }
/*       */   
/*       */   private void reallyHandle_CMD_MOUNTSPEED(ByteBuffer byteBuffer) {
/*  2728 */     logger.log(Level.WARNING, this.player.getName() + " Not used!");
/*  2729 */     short newMountSpeed = byteBuffer.getShort();
/*  2730 */     this.player.getMovementScheme().removeMountSpeed(newMountSpeed);
/*  2731 */     if (this.currentmove != null && this.ready) {
/*       */       
/*  2733 */       this.currentmove.getLast().setNewMountSpeed(newMountSpeed);
/*       */     } else {
/*       */       
/*  2736 */       this.player.getMovementScheme().setMountSpeed(newMountSpeed);
/*       */     } 
/*       */   }
/*       */   
/*       */   private void reallyHandle_CMD_WEATHER_UPDATE() {
/*  2741 */     logger.log(Level.WARNING, this.player.getName() + " Not used!");
/*  2742 */     if (this.currentmove != null && this.ready) {
/*       */       
/*  2744 */       this.currentmove.getLast().setWeatherChange(true);
/*       */     }
/*       */     else {
/*       */       
/*  2748 */       this.ticker.diffWindX = Server.getWeather().getXWind();
/*  2749 */       this.ticker.diffWindY = Server.getWeather().getYWind();
/*  2750 */       this.ticker.setWindRotation(Server.getWeather().getWindRotation());
/*  2751 */       this.ticker.setWindStrength(Server.getWeather().getWindPower());
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_CLIMB(ByteBuffer byteBuffer) {
/*  2757 */     logger.log(Level.WARNING, this.player.getName() + " Not used!");
/*  2758 */     boolean climbing = (byteBuffer.get() != 0);
/*  2759 */     if (!climbing)
/*       */     {
/*  2761 */       this.player.sentClimbing = 0L;
/*       */     }
/*  2763 */     if (this.player.getVehicle() != -10L)
/*       */     {
/*  2765 */       if (climbing) {
/*       */         
/*  2767 */         sendClimb(false);
/*  2768 */         sendNormalServerMessage("You can not climb now.");
/*  2769 */         sendToggle(0, false);
/*       */         return;
/*       */       } 
/*       */     }
/*  2773 */     if (!this.player.isStunned()) {
/*       */       
/*  2775 */       if (this.currentmove != null && this.ready) {
/*       */         
/*  2777 */         this.currentmove.getLast().setToggleClimb(true);
/*  2778 */         this.currentmove.getLast().setClimbing(climbing);
/*       */       } else {
/*       */         
/*  2781 */         this.ticker.setServerClimbing(climbing);
/*       */       } 
/*       */     } else {
/*       */       
/*  2785 */       sendClimb(false);
/*  2786 */       sendNormalServerMessage("You can not climb right now.");
/*  2787 */       sendToggle(0, false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_CREATION_WINDOW(ByteBuffer byteBuffer) {
/*  2793 */     byte subCommand = byteBuffer.get();
/*  2794 */     if (subCommand == 2)
/*       */     {
/*  2796 */       this.player.setCreationWindowOpen(false); }  } private void reallyHandle_EIGC(byte cmd, ByteBuffer byteBuffer) throws UnsupportedEncodingException { int length; EigcClient client; byte[] tempStringArr; int i; String name; byte[] arrayOfByte1; String inviterName;
/*       */     String mutedName;
/*       */     String invitedName;
/*       */     int teamId;
/*       */     int j;
/*       */     byte muteState;
/*  2802 */     switch (cmd) {
/*       */ 
/*       */       
/*       */       case -1:
/*  2806 */         length = byteBuffer.get() & 0xFF;
/*  2807 */         tempStringArr = new byte[length];
/*  2808 */         byteBuffer.get(tempStringArr);
/*  2809 */         name = new String(tempStringArr, "UTF-8");
/*  2810 */         respondEigcName(name);
/*       */         break;
/*       */ 
/*       */       
/*       */       case -2:
/*  2815 */         length = byteBuffer.get() & 0xFF;
/*  2816 */         tempStringArr = new byte[length];
/*  2817 */         byteBuffer.get(tempStringArr);
/*  2818 */         name = new String(tempStringArr, "UTF-8");
/*  2819 */         respondEigcPlayerName(name);
/*       */         break;
/*       */       
/*       */       case -3:
/*  2823 */         respondEigcLogin(this.player.getName());
/*       */         break;
/*       */       case -8:
/*  2826 */         client = Eigc.getClientForPlayer(this.player.getName());
/*  2827 */         if (client != null) {
/*  2828 */           setEigcServiceState(client.getServiceBundle());
/*       */         }
/*       */         break;
/*       */       
/*       */       case 104:
/*  2833 */         i = byteBuffer.get() & 0xFF;
/*  2834 */         arrayOfByte1 = new byte[i];
/*  2835 */         byteBuffer.get(arrayOfByte1);
/*  2836 */         inviterName = new String(arrayOfByte1, "UTF-8");
/*  2837 */         i = byteBuffer.get() & 0xFF;
/*  2838 */         arrayOfByte1 = new byte[i];
/*  2839 */         byteBuffer.get(arrayOfByte1);
/*  2840 */         invitedName = new String(arrayOfByte1, "UTF-8");
/*       */         
/*  2842 */         j = byteBuffer.getInt();
/*  2843 */         respondEigcTeamInvite(j, inviterName, invitedName);
/*       */         break;
/*       */ 
/*       */ 
/*       */       
/*       */       case 123:
/*  2849 */         i = byteBuffer.get() & 0xFF;
/*  2850 */         arrayOfByte1 = new byte[i];
/*  2851 */         byteBuffer.get(arrayOfByte1);
/*  2852 */         mutedName = new String(arrayOfByte1, "UTF-8");
/*  2853 */         teamId = byteBuffer.getInt();
/*  2854 */         muteState = byteBuffer.get();
/*  2855 */         respondEigcTeamMute(mutedName, teamId, muteState);
/*       */         break;
/*       */     }  }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_FATAL_ERROR(ByteBuffer byteBuffer) {
/*  2863 */     int length = byteBuffer.get() & 0xFF;
/*  2864 */     byte[] tempStringArr = new byte[length];
/*  2865 */     byteBuffer.get(tempStringArr);
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_MORE_ITEMS(ByteBuffer byteBuffer) {
/*  2871 */     long inventoryId = byteBuffer.getLong();
/*  2872 */     long itemid = byteBuffer.getLong();
/*       */     
/*       */     try {
/*  2875 */       Item item = Items.getItem(itemid);
/*  2876 */       item.sendContainedItems(inventoryId, (Creature)this.player);
/*       */ 
/*       */     
/*       */     }
/*  2880 */     catch (NoSuchItemException noSuchItemException) {}
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_EMPTY(ByteBuffer byteBuffer) {
/*  2887 */     int fps = byteBuffer.getInt();
/*       */     
/*  2889 */     int tripCounter = byteBuffer.getInt();
/*  2890 */     if (tripCounter <= 10 || fps > 15);
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_STATE(ByteBuffer byteBuffer) {
/*  2903 */     this.player.gotHash = true;
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_PERMISSIONS(ByteBuffer byteBuffer) throws Exception {
/*       */     String playerName;
/*       */     long pId;
/*       */     byte kingdom;
/*       */     int questionId;
/*       */     Properties answers;
/*       */     String objectName, ownerName;
/*       */     int rows, qId;
/*       */     Properties ans;
/*  2917 */     byte subCommand = byteBuffer.get();
/*  2918 */     switch (subCommand) {
/*       */       
/*       */       case 1:
/*  2921 */         playerName = LoginHandler.raiseFirstLetter(readByteString(byteBuffer));
/*  2922 */         pId = PlayerInfoFactory.getWurmId(playerName);
/*  2923 */         if (pId == -10L) {
/*  2924 */           sendPermissionsAddedManually(playerName, -10L);
/*       */           
/*       */           break;
/*       */         } 
/*  2928 */         kingdom = Players.getInstance().getKingdomForPlayer(pId);
/*       */         
/*  2930 */         if (kingdom == this.player.getKingdomId() || kingdom == 0) {
/*  2931 */           sendPermissionsAddedManually(playerName, pId);
/*       */           break;
/*       */         } 
/*  2934 */         sendNormalServerMessage("You may not permit the enemy " + playerName + " to have any permissions.");
/*       */         
/*  2936 */         sendPermissionsAddedManually(playerName, -10L);
/*       */         break;
/*       */ 
/*       */ 
/*       */       
/*       */       case 2:
/*  2942 */         questionId = byteBuffer.getInt();
/*  2943 */         answers = new Properties();
/*  2944 */         objectName = readByteString(byteBuffer);
/*  2945 */         answers.put("object", objectName);
/*       */         
/*  2947 */         ownerName = readByteString(byteBuffer);
/*  2948 */         ownerName = LoginHandler.raiseFirstLetter(ownerName);
/*  2949 */         answers.put("owner", ownerName);
/*       */ 
/*       */         
/*  2952 */         answers.put("manage", "" + ((byteBuffer.get() == 1) ? 1 : 0));
/*       */         
/*  2954 */         rows = byteBuffer.getShort() & 0xFFFF;
/*  2955 */         answers.put("rows", "" + rows);
/*  2956 */         if (rows > 0) {
/*       */           
/*  2958 */           int cols = byteBuffer.get() & 0xFF;
/*  2959 */           answers.put("cols", "" + cols);
/*  2960 */           for (int row = 0; row < rows; row++) {
/*       */             
/*  2962 */             long aId = byteBuffer.getLong();
/*  2963 */             answers.put("r" + row, "" + aId);
/*  2964 */             for (int col = 0; col < cols; col++) {
/*       */               
/*  2966 */               byte flag = byteBuffer.get();
/*  2967 */               answers.put("r" + row + "c" + col, "" + ((flag == 1) ? 1 : 0));
/*       */             } 
/*       */           } 
/*       */         } 
/*       */         
/*       */         try {
/*  2973 */           Question question = Questions.getQuestion(questionId);
/*  2974 */           question.answer(answers);
/*  2975 */           Questions.removeQuestion(question);
/*       */         
/*       */         }
/*  2978 */         catch (NoSuchQuestionException nsq) {
/*       */           
/*  2980 */           sendSafeServerMessage("You answered an old question. It has timed out over 15 minutes or been replaced by a more recent.");
/*       */         } 
/*       */         break;
/*       */ 
/*       */       
/*       */       case 3:
/*  2986 */         qId = byteBuffer.getInt();
/*  2987 */         ans = new Properties();
/*  2988 */         ans.put("back", "true");
/*       */         
/*       */         try {
/*  2991 */           Question question = Questions.getQuestion(qId);
/*  2992 */           question.answer(ans);
/*  2993 */           Questions.removeQuestion(question);
/*       */         }
/*  2995 */         catch (NoSuchQuestionException nsq) {
/*       */           
/*  2997 */           sendSafeServerMessage("You answered an old question. It has timed out over 15 minutes or been replaced by a more recent.");
/*       */         } 
/*       */         break;
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_BRIDGE(ByteBuffer byteBuffer) throws UnsupportedEncodingException {
/*  3006 */     int startX = byteBuffer.getInt();
/*  3007 */     int startY = byteBuffer.getInt();
/*  3008 */     int startH = byteBuffer.getInt();
/*  3009 */     Point start = new Point(startX, startY, startH);
/*  3010 */     int endX = byteBuffer.getInt();
/*  3011 */     int endY = byteBuffer.getInt();
/*  3012 */     int endH = byteBuffer.getInt();
/*  3013 */     Point end = new Point(endX, endY, endH);
/*       */     
/*  3015 */     byte[] tempStringArr = new byte[byteBuffer.get() & 0xFF];
/*  3016 */     byteBuffer.get(tempStringArr);
/*  3017 */     String bridgeName = new String(tempStringArr, "UTF-8");
/*       */     
/*  3019 */     byte dir = byteBuffer.get();
/*  3020 */     byte bridgeType = byteBuffer.get();
/*       */     
/*  3022 */     byte[] tempStringArr2 = new byte[byteBuffer.get() & 0xFF];
/*  3023 */     byteBuffer.get(tempStringArr2);
/*  3024 */     String bridgePlan = new String(tempStringArr2, "UTF-8");
/*       */     
/*  3026 */     PlanBridgeMethods.planBridge((Creature)this.player, dir, bridgeType, false, bridgePlan, 0, start, end, bridgeName);
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_VERIFY_CLIENT_VERSION(ByteBuffer byteBuffer) throws IOException {
/*  3122 */     this.player.clearRespondTo();
/*       */   }
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_SERVERPORTAL(ByteBuffer byteBuffer) {
/*  3127 */     Item portal = null;
/*  3128 */     for (Item item : Items.getAllItems()) {
/*  3129 */       if (item.getTemplateId() == 855) {
/*       */         
/*  3131 */         portal = item; break;
/*       */       } 
/*       */     } 
/*  3134 */     int server = byteBuffer.getInt();
/*  3135 */     PortalQuestion pq = new PortalQuestion((Creature)this.player, "Select allegiance", "Please select kingdom", portal);
/*       */ 
/*       */     
/*  3138 */     pq.sendQuestion2(server);
/*       */   }
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_SEND_WINDOW_TYPE_DATA(ByteBuffer byteBuffer) {
/*  3143 */     byte windowType = byteBuffer.get();
/*  3144 */     switch (windowType) {
/*       */ 
/*       */       
/*       */       case 0:
/*  3148 */         handleRecruitWindowDataMessage(byteBuffer);
/*       */         return;
/*       */     } 
/*       */ 
/*       */     
/*  3153 */     logInfo(this.player.getName() + ": Trying to send data from unknown window: " + windowType);
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_MAP_ANNOTATIONS(ByteBuffer byteBuffer) throws UnsupportedEncodingException {
/*  3160 */     byte cmdType = byteBuffer.get();
/*  3161 */     if (cmdType == 0) {
/*       */       
/*  3163 */       byte type = byteBuffer.get();
/*       */       
/*  3165 */       int nameLength = byteBuffer.getShort();
/*  3166 */       byte[] nameBytes = new byte[nameLength];
/*  3167 */       byteBuffer.get(nameBytes);
/*  3168 */       String name = new String(nameBytes, "UTF-8");
/*       */       
/*  3170 */       int serverNameLength = byteBuffer.getShort();
/*  3171 */       byte[] serverBytes = new byte[serverNameLength];
/*  3172 */       byteBuffer.get(serverBytes);
/*  3173 */       String server = new String(serverBytes, "UTF-8");
/*       */       
/*  3175 */       int x = byteBuffer.getInt();
/*  3176 */       int y = byteBuffer.getInt();
/*  3177 */       byte icon = byteBuffer.get();
/*       */       
/*  3179 */       this.player.createNewMapPOI(name, type, x, y, server, icon);
/*  3180 */     } else if (cmdType == 1) {
/*       */       
/*  3182 */       long id = byteBuffer.getLong();
/*  3183 */       byte type = byteBuffer.get();
/*       */       
/*  3185 */       MapAnnotation anno = this.player.getAnnotation(id, type);
/*  3186 */       if (anno != null)
/*  3187 */         this.player.removeMapPOI(anno); 
/*  3188 */     } else if (cmdType == 2) {
/*       */       
/*  3190 */       sendMapAnnotationPermissions();
/*       */     } else {
/*  3192 */       logWarn("Unknown annotation command sent: " + cmdType);
/*       */     } 
/*       */   }
/*       */   
/*       */   private void reallyHandle_CMD_TICKET_ADD(ByteBuffer byteBuffer) throws UnsupportedEncodingException {
/*  3197 */     byte category = byteBuffer.get();
/*  3198 */     byte[] tempStringArr = new byte[byteBuffer.get() & 0xFF];
/*  3199 */     byteBuffer.get(tempStringArr);
/*  3200 */     String message = new String(tempStringArr, "UTF-8");
/*       */     
/*  3202 */     if (Tickets.checkForFlooding(this.player.getWurmId())) {
/*  3203 */       sendNormalServerMessage("Sorry but your support call cannot be taken right now as you already have some in the queue.");
/*       */     } else {
/*       */       
/*  3206 */       Tickets.addTicket(new Ticket(this.player.getWurmId(), this.player
/*  3207 */             .getName(), category, message), false);
/*       */     } 
/*       */   }
/*       */   
/*       */   private void reallyHandle_CMD_TAB_SELECTED(ByteBuffer byteBuffer) throws UnsupportedEncodingException {
/*  3212 */     byte[] tempStringArr = new byte[byteBuffer.get() & 0xFF];
/*  3213 */     byteBuffer.get(tempStringArr);
/*  3214 */     String title = new String(tempStringArr, "UTF-8");
/*  3215 */     if (title.equalsIgnoreCase(":Support"))
/*       */     {
/*       */       
/*  3218 */       Tickets.acknowledgeTicketUpdatesFor(this.player);
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_TAB_CLOSED(ByteBuffer byteBuffer) throws UnsupportedEncodingException {
/*  3224 */     byte[] tempStringArr = new byte[byteBuffer.get() & 0xFF];
/*  3225 */     byteBuffer.get(tempStringArr);
/*  3226 */     String title = new String(tempStringArr, "UTF-8");
/*  3227 */     if (title.startsWith("PM: ")) {
/*       */ 
/*       */       
/*  3230 */       StringTokenizer tokens = new StringTokenizer(title);
/*  3231 */       tokens.nextToken();
/*  3232 */       String targetName = "Unknown";
/*  3233 */       if (tokens.hasMoreTokens())
/*  3234 */         targetName = tokens.nextToken().trim(); 
/*  3235 */       this.player.closePM(targetName);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_NEW_FACE(ByteBuffer byteBuffer) {
/*  3241 */     long face = byteBuffer.getLong();
/*  3242 */     long itemId = byteBuffer.getLong();
/*       */     
/*       */     try {
/*  3245 */       Item i = Items.getItem(itemId);
/*  3246 */       if (!i.deleted && i.getOwnerId() == this.player.getWurmId())
/*       */       {
/*  3248 */         this.player.getSaveFile().setFace(face);
/*  3249 */         if (this.player.getCurrentTile() != null)
/*  3250 */           this.player.getCurrentTile().setNewFace((Creature)this.player); 
/*  3251 */         sendSafeServerMessage("The mirror disintegrates into nothing as the last of its magic is used.");
/*  3252 */         Items.destroyItem(itemId);
/*       */       }
/*       */     
/*  3255 */     } catch (NoSuchItemException nso) {
/*       */       
/*  3257 */       logger.warning("No such mirror item " + itemId + " for " + this.player.getName());
/*       */     }
/*  3259 */     catch (IOException ex) {
/*       */       
/*  3261 */       logger.warning("Unable to set new face for " + this.player.getName() + ": " + ex.getMessage());
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_SET_TRADE_AGREE(ByteBuffer byteBuffer) {
/*  3267 */     int agree = byteBuffer.get();
/*  3268 */     int id = byteBuffer.getInt();
/*  3269 */     if (!this.player.isDead()) {
/*       */       
/*  3271 */       if (this.player.isTrading()) {
/*       */         
/*  3273 */         this.player.getTrade().setSatisfied((Creature)this.player, (agree != 0), id);
/*  3274 */         if (agree != 0)
/*       */         {
/*  3276 */           if (this.invulnerable) {
/*       */             
/*  3278 */             setInvulnerable(false);
/*  3279 */             sendNormalServerMessage("You are no longer invulnerable.");
/*       */           } 
/*       */         }
/*       */       } 
/*  3283 */     } else if (this.player.isTrading()) {
/*  3284 */       this.player.getTrade().end((Creature)this.player, true);
/*       */     } 
/*       */   }
/*       */   
/*       */   private void reallyHandle_CMD_LOGIN(ByteBuffer byteBuffer) throws UnsupportedEncodingException {
/*  3289 */     int length = byteBuffer.get() & 0xFF;
/*  3290 */     byte[] tempStringArr = new byte[length];
/*  3291 */     byteBuffer.get(tempStringArr);
/*  3292 */     String name = new String(tempStringArr, "UTF-8");
/*  3293 */     length = byteBuffer.get() & 0xFF;
/*  3294 */     tempStringArr = new byte[length];
/*  3295 */     byteBuffer.get(tempStringArr);
/*  3296 */     logInfo("Player with name " + name + " tries to login although he is already logged in.");
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_TELEPORT(ByteBuffer byteBuffer) {
/*  3303 */     int counter = byteBuffer.getInt();
/*  3304 */     this.moves = 0;
/*  3305 */     this.receivedTicks = false;
/*  3306 */     if (this.player.isLogged()) {
/*  3307 */       logInfo(this.player.getName() + " is teleporting counter at " + this.player.getTeleportCounter() + " received " + counter + " justlogged on:=" + this.justLoggedIn);
/*       */     }
/*  3309 */     if (!((counter == this.player.getTeleportCounter()) ? 1 : 0)) {
/*       */       
/*  3311 */       if (this.player.getMovementScheme().isIntraTeleporting()) {
/*       */         
/*  3313 */         this.player.getMovementScheme().removeIntraTeleport(counter);
/*  3314 */         if (this.player.isLogged())
/*       */         {
/*  3316 */           logInfo("No longer intrateleporting but still teleporting.");
/*       */         }
/*       */       } 
/*  3319 */       if (this.justLoggedIn) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */         
/*  3326 */         this.player.teleport((this.player.getVisionArea() == null));
/*  3327 */         if (this.player.isLogged()) {
/*  3328 */           logInfo(this.player.getName() + " just logged on. Probably on vehicle. Teleport.");
/*       */         }
/*       */       } 
/*       */       return;
/*       */     } 
/*  3333 */     if (this.player.isTeleporting()) {
/*       */       
/*  3335 */       if (this.player.getMovementScheme().isIntraTeleporting()) {
/*       */         
/*  3337 */         if (this.player.isLogged())
/*  3338 */           logInfo(this.player.getName() + " is intraporting."); 
/*  3339 */         if (this.player.getMovementScheme().removeIntraTeleport(counter)) {
/*       */           
/*  3341 */           if (this.player.isLogged())
/*  3342 */             logInfo(this.player.getName() + " removed intraport for " + counter); 
/*  3343 */           if (this.player.transferCounter <= 0) {
/*       */             
/*  3345 */             if (this.player.isLogged())
/*  3346 */               logInfo(this.player.getName() + " setting ready"); 
/*  3347 */             setReady(true);
/*  3348 */             this.player.getMovementScheme().resumeSpeedModifier();
/*  3349 */           } else if (this.player.isLogged()) {
/*  3350 */             logInfo(this.player.getName() + " transfercounter= " + this.player.transferCounter);
/*  3351 */           }  if (this.player.getVehicle() == -10L) {
/*       */             
/*  3353 */             if (this.player.isLogged())
/*  3354 */               logInfo(this.player.getName() + " vehicle=" + this.player.getVehicle()); 
/*  3355 */             this.player.getMovementScheme().setMooredMod(false);
/*  3356 */             this.player.getMovementScheme().addWindImpact((byte)0);
/*  3357 */             this.player.calcBaseMoveMod();
/*       */           } 
/*  3359 */           this.player.setTeleporting(false);
/*       */         } else {
/*  3361 */           logWarn("Counter is correct. Was intrateleporting but there still seems to remain some teleport.");
/*       */         }
/*       */       
/*  3364 */       } else if (this.player.isWithinTeleportTime()) {
/*       */         
/*  3366 */         if (this.justLoggedIn) {
/*       */           
/*  3368 */           this.justLoggedIn = false;
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */           
/*  3374 */           setReady(true);
/*       */           
/*  3376 */           this.player.setTeleporting(false);
/*  3377 */           if (this.player.isLogged()) {
/*  3378 */             logInfo(this.player.getName() + " just logged on");
/*       */           }
/*       */         } else {
/*  3381 */           this.player.teleport();
/*  3382 */           if (this.player.isLogged()) {
/*  3383 */             logInfo(this.player.getName() + " teleported");
/*       */           }
/*       */         } 
/*       */       } else {
/*  3387 */         sendAlertServerMessage("The time for the teleport was exceeded. You may try again.");
/*  3388 */         this.player.cancelTeleport();
/*       */       
/*       */       }
/*       */     
/*       */     }
/*  3393 */     else if (this.justLoggedIn) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/*  3400 */       this.justLoggedIn = false;
/*       */ 
/*       */ 
/*       */       
/*  3404 */       setReady(true);
/*       */       
/*  3406 */       this.player.setTeleporting(false);
/*  3407 */       if (this.player.isLogged()) {
/*  3408 */         logInfo(this.player.getName() + " just logged on. End logged.");
/*       */       }
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_SET_BRIDGE(ByteBuffer byteBuffer) {
/*  3416 */     this.newBridgeId = byteBuffer.getLong();
/*  3417 */     if (this.currentmove == null) {
/*       */ 
/*       */ 
/*       */       
/*  3421 */       this.newBridgeId = -10L;
/*  3422 */       this.receivedBridgeChange = false;
/*       */     } else {
/*  3424 */       this.receivedBridgeChange = true;
/*       */     } 
/*       */   }
/*       */   
/*       */   private void reallyHandle_CMD_ERROR(ByteBuffer byteBuffer) throws UnsupportedEncodingException {
/*  3429 */     int length = byteBuffer.getShort() & 0xFFFF;
/*  3430 */     byte[] tempStringArr = new byte[length];
/*  3431 */     byteBuffer.get(tempStringArr);
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/*  3440 */     if (byteBuffer.hasRemaining()) {
/*       */       
/*  3442 */       int length2 = byteBuffer.getShort() & 0xFFFF;
/*  3443 */       byte[] tempStringArr2 = new byte[length2];
/*  3444 */       byteBuffer.get(tempStringArr2);
/*  3445 */       this.macAddr = new String(tempStringArr2, "UTF-8");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_AVAILABLE_SERVER(ByteBuffer byteBuffer) {
/*  3452 */     byte direction = byteBuffer.get();
/*  3453 */     boolean avail = (byteBuffer.get() > 0);
/*  3454 */     if (direction == 0) {
/*  3455 */       this.ticker.serverNorthAvailable = avail;
/*  3456 */     } else if (direction == 4) {
/*  3457 */       this.ticker.serverSouthAvailable = avail;
/*  3458 */     } else if (direction == 6) {
/*  3459 */       this.ticker.serverWestAvailable = avail;
/*  3460 */     } else if (direction == 2) {
/*  3461 */       this.ticker.serverEastAvailable = avail;
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_BML_FORM(ByteBuffer byteBuffer) throws UnsupportedEncodingException {
/*  3470 */     byte verifier = byteBuffer.get();
/*  3471 */     byte[] tempStringArr = new byte[byteBuffer.get() & 0xFF];
/*  3472 */     byteBuffer.get(tempStringArr);
/*  3473 */     String buttonId = new String(tempStringArr, "UTF-8");
/*       */     
/*  3475 */     int keysize = byteBuffer.getShort() & 0xFFFF;
/*  3476 */     Properties answers = new Properties();
/*  3477 */     for (int x = 0; x < keysize; x++) {
/*       */       
/*  3479 */       tempStringArr = new byte[byteBuffer.get() & 0xFF];
/*  3480 */       byteBuffer.get(tempStringArr);
/*  3481 */       String key = new String(tempStringArr, "UTF-8");
/*       */       
/*  3483 */       tempStringArr = new byte[byteBuffer.getShort()];
/*  3484 */       byteBuffer.get(tempStringArr);
/*  3485 */       String value = new String(tempStringArr, "UTF-8");
/*       */       
/*  3487 */       answers.put(key, value);
/*       */     } 
/*  3489 */     if (!buttonId.equals("submit"))
/*       */     {
/*  3491 */       answers.put(buttonId, "true");
/*       */     }
/*  3493 */     String ids = answers.getProperty("id");
/*  3494 */     String tutId = answers.getProperty("tutorialid");
/*  3495 */     if (ids != null && !ids.isEmpty()) {
/*       */       
/*  3497 */       int id = Integer.parseInt(ids);
/*       */       
/*       */       try {
/*  3500 */         Question question = Questions.getQuestion(id);
/*  3501 */         if (question.getResponder() == this.player || (question instanceof VillageJoinQuestion && ((VillageJoinQuestion)question).getInvited().getWurmId() == this.player.getWurmId()) || (question instanceof TeamManagementQuestion && ((TeamManagementQuestion)question).getInvited().getWurmId() == this.player.getWurmId()))
/*       */         {
/*  3503 */           if (!buttonId.isEmpty())
/*  3504 */             question.answer(answers); 
/*  3505 */           Questions.removeQuestion(question);
/*       */         }
/*       */       
/*  3508 */       } catch (NoSuchQuestionException nsq) {
/*       */         
/*  3510 */         sendSafeServerMessage("You answered an old question. It has timed out over 15 minutes or been replaced by a more recent.");
/*       */       }
/*       */     
/*  3513 */     } else if (tutId != null && !tutId.isEmpty()) {
/*       */       
/*  3515 */       if (PlayerTutorial.doesTutorialExist(this.player.getWurmId())) {
/*  3516 */         PlayerTutorial.getTutorialForPlayer(this.player.getWurmId(), false).updateReceived(answers);
/*       */       }
/*       */     } 
/*       */   }
/*       */   
/*       */   private void reallyHandle_CMD_FORM_RESPONSE(ByteBuffer byteBuffer) throws UnsupportedEncodingException {
/*  3522 */     int keysize = byteBuffer.getShort() & 0xFFFF;
/*  3523 */     Properties answers = new Properties();
/*  3524 */     for (int x = 0; x < keysize; x++) {
/*       */       
/*  3526 */       byte[] tempStringArr = new byte[byteBuffer.get() & 0xFF];
/*  3527 */       byteBuffer.get(tempStringArr);
/*  3528 */       String key = new String(tempStringArr, "UTF-8");
/*  3529 */       tempStringArr = new byte[byteBuffer.getShort()];
/*  3530 */       byteBuffer.get(tempStringArr);
/*  3531 */       String value = new String(tempStringArr, "UTF-8");
/*  3532 */       answers.put(key, value);
/*       */     } 
/*  3534 */     String ids = answers.getProperty("id");
/*  3535 */     int id = Integer.parseInt(ids);
/*       */     
/*       */     try {
/*  3538 */       Question question = Questions.getQuestion(id);
/*       */       
/*  3540 */       if (question.getResponder() == this.player)
/*       */       {
/*  3542 */         question.answer(answers);
/*  3543 */         commandAction = question.getType();
/*       */       }
/*       */     
/*  3546 */     } catch (NoSuchQuestionException nsq) {
/*       */       
/*  3548 */       sendSafeServerMessage("You answered an old question. It has timed out after 15 minutes or has been replaced by a more recent one.");
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_CLOSE_INVENTORY_WINDOW(ByteBuffer byteBuffer) {
/*  3554 */     long targetId = byteBuffer.getLong();
/*  3555 */     if (WurmId.getType(targetId) == 13) {
/*  3556 */       this.player.closeBank();
/*       */     } else {
/*       */ 
/*       */       
/*       */       try {
/*  3561 */         Item item = Items.getItem(targetId);
/*  3562 */         if (item.getOwnerId() != this.player.getWurmId())
/*       */         {
/*  3564 */           if (item.getParentId() == -10L) {
/*  3565 */             item.removeWatcher((Creature)this.player, true);
/*       */           } else {
/*       */             
/*  3568 */             boolean found = false;
/*       */             
/*       */             try {
/*  3571 */               Creature[] crets = item.getParent().getWatchers();
/*  3572 */               for (int x = 0; x < crets.length; x++)
/*       */               {
/*  3574 */                 if (crets[x].getWurmId() == this.player.getWurmId())
/*       */                 {
/*  3576 */                   found = true;
/*       */                 }
/*       */               }
/*       */             
/*  3580 */             } catch (NoSuchItemException noSuchItemException) {
/*       */ 
/*       */             
/*       */             }
/*  3584 */             catch (NoSuchCreatureException noSuchCreatureException) {}
/*       */ 
/*       */ 
/*       */             
/*  3588 */             if (!found)
/*  3589 */               item.removeWatcher((Creature)this.player, true); 
/*       */           } 
/*       */         }
/*  3592 */         sendCloseInventoryWindow(targetId);
/*       */       }
/*  3594 */       catch (NoSuchItemException nsi) {
/*       */         
/*  3596 */         logInfo("No container to close with id " + targetId);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_MOVE_INVENTORY(ByteBuffer byteBuffer) throws NoSuchItemException, IOException {
/*  3603 */     long now = System.currentTimeMillis();
/*       */ 
/*       */ 
/*       */     
/*  3607 */     int nums = byteBuffer.getShort() & 0xFFFF;
/*       */     
/*  3609 */     this.subjectIds = new long[nums];
/*       */     
/*  3611 */     for (int x = 0; x < nums; x++)
/*       */     {
/*  3613 */       this.subjectIds[x] = byteBuffer.getLong();
/*       */     }
/*       */     
/*  3616 */     long targetId = byteBuffer.getLong();
/*  3617 */     commandAction = targetId;
/*  3618 */     if (targetId == -1L)
/*  3619 */       targetId = this.player.getInventory().getWurmId(); 
/*  3620 */     if (WurmId.getType(targetId) == 8 || WurmId.getType(targetId) == 32) {
/*       */       return;
/*       */     }
/*       */     
/*  3624 */     if (this.player.isUndead()) {
/*       */       return;
/*       */     }
/*  3627 */     this.coins = null;
/*  3628 */     this.subjectItem = null;
/*  3629 */     boolean checkedParent = false;
/*       */ 
/*       */     
/*       */     try {
/*  3633 */       Item target = Items.getItem(targetId);
/*  3634 */       if (target.getTemplateId() == 1392) {
/*  3635 */         targetId = target.getParentId();
/*       */       }
/*  3637 */     } catch (NoSuchItemException noSuchItemException) {}
/*       */ 
/*       */ 
/*       */ 
/*       */     
/*  3642 */     int maxLength = 6;
/*       */     
/*  3644 */     int moved = 0;
/*  3645 */     for (int s = 0; s < nums; s++) {
/*       */       
/*  3647 */       if (s >= 100) {
/*       */         
/*  3649 */         sendNormalServerMessage("You may only move max 100 items at a time.");
/*  3650 */         handleCoins(this.coins);
/*       */         
/*       */         break;
/*       */       } 
/*  3654 */       if (WurmId.getType(this.subjectIds[s]) == 8 || WurmId.getType(this.subjectIds[s]) == 32) {
/*       */         
/*  3656 */         handleCoins(this.coins);
/*       */         return;
/*       */       } 
/*  3659 */       this.subjectItem = Items.getItem(this.subjectIds[s]);
/*       */       
/*  3661 */       if (this.subjectItem.getTemplateId() == 1311) {
/*       */         
/*  3663 */         sendNormalServerMessage("You can only load or unload this item.");
/*       */         
/*       */         return;
/*       */       } 
/*  3667 */       boolean held = false;
/*  3668 */       long subjectOwnerId = this.subjectItem.getOwnerId();
/*  3669 */       if (subjectOwnerId == this.player.getWurmId())
/*  3670 */         held = true; 
/*  3671 */       if ((this.subjectItem.isBodyPart() && this.subjectItem.getAuxData() != 100) || this.subjectItem
/*  3672 */         .getTemplateId() == 0 || this.subjectItem.getTemplateId() == 1392) {
/*       */         
/*  3674 */         sendNormalServerMessage("You cannot move that.");
/*  3675 */         handleCoins(this.coins);
/*       */         return;
/*       */       } 
/*  3678 */       if (this.subjectItem.isBeingWorkedOn()) {
/*       */         long lOwner;
/*       */ 
/*       */         
/*       */         try {
/*  3683 */           lOwner = this.subjectItem.getOwner();
/*  3684 */         } catch (NotOwnedException e) {
/*       */           
/*  3686 */           lOwner = -1L;
/*       */         } 
/*       */         
/*  3689 */         if (lOwner != -1L) {
/*  3690 */           sendNormalServerMessage("You are working with that item.");
/*       */         } else {
/*  3692 */           sendNormalServerMessage("That item is already busy");
/*  3693 */         }  handleCoins(this.coins); return;
/*       */       } 
/*  3695 */       if (this.subjectItem.isOutsideOnly() || this.subjectItem.isComponentItem()) {
/*       */         
/*  3697 */         sendNormalServerMessage("You cannot move that.");
/*  3698 */         handleCoins(this.coins); return;
/*       */       } 
/*  3700 */       if (this.subjectItem.mailed) {
/*       */         
/*  3702 */         sendNormalServerMessage("You cannot reach that now. It is in the mail.");
/*       */         
/*       */         return;
/*       */       } 
/*  3706 */       if (targetId < 5L) {
/*       */         
/*  3708 */         if (!this.player.isTrading()) {
/*       */           
/*  3710 */           sendAlertServerMessage("You are not trading.");
/*       */           
/*       */           return;
/*       */         } 
/*  3714 */         Trade trade = this.player.getTrade();
/*  3715 */         if (this.subjectItem.isLiquid()) {
/*       */           return;
/*       */         }
/*       */ 
/*       */ 
/*       */         
/*  3721 */         if (this.subjectItem.getTemplateId() == 300 && this.subjectItem.getData() == trade.creatureTwo.getWurmId()) {
/*       */           return;
/*       */         }
/*       */ 
/*       */         
/*  3726 */         if (this.player.getPower() == 0 && trade.creatureTwo.getPower() == 0 && (this.subjectItem
/*  3727 */           .isVillageDeed() || this.subjectItem.isHomesteadDeed())) {
/*       */           
/*  3729 */           if (targetId == 4L && !this.player.isReallyPaying() && (this.subjectItem.getData2() > 0 || Servers.localServer.EPIC)) {
/*       */             
/*  3731 */             sendNormalServerMessage("You must be a premium player in order to receive settlement forms and deeds.");
/*       */             return;
/*       */           } 
/*  3734 */           if (this.subjectItem.getData2() > 0) {
/*       */             
/*  3736 */             if (trade.creatureTwo != this.player && this.subjectItem.getData2() != trade.creatureTwo.getVillageId())
/*       */             {
/*  3738 */               if (trade.creatureTwo.isPlayer() && trade.creatureTwo.mayChangeVillageInMillis() > 0L) {
/*       */                 
/*  3740 */                 sendNormalServerMessage(trade.creatureTwo.getName() + " may not change village until " + 
/*  3741 */                     Server.getTimeFor(trade.creatureTwo.mayChangeVillageInMillis()) + " has elapsed.");
/*       */                 return;
/*       */               } 
/*       */             }
/*  3745 */             if (trade.creatureOne != this.player && this.subjectItem.getData2() != trade.creatureOne.getVillageId())
/*       */             {
/*  3747 */               if (trade.creatureOne.isPlayer() && trade.creatureOne.mayChangeVillageInMillis() > 0L) {
/*       */                 
/*  3749 */                 sendNormalServerMessage(trade.creatureOne.getName() + " may not change village until " + 
/*  3750 */                     Server.getTimeFor(trade.creatureOne.mayChangeVillageInMillis()) + " has elapsed.");
/*       */                 
/*       */                 return;
/*       */               } 
/*       */             }
/*       */           } 
/*       */         } 
/*  3757 */         TradingWindow window = trade.getTradingWindow(targetId);
/*       */         
/*  3759 */         if (this.subjectItem.isTraded()) {
/*       */           
/*  3761 */           TradingWindow currWin = this.subjectItem.getTradeWindow();
/*  3762 */           if (currWin.mayMoveItemToWindow(this.subjectItem, (Creature)this.player, targetId))
/*       */           {
/*  3764 */             currWin.removeItem(this.subjectItem);
/*  3765 */             window.startReceivingItems();
/*  3766 */             window.addItem(this.subjectItem);
/*  3767 */             window.stopReceivingItems();
/*       */           }
/*       */         
/*  3770 */         } else if (held) {
/*       */           
/*  3772 */           if (window.mayAddFromInventory((Creature)this.player, this.subjectItem)) {
/*       */             
/*  3774 */             window.startReceivingItems();
/*  3775 */             window.addItem(this.subjectItem);
/*  3776 */             window.stopReceivingItems();
/*       */           } 
/*       */         } else {
/*       */           return;
/*       */         } 
/*       */ 
/*       */ 
/*       */         
/*       */         continue;
/*       */       } 
/*       */ 
/*       */ 
/*       */       
/*  3789 */       Communicator playerComm = this.player.getCommunicator();
/*  3790 */       if (WurmId.getType(targetId) == 13) {
/*       */ 
/*       */         
/*  3793 */         if (this.player.isTrading()) {
/*       */           
/*  3795 */           sendNormalServerMessage("You are trading and may not perform bank actions.");
/*       */           
/*       */           return;
/*       */         } 
/*  3799 */         if (this.player.isDead()) {
/*       */           
/*  3801 */           sendNormalServerMessage("You cannot reach that now.");
/*  3802 */           handleCoins(this.coins);
/*       */           
/*       */           return;
/*       */         } 
/*  3806 */         Bank bank = Banks.getBank(this.player.getWurmId());
/*  3807 */         if (!bank.open) {
/*       */           
/*  3809 */           logWarn(this.player.getName() + " tried to drag to bank while it is closed.");
/*  3810 */           handleCoins(this.coins);
/*       */           
/*       */           return;
/*       */         } 
/*  3814 */         if (this.subjectItem.isBanked()) {
/*       */           return;
/*       */         }
/*       */ 
/*       */         
/*  3819 */         if (this.subjectItem.isBulkContainer() || this.subjectItem.isBulkItem()) {
/*       */           
/*  3821 */           playerComm.sendNormalServerMessage("You may not bank the " + this.subjectItem.getName() + ".");
/*       */           
/*       */           continue;
/*       */         } 
/*  3825 */         if (!this.subjectItem.isAlwaysBankable() && (this.subjectItem.isNoDrop() || this.subjectItem.isArtifact() || this.subjectItem
/*  3826 */           .isBodyPart() || this.subjectItem.isTemporary() || this.subjectItem.isLiquid() || this.subjectItem
/*  3827 */           .isNoBank())) {
/*       */           
/*  3829 */           playerComm.sendNormalServerMessage("You may not bank the " + this.subjectItem.getName() + ".");
/*       */           
/*       */           continue;
/*       */         } 
/*  3833 */         if (this.subjectItem.isLocked()) {
/*       */           
/*  3835 */           playerComm.sendNormalServerMessage("You may not bank locked items.");
/*       */           
/*       */           continue;
/*       */         } 
/*  3839 */         if (this.subjectItem.getOwnerId() != this.player.getWurmId()) {
/*       */           
/*  3841 */           playerComm.sendNormalServerMessage("You must possess the " + this.subjectItem.getName() + " in order to bank it.");
/*       */           
/*       */           continue;
/*       */         } 
/*  3845 */         if (this.subjectItem.isHollow() && !this.subjectItem.isEmpty(true)) {
/*       */           
/*  3847 */           boolean skip = false;
/*  3848 */           for (Item item : this.subjectItem.getAllItems(true)) {
/*  3849 */             if (item.getTemplateId() != 1392)
/*  3850 */               skip = true; 
/*       */           } 
/*  3852 */           if (skip) {
/*       */             
/*  3854 */             playerComm.sendNormalServerMessage("You may only bank empty containers.");
/*       */             
/*       */             continue;
/*       */           } 
/*       */         } 
/*  3859 */         if (this.subjectItem.isCoin()) {
/*       */           
/*  3861 */           if (this.coins == null)
/*  3862 */             this.coins = new HashSet<>(); 
/*  3863 */           this.coins.add(this.subjectItem);
/*       */           
/*       */           continue;
/*       */         } 
/*  3867 */         if (!bank.addItem(this.subjectItem)) {
/*       */           
/*  3869 */           playerComm.sendNormalServerMessage("The bank is full. Remove something first.");
/*  3870 */           handleCoins(this.coins);
/*       */           
/*       */           return;
/*       */         } 
/*       */         
/*  3875 */         if (this.subjectItem.isFood()) {
/*       */           
/*  3877 */           float damageToSet = this.subjectItem.getDamage() + 5.0F + Server.rand.nextFloat() * 10.0F;
/*  3878 */           this.subjectItem.setDamage(damageToSet);
/*  3879 */           sendNormalServerMessage("The " + this.subjectItem.getName() + " gets dirty.");
/*       */ 
/*       */           
/*  3882 */           if (damageToSet >= 100.0F) {
/*       */             continue;
/*       */           }
/*       */         } 
/*       */         
/*       */         try {
/*  3888 */           Item parent = this.subjectItem.getParent();
/*  3889 */           parent.dropItem(this.subjectItem.getWurmId(), true);
/*  3890 */           sendAddToInventory(this.subjectItem, bank.id, 0L, -1);
/*       */         }
/*  3892 */         catch (NoSuchItemException nsi) {
/*       */           
/*  3894 */           logWarn(this.subjectItem.getName() + " had no parent when banking?");
/*  3895 */           playerComm.sendNormalServerMessage(this.subjectItem.getName() + " does not belong to you. Report this as an error.");
/*       */           return;
/*       */         } 
/*       */         continue;
/*       */       } 
/*  3900 */       if (this.subjectItem.isBanked()) {
/*       */         
/*  3902 */         if (this.subjectItem.isCoin()) {
/*       */           return;
/*       */         }
/*       */ 
/*       */         
/*  3907 */         if (this.subjectItem.lastOwner != this.player.getWurmId()) {
/*       */           return;
/*       */         }
/*       */ 
/*       */         
/*  3912 */         if (this.player.isDead()) {
/*       */           
/*  3914 */           sendNormalServerMessage("You are trading and may not perform bank actions.");
/*       */           
/*       */           return;
/*       */         } 
/*  3918 */         if (this.player.isTrading()) {
/*       */           
/*  3920 */           sendNormalServerMessage("You cannot reach that now.");
/*       */           
/*       */           return;
/*       */         } 
/*  3924 */         Bank bank = Banks.getBank(this.player.getWurmId());
/*  3925 */         if (bank == null) {
/*       */           return;
/*       */         }
/*       */ 
/*       */         
/*  3930 */         if (!bank.open) {
/*       */           
/*  3932 */           logWarn(this.player.getName() + " tried to drag from bank while it is closed.");
/*       */           
/*       */           return;
/*       */         } 
/*  3936 */         if (WurmId.getType(targetId) != 2 && 
/*  3937 */           WurmId.getType(targetId) != 6 && 
/*  3938 */           WurmId.getType(targetId) != 19 && 
/*  3939 */           WurmId.getType(targetId) != 20) {
/*       */           
/*  3941 */           playerComm.sendNormalServerMessage("You may not move bank items there.");
/*       */           
/*       */           return;
/*       */         } 
/*       */         
/*       */         try {
/*  3947 */           Item target = Items.getItem(targetId);
/*  3948 */           Item inventory = this.player.getInventory();
/*  3949 */           if (target.getTemplateId() == 0) {
/*       */             
/*  3951 */             sendRemoveFromInventory(this.subjectItem, bank.id);
/*  3952 */             bank.removeItem(this.subjectItem);
/*  3953 */             this.subjectItem.removeWatcher((Creature)this.player, false);
/*  3954 */             target.insertItem(this.subjectItem);
/*  3955 */             if (!this.subjectItem.isRiftLoot()) {
/*  3956 */               this.subjectItem.setLastMaintained(WurmCalendar.currentTime);
/*       */             }
/*  3958 */           } else if (target.getOwnerId() == this.player.getWurmId()) {
/*       */             
/*  3960 */             if (target.isBulkContainer() && !target.isCrate() && target
/*  3961 */               .getTopParent() != target.getWurmId()) {
/*       */               
/*  3963 */               sendNormalServerMessage(StringUtil.format("You are not allowed to do that! The %s must be on the ground.", new Object[] { target
/*  3964 */                       .getName() })); return;
/*       */             } 
/*  3966 */             if (target.isTent() && target
/*  3967 */               .getTopParent() != target.getWurmId()) {
/*       */               
/*  3969 */               sendNormalServerMessage(StringUtil.format("You are not allowed to do that! The %s must be on the ground.", new Object[] { target
/*  3970 */                       .getName() }));
/*       */               
/*       */               return;
/*       */             } 
/*  3974 */             tryInsertBankItem(this.subjectItem, target, bank, inventory);
/*       */           }
/*       */           else {
/*       */             
/*       */             return;
/*       */           }
/*       */         
/*  3981 */         } catch (NoSuchItemException nsi) {
/*       */ 
/*       */           
/*  3984 */           logWarn(this.player.getName() + "- removing from bank but no such item: " + targetId);
/*       */         
/*       */         }
/*       */ 
/*       */       
/*       */       }
/*       */       else {
/*       */         
/*  3992 */         boolean sameVehicle = (this.subjectItem.getTopParent() == this.player.getVehicle());
/*       */         
/*       */         try {
/*  3995 */           if (!checkedParent)
/*       */           {
/*  3997 */             Item parent = Items.getItem(this.subjectItem.getTopParent());
/*  3998 */             if (parent.isVehicle() && !parent.isTent())
/*       */             {
/*  4000 */               maxLength = parent.getSizeZ() / 100;
/*       */             }
/*  4002 */             if (parent.getOwnerId() != this.player.getWurmId() && parent.getBridgeId() != this.player.getBridgeId()) {
/*       */               
/*  4004 */               sendNormalServerMessage("You need to be on the same bridge as " + parent.getName() + ".");
/*       */               return;
/*       */             } 
/*  4007 */             checkedParent = true;
/*       */           }
/*       */         
/*  4010 */         } catch (NoSuchItemException noSuchItemException) {}
/*       */ 
/*       */ 
/*       */         
/*  4014 */         if (!held && !sameVehicle && !this.player.isWithinDistanceTo(this.subjectItem, maxLength)) {
/*       */           
/*  4016 */           Item item = Items.getItem(targetId);
/*  4017 */           if (!item.isTraded() || !this.subjectItem.isTraded() || item.mailed || this.subjectItem.mailed) {
/*       */             
/*  4019 */             sendNormalServerMessage("You are not allowed to do that.");
/*       */           }
/*       */           else {
/*       */             
/*  4023 */             TradingWindow window = item.getTradeWindow();
/*  4024 */             if (this.subjectItem.isTraded()) {
/*       */               
/*  4026 */               TradingWindow currWin = this.subjectItem.getTradeWindow();
/*  4027 */               if (currWin.mayMoveItemToWindow(this.subjectItem, (Creature)this.player, window.getWurmId())) {
/*       */                 
/*  4029 */                 currWin.removeItem(this.subjectItem);
/*  4030 */                 window.startReceivingItems();
/*  4031 */                 window.addItem(this.subjectItem);
/*  4032 */                 window.stopReceivingItems();
/*       */               } 
/*       */             } 
/*       */           } 
/*       */         } else {
/*       */ 
/*       */ 
/*       */           
/*       */           try { 
/*       */ 
/*       */ 
/*       */             
/*  4044 */             if (!held && this.player.isDead()) {
/*       */               
/*  4046 */               sendNormalServerMessage("You cannot reach that now.");
/*       */               return;
/*       */             } 
/*  4049 */             if (WurmId.getType(targetId) == 2 || 
/*  4050 */               WurmId.getType(targetId) == 6 || 
/*  4051 */               WurmId.getType(targetId) == 19 || 
/*  4052 */               WurmId.getType(targetId) == 20) {
/*       */               
/*       */               try {
/*       */                 
/*  4056 */                 Item targetItem = Items.getItem(targetId);
/*  4057 */                 Item parent = Items.getItem(targetItem.getTopParent());
/*  4058 */                 Item subjectParent = this.subjectItem.getParentOrNull();
/*  4059 */                 if (this.subjectItem.isBulkContainer())
/*       */                 {
/*  4061 */                   if (subjectParent == null || !subjectParent.isInventory() || parent.getTemplateId() != 1315)
/*       */                   {
/*       */ 
/*       */                     
/*  4065 */                     if (subjectParent == null || subjectParent.getTemplateId() != 1315 || !parent.isInventory())
/*       */                     {
/*       */ 
/*       */                       
/*  4069 */                       if (!this.subjectItem.isCrate() || (parent.getTemplateId() != 1309 && parent
/*  4070 */                         .getTemplateId() != 1312 && !parent.isVehicle()))
/*       */                       {
/*       */ 
/*       */ 
/*       */                         
/*  4075 */                         if ((subjectParent == null || (!subjectParent.isVehicle() && subjectParent.getTemplateId() != 1312) || (
/*  4076 */                           !parent.isVehicle() && parent.getTemplateId() != 1312)) && parent
/*  4077 */                           .getTemplateId() != 853 && parent.getTemplateId() != 1410) {
/*       */                           
/*  4079 */                           sendNormalServerMessage("You can only drop the " + this.subjectItem.getName() + ".");
/*       */                           return;
/*       */                         }  }  }  } 
/*       */                 }
/*  4083 */                 if (parent.getTemplateId() == 1342 && !parent.isPlanted() && parent.getData() == -1L) {
/*       */                   
/*  4085 */                   sendNormalServerMessage("The " + parent.getName() + " needs to be planted or attached to a boat, for the " + this.subjectItem.getName() + " to go into it.");
/*       */                   return;
/*       */                 } 
/*  4088 */                 if (!parent.isHollow()) {
/*       */                   
/*  4090 */                   sendNormalServerMessage("There is nowhere in the " + parent.getName() + " to put the " + this.subjectItem
/*  4091 */                       .getName() + ".");
/*       */                   return;
/*       */                 } 
/*  4094 */                 float maxDist = 6.0F;
/*  4095 */                 if (parent.isVehicle()) {
/*       */                   
/*  4097 */                   Vehicle vehicle = Vehicles.getVehicle(parent);
/*  4098 */                   if (vehicle != null)
/*  4099 */                     maxDist = Math.max(maxDist, vehicle.getMaxAllowedLoadDistance()); 
/*       */                 } 
/*  4101 */                 if (!this.player.isWithinDistanceTo(parent, maxDist)) {
/*       */                   
/*  4103 */                   sendNormalServerMessage("You're too far away from the " + parent.getName() + ".");
/*       */                   return;
/*       */                 } 
/*  4106 */                 if (parent.getOwnerId() != this.player.getWurmId() && parent.getBridgeId() != this.player.getBridgeId()) {
/*       */                   
/*  4108 */                   sendNormalServerMessage("You need to be on the same bridge as " + parent.getName() + ".");
/*       */                   return;
/*       */                 } 
/*  4111 */                 Item newTarget = targetItem;
/*  4112 */                 if (!targetItem.isHollow() && !targetItem.isBulkContainer()) {
/*       */                   
/*  4114 */                   boolean end = false;
/*       */                   
/*       */                   do {
/*  4117 */                     newTarget = newTarget.getParentOrNull();
/*  4118 */                     if (newTarget != null && newTarget.getWurmId() != targetItem.getWurmId()) {
/*       */                       
/*  4120 */                       if (newTarget.isHollow() || newTarget.isBulkContainer())
/*       */                       {
/*  4122 */                         targetItem = newTarget;
/*  4123 */                         end = true;
/*       */                       }
/*       */                     
/*       */                     } else {
/*       */                       
/*  4128 */                       end = true;
/*       */                     }
/*       */                   
/*  4131 */                   } while (!end);
/*       */                 } 
/*  4133 */                 if (targetItem.getTemplate().hasViewableSubItems() && !targetItem.getTemplate().isContainerWithSubItems()) {
/*       */                   
/*  4135 */                   sendNormalServerMessage("You'll need to place the " + this.subjectItem.getName() + " on the " + targetItem
/*  4136 */                       .getName() + ".");
/*       */                   return;
/*       */                 } 
/*  4139 */                 if (targetItem.getOwnerId() > 0L)
/*       */                 {
/*  4141 */                   if (targetItem.isBulkItem() || targetItem.isBulkContainer()) {
/*       */                     
/*  4143 */                     sendNormalServerMessage("You are not allowed to do that.");
/*       */                     return;
/*       */                   } 
/*       */                 }
/*  4147 */                 if (targetItem.mailed) {
/*       */                   
/*  4149 */                   sendNormalServerMessage("You cannot reach that now. It is in the mail.");
/*       */                   return;
/*       */                 } 
/*  4152 */                 if (targetItem.isLockable()) {
/*       */                   
/*  4154 */                   long lockid = targetItem.getLockId();
/*  4155 */                   if (lockid != -10L) {
/*       */                     
/*       */                     try {
/*       */                       
/*  4159 */                       Item lock = Items.getItem(lockid);
/*  4160 */                       if (!this.player.hasKeyForLock(lock) && !targetItem.mayAccessHold((Creature)this.player)) {
/*       */                         
/*  4162 */                         boolean mayUseItem = false;
/*       */                         
/*  4164 */                         if (targetItem.isDraggable() || targetItem.getTemplateId() == 850)
/*       */                         {
/*  4166 */                           mayUseItem = MethodsItems.mayUseInventoryOfVehicle((Creature)this.player, targetItem);
/*       */                         }
/*  4168 */                         if (!mayUseItem) {
/*       */                           
/*  4170 */                           sendSafeServerMessage("That item is locked.");
/*       */                           
/*       */                           return;
/*       */                         } 
/*       */                       } 
/*  4175 */                     } catch (NoSuchItemException nsi) {
/*       */                       
/*  4177 */                       logWarn(targetId + " is locked but lock " + lockid + " can not be found.", (Throwable)nsi);
/*  4178 */                       sendAlertServerMessage("The target item is locked but the lock could not be found. Rejecting move request.");
/*       */                       return;
/*       */                     } 
/*       */                   }
/*       */                 } 
/*  4183 */                 if (targetItem.isTraded()) {
/*       */                   
/*  4185 */                   if (targetItem.getOwnerId() == this.player.getWurmId())
/*       */                   {
/*  4187 */                     TradingWindow window = targetItem.getTradeWindow();
/*  4188 */                     if (this.subjectItem.isTraded()) {
/*       */                       
/*  4190 */                       TradingWindow currWin = this.subjectItem.getTradeWindow();
/*  4191 */                       if (currWin.mayMoveItemToWindow(this.subjectItem, (Creature)this.player, window.getWurmId()))
/*       */                       {
/*  4193 */                         currWin.removeItem(this.subjectItem);
/*  4194 */                         window.startReceivingItems();
/*  4195 */                         window.addItem(this.subjectItem);
/*  4196 */                         window.stopReceivingItems();
/*       */                       }
/*       */                     
/*       */                     } else {
/*       */                       
/*  4201 */                       if (subjectOwnerId == -10L) {
/*       */                         
/*  4203 */                         sendNormalServerMessage("You are not allowed to do that, since the " + targetItem
/*  4204 */                             .getName() + " is being traded.");
/*       */                         
/*       */                         return;
/*       */                       } 
/*       */                       
/*  4209 */                       if (window.mayAddFromInventory((Creature)this.player, this.subjectItem))
/*       */                       {
/*  4211 */                         window.startReceivingItems();
/*  4212 */                         window.addItem(this.subjectItem);
/*  4213 */                         window.stopReceivingItems();
/*       */                       
/*       */                       }
/*       */ 
/*       */                     
/*       */                     }
/*       */                   
/*       */                   }
/*  4221 */                   else if (!held)
/*       */                   {
/*  4223 */                     TradingWindow window = targetItem.getTradeWindow();
/*  4224 */                     if (this.subjectItem.isTraded())
/*       */                     {
/*  4226 */                       TradingWindow currWin = this.subjectItem.getTradeWindow();
/*  4227 */                       if (currWin.mayMoveItemToWindow(this.subjectItem, (Creature)this.player, window.getWurmId()))
/*       */                       {
/*  4229 */                         currWin.removeItem(this.subjectItem);
/*  4230 */                         window.startReceivingItems();
/*  4231 */                         window.addItem(this.subjectItem);
/*  4232 */                         window.stopReceivingItems();
/*       */                       }
/*       */                     
/*       */                     }
/*       */                   
/*       */                   }
/*       */                 
/*  4239 */                 } else if (this.subjectItem.isTraded()) {
/*       */                   
/*  4241 */                   TradingWindow currWin = this.subjectItem.getTradeWindow();
/*  4242 */                   if (mayMoveToInventory(this.subjectItem)) {
/*  4243 */                     currWin.removeItem(this.subjectItem);
/*       */                   }
/*  4245 */                 } else if (subjectOwnerId == -10L) {
/*       */ 
/*       */                   
/*  4248 */                   long topparentid = this.subjectItem.getTopParent();
/*  4249 */                   if (topparentid != -10L && WurmId.getType(topparentid) != 6) {
/*       */                     
/*  4251 */                     boolean mayUseVehicle = true;
/*       */                     
/*       */                     try {
/*  4254 */                       Item topparent = Items.getItem(topparentid);
/*  4255 */                       if (topparent.isDraggable())
/*       */                       {
/*  4257 */                         mayUseVehicle = MethodsItems.mayUseInventoryOfVehicle((Creature)this.player, topparent);
/*       */                       }
/*  4259 */                       if (!mayUseVehicle && this.subjectItem.lastOwner != this.player.getWurmId())
/*       */                       {
/*  4261 */                         if ((topparent.isVehicle() && topparent.getLockId() != -10L) || Items.isItemDragged(topparent))
/*       */                         {
/*  4263 */                           if (this.player.getDraggedItem() != topparent) {
/*       */                             
/*  4265 */                             sendNormalServerMessage("The " + topparent.getName() + " is being watched too closely. You cannot take items from it.");
/*       */                             
/*       */                             return;
/*       */                           } 
/*       */                         }
/*       */                       }
/*  4271 */                     } catch (NoSuchItemException noSuchItemException) {}
/*       */                   } 
/*       */ 
/*       */ 
/*       */                   
/*  4276 */                   boolean noOwner = (targetItem.getOwnerId() == -10L);
/*  4277 */                   boolean targetIsPileOrVehicle = (targetItem.isTopParentPile() || targetItem.isVehicle());
/*  4278 */                   Item topParent = targetItem.getTopParentOrNull();
/*  4279 */                   boolean topParentIsContainer = (topParent != null && (topParent.isVehicle() || topParent.isHollow()));
/*  4280 */                   boolean subjectIsNotBulkable = (!this.subjectItem.isBulk() && !this.subjectItem.isBulkItem());
/*  4281 */                   boolean targetIsNotBulkItemOrContainer = (!targetItem.isBulkItem() && !targetItem.isBulkContainer());
/*  4282 */                   boolean targetIsNotVehicleOrContainer = (!targetItem.isVehicle() && !targetItem.isHollow());
/*  4283 */                   if ((noOwner && !targetIsPileOrVehicle && !topParentIsContainer && subjectIsNotBulkable) || (targetIsNotBulkItemOrContainer && targetIsNotVehicleOrContainer)) {
/*       */ 
/*       */ 
/*       */                     
/*  4287 */                     sendNormalServerMessage("You are not allowed to do that.");
/*       */                     return;
/*       */                   } 
/*  4290 */                   if (targetItem.getOwnerId() == -10L && targetItem.isTopParentPile() && this.subjectItem.isBulkItem()) {
/*       */                     
/*  4292 */                     sendNormalServerMessage("You are not allowed to do that.");
/*       */                     
/*       */                     return;
/*       */                   } 
/*       */                   
/*  4297 */                   if (targetItem.isTraded()) {
/*       */                     
/*  4299 */                     sendNormalServerMessage("You are not allowed to do that, since the " + targetItem
/*  4300 */                         .getName() + " is being traded.");
/*       */                     return;
/*       */                   } 
/*  4303 */                   if (this.subjectItem.getTopParent() != this.player.getVehicle() && 
/*  4304 */                     !this.player.isWithinTileDistanceTo(
/*  4305 */                       (int)this.subjectItem.getPosX() >> 2, 
/*  4306 */                       (int)this.subjectItem.getPosY() >> 2, 
/*  4307 */                       (int)this.subjectItem.getPosZ() >> 2, 3)) {
/*       */ 
/*       */                     
/*  4310 */                     sendNormalServerMessage("You cannot reach the " + this.subjectItem.getName() + " now.");
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                     
/*       */                     return;
/*       */                   } 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                   
/*  4363 */                   if (!MethodsItems.isLootableBy((Creature)this.player, this.subjectItem)) {
/*       */                     
/*  4365 */                     sendNormalServerMessage("You may not loot that item.");
/*       */                     return;
/*       */                   } 
/*  4368 */                   if (MethodsItems.checkIfStealing(this.subjectItem, (Creature)this.player, null))
/*       */                   {
/*  4370 */                     int tilex = (int)this.subjectItem.getPosX() >> 2;
/*  4371 */                     int tiley = (int)this.subjectItem.getPosY() >> 2;
/*  4372 */                     Village vil = Zones.getVillage(tilex, tiley, this.player.isOnSurface());
/*  4373 */                     if (this.player.isLegal() && vil != null) {
/*       */                       
/*  4375 */                       sendNormalServerMessage("That would be illegal here. You can check the settlement token for the local laws.");
/*       */                       return;
/*       */                     } 
/*  4378 */                     if (this.player.getDeity() != null && !this.player.getDeity().isLibila())
/*       */                     {
/*  4380 */                       if (this.player.faithful) {
/*       */                         
/*  4382 */                         sendNormalServerMessage("Your deity would never allow stealing.");
/*       */                         return;
/*       */                       } 
/*       */                     }
/*  4386 */                     sendNormalServerMessage("Right-click and select Steal instead.");
/*       */                   }
/*       */                   else
/*       */                   {
/*  4390 */                     if (this.subjectItem.isBulkItem()) {
/*       */                       
/*  4392 */                       if (targetItem.isNoPut() || targetItem.getTemplateId() == 272) {
/*       */                         
/*  4394 */                         sendNormalServerMessage("You are not allowed to do that.");
/*       */                         return;
/*       */                       } 
/*  4397 */                       Item targetParent = targetItem.getParentOrNull();
/*       */                       
/*  4399 */                       if (targetItem.isContainerLiquid())
/*       */                       {
/*       */ 
/*       */ 
/*       */                         
/*  4404 */                         for (Item contained : targetItem.getItems()) {
/*       */                           
/*  4406 */                           if (contained.isLiquid())
/*       */                           {
/*  4408 */                             if (MethodsItems.wouldDestroyLiquid(targetItem, contained, this.subjectItem)) {
/*       */                               
/*  4410 */                               sendNormalServerMessage("That would destroy the liquid.");
/*       */ 
/*       */ 
/*       */                               
/*       */                               return;
/*       */                             } 
/*       */                           }
/*       */                         } 
/*       */                       }
/*       */ 
/*       */ 
/*       */                       
/*  4422 */                       if (targetItem.getTopParent() != targetItem.getWurmId())
/*       */                       {
/*  4424 */                         if (targetParent != null) {
/*       */                           
/*  4426 */                           if (targetParent.isNoPut()) {
/*       */                             
/*  4428 */                             sendNormalServerMessage("You are not allowed to do that.");
/*       */ 
/*       */                             
/*       */                             return;
/*       */                           } 
/*       */                         } else {
/*  4434 */                           logInfo(targetItem.getName() + ": " + targetItem.getWurmId() + " no parent " + targetItem.getParentId());
/*       */                         } 
/*       */                       }
/*  4437 */                       if (!targetItem.isVehicle() && !targetItem.isHollow() && !targetItem.isTent() && targetItem.getTopParent() != targetItem.getWurmId()) {
/*       */ 
/*       */                         
/*  4440 */                         if (targetItem.getTemplateId() == 1432) {
/*       */                           
/*  4442 */                           sendNormalServerMessage("You can't put that there.");
/*       */                           return;
/*       */                         } 
/*  4445 */                         if (targetItem.getTemplateId() == 1436) {
/*       */                           
/*  4447 */                           sendNormalServerMessage("You can't put that there.");
/*       */                           return;
/*       */                         } 
/*  4450 */                         if (targetItem.getTemplateId() == 1434 && !this.subjectItem.getRealTemplate().isSeed()) {
/*       */                           
/*  4452 */                           sendNormalServerMessage("You can only put seeds into the feeder.");
/*       */                           return;
/*       */                         } 
/*  4455 */                         if (targetItem.getTemplateId() == 1435 && this.subjectItem.getRealTemplateId() != 128) {
/*       */                           
/*  4457 */                           sendNormalServerMessage("You can only put water into the drinker.");
/*       */                           
/*       */                           return;
/*       */                         } 
/*  4461 */                         RemoveItemQuestion riq = new RemoveItemQuestion((Creature)this.player, this.subjectItem.getWurmId());
/*  4462 */                         riq.sendQuestion();
/*       */                       }
/*       */                       else {
/*       */                         
/*  4466 */                         if (targetItem.isTent()) {
/*       */                           
/*  4468 */                           sendNormalServerMessage("The tent doesn't work that way.");
/*       */                           return;
/*       */                         } 
/*  4471 */                         if (targetItem.getTemplateId() == 1023 && !this.subjectItem.getRealTemplate().isUnfired()) {
/*       */                           
/*  4473 */                           sendNormalServerMessage("Only unfired clay items can be put into a kiln.");
/*       */                           return;
/*       */                         } 
/*  4476 */                         if (targetItem.getTemplateId() == 1028 && !(this.subjectItem.getRealTemplate()).isOre) {
/*       */                           
/*  4478 */                           sendNormalServerMessage("Only ore can be put into a smelter.");
/*       */                           return;
/*       */                         } 
/*  4481 */                         if (targetItem.isShelf() && targetParent.getParentId() != -10L) {
/*       */                           
/*  4483 */                           sendNormalServerMessage("You cannot put items on the " + targetItem.getName() + " whilst the " + targetParent
/*  4484 */                               .getName() + " is not on the ground.");
/*       */                           return;
/*       */                         } 
/*  4487 */                         if (targetItem.getTemplateId() == 1278 && this.subjectItem.getRealTemplateId() != 1276) {
/*       */                           
/*  4489 */                           sendNormalServerMessage("Only snowballs can be put into an icebox.");
/*       */                           return;
/*       */                         } 
/*  4492 */                         if (targetItem.getTemplateId() == 1309 && !this.subjectItem.isCrate()) {
/*       */                           
/*  4494 */                           sendNormalServerMessage("Only crates fit in the wagoner container.");
/*       */                           return;
/*       */                         } 
/*  4497 */                         if (targetItem.getTemplateId() == 1108 && this.subjectItem.getRealTemplateId() != 768) {
/*       */                           
/*  4499 */                           sendNormalServerMessage("Only wine barrels can be put on that rack.");
/*       */                           return;
/*       */                         } 
/*  4502 */                         if (targetItem.getTemplateId() == 1109 && this.subjectItem.getRealTemplateId() != 189) {
/*       */                           
/*  4504 */                           sendNormalServerMessage("Only small barrels can be put into that rack.");
/*       */                           return;
/*       */                         } 
/*  4507 */                         if (targetItem.getTemplateId() == 1279 && !this.subjectItem.getRealTemplate().canLarder() && (
/*  4508 */                           !this.subjectItem.getRealTemplate().usesFoodState() || this.subjectItem.getAuxData() != 0)) {
/*       */                           
/*  4510 */                           sendNormalServerMessage("Only procesed food items can be put onto a food shelf.");
/*       */                           return;
/*       */                         } 
/*  4513 */                         if (targetItem.containsIngredientsOnly() && !this.subjectItem.getRealTemplate().isFood() && 
/*  4514 */                           !this.subjectItem.getRealTemplate().isLiquid() && !this.subjectItem.getRealTemplate().isRecipeItem()) {
/*       */                           
/*  4516 */                           sendNormalServerMessage("Only ingredients that are used to make food can be put onto " + targetItem.getNameWithGenus() + ".");
/*       */                           return;
/*       */                         } 
/*  4519 */                         if (targetItem.isAlmanacContainer() && !this.subjectItem.isHarvestReport()) {
/*       */                           
/*  4521 */                           sendNormalServerMessage("Only harvest reports can be put in " + targetItem
/*  4522 */                               .getTemplate().getNameWithGenus() + ".");
/*       */                           return;
/*       */                         } 
/*  4525 */                         if (targetItem.getTemplateId() == 1312 && !this.subjectItem.isCrate()) {
/*       */                           
/*  4527 */                           sendNormalServerMessage("Only crates can be put into that rack.");
/*       */                           return;
/*       */                         } 
/*  4530 */                         if (targetItem.getTemplateId() == 1315 && (this.subjectItem.getTemplateId() != 662 || !this.subjectItem.isEmpty(false))) {
/*       */                           
/*  4532 */                           sendNormalServerMessage("Only empty bsb can be put into that rack.");
/*       */                           return;
/*       */                         } 
/*  4535 */                         if (targetItem.getTemplateId() == 1284) {
/*       */                           
/*  4537 */                           if (parent != null && parent.getTemplateId() == 1178 && parent.getParentId() != -10L) {
/*       */                             
/*  4539 */                             sendNormalServerMessage("You can only put liquids into the boiler when the still is not on the ground.");
/*       */                             
/*       */                             return;
/*       */                           } 
/*  4543 */                         } else if (targetItem.getTemplateId() == 725) {
/*       */                           
/*  4545 */                           if (!this.subjectItem.isWeaponPolearm()) {
/*       */                             
/*  4547 */                             sendNormalServerMessage("The " + this.subjectItem.getName() + " doesn't fit.");
/*       */                             
/*       */                             return;
/*       */                           } 
/*  4551 */                         } else if (targetItem.getTemplateId() == 724) {
/*       */                           
/*  4553 */                           if (!this.subjectItem.isWeapon() || this.subjectItem.isWeaponPolearm()) {
/*       */                             
/*  4555 */                             sendNormalServerMessage("The " + this.subjectItem.getName() + " doesn't fit.");
/*       */                             
/*       */                             return;
/*       */                           } 
/*  4559 */                         } else if (targetItem.getTemplateId() == 758) {
/*       */                           
/*  4561 */                           if (!this.subjectItem.isWeaponBow() && !this.subjectItem.isBowUnstringed()) {
/*       */                             
/*  4563 */                             sendNormalServerMessage("The " + this.subjectItem.getName() + " doesn't fit.");
/*       */                             
/*       */                             return;
/*       */                           } 
/*  4567 */                         } else if (targetItem.getTemplateId() == 759) {
/*       */                           
/*  4569 */                           if (!this.subjectItem.isArmour()) {
/*       */                             
/*  4571 */                             sendNormalServerMessage("The " + this.subjectItem.getName() + " doesn't fit.");
/*       */                             
/*       */                             return;
/*       */                           } 
/*  4575 */                         } else if (targetItem.getTemplateId() == 892) {
/*       */                           
/*  4577 */                           if (!this.subjectItem.isArmour() && this.subjectItem.getTemplateId() != 831) {
/*       */                             
/*  4579 */                             sendNormalServerMessage("The " + this.subjectItem.getName() + " doesn't fit.");
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                             
/*       */                             return;
/*       */                           } 
/*       */                         } 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                         
/*  4594 */                         Item thisTopParent = this.subjectItem.getTopParentOrNull();
/*  4595 */                         if (thisTopParent != null && (thisTopParent.getTemplateId() == 853 || thisTopParent
/*  4596 */                           .getTemplateId() == 1410)) {
/*       */                           
/*  4598 */                           sendNormalServerMessage("That needs to be on the ground to reach it.");
/*       */                           return;
/*       */                         } 
/*  4601 */                         if (subjectParent == null || subjectParent.getWurmId() != targetItem.getWurmId()) {
/*       */ 
/*       */                           
/*  4604 */                           if (targetItem.getTemplateId() == 1432) {
/*       */                             
/*  4606 */                             sendNormalServerMessage("You can't put that there.");
/*       */                             return;
/*       */                           } 
/*  4609 */                           if (targetItem.getTemplateId() == 1436) {
/*       */                             
/*  4611 */                             sendNormalServerMessage("You can't put that there.");
/*       */                             return;
/*       */                           } 
/*  4614 */                           if (targetItem.getTemplateId() == 1434 && !this.subjectItem.getRealTemplate().isSeed()) {
/*       */                             
/*  4616 */                             sendNormalServerMessage("You can only put seeds into the feeder.");
/*       */                             return;
/*       */                           } 
/*  4619 */                           if (targetItem.getTemplateId() == 1435 && this.subjectItem.getRealTemplateId() != 128) {
/*       */                             
/*  4621 */                             sendNormalServerMessage("You can only put water into the drinker.");
/*       */                             
/*       */                             return;
/*       */                           } 
/*  4625 */                           RemoveItemQuestion riq = new RemoveItemQuestion((Creature)this.player, this.subjectItem.getWurmId(), targetItem.getWurmId());
/*  4626 */                           riq.sendQuestion();
/*       */                         } 
/*       */                       } 
/*       */                       return;
/*       */                     } 
/*  4631 */                     if (this.subjectItem.isCoin() && this.subjectItem.getParentId() == -10L)
/*       */                       return; 
/*  4633 */                     if (subjectParent == null || !subjectParent.isVehicle() || !targetItem.isVehicle())
/*       */                     {
/*  4635 */                       if (this.subjectItem.isNoTake() && (subjectParent == null || subjectParent.isNoTake())) {
/*       */                         
/*  4637 */                         sendNormalServerMessage("The " + this.subjectItem.getName() + " can not be picked up.");
/*       */                         return;
/*       */                       } 
/*       */                     }
/*  4641 */                     if (this.subjectItem.isHollow() && this.subjectItem.getTemplate().getInitialContainers() == null)
/*       */                     {
/*  4643 */                       for (Item i : this.subjectItem.getAllItems(true)) {
/*       */                         
/*  4645 */                         if (i.isNoTake() && i.getTemplateId() != 669 && !i.isComponentItem() && i
/*  4646 */                           .getTemplateId() != 1403) {
/*       */                           
/*  4648 */                           sendNormalServerMessage("The " + this.subjectItem.getName() + " contains a no-take item.");
/*       */                           return;
/*       */                         } 
/*       */                       } 
/*       */                     }
/*  4653 */                     if (this.subjectItem.getTopParentOrNull() != null && (this.subjectItem
/*  4654 */                       .getTopParentOrNull().getTemplateId() == 853 || this.subjectItem
/*  4655 */                       .getTopParentOrNull().getTemplateId() == 1410)) {
/*       */                       
/*  4657 */                       sendNormalServerMessage("You need to use the unload action to do this.");
/*       */                       return;
/*       */                     } 
/*  4660 */                     if (!equipCreatureCheck(targetItem)) {
/*       */                       
/*  4662 */                       sendNormalServerMessage("You are not allowed to do that.");
/*       */                       return;
/*       */                     } 
/*  4665 */                     if (!creatureWearableRestrictions(targetItem)) {
/*       */                       return;
/*       */                     }
/*  4668 */                     boolean lastMove = (s == nums - 1);
/*  4669 */                     Item subjectTopParent = this.subjectItem.getTopParentOrNull();
/*       */ 
/*       */                     
/*  4672 */                     for (Item item : subjectTopParent.getAllItems(true)) {
/*       */                       
/*  4674 */                       if (item.getTemplateId() == 1436 && !item.isEmpty(true)) {
/*       */                         
/*  4676 */                         if (this.subjectItem.getParent().getTemplateId() == 1434) {
/*       */                           
/*  4678 */                           sendNormalServerMessage("The chickens refuse to let you take the food, perhaps you should remove them first.");
/*       */                           
/*       */                           return;
/*       */                         } 
/*       */                         
/*  4683 */                         if (this.subjectItem.getParent().getTemplateId() == 1435) {
/*       */                           
/*  4685 */                           sendNormalServerMessage("The chickens refuse to let you take the water, perhaps you should remove them first.");
/*       */ 
/*       */ 
/*       */                           
/*       */                           return;
/*       */                         } 
/*       */                       } 
/*       */                     } 
/*       */ 
/*       */                     
/*  4695 */                     if (this.subjectItem
/*  4696 */                       .moveToItem((Creature)this.player, targetItem.getWurmId(), lastMove))
/*       */                     {
/*  4698 */                       moved++;
/*  4699 */                       sendUpdateInventoryItem(this.subjectItem);
/*  4700 */                       if (subjectTopParent != null && lastMove && subjectTopParent
/*       */                         
/*  4702 */                         .getTemplateId() != 177)
/*       */                       {
/*  4704 */                         subjectTopParent.updateModelNameOnGroundItem();
/*       */                       }
/*  4706 */                       if ((targetItem.getTemplateId() == 1312 || targetItem
/*  4707 */                         .getTemplateId() == 1315 || targetItem
/*  4708 */                         .getTemplateId() == 1309) && lastMove)
/*       */                       {
/*  4710 */                         targetItem.updateModelNameOnGroundItem();
/*       */                       }
/*       */                     }
/*       */                   
/*       */                   }
/*       */                 
/*  4716 */                 } else if (held) {
/*       */                   
/*  4718 */                   if (!this.subjectItem.canBeDropped(true)) {
/*       */                     
/*  4720 */                     if (targetItem.getOwnerId() == -10L || targetItem.getOwnerId() != this.player.getWurmId()) {
/*  4721 */                       sendSafeServerMessage("You are not allowed to drop that.");
/*  4722 */                     } else if (this.subjectItem.isBulkContainer() && targetItem.getTemplateId() != 1315) {
/*  4723 */                       sendSafeServerMessage("You can't move that around.");
/*  4724 */                     } else if (this.subjectItem.moveToItem((Creature)this.player, targetId, (s == nums - 1))) {
/*       */                       
/*  4726 */                       moved++;
/*  4727 */                       Item itemParent = null;
/*       */                       
/*       */                       try {
/*  4730 */                         itemParent = this.subjectItem.getParent();
/*       */                       }
/*  4732 */                       catch (NoSuchItemException noSuchItemException) {}
/*       */ 
/*       */ 
/*       */                       
/*  4736 */                       for (Creature c : (itemParent != null) ? itemParent.getWatchers() : this.subjectItem.getWatchers())
/*       */                       {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                         
/*  4748 */                         if (c.isPlayer()) {
/*  4749 */                           c.getCommunicator().sendUpdateInventoryItem(this.subjectItem);
/*       */                         }
/*       */                       }
/*       */                     
/*       */                     }
/*       */                   
/*       */                   }
/*  4756 */                   else if (targetItem.getOwnerId() != -10L && targetItem.getOwnerId() != this.player.getWurmId()) {
/*       */ 
/*       */ 
/*       */                     
/*  4760 */                     if ((this.subjectItem.isHollow() && this.subjectItem.getTemplateId() != 621 && targetItem
/*  4761 */                       .getTemplateId() != 621 && !targetItem.isHollow()) || (this.subjectItem
/*  4762 */                       .isLiquid() && !targetItem.isContainerLiquid())) {
/*       */                       
/*  4764 */                       sendSafeServerMessage("You are not allowed to equip that.");
/*       */                     } else {
/*       */ 
/*       */                       
/*       */                       try {
/*       */                         
/*  4770 */                         Creature owner = Server.getInstance().getCreature(targetItem.getOwnerId());
/*  4771 */                         if (owner.isDead())
/*       */                           return; 
/*  4773 */                         if (equipCreatureCheck(targetItem)) {
/*       */                           
/*  4775 */                           if (!creatureWearableRestrictions(targetItem))
/*       */                             return; 
/*  4777 */                           if (targetItem.getTemplateId() == 621 && targetItem.isHollow() && (owner
/*  4778 */                             .getDominator() == this.player || owner.mayAccessHold((Creature)this.player))) {
/*       */ 
/*       */                             
/*       */                             try {
/*  4782 */                               if (targetItem.testInsertItem(this.subjectItem)) {
/*       */                                 
/*  4784 */                                 this.subjectItem.getParent().dropItem(this.subjectItem.getWurmId(), false);
/*  4785 */                                 targetItem.insertItem(this.subjectItem);
/*  4786 */                                 if (!this.subjectItem.isRiftLoot()) {
/*  4787 */                                   this.subjectItem.setLastMaintained(WurmCalendar.currentTime);
/*       */                                 }
/*       */                               } else {
/*  4790 */                                 playerComm.sendNormalServerMessage(this.subjectItem.getNameWithGenus() + " won't fit in " + targetItem
/*  4791 */                                     .getNameWithGenus() + ".");
/*       */                               } 
/*  4793 */                             } catch (NoSuchItemException nsi) {
/*       */                               
/*  4795 */                               logWarn(this.player.getName() + " moving " + this.subjectItem.getName() + " to " + targetItem.getName());
/*       */                             }
/*       */                           
/*  4798 */                           } else if (owner.isKingdomGuard() || owner.getDominator() == this.player || owner.mayAccessHold((Creature)this.player)) {
/*       */                             
/*  4800 */                             if (this.subjectItem.isUnfinished()) {
/*       */                               
/*  4802 */                               sendNormalServerMessage(owner.getName() + " gives the unfinished item back with a shrug.");
/*       */                               return;
/*       */                             } 
/*  4805 */                             if (targetItem.testInsertItem(this.subjectItem)) {
/*       */                               
/*  4807 */                               if (this.subjectItem.moveToItem((Creature)this.player, targetItem.getWurmId(), (s == nums - 1)))
/*       */                               {
/*  4809 */                                 moved++;
/*  4810 */                                 sendUpdateInventoryItem(this.subjectItem);
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                               
/*       */                               }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                             
/*       */                             }
/*  4847 */                             else if (targetItem.getTemplateId() != 16) {
/*       */ 
/*       */                               
/*       */                               try {
/*  4851 */                                 Item targetParent = targetItem.getParent();
/*  4852 */                                 if (targetParent.testInsertItem(this.subjectItem)) {
/*       */                                   
/*  4854 */                                   boolean found = false;
/*  4855 */                                   if (targetItem.isBodyPart()) {
/*       */                                     
/*  4857 */                                     found = false;
/*  4858 */                                     for (int i = 0; i < (this.subjectItem.getBodySpaces()).length; i++) {
/*  4859 */                                       if (this.subjectItem.getBodySpaces()[i] == targetParent.getPlace())
/*  4860 */                                         found = true; 
/*       */                                     } 
/*  4862 */                                     if (!found && owner.hasHands())
/*       */                                     {
/*  4864 */                                       if (targetParent.getPlace() == 13 || targetParent.getPlace() == 14)
/*  4865 */                                         found = true; 
/*       */                                     }
/*       */                                   } 
/*  4868 */                                   if (found) {
/*       */ 
/*       */                                     
/*       */                                     try {
/*  4872 */                                       this.subjectItem.getParent().dropItem(this.subjectItem.getWurmId(), false);
/*  4873 */                                       targetParent.insertItem(this.subjectItem);
/*  4874 */                                       if (!this.subjectItem.isRiftLoot()) {
/*  4875 */                                         this.subjectItem.setLastMaintained(WurmCalendar.currentTime);
/*       */                                       }
/*  4877 */                                     } catch (NoSuchItemException nsi) {
/*       */                                       
/*  4879 */                                       logWarn(this.player.getName() + " moving " + this.subjectItem.getName() + " to " + targetItem
/*  4880 */                                           .getName());
/*       */                                     }
/*       */                                   
/*       */                                   } else {
/*       */                                     
/*  4885 */                                     playerComm.sendNormalServerMessage(this.subjectItem.getNameWithGenus() + " won't fit in " + targetItem
/*  4886 */                                         .getNameWithGenus() + '.');
/*       */                                   }
/*       */                                 
/*       */                                 } else {
/*       */                                   
/*  4891 */                                   playerComm.sendNormalServerMessage(this.subjectItem.getNameWithGenus() + " won't fit in " + targetItem
/*  4892 */                                       .getNameWithGenus() + '.');
/*       */                                 }
/*       */                               
/*  4895 */                               } catch (NoSuchItemException nsi) {
/*       */                                 
/*  4897 */                                 logWarn(this.player.getName() + " moving " + this.subjectItem.getName() + " to " + targetItem.getName());
/*       */                               } 
/*       */                             } 
/*       */                           } else {
/*       */                             
/*  4902 */                             sendNormalServerMessage(owner.getName() + " will not accept that.");
/*       */                           } 
/*  4904 */                         } else if (!targetItem.mayCreatureInsertItem()) {
/*       */                           
/*  4906 */                           sendNormalServerMessage("The " + targetItem.getName() + " contains too many items.");
/*       */                         } else {
/*       */                           
/*  4909 */                           sendNormalServerMessage("You are not allowed to do that.");
/*       */                         } 
/*  4911 */                       } catch (NoSuchCreatureException nsc) {
/*       */                         
/*  4913 */                         logWarn(this.player.getName() + " trying to move item to nonexistant creature.");
/*       */                       }
/*  4915 */                       catch (NoSuchPlayerException nsc) {
/*       */                         
/*  4917 */                         logWarn(this.player.getName() + " trying to move item to nonexistant player.");
/*       */                       }
/*       */                     
/*       */                     } 
/*       */                   } else {
/*       */                     
/*  4923 */                     if (targetItem.getTopParent() != this.player.getVehicle() && targetItem
/*  4924 */                       .getWurmId() != this.player.getStatus().getInventoryId() && 
/*  4925 */                       !this.player.isWithinTileDistanceTo(
/*  4926 */                         (int)targetItem.getPosX() >> 2, 
/*  4927 */                         (int)targetItem.getPosY() >> 2, 
/*  4928 */                         (int)targetItem.getPosZ() >> 2, 3)) {
/*       */                       
/*  4930 */                       sendNormalServerMessage("You cannot reach the " + targetItem.getName() + " now.");
/*       */                       return;
/*       */                     } 
/*  4933 */                     if (this.subjectItem.isBulkContainer() && targetItem.getTemplateId() != 1315) {
/*  4934 */                       sendSafeServerMessage("You can't move that around.");
/*       */                     }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                     
/*  4965 */                     Item topParent = this.subjectItem.getTopParentOrNull();
/*  4966 */                     boolean lastMove = (s == nums - 1);
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                     
/*  4985 */                     if (this.subjectItem.moveToItem((Creature)this.player, targetItem.getWurmId(), lastMove)) {
/*       */                       
/*  4987 */                       moved++;
/*  4988 */                       sendUpdateInventoryItem(this.subjectItem);
/*  4989 */                       if (topParent != null && lastMove && topParent.getTemplateId() != 177)
/*  4990 */                         topParent.updateModelNameOnGroundItem(); 
/*       */                     } 
/*  4992 */                     if ((targetItem.getTemplateId() == 1312 || targetItem.getTemplateId() == 1315) && lastMove && moved > 0)
/*       */                     {
/*  4994 */                       targetItem.updateModelNameOnGroundItem();
/*       */                     }
/*       */                   } 
/*       */                 } else {
/*       */ 
/*       */                   
/*       */                   try {
/*       */ 
/*       */                     
/*  5003 */                     Creature owner = Server.getInstance().getCreature(subjectOwnerId);
/*  5004 */                     if (owner.isDead()) {
/*       */                       return;
/*       */                     }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                     
/*  5017 */                     boolean ok = (owner.isKingdomGuard() && owner.getKingdomId() == this.player.getKingdomId());
/*  5018 */                     if (!Servers.isThisAPvpServer() && owner.isBranded()) {
/*  5019 */                       ok = (ok || owner.mayAccessHold((Creature)this.player));
/*       */                     } else {
/*  5021 */                       ok = (ok || owner.getDominator() == this.player);
/*  5022 */                     }  if (ok && targetItem.getOwnerId() != this.player.getWurmId()) {
/*       */                       
/*       */                       try {
/*       */                         
/*  5026 */                         Creature targetOwner = Server.getInstance().getCreature(targetItem.getOwner());
/*  5027 */                         if (targetOwner.isKingdomGuard() && targetOwner.getKingdomId() != this.player.getKingdomId()) {
/*  5028 */                           ok = false;
/*  5029 */                         } else if (!Servers.isThisAPvpServer() && targetOwner.isBranded()) {
/*  5030 */                           ok = targetOwner.mayAccessHold((Creature)this.player);
/*       */                         } else {
/*  5032 */                           ok = (targetOwner.getDominator() == this.player);
/*       */                         } 
/*  5034 */                       } catch (NotOwnedException notOwnedException) {}
/*       */                     }
/*       */ 
/*       */ 
/*       */                     
/*  5039 */                     if ((ok || (owner.isReborn() && owner.isHuman())) && targetItem.mayCreatureInsertItem()) {
/*       */                       
/*  5041 */                       if (!equipCreatureCheck(targetItem)) {
/*       */                         
/*  5043 */                         sendNormalServerMessage("You are not allowed to do that.");
/*       */                         return;
/*       */                       } 
/*  5046 */                       if (!creatureWearableRestrictions(targetItem))
/*       */                         return; 
/*  5048 */                       if (this.subjectItem.moveToItem((Creature)this.player, targetItem.getWurmId(), (s == nums - 1))) {
/*       */                         
/*  5050 */                         moved++;
/*  5051 */                         sendUpdateInventoryItem(this.subjectItem);
/*       */                       }
/*       */                       else {
/*       */                         
/*  5055 */                         long itemOwnerId = targetItem.getOwnerId();
/*  5056 */                         if (ok && (itemOwnerId == -10L || itemOwnerId == this.player.getWurmId() || itemOwnerId == subjectOwnerId)) {
/*       */                           
/*  5058 */                           if (itemOwnerId == -10L) {
/*       */                             
/*  5060 */                             if (targetItem.isBulkItem() || targetItem.isBulkContainer()) {
/*       */                               
/*  5062 */                               sendNormalServerMessage("You are not allowed to do that.");
/*       */                               return;
/*       */                             } 
/*  5065 */                             if (targetItem.isLocked()) {
/*       */                               
/*  5067 */                               playerComm.sendNormalServerMessage("The " + targetItem.getName() + " is locked.");
/*       */                               return;
/*       */                             } 
/*       */                           } 
/*  5071 */                           if (targetItem.testInsertItem(this.subjectItem)) {
/*       */                             
/*  5073 */                             boolean found = false;
/*  5074 */                             if (targetItem.isBodyPart()) {
/*       */                               
/*  5076 */                               found = false;
/*  5077 */                               for (int i = 0; i < (this.subjectItem.getBodySpaces()).length; i++) {
/*  5078 */                                 if (this.subjectItem.getBodySpaces()[i] == targetItem.getPlace())
/*  5079 */                                   found = true; 
/*  5080 */                               }  if (!found)
/*       */                               {
/*  5082 */                                 if (targetItem.getPlace() == 13 || targetItem.getPlace() == 14)
/*  5083 */                                   found = true; 
/*       */                               }
/*       */                             } 
/*  5086 */                             if (found)
/*       */                             {
/*  5088 */                               if (this.subjectItem.isLiquid() && !targetItem.isContainerLiquid()) {
/*  5089 */                                 playerComm.sendNormalServerMessage("The " + this.subjectItem.getName() + " wont fit in " + targetItem
/*  5090 */                                     .getNameWithGenus() + '.');
/*       */                               } else {
/*       */ 
/*       */                                 
/*       */                                 try {
/*  5095 */                                   this.subjectItem.getParent().dropItem(this.subjectItem.getWurmId(), false);
/*  5096 */                                   targetItem.insertItem(this.subjectItem);
/*  5097 */                                   if (!this.subjectItem.isRiftLoot()) {
/*  5098 */                                     this.subjectItem.setLastMaintained(WurmCalendar.currentTime);
/*       */                                   }
/*  5100 */                                 } catch (NoSuchItemException nsi) {
/*       */                                   
/*  5102 */                                   logWarn(this.player.getName() + " moving " + this.subjectItem.getName() + " to " + targetItem.getName());
/*       */                                 }
/*       */                               
/*       */                               } 
/*       */                             }
/*  5107 */                           } else if (targetItem.getTemplateId() == 621) {
/*       */                             
/*  5109 */                             playerComm.sendNormalServerMessage(this.subjectItem.getNameWithGenus() + " wont fit in " + targetItem
/*  5110 */                                 .getNameWithGenus() + '.');
/*       */                           }
/*  5112 */                           else if (targetItem.getTemplateId() != 0 && targetItem
/*  5113 */                             .getTemplateId() != 16) {
/*       */ 
/*       */                             
/*       */                             try {
/*  5117 */                               Item targetParent = targetItem.getParent();
/*  5118 */                               if (targetParent.testInsertItem(this.subjectItem)) {
/*       */                                 
/*  5120 */                                 boolean found = false;
/*  5121 */                                 if (targetItem.isBodyPart()) {
/*       */                                   
/*  5123 */                                   found = false;
/*  5124 */                                   for (int i = 0; i < (this.subjectItem.getBodySpaces()).length; i++) {
/*  5125 */                                     if (this.subjectItem.getBodySpaces()[i] == targetParent.getPlace())
/*  5126 */                                       found = true; 
/*  5127 */                                   }  if (!found)
/*       */                                   {
/*  5129 */                                     if (targetParent.getPlace() == 13 || targetParent.getPlace() == 14)
/*  5130 */                                       found = true; 
/*       */                                   }
/*       */                                 } 
/*  5133 */                                 if (found) {
/*       */ 
/*       */                                   
/*       */                                   try {
/*  5137 */                                     this.subjectItem.getParent().dropItem(this.subjectItem.getWurmId(), false);
/*  5138 */                                     targetParent.insertItem(this.subjectItem);
/*  5139 */                                     if (!this.subjectItem.isRiftLoot()) {
/*  5140 */                                       this.subjectItem.setLastMaintained(WurmCalendar.currentTime);
/*       */                                     }
/*  5142 */                                   } catch (NoSuchItemException nsi) {
/*       */                                     
/*  5144 */                                     logWarn(this.player.getName() + " moving " + this.subjectItem.getName() + " to " + targetItem.getName());
/*       */                                   }
/*       */                                 
/*       */                                 } else {
/*       */                                   
/*  5149 */                                   playerComm.sendNormalServerMessage(this.subjectItem.getNameWithGenus() + " wont fit in " + targetItem
/*  5150 */                                       .getNameWithGenus() + '.');
/*       */                                 }
/*       */                               
/*       */                               } else {
/*       */                                 
/*  5155 */                                 playerComm.sendNormalServerMessage(this.subjectItem.getNameWithGenus() + " wont fit in " + targetItem
/*  5156 */                                     .getNameWithGenus() + '.');
/*       */                               }
/*       */                             
/*  5159 */                             } catch (NoSuchItemException nsi) {
/*       */                               
/*  5161 */                               logWarn(this.player.getName() + " moving " + this.subjectItem.getName() + " to " + targetItem.getName());
/*       */                             } 
/*       */                           } 
/*       */                         } else {
/*       */                           
/*  5166 */                           sendNormalServerMessage("You can't reach that.");
/*       */                         } 
/*       */                       } 
/*  5169 */                     } else if (!targetItem.mayCreatureInsertItem()) {
/*       */                       
/*  5171 */                       sendNormalServerMessage("The " + targetItem.getName() + " contains too many items.");
/*       */                     } else {
/*       */                       
/*  5174 */                       sendNormalServerMessage("You can't reach that.");
/*       */                     } 
/*  5176 */                   } catch (NoSuchCreatureException nsc) {
/*       */                     
/*  5178 */                     logWarn(this.player.getName() + " trying to move item from nonexistant creature.");
/*       */                   }
/*  5180 */                   catch (NoSuchPlayerException nsc) {
/*       */                     
/*  5182 */                     logWarn(this.player.getName() + " trying to move item from nonexistant player.");
/*       */                   }
/*       */                 
/*       */                 } 
/*  5186 */               } catch (NoSuchItemException nsi) {
/*       */                 
/*  5188 */                 sendNormalServerMessage(nsi.getMessage());
/*  5189 */                 logWarn(this.player.getName() + "- moving item - no such target item: " + targetId);
/*       */               }
/*       */             
/*       */             } }
/*  5193 */           catch (NoSuchCreatureException cnf)
/*       */           
/*  5195 */           { logWarn(this.player.getName() + "- " + cnf.getMessage(), (Throwable)cnf); }
/*       */           
/*  5197 */           catch (NoSuchPlayerException nsp)
/*       */           
/*  5199 */           { logWarn(this.player.getName() + "- " + nsp.getMessage(), (Throwable)nsp); } 
/*       */         } 
/*       */       }  continue;
/*  5202 */     }  handleCoins(this.coins);
/*  5203 */     if (System.currentTimeMillis() - now > 1000L)
/*       */     {
/*  5205 */       logInfo("Moving items took " + (System.currentTimeMillis() - now) + " ms for " + this.player
/*  5206 */           .getName() + ". target=" + commandAction + ", coins=" + ((this.coins != null) ? 1 : 0));
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private boolean equipCreatureCheck(Item targetItem) {
/*  5212 */     if (targetItem.getOwnerId() == -10L)
/*  5213 */       return true; 
/*  5214 */     boolean ok = false;
/*       */     
/*       */     try {
/*  5217 */       Creature owner = Server.getInstance().getCreature(targetItem.getOwnerId());
/*  5218 */       if (owner.isPlayer())
/*  5219 */         return true; 
/*  5220 */       if (owner.isDead()) {
/*  5221 */         return false;
/*       */       }
/*  5223 */       Vehicle vehicle = Vehicles.getVehicle(owner);
/*       */ 
/*       */       
/*  5226 */       if (!ok && owner.isKingdomGuard() && owner.getKingdomId() == this.player.getKingdomId())
/*  5227 */         ok = true; 
/*  5228 */       if (targetItem.getTemplateId() == 621 || targetItem.isSaddleBags() || targetItem
/*  5229 */         .isInside(new int[] { 1333, 1334 })) {
/*       */         
/*  5231 */         if (!Servers.isThisAPvpServer() && owner.isBranded()) {
/*  5232 */           ok = (ok || owner.mayAccessHold((Creature)this.player));
/*       */         } else {
/*  5234 */           ok = (ok || owner.getDominator() == this.player);
/*       */         } 
/*  5236 */         if (ok)
/*  5237 */           ok = targetItem.mayCreatureInsertItem(); 
/*       */       } 
/*  5239 */       if (this.subjectItem.isCreatureWearableOnly() && owner.isVehicle() && vehicle.getCanHaveEquipment())
/*       */       {
/*  5241 */         if (!Servers.isThisAPvpServer() && owner.isBranded()) {
/*  5242 */           ok = (ok || owner.mayAccessHold((Creature)this.player));
/*       */         } else {
/*  5244 */           ok = (ok || owner.getDominator() == this.player);
/*       */         } 
/*       */       }
/*  5247 */     } catch (NoSuchCreatureException nsc) {
/*       */       
/*  5249 */       logWarn(this.player.getName() + " trying to move item to nonexistant creature.");
/*       */     }
/*  5251 */     catch (NoSuchPlayerException nsc) {
/*       */       
/*  5253 */       logWarn(this.player.getName() + " trying to move item to nonexistant player.");
/*       */     } 
/*  5255 */     return ok;
/*       */   }
/*       */   
/*       */   private final boolean creatureWearableRestrictions(Item targetItem) {
/*  5259 */     if (targetItem.getOwnerId() == -10L)
/*  5260 */       return true; 
/*  5261 */     if (targetItem.isSaddleBags() || targetItem.isInside(new int[] { 1333, 1334 })) {
/*  5262 */       return true;
/*       */     }
/*       */     try {
/*  5265 */       Creature owner = Server.getInstance().getCreature(targetItem.getOwnerId());
/*  5266 */       if (owner.isPlayer()) {
/*  5267 */         return true;
/*       */       }
/*  5269 */       if (this.player.getVehicle() != -10L) {
/*       */         
/*  5271 */         sendNormalServerMessage("You need to be standing on the ground to do that.");
/*  5272 */         return false;
/*       */       } 
/*       */       
/*  5275 */       if (!this.subjectItem.isCreatureWearableOnly())
/*  5276 */         return true; 
/*  5277 */       if (this.subjectItem.getTemperature() > 400) {
/*       */         
/*  5279 */         sendNormalServerMessage("The " + owner.getName() + " rears as the " + this.subjectItem
/*  5280 */             .getName() + " is too warm.");
/*  5281 */         return false;
/*       */       } 
/*  5283 */       if (this.subjectItem.isSaddleLarge()) {
/*       */         
/*  5285 */         if (owner.getSize() <= 4) {
/*       */           
/*  5287 */           sendNormalServerMessage("The " + owner.getName() + " needs to use a normal saddle.");
/*  5288 */           return false;
/*       */         } 
/*  5290 */         if (owner.isKingdomGuard())
/*       */         {
/*  5292 */           sendNormalServerMessage("The " + owner.getName() + " can not use that.");
/*  5293 */           return false;
/*       */         }
/*       */       
/*  5296 */       } else if (this.subjectItem.isSaddleNormal()) {
/*       */         
/*  5298 */         if (owner.getSize() > 4) {
/*       */           
/*  5300 */           sendNormalServerMessage("The " + owner.getName() + " needs to use a larger saddle.");
/*  5301 */           return false;
/*       */         } 
/*  5303 */         if (owner.isKingdomGuard())
/*       */         {
/*  5305 */           sendNormalServerMessage("The " + owner.getName() + " can not use that.");
/*  5306 */           return false;
/*       */         }
/*       */       
/*  5309 */       } else if (this.subjectItem.isHorseShoe()) {
/*       */ 
/*       */         
/*  5312 */         if (!owner.isHorse() && (!owner.isUnicorn() || (this.subjectItem
/*  5313 */           .getMaterial() != 7 && this.subjectItem
/*  5314 */           .getMaterial() != 8 && this.subjectItem
/*  5315 */           .getMaterial() != 96)))
/*       */         {
/*  5317 */           sendNormalServerMessage("The " + owner.getName() + " can not use that.");
/*  5318 */           return false;
/*       */         }
/*       */       
/*  5321 */       } else if (this.subjectItem.isBarding()) {
/*       */         
/*  5323 */         if (!owner.isHorse())
/*       */         {
/*  5325 */           sendNormalServerMessage("The " + owner.getName() + " can not use that.");
/*  5326 */           return false;
/*       */         }
/*       */       
/*       */       }
/*       */     
/*  5331 */     } catch (NoSuchCreatureException nsc) {
/*       */       
/*  5333 */       logWarn(this.player.getName() + " trying to move item to nonexistant creature.");
/*  5334 */       return false;
/*       */     }
/*  5336 */     catch (NoSuchPlayerException nsc) {
/*       */       
/*  5338 */       logWarn(this.player.getName() + " trying to move item to nonexistant player.");
/*  5339 */       return false;
/*       */     } 
/*  5341 */     return true;
/*       */   }
/*       */   
/*       */   private final void handleCoins(Set<Item> coins) throws IOException {
/*  5345 */     if (coins != null) {
/*       */       
/*  5347 */       int val = 0; Iterator<Item> it;
/*  5348 */       for (it = coins.iterator(); it.hasNext(); ) {
/*       */         
/*  5350 */         Item c = it.next();
/*  5351 */         if (c.isCoin())
/*       */         {
/*  5353 */           val += Economy.getValueFor(c.getTemplateId());
/*       */         }
/*       */       } 
/*  5356 */       if (this.player.addMoney(val)) {
/*       */         
/*  5358 */         for (it = coins.iterator(); it.hasNext(); ) {
/*       */           
/*  5360 */           Item item = it.next();
/*  5361 */           if (item.isCoin()) {
/*       */             
/*       */             try {
/*       */               
/*  5365 */               Item parent = item.getParent();
/*  5366 */               parent.dropItem(item.getWurmId(), false);
/*       */ 
/*       */               
/*  5369 */               item.setOwnerId(this.player.getWurmId());
/*       */               
/*  5371 */               Economy.getEconomy().returnCoin(item, "Banked");
/*       */ 
/*       */             
/*       */             }
/*  5375 */             catch (NoSuchItemException nsi) {
/*       */               
/*  5377 */               logWarn(item.getName() + " had no parent when banking?");
/*  5378 */               this.player.getCommunicator().sendNormalServerMessage(item
/*  5379 */                   .getName() + " does not belong to you. Report this as an error.");
/*  5380 */               coins.clear();
/*       */               return;
/*       */             } 
/*       */           }
/*       */         } 
/*  5385 */         Change c = new Change(val);
/*  5386 */         sendNormalServerMessage("Deposited " + c.getChangeString() + '.');
/*  5387 */         Change change = Economy.getEconomy().getChangeFor(this.player.getMoney());
/*  5388 */         sendNormalServerMessage("You now have " + change.getChangeString() + " in the bank.");
/*  5389 */         sendNormalServerMessage("If this amount is incorrect, please wait a while since the information may not immediately be updated.");
/*       */         
/*  5391 */         logInfo(this.player.getName() + " deposited " + c.getChangeString() + " and now has " + change
/*  5392 */             .getChangeString());
/*       */       } else {
/*  5394 */         sendNormalServerMessage("Your bank is not available at the moment. Please try later.");
/*  5395 */       }  coins.clear();
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_EQUIP_ITEM(ByteBuffer byteBuffer) throws NoSuchPlayerException, NoSuchCreatureException, NoSuchBehaviourException, NoSuchWallException, FailedException {
/*  5406 */     int nums = byteBuffer.getShort() & 0xFFFF;
/*  5407 */     long[] items = new long[nums]; int i;
/*  5408 */     for (i = 0; i < nums; i++) {
/*  5409 */       items[i] = byteBuffer.getLong();
/*       */     }
/*  5411 */     for (i = 0; i < nums; i++) {
/*       */ 
/*       */       
/*       */       try {
/*  5415 */         Item item = Items.getItem(items[i]);
/*  5416 */         Item parent = item.getParentOrNull();
/*  5417 */         if (parent != null)
/*  5418 */           if (parent.isBodyPart()) {
/*  5419 */             BehaviourDispatcher.action((Creature)this.player, this, -1L, item.getWurmId(), (short)585);
/*       */           } else {
/*  5421 */             BehaviourDispatcher.action((Creature)this.player, this, -1L, item.getWurmId(), (short)582);
/*       */           }  
/*  5423 */       } catch (NoSuchItemException noSuchItemException) {}
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_MESSAGE(ByteBuffer byteBuffer) throws Exception {
/*  5432 */     byte[] tempStringArr = new byte[byteBuffer.get() & 0xFF];
/*  5433 */     byteBuffer.get(tempStringArr);
/*  5434 */     String message = new String(tempStringArr, "UTF-8");
/*  5435 */     tempStringArr = new byte[byteBuffer.get() & 0xFF];
/*  5436 */     byteBuffer.get(tempStringArr);
/*  5437 */     String title = new String(tempStringArr, "UTF-8");
/*  5438 */     commandMessage = message;
/*  5439 */     if (++this.messagesReceived < 2 || !this.player.isFullyLoaded() || this.player.getSecondsPlayed() < 60.0F) {
/*       */       
/*  5441 */       int power = this.player.getPower();
/*  5442 */       if (message.charAt(0) == '#' && this.player.getPower() == 1) {
/*       */         
/*  5444 */         if (message.startsWith("#invis"))
/*       */         
/*  5446 */         { handleHashMessageInvisible(power); }
/*  5447 */         else if (message.equals("#help"))
/*       */         
/*  5449 */         { handleHashMessageHelp(power); }
/*  5450 */         else if (message.startsWith("#chat"))
/*       */         
/*  5452 */         { handleHashMessageChatColour(message, power); }
/*  5453 */         else if (message.startsWith("#showclientinfo"))
/*       */         
/*  5455 */         { handleHashMessageClientInfo(message, power); }
/*       */         else
/*  5457 */         { sendSafeServerMessage("Unknown command: " + message); } 
/*  5458 */       } else if (message.charAt(0) == '#' && (this.player.getPower() > 1 || this.player.mayMute())) {
/*       */         
/*  5460 */         if (message.startsWith("#sdown"))
/*       */         
/*  5462 */         { handleHashMessageShutdown(power); }
/*  5463 */         else if (message.startsWith("#allowall"))
/*       */         
/*  5465 */         { handleHashMessageAllowAll(power); }
/*  5466 */         else if (message.startsWith("#kick"))
/*       */         
/*  5468 */         { handleHashMessageKick(message, power); }
/*  5469 */         else if (message.startsWith("#showcreaturelist"))
/*       */         
/*  5471 */         { handleShowCreatureList(message, power); }
/*  5472 */         else if (message.startsWith("#setreputation"))
/*       */         
/*  5474 */         { handleHashMessageSetReputation(message, power); }
/*  5475 */         else if (message.startsWith("#toggleglobal"))
/*       */         
/*  5477 */         { handleHashMessageToggleGlobalChat(power); }
/*  5478 */         else if (message.startsWith("#who"))
/*       */         
/*  5480 */         { handleHashMessageWho(message, power); }
/*  5481 */         else if (message.startsWith("#getips"))
/*       */         
/*  5483 */         { handleHashMessageGetIps(power); }
/*  5484 */         else if (message.startsWith("#getip"))
/*       */         
/*  5486 */         { handleHashMessageGetIP(message, power); }
/*  5487 */         else if (message.startsWith("#offline"))
/*       */         
/*  5489 */         { handleHashMessageOffline(power); }
/*  5490 */         else if (message.startsWith("#calcCreatures"))
/*       */         
/*  5492 */         { handleHashMessageCalcCreatures(power); }
/*  5493 */         else if (message.startsWith("#alerts"))
/*       */         
/*  5495 */         { handleHashMessageAlerts(power); }
/*  5496 */         else if (message.startsWith("#ban"))
/*       */         
/*  5498 */         { handleHashMessageBan(message, power); }
/*  5499 */         else if (message.startsWith("#locateitem"))
/*       */         
/*  5501 */         { handleHashMessageLocateItem(message, power); }
/*  5502 */         else if (message.startsWith("#wartargets"))
/*       */         
/*  5504 */         { handleHashMessageWarTargets(power); }
/*  5505 */         else if (message.startsWith("#highscore"))
/*       */         
/*  5507 */         { handleHashMessageHighscore(message, power); }
/*  5508 */         else if (message.startsWith("#meditation"))
/*       */         
/*  5510 */         { handleHashMessageMeditation(power); }
/*  5511 */         else if (message.equals("#createportals"))
/*       */         
/*  5513 */         { handleHashMessageCreatePortals(power); }
/*  5514 */         else if (message.startsWith("#warn"))
/*       */         
/*  5516 */         { handleHashMessageWarn(message, power); }
/*  5517 */         else if (message.startsWith("#resetwarnings"))
/*       */         
/*  5519 */         { handleHashMessageResetWarnings(message, power); }
/*  5520 */         else if (message.startsWith("#getwarnings"))
/*       */         
/*  5522 */         { handleHashMessageGetWarnings(message, power); }
/*  5523 */         else if (message.startsWith("#pardonip"))
/*       */         
/*  5525 */         { handleHashMessagePardonIp(message, power); }
/*  5526 */         else if (message.startsWith("#pardonsteamid"))
/*  5527 */         { handleHashMessagePardonSteamId(message, power); }
/*  5528 */         else if (message.startsWith("#pardon"))
/*  5529 */         { handleHashMessagePardon(message, power); }
/*  5530 */         else if (message.startsWith("#devtalk"))
/*       */         
/*  5532 */         { handleHashMessageDevTalk(message, power); }
/*  5533 */         else if (message.startsWith("#artist"))
/*       */         
/*  5535 */         { handleHashMessageToggleArtist(message, power); }
/*  5536 */         else if (message.startsWith("#invis"))
/*       */         
/*  5538 */         { handleHashMessageInvisible(power); }
/*       */         
/*  5540 */         else if (message.startsWith("#checkeigc"))
/*       */         
/*  5542 */         { handleHashMessageCheckEigc(power); }
/*       */         
/*  5544 */         else if (message.startsWith("#showbans"))
/*       */         
/*  5546 */         { handleHashMessageShowBans(power); }
/*  5547 */         else if (message.startsWith("#locatehorse"))
/*       */         
/*  5549 */         { handleHashMessageLocateHorses(message, power); }
/*  5550 */         else if (message.startsWith("#locateavatars"))
/*       */         
/*  5552 */         { handleHashMessageLocateAvatars(message, power); }
/*  5553 */         else if (message.startsWith("#locate"))
/*       */         
/*  5555 */         { handleHashMessageLocate(message, power); }
/*  5556 */         else if (message.startsWith("#boats"))
/*       */         
/*  5558 */         { handleHashMessageBoats(power); }
/*  5559 */         else if (message.startsWith("#buildinfo") && !Server.getInstance().isPS())
/*       */         
/*  5561 */         { handleHashMessageBuildInfo();
/*       */ 
/*       */ 
/*       */           
/*       */            }
/*       */         
/*  5567 */         else if (message.startsWith("#getAchievementData"))
/*       */         
/*  5569 */         { handleHashMessageGetAchievementData(message, power); }
/*       */         
/*  5571 */         else if (message.startsWith("#showPersonalGoals"))
/*       */         
/*  5573 */         { handleHashMessageShowPersonalGoals(message, power); }
/*       */         
/*  5575 */         else if (message.startsWith("#creaturepos"))
/*       */         
/*  5577 */         { handleHashMessageCreaturePos(power); }
/*  5578 */         else if (message.startsWith("#loadItem"))
/*       */         
/*  5580 */         { handleHashMessageLoadItemFromHell(message, power); }
/*  5581 */         else if (message.equals("#enableboats"))
/*       */         
/*  5583 */         { handleHashMessageEnableBoats(power); }
/*  5584 */         else if (message.equals("#slate"))
/*       */         
/*  5586 */         { handleHashMessageSlate(power); }
/*  5587 */         else if (message.startsWith("#startx"))
/*       */         
/*  5589 */         { handleHashMessageStartX(message, power); }
/*  5590 */         else if (message.startsWith("#starty"))
/*       */         
/*  5592 */         { handleHashMessageStartY(message, power); }
/*  5593 */         else if (message.startsWith("#gm "))
/*       */         
/*  5595 */         { handleHashMessageGm(message, power); }
/*  5596 */         else if (message.startsWith("#resetplayer"))
/*       */         
/*  5598 */         { handleHashMessageResetPlayer(message, power); }
/*  5599 */         else if (message.startsWith("#toggleEpic"))
/*       */         
/*  5601 */         { handleHashMessageToggleEpic(power); }
/*  5602 */         else if (message.startsWith("#xmaslight"))
/*       */         
/*  5604 */         { handleHashMessageXmasLight(power); }
/*  5605 */         else if (message.startsWith("#noxmas"))
/*       */         
/*  5607 */         { handleHashMessageNoXmas(power); }
/*  5608 */         else if (message.startsWith("#mac"))
/*       */         
/*  5610 */         { handleHashMessageMac(message, power); }
/*  5611 */         else if (message.equals("#resetGuards"))
/*       */         
/*  5613 */         { handleHashMessageResetGuards(power); }
/*  5614 */         else if (message.startsWith("#startlibx"))
/*       */         
/*  5616 */         { handleHashMessageStartLibX(message, power); }
/*  5617 */         else if (message.startsWith("#addfakemo"))
/*       */         
/*  5619 */         { handleHashMessageAddFakeMoney(message, power); }
/*  5620 */         else if (message.startsWith("#startliby"))
/*       */         
/*  5622 */         { handleHashMessageStartLibY(message, power); }
/*  5623 */         else if (message.startsWith("#setstartmolrehan"))
/*       */         
/*  5625 */         { handleHashMessageSetStartMolRehan(power); }
/*  5626 */         else if (message.startsWith("#startmolx"))
/*       */         
/*  5628 */         { handleHashMessageStartMolX(message, power); }
/*  5629 */         else if (message.startsWith("#startmoly"))
/*       */         
/*  5631 */         { handleHashMessageStartMolY(message, power); }
/*  5632 */         else if (message.startsWith("#plimit"))
/*       */         
/*  5634 */         { handleHashMessagePLimit(message, power); }
/*  5635 */         else if (message.startsWith("#itempos"))
/*       */         
/*  5637 */         { handleHashMessageItemPosition(message, power); }
/*  5638 */         else if (message.startsWith("#mutewarn"))
/*       */         
/*  5640 */         { handleHashMessageMuteWarn(message, power); }
/*  5641 */         else if (message.startsWith("#checkAff"))
/*       */         
/*  5643 */         { handleHashMessageCheckAffinity(message, power); }
/*  5644 */         else if (message.startsWith("#mute"))
/*       */         
/*  5646 */         { handleHashMessageMute(message, power); }
/*  5647 */         else if (message.startsWith("#unmute"))
/*       */         
/*  5649 */         { handleHashMessageUnmute(message, power); }
/*  5650 */         else if (message.startsWith("#showmuters"))
/*       */         
/*  5652 */         { handleHashMessageShowMuters(power); }
/*  5653 */         else if (message.startsWith("#showdevtalkers"))
/*       */         
/*  5655 */         { handleHashMessageShowDevTalkers(power); }
/*  5656 */         else if (message.startsWith("#showcas"))
/*       */         
/*  5658 */         { handleHashMessageShowCas(power); }
/*  5659 */         else if (message.startsWith("#showhero"))
/*       */         
/*  5661 */         { handleHashMessageShowHeros(message, power); }
/*  5662 */         else if (message.startsWith("#showmuted"))
/*       */         
/*  5664 */         { handleHashMessageShowMuted(power); }
/*  5665 */         else if (message.startsWith("#printranks"))
/*       */         
/*  5667 */         { handleHashMessagePrintRanks(power); }
/*  5668 */         else if (message.startsWith("#setmuter"))
/*       */         
/*  5670 */         { handleHashMessageSetMuter(message, power); }
/*  5671 */         else if (message.startsWith("#toggleca"))
/*       */         
/*  5673 */         { handleHashMessageToggleCA(message); }
/*  5674 */         else if (message.startsWith("#changepassword"))
/*       */         
/*  5676 */         { handleHashMessageChangePassword(message, power); }
/*  5677 */         else if (message.startsWith("#changeemail"))
/*       */         
/*  5679 */         { handleHashMessageChangeEmail(message, power); }
/*  5680 */         else if (message.startsWith("#testemail"))
/*       */         
/*  5682 */         { handleMessageSendTestLetter(message); }
/*  5683 */         else if (message.equals("#invuln"))
/*       */         
/*  5685 */         { handleHashMessageInvulnerable(power); }
/*  5686 */         else if (message.startsWith("#chat"))
/*       */         
/*  5688 */         { handleHashMessageChatColour(message, power); }
/*  5689 */         else if (message.equals("#uniques"))
/*       */         
/*  5691 */         { handleHashMessageUniques(power); }
/*  5692 */         else if (message.startsWith("#rename"))
/*       */         
/*  5694 */         { handleHashMessageRename(message, power); }
/*  5695 */         else if (message.equals("#help"))
/*       */         
/*  5697 */         { handleHashMessageHelp(power); }
/*  5698 */         else if (message.toLowerCase().startsWith("#testcolors"))
/*       */         
/*  5700 */         { handleHashMessageTestColors(message, power); }
/*  5701 */         else if (message.equals("#testAffinity"))
/*       */         
/*  5703 */         { handleHashMessageTestAffinity(power); }
/*  5704 */         else if (message.startsWith("#testFragments"))
/*       */         
/*  5706 */         { handleHashMessageTestFragments(message, power); }
/*  5707 */         else if (message.startsWith("#b ") || message.startsWith("#br ") || message
/*  5708 */           .startsWith("#broadcast "))
/*       */         
/*  5710 */         { handleHashMessageBroadcast(message, power); }
/*  5711 */         else if (message.startsWith("#a ") || message.startsWith("#ann ") || message
/*  5712 */           .startsWith("#announce "))
/*       */         
/*  5714 */         { handleHashMessageAnnounce(message, power); }
/*  5715 */         else if (message.startsWith("#respawn"))
/*       */         
/*  5717 */         { handleHashMessageRespawn(message, power); }
/*  5718 */         else if (message.startsWith("#redeem"))
/*       */         
/*  5720 */         { handleHashMessageRedeem(power); }
/*  5721 */         else if (message.startsWith("#addtitle"))
/*       */         
/*  5723 */         { handleHashMessageAddTitle(message, power); }
/*  5724 */         else if (message.startsWith("#removetitle"))
/*       */         
/*  5726 */         { handleHashMessageRemoveTitle(message, power); }
/*  5727 */         else if (message.startsWith("#reload "))
/*       */         
/*  5729 */         { handleHashMessageReload(message, power); }
/*  5730 */         else if (message.startsWith("#playerstatuses"))
/*       */         
/*  5732 */         { handleHashMessagePlayerStatuses(power); }
/*  5733 */         else if (message.startsWith("#testweb"))
/*       */         
/*  5735 */         { handleHashMessageTestWeb(message, power); }
/*  5736 */         else if (message.startsWith("#worth"))
/*       */         
/*  5738 */         { handleHashMessageWorth(message, power); }
/*  5739 */         else if (message.startsWith("#findboat"))
/*       */         
/*  5741 */         { handleHashMessageFindBoat(message, power); }
/*  5742 */         else if (message.startsWith("#forceRiftLoot"))
/*       */         
/*  5744 */         { handleHashMessageForceRiftLoot(message, power); }
/*  5745 */         else if (message.startsWith("#findfish") && power == 5)
/*       */         
/*  5747 */         { handleHashMessageFindFish(message, true); }
/*  5748 */         else if (message.startsWith("#findoldfish") && power == 5 && Servers.isThisATestServer())
/*       */         
/*  5750 */         { handleHashMessageFindFish(message, false); }
/*  5751 */         else if (message.startsWith("#timemod"))
/*       */         
/*  5753 */         { handleHashMessageTimeMod(message, power); }
/*  5754 */         else if (message.startsWith("#addmoney"))
/*       */         
/*  5756 */         { handleHashMessageAddMoney(message, power); }
/*  5757 */         else if (message.startsWith("#addreimb"))
/*       */         
/*  5759 */         { handleHashMessageAddReimbursement(message, power); }
/*  5760 */         else if (message.startsWith("#lagstatus"))
/*       */         
/*  5762 */         { handleHashMessageLagStatus(power); }
/*  5763 */         else if (message.startsWith("#vespeed"))
/*       */         
/*  5765 */         { handleHashMessageVeSpeed(message, power); }
/*  5766 */         else if (message.startsWith("#onfire"))
/*       */         
/*  5768 */         { handleHashMessageOnFire(power); }
/*  5769 */         else if (message.startsWith("#checkItems"))
/*       */         
/*  5771 */         { handleHashMessageCheckItems(message, power); }
/*  5772 */         else if (message.startsWith("#reloadItems"))
/*       */         
/*  5774 */         { handleHashMessageReloadItems(message, power); }
/*  5775 */         else if (message.startsWith("#checkCreatures"))
/*       */         
/*  5777 */         { handleHashMessageCheckCreatures(message, power); }
/*  5778 */         else if (message.startsWith("#checkZones"))
/*       */         
/*  5780 */         { handleHashMessageCheckZones(power); }
/*  5781 */         else if (message.startsWith("#resendw"))
/*       */         
/*  5783 */         { PendingAccount.resendMails("wurmonline.com"); }
/*  5784 */         else if (message.startsWith("#resendgmail"))
/*       */         
/*  5786 */         { PendingAccount.resendMails("gmail.com"); }
/*  5787 */         else if (message.startsWith("#resend"))
/*       */         
/*  5789 */         { StringTokenizer tokens = new StringTokenizer(message);
/*  5790 */           tokens.nextToken();
/*       */           
/*  5792 */           String next = null;
/*  5793 */           if (tokens.hasMoreTokens())
/*  5794 */             next = tokens.nextToken(); 
/*  5795 */           PendingAccount.resendMails(next); }
/*  5796 */         else if (message.startsWith("#kips"))
/*       */         
/*  5798 */         { handleHashMessageBannedIps(power); }
/*  5799 */         else if (message.startsWith("#overrideshop"))
/*       */         
/*  5801 */         { handleHashMessageOverrideShop(message, power); }
/*  5802 */         else if (message.startsWith("#setserver"))
/*       */         
/*  5804 */         { handleHashMessageSetServer(message, power); }
/*  5805 */         else if (message.startsWith("#readlog"))
/*       */         
/*  5807 */         { handleHashMessageReadLog(message, power); }
/*  5808 */         else if (message.startsWith("#togglemounts"))
/*       */         
/*  5810 */         { handleHashMessageToggleMounts(power); }
/*  5811 */         else if (message.startsWith("#now"))
/*       */         
/*  5813 */         { handleHashMessageNow(); }
/*  5814 */         else if (message.startsWith("#date"))
/*       */         
/*  5816 */         { handleHashMessageRealTime(message); }
/*  5817 */         else if (message.startsWith("#wurmdate"))
/*       */         
/*  5819 */         { handleHashMessageWurmDate(message); }
/*  5820 */         else if (message.startsWith("#harvest") && this.player.getPower() > 2)
/*       */         
/*  5822 */         { handleHashMessageHarvest(message); }
/*  5823 */         else if (!message.startsWith("#respondingto ") || 
/*  5824 */           !handleHashMessageRespond(message))
/*       */         
/*  5826 */         { if (message.startsWith("#logTilePoll"))
/*       */           
/*  5828 */           { handleHashMessageTilePollLog(this.player.getPower()); }
/*  5829 */           else if (message.startsWith("#watch "))
/*       */           
/*  5831 */           { handleHashMessageWatchPlayer(message); }
/*  5832 */           else if (message.startsWith("#tthrow"))
/*       */           
/*  5834 */           { testThrow(); }
/*  5835 */           else if (message.startsWith("#tdeitycount"))
/*       */           
/*  5837 */           { Deities.calculateFaiths();
/*  5838 */             for (Deity d : Deities.getDeities())
/*       */             {
/*  5840 */               sendNormalServerMessage(d
/*  5841 */                   .getName() + " kingdom=" + Deities.getFavoredKingdom(d.getNumber()));
/*       */             } }
/*  5843 */           else if (message.equals("#cpollog"))
/*       */           
/*  5845 */           { Creatures.getInstance().togglePollTaskLog();
/*  5846 */             Creature.getPF().toggleLog();
/*  5847 */             Creature.getPFA().toggleLog();
/*  5848 */             Creature.getPFNPC().toggleLog(); }
/*  5849 */           else if (message.startsWith("#newmission"))
/*       */           
/*  5851 */           { handleHashMessageNeMission(this.player.getPower(), message); }
/*  5852 */           else if (message.startsWith("#togglemission"))
/*       */           
/*  5854 */           { handleHashMessageToggleEnableMission(this.player.getPower(), message); }
/*  5855 */           else if (message.startsWith("#dumpxml"))
/*       */           
/*  5857 */           { handleHashMessageDumpXml(this.player.getPower()); }
/*  5858 */           else if (message.startsWith("#toggleqa"))
/*       */           
/*  5860 */           { handleHashMessageToggleQA(power, message); }
/*  5861 */           else if (message.startsWith("#isqa"))
/*       */           
/*  5863 */           { handleHashMessageIsQA(power, message); }
/*  5864 */           else if (message.startsWith("#maxcreatures"))
/*       */           
/*  5866 */           { handleHashMessageMaxCreatures(power, message); }
/*  5867 */           else if (message.startsWith("#changemodel"))
/*       */           
/*  5869 */           { handleHashMessageChangeModel(power, message); }
/*  5870 */           else if (message.startsWith("#gmlight"))
/*       */           
/*  5872 */           { handleHashMessageGMLight(power, message); }
/*  5873 */           else if (message.startsWith("#dumpcreatures"))
/*       */           
/*  5875 */           { handleCreatureDump(power); }
/*  5876 */           else if (message.startsWith("#dumpmarkers"))
/*       */           
/*  5878 */           { handleMarkerDump(power); }
/*  5879 */           else if (message.startsWith("#dumproutes"))
/*       */           
/*  5881 */           { handleRouteDump(power); }
/*  5882 */           else if (message.startsWith("#dumpsurfacewater"))
/*       */           
/*  5884 */           { handleWaterDump(power, true); }
/*  5885 */           else if (message.startsWith("#dumpcavewater"))
/*       */           
/*  5887 */           { handleWaterDump(power, false); }
/*  5888 */           else if (message.startsWith("#dumpfishspots"))
/*       */           
/*  5890 */           { handleDumpFishSpots(power); }
/*  5891 */           else if (message.startsWith("#showfishspots"))
/*       */           
/*  5893 */           { handleShowFishSpots(power); }
/*  5894 */           else if (message.startsWith("#savemapdump"))
/*       */           
/*  5896 */           { handleMapDump(power); }
/*  5897 */           else if (message.startsWith("#testchallenge"))
/*       */           
/*  5899 */           { handleMessageTestChallengeShutdown(); }
/*       */           
/*  5901 */           else if (message.startsWith("#toggleflag"))
/*       */           
/*  5903 */           { handleHashMessageToggleFlag(power, message); }
/*       */           
/*  5905 */           else if (message.startsWith("#triggerAchievement"))
/*       */           
/*  5907 */           { handleHashMessageTriggerAchievement(power, message); }
/*       */           
/*  5909 */           else if (message.toLowerCase().startsWith("#online"))
/*       */           
/*  5911 */           { handleHashMessageOnline(power, message); }
/*       */           
/*  5913 */           else if (message.startsWith("#flattenRock") && power >= 4)
/*  5914 */           { handleHashMessageFlattenRock(power, message); }
/*       */           
/*  5916 */           else if (message.startsWith("#flattenDirt") && power >= 4)
/*  5917 */           { handleHashMessageFlattenDirt(power, message); }
/*       */           
/*  5919 */           else if (message.startsWith("#createInvestigates") && power >= 4)
/*       */           
/*  5921 */           { Zones.createInvestigatables();
/*  5922 */             sendNormalServerMessage("Ok. Created."); }
/*       */           
/*  5924 */           else if (message.startsWith("#generateDeadVillage") && power == 5)
/*       */           
/*  5926 */           { handleHashMessageGenerateDeadVillage(power, message); }
/*       */           
/*  5928 */           else if (message.startsWith("#addregalia"))
/*       */           
/*  5930 */           { if (power == 5)
/*       */             {
/*  5932 */               handleHashMessageAddRegalia(message, this.player.getPower());
/*       */             } }
/*  5934 */           else if (message.startsWith("#elevate"))
/*       */           
/*  5936 */           { handleHashMessageElevate(this.player.getPower(), message); }
/*  5937 */           else if (message.startsWith("#give"))
/*       */           
/*  5939 */           { if (power == 5)
/*       */             {
/*  5941 */               handleHashMessageGive(message);
/*       */             } }
/*       */           
/*  5944 */           else if (message.startsWith("#clearappointments") && power == 5)
/*       */           
/*  5946 */           { handleHashMessageClearAppointments(message); }
/*       */           
/*  5948 */           else if (message.startsWith("#resetappointments") && power == 5)
/*       */           
/*  5950 */           { handleHashMessageResetAppointments(message); }
/*       */           
/*  5952 */           else if (message.startsWith("#listwildhives") && Servers.isThisATestServer())
/*       */           
/*  5954 */           { handleHashMessageListWildHives(message); }
/*       */           
/*  5956 */           else if (message.startsWith("#removewildhives") && Servers.isThisATestServer())
/*       */           
/*  5958 */           { handleHashMessageRemoveWildHives(); }
/*       */           
/*  5960 */           else if (message.startsWith("#removeknownrecipes") && power == 5)
/*       */           
/*  5962 */           { handleHashMessageRemoveKnownRecipes(message); }
/*       */           
/*  5964 */           else if (message.startsWith("#removenamedrecipe") && power == 5)
/*       */           
/*  5966 */           { handleHashMessageRemoveNamedRecipe(message); }
/*       */           
/*  5968 */           else if (message.startsWith("#setwindpower") && power == 5 && 
/*  5969 */             Servers.isThisATestServer())
/*       */           
/*  5971 */           { handleHashMessageWindPower(message); }
/*       */           
/*  5973 */           else if (message.startsWith("#showme") && power >= 2)
/*       */           
/*  5975 */           { handleHashMessageShowMe(message); }
/*       */           
/*  5977 */           else if (message.startsWith("#hideme") && power >= 2)
/*       */           
/*  5979 */           { handleHashMessageHideMe(message); }
/*       */           
/*  5981 */           else if (message.startsWith("#testspecial") && power == 5)
/*       */           
/*  5983 */           { handleHashMessageTestSpecial(message); }
/*       */           
/*  5985 */           else if (message.startsWith("#setpower") && power >= 4)
/*       */           
/*  5987 */           { handleHashMessageSetPower(message); }
/*       */           
/*  5989 */           else if (message.startsWith("#setAffinityChance") && power == 5)
/*       */           
/*  5991 */           { handleHashMessageSetAffinityChance(message); }
/*       */           
/*  5993 */           else if (message.equalsIgnoreCase("#getAffinityStats") && power == 5)
/*       */           
/*  5995 */           { handleHashMessageGetAffinityStats(); }
/*       */           
/*  5997 */           else if (message.startsWith("#listdens") && power >= 4)
/*       */           
/*  5999 */           { handleHashMessageListDens(); }
/*       */           
/*  6001 */           else if (message.startsWith("#removeden") && power >= 4)
/*       */           
/*  6003 */           { handleHashMessageRemoveDen(message); }
/*       */           
/*  6005 */           else if (message.startsWith("#testTut"))
/*       */           
/*  6007 */           { PlayerTutorial.testTutorialCommand(this.player, message); }
/*       */           
/*  6009 */           else if (message.startsWith("#getStoredCreatures") && power >= 4)
/*       */           
/*  6011 */           { handleGetStoredCreatures(message); }
/*       */           
/*  6013 */           else if (message.startsWith("#testfish ") && power >= 5)
/*       */           
/*  6015 */           { handleTestFish(message); }
/*       */           
/*  6017 */           else if (message.startsWith("#destroyAllCreatures") && power == 5)
/*       */           
/*  6019 */           { if (Servers.isThisATestServer())
/*       */             {
/*  6021 */               handleDestroyAllCreatures();
/*       */             }
/*       */             else
/*       */             {
/*  6025 */               sendNormalServerMessage("This command can only be ran on a test server.");
/*       */             }
/*       */              }
/*  6028 */           else if (message.startsWith("#journalinfo") && power >= 4)
/*       */           
/*  6030 */           { handleHashMessageJournalInfo(message); }
/*       */           else
/*       */           
/*  6033 */           { sendSafeServerMessage("Unknown command: " + message); }  } 
/*  6034 */       } else if (message.startsWith("#mute")) {
/*       */ 
/*       */ 
/*       */         
/*  6038 */         sendSafeServerMessage("You don't have that type of power: " + message);
/*  6039 */       } else if (message.charAt(0) == '/' && !message.startsWith("/me ")) {
/*       */         
/*  6041 */         if (message.startsWith("/tea"))
/*       */         
/*  6043 */         { handleMessageTeamChat(message); }
/*  6044 */         else if (message.startsWith("/testTut"))
/*       */         
/*  6046 */         { PlayerTutorial.testTutorialCommand(this.player, message); }
/*  6047 */         else { if (message.startsWith("/t ") || message.startsWith("/tell ") || message
/*  6048 */             .startsWith("/te")) {
/*       */             
/*  6050 */             handlePMs(message); return;
/*       */           } 
/*  6052 */           if (message.startsWith("/v ") || message.startsWith("/vi ") || message
/*  6053 */             .startsWith("/village ")) {
/*       */             
/*  6055 */             handleMessageVillageChat(message);
/*  6056 */           } else if (isVillageInviteMessage(message)) {
/*       */             
/*  6058 */             handleVillageInviteMessage(message);
/*  6059 */           } else if (message.startsWith("/recruit ")) {
/*       */             
/*  6061 */             handleRecruitMessage(message);
/*  6062 */           } else if (message.startsWith("/unrecruit ")) {
/*       */             
/*  6064 */             handleUnRecruiteMessage(message);
/*  6065 */           } else if (message.equalsIgnoreCase("/listrecruits")) {
/*       */             
/*  6067 */             handleListRecruites();
/*  6068 */           } else if (message.startsWith("/join ")) {
/*       */             
/*  6070 */             handleJoinVillageMessage(message);
/*  6071 */           } else if (message.equals("/vteleport")) {
/*       */             
/*  6073 */             handleVillageTeleportMessage(message);
/*  6074 */           } else if (message.equals("/poll")) {
/*       */             
/*  6076 */             handleInGameVoting();
/*  6077 */           } else if (message.startsWith("/all") || message.startsWith("/alliance ")) {
/*       */             
/*  6079 */             handleMessageAllianceChat(message);
/*  6080 */           } else if (message.startsWith("/afk")) {
/*       */             
/*  6082 */             handleMessageAFK(message);
/*  6083 */           } else if (message.startsWith("/addfriend")) {
/*       */             
/*  6085 */             handleMessageAddFriend(message);
/*  6086 */           } else if (message.startsWith("/tweet ")) {
/*       */             
/*  6088 */             handleMessageTweet(message);
/*  6089 */           } else if (message.startsWith("/support")) {
/*       */             
/*  6091 */             handleMessageSupportChat(message);
/*  6092 */           } else if (message.startsWith("/dev")) {
/*       */             
/*  6094 */             sendNormalServerMessage("Use /support instead.");
/*  6095 */           } else if (message.startsWith("/fl")) {
/*       */             
/*  6097 */             handleMessageFightLevel();
/*  6098 */           } else if (message.startsWith("/suicide")) {
/*       */             
/*  6100 */             handleMessageSuicide();
/*  6101 */           } else if (message.startsWith("/ks")) {
/*       */             
/*  6103 */             sendNormalServerMessage("In future please use /gshout instead.");
/*  6104 */           } else if (message.startsWith("/gs")) {
/*       */             
/*  6106 */             handleMessageKingdomChat(message);
/*  6107 */           } else if (message.startsWith("/s ") || message.startsWith("/shout") || message
/*  6108 */             .startsWith("/sh ")) {
/*       */             
/*  6110 */             handleMessageShout(message);
/*  6111 */           } else if (message.startsWith("/gm ")) {
/*       */             
/*  6113 */             handleMessageGameMasterChat(message);
/*  6114 */           } else if (message.startsWith("/openchat ")) {
/*       */             
/*  6116 */             handleMessageOpenChat(message);
/*  6117 */           } else if (message.equals("/fatigue")) {
/*       */             
/*  6119 */             handleMessageFatigue();
/*  6120 */           } else if (message.equals("/time")) {
/*       */             
/*  6122 */             sendNormalServerMessage(WurmCalendar.getTime());
/*  6123 */             if (Servers.localServer.isChallengeServer())
/*       */             {
/*  6125 */               sendNormalServerMessage("This Challenge ends in " + 
/*  6126 */                   Server.getTimeFor(Servers.localServer.getChallengeEnds() - 
/*  6127 */                     System.currentTimeMillis()) + " and the server is reset.");
/*       */             }
/*       */           }
/*  6130 */           else if (message.equals("/playtime")) {
/*       */             
/*  6132 */             handleMessageTimePlayed();
/*  6133 */           } else if (message.equals("/who")) {
/*       */             
/*  6135 */             handleMessageWho();
/*  6136 */           } else if (message.startsWith("/kchat")) {
/*       */ 
/*       */             
/*  6139 */             sendNormalServerMessage("Please toggle using your Profile.");
/*  6140 */           } else if (message.startsWith("/gchat")) {
/*       */ 
/*       */             
/*  6143 */             sendNormalServerMessage("Please toggle using your Profile.");
/*  6144 */           } else if (message.equals("/respawn")) {
/*       */             
/*  6146 */             handleMessageRespawn();
/*  6147 */           } else if (message.equals("/attackers")) {
/*       */             
/*  6149 */             handleMessageAttackers();
/*  6150 */           } else if (message.startsWith("/weat")) {
/*       */             
/*  6152 */             handleMessageWeather();
/*  6153 */           } else if (message.equals("/stuck")) {
/*       */             
/*  6155 */             handleMessageStuck();
/*       */           }
/*  6157 */           else if (message.equals("/converts")) {
/*       */             
/*  6159 */             handleMessageConverts();
/*  6160 */           } else if (message.equals("/lives")) {
/*       */             
/*  6162 */             handleMessageLives();
/*  6163 */           } else if (message.equals("/title")) {
/*       */             
/*  6165 */             handleMessageTitle();
/*  6166 */           } else if (message.equals("/sleep")) {
/*       */             
/*  6168 */             handleMessageSleepBonus();
/*  6169 */           } else if (message.equals("/titles")) {
/*       */             
/*  6171 */             handleMessageTitleSelect();
/*  6172 */           } else if (message.startsWith("/uptime")) {
/*       */             
/*  6174 */             handleMessageUptime();
/*  6175 */           } else if (message.startsWith("/vote ")) {
/*       */             
/*  6177 */             handleMessageVote(message);
/*  6178 */           } else if (message.equals("/help") || message.equals("/?")) {
/*       */             
/*  6180 */             handleMessageHelp();
/*  6181 */           } else if (message.startsWith("/mission")) {
/*       */             
/*  6183 */             handleMessageMissionInformation();
/*  6184 */           } else if (message.startsWith("/fsleep")) {
/*       */             
/*  6186 */             handleMessageToggleSleep();
/*  6187 */           } else if (message.startsWith("/kingdoms")) {
/*       */             
/*  6189 */             sendZones();
/*  6190 */           } else if (message.startsWith("/challenge")) {
/*       */             
/*  6192 */             handleMessageChallengeKing();
/*  6193 */           } else if (message.startsWith("/revoke")) {
/*       */             
/*  6195 */             handleMessageRevokeVillage(message);
/*  6196 */           } else if (message.startsWith("/remove ")) {
/*       */             
/*  6198 */             handleMessageRemoveFriend(message);
/*  6199 */           } else if (message.startsWith("/random")) {
/*       */             
/*  6201 */             handleMessageRandomNumber(message);
/*       */           }
/*  6203 */           else if (message.startsWith("/part")) {
/*       */             
/*  6205 */             handleHashMessageParticipation(message);
/*       */           }
/*  6207 */           else if (message.startsWith("/rift")) {
/*       */             
/*  6209 */             handleHashMessageRiftParticipation(message, power);
/*       */           }
/*  6211 */           else if (message.startsWith("/release corpse")) {
/*       */             
/*  6213 */             handleMessageReleaseCorpses();
/*  6214 */           } else if (message.startsWith("/champs")) {
/*       */             
/*  6216 */             handleMessageChampRanks();
/*  6217 */           } else if (message.startsWith("/ranks")) {
/*       */             
/*  6219 */             handleMessageBattleRanks();
/*  6220 */           } else if (message.startsWith("/maxranks")) {
/*       */             
/*  6222 */             handleMessageMaxBattleRanks();
/*       */ 
/*       */ 
/*       */ 
/*       */           
/*       */           }
/*  6228 */           else if (message.startsWith("/rank")) {
/*       */             
/*  6230 */             handleMessageBattleRank();
/*  6231 */           } else if (message.startsWith("/lotime")) {
/*       */             
/*  6233 */             handleMessageLogoutTime();
/*  6234 */           } else if (message.startsWith("/reputation")) {
/*       */             
/*  6236 */             handleMessageReputation();
/*  6237 */           } else if (message.startsWith("/invitations")) {
/*       */             
/*  6239 */             handleMessageToggleInvitations();
/*  6240 */           } else if (message.startsWith("/password")) {
/*       */             
/*  6242 */             handleMessageChangePassword(message);
/*  6243 */           } else if (message.startsWith("/ignor")) {
/*       */             
/*  6245 */             handleMessageIgnore(message);
/*  6246 */           } else if (message.startsWith("/snipe")) {
/*       */             
/*  6248 */             handleMessageSnipe(message);
/*  6249 */           } else if (message.equals("/stopcaring")) {
/*       */             
/*  6251 */             handleMessageStopCaring();
/*  6252 */           } else if (message.equals("/caringfor")) {
/*       */             
/*  6254 */             handleMessageShowCaringFor();
/*  6255 */           } else if (message.equals("/vc") || message.equals("/voicechat")) {
/*       */             
/*  6257 */             Methods.sendVoiceChatQuestion((Creature)this.player);
/*  6258 */           } else if (message.equals("/transfer")) {
/*       */             
/*  6260 */             handleMessageTransfer();
/*  6261 */           } else if (message.toLowerCase().equals("/ca")) {
/*       */             
/*  6263 */             sendNormalServerMessage("In future, Please toggle using your Profile.");
/*  6264 */             handleMessageToggleCommunityAssistant();
/*  6265 */           } else if (message.startsWith("/warnings")) {
/*       */             
/*  6267 */             handleMessageWarnings();
/*  6268 */           } else if (message.startsWith("/sign")) {
/*       */             
/*  6270 */             handleMessageSignInOut(message);
/*  6271 */           } else if (message.startsWith("/tinvite")) {
/*       */             
/*  6273 */             handleMessageTeamInvite(message);
/*  6274 */           } else if (Servers.isThisATestServer() && message.startsWith("/rarity ")) {
/*       */             
/*  6276 */             handleMessageRarity(message);
/*       */           }
/*  6278 */           else if (message.startsWith("/mykingdoms")) {
/*       */             
/*  6280 */             handleMessageMyKingdoms();
/*       */           }
/*  6282 */           else if (ServerTweaksHandler.isTweakCommand(message)) {
/*       */             
/*  6284 */             ServerTweaksHandler.handleTweakCommand(message, this.player);
/*       */           }
/*  6286 */           else if (message.startsWith("/toggleccfp")) {
/*       */             
/*  6288 */             handleHashMessageToggleCCFP(power, message);
/*       */           }
/*  6290 */           else if (message.startsWith("/resetccfp") && Servers.isThisATestServer()) {
/*       */             
/*  6292 */             handleMessageClearCCFP();
/*       */           }
/*  6294 */           else if (message.startsWith("/resetfood") && Servers.isThisATestServer()) {
/*       */             
/*  6296 */             handleMessageClearFood();
/*       */           }
/*  6298 */           else if (message.startsWith("/resetthirst") && Servers.isThisATestServer()) {
/*       */             
/*  6300 */             handleMessageClearThirst();
/*       */           }
/*  6302 */           else if (message.startsWith("/almanac")) {
/*       */             
/*  6304 */             handleMessageAlmanac(message);
/*       */           }
/*  6306 */           else if (message.equalsIgnoreCase("/tutorial")) {
/*       */             
/*  6308 */             PlayerTutorial.startTutorialCommand(this.player, message);
/*       */           }
/*  6310 */           else if (message.equalsIgnoreCase("/skipTutorial")) {
/*       */             
/*  6312 */             PlayerTutorial.skipTutorialCommand(this.player, message);
/*       */           } else {
/*       */             
/*  6315 */             sendSafeServerMessage("Unknown command: " + message);
/*       */           }  }
/*       */       
/*  6318 */       } else if (!this.player.isMute()) {
/*       */         
/*  6320 */         boolean emote = message.startsWith("/me ");
/*  6321 */         Message mess = null;
/*  6322 */         String emSend = null;
/*  6323 */         if (emote)
/*       */         {
/*  6325 */           if (!this.player.isDead()) {
/*       */             
/*  6327 */             emSend = this.player.getName() + ' ';
/*  6328 */             emSend = emSend + message.substring(4, message.length());
/*       */           } else {
/*  6330 */             sendNormalServerMessage("Nobody can see you now.");
/*       */           }  } 
/*  6332 */         if (title.equals(":Local")) {
/*       */           
/*  6334 */           if (!this.player.isDead())
/*       */           
/*  6336 */           { if (this.invulnerable) {
/*       */               
/*  6338 */               sendAlertServerMessage("You may not use local chat until you have moved and lost invulnerability.");
/*       */               
/*       */               return;
/*       */             } 
/*  6342 */             if (emote) {
/*  6343 */               mess = new Message((Creature)this.player, (byte)6, ":Local", emSend);
/*       */             } else {
/*       */               
/*  6346 */               message = drunkGarble(message);
/*       */ 
/*       */ 
/*       */               
/*  6350 */               mess = new Message((Creature)this.player, (byte)0, ":Local", "<" + this.player.getName() + "> " + message);
/*       */             } 
/*       */             
/*  6353 */             if (this.player.isStealth())
/*  6354 */               this.player.setStealth(false); 
/*  6355 */             VolaTile tile = this.player.getCurrentTile();
/*  6356 */             if (tile != null)
/*  6357 */               tile.broadCastMessage(mess); 
/*  6358 */             if (!emote)
/*       */             {
/*  6360 */               if (message.equals("help") || message.contains("guard!") || message
/*  6361 */                 .contains("guards!") || message
/*  6362 */                 .contains("help guard") || message.contains("help guards"))
/*  6363 */                 this.player.callGuards(); 
/*       */             }
/*  6365 */             this.player.chattedLocal(); }
/*  6366 */           else if (!this.player.isUndead())
/*  6367 */           { sendNormalServerMessage("Nobody can hear you now."); } 
/*  6368 */         } else if (title.equals("Team")) {
/*       */           
/*  6370 */           if (!this.player.isDead())
/*       */           
/*  6372 */           { if (this.invulnerable) {
/*       */               
/*  6374 */               sendAlertServerMessage("You may not use team chat until you have moved and lost invulnerability.");
/*       */               
/*       */               return;
/*       */             } 
/*       */             
/*  6379 */             if (emote) {
/*       */               
/*  6381 */               mess = new Message((Creature)this.player, (byte)6, "Team", emSend);
/*  6382 */               Team g = this.player.getTeam();
/*  6383 */               if (g != null) {
/*       */                 
/*  6385 */                 g.sendTeamMessage((Creature)this.player, mess);
/*       */               } else {
/*  6387 */                 sendNormalServerMessage("You are not part of a team.");
/*       */               } 
/*       */             } else {
/*  6390 */               message = drunkGarble(message);
/*  6391 */               Team g = this.player.getTeam();
/*  6392 */               if (g != null) {
/*       */                 
/*  6394 */                 g.sendTeamMessage((Creature)this.player, message);
/*       */               } else {
/*  6396 */                 sendNormalServerMessage("You are not part of a team.");
/*       */               } 
/*       */             }  }
/*  6399 */           else { sendNormalServerMessage("Nobody can hear you now."); } 
/*  6400 */         } else if (title.equals("Alliance")) {
/*       */           
/*  6402 */           if (!this.player.isDead())
/*       */           
/*  6404 */           { Village lVillage = this.player.getCitizenVillage();
/*  6405 */             if (lVillage == null || lVillage.getAllianceNumber() == 0) {
/*  6406 */               sendNormalServerMessage("You are not part of an alliance.");
/*       */             }
/*       */             else {
/*       */               
/*  6410 */               PvPAlliance pvpAlliance = PvPAlliance.getPvPAlliance(lVillage.getAllianceNumber());
/*  6411 */               if (pvpAlliance != null) {
/*       */                 
/*  6413 */                 if (emote) {
/*  6414 */                   mess = new Message((Creature)this.player, (byte)6, "Alliance", emSend);
/*       */                 } else {
/*       */                   
/*  6417 */                   message = drunkGarble(message);
/*       */ 
/*       */ 
/*       */                   
/*  6421 */                   mess = new Message((Creature)this.player, (byte)15, "Alliance", "<" + this.player.getName() + "> " + message);
/*       */                 } 
/*       */                 
/*  6424 */                 pvpAlliance.broadCastMessage(mess);
/*       */               } 
/*       */             }  }
/*       */           else
/*  6428 */           { sendNormalServerMessage("Nobody can hear you now."); } 
/*  6429 */         } else if (title.equals("Village")) {
/*       */           
/*  6431 */           if (!this.player.isDead())
/*       */           
/*  6433 */           { Village lVillage = this.player.getCitizenVillage();
/*  6434 */             if (lVillage == null) {
/*  6435 */               sendNormalServerMessage("You are not the citizen of a village or homestead.");
/*       */             } else {
/*       */               
/*  6438 */               if (emote) {
/*  6439 */                 mess = new Message((Creature)this.player, (byte)6, "Village", emSend);
/*       */               
/*       */               }
/*       */               else {
/*       */                 
/*  6444 */                 message = drunkGarble(message);
/*       */ 
/*       */ 
/*       */                 
/*  6448 */                 mess = new Message((Creature)this.player, (byte)3, "Village", "<" + this.player.getName() + "> " + message);
/*       */               } 
/*       */               
/*  6451 */               lVillage.broadCastMessage(mess, lVillage.twitChat());
/*       */             }  }
/*       */           else
/*       */           
/*  6455 */           { sendNormalServerMessage("Nobody can hear you now."); } 
/*  6456 */         } else if (Kingdoms.isKingdomChat(title)) {
/*       */           
/*  6458 */           Kingdom k = Kingdoms.getKingdomWithChatTitle(title);
/*  6459 */           if (!this.player.isDead())
/*       */           
/*  6461 */           { if (emote) {
/*  6462 */               sendNormalServerMessage("You can not emote in that window.");
/*       */             } else {
/*       */               
/*  6465 */               if (this.player.getPower() <= 0)
/*       */               {
/*  6467 */                 if (k != null)
/*       */                 {
/*  6469 */                   if (this.player.getKingdomId() != k.getId()) {
/*       */                     
/*  6471 */                     sendAlertServerMessage("You are not part of " + k
/*  6472 */                         .getName() + '.');
/*       */                     return;
/*       */                   } 
/*       */                 }
/*       */               }
/*  6477 */               if (this.invulnerable) {
/*       */                 
/*  6479 */                 sendAlertServerMessage("You may not use kingdom chat until you have moved and lost invulnerability.");
/*       */                 
/*       */                 return;
/*       */               } 
/*  6483 */               if (this.player.isKingdomChat()) {
/*       */                 
/*  6485 */                 message = drunkGarble(message);
/*       */ 
/*       */ 
/*       */                 
/*  6489 */                 mess = new Message((Creature)this.player, (byte)10, title, "<" + this.player.getName() + "> " + message);
/*       */                 
/*  6491 */                 chatlogger.log(Level.INFO, "SH-" + mess.getMessage());
/*  6492 */                 Player[] playarr = Players.getInstance().getPlayers();
/*       */ 
/*       */                 
/*  6495 */                 if (k != null) {
/*       */                   
/*  6497 */                   byte windowKingdom = k.getId();
/*  6498 */                   if (this.player.getKingdomId() == windowKingdom || this.player
/*  6499 */                     .getPower() > 0)
/*       */                   {
/*  6501 */                     for (int x = 0; x < playarr.length; x++) {
/*       */                       
/*  6503 */                       if (!(playarr[x].getCommunicator()).invulnerable)
/*       */                       {
/*  6505 */                         if (playarr[x].isKingdomChat() && 
/*  6506 */                           !playarr[x].isIgnored(this.player.getWurmId()) && (windowKingdom == playarr[x]
/*  6507 */                           .getKingdomId() || playarr[x]
/*       */                           
/*  6509 */                           .getPower() > 0)) {
/*  6510 */                           playarr[x].getCommunicator().sendMessage(mess);
/*       */                         }
/*       */                       }
/*       */                     } 
/*       */                   }
/*  6515 */                   this.player.chatted();
/*       */                 } 
/*       */               } else {
/*  6518 */                 sendNormalServerMessage("You must toggle Kingdom chat on with /kchat to be able to participate.");
/*       */               } 
/*       */             }  }
/*       */           else
/*  6522 */           { sendNormalServerMessage("Nobody can hear you now."); } 
/*  6523 */         } else if (Kingdoms.isGlobalKingdomChat(title)) {
/*       */           
/*  6525 */           if (gchatdisabled) {
/*       */             
/*  6527 */             sendNormalServerMessage("Global chat is currently disabled on this server.");
/*       */             
/*       */             return;
/*       */           } 
/*       */           
/*  6532 */           Kingdom k = Kingdoms.getKingdomWithChatTitle(title.replace("GL-", ""));
/*  6533 */           if (!this.player.isDead())
/*       */           
/*  6535 */           { if (emote) {
/*  6536 */               sendNormalServerMessage("You can not emote in that window.");
/*       */             } else {
/*       */               
/*  6539 */               if (this.player.getPower() <= 0)
/*       */               {
/*  6541 */                 if (k != null)
/*       */                 {
/*  6543 */                   if (this.player.getKingdomId() != k.getId()) {
/*       */                     
/*  6545 */                     sendAlertServerMessage("You are not part of " + k
/*  6546 */                         .getName() + '.');
/*       */                     return;
/*       */                   } 
/*       */                 }
/*       */               }
/*  6551 */               if (Servers.localServer.entryServer)
/*       */               {
/*  6553 */                 if (!this.player.isReallyPaying() && !this.player.mayMute()) {
/*       */                   
/*  6555 */                   sendNormalServerMessage("You may not use global kingdom chat as a non-premium until you use a portal.");
/*       */                   
/*       */                   return;
/*       */                 } 
/*       */               }
/*  6560 */               if (this.invulnerable) {
/*       */                 
/*  6562 */                 sendAlertServerMessage("You may not use kingdom chat until you have moved and lost invulnerability.");
/*       */                 
/*       */                 return;
/*       */               } 
/*  6566 */               if (this.player.isGlobalChat()) {
/*       */                 
/*  6568 */                 message = drunkGarble(message);
/*       */ 
/*       */ 
/*       */                 
/*  6572 */                 mess = new Message((Creature)this.player, (byte)10, title, "<" + this.player.getName() + "> " + message);
/*       */                 
/*  6574 */                 chatlogger.log(Level.INFO, "KSH-" + mess.getMessage());
/*  6575 */                 Player[] playarr = Players.getInstance().getPlayers();
/*  6576 */                 if (k != null) {
/*       */                   
/*  6578 */                   byte windowKingdom = k.getId();
/*  6579 */                   if (this.player.getKingdomId() == windowKingdom || this.player
/*  6580 */                     .getPower() > 0)
/*       */                   {
/*  6582 */                     for (int x = 0; x < playarr.length; x++) {
/*       */                       
/*  6584 */                       if (!(playarr[x].getCommunicator()).invulnerable)
/*       */                       {
/*  6586 */                         if (playarr[x].isGlobalChat() && 
/*  6587 */                           !playarr[x].isIgnored(this.player.getWurmId()) && (windowKingdom == playarr[x]
/*  6588 */                           .getKingdomId() || playarr[x]
/*       */                           
/*  6590 */                           .getPower() > 0))
/*  6591 */                           playarr[x].getCommunicator().sendMessage(mess); 
/*       */                       }
/*       */                     } 
/*       */                   }
/*  6595 */                   if (message.trim().length() > 1) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                     
/*  6611 */                     WcKingdomChat wc = new WcKingdomChat(WurmId.getNextWCCommandId(), this.player.getWurmId(), this.player.getName(), message, false, this.player.getKingdomId(), this.player.hasColoredChat() ? this.player.getCustomRedChat() : -1, this.player.hasColoredChat() ? this.player.getCustomGreenChat() : -1, this.player.hasColoredChat() ? this.player.getCustomBlueChat() : -1);
/*       */                     
/*  6613 */                     if (!Servers.isThisLoginServer()) {
/*       */                       
/*  6615 */                       wc.sendToLoginServer();
/*       */                     }
/*       */                     else {
/*       */                       
/*  6619 */                       wc.sendFromLoginServer();
/*       */                     } 
/*       */                   } 
/*  6622 */                   this.player.chatted();
/*       */                 } 
/*       */               } else {
/*  6625 */                 sendNormalServerMessage("You must toggle global Kingdom chat on with /gchat to be able to participate.");
/*       */               } 
/*       */             }  }
/*       */           else
/*  6629 */           { sendNormalServerMessage("Nobody can hear you now."); } 
/*  6630 */         } else if (title.equals("MGMT")) {
/*       */           
/*  6632 */           if (emote)
/*  6633 */             message = emSend; 
/*  6634 */           if (message != null && !message.trim().isEmpty())
/*       */           {
/*  6636 */             Players.getInstance()
/*  6637 */               .sendMgmtMessage((Creature)this.player, this.player
/*  6638 */                 .getName(), message, emote, false, 
/*       */ 
/*       */ 
/*       */                 
/*  6642 */                 getPowerColourRed(), 
/*  6643 */                 getPowerColourGreen(), 
/*  6644 */                 getPowerColourBlue());
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */             
/*  6656 */             WcMgmtMessage wc = new WcMgmtMessage(WurmId.getNextWCCommandId(), this.player.getName(), "(" + Servers.localServer.getAbbreviation() + ") " + message, emote, false, getPowerColourRed(), getPowerColourGreen(), getPowerColourBlue());
/*  6657 */             if (!Servers.isThisLoginServer())
/*       */             {
/*  6659 */               wc.sendToLoginServer();
/*       */             }
/*       */             else
/*       */             {
/*  6663 */               wc.sendFromLoginServer();
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */             
/*       */             }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */           
/*       */           }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */         
/*       */         }
/*  6683 */         else if (title.equals("GM")) {
/*       */           
/*  6685 */           if (emote)
/*  6686 */             message = emSend; 
/*  6687 */           if (message != null && !message.trim().isEmpty()) {
/*       */             
/*  6689 */             Players.getInstance().sendGmMessage((Creature)this.player, this.player
/*  6690 */                 .getName(), message, emote, 
/*       */ 
/*       */                 
/*  6693 */                 getPowerColourRed(), 
/*  6694 */                 getPowerColourGreen(), 
/*  6695 */                 getPowerColourBlue());
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */             
/*  6706 */             WCGmMessage wc = new WCGmMessage(WurmId.getNextWCCommandId(), this.player.getName(), "(" + Servers.localServer.getAbbreviation() + ") " + message, emote, getPowerColourRed(), getPowerColourGreen(), getPowerColourBlue());
/*  6707 */             if (!Servers.isThisLoginServer()) {
/*       */               
/*  6709 */               wc.sendToLoginServer();
/*       */             }
/*       */             else {
/*       */               
/*  6713 */               wc.sendFromLoginServer();
/*       */             } 
/*       */           } 
/*  6716 */         } else if (title.equals("Trade")) {
/*       */           
/*  6718 */           if (!this.player.isDead()) {
/*       */             
/*  6720 */             if (emote) {
/*  6721 */               sendNormalServerMessage("You can not emote in that window.");
/*       */             } else {
/*       */               
/*  6724 */               if (Servers.localServer.entryServer)
/*       */               {
/*  6726 */                 if (!this.player.isReallyPaying() && !this.player.mayMute()) {
/*       */                   
/*  6728 */                   sendNormalServerMessage("You may not use global Trade chat as a non-premium until you use a portal.");
/*       */                   
/*       */                   return;
/*       */                 } 
/*       */               }
/*  6733 */               if (this.invulnerable) {
/*       */                 
/*  6735 */                 sendAlertServerMessage("You may not use Trade chat until you have moved and lost invulnerability.");
/*       */                 
/*       */                 return;
/*       */               } 
/*  6739 */               if (!this.player.hasColoredChat && this.player.getPower() <= 1 && 
/*  6740 */                 !message.toUpperCase().startsWith("WTS ") && 
/*  6741 */                 !message.toUpperCase().startsWith("WTT ") && 
/*  6742 */                 !message.toUpperCase().startsWith("WTB ") && 
/*  6743 */                 !message.toUpperCase().startsWith("PC ") && 
/*  6744 */                 !message.toUpperCase().startsWith("@")) {
/*       */                 
/*  6746 */                 sendAlertServerMessage("Only messages starting with WTB, WTS, WTT, PC or @ are allowed.");
/*       */                 
/*       */                 return;
/*       */               } 
/*  6750 */               if (!this.player.hasColoredChat && this.player.hasFlag(1)) {
/*       */                 
/*  6752 */                 sendAlertServerMessage("You must have PMs enabled to use this channel.");
/*       */                 return;
/*       */               } 
/*  6755 */               if (!this.player.hasColoredChat && !this.player.hasFlag(3))
/*       */               {
/*  6757 */                 sendNormalServerMessage("As you dont have cross server PMs enabled, message is restricted to this server only.");
/*       */               }
/*       */               
/*  6760 */               if (this.player.isTradeChannel()) {
/*       */                 
/*  6762 */                 message = drunkGarble(message);
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                 
/*  6776 */                 mess = new Message((Creature)this.player, (byte)18, title, "<" + this.player.getName() + "> (" + Servers.localServer.getAbbreviation() + ") " + message, this.player.hasColoredChat() ? this.player.getCustomRedChat() : -1, this.player.hasColoredChat() ? this.player.getCustomGreenChat() : -1, this.player.hasColoredChat() ? this.player.getCustomBlueChat() : -1);
/*       */                 
/*  6778 */                 chatlogger.log(Level.INFO, "TD-" + mess.getMessage());
/*  6779 */                 Player[] playarr = Players.getInstance().getPlayers();
/*  6780 */                 byte windowKingdom = this.player.getKingdomId();
/*  6781 */                 for (int x = 0; x < playarr.length; x++) {
/*       */                   
/*  6783 */                   if (!(playarr[x].getCommunicator()).invulnerable)
/*       */                   {
/*  6785 */                     if (playarr[x].isTradeChannel() && 
/*  6786 */                       !playarr[x].isIgnored(this.player.getWurmId()) && (windowKingdom == playarr[x]
/*  6787 */                       .getKingdomId() || playarr[x]
/*  6788 */                       .getPower() > 0)) {
/*       */                       
/*  6790 */                       boolean tell = true;
/*  6791 */                       if (message.startsWith("@")) {
/*       */ 
/*       */                         
/*  6794 */                         String patternString = "@" + playarr[x].getName().toLowerCase() + "\\b";
/*       */                         
/*  6796 */                         Pattern pattern = Pattern.compile(patternString);
/*       */                         
/*  6798 */                         Matcher matcher = pattern.matcher(message.toLowerCase());
/*       */                         
/*  6800 */                         tell = (matcher.find() || this.player.getWurmId() == playarr[x].getWurmId());
/*       */                       } 
/*       */                       
/*  6803 */                       if (!this.player.hasColoredChat) {
/*       */ 
/*       */                         
/*  6806 */                         String patternString = "\\b" + playarr[x].getName().toLowerCase() + "\\b";
/*       */                         
/*  6808 */                         Pattern pattern = Pattern.compile(patternString);
/*       */                         
/*  6810 */                         Matcher matcher = pattern.matcher(message.toLowerCase());
/*  6811 */                         if (matcher.find()) {
/*       */                           
/*  6813 */                           mess.setColorR(100);
/*  6814 */                           mess.setColorG(170);
/*  6815 */                           mess.setColorB(255);
/*       */                         } else {
/*       */                           
/*  6818 */                           mess.setColorR(150);
/*  6819 */                           mess.setColorG(230);
/*  6820 */                           mess.setColorB(255);
/*       */                         } 
/*       */                       } 
/*  6823 */                       if (tell)
/*  6824 */                         playarr[x].getCommunicator().sendMessage(mess); 
/*       */                     } 
/*       */                   }
/*       */                 } 
/*  6828 */                 if (this.player.hasFlag(3)) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                   
/*  6844 */                   WcTradeChannel wc = new WcTradeChannel(WurmId.getNextWCCommandId(), this.player.getWurmId(), this.player.getName(), "(" + Servers.localServer.getAbbreviation() + ") " + message, this.player.getKingdomId(), this.player.hasColoredChat() ? this.player.getCustomRedChat() : -1, this.player.hasColoredChat() ? this.player.getCustomGreenChat() : -1, this.player.hasColoredChat() ? this.player.getCustomBlueChat() : -1);
/*       */                   
/*  6846 */                   if (!Servers.isThisLoginServer()) {
/*       */                     
/*  6848 */                     wc.sendToLoginServer();
/*       */                   }
/*       */                   else {
/*       */                     
/*  6852 */                     wc.sendFromLoginServer();
/*       */                   } 
/*       */                 } 
/*  6855 */                 this.player.chatted();
/*       */               } else {
/*       */                 
/*  6858 */                 sendNormalServerMessage("You must toggle Trade channel on from your profile.");
/*       */               } 
/*       */             } 
/*       */           } else {
/*       */             
/*  6863 */             sendNormalServerMessage("Nobody can hear you now.");
/*       */           } 
/*  6865 */         } else if (title.equals("CA HELP")) {
/*       */           
/*  6867 */           if (Servers.localServer.EPIC) {
/*       */             
/*  6869 */             sendNormalServerMessage("This channel is only available when NOT on EPIC servers.");
/*       */           
/*       */           }
/*  6872 */           else if (Servers.isThisLoginServer() && !Server.getInstance().isPS()) {
/*       */ 
/*       */ 
/*       */             
/*  6876 */             if (emote) {
/*  6877 */               mess = new Message((Creature)this.player, (byte)6, "GV HELP", emSend);
/*       */             
/*       */             }
/*       */             else {
/*       */ 
/*       */               
/*  6883 */               mess = new Message((Creature)this.player, (byte)12, "GV HELP", "<" + this.player.getName() + "> " + message);
/*       */             } 
/*       */ 
/*       */             
/*  6887 */             WcGVHelpMessage wchgm = new WcGVHelpMessage(this.player.getName(), message, emote, mess.getRed(), mess.getGreen(), mess.getBlue());
/*  6888 */             for (ServerEntry se : Servers.getAllServers()) {
/*       */ 
/*       */               
/*  6891 */               if (se.getId() != Servers.getLocalServerId())
/*       */               {
/*  6893 */                 wchgm.sendToServer(se.getId());
/*       */               }
/*       */             } 
/*       */           } 
/*  6897 */           if (this.player.seesPlayerAssistantWindow()) {
/*       */             
/*  6899 */             if (emote) {
/*  6900 */               mess = new Message((Creature)this.player, (byte)6, "CA HELP", emSend);
/*       */             
/*       */             }
/*       */             else {
/*       */ 
/*       */               
/*  6906 */               mess = new Message((Creature)this.player, (byte)12, "CA HELP", "<" + this.player.getName() + "> " + message);
/*       */             } 
/*       */ 
/*       */             
/*  6910 */             byte localCAHelpGroup = Servers.localServer.getCAHelpGroup();
/*  6911 */             if (localCAHelpGroup != -1)
/*       */             {
/*  6913 */               if (Servers.isThisLoginServer()) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                 
/*  6922 */                 WcCAHelpGroupMessage wchgm = new WcCAHelpGroupMessage(localCAHelpGroup, this.player.getKingdomId(), this.player.getName(), emote ? emSend : ("(" + Servers.localServer.getAbbreviation() + ") " + message), emote, mess.getRed(), mess.getGreen(), mess.getBlue());
/*  6923 */                 for (ServerEntry se : Servers.getAllServers())
/*       */                 {
/*  6925 */                   if (se.getId() != Servers.getLocalServerId() && se
/*  6926 */                     .getCAHelpGroup() == localCAHelpGroup)
/*       */                   {
/*  6928 */                     wchgm.sendToServer(se.getId());
/*       */                   
/*       */                   }
/*       */                 
/*       */                 }
/*       */ 
/*       */               
/*       */               }
/*       */               else {
/*       */ 
/*       */                 
/*  6939 */                 WcCAHelpGroupMessage wchgm = new WcCAHelpGroupMessage(localCAHelpGroup, this.player.getKingdomId(), this.player.getName(), emote ? emSend : ("(" + Servers.localServer.getAbbreviation() + ") " + message), emote, mess.getRed(), mess.getGreen(), mess.getBlue());
/*  6940 */                 wchgm.sendToLoginServer();
/*       */               } 
/*       */             }
/*       */             
/*  6944 */             Players.getInstance().sendPaMessage(mess);
/*       */           } else {
/*       */             
/*  6947 */             sendNormalServerMessage("You must toggle the CA window using the command /ca first.");
/*       */           }
/*       */         
/*  6950 */         } else if (title.equals("GV HELP")) {
/*       */           
/*  6952 */           if (Servers.isThisLoginServer()) {
/*       */             
/*  6954 */             sendNormalServerMessage("Please use the CA Help window on this server.");
/*       */           
/*       */           }
/*       */           else {
/*       */ 
/*       */             
/*  6960 */             if (emote) {
/*  6961 */               mess = new Message((Creature)this.player, (byte)6, "CA HELP", emSend);
/*       */             
/*       */             }
/*       */             else {
/*       */ 
/*       */               
/*  6967 */               mess = new Message((Creature)this.player, (byte)12, "CA HELP", "<" + this.player.getName() + "> " + message);
/*       */             } 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */             
/*  6974 */             WcCAHelpGroupMessage wchgm = new WcCAHelpGroupMessage((byte)-1, (byte)4, this.player.getName(), emote ? emSend : message, emote, mess.getRed(), mess.getGreen(), mess.getBlue());
/*  6975 */             wchgm.sendToLoginServer();
/*       */             
/*  6977 */             if (emote) {
/*  6978 */               mess = new Message((Creature)this.player, (byte)6, "GV HELP", emSend);
/*       */             
/*       */             }
/*       */             else {
/*       */ 
/*       */               
/*  6984 */               mess = new Message((Creature)this.player, (byte)12, "GV HELP", "<" + this.player.getName() + "> " + message);
/*       */             } 
/*       */             
/*  6987 */             Players.getInstance().sendGVMessage(mess);
/*       */ 
/*       */             
/*  6990 */             WcGVHelpMessage wgvhm = new WcGVHelpMessage(this.player.getName(), message, emote, mess.getRed(), mess.getGreen(), mess.getBlue());
/*  6991 */             for (ServerEntry se : Servers.getAllServers())
/*       */             {
/*       */               
/*  6994 */               if (se.getId() != Servers.getLocalServerId() && se
/*  6995 */                 .getId() != Servers.getLoginServerId())
/*       */               {
/*  6997 */                 wgvhm.sendToServer(se.getId());
/*       */               }
/*       */             }
/*       */           
/*       */           } 
/*  7002 */         } else if (title.equals("JK HELP") || title.equals("MR HELP") || title.equals("HOTS HELP")) {
/*       */           
/*  7004 */           if (!Servers.localServer.EPIC) {
/*       */             
/*  7006 */             sendNormalServerMessage("This channel is only available when on EPIC servers.");
/*       */           
/*       */           }
/*  7009 */           else if (this.player.seesPlayerAssistantWindow()) {
/*       */             
/*  7011 */             byte kingdomId = this.player.getKingdomId();
/*  7012 */             if (this.player.getPower() > 1)
/*       */             {
/*       */               
/*  7015 */               if (title.equals("JK HELP")) {
/*  7016 */                 kingdomId = 1;
/*  7017 */               } else if (title.equals("MR HELP")) {
/*  7018 */                 kingdomId = 2;
/*  7019 */               } else if (title.equals("HOTS HELP")) {
/*  7020 */                 kingdomId = 3;
/*       */               }  } 
/*  7022 */             if (emote) {
/*  7023 */               mess = new Message((Creature)this.player, (byte)6, title, emSend);
/*       */             
/*       */             }
/*       */             else {
/*       */ 
/*       */               
/*  7029 */               mess = new Message((Creature)this.player, (byte)12, title, "<" + this.player.getName() + "> " + message);
/*       */             } 
/*       */ 
/*       */             
/*  7033 */             byte localCAHelpGroup = Servers.localServer.getCAHelpGroup();
/*  7034 */             if (localCAHelpGroup != -1)
/*       */             {
/*  7036 */               if (Servers.isThisLoginServer()) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                 
/*  7043 */                 WcCAHelpGroupMessage wchgm = new WcCAHelpGroupMessage(localCAHelpGroup, kingdomId, this.player.getName(), emote ? emSend : message, emote, mess.getRed(), mess.getGreen(), mess.getBlue());
/*  7044 */                 for (ServerEntry se : Servers.getAllServers())
/*       */                 {
/*  7046 */                   if (se.getId() != Servers.getLocalServerId() && se
/*  7047 */                     .getCAHelpGroup() == localCAHelpGroup)
/*       */                   {
/*  7049 */                     wchgm.sendToServer(se.getId());
/*       */                   
/*       */                   }
/*       */                 
/*       */                 }
/*       */ 
/*       */               
/*       */               }
/*       */               else {
/*       */                 
/*  7059 */                 WcCAHelpGroupMessage wchgm = new WcCAHelpGroupMessage(localCAHelpGroup, kingdomId, this.player.getName(), emote ? emSend : message, emote, mess.getRed(), mess.getGreen(), mess.getBlue());
/*  7060 */                 wchgm.sendToLoginServer();
/*       */               } 
/*       */             }
/*       */             
/*  7064 */             Players.getInstance().sendCaMessage(kingdomId, mess);
/*       */           } else {
/*       */             
/*  7067 */             sendNormalServerMessage("You must toggle the CA window using the command /ca first.");
/*       */           }
/*       */         
/*  7070 */         } else if (title.equals("Friends")) {
/*       */           
/*  7072 */           if (!this.player.isDead()) {
/*       */             
/*  7074 */             Friend[] lFriends = this.player.getFriends();
/*  7075 */             if (emote) {
/*  7076 */               mess = new Message((Creature)this.player, (byte)6, "Friends", emSend);
/*       */             } else {
/*       */               
/*  7079 */               message = drunkGarble(message);
/*       */ 
/*       */ 
/*       */               
/*  7083 */               mess = new Message((Creature)this.player, (byte)4, "Friends", "<" + this.player.getName() + "> " + message);
/*       */             } 
/*       */             
/*  7086 */             for (int a = 0; a < lFriends.length; a++)
/*       */             {
/*       */               
/*       */               try {
/*       */                 
/*  7091 */                 Player friend = Players.getInstance().getPlayer(lFriends[a].getFriendId());
/*  7092 */                 friend.getCommunicator().sendMessage(mess);
/*       */               }
/*  7094 */               catch (NoSuchPlayerException noSuchPlayerException) {}
/*       */             
/*       */             }
/*       */           
/*       */           }
/*       */           else {
/*       */             
/*  7101 */             sendNormalServerMessage("Nobody can hear you now.");
/*       */           } 
/*  7103 */         } else if (title.startsWith("PM: ")) {
/*       */           
/*  7105 */           if (!this.player.isDead() && !this.player.isMute()) {
/*       */             
/*  7107 */             StringTokenizer tokens = new StringTokenizer(title);
/*  7108 */             tokens.nextToken();
/*  7109 */             String targetName = "Unknown";
/*  7110 */             if (tokens.hasMoreTokens())
/*  7111 */               targetName = tokens.nextToken().trim(); 
/*  7112 */             if (emote) {
/*       */               
/*  7114 */               this.player.sendPM(targetName, emSend, true, false);
/*       */             } else {
/*       */               
/*  7117 */               this.player.sendPM(targetName, drunkGarble(message), false, false);
/*       */             } 
/*       */           } 
/*       */           return;
/*       */         } 
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageBuildInfo() {
/*  7130 */     sendBuildInfo("server");
/*  7131 */     sendBuildInfo("common");
/*       */   }
/*       */ 
/*       */   
/*       */   private void sendBuildInfo(String module) {
/*       */     try {
/*  7137 */       BuildProperties info = BuildProperties.getPropertiesFor("/com/wurmonline/" + module.toLowerCase() + "/build.properties");
/*  7138 */       sendNormalServerMessage(module + " branch: " + info.getGitBranch());
/*  7139 */       sendNormalServerMessage(module + " build SHA: " + info.getGitSha1Short());
/*  7140 */       sendNormalServerMessage(module + " built on: " + info.getBuildTimeString());
/*  7141 */       sendNormalServerMessage(module + " version: " + info.getVersion());
/*       */     }
/*  7143 */     catch (IOException e) {
/*  7144 */       sendNormalServerMessage(module + " info not available.");
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleMessageMyKingdoms() {
/*  7150 */     Kingdom epicKingdom = Kingdoms.getKingdom((getPlayer().getSaveFile()).epicKingdom);
/*  7151 */     Kingdom chaosKingdom = Kingdoms.getKingdom(getPlayer().getSaveFile().getChaosKingdom());
/*  7152 */     Kingdom kingdom = Kingdoms.getKingdom(getPlayer().getKingdomId());
/*  7153 */     if (Servers.localServer.isChallengeOrEpicServer())
/*  7154 */       epicKingdom = kingdom; 
/*  7155 */     sendNormalServerMessage("Your current kingdom in these lands is " + kingdom.getName() + ".");
/*  7156 */     if (Server.getInstance().isPS()) {
/*  7157 */       sendNormalServerMessage("Your PvP kingdom is " + chaosKingdom.getName() + ".");
/*       */     } else {
/*  7159 */       sendNormalServerMessage("Your kingdom on Chaos is " + chaosKingdom.getName() + ".");
/*  7160 */     }  sendNormalServerMessage("Your kingdom on Epic is " + epicKingdom.getName() + ".");
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageClearCCFP() {
/*  7166 */     if (Servers.isThisATestServer())
/*       */     {
/*  7168 */       this.player.getStatus().clearCCFPValues();
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageClearFood() {
/*  7175 */     if (Servers.isThisATestServer())
/*       */     {
/*  7177 */       this.player.getStatus().clearHunger();
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageClearThirst() {
/*  7184 */     if (Servers.isThisATestServer())
/*       */     {
/*  7186 */       this.player.getStatus().clearThirst();
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageAlmanac(String message) {
/*  7193 */     Item[] reports = Methods.getBestReports((Creature)this.player, null);
/*  7194 */     if (reports.length == 0) {
/*  7195 */       sendSafeServerMessage("No reports found!");
/*       */     } else {
/*       */       
/*  7198 */       sendSafeServerMessage("Currently Harvestable (from your almanac): ");
/*  7199 */       int found = 0;
/*  7200 */       for (Item report : reports) {
/*       */         
/*  7202 */         WurmHarvestables.Harvestable harvestable = report.getHarvestable();
/*  7203 */         if (harvestable != null && harvestable.isHarvestable()) {
/*       */           
/*  7205 */           sendSafeServerMessage(harvestable.getHarvestableWithDates());
/*  7206 */           found++;
/*       */         } 
/*       */       } 
/*  7209 */       if (found == 0) {
/*  7210 */         sendSafeServerMessage("Nothing in your almanac is currently harvestable!");
/*       */       }
/*       */     } 
/*       */   }
/*       */   
/*       */   private void reallyHandle_CMD_TOGGLE_SWITCH(ByteBuffer byteBuffer) throws IOException {
/*  7216 */     int toggle = byteBuffer.get() & 0xFF;
/*  7217 */     int value = byteBuffer.get() & 0xFF;
/*  7218 */     if (toggle == 0) {
/*       */       
/*  7220 */       if (this.player.isClimbing()) {
/*       */         
/*  7222 */         if (value == 0) {
/*       */           
/*  7224 */           this.player.setClimbing(false);
/*  7225 */           PlayerTutorial.firePlayerTrigger(this.player.getWurmId(), PlayerTutorial.PlayerTrigger.DISABLED_CLIMBING);
/*       */         } 
/*  7227 */       } else if (value == 1 || value == 2) {
/*       */         
/*  7229 */         if (this.player.getVehicle() != -10L) {
/*       */           
/*  7231 */           sendNormalServerMessage("You can not climb now.");
/*  7232 */           sendToggle(0, false); return;
/*       */         } 
/*  7234 */         if (this.player.getStatus().getStamina() > 500 || this.player.isUsingLastGasp()) {
/*       */           
/*  7236 */           this.player.setClimbing(true);
/*  7237 */           PlayerTutorial.firePlayerTrigger(this.player.getWurmId(), PlayerTutorial.PlayerTrigger.ENABLED_CLIMBING);
/*       */         } else {
/*       */           
/*  7240 */           sendNormalServerMessage("You are too exhausted to climb now.");
/*  7241 */           sendToggle(0, false);
/*       */         } 
/*       */       } 
/*  7244 */     } else if (toggle == 5) {
/*       */       
/*  7246 */       float lastx = byteBuffer.getFloat();
/*  7247 */       float lasty = byteBuffer.getFloat();
/*  7248 */       float lastz = byteBuffer.getFloat();
/*  7249 */       float dampen = byteBuffer.getFloat();
/*  7250 */       float fallMod = byteBuffer.getFloat();
/*  7251 */       if (this.ready) {
/*       */         
/*  7253 */         if (lastx != this.lastX || lasty != this.lastY || lastz != this.lastZ) {
/*       */           
/*  7255 */           this.player.setCheated("Not same moves!");
/*  7256 */           logWarn(this.player.getName() + " not the same move at verification! lastX=" + this.lastX + " vs " + lastx + ", lastY=" + this.lastY + " vs " + lasty + ", lastZ=" + this.lastZ + " vs " + lastz);
/*       */         } 
/*       */ 
/*       */ 
/*       */         
/*  7261 */         this.lastCounts = 0;
/*  7262 */         if (fallMod != this.ticker.getFallMod()) {
/*       */           
/*  7264 */           this.player.setCheated("Hacked Fall mod");
/*  7265 */           logWarn(this.player.getName() + " hacked the fall mod to " + fallMod + " from the standard " + this.ticker
/*  7266 */               .getFallMod());
/*       */         } 
/*  7268 */         if (dampen != this.ticker.getMoveMod()) {
/*       */           
/*  7270 */           this.player.setCheated("Hacked Move mod");
/*  7271 */           logWarn(this.player.getName() + " hacked the move mod to " + dampen + " from the standard " + this.ticker
/*  7272 */               .getMoveMod());
/*       */         } 
/*       */       } 
/*  7275 */     } else if (toggle == 1) {
/*       */       
/*  7277 */       if (this.player.faithful) {
/*       */         
/*  7279 */         if (value == 0)
/*       */         {
/*       */ 
/*       */ 
/*       */           
/*  7284 */           this.player.setFaithMode(false);
/*       */         }
/*  7286 */       } else if (value == 1 || value == 2) {
/*       */         
/*  7288 */         this.player.setFaithMode(true);
/*       */       } 
/*       */ 
/*       */ 
/*       */       
/*  7293 */       this.player.getStatus().sendStateString();
/*  7294 */     } else if (toggle == 2) {
/*       */       
/*  7296 */       if (this.player.isLegal()) {
/*       */         
/*  7298 */         if (value == 0)
/*  7299 */           this.player.setLegal(false); 
/*  7300 */       } else if (value == 1 || value == 2) {
/*  7301 */         this.player.setLegal(true);
/*       */       }
/*       */     
/*  7304 */     } else if (toggle == 3) {
/*       */       
/*  7306 */       if (this.player.isStealth()) {
/*       */         
/*  7308 */         if (value == 0)
/*  7309 */           this.player.setStealth(false); 
/*  7310 */       } else if (value == 1 || value == 2) {
/*       */         
/*  7312 */         if (this.player.isFighting()) {
/*       */           
/*  7314 */           sendToggle(3, false);
/*  7315 */           sendNormalServerMessage("You can't hide now.", (byte)3);
/*       */         } else {
/*       */ 
/*       */           
/*       */           try {
/*  7320 */             if (this.player.getCurrentAction() != null) {
/*       */               
/*  7322 */               sendToggle(3, false);
/*  7323 */               sendNormalServerMessage("You can't hide now.");
/*       */             } else {
/*  7325 */               this.player.startPersonalAction((short)136, -1L, this.player.getWurmId());
/*       */             } 
/*  7327 */           } catch (NoSuchActionException nsa) {
/*       */             
/*  7329 */             this.player.startPersonalAction((short)136, -1L, this.player.getWurmId());
/*       */           }
/*       */         
/*       */         } 
/*       */       } 
/*  7334 */     } else if (toggle == 4) {
/*       */       
/*  7336 */       if (this.player.isAutofight())
/*       */       
/*  7338 */       { if (value == 0)
/*  7339 */           this.player.setAutofight(false);  }
/*  7340 */       else if (value == 1 || value == 2)
/*  7341 */       { this.player.setAutofight(true); } 
/*  7342 */     } else if (toggle == 100) {
/*       */       
/*  7344 */       if (this.player.isArcheryMode())
/*       */       
/*  7346 */       { if (value == 0)
/*  7347 */           this.player.setArcheryMode(false);  }
/*  7348 */       else if (value == 1 || value == 2)
/*  7349 */       { this.player.setArcheryMode(true); } 
/*  7350 */     } else if (toggle == 6) {
/*       */       
/*  7352 */       handleMessageToggleSleep();
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_ACTION(ByteBuffer byteBuffer) {
/*  7359 */     if (this.invulnerable) {
/*       */       
/*  7361 */       setInvulnerable(false);
/*  7362 */       sendNormalServerMessage("You are no longer invulnerable.");
/*       */     } 
/*       */     
/*  7365 */     int nums = byteBuffer.getShort() & 0xFFFF;
/*  7366 */     long subject = byteBuffer.getLong();
/*  7367 */     long[] targets = new long[nums];
/*  7368 */     for (int s = 0; s < nums; s++) {
/*  7369 */       targets[s] = byteBuffer.getLong();
/*       */     }
/*  7371 */     short action = byteBuffer.getShort();
/*       */ 
/*       */     
/*  7374 */     if (nums > 1 && Actions.isMultipleItemAction(action, targets)) {
/*       */ 
/*       */ 
/*       */ 
/*       */       
/*  7379 */       commandAction = WurmId.getType(targets[0]);
/*  7380 */       if (!this.player.isDead() && !this.player.isTransferring()) {
/*       */         try
/*       */         {
/*       */ 
/*       */ 
/*       */           
/*  7386 */           if (Actions.isDefaultTerraformingAction(action))
/*       */           {
/*  7388 */             action = Actions.getDefaultActionForTarget(subject, targets[0]);
/*       */           }
/*  7390 */           BehaviourDispatcher.action((Creature)this.player, this, subject, targets, action);
/*       */         }
/*  7392 */         catch (FailedException fe)
/*       */         {
/*  7394 */           sendNormalServerMessage(fe.getMessage());
/*       */         
/*       */         }
/*  7397 */         catch (NoSuchCreatureException nsc)
/*       */         {
/*  7399 */           logInfo(this.player.getName() + "- action dispatching failed. " + nsc);
/*       */         
/*       */         }
/*  7402 */         catch (NoSuchPlayerException nsp)
/*       */         {
/*  7404 */           logInfo(this.player.getName() + "- action dispatching failed. " + nsp);
/*       */         
/*       */         }
/*  7407 */         catch (RuntimeException rex)
/*       */         {
/*  7409 */           logInfo(this.player.getName() + "- action dispatching failed", rex);
/*       */         
/*       */         }
/*  7412 */         catch (NoSuchBehaviourException nsb)
/*       */         {
/*  7414 */           logInfo(this.player.getName() + "- action dispatching failed " + nsb.getMessage(), (Throwable)nsb);
/*       */         
/*       */         }
/*  7417 */         catch (NoSuchItemException nsw)
/*       */         {
/*       */ 
/*       */ 
/*       */           
/*  7422 */           if (this.player.getPower() >= 2)
/*       */           {
/*  7424 */             this.player.getCommunicator().sendNormalServerMessage(nsw.getMessage());
/*       */           }
/*       */         }
/*  7427 */         catch (Exception ex)
/*       */         {
/*       */           
/*  7430 */           logInfo(this.player.getName() + "- action dispatching failed", ex);
/*       */         }
/*       */       
/*       */       }
/*       */     } else {
/*       */       
/*  7436 */       for (int x = 0; x < nums; x++) {
/*       */ 
/*       */ 
/*       */         
/*  7440 */         if (!this.player.isDead() && !this.player.isTransferring()) {
/*       */           
/*       */           try {
/*       */             
/*  7444 */             commandAction = WurmId.getType(targets[x]);
/*       */ 
/*       */             
/*  7447 */             if (Actions.isDefaultTerraformingAction(action))
/*       */             {
/*  7449 */               action = Actions.getDefaultActionForTarget(subject, targets[x]);
/*       */             }
/*  7451 */             BehaviourDispatcher.action((Creature)this.player, this, subject, targets[x], action);
/*       */           }
/*  7453 */           catch (FailedException fe) {
/*       */             
/*  7455 */             if (!fe.getMessage().equals("This is a placeholder message.")) {
/*  7456 */               sendNormalServerMessage(fe.getMessage(), (byte)3);
/*       */             }
/*       */           }
/*  7459 */           catch (NoSuchCreatureException nsc) {
/*       */             
/*  7461 */             logInfo(this.player.getName() + "- action dispatching failed. " + nsc);
/*       */           
/*       */           }
/*  7464 */           catch (NoSuchPlayerException nsp) {
/*       */             
/*  7466 */             logInfo(this.player.getName() + "- action dispatching failed. " + nsp);
/*       */           
/*       */           }
/*  7469 */           catch (RuntimeException rex) {
/*       */             
/*  7471 */             logInfo(this.player.getName() + "- action dispatching failed", rex);
/*       */           
/*       */           }
/*  7474 */           catch (NoSuchBehaviourException nsb) {
/*       */             
/*  7476 */             logInfo(this.player.getName() + "- action dispatching failed " + nsb.getMessage(), (Throwable)nsb);
/*       */           
/*       */           }
/*  7479 */           catch (NoSuchWallException nsw) {
/*       */             
/*  7481 */             logInfo(this.player.getName() + "- action dispatching failed " + nsw.getMessage(), (Throwable)nsw);
/*       */           
/*       */           }
/*  7484 */           catch (NoSuchItemException nsw) {
/*       */ 
/*       */ 
/*       */ 
/*       */             
/*  7489 */             if (this.player.getPower() >= 2)
/*       */             {
/*  7491 */               this.player.getCommunicator().sendNormalServerMessage(nsw.getMessage());
/*       */             }
/*       */           }
/*  7494 */           catch (Exception ex) {
/*       */ 
/*       */             
/*  7497 */             logInfo(this.player.getName() + "- action dispatching failed", ex);
/*       */           } 
/*       */         }
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_ITEM_CREATION_LIST(ByteBuffer byteBuffer) {
/*  7512 */     byte subCommand = byteBuffer.get();
/*  7513 */     if (this.commandsThisSecond > 10)
/*       */     {
/*  7515 */       logger.log(Level.INFO, "Subcommand for item_creation_list=" + subCommand);
/*       */     }
/*  7517 */     if (subCommand == 0) {
/*       */       
/*  7519 */       long source = byteBuffer.getLong();
/*  7520 */       long target = byteBuffer.getLong();
/*  7521 */       int sType = WurmId.getType(source);
/*  7522 */       int tType = WurmId.getType(target);
/*       */       
/*  7524 */       if ((sType == 2 || sType == 19 || source == -10L) && (tType == 2 || tType == 19 || target == -10L)) {
/*       */ 
/*       */         
/*  7527 */         sendPartialCreationList(source, target);
/*       */       }
/*  7529 */       else if (sType == 12 || tType == 12) {
/*       */         
/*  7531 */         if (sType == 12 && tType == 2) {
/*  7532 */           sendTileBorderCreationList(source, target);
/*  7533 */         } else if (sType == 2 && tType == 12) {
/*  7534 */           sendTileBorderCreationList(target, source);
/*       */         } 
/*  7536 */       } else if (sType == 7 || tType == 7) {
/*       */         
/*  7538 */         sendFenceCreationList(source, target);
/*       */       }
/*  7540 */       else if (sType == 5 || tType == 5) {
/*       */         
/*  7542 */         if (sType == 5 && (tType == 2 || target == -10L)) {
/*  7543 */           sendWallCreationList(source, target);
/*  7544 */         } else if ((sType == 2 || source == -10L) && tType == 5) {
/*  7545 */           sendWallCreationList(target, source);
/*       */         } 
/*  7547 */       } else if (sType == 23 || tType == 23) {
/*       */         
/*  7549 */         if (sType == 23 && (tType == 2 || target == -10L)) {
/*  7550 */           sendRoofFloorCreationList(source, target);
/*  7551 */         } else if ((sType == 2 || source == -10L) && tType == 23) {
/*  7552 */           sendRoofFloorCreationList(target, source);
/*       */         } 
/*  7554 */       } else if (sType == 28 || tType == 28) {
/*       */         
/*  7556 */         if (sType == 28 && (tType == 2 || tType == 19 || target == -10L)) {
/*       */           
/*  7558 */           sendBridgePartCreationList(source, target);
/*  7559 */         } else if ((sType == 2 || sType == 19 || source == -10L) && tType == 28) {
/*       */           
/*  7561 */           sendBridgePartCreationList(target, source);
/*       */         } 
/*  7563 */       } else if (sType == 17 || tType == 17) {
/*       */         
/*  7565 */         if (sType == 17 && (tType == 2 || target == -10L)) {
/*  7566 */           sendCaveCreationList(source, target);
/*  7567 */         } else if ((sType == 2 || source == -10L) && tType == 17) {
/*  7568 */           sendCaveCreationList(target, source);
/*       */         } 
/*       */       } 
/*  7571 */     } else if (subCommand == 3) {
/*       */       
/*  7573 */       sendCreationsList();
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_REQUEST_SELECT(ByteBuffer byteBuffer) {
/*  7579 */     if (this.invulnerable) {
/*       */       
/*  7581 */       setInvulnerable(false);
/*  7582 */       sendNormalServerMessage("You are no longer invulnerable.");
/*       */     } 
/*  7584 */     byte requestId = byteBuffer.get();
/*  7585 */     long target = byteBuffer.getLong();
/*  7586 */     long subject = byteBuffer.getLong();
/*       */     
/*  7588 */     commandAction = WurmId.getType(target);
/*  7589 */     if (this.commandsThisSecond > 10)
/*       */     {
/*  7591 */       logger.log(Level.INFO, "Subcommand for reallyHandle_CMD_REQUEST_SELECT=" + commandAction);
/*       */     }
/*  7593 */     if (!this.player.isDead() && !this.player.isTransferring()) {
/*       */       
/*       */       try {
/*       */         
/*  7597 */         BehaviourDispatcher.requestSelectionActions((Creature)this.player, this, requestId, subject, target);
/*       */       }
/*  7599 */       catch (NoSuchItemException ex) {
/*       */         
/*  7601 */         logInfo(this.player.getName() + "- action request failed. No such item. " + ex);
/*       */       }
/*  7603 */       catch (NoSuchPlayerException nsp) {
/*       */         
/*  7605 */         logInfo(this.player.getName() + "- action request failed. No such player. " + nsp);
/*       */       }
/*  7607 */       catch (NoSuchCreatureException nsc) {
/*       */         
/*  7609 */         logInfo(this.player.getName() + "- action request failed. No such creature. " + nsc);
/*       */       }
/*  7611 */       catch (Exception ex) {
/*       */         
/*  7613 */         logWarn(this.player.getName() + "- action request failed.", ex);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_REQUEST_ACTIONS(ByteBuffer byteBuffer) {
/*  7620 */     if (this.invulnerable) {
/*       */       
/*  7622 */       setInvulnerable(false);
/*  7623 */       sendNormalServerMessage("You are no longer invulnerable.");
/*       */     } 
/*  7625 */     byte requestId = byteBuffer.get();
/*  7626 */     long target = byteBuffer.getLong();
/*  7627 */     long subject = byteBuffer.getLong();
/*       */     
/*  7629 */     commandAction = WurmId.getType(target);
/*  7630 */     if (!this.player.isDead() && !this.player.isTransferring()) {
/*       */       
/*       */       try {
/*       */         
/*  7634 */         BehaviourDispatcher.requestActions((Creature)this.player, this, requestId, subject, target);
/*       */       }
/*  7636 */       catch (NoSuchItemException ex) {
/*       */         
/*  7638 */         logInfo(this.player.getName() + "- action request failed. No such item. " + ex);
/*       */       }
/*  7640 */       catch (NoSuchPlayerException nsp) {
/*       */         
/*  7642 */         logInfo(this.player.getName() + "- action request failed. No such player. " + nsp);
/*       */       }
/*  7644 */       catch (NoSuchCreatureException nsc) {
/*       */         
/*  7646 */         logInfo(this.player.getName() + "- action request failed. No such creature. " + nsc);
/*       */       }
/*  7648 */       catch (Exception ex) {
/*       */         
/*  7650 */         logWarn(this.player.getName() + "- action request failed.", ex);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private final boolean setNextMove() {
/*  7657 */     if (this.currentmove.getNext() != null && this.currentmove != this.currentmove.getNext()) {
/*       */       
/*  7659 */       if (this.currentmove.isHandled()) {
/*       */         
/*  7661 */         PlayerMove last = this.currentmove;
/*       */         
/*  7663 */         this.currentmove = this.currentmove.getNext();
/*  7664 */         last.setNext(null);
/*       */       } 
/*  7666 */       return true;
/*       */     } 
/*  7668 */     return false;
/*       */   }
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_MOVE_CREATURE(ByteBuffer byteBuffer, byte cmd) {
/*  7673 */     if (this.ready) {
/*       */       
/*  7675 */       this.lastCounts++;
/*  7676 */       if (this.lastCounts % 10000 == 0) {
/*  7677 */         logWarn(this.player.getName() + " last counts=" + this.lastCounts);
/*       */       }
/*       */     } 
/*       */     
/*  7681 */     if (this.ready) {
/*       */       
/*  7683 */       PlayerMove next = new PlayerMove();
/*       */       
/*  7685 */       if (this.currentmove != null)
/*       */       {
/*  7687 */         this.currentmove.getLast().setNext(next);
/*       */       }
/*  7689 */       if (this.player.vehicle != -10L && !this.player.isVehicleCommander()) {
/*       */         
/*  7691 */         this.lastX = byteBuffer.getFloat();
/*  7692 */         this.lastY = byteBuffer.getFloat();
/*  7693 */         this.lastZ = byteBuffer.getFloat();
/*       */       
/*       */       }
/*       */       else {
/*       */         
/*  7698 */         next.setNewPosX(byteBuffer.getFloat());
/*  7699 */         next.setNewPosY(byteBuffer.getFloat());
/*  7700 */         next.setNewPosZ(byteBuffer.getFloat());
/*  7701 */         this.lastX = next.getNewPosX();
/*  7702 */         this.lastY = next.getNewPosY();
/*  7703 */         this.lastZ = next.getNewPosZ();
/*       */       } 
/*       */       
/*  7706 */       next.setNewRot(byteBuffer.getFloat());
/*  7707 */       next.setBm(byteBuffer.get());
/*  7708 */       next.setLayer(byteBuffer.get());
/*  7709 */       if (cmd == -29) {
/*       */         
/*  7711 */         byte data = byteBuffer.get();
/*       */         
/*  7713 */         next.setOnFloor(((data & 0x1) != 0));
/*       */         
/*  7715 */         boolean sentBridge = ((data & 0x2) != 0);
/*  7716 */         boolean falling = ((data & 0x4) != 0);
/*  7717 */         next.setIsFalling(falling);
/*  7718 */         if (sentBridge)
/*       */         {
/*  7720 */           next.setNewBridgeId(byteBuffer.getLong());
/*       */         }
/*  7722 */         if ((data & 0x8) != 0) {
/*       */           
/*  7724 */           next.setNewHeightOffset(byteBuffer.getInt());
/*  7725 */           if ((data & 0x10) != 0) {
/*       */             
/*  7727 */             next.setChangeHeightImmediately(false);
/*       */           } else {
/*  7729 */             next.setChangeHeightImmediately(true);
/*       */           } 
/*       */         } 
/*       */       } 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/*  7750 */       if (this.receivedBridgeChange) {
/*       */         
/*  7752 */         next.setNewBridgeId(this.newBridgeId);
/*  7753 */         this.receivedBridgeChange = false;
/*       */       } 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/*  7770 */       if (this.currentmove == null)
/*       */       {
/*  7772 */         this.currentmove = next;
/*       */       }
/*       */       
/*  7775 */       this.moves++;
/*  7776 */       this.ticker.started = true;
/*  7777 */       if (!this.receivedTicks)
/*       */       {
/*       */         
/*  7780 */         this.receivedTicks = true;
/*       */       }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/*  7790 */       if (this.moves > 2500)
/*       */       {
/*  7792 */         logWarn(this.player.getName() + " 2500 moves. Disconnecting.");
/*  7793 */         this.player.setLink(false);
/*       */ 
/*       */ 
/*       */       
/*       */       }
/*       */ 
/*       */ 
/*       */ 
/*       */     
/*       */     }
/*       */     else {
/*       */ 
/*       */ 
/*       */ 
/*       */       
/*  7808 */       byteBuffer.getFloat();
/*  7809 */       byteBuffer.getFloat();
/*  7810 */       byteBuffer.getFloat();
/*       */       
/*  7812 */       byteBuffer.getFloat();
/*       */       
/*  7814 */       byte crapbm = byteBuffer.get();
/*  7815 */       byteBuffer.get();
/*       */       
/*  7817 */       if (cmd == -29) {
/*       */         
/*  7819 */         byte data = byteBuffer.get();
/*       */         
/*  7821 */         boolean sentBridge = ((data & 0x2) != 0);
/*       */         
/*  7823 */         if (sentBridge)
/*       */         {
/*  7825 */           byteBuffer.getLong();
/*       */         }
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_NOT_MOVE_CREATURE() {
/*  7858 */     if (this.ticker != null)
/*       */     {
/*  7860 */       if (this.ready)
/*       */       {
/*  7862 */         if (this.currentmove != null) {
/*       */           
/*  7864 */           this.moves++;
/*  7865 */           this.currentmove.getLast().incrementSameMoves();
/*       */ 
/*       */           
/*  7868 */           if (this.newHeightOffset != -10000) {
/*       */             
/*  7870 */             this.currentmove.getLast().setNewHeightOffset(this.newHeightOffset);
/*  7871 */             this.currentmove.getLast().setChangeHeightImmediately(this.changeHeightImmediately);
/*  7872 */             this.newHeightOffset = -10000;
/*       */           } 
/*  7874 */           if (this.receivedBridgeChange) {
/*       */             
/*  7876 */             this.currentmove.setNewBridgeId(this.newBridgeId);
/*  7877 */             this.receivedBridgeChange = false;
/*       */           } 
/*       */         } 
/*       */       }
/*       */     }
/*       */   }
/*       */   
/*       */   private void reallyHandle_CMD_VALREIFIGHT(ByteBuffer byteBuffer) throws Exception { int requestedPage;
/*       */     long fightId;
/*  7886 */     byte subCommand = byteBuffer.get();
/*  7887 */     switch (subCommand) {
/*       */       
/*       */       case 0:
/*  7890 */         requestedPage = byteBuffer.getInt();
/*  7891 */         sendValreiFightList(requestedPage);
/*       */         break;
/*       */       case 1:
/*  7894 */         fightId = byteBuffer.getLong();
/*  7895 */         sendValreiFightDetails(fightId);
/*       */         break;
/*       */     }  } private void reallyHandle_CMD_COOKBOOK(ByteBuffer byteBuffer) throws Exception {
/*       */     short recipeId;
/*       */     boolean isFavourite;
/*       */     String notes;
/*       */     Recipe recipe;
/*  7902 */     byte subCommand = byteBuffer.get();
/*  7903 */     switch (subCommand) {
/*       */ 
/*       */       
/*       */       case 0:
/*  7907 */         this.player.setIsViewingCookbook();
/*       */         
/*  7909 */         if (this.player.getPower() == 5) {
/*  7910 */           sendRecipeNameList(Recipes.getAllRecipes()); break;
/*       */         } 
/*  7912 */         sendRecipeNameList(RecipesByPlayer.getKnownRecipesFor(this.player.getWurmId()));
/*       */         break;
/*       */ 
/*       */ 
/*       */       
/*       */       case 1:
/*  7918 */         recipeId = byteBuffer.getShort();
/*  7919 */         if (this.player.getPower() == 5) {
/*  7920 */           sendCookbookRecipe(Recipes.getRecipeById(recipeId)); break;
/*       */         } 
/*  7922 */         sendCookbookRecipe(RecipesByPlayer.getRecipe(this.player.getWurmId(), recipeId));
/*       */         break;
/*       */ 
/*       */ 
/*       */       
/*       */       case 2:
/*  7928 */         recipeId = byteBuffer.getShort();
/*  7929 */         isFavourite = (byteBuffer.get() != 0);
/*  7930 */         RecipesByPlayer.setIsFavourite(this.player.getWurmId(), recipeId, isFavourite);
/*       */         break;
/*       */ 
/*       */ 
/*       */ 
/*       */       
/*       */       case 3:
/*  7937 */         recipeId = byteBuffer.getShort();
/*  7938 */         notes = readByteString(byteBuffer);
/*  7939 */         RecipesByPlayer.setNotes(this.player.getWurmId(), recipeId, notes);
/*       */         break;
/*       */ 
/*       */ 
/*       */ 
/*       */       
/*       */       case 4:
/*  7946 */         if (this.player.isWritingRecipe()) {
/*       */           
/*  7948 */           sendNormalServerMessage("You are currently writing a recipe so cannot change to another.");
/*       */           
/*       */           break;
/*       */         } 
/*  7952 */         recipeId = byteBuffer.getShort();
/*  7953 */         recipe = RecipesByPlayer.getRecipe(this.player.getWurmId(), recipeId);
/*  7954 */         this.player.setViewingRecipe(recipe);
/*       */         break;
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private int getPowerColourRed() {
/*  7962 */     switch (this.player.getPower()) {
/*       */       
/*       */       case 5:
/*  7965 */         return 255;
/*       */       case 4:
/*  7967 */         return 128;
/*       */       case 3:
/*  7969 */         return 187;
/*       */       case 2:
/*  7971 */         return 20;
/*       */       case 1:
/*  7973 */         return 255;
/*       */     } 
/*  7975 */     if (this.player.mayHearDevTalk())
/*  7976 */       return 255; 
/*  7977 */     if (this.player.mayMute())
/*  7978 */       return 100; 
/*  7979 */     return -1;
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private int getPowerColourGreen() {
/*  7985 */     switch (this.player.getPower()) {
/*       */       
/*       */       case 5:
/*  7988 */         return 242;
/*       */       case 4:
/*  7990 */         return 250;
/*       */       case 3:
/*  7992 */         return 1;
/*       */       case 2:
/*  7994 */         return 200;
/*       */       case 1:
/*  7996 */         return 175;
/*       */     } 
/*  7998 */     if (this.player.mayHearDevTalk())
/*  7999 */       return 128; 
/*  8000 */     if (this.player.mayMute())
/*  8001 */       return 220; 
/*  8002 */     return -1;
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private int getPowerColourBlue() {
/*  8008 */     switch (this.player.getPower()) {
/*       */       
/*       */       case 5:
/*  8011 */         return 1;
/*       */       case 4:
/*  8013 */         return 20;
/*       */       case 3:
/*  8015 */         return 187;
/*       */       case 2:
/*  8017 */         return 255;
/*       */       case 1:
/*  8019 */         return 200;
/*       */     } 
/*  8021 */     if (this.player.mayHearDevTalk())
/*  8022 */       return 1; 
/*  8023 */     if (this.player.mayMute())
/*  8024 */       return 200; 
/*  8025 */     return -1;
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleRecruitWindowDataMessage(ByteBuffer bb) {
/*  8031 */     short length = bb.getShort();
/*  8032 */     byte[] byteDesc = new byte[length];
/*  8033 */     bb.get(byteDesc);
/*       */ 
/*       */     
/*       */     try {
/*  8037 */       String description = new String(byteDesc, "UTF-8");
/*  8038 */       Village playerVillage = Villages.getVillageForCreature((Creature)this.player);
/*  8039 */       if (playerVillage != null) {
/*       */ 
/*       */         
/*       */         try {
/*  8043 */           if (!RecruitmentAds.containsAdForVillage(playerVillage.getId()))
/*       */           {
/*  8045 */             RecruitmentAds.create(playerVillage.getId(), description, this.player.getWurmId(), this.player.getKingdomId());
/*       */           }
/*       */           else
/*       */           {
/*  8049 */             RecruitmentAds.update(playerVillage.getId(), description, this.player.getWurmId(), new Date(
/*  8050 */                   System.currentTimeMillis()), this.player.getKingdomId());
/*       */           }
/*       */         
/*  8053 */         } catch (IOException ioe) {
/*       */           
/*  8055 */           logWarn("Unable to create recruitment ad.", ioe);
/*       */         }
/*       */       
/*       */       } else {
/*       */         
/*  8060 */         sendNormalServerMessage("You don't belong to a village so you can't post a recruitment ad.");
/*       */       }
/*       */     
/*  8063 */     } catch (UnsupportedEncodingException enc) {
/*       */       
/*  8065 */       logWarn("Unsupported encoding in recruit window data: UTF-8", enc);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void testThrow() {
/*  8071 */     CombatMove thrsow = CombatMove.getCombatMove(6);
/*  8072 */     thrsow.perform((Creature)this.player);
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void handlePMs(String message) {
/*  8078 */     if (!this.player.isDead() && !this.player.isMute()) {
/*       */       
/*  8080 */       StringTokenizer tokens = new StringTokenizer(message);
/*  8081 */       tokens.nextToken();
/*  8082 */       String targetName = "Unknown";
/*  8083 */       if (tokens.hasMoreTokens())
/*  8084 */         targetName = tokens.nextToken().trim(); 
/*  8085 */       String _message = "";
/*  8086 */       if (tokens.hasMoreTokens())
/*  8087 */         _message = tokens.nextToken(); 
/*  8088 */       while (tokens.hasMoreTokens())
/*  8089 */         _message = _message + ' ' + tokens.nextToken(); 
/*  8090 */       _message = drunkGarble(_message);
/*       */       
/*  8092 */       this.player.sendPM(targetName, _message, false, false);
/*       */     } else {
/*       */       
/*  8095 */       sendNormalServerMessage("Nobody can hear you now.");
/*       */     } 
/*       */   }
/*       */   
/*       */   private void handleMessageAFK(String message) {
/*  8100 */     if (this.player.isAFK()) {
/*       */ 
/*       */       
/*  8103 */       this.player.setAFK(false);
/*  8104 */       sendNormalServerMessage("You are no longer AFK.");
/*       */     
/*       */     }
/*       */     else {
/*       */       
/*  8109 */       StringTokenizer tokens = new StringTokenizer(message);
/*  8110 */       tokens.nextToken();
/*  8111 */       String newAFKMessage = "";
/*  8112 */       while (tokens.hasMoreTokens())
/*  8113 */         newAFKMessage = newAFKMessage + tokens.nextToken().trim() + ' '; 
/*  8114 */       if (!newAFKMessage.isEmpty()) {
/*  8115 */         this.player.setAFKMessage(newAFKMessage);
/*       */       }
/*  8117 */       this.player.setAFK(true);
/*  8118 */       sendNormalServerMessage("You are now AFK (with message:" + this.player
/*  8119 */           .getAFKMessage() + ").");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageAddFriend(String message) {
/*  8126 */     StringTokenizer tokens = new StringTokenizer(message);
/*  8127 */     tokens.nextToken();
/*  8128 */     String friendsName = "";
/*  8129 */     String category = "Other";
/*  8130 */     if (tokens.hasMoreTokens())
/*  8131 */       friendsName = tokens.nextToken().trim(); 
/*  8132 */     if (tokens.hasMoreTokens()) {
/*  8133 */       category = tokens.nextToken().trim();
/*       */     }
/*  8135 */     if (!friendsName.isEmpty()) {
/*  8136 */       addFriend(friendsName, category);
/*       */     } else {
/*  8138 */       sendNormalServerMessage("Use /addfriend <name> <category>.");
/*       */     } 
/*       */   }
/*       */   
/*       */   public void addFriend(String name, String category) {
/*  8143 */     Friend.Category cat = Friend.Category.Other;
/*       */     
/*  8145 */     cat = Friend.Category.catFromName(category);
/*  8146 */     if (cat == null) {
/*       */       
/*  8148 */       sendNormalServerMessage("Unknown category, should be one of Trusted, Friends, Contacts or Other.");
/*       */       
/*       */       return;
/*       */     } 
/*  8152 */     String friendsName = LoginHandler.raiseFirstLetter(name);
/*  8153 */     if (friendsName.equalsIgnoreCase(this.player.getName())) {
/*       */       
/*  8155 */       sendNormalServerMessage("We will always be friends, you know too much.");
/*       */       return;
/*       */     } 
/*  8158 */     String wffn = this.player.waitingForFriend();
/*  8159 */     if (!wffn.isEmpty() && !wffn.equalsIgnoreCase(friendsName)) {
/*       */       
/*  8161 */       if (this.player.askingFriend()) {
/*  8162 */         sendNormalServerMessage("You are still waiting for " + wffn + '.');
/*       */       } else {
/*  8164 */         sendNormalServerMessage("You need to reply to " + wffn + " first.");
/*       */       } 
/*       */       return;
/*       */     } 
/*  8168 */     PlayerState pstate = PlayerInfoFactory.getPlayerState(friendsName);
/*  8169 */     if (pstate == null) {
/*       */       
/*  8171 */       sendNormalServerMessage("Unknown player " + friendsName + '.');
/*       */       
/*       */       return;
/*       */     } 
/*  8175 */     if (this.player.isFriend(pstate.getPlayerId())) {
/*       */       
/*  8177 */       sendNormalServerMessage("You are already friends with " + friendsName + '.');
/*       */       
/*       */       return;
/*       */     } 
/*  8181 */     if (this.player.isIgnored(pstate.getPlayerId())) {
/*       */       
/*  8183 */       sendNormalServerMessage("You are ignoring " + friendsName + " and therefore cannot send friends request.");
/*       */       return;
/*       */     } 
/*  8186 */     if (this.player.hasFlag(1)) {
/*       */       
/*  8188 */       sendNormalServerMessage("You have to enable PMs to be able to send friend requests.");
/*       */       
/*       */       return;
/*       */     } 
/*  8192 */     if (wffn.equalsIgnoreCase(friendsName) && this.player.askingFriend()) {
/*       */       
/*  8194 */       sendNormalServerMessage("You are still waiting for " + wffn + '.');
/*       */       
/*       */       return;
/*       */     } 
/*  8198 */     if (pstate.getServerId() == Servers.getLocalServerId()) {
/*       */ 
/*       */       
/*       */       try {
/*       */         
/*  8203 */         byte reply = 7;
/*  8204 */         Player p = Players.getInstance().getPlayer(friendsName);
/*  8205 */         if (wffn.isEmpty()) {
/*       */ 
/*       */           
/*  8208 */           if (this.player.getKingdomId() != p.getKingdomId() && !this.player.hasFlag(2)) {
/*       */             
/*  8210 */             sendNormalServerMessage(friendsName + " is not the same kingdom. You need to enable cross kingdom PMs to be able to send friend requests to other kingdoms.");
/*       */             
/*       */             return;
/*       */           } 
/*       */           
/*  8215 */           this.player.setAskFriend(friendsName, cat);
/*  8216 */           sendNormalServerMessage("You have sent a request to " + friendsName + '.');
/*  8217 */           reply = p.remoteAddFriend(this.player.getName(), this.player.getKingdomId(), (byte)0, false, this.player
/*  8218 */               .hasFlag(2));
/*       */         }
/*       */         else {
/*       */           
/*  8222 */           this.player.setAddFriendTimout(30, cat);
/*  8223 */           reply = p.remoteAddFriend(this.player.getName(), this.player.getKingdomId(), (byte)6, false, this.player
/*  8224 */               .hasFlag(2));
/*       */         } 
/*       */         
/*  8227 */         if (reply != 7) {
/*  8228 */           this.player.remoteAddFriend(friendsName, p.getKingdomId(), reply, false, p
/*  8229 */               .hasFlag(2));
/*       */         }
/*  8231 */       } catch (NoSuchPlayerException e) {
/*       */         
/*  8233 */         sendSafeServerMessage(friendsName + " is not currently available, please try again later.");
/*       */ 
/*       */ 
/*       */         
/*       */         return;
/*       */       } 
/*       */     } else {
/*  8240 */       byte reply = 0;
/*  8241 */       if (!wffn.isEmpty()) {
/*       */         
/*  8243 */         this.player.setAddFriendTimout(30, cat);
/*  8244 */         reply = 6;
/*       */       }
/*       */       else {
/*       */         
/*  8248 */         sendNormalServerMessage("You have sent a request to " + friendsName + '.');
/*  8249 */         this.player.setAskFriend(friendsName, cat);
/*       */       } 
/*       */ 
/*       */       
/*  8253 */       WcAddFriend waf = new WcAddFriend(this.player.getName(), this.player.getKingdomId(), friendsName, reply, this.player.hasFlag(2));
/*       */       
/*  8255 */       if (Servers.isThisLoginServer()) {
/*       */         
/*  8257 */         byte where = waf.sendToPlayerServer(friendsName);
/*  8258 */         if (where == 1) {
/*       */           
/*  8260 */           sendSafeServerMessage(friendsName + " is unknown.");
/*       */           
/*       */           return;
/*       */         } 
/*       */       } else {
/*  8265 */         waf.sendToLoginServer();
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageSetReputation(String message, int power) {
/*  8275 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/*  8284 */       StringTokenizer tokens = new StringTokenizer(message);
/*       */       
/*  8286 */       tokens.nextToken();
/*  8287 */       String pname = "Unknown";
/*  8288 */       String rep = "0";
/*  8289 */       int newreputation = 0;
/*  8290 */       if (tokens.hasMoreTokens()) {
/*       */         
/*       */         try {
/*       */           
/*  8294 */           pname = tokens.nextToken().trim();
/*  8295 */           if (tokens.hasMoreTokens()) {
/*  8296 */             rep = tokens.nextToken();
/*       */           } else {
/*       */             
/*  8299 */             sendSafeServerMessage("Usage: #setreputation <name> <new reputation>");
/*       */             
/*       */             return;
/*       */           } 
/*       */           try {
/*  8304 */             newreputation = Integer.parseInt(rep);
/*       */           }
/*  8306 */           catch (NumberFormatException nse) {
/*       */             
/*  8308 */             sendSafeServerMessage("Failed to parse " + rep + " to a valid number.");
/*       */             
/*       */             return;
/*       */           } 
/*  8312 */           pname = LoginHandler.raiseFirstLetter(pname);
/*  8313 */           Player p = Players.getInstance().getPlayer(pname);
/*  8314 */           if (this.player.getLogger() != null) {
/*  8315 */             this.player.getLogger().log(Level.INFO, this.player
/*       */                 
/*  8317 */                 .getName() + " setting reputation of " + pname + " to " + newreputation);
/*       */           }
/*  8319 */           if (p.getPower() < power) {
/*       */             
/*  8321 */             if (p.getReputation() > newreputation) {
/*  8322 */               p.getCommunicator().sendAlertServerMessage("Your reputation has been lowered by " + this.player
/*  8323 */                   .getName() + '!');
/*       */             } else {
/*       */               
/*  8326 */               p.getCommunicator().sendSafeServerMessage("Your reputation has been increased by " + this.player
/*  8327 */                   .getName() + '!');
/*       */             } 
/*  8329 */             p.setReputation(newreputation);
/*  8330 */             sendNormalServerMessage("The reputation of " + p.getName() + " now is " + p
/*  8331 */                 .getReputation() + '.');
/*       */           } else {
/*       */             
/*  8334 */             sendAlertServerMessage("You cannot change " + p.getName() + "'s reputation.");
/*       */           } 
/*  8336 */         } catch (NoSuchPlayerException nsp) {
/*       */           
/*  8338 */           sendSafeServerMessage("No player found with the name " + pname);
/*       */         } 
/*       */       }
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void banSteamIdImplementation(String message, int power) {
/*  8346 */     String usage = "Usage: #bansteam <player/steamId> <days> <reason>";
/*       */     
/*  8348 */     StringTokenizer tokens = new StringTokenizer(message);
/*  8349 */     tokens.nextToken();
/*  8350 */     String identifier = tokens.hasMoreTokens() ? tokens.nextToken() : "";
/*  8351 */     int days = tokens.hasMoreTokens() ? Integer.parseInt(tokens.nextToken()) : 0;
/*  8352 */     String reason = tokens.hasMoreTokens() ? tokens.nextToken("") : "";
/*       */     
/*  8354 */     if (identifier.isEmpty() || days == 0 || reason.isEmpty()) {
/*       */       
/*  8356 */       sendAlertServerMessage("Usage: #bansteam <player/steamId> <days> <reason>");
/*       */       
/*       */       return;
/*       */     } 
/*  8360 */     Player ply = Players.getInstance().getPlayerOrNull(identifier);
/*  8361 */     SteamId toBan = null;
/*  8362 */     if (ply == null) {
/*  8363 */       toBan = SteamId.fromAnyString(identifier);
/*  8364 */       for (Player p : Players.getInstance().getPlayerMap().values()) {
/*  8365 */         if (p.getSteamId().equals(SteamId.fromAnyString(identifier))) {
/*  8366 */           ply = p; break;
/*       */         } 
/*       */       } 
/*       */     } else {
/*  8370 */       toBan = ply.getSteamId();
/*       */     } 
/*  8372 */     if (ply != null && ply.getPower() >= power) {
/*       */       
/*  8374 */       sendAlertServerMessage("You cannot ban someone of equal or greater power and they've been informed.");
/*  8375 */       if (ply.hasLink() && ply.getCommunicator() != null)
/*  8376 */         ply.getCommunicator().sendAlertServerMessage(this.player.getName() + " tried to ban your SteamId."); 
/*  8377 */       if (this.player.getLogger() != null)
/*  8378 */         this.player.getLogger().log(Level.INFO, this.player.getName() + " tried to steamid ban " + ply.getName() + " (" + toBan + ") for " + days + " days. Reason: " + reason); 
/*       */       return;
/*       */     } 
/*  8381 */     Players.getInstance().addBan((Ban)new SteamIdBan(toBan, reason, System.currentTimeMillis() + days * 86400000L));
/*  8382 */     if (this.player.getLogger() != null)
/*  8383 */       this.player.getLogger().log(Level.INFO, this.player.getName() + " banned " + toBan + " for " + days + " days. Reason: " + reason); 
/*  8384 */     sendSafeServerMessage("You ban " + toBan + " for " + days + " days.");
/*  8385 */     logInfo(this.player.getName() + " bans steamid " + toBan + " for " + days + " days. Reason " + reason);
/*  8386 */     if (ply.hasLink() && ply.getCommunicator() != null) {
/*  8387 */       ply.getCommunicator().sendAlertServerMessage("You have been banned for " + days + " days.");
/*       */     }
/*       */   }
/*       */   
/*       */   private void banIpImplementation(String message, int power) {
/*  8392 */     boolean ok = true;
/*  8393 */     StringTokenizer tokens = new StringTokenizer(message);
/*  8394 */     tokens.nextToken();
/*  8395 */     String ip = "";
/*  8396 */     String reason = "";
/*  8397 */     long expiry = 0L;
/*  8398 */     int days = 0;
/*  8399 */     if (tokens.hasMoreTokens() && ok) {
/*       */       
/*       */       try
/*       */       {
/*  8403 */         ip = tokens.nextToken().trim();
/*  8404 */         if (ip.charAt(0) != '/') {
/*  8405 */           ip = '/' + ip;
/*       */         
/*       */         }
/*       */       }
/*  8409 */       catch (Exception ex)
/*       */       {
/*  8411 */         ok = false;
/*       */       }
/*       */     
/*       */     } else {
/*       */       
/*  8416 */       ok = false;
/*       */     } 
/*  8418 */     int dots = ip.indexOf('*');
/*  8419 */     if (dots > 0 && dots < 5) {
/*       */       
/*  8421 */       sendAlertServerMessage("Failed to ban the ip. The ip address must be at least 5 characters long.");
/*       */       return;
/*       */     } 
/*  8424 */     Player[] players = Players.getInstance().getPlayers();
/*  8425 */     for (int x = 0; x < players.length; x++) {
/*       */       
/*  8427 */       if (players[x].hasLink()) {
/*       */         
/*  8429 */         boolean ban = players[x].getCommunicator().getConnection().getIp().equals(ip);
/*  8430 */         if (!ban && dots > 0)
/*       */         {
/*  8432 */           ban = players[x].getCommunicator().getConnection().getIp().startsWith(ip.substring(0, dots)); } 
/*  8433 */         if (ban)
/*       */         {
/*  8435 */           if (players[x].getPower() < power) {
/*       */             
/*  8437 */             Players.getInstance().logoutPlayer(players[x]);
/*       */           }
/*       */           else {
/*       */             
/*  8441 */             ok = false;
/*  8442 */             sendNormalServerMessage("You cannot kick " + players[x].getName() + '!');
/*       */             
/*  8444 */             players[x].getCommunicator().sendAlertServerMessage(this.player
/*  8445 */                 .getName() + " tried to kick you from the game and ban your ip.");
/*       */           } 
/*       */         }
/*       */       } 
/*       */     } 
/*       */     
/*  8451 */     if (tokens.hasMoreTokens() && ok) {
/*       */       
/*       */       try
/*       */       {
/*  8455 */         days = Integer.parseInt(tokens.nextToken().trim());
/*  8456 */         expiry = System.currentTimeMillis() + days * 86400000L;
/*       */ 
/*       */       
/*       */       }
/*  8460 */       catch (Exception ex)
/*       */       {
/*  8462 */         ok = false;
/*       */       }
/*       */     
/*       */     } else {
/*       */       
/*  8467 */       ok = false;
/*       */     } 
/*  8469 */     if (tokens.hasMoreTokens() && ok) {
/*       */ 
/*       */       
/*       */       try {
/*  8473 */         while (tokens.hasMoreTokens())
/*  8474 */           reason = reason + tokens.nextToken() + ' '; 
/*  8475 */         if (reason.length() < 4) {
/*       */           
/*  8477 */           sendAlertServerMessage("The reason " + reason + " seems a bit short. Please explain a bit more.");
/*       */ 
/*       */           
/*       */           return;
/*       */         } 
/*  8482 */       } catch (Exception ex) {
/*       */         
/*  8484 */         ok = false;
/*       */       }
/*       */     
/*       */     } else {
/*       */       
/*  8489 */       ok = false;
/*       */     } 
/*  8491 */     if (!ok) {
/*       */       
/*  8493 */       sendAlertServerMessage("Failed to ban the ip. Make sure you use the syntax #ban <ip> <days> <reason> like this: #ban 10.0.0.0 2 broke the rules.");
/*       */       return;
/*       */     } 
/*  8496 */     Players.getInstance().addBannedIp(ip, reason, expiry);
/*  8497 */     if (this.player.getLogger() != null) {
/*  8498 */       this.player.getLogger().log(Level.INFO, this.player
/*       */           
/*  8500 */           .getName() + " banned " + ip + " for " + days + " days. Reason: " + reason);
/*       */     }
/*  8502 */     sendSafeServerMessage("You ban " + ip + " for " + days + " days. The server won't accept connections from " + ip + " anymore.");
/*       */     
/*  8504 */     logInfo(this.player.getName() + " bans ipaddress " + ip + " for " + days + " days. Reason " + reason);
/*       */     
/*  8506 */     if (!message.startsWith("#baniphere")) {
/*       */       
/*       */       try {
/*       */         
/*  8510 */         LoginServerWebConnection c = new LoginServerWebConnection();
/*  8511 */         sendSafeServerMessage(c.addBannedIp(ip, reason, days));
/*       */       }
/*  8513 */       catch (Exception e) {
/*       */         
/*  8515 */         sendAlertServerMessage("Failed to ban on login server:" + e.getMessage());
/*  8516 */         logInfo(this.player.getName() + " banning ip on login server failed: " + e
/*  8517 */             .getMessage(), e);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private void banPlayerImplementation(String message, int power) {
/*  8524 */     StringTokenizer tokens = new StringTokenizer(message);
/*  8525 */     tokens.nextToken();
/*  8526 */     String bname = "";
/*  8527 */     StringBuilder reason = new StringBuilder("");
/*  8528 */     long expiry = 0L;
/*  8529 */     int days = 0;
/*  8530 */     if (tokens.hasMoreTokens()) {
/*       */ 
/*       */       
/*       */       try {
/*  8534 */         bname = tokens.nextToken().trim();
/*  8535 */         bname = LoginHandler.raiseFirstLetter(bname);
/*  8536 */         this.player.getLogger().log(Level.INFO, "Trying to ban player " + bname + '.');
/*       */       }
/*  8538 */       catch (Exception ex) {
/*       */ 
/*       */         
/*  8541 */         sendAlertServerMessage("Failed to ban the player. Make sure you use the syntax #ban <name> <days> <reason> like this: #ban Griefer 2 broke the rules. Error=" + ex
/*  8542 */             .getMessage());
/*       */ 
/*       */         
/*       */         return;
/*       */       } 
/*       */     } else {
/*  8548 */       sendAlertServerMessage("Failed to ban the player. Make sure you use the syntax #ban <name> <days> <reason> like this: #ban Griefer 2 broke the rules.");
/*       */       return;
/*       */     } 
/*  8551 */     if (tokens.hasMoreTokens()) {
/*       */ 
/*       */       
/*       */       try {
/*  8555 */         days = Integer.parseInt(tokens.nextToken().trim());
/*  8556 */         expiry = System.currentTimeMillis() + days * 86400000L;
/*  8557 */         if (days == 0) {
/*       */           
/*  8559 */           sendAlertServerMessage("Failed to ban the player - too few days. Make sure you use the syntax #ban <name> <days> <reason> like this: #ban Griefer 2 broke the rules.");
/*       */           
/*       */           return;
/*       */         } 
/*  8563 */       } catch (Exception ex) {
/*       */         
/*  8565 */         sendAlertServerMessage("Failed to ban the player. Make sure you use the syntax #ban <name> <days> <reason> like this: #ban Griefer 2 broke the rules. Error=" + ex
/*  8566 */             .getMessage());
/*       */ 
/*       */         
/*       */         return;
/*       */       } 
/*       */     } else {
/*  8572 */       sendAlertServerMessage("Failed to ban the player. Make sure you use the syntax #ban <name> <days> <reason> like this: #ban Griefer 2 broke the rules.");
/*       */       return;
/*       */     } 
/*  8575 */     if (tokens.hasMoreTokens()) {
/*       */ 
/*       */       
/*       */       try {
/*  8579 */         while (tokens.hasMoreTokens())
/*  8580 */           reason.append(tokens.nextToken()).append(' '); 
/*  8581 */         if (reason.length() < 4) {
/*       */           
/*  8583 */           sendAlertServerMessage("The reason " + reason + " seems a bit short. Please explain a bit more.");
/*       */ 
/*       */           
/*       */           return;
/*       */         } 
/*  8588 */       } catch (Exception ex) {
/*       */         
/*  8590 */         sendAlertServerMessage("Failed to ban the player. Make sure you use the syntax #ban <name> <days> <reason> like this: #ban Griefer 2 broke the rules. Error: " + ex
/*  8591 */             .getMessage());
/*       */ 
/*       */         
/*       */         return;
/*       */       } 
/*       */     } else {
/*  8597 */       sendAlertServerMessage("Failed to ban the player. Make sure you use the syntax #ban <name> <days> <reason> like this: #ban Griefer 2 broke the rules.");
/*       */       
/*       */       return;
/*       */     } 
/*       */     try {
/*  8602 */       Player toBan = Players.getInstance().getPlayer(bname);
/*  8603 */       if (toBan.getPower() >= power) {
/*       */         
/*  8605 */         sendNormalServerMessage("You cannot ban " + bname + '!');
/*  8606 */         toBan.getCommunicator().sendNormalServerMessage(this.player
/*  8607 */             .getName() + " tried to ban you from the game!");
/*       */         return;
/*       */       } 
/*  8610 */       if (toBan.hasLink()) {
/*       */         
/*  8612 */         String bip = toBan.getCommunicator().getConnection().getIp();
/*  8613 */         toBan.getCommunicator().sendAlertServerMessage("You have been banned for " + days + " days and thrown out from the game.");
/*       */ 
/*       */         
/*       */         try {
/*  8617 */           sendSafeServerMessage("You ban and kick " + bname + ". The server won't accept connections from " + bip + " anymore.");
/*       */           
/*  8619 */           logInfo(this.player.getName() + " bans player " + bname + " and ipaddress " + bip + " for " + days + " days.");
/*       */           
/*  8621 */           toBan.ban(reason.toString(), expiry);
/*       */ 
/*       */ 
/*       */ 
/*       */           
/*  8626 */           WcGlobalModeration wcgm = new WcGlobalModeration(WurmId.getNextWCCommandId(), this.player.getName(), (byte)this.player.getPower(), false, false, false, true, false, 0, days, bname, reason.toString());
/*  8627 */           if (Servers.localServer.LOGINSERVER) {
/*  8628 */             wcgm.sendFromLoginServer();
/*       */           } else {
/*  8630 */             wcgm.sendToLoginServer();
/*       */           } 
/*  8632 */           if (!message.startsWith("#banhere")) {
/*       */ 
/*       */             
/*       */             try {
/*  8636 */               LoginServerWebConnection c = new LoginServerWebConnection();
/*  8637 */               sendSafeServerMessage(c.ban(bname, reason.toString(), days));
/*       */             }
/*  8639 */             catch (Exception e) {
/*       */               
/*  8641 */               sendAlertServerMessage("Failed to ban on login server:" + e
/*  8642 */                   .getMessage());
/*  8643 */               logInfo(this.player.getName() + " banning " + bname + " on login server failed: " + e
/*  8644 */                   .getMessage(), e);
/*       */             } 
/*       */             
/*       */             try {
/*  8648 */               LoginServerWebConnection c = new LoginServerWebConnection();
/*  8649 */               sendSafeServerMessage(c.addBannedIp(bip, "[" + bname + "] " + reason, days));
/*       */             
/*       */             }
/*  8652 */             catch (Exception e) {
/*       */               
/*  8654 */               sendAlertServerMessage("Failed to ban on login server:" + e
/*  8655 */                   .getMessage());
/*  8656 */               logInfo(this.player.getName() + " banning ip on login server failed: " + e
/*  8657 */                   .getMessage(), e);
/*       */             } 
/*       */           } 
/*  8660 */           if (this.player.getLogger() != null) {
/*  8661 */             this.player.getLogger().log(Level.INFO, this.player
/*       */                 
/*  8663 */                 .getName() + " banned " + bname + " for " + days + " days. Reason: " + reason);
/*       */           }
/*       */         }
/*  8666 */         catch (Exception ex) {
/*       */           
/*  8668 */           logWarn("Error: " + this.player.getName() + " tries to ban player " + bname + " and ipaddress " + bip + " - " + ex
/*       */               
/*  8670 */               .getMessage(), ex);
/*  8671 */           sendAlertServerMessage("You try to ban and kick " + bname + ", but an error seems to have occured on the server.");
/*       */         }
/*       */       
/*       */       } else {
/*       */         
/*  8676 */         throw new NoSuchPlayerException("Just went offline.");
/*       */       } 
/*  8678 */     } catch (NoSuchPlayerException nsp) {
/*       */       
/*  8680 */       PlayerInfo pinf = PlayerInfoFactory.createPlayerInfo(bname);
/*       */       
/*       */       try {
/*  8683 */         pinf.load();
/*  8684 */         pinf.setBanned(true, reason.toString(), expiry);
/*  8685 */         String bip = pinf.getIpaddress();
/*  8686 */         Players.getInstance().addBannedIp(bip, "[" + bname + "] " + reason, expiry);
/*  8687 */         if (!message.startsWith("#banhere")) {
/*       */ 
/*       */           
/*       */           try {
/*  8691 */             LoginServerWebConnection c = new LoginServerWebConnection();
/*  8692 */             sendSafeServerMessage(c.ban(bname, reason.toString(), days));
/*       */           }
/*  8694 */           catch (Exception e) {
/*       */             
/*  8696 */             sendAlertServerMessage("Failed to ban on login server:" + e.getMessage());
/*  8697 */             logInfo(this.player.getName() + " banning " + bname + " on login server failed: " + e
/*  8698 */                 .getMessage(), e);
/*       */           } 
/*       */           
/*       */           try {
/*  8702 */             LoginServerWebConnection c = new LoginServerWebConnection();
/*  8703 */             sendSafeServerMessage(c.addBannedIp(bip, "[" + bname + "] " + reason, days));
/*       */           }
/*  8705 */           catch (Exception e) {
/*       */             
/*  8707 */             sendAlertServerMessage("Failed to ban on login server:" + e.getMessage());
/*  8708 */             logInfo(this.player.getName() + " banning ip on login server failed: " + e
/*  8709 */                 .getMessage(), e);
/*       */           } 
/*       */         } 
/*  8712 */         if (this.player.getLogger() != null) {
/*  8713 */           this.player.getLogger().log(Level.INFO, this.player
/*       */               
/*  8715 */               .getName() + " banned " + bname + " for " + days + " days. Reason: " + reason);
/*       */         }
/*  8717 */         sendSafeServerMessage("You ban " + bname + " for " + days + " days. The server won't accept connections from " + bip + " anymore.");
/*       */         
/*  8719 */         logInfo(this.player.getName() + " bans player " + bname + " and ipaddress " + bip + " for " + days + " days. Reason " + reason);
/*       */       
/*       */       }
/*  8722 */       catch (IOException iox) {
/*       */         
/*  8724 */         sendSafeServerMessage("Failed to locate player with the name " + bname + '.' + ". Banning globally.");
/*       */ 
/*       */ 
/*       */         
/*  8728 */         WcGlobalModeration wcgm = new WcGlobalModeration(WurmId.getNextWCCommandId(), this.player.getName(), (byte)this.player.getPower(), false, false, false, true, false, 0, days, bname, reason.toString());
/*  8729 */         if (Servers.localServer.LOGINSERVER) {
/*  8730 */           wcgm.sendFromLoginServer();
/*       */         } else {
/*  8732 */           wcgm.sendToLoginServer();
/*       */         } 
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageBan(String message, int power) {
/*  8743 */     if (power < 2)
/*       */       return; 
/*  8745 */     if (message.startsWith("#banip")) {
/*  8746 */       banIpImplementation(message, power);
/*  8747 */     } else if (message.startsWith("#bansteam")) {
/*  8748 */       banSteamIdImplementation(message, power);
/*       */     } else {
/*  8750 */       banPlayerImplementation(message, power);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageDevTalk(String message, int power) throws IOException {
/*  8760 */     if (power >= 3) {
/*       */       
/*  8762 */       StringTokenizer tokens = new StringTokenizer(message);
/*  8763 */       tokens.nextToken();
/*  8764 */       String bname = "";
/*       */       
/*       */       try {
/*  8767 */         bname = tokens.nextToken().trim();
/*  8768 */         bname = LoginHandler.raiseFirstLetter(bname);
/*       */       }
/*  8770 */       catch (Exception ex) {
/*       */         
/*  8772 */         sendNormalServerMessage("Syntax: #devtalk <name>. Error=" + ex.getMessage());
/*       */         
/*       */         return;
/*       */       } 
/*  8776 */       PlayerInfo pinf = null;
/*  8777 */       Player p = null;
/*       */       
/*       */       try {
/*  8780 */         p = Players.getInstance().getPlayer(bname);
/*  8781 */         pinf = p.getSaveFile();
/*       */       }
/*  8783 */       catch (NoSuchPlayerException nsp) {
/*       */         
/*  8785 */         pinf = PlayerInfoFactory.createPlayerInfo(bname);
/*  8786 */         pinf.load();
/*       */       } 
/*  8788 */       if (pinf.wurmId > 0L) {
/*       */         
/*  8790 */         if (pinf.mayHearDevTalk) {
/*       */           
/*  8792 */           pinf.setDevTalk(false);
/*       */           
/*  8794 */           sendSafeServerMessage(bname + " may no longer hear devtalk.");
/*  8795 */           if (p != null) {
/*  8796 */             p.getCommunicator().sendNormalServerMessage("You may no longer hear the deities chit-chat.");
/*       */           }
/*       */           
/*  8799 */           if (this.player.getLogger() != null) {
/*  8800 */             this.player.getLogger().log(Level.INFO, this.player
/*  8801 */                 .getName() + " removes " + bname + " from devtalk.");
/*       */           }
/*       */ 
/*       */           
/*  8805 */           WcDemotion wc = new WcDemotion(WurmId.getNextWCCommandId(), this.player.getWurmId(), pinf.wurmId, (short)3);
/*  8806 */           if (Servers.localServer.LOGINSERVER) {
/*  8807 */             wc.sendFromLoginServer();
/*       */           } else {
/*  8809 */             wc.sendToLoginServer();
/*       */           } 
/*       */         } else {
/*       */           
/*  8813 */           pinf.setDevTalk(true);
/*       */           
/*  8815 */           sendSafeServerMessage(bname + " may now hear devtalk.");
/*  8816 */           if (p != null) {
/*  8817 */             p.getCommunicator().sendNormalServerMessage("You may now listen to the wise words of the gods.");
/*       */           }
/*       */           
/*  8820 */           if (this.player.getLogger() != null) {
/*  8821 */             this.player.getLogger().log(Level.INFO, this.player
/*  8822 */                 .getName() + " adds " + bname + " to devtalk.");
/*       */           }
/*       */         } 
/*       */       } else {
/*  8826 */         sendSafeServerMessage("No player with the name " + bname + " exists on this server.");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageToggleArtist(String message, int power) throws IOException {
/*  8837 */     if (power >= 3) {
/*       */       
/*  8839 */       StringTokenizer tokens = new StringTokenizer(message);
/*  8840 */       tokens.nextToken();
/*  8841 */       String bname = "";
/*  8842 */       boolean ok = true;
/*       */       
/*       */       try {
/*  8845 */         bname = tokens.nextToken().trim();
/*  8846 */         bname = LoginHandler.raiseFirstLetter(bname);
/*       */       }
/*  8848 */       catch (Exception ex) {
/*       */         
/*  8850 */         sendNormalServerMessage("Syntax: #artist <name> <sound (true or false)> <graphics (true or false)> . Error=" + ex
/*  8851 */             .getMessage());
/*       */         return;
/*       */       } 
/*  8854 */       PlayerInfo pinf = null;
/*  8855 */       Player p = null;
/*       */       
/*       */       try {
/*  8858 */         p = Players.getInstance().getPlayer(bname);
/*  8859 */         pinf = p.getSaveFile();
/*       */       }
/*  8861 */       catch (NoSuchPlayerException nsp) {
/*       */         
/*  8863 */         pinf = PlayerInfoFactory.createPlayerInfo(bname);
/*  8864 */         pinf.load();
/*       */       } 
/*  8866 */       if (pinf.wurmId > 0L) {
/*       */         
/*  8868 */         if (tokens.hasMoreTokens()) {
/*       */           
/*  8870 */           String sound = tokens.nextToken();
/*  8871 */           boolean s = sound.equals("true");
/*  8872 */           if (tokens.hasMoreTokens()) {
/*       */             
/*  8874 */             String graphics = tokens.nextToken();
/*  8875 */             boolean g = graphics.equals("true");
/*  8876 */             if (g || s) {
/*       */               
/*  8878 */               Players.addArtist(pinf.wurmId, s, g);
/*  8879 */               sendSafeServerMessage(bname + " is now an artist sound=" + s + ", graphics=" + g + ".");
/*       */               
/*  8881 */               if (p != null) {
/*  8882 */                 p.getCommunicator().sendNormalServerMessage("You are now artist sound=" + s + ", graphics=" + g + ".");
/*       */               }
/*       */               
/*  8885 */               if (this.player.getLogger() != null) {
/*  8886 */                 this.player.getLogger().log(Level.INFO, this.player
/*       */                     
/*  8888 */                     .getName() + " sets " + bname + " artist " + s + "," + g + ".");
/*       */               }
/*       */             }
/*       */             else {
/*       */               
/*  8893 */               Players.deleteArtist(pinf.wurmId);
/*  8894 */               if (p != null) {
/*  8895 */                 p.getCommunicator().sendNormalServerMessage("You no longer have artist privileges.");
/*       */               }
/*       */               
/*  8898 */               sendSafeServerMessage(bname + " no longer has artist privileges.");
/*  8899 */               if (this.player.getLogger() != null) {
/*  8900 */                 this.player.getLogger().log(Level.INFO, this.player
/*       */                     
/*  8902 */                     .getName() + " sets " + bname + " artist " + bname + " sound=" + s + ", graphics=" + g + ".");
/*       */               }
/*       */             } 
/*       */           } else {
/*       */             
/*  8907 */             ok = false;
/*       */           } 
/*       */         } else {
/*  8910 */           ok = false;
/*       */         } 
/*       */       } else {
/*       */         
/*  8914 */         sendSafeServerMessage("No player with the name " + bname + " exists on this server.");
/*       */         return;
/*       */       } 
/*  8917 */       if (!ok) {
/*  8918 */         sendNormalServerMessage("Syntax: #artist <name> <sound (true or false)> <graphics (true or false)>.");
/*       */       }
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageChatColour(String message, int power) {
/*  8928 */     if (power >= 1 || this.player.mayMute())
/*       */     {
/*  8930 */       if (this.player.hasColoredChat) {
/*       */         
/*  8932 */         this.player.hasColoredChat = false;
/*  8933 */         this.player.customBlueChat = 0;
/*  8934 */         this.player.customGreenChat = 140;
/*  8935 */         this.player.customRedChat = 255;
/*  8936 */         sendNormalServerMessage("You now chat with the colours of the common man and your chat colours have been reset.");
/*       */       }
/*       */       else {
/*       */         
/*  8940 */         this.player.hasColoredChat = true;
/*  8941 */         StringTokenizer tokens = new StringTokenizer(message);
/*  8942 */         tokens.nextToken();
/*  8943 */         if (tokens.hasMoreTokens()) {
/*       */           
/*  8945 */           String nt = tokens.nextToken();
/*  8946 */           if (nt.contains(",")) {
/*       */             
/*  8948 */             String[] colours = nt.split(",");
/*  8949 */             if (colours.length != 3) {
/*       */               
/*  8951 */               sendNormalServerMessage("The value " + nt + " could not split into rgb values.");
/*       */               return;
/*       */             } 
/*  8954 */             int ired = Integer.parseInt(colours[0]);
/*  8955 */             int cred = Math.max(1, Math.min(255, ired));
/*  8956 */             int igreen = Integer.parseInt(colours[1]);
/*  8957 */             int cgreen = Math.max(1, Math.min(255, igreen));
/*  8958 */             int iblue = Integer.parseInt(colours[2]);
/*  8959 */             int cblue = Math.max(1, Math.min(255, iblue));
/*  8960 */             this.player.customRedChat = cred;
/*  8961 */             this.player.customGreenChat = cgreen;
/*  8962 */             this.player.customBlueChat = cblue;
/*       */           } else {
/*       */ 
/*       */             
/*       */             try {
/*       */               
/*  8968 */               int newColor = Integer.parseInt(nt);
/*  8969 */               this.player.customRedChat = newColor >> 16 & 0xFF;
/*  8970 */               this.player.customGreenChat = newColor >> 8 & 0xFF;
/*  8971 */               this.player.customBlueChat = newColor & 0xFF;
/*       */             }
/*  8973 */             catch (NumberFormatException nfe) {
/*       */               
/*  8975 */               sendNormalServerMessage("The value " + nt + " could not be parsed into an integer.");
/*       */               return;
/*       */             } 
/*       */           } 
/*       */         } 
/*  8980 */         sendNormalServerMessage("You now chat with some fancy colour.");
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageWarnings() {
/*  8990 */     long lastWarned = this.player.getSaveFile().getLastWarned();
/*  8991 */     String wst = this.player.getSaveFile().getWarningStats(lastWarned);
/*  8992 */     sendNormalServerMessage(wst);
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageToggleCommunityAssistant() {
/*  9000 */     if (System.currentTimeMillis() - this.lastToggledPA > 30000L || this.player.getPower() > 1) {
/*       */       
/*  9002 */       this.lastToggledPA = System.currentTimeMillis();
/*  9003 */       if (this.player.seesPlayerAssistantWindow())
/*       */       {
/*  9005 */         this.player.togglePlayerAssistantWindow(false);
/*  9006 */         sendNormalServerMessage("You will no longer receive CA messages.");
/*       */ 
/*       */       
/*       */       }
/*  9010 */       else if (Servers.localServer.HOMESERVER || Servers.localServer.EPIC)
/*       */       {
/*  9012 */         Players.getInstance().sendPAWindow(this.player);
/*  9013 */         this.player.togglePlayerAssistantWindow(true);
/*  9014 */         sendNormalServerMessage("You will now receive CA messages.");
/*       */       }
/*       */       else
/*       */       {
/*  9018 */         sendNormalServerMessage("Community assistants are not available on this server. Please ask the other players instead or use /support if you need help from the game administrators.");
/*       */       }
/*       */     
/*       */     } else {
/*       */       
/*  9023 */       sendNormalServerMessage("You can only toggle this twice per minute.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageTransfer() {
/*  9031 */     if (this.player.hasFlag(74)) {
/*       */       
/*  9033 */       sendNormalServerMessage("You do not currently have a free transfer of faith available.");
/*       */       return;
/*       */     } 
/*  9036 */     if (this.player.isChampion()) {
/*       */       
/*  9038 */       sendNormalServerMessage("Champions cannot convert faith with this command.");
/*       */       return;
/*       */     } 
/*  9041 */     if (this.player.getDeity() != null) {
/*       */       
/*  9043 */       TransferQuestion tq = new TransferQuestion((Creature)this.player, "Free transfer to a new faith", "Do you wish to receive a free transfer?");
/*       */       
/*  9045 */       tq.sendQuestion();
/*       */     }
/*       */     else {
/*       */       
/*  9049 */       sendNormalServerMessage("You do not currently have a deity to transfer away from.");
/*       */       return;
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageStopCaring() {
/*  9059 */     int nums = Creatures.getInstance().setNoCreaturesProtectedBy(this.player.getWurmId());
/*  9060 */     if (nums == 0)
/*  9061 */       sendNormalServerMessage("You didn't care specially for any creature."); 
/*  9062 */     if (nums == 1) {
/*  9063 */       sendNormalServerMessage("You no longer care for the one creature you used to.");
/*       */     } else {
/*  9065 */       sendNormalServerMessage("You no longer care for any of the " + nums + " creatures you used to.");
/*       */     } 
/*       */   }
/*       */   
/*       */   private void handleMessageShowCaringFor() {
/*  9070 */     Creature[] creatures = Creatures.getInstance().getProtectedCreaturesFor(this.player.getWurmId());
/*  9071 */     if (creatures.length > 0) {
/*       */       
/*  9073 */       StringBuilder buf = new StringBuilder();
/*  9074 */       buf.append("You are caring for:");
/*  9075 */       boolean first = true;
/*  9076 */       for (Creature creature : creatures) {
/*       */         
/*  9078 */         if (first) {
/*  9079 */           first = false;
/*       */         } else {
/*  9081 */           buf.append(",");
/*  9082 */         }  buf.append("  " + creature.getNameWithoutPrefixes());
/*       */       } 
/*  9084 */       sendNormalServerMessage(buf.toString());
/*       */     } else {
/*       */       
/*  9087 */       sendNormalServerMessage("You are not caring for any creatures.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageSnipe(String message) throws IOException {
/*  9096 */     StringTokenizer tokens = new StringTokenizer(message);
/*  9097 */     tokens.nextToken();
/*  9098 */     String pname = "x";
/*  9099 */     if (tokens.hasMoreTokens()) {
/*       */       
/*  9101 */       pname = tokens.nextToken().trim();
/*  9102 */       pname = LoginHandler.raiseFirstLetter(pname);
/*       */     } 
/*  9104 */     if (!pname.equals("x")) {
/*       */       
/*  9106 */       boolean muteGlobal = false;
/*  9107 */       PlayerInfo pinf = PlayerInfoFactory.createPlayerInfo(pname);
/*       */       
/*       */       try {
/*  9110 */         pinf.load();
/*  9111 */         if (pinf.getCurrentServer() == Servers.localServer.id) {
/*       */           
/*  9113 */           attemptMuting(this.player, pinf, false, false);
/*       */         } else {
/*       */           
/*  9116 */           muteGlobal = true;
/*       */         } 
/*  9118 */       } catch (IOException iox) {
/*       */ 
/*       */ 
/*       */         
/*  9122 */         muteGlobal = true;
/*       */       } 
/*  9124 */       if (muteGlobal) {
/*       */         
/*  9126 */         sendNormalServerMessage("Trying to snipe " + pname + " globally.");
/*  9127 */         attemptMuting(this.player, pinf, true, false);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageIgnore(String message) throws IOException {
/*  9138 */     StringTokenizer tokens = new StringTokenizer(message);
/*  9139 */     tokens.nextToken();
/*  9140 */     String pname = "x";
/*  9141 */     if (tokens.hasMoreTokens()) {
/*       */       
/*  9143 */       pname = tokens.nextToken().trim();
/*  9144 */       pname = LoginHandler.raiseFirstLetter(pname);
/*       */     } 
/*  9146 */     if (!pname.equals("x")) {
/*       */       
/*  9148 */       PlayerState pstate = PlayerInfoFactory.getPlayerState(pname);
/*  9149 */       if (pstate == null) {
/*       */         
/*  9151 */         sendNormalServerMessage("Unknown player " + pname + '.');
/*       */         
/*       */         return;
/*       */       } 
/*  9155 */       long pid = pstate.getPlayerId();
/*  9156 */       boolean muteGlobal = false;
/*  9157 */       PlayerInfo pinf = PlayerInfoFactory.createPlayerInfo(pname);
/*       */ 
/*       */       
/*       */       try {
/*  9161 */         if (this.player.isIgnored(pid)) {
/*       */ 
/*       */           
/*  9164 */           if (pstate.getServerId() == Servers.localServer.id) {
/*       */             
/*  9166 */             if (this.player.removeIgnored(pid)) {
/*  9167 */               sendNormalServerMessage("You no longer ignore " + pname + '.');
/*       */             } else {
/*  9169 */               sendNormalServerMessage("The server failed to execute your remove ignore request.");
/*       */             
/*       */             }
/*       */           
/*       */           }
/*       */           else {
/*       */             
/*  9176 */             WcGlobalIgnore wgi = new WcGlobalIgnore(WurmId.getNextWCCommandId(), this.player.getWurmId(), this.player.getName(), pid, pname, false, false, false, false, true, this.player.getKingdomId());
/*  9177 */             if (Servers.isThisLoginServer()) {
/*  9178 */               wgi.sendToServer(pstate.getServerId());
/*       */             } else {
/*  9180 */               wgi.sendToLoginServer();
/*       */             } 
/*       */           } 
/*  9183 */         } else if (pstate.getServerId() == Servers.localServer.id) {
/*       */           
/*  9185 */           pinf.load();
/*  9186 */           if (pinf.getPower() > 1 || pinf.mayMute) {
/*       */             
/*  9188 */             sendNormalServerMessage("You may not ignore " + pname + '.');
/*       */           }
/*  9190 */           else if (this.player.addIgnored(pid)) {
/*       */             
/*  9192 */             sendNormalServerMessage("You now ignore " + pname + '.');
/*  9193 */             attemptMuting(this.player, pinf, false, true);
/*       */           } else {
/*       */             
/*  9196 */             sendNormalServerMessage("The server failed to execute your ignore request.");
/*       */           } 
/*       */         } else {
/*  9199 */           muteGlobal = true;
/*       */         } 
/*  9201 */       } catch (IOException iox) {
/*       */ 
/*       */         
/*  9204 */         muteGlobal = true;
/*       */       } 
/*  9206 */       if (muteGlobal)
/*       */       {
/*       */         
/*  9209 */         attemptMuting(this.player, pinf, true, true);
/*       */       }
/*       */     }
/*       */     else {
/*       */       
/*  9214 */       long[] ids = this.player.getIgnored();
/*  9215 */       String nlist = "You are ignoring ";
/*  9216 */       for (int x = 0; x < ids.length; x++) {
/*       */         
/*  9218 */         PlayerState pstate = PlayerInfoFactory.getPlayerState(ids[x]);
/*  9219 */         String next = "unknown?";
/*  9220 */         if (pstate != null)
/*  9221 */           next = pstate.getPlayerName(); 
/*  9222 */         if (x == ids.length - 1) {
/*  9223 */           nlist = nlist + next;
/*  9224 */         } else if (x == ids.length - 2) {
/*  9225 */           nlist = nlist + next + " and ";
/*       */         } else {
/*  9227 */           nlist = nlist + next + ", ";
/*       */         } 
/*  9229 */         if (next.equals("unknown?")) {
/*       */           
/*  9231 */           this.player.removeIgnored(ids[x]);
/*  9232 */           sendNormalServerMessage("Deleted player detected, removing them from your ignored players list. Please execute command again to confirm they are gone.");
/*       */         } 
/*       */       } 
/*       */ 
/*       */       
/*  9237 */       if (ids.length == 0)
/*  9238 */         nlist = nlist + "nobody"; 
/*  9239 */       nlist = nlist + '.';
/*  9240 */       sendNormalServerMessage(nlist);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageChangePassword(String message) throws Exception {
/*  9250 */     StringTokenizer tokens = new StringTokenizer(message);
/*  9251 */     if (tokens.countTokens() == 3) {
/*       */       
/*  9253 */       tokens.nextToken();
/*  9254 */       String oldpassword = "Unknown";
/*  9255 */       oldpassword = tokens.nextToken().trim();
/*  9256 */       String newpassword = "Unknown2";
/*  9257 */       newpassword = tokens.nextToken().trim();
/*  9258 */       if (LoginHandler.hashPassword(oldpassword, LoginHandler.encrypt(LoginHandler.raiseFirstLetter(this.player.getSaveFile().getName()))).equals(this.player
/*  9259 */           .getSaveFile().getPassword())) {
/*       */         
/*  9261 */         if (newpassword.length() >= 6 && newpassword.length() <= 20) {
/*       */           
/*  9263 */           LoginServerWebConnection lsw = new LoginServerWebConnection();
/*  9264 */           sendNormalServerMessage(lsw.changePassword(this.player.getName(), this.player.getName(), newpassword, this.player
/*  9265 */                 .getPower()));
/*       */         } else {
/*       */           
/*  9268 */           sendNormalServerMessage("The password must be between 6 and 20 characters long.");
/*       */         } 
/*       */       } else {
/*  9271 */         sendNormalServerMessage("The old password you submitted is not correct.");
/*       */       } 
/*       */     } else {
/*  9274 */       sendNormalServerMessage("The syntax to change the password is '/password <oldpassword> <newpassword>', nothing else.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageToggleInvitations() {
/*  9282 */     if (this.player.acceptsInvitations()) {
/*       */       
/*  9284 */       this.player.acceptsInvitations = false;
/*  9285 */       sendNormalServerMessage("You will no longer accept invitations to change kingdom or religion.");
/*       */     }
/*       */     else {
/*       */       
/*  9289 */       if (this.player.isUndead()) {
/*       */         
/*  9291 */         sendNormalServerMessage("Urrr. Urrr.. Nooo..");
/*       */         return;
/*       */       } 
/*  9294 */       this.player.acceptsInvitations = true;
/*  9295 */       sendNormalServerMessage("You will now accept invitations to change kingdom and religion.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageReputation() {
/*  9304 */     int rep = this.player.getReputation();
/*  9305 */     sendNormalServerMessage("Your reputation is " + rep + '.');
/*  9306 */     if (this.player.getKingdomTemplateId() != 3)
/*       */     {
/*  9308 */       if (rep > 20) {
/*  9309 */         sendNormalServerMessage("You raise no suspicion.");
/*  9310 */       } else if (rep >= 0) {
/*  9311 */         sendNormalServerMessage("You are close to becoming an outlaw, which would mean that other players can kill you on sight.");
/*  9312 */       } else if (rep > -80) {
/*  9313 */         sendNormalServerMessage("You are an outlaw, and may be killed on sight by other players.");
/*  9314 */       } else if (rep >= -100) {
/*  9315 */         sendNormalServerMessage("You are an outlaw, and may be killed on sight by other players. Soon the kingdom guards will start to attack you.");
/*  9316 */       } else if (rep > -180) {
/*  9317 */         sendNormalServerMessage("You are an outlaw. Other players and the kingdom guards will attack you on sight.");
/*  9318 */       } else if (rep >= -200) {
/*       */         
/*  9320 */         sendNormalServerMessage("You are an outlaw. Other players and kingdom guards may attack you on sight.");
/*  9321 */         sendAlertServerMessage("You are very close to joining the Horde of The Summoned!");
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageLogoutTime() {
/*  9331 */     sendSafeServerMessage("You would leave the world in " + this.player.getSecondsToLogout() + " seconds if you disconnected now.");
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageBattleRank() {
/*  9340 */     sendNormalServerMessage("Your current battle rank is " + this.player.getRank() + '.');
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageMaxBattleRanks() {
/*  9364 */     sendNormalServerMessage("Historic Battle Masters:");
/*  9365 */     Map<String, Integer> map = Players.getMaxBattleRanks(10);
/*  9366 */     for (Iterator<Map.Entry<String, Integer>> it = map.entrySet().iterator(); it.hasNext(); ) {
/*       */       
/*  9368 */       Map.Entry<String, Integer> entry = it.next();
/*  9369 */       sendNormalServerMessage((String)entry.getKey() + ' ' + ((Integer)entry.getValue()).intValue());
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageBattleRanks() {
/*  9378 */     sendNormalServerMessage("Current Battle Masters:");
/*  9379 */     Map<String, Integer> map = Players.getBattleRanks(10);
/*  9380 */     for (Iterator<Map.Entry<String, Integer>> it = map.entrySet().iterator(); it.hasNext(); ) {
/*       */       
/*  9382 */       Map.Entry<String, Integer> entry = it.next();
/*  9383 */       sendNormalServerMessage((String)entry.getKey() + ' ' + ((Integer)entry.getValue()).intValue());
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageChampRanks() {
/*  9392 */     sendSafeServerMessage("Current Eternal Records:");
/*  9393 */     WurmRecord[] allRecs = PlayerInfoFactory.getChampionRecords();
/*       */     
/*  9395 */     for (WurmRecord record : allRecs) {
/*       */       
/*  9397 */       if (record.isCurrent())
/*  9398 */         sendNormalServerMessage(record.getHolder() + ' ' + record.getValue()); 
/*       */     } 
/*  9400 */     sendSafeServerMessage("Older Eternal Records:");
/*  9401 */     for (WurmRecord record : allRecs) {
/*       */       
/*  9403 */       if (!record.isCurrent()) {
/*  9404 */         sendNormalServerMessage(record.getHolder() + ' ' + record.getValue());
/*       */       }
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageReleaseCorpses() {
/*  9413 */     Zones.releaseAllCorpsesFor((Creature)this.player);
/*  9414 */     sendNormalServerMessage("Your corpses may now be looted by anyone.");
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageTestChallengeShutdown() {
/*  9422 */     Players.getInstance().setChallengeStep(Players.getInstance().getChallengeStep() + 1);
/*  9423 */     if (Players.getInstance().getChallengeStep() > 4) {
/*  9424 */       Players.getInstance().setChallengeStep(0);
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageRandomNumber(String message) {
/*  9432 */     StringTokenizer tokens = new StringTokenizer(message);
/*  9433 */     tokens.nextToken();
/*  9434 */     int rand = 100;
/*  9435 */     if (tokens.hasMoreTokens()) {
/*       */       
/*  9437 */       String numo = tokens.nextToken().trim();
/*       */       
/*       */       try {
/*  9440 */         rand = Integer.parseInt(numo);
/*       */       }
/*  9442 */       catch (NumberFormatException numberFormatException) {}
/*       */     } 
/*       */ 
/*       */ 
/*       */     
/*  9447 */     rand = Math.min(10000000, rand);
/*  9448 */     rand = Math.max(2, rand);
/*  9449 */     this.player.getCurrentTile().broadCast(this.player
/*  9450 */         .getName() + " rolls " + (Server.rand.nextInt(rand) + 1) + "/" + rand + ".");
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageRemoveFriend(String message) throws IOException {
/*  9459 */     StringTokenizer tokens = new StringTokenizer(message);
/*  9460 */     tokens.nextToken();
/*  9461 */     if (!tokens.hasMoreTokens()) {
/*       */       
/*  9463 */       sendAlertServerMessage("You must specify a player to remove!");
/*       */     }
/*       */     else {
/*       */       
/*  9467 */       String friendName = tokens.nextToken().trim();
/*  9468 */       friendName = LoginHandler.raiseFirstLetter(friendName);
/*  9469 */       long friendWurmId = this.player.removeFriend(friendName);
/*  9470 */       this.player.removeMeFromFriendsList(friendWurmId, friendName);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageRevokeVillage(String message) {
/*  9479 */     if (message.equals("/revoke")) {
/*  9480 */       sendNormalServerMessage("As a safety measure you have to type your village name as part of the command: revoke <villagename>");
/*  9481 */     } else if (this.player.citizenVillage != null) {
/*       */       
/*  9483 */       String vname = message.substring("/revoke ".length(), message.length());
/*  9484 */       vname = vname.toLowerCase();
/*  9485 */       if (vname.equals(this.player.citizenVillage.getName().toLowerCase())) {
/*       */         
/*  9487 */         Citizen cz = this.player.citizenVillage.getCitizen(this.player.getWurmId());
/*  9488 */         VillageRole role = cz.getRole();
/*  9489 */         if (role.getStatus() == 2) {
/*  9490 */           sendNormalServerMessage("You cannot revoke the citizenship of the mayor this way. You have to give away the village deed.");
/*       */         } else {
/*  9492 */           this.player.citizenVillage.removeCitizen(cz);
/*       */         } 
/*       */       } else {
/*  9495 */         sendNormalServerMessage("You may not revoke your citizenship in the village of '" + vname + "' since you are a citizen of '" + this.player.citizenVillage
/*  9496 */             .getName().toLowerCase() + "'.");
/*       */       } 
/*       */     } else {
/*       */       
/*  9500 */       sendNormalServerMessage("You are not citizen of a village and therefor may not revoke your citizenship in it.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageChallengeKing() {
/*  9508 */     if (this.player.isKing())
/*       */     {
/*  9510 */       MethodsCreatures.sendChallengeKingQuestion((Creature)this.player);
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageToggleSleep() {
/*  9519 */     if (this.player.getSaveFile().getSleepLeft() <= 0) {
/*       */       
/*  9521 */       sendNormalServerMessage("You do not have any sleep bonus. You can gain some by eating a sleep powder or sleeping in a bed.");
/*       */ 
/*       */ 
/*       */     
/*       */     }
/*       */     else {
/*       */ 
/*       */ 
/*       */ 
/*       */       
/*  9531 */       if ((this.player.getSaveFile()).frozenSleep && System.currentTimeMillis() - (this.player.getSaveFile()).lastToggledFSleep < 300000L) {
/*  9532 */         sendNormalServerMessage("You need to wait " + 
/*  9533 */             Server.getTimeFor((this.player.getSaveFile()).lastToggledFSleep + 300000L - 
/*  9534 */               System.currentTimeMillis()) + " until you can toggle sleep bonus again.");
/*  9535 */       } else if ((this.player.getSaveFile()).frozenSleep) {
/*       */         
/*  9537 */         (this.player.getSaveFile()).lastToggledFSleep = System.currentTimeMillis();
/*  9538 */         (this.player.getSaveFile()).frozenSleep = false;
/*  9539 */         sendNormalServerMessage("You start using your sleep bonus.");
/*  9540 */         if (this.player.isSBIdleOffEnabled())
/*       */         {
/*  9542 */           sendNormalServerMessage("Your sleep bonus will auto-freeze after " + 
/*  9543 */               Server.getTimeFor(600000L) + " of inactivity.");
/*       */         }
/*       */         
/*  9546 */         this.player.resetInactivity(true);
/*       */       }
/*       */       else {
/*       */         
/*  9550 */         (this.player.getSaveFile()).frozenSleep = true;
/*  9551 */         sendNormalServerMessage("You refrain from using your sleep bonus.");
/*       */       } 
/*  9553 */       sendSleepInfo();
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageMissionInformation() {
/*  9562 */     sendNormalServerMessage("Current instruction:");
/*  9563 */     SimplePopup popup = new SimplePopup((Creature)this.player, "Current mission", this.player.getCurrentMissionInstruction());
/*  9564 */     popup.sendQuestion();
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageHelp() {
/*  9573 */     sendHelp();
/*  9574 */     if (this.player.getPower() >= 1)
/*       */     {
/*  9576 */       sendDeityHelp(this.player.getPower());
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageVote(String message) {
/*  9585 */     StringTokenizer tokens = new StringTokenizer(message);
/*  9586 */     tokens.nextToken();
/*  9587 */     String pname = "Unknown";
/*  9588 */     pname = tokens.nextToken().trim();
/*  9589 */     pname = LoginHandler.raiseFirstLetter(pname);
/*       */     
/*       */     try {
/*  9592 */       Village vill = this.player.getCitizenVillage();
/*  9593 */       if (vill != null) {
/*  9594 */         vill.vote((Creature)this.player, pname);
/*       */       } else {
/*  9596 */         sendSafeServerMessage("You are not citizen of a village, hence you cannot vote!");
/*       */       } 
/*  9598 */     } catch (IOException iox) {
/*       */       
/*  9600 */       sendSafeServerMessage("Failed to vote for " + pname + ". An error occured on the server.");
/*  9601 */       logWarn(iox.getMessage(), iox);
/*       */     }
/*  9603 */     catch (NoSuchPlayerException nsp) {
/*       */       
/*  9605 */       sendSafeServerMessage("Failed to vote for " + pname + ". Please verify that the name is correct.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageUptime() {
/*  9615 */     sendNormalServerMessage("The server has been up " + 
/*  9616 */         Server.getTimeFor(System.currentTimeMillis() - Server.getStartTime()) + '.');
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageTitleSelect() {
/*  9624 */     if (Features.Feature.COMPOUND_TITLES.isEnabled()) {
/*       */ 
/*       */       
/*  9627 */       TitleCompoundQuestion tcq = new TitleCompoundQuestion((Creature)this.player, "Select your titles", "Which titles do you want to use?", this.player.getWurmId());
/*  9628 */       tcq.sendQuestion();
/*       */     
/*       */     }
/*       */     else {
/*       */       
/*  9633 */       TitleQuestion tq = new TitleQuestion((Creature)this.player, "Select your title", "Which title do you want to use?", this.player.getWurmId());
/*  9634 */       tq.sendQuestion();
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageSleepBonus() {
/*  9643 */     if (!this.player.hasSleepBonus()) {
/*       */       
/*  9645 */       if ((this.player.getSaveFile()).sleep > 0 && (this.player.getSaveFile()).frozenSleep) {
/*  9646 */         sendNormalServerMessage("You have " + Server.getTimeFor(((this.player.getSaveFile()).sleep * 1000)) + " left of your sleep bonus, which is frozen.");
/*       */       } else {
/*       */         
/*  9649 */         sendNormalServerMessage("You have no bonus from sleep.");
/*       */       } 
/*       */     } else {
/*  9652 */       sendNormalServerMessage("You have " + Server.getTimeFor(((this.player.getSaveFile()).sleep * 1000)) + " left of your sleep bonus.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageTitle() {
/*  9661 */     String suff = "";
/*  9662 */     if (this.player.isKing()) {
/*  9663 */       suff = suff + " [" + King.getRulerTitle((this.player.getSex() == 0), this.player.getKingdomId()) + ']';
/*       */     }
/*       */     
/*  9666 */     Titles.Title tempTitle = this.player.getTitle();
/*  9667 */     if (tempTitle != null)
/*       */     {
/*  9669 */       if (tempTitle.isRoyalTitle()) {
/*  9670 */         suff = suff + " [" + this.player.getKingdomTitle() + ']';
/*       */       } else {
/*  9672 */         suff = suff + " [" + tempTitle.getName(this.player.isNotFemale()) + ']';
/*       */       } 
/*       */     }
/*  9675 */     if (Features.Feature.COMPOUND_TITLES.isEnabled()) {
/*       */       
/*  9677 */       Titles.Title tempSecondTitle = this.player.getSecondTitle();
/*  9678 */       if (tempSecondTitle != null)
/*       */       {
/*  9680 */         if (tempSecondTitle.isRoyalTitle()) {
/*  9681 */           suff = suff + " [" + this.player.getKingdomTitle() + ']';
/*       */         } else {
/*  9683 */           suff = suff + " [" + tempSecondTitle.getName(this.player.isNotFemale()) + ']';
/*       */         } 
/*       */       }
/*       */     } 
/*  9687 */     if (this.player.isChampion())
/*  9688 */       suff = suff + " [Champion of " + (this.player.getDeity()).name + ']'; 
/*  9689 */     if (this.player.getTitle() == null) {
/*  9690 */       sendNormalServerMessage("You are currently using no title.");
/*       */     } else {
/*       */       
/*  9693 */       sendNormalServerMessage("You are currently using the titles " + suff + '.');
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageLives() {
/*  9702 */     if (this.player.isChampion()) {
/*       */       
/*  9704 */       if ((this.player.getSaveFile()).realdeath - 1 == 0) {
/*  9705 */         sendAlertServerMessage("The next time you return from the underworld you will no longer be a Champion.");
/*       */       } else {
/*  9707 */         sendNormalServerMessage("You may visit the underworld as a Champion " + 
/*  9708 */             (this.player.getSaveFile()).realdeath + " times more.");
/*       */       } 
/*       */       
/*  9711 */       if (System.currentTimeMillis() - (this.player.getSaveFile()).championTimeStamp < 14515200000L) {
/*       */         
/*  9713 */         String timefor = Server.getTimeFor(14515200000L + this.player
/*  9714 */             .getChampTimeStamp() - System.currentTimeMillis());
/*  9715 */         sendNormalServerMessage("You will stay champion for " + timefor + ".");
/*       */       } else {
/*       */         
/*  9718 */         sendNormalServerMessage("You may become champion whenever you meet the prerequisites.");
/*       */ 
/*       */       
/*       */       }
/*       */ 
/*       */ 
/*       */     
/*       */     }
/*       */     else {
/*       */ 
/*       */       
/*  9729 */       sendNormalServerMessage("You are not the Champion of a deity.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageConverts() {
/*  9737 */     sendNormalServerMessage("You have changed kingdom " + this.player.getSaveFile().getChangedKingdom() + " times.");
/*       */     
/*  9739 */     if (Servers.localServer.isChallengeServer() && this.player.getPower() <= 0) {
/*       */       
/*  9741 */       sendNormalServerMessage("You may not change kingdom on this server.");
/*       */       return;
/*       */     } 
/*  9744 */     if (System.currentTimeMillis() - (this.player.getSaveFile()).lastChangedKindom < this.player
/*  9745 */       .getChangeKingdomLimit()) {
/*       */       
/*  9747 */       String timefor = Server.getTimeFor(this.player.getChangeKingdomLimit() + 
/*  9748 */           (this.player.getSaveFile()).lastChangedKindom - System.currentTimeMillis());
/*  9749 */       sendNormalServerMessage("You may change kingdom in " + timefor + ".");
/*       */     } else {
/*       */       
/*  9752 */       sendNormalServerMessage("You may change kingdom now.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageGoMolRehan() {
/*  9760 */     sendNormalServerMessage("This command is no longer active.");
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageChangeEmail(String message) throws IOException {
/*  9769 */     if (System.currentTimeMillis() - this.lastChangedEmail > 30000L || Servers.localServer.testServer) {
/*       */       
/*  9771 */       ChangeEmailQuestion ceq = new ChangeEmailQuestion((Creature)this.player);
/*  9772 */       ceq.sendQuestion();
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/*  9818 */       this.lastChangedEmail = System.currentTimeMillis();
/*       */     } else {
/*       */       
/*  9821 */       sendNormalServerMessage("You may only change email twice per minute. Please wait a while.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageStuck() throws NoSuchZoneException {
/*  9829 */     if (this.player.isDead()) {
/*       */       
/*  9831 */       sendNormalServerMessage("You are dead.");
/*       */ 
/*       */     
/*       */     }
/*  9835 */     else if (this.player.isTeleporting() || this.player.getMovementScheme().isIntraTeleporting()) {
/*       */       
/*  9837 */       sendNormalServerMessage("You are teleporting and cannot use this command.");
/*       */     }
/*  9839 */     else if (this.player.stuckCounter > 0) {
/*       */       
/*  9841 */       sendNormalServerMessage("Try again in " + this.player.stuckCounter + " second/s.");
/*       */     }
/*  9843 */     else if (this.player.getVehicle() != -10L) {
/*       */       
/*  9845 */       sendNormalServerMessage("You must disembark first.");
/*       */     }
/*  9847 */     else if (this.player.getLayer() < 0) {
/*       */       
/*  9849 */       sendNormalServerMessage("Stuck does not work below ground. You need to use /suicide instead.");
/*       */     }
/*  9851 */     else if (this.player.isFighting()) {
/*       */       
/*  9853 */       sendNormalServerMessage("You cannot do this while you're in combat!");
/*       */     }
/*       */     else {
/*       */       
/*  9857 */       int tilex = (this.player.getCurrentTile()).tilex;
/*  9858 */       int tiley = (this.player.getCurrentTile()).tiley;
/*       */       
/*       */       try {
/*  9861 */         float tHeight = Zones.calculateHeight(this.player.getPosX(), this.player.getPosY(), this.player.isOnSurface());
/*  9862 */         if (this.player.getPositionZ() - 0.5F > tHeight) {
/*       */           
/*  9864 */           sendNormalServerMessage("You need to be firmly on the ground.");
/*       */           
/*       */           return;
/*       */         } 
/*  9868 */       } catch (Exception ex) {
/*       */         
/*  9870 */         sendNormalServerMessage("You are in a bad place. You need to use /suicide instead.");
/*       */         return;
/*       */       } 
/*  9873 */       short[] heights = Creature.getTileSteepness(tilex, tiley, this.player.isOnSurface());
/*  9874 */       if (heights[1] > 50) {
/*       */         
/*  9876 */         sendNormalServerMessage("This area is too steep to jump in. Try relogging and worst case use /suicide instead.");
/*       */       }
/*       */       else {
/*       */         
/*  9880 */         boolean ok = true;
/*  9881 */         for (int x = 0; x < 10; x++) {
/*       */           
/*  9883 */           float posx = (tilex * 4 + 1 + Server.rand.nextInt(2));
/*  9884 */           float posy = (tiley * 4 + 1 + Server.rand.nextInt(2));
/*       */           
/*  9886 */           VolaTile t = Zones.getTileOrNull((int)posx >> 2, (int)posy >> 2, this.player.isOnSurface());
/*  9887 */           if (t != null) {
/*       */             
/*  9889 */             Structure struct = t.getStructure();
/*  9890 */             if (struct != null && struct.isFinished()) {
/*       */               
/*  9892 */               ok = false;
/*  9893 */               Item[] keys = this.player.getKeys();
/*  9894 */               for (Item lKey : keys) {
/*       */                 
/*  9896 */                 if (lKey.getWurmId() == struct.getWritId())
/*  9897 */                   ok = true; 
/*       */               } 
/*  9899 */               if (struct.mayPass((Creature)this.player))
/*  9900 */                 ok = true; 
/*       */             } 
/*       */           } 
/*  9903 */           if (ok) {
/*       */             
/*  9905 */             this.player.intraTeleport(posx, posy, Zones.calculateHeight(posx, posy, this.player
/*  9906 */                   .isOnSurface()), this.player.getStatus().getRotation(), this.player
/*  9907 */                 .getLayer(), "Stuck");
/*  9908 */             this.player.stuckCounter = 30;
/*       */             break;
/*       */           } 
/*       */         } 
/*  9912 */         if (!ok) {
/*  9913 */           sendNormalServerMessage("Failed to locate a proper place to teleport to. You may have to use /suicide or relog instead.");
/*       */         }
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageWeather() {
/*  9924 */     sendNormalServerMessage(Server.getWeather().getWeatherString((this.player.getPower() >= 3)));
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageAttackers() {
/*  9932 */     long[] attids = this.player.getLatestAttackers();
/*  9933 */     sendNormalServerMessage("Latest attackers:");
/*  9934 */     if (attids.length == 0) {
/*  9935 */       sendNormalServerMessage("None.");
/*       */     } else {
/*       */       
/*  9938 */       for (int x = 0; x < attids.length; x++) {
/*       */ 
/*       */         
/*       */         try {
/*  9942 */           Creature cret = Server.getInstance().getCreature(attids[x]);
/*  9943 */           sendNormalServerMessage(cret.getName());
/*       */         }
/*  9945 */         catch (NoSuchPlayerException noSuchPlayerException) {
/*       */ 
/*       */         
/*       */         }
/*  9949 */         catch (NoSuchCreatureException noSuchCreatureException) {}
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageRespawn() {
/*  9962 */     if (this.player.isDead()) {
/*       */       
/*  9964 */       this.player.sendSpawnQuestion();
/*       */     } else {
/*       */       
/*  9967 */       sendNormalServerMessage("You are not dead yet.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageWho() {
/*  9975 */     LoginHandler.sendWho(this.player, false);
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageSendTestLetter(String mess) {
/*  9983 */     StringTokenizer t = new StringTokenizer(mess);
/*  9984 */     t.nextToken();
/*  9985 */     if (t.hasMoreTokens()) {
/*       */       
/*  9987 */       String num = t.nextToken();
/*       */       
/*       */       try {
/*  9990 */         int number = Integer.parseInt(num);
/*  9991 */         if (number == 1)
/*  9992 */           PlayerInfoFactory.sendDeleteLetter(this.player.getSaveFile()); 
/*  9993 */         if (number == 2)
/*  9994 */           PlayerInfoFactory.sendDeletePreventLetter(this.player.getSaveFile()); 
/*  9995 */         if (number == 3) {
/*  9996 */           PlayerInfoFactory.sendPremiumWarningLetter(this.player.getSaveFile());
/*       */         }
/*  9998 */       } catch (Exception ex) {
/*       */         
/* 10000 */         sendAlertServerMessage(ex.getMessage());
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageTimePlayed() {
/* 10011 */     Item inventory = this.player.getInventory();
/* 10012 */     if (inventory != null)
/*       */     {
/* 10014 */       sendNormalServerMessage("You entered through the portal to Wurm on " + 
/* 10015 */           WurmCalendar.getDateFor(inventory.creationDate) + " That's " + 
/* 10016 */           Server.getTimeFor(System.currentTimeMillis() - (this.player.getSaveFile()).creationDate) + " ago.");
/*       */     }
/* 10018 */     long timePlayed = this.player.getPlayingTime();
/* 10019 */     short days = (short)(int)(timePlayed / 86400000L);
/* 10020 */     long millsoverdays = timePlayed % 86400000L;
/* 10021 */     short hours = (short)(int)(millsoverdays / 3600000L);
/* 10022 */     long minsmillis = millsoverdays % 3600000L;
/* 10023 */     short minutes = (short)(int)(minsmillis / 60000L);
/* 10024 */     sendNormalServerMessage("You have played " + days + " days, " + hours + " hours and " + minutes + " minutes.");
/*       */     
/* 10026 */     if ((this.player.getSaveFile()).awards != null) {
/*       */       
/* 10028 */       sendNormalServerMessage("You have been premium a total of " + (this.player.getSaveFile()).awards.getMonthsPaidEver() + " months until Dec 2013.");
/*       */       
/* 10030 */       sendNormalServerMessage("You have been premium a total of " + (this.player.getSaveFile()).awards.getMonthsPaidSinceReset() + " months since Dec 2013.");
/*       */       
/* 10032 */       sendNormalServerMessage("You have been premium consecutively for " + 
/* 10033 */           (this.player.getSaveFile()).awards.getMonthsPaidInARow() + " months since Dec 2013.");
/*       */     } 
/* 10035 */     if (this.player.isReallyPaying()) {
/*       */       
/* 10037 */       sendNormalServerMessage("You have premium time until " + 
/* 10038 */           WurmCalendar.formatGmt(this.player.getPaymentExpire()));
/*       */     } else {
/*       */       
/* 10041 */       sendNormalServerMessage("You have not paid for premium time.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageFatigue() {
/* 10049 */     int time = this.player.getFatigueLeft();
/* 10050 */     time *= 1000;
/* 10051 */     String t = Server.getTimeFor(time);
/* 10052 */     sendNormalServerMessage("You have " + t + " left.");
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageSignInOut(String message) {
/* 10068 */     if (this.player.canSignIn()) {
/*       */       
/* 10070 */       StringTokenizer tokens = new StringTokenizer(message);
/* 10071 */       String inout = tokens.nextToken();
/* 10072 */       String msg = "";
/* 10073 */       while (tokens.hasMoreTokens()) {
/* 10074 */         msg = msg + ' ' + tokens.nextToken();
/*       */       }
/* 10076 */       if (inout.equals("/signin")) {
/*       */         
/* 10078 */         if (this.player.isSignedIn())
/*       */         {
/* 10080 */           sendNormalServerMessage("You are already signed in.");
/*       */         }
/*       */         else
/*       */         {
/* 10084 */           signIn(msg);
/* 10085 */           sendNormalServerMessage("You are now signed in.");
/*       */         }
/*       */       
/* 10088 */       } else if (inout.equals("/signout")) {
/*       */         
/* 10090 */         if (!this.player.isSignedIn()) {
/*       */           
/* 10092 */           sendNormalServerMessage("You are already signed out.");
/*       */         }
/*       */         else {
/*       */           
/* 10096 */           signOut(msg);
/* 10097 */           sendNormalServerMessage("You are now signed out.");
/*       */         } 
/*       */       } else {
/*       */         
/* 10101 */         sendNormalServerMessage("unknown command " + inout);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void signIn(String aMsg) {
/* 10112 */     signInOut(true, "Signing in. " + aMsg);
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void signOut(String aMsg) {
/* 10122 */     signInOut(false, "Signing out. " + aMsg);
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void signInOut(boolean inOut, String msg) {
/* 10133 */     if (inOut && this.player.isSignedIn()) {
/*       */ 
/*       */ 
/*       */       
/* 10137 */       if (this.player.getPower() < 2) {
/* 10138 */         sendMGMTMessage(msg, true);
/*       */       }
/* 10140 */     } else if (this.player.isTransferring()) {
/*       */ 
/*       */ 
/*       */       
/* 10144 */       if (this.player.getPower() < 2) {
/* 10145 */         sendMGMTMessage(msg, true);
/*       */       }
/*       */     } else {
/*       */       
/* 10149 */       this.player.setSignedIn(inOut);
/*       */       
/* 10151 */       if (this.player.mayHearDevTalk()) {
/* 10152 */         sendGMMessage(msg, true);
/*       */       }
/* 10154 */       if (this.player.getPower() < 2) {
/* 10155 */         sendMGMTMessage(msg, true);
/*       */       }
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageGameMasterChat(String message) {
/* 10164 */     if (!this.player.isMute())
/*       */     {
/* 10166 */       if (this.player.mayHearMgmtTalk() && this.player.mayMute()) {
/*       */         
/* 10168 */         StringTokenizer tokens = new StringTokenizer(message);
/* 10169 */         tokens.nextToken();
/* 10170 */         String toSend = "";
/* 10171 */         if (tokens.hasMoreTokens())
/* 10172 */           toSend = tokens.nextToken(); 
/* 10173 */         while (tokens.hasMoreTokens())
/* 10174 */           toSend = toSend + ' ' + tokens.nextToken(); 
/* 10175 */         Message mess = sendGMMessage(toSend, false);
/* 10176 */         if (!this.player.mayHearDevTalk()) {
/* 10177 */           sendMessage(mess);
/*       */         }
/*       */       } else {
/* 10180 */         sendNormalServerMessage("You may not use that channel.");
/*       */       } 
/*       */     }
/*       */   }
/*       */   
/*       */   private Message sendGMMessage(String msg, boolean addPlayerType) {
/* 10186 */     Message mess = new Message((Creature)this.player, (byte)11, "GM", "<" + getPlayerName(addPlayerType) + "> " + msg);
/*       */ 
/*       */     
/* 10189 */     Server.getInstance().addMessage(mess);
/* 10190 */     Players.addGmMessage(getPlayerName(addPlayerType), msg);
/* 10191 */     if (msg.trim().length() > 1) {
/*       */ 
/*       */       
/* 10194 */       WCGmMessage wc = new WCGmMessage(WurmId.getNextWCCommandId(), getPlayerName(addPlayerType), "(" + Servers.localServer.getAbbreviation() + ") " + msg, false);
/* 10195 */       if (Servers.localServer.LOGINSERVER) {
/* 10196 */         wc.sendFromLoginServer();
/*       */       } else {
/* 10198 */         wc.sendToLoginServer();
/*       */       } 
/* 10200 */     }  return mess;
/*       */   }
/*       */ 
/*       */   
/*       */   private String getPlayerName(boolean addPlayerType) {
/* 10205 */     if (!addPlayerType)
/* 10206 */       return this.player.getName(); 
/* 10207 */     if (this.player.getPower() == 2)
/* 10208 */       return "GM " + this.player.getName(); 
/* 10209 */     if (this.player.getPower() == 4)
/* 10210 */       return "ARCH " + this.player.getName(); 
/* 10211 */     if (this.player.getPower() > 2)
/* 10212 */       return "GOD " + this.player.getName(); 
/* 10213 */     if (this.player.mayMute())
/* 10214 */       return "CM " + this.player.getName(); 
/* 10215 */     if (this.player.isPlayerAssistant())
/* 10216 */       return "CA " + this.player.getName(); 
/* 10217 */     return this.player.getName();
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageShout(String message) {
/* 10225 */     if (!this.player.isMute())
/*       */     {
/* 10227 */       if (this.player.isKingdomChat()) {
/*       */         
/* 10229 */         if (this.invulnerable)
/*       */         {
/* 10231 */           sendAlertServerMessage("You may not use kingdom chat until you have moved and lost invulnerability.");
/*       */         }
/*       */         else
/*       */         {
/* 10235 */           StringTokenizer tokens = new StringTokenizer(message);
/* 10236 */           tokens.nextToken();
/* 10237 */           String toSend = "";
/* 10238 */           if (tokens.hasMoreTokens())
/* 10239 */             toSend = tokens.nextToken(); 
/* 10240 */           while (tokens.hasMoreTokens())
/* 10241 */             toSend = toSend + ' ' + tokens.nextToken(); 
/* 10242 */           toSend = drunkGarble(toSend);
/* 10243 */           sendToLocalKingdomChat(toSend);
/*       */         }
/*       */       
/* 10246 */       } else if (!this.player.isUndead()) {
/* 10247 */         sendNormalServerMessage("You must toggle Kingdom chat on your profile.");
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendToLocalKingdomChat(String message) {
/* 10255 */     Message mess = new Message((Creature)this.player, (byte)10, Kingdoms.getChatNameFor(this.player.getKingdomId()), "<" + this.player.getName() + "> " + message);
/* 10256 */     if (message.trim().length() > 1) {
/*       */       
/* 10258 */       Server.getInstance().addMessage(mess);
/* 10259 */       this.player.chatted();
/*       */     }
/*       */     else {
/*       */       
/* 10263 */       sendMessage(mess);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageKingdomChat(String message) {
/* 10271 */     if (gchatdisabled) {
/*       */       
/* 10273 */       sendNormalServerMessage("Global chat is currently disabled on this server.");
/*       */     }
/* 10275 */     else if (!this.player.isMute()) {
/*       */       
/* 10277 */       if (this.player.isGlobalChat()) {
/*       */         
/* 10279 */         if (Servers.localServer.entryServer && !this.player.isReallyPaying() && !this.player.mayMute())
/*       */         {
/* 10281 */           sendNormalServerMessage("You may not use global kingdom chat as a non-premium until you use a portal.");
/*       */         }
/* 10283 */         else if (this.invulnerable)
/*       */         {
/* 10285 */           sendAlertServerMessage("You may not use global kingdom chat until you have moved and lost invulnerability.");
/*       */         }
/*       */         else
/*       */         {
/* 10289 */           StringTokenizer tokens = new StringTokenizer(message);
/* 10290 */           tokens.nextToken();
/* 10291 */           String toSend = "";
/* 10292 */           if (tokens.hasMoreTokens())
/* 10293 */             toSend = tokens.nextToken(); 
/* 10294 */           while (tokens.hasMoreTokens()) {
/* 10295 */             toSend = toSend + ' ' + tokens.nextToken();
/*       */           }
/* 10297 */           toSend = drunkGarble(toSend);
/*       */           
/* 10299 */           sendToGlobalKingdomChat(toSend);
/* 10300 */           this.player.chatted();
/*       */         }
/*       */       
/* 10303 */       } else if (!this.player.isUndead()) {
/* 10304 */         sendNormalServerMessage("You must toggle global Kingdom chat on your profile.");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendToGlobalKingdomChat(String message) {
/* 10311 */     Message mess = new Message((Creature)this.player, (byte)16, "GL-" + Kingdoms.getChatNameFor(this.player.getKingdomId()), "<" + this.player.getName() + "> " + message);
/*       */     
/* 10313 */     mess.setSenderKingdom(this.player.getKingdomId());
/* 10314 */     if (message.trim().length() > 1) {
/*       */       
/* 10316 */       Server.getInstance().addMessage(mess);
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 10321 */       WcKingdomChat wc = new WcKingdomChat(WurmId.getNextWCCommandId(), this.player.getWurmId(), this.player.getName(), message, false, this.player.getKingdomId(), this.player.hasColoredChat() ? this.player.getCustomRedChat() : -1, this.player.hasColoredChat() ? this.player.getCustomGreenChat() : -1, this.player.hasColoredChat() ? this.player.getCustomBlueChat() : -1);
/* 10322 */       if (Servers.localServer.LOGINSERVER) {
/* 10323 */         wc.sendFromLoginServer();
/*       */       } else {
/* 10325 */         wc.sendToLoginServer();
/*       */       } 
/*       */     } else {
/*       */       
/* 10329 */       sendMessage(mess);
/*       */     } 
/*       */   }
/*       */   
/*       */   public void sendToTradeChannel(String message) {
/* 10334 */     Message mess = new Message((Creature)this.player, (byte)18, "Trade", "<" + this.player.getName() + "> " + message);
/*       */     
/* 10336 */     mess.setSenderKingdom(this.player.getKingdomId());
/*       */     
/* 10338 */     sendMessage(mess);
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageOpenChat(String message) {
/* 10347 */     if (!this.player.isMute()) {
/*       */       
/* 10349 */       StringTokenizer tokens = new StringTokenizer(message);
/* 10350 */       tokens.nextToken();
/* 10351 */       String chat = "";
/*       */       
/* 10353 */       if (tokens.hasMoreTokens()) {
/* 10354 */         chat = tokens.nextToken();
/*       */       }
/* 10356 */       if (chat.toLowerCase().startsWith("k")) {
/*       */         
/* 10358 */         if (this.player.isKingdomChat()) {
/* 10359 */           sendToLocalKingdomChat("");
/*       */         } else {
/* 10361 */           sendNormalServerMessage("Need to enable kingdom chat in profile before opening it.");
/*       */         } 
/* 10363 */       } else if (chat.toLowerCase().startsWith("g")) {
/*       */         
/* 10365 */         if (this.player.isGlobalChat()) {
/* 10366 */           sendToGlobalKingdomChat("");
/*       */         } else {
/* 10368 */           sendNormalServerMessage("Need to enable global kingdom chat in profile before opening it.");
/*       */         } 
/* 10370 */       } else if (chat.toLowerCase().startsWith("t")) {
/*       */         
/* 10372 */         if (this.player.isTradeChannel()) {
/* 10373 */           sendToTradeChannel("");
/*       */         } else {
/* 10375 */           sendNormalServerMessage("Need to enable Trade channel in profile before opening it.");
/*       */         } 
/*       */       } else {
/* 10378 */         sendNormalServerMessage("Unknown chat channel. Use k, g or t as parameter.");
/* 10379 */       }  this.player.chatted();
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageSuicide() {
/* 10388 */     if (System.currentTimeMillis() - this.player.lastSuicide < 60000L * (this.player.isUndead() ? 10L : 3L)) {
/*       */       
/* 10390 */       sendNormalServerMessage("You suicided recently. You have to wait a few minutes between each attempt.");
/*       */     }
/* 10392 */     else if (this.player.isDead()) {
/* 10393 */       sendNormalServerMessage("You are already dead. Use /respawn if you want a respawn window.");
/* 10394 */     } else if (this.player.isTeleporting()) {
/* 10395 */       sendAlertServerMessage("You are too confused to kill yourself right now.");
/* 10396 */     } else if (this.player.getBattle() != null) {
/* 10397 */       sendAlertServerMessage("You are too full of adrenaline from the battle to kill yourself right now.");
/*       */ 
/*       */ 
/*       */     
/*       */     }
/* 10402 */     else if ((this.player.getSaveFile()).realdeath > 2) {
/*       */       
/* 10404 */       sendAlertServerMessage("You cannot force yourself to suicide this time.");
/*       */     
/*       */     }
/*       */     else {
/*       */       
/* 10409 */       SuicideQuestion s = new SuicideQuestion((Creature)this.player, "Suicidal?", "Do you wish to commit suicide?", this.player.getWurmId());
/* 10410 */       s.sendQuestion();
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageFightLevel() {
/* 10425 */     if (this.player.fightlevel > 0) {
/* 10426 */       sendCombatNormalMessage(this.player.getFightlevelString());
/*       */     } else {
/* 10428 */       sendNormalServerMessage("You are not focused on combat.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageSupportChat(String message) {
/* 10436 */     if (!this.player.isMute()) {
/*       */       
/* 10438 */       StringTokenizer tokens = new StringTokenizer(message);
/* 10439 */       tokens.nextToken();
/* 10440 */       String toSend = "";
/* 10441 */       if (tokens.hasMoreTokens())
/* 10442 */         toSend = tokens.nextToken(); 
/* 10443 */       while (tokens.hasMoreTokens())
/* 10444 */         toSend = toSend + ' ' + tokens.nextToken(); 
/* 10445 */       Message mess = sendMGMTMessage(toSend, false);
/* 10446 */       if (!this.player.mayHearMgmtTalk()) {
/* 10447 */         sendMessage(mess);
/*       */       }
/*       */     } 
/*       */   }
/*       */   
/*       */   private Message sendMGMTMessage(String msg, boolean addPlayerType) {
/* 10453 */     Message mess = new Message((Creature)this.player, (byte)9, "MGMT", "<" + getPlayerName(addPlayerType) + "> " + msg);
/*       */     
/* 10455 */     Server.getInstance().addMessage(mess);
/*       */     
/* 10457 */     return mess;
/*       */   }
/*       */ 
/*       */   
/*       */   public void remindToSignIn() {
/* 10462 */     String msg = "You can Sign In using /signin with an optional message which will be appended to the default of Signing in.";
/* 10463 */     Message mess = new Message((Creature)this.player, (byte)0, ":Local", "<System> You can Sign In using /signin with an optional message which will be appended to the default of Signing in.");
/*       */     
/* 10465 */     mess.setColorR(250);
/* 10466 */     mess.setColorG(150);
/* 10467 */     mess.setColorB(250);
/* 10468 */     sendMessage(mess);
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageTweet(String message) {
/* 10476 */     if (!this.player.isDead()) {
/*       */       
/* 10478 */       Village lVillage = this.player.getCitizenVillage();
/* 10479 */       if (lVillage == null) {
/* 10480 */         sendNormalServerMessage("You are not the citizen of a village or homestead.");
/*       */       } else {
/*       */         
/* 10483 */         StringTokenizer tokens = new StringTokenizer(message);
/* 10484 */         tokens.nextToken();
/* 10485 */         String toSend = "";
/* 10486 */         if (tokens.hasMoreTokens()) {
/*       */           
/* 10488 */           toSend = tokens.nextToken();
/* 10489 */           while (tokens.hasMoreTokens())
/* 10490 */             toSend = toSend + ' ' + tokens.nextToken(); 
/* 10491 */           toSend = drunkGarble(toSend);
/* 10492 */           lVillage.broadCastMessage(new Message((Creature)this.player, (byte)3, "Village", "<" + this.player
/* 10493 */                 .getName() + "> " + toSend), true);
/*       */         }
/*       */         else {
/*       */           
/* 10497 */           sendNormalServerMessage("You need to /tweet something!");
/*       */         } 
/*       */       } 
/*       */     } else {
/* 10501 */       sendNormalServerMessage("Nobody can hear you now.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageAllianceChat(String message) {
/* 10509 */     if (!this.player.isDead()) {
/*       */       
/* 10511 */       if (this.player.isMute()) {
/*       */         
/* 10513 */         sendNormalServerMessage("You are muted.");
/*       */       }
/*       */       else {
/*       */         
/* 10517 */         Village lVillage = this.player.getCitizenVillage();
/* 10518 */         if (lVillage == null || lVillage.getAllianceNumber() == 0) {
/* 10519 */           sendNormalServerMessage("You are not in an alliance.");
/*       */         } else {
/*       */           
/* 10522 */           PvPAlliance pvpAlliance = PvPAlliance.getPvPAlliance(lVillage.getAllianceNumber());
/* 10523 */           if (pvpAlliance != null) {
/*       */             
/* 10525 */             StringTokenizer tokens = new StringTokenizer(message);
/* 10526 */             tokens.nextToken();
/* 10527 */             String toSend = "";
/* 10528 */             if (tokens.hasMoreTokens())
/* 10529 */               toSend = tokens.nextToken(); 
/* 10530 */             while (tokens.hasMoreTokens())
/* 10531 */               toSend = toSend + ' ' + tokens.nextToken(); 
/* 10532 */             toSend = drunkGarble(toSend);
/* 10533 */             pvpAlliance.broadCastMessage(new Message((Creature)this.player, (byte)15, "Alliance", "<" + this.player
/* 10534 */                   .getName() + "> " + toSend));
/*       */           } 
/*       */         } 
/*       */       } 
/*       */     } else {
/*       */       
/* 10540 */       sendNormalServerMessage("Nobody can hear you now.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleInGameVoting() {
/* 10553 */     InGameVoteQuestion igvq = new InGameVoteQuestion((Creature)this.player);
/* 10554 */     igvq.sendQuestion();
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleCreatureDump(int power) {
/* 10560 */     if (power == 5) {
/*       */       
/* 10562 */       Thread thread = new Thread("saveCreatureDistributionAsImg-Thread")
/*       */         {
/*       */           
/*       */           public void run()
/*       */           {
/* 10567 */             ZonesUtility.saveCreatureDistributionAsImg(Server.surfaceMesh);
/*       */           }
/*       */         };
/* 10570 */       thread.start();
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleMarkerDump(int power) {
/* 10576 */     if (power == 5) {
/*       */       
/* 10578 */       Thread thread = new Thread("saveMapWithMarkersAsImg-Thread")
/*       */         {
/*       */           
/*       */           public void run()
/*       */           {
/* 10583 */             ZonesUtility.saveMapWithMarkersAsImg();
/*       */           }
/*       */         };
/* 10586 */       thread.start();
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleRouteDump(int power) {
/* 10592 */     if (power == 5) {
/*       */       
/* 10594 */       Thread thread = new Thread("saveRoutesAsImg-Thread")
/*       */         {
/*       */           
/*       */           public void run()
/*       */           {
/* 10599 */             ZonesUtility.saveRoutesAsImg();
/*       */           }
/*       */         };
/* 10602 */       thread.start();
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleWaterDump(int power, final boolean onSurface) {
/* 10608 */     if (power == 5) {
/*       */       
/* 10610 */       Thread thread = new Thread("saveWaterAsImg-Thread")
/*       */         {
/*       */           
/*       */           public void run()
/*       */           {
/* 10615 */             ZonesUtility.saveWaterTypesAsImg(onSurface);
/*       */           }
/*       */         };
/* 10618 */       thread.start();
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleSkillProgress(int power) {
/* 10624 */     if (power > 1) {
/*       */       
/* 10626 */       SkillProgressQuestion spq = new SkillProgressQuestion((Creature)this.player);
/* 10627 */       spq.sendQuestion();
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleDumpFishSpots(int power) {
/* 10637 */     if (power == 5) {
/*       */       
/* 10639 */       Thread thread = new Thread("saveFishSpotsAsImg-Thread")
/*       */         {
/*       */           
/*       */           public void run()
/*       */           {
/* 10644 */             ZonesUtility.saveFishSpots(Server.surfaceMesh);
/*       */           }
/*       */         };
/* 10647 */       thread.start();
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleShowFishSpots(int power) {
/* 10653 */     if (power == 5)
/*       */     {
/* 10655 */       if (this.player != null && this.player.hasLink()) {
/*       */         
/*       */         try {
/*       */           
/* 10659 */           ByteBuffer bb = this.connection.getBuffer();
/* 10660 */           bb.put((byte)-64);
/* 10661 */           bb.put((byte)45);
/* 10662 */           for (byte season = 0; season < 4; season = (byte)(season + 1)) {
/*       */             
/* 10664 */             Color bgColour = MethodsFishing.getBgColour(season);
/* 10665 */             bb.put((byte)bgColour.getRed());
/* 10666 */             bb.put((byte)bgColour.getGreen());
/* 10667 */             bb.put((byte)bgColour.getBlue());
/* 10668 */             Point offset = MethodsFishing.getSeasonOffset(season);
/* 10669 */             bb.putInt(offset.getX());
/* 10670 */             bb.putInt(offset.getY());
/*       */             
/* 10672 */             Point[] spots = MethodsFishing.getSpecialSpots(0, 0, season);
/* 10673 */             bb.put((byte)spots.length);
/* 10674 */             for (Point spot : spots) {
/*       */               
/* 10676 */               bb.putInt(spot.getX());
/* 10677 */               bb.putInt(spot.getY());
/* 10678 */               Color fishColour = MethodsFishing.getFishColour(spot.getH());
/* 10679 */               bb.put((byte)fishColour.getRed());
/* 10680 */               bb.put((byte)fishColour.getGreen());
/* 10681 */               bb.put((byte)fishColour.getBlue());
/*       */             } 
/*       */           } 
/* 10684 */           this.connection.flush();
/*       */         }
/* 10686 */         catch (Exception ex) {
/*       */           
/* 10688 */           logInfo(this.player.getName() + " could not send data for showing fish spots due to " + ex.getMessage(), ex);
/* 10689 */           this.player.setLink(false);
/*       */         } 
/*       */       }
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleMapDump(int power) {
/* 10697 */     if (power == 5) {
/*       */       
/* 10699 */       Thread thread = new Thread("saveMapDumpAsImg-Thread")
/*       */         {
/*       */           
/*       */           public void run()
/*       */           {
/* 10704 */             ZonesUtility.saveMapDump(Server.surfaceMesh);
/*       */           }
/*       */         };
/* 10707 */       thread.start();
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleVillageTeleportMessage(String message) {
/* 10713 */     if (!this.player.isDead()) {
/*       */       
/* 10715 */       if (!this.player.canUseFreeVillageTeleport()) {
/*       */         
/* 10717 */         sendNormalServerMessage("You have no free teleports left.");
/*       */         
/*       */         return;
/*       */       } 
/* 10721 */       Village invitingVillage = this.player.getCitizenVillage();
/* 10722 */       if (invitingVillage == null) {
/*       */         
/* 10724 */         sendNormalServerMessage("You are not part of a village.");
/*       */         
/*       */         return;
/*       */       } 
/* 10728 */       VillageTeleportQuestion vtq = new VillageTeleportQuestion((Creature)this.player);
/* 10729 */       vtq.sendQuestion();
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleJoinVillageMessage(String message) {
/* 10735 */     if (this.player.isDead()) {
/*       */       
/* 10737 */       sendNormalServerMessage("You need to be alive to join a village.");
/*       */       
/*       */       return;
/*       */     } 
/* 10741 */     StringTokenizer tokens = new StringTokenizer(message);
/* 10742 */     tokens.nextToken();
/* 10743 */     if (!tokens.hasMoreTokens()) {
/*       */       
/* 10745 */       sendNormalServerMessage("The message must be in either of the following formats:");
/* 10746 */       sendNormalServerMessage("/join village <villagename>");
/* 10747 */       sendNormalServerMessage("/join player <playername>");
/*       */       
/*       */       return;
/*       */     } 
/* 10751 */     String type = tokens.nextToken();
/*       */     
/* 10753 */     if (!type.toLowerCase().equals("village") && !type.toLowerCase().equals("player")) {
/*       */       
/* 10755 */       sendNormalServerMessage("The message must be in either of the following formats:");
/* 10756 */       sendNormalServerMessage("/join village <villagename>");
/* 10757 */       sendNormalServerMessage("/join player <playername>");
/*       */       
/*       */       return;
/*       */     } 
/* 10761 */     if (!tokens.hasMoreTokens()) {
/*       */       
/* 10763 */       sendNormalServerMessage("You must specify which village or player you want to join.");
/*       */       
/*       */       return;
/*       */     } 
/* 10767 */     String toJoin = tokens.nextToken();
/*       */     
/* 10769 */     boolean joinByPlayer = type.toLowerCase().equals("player");
/* 10770 */     if (joinByPlayer) {
/*       */       
/* 10772 */       PlayerInfo info = PlayerInfoFactory.getPlayerInfoWithName(toJoin);
/* 10773 */       if (info == null) {
/*       */         
/* 10775 */         sendNormalServerMessage("There is no player by that name.");
/*       */         return;
/*       */       } 
/* 10778 */       Village vill = Villages.getVillageForCreature(info.getPlayerId());
/* 10779 */       if (vill == null) {
/*       */         
/* 10781 */         sendNormalServerMessage("Unable to find a village for a player with that name: " + toJoin);
/*       */         
/*       */         return;
/*       */       } 
/* 10785 */       vill.joinVillage(this.player);
/*       */     
/*       */     }
/*       */     else {
/*       */ 
/*       */       
/* 10791 */       while (tokens.hasMoreTokens())
/*       */       {
/* 10793 */         toJoin = toJoin + " " + tokens.nextToken();
/*       */       }
/*       */       
/*       */       try {
/* 10797 */         Village vill = Villages.getVillage(toJoin);
/* 10798 */         vill.joinVillage(this.player);
/*       */       }
/* 10800 */       catch (NoSuchVillageException e) {
/*       */ 
/*       */         
/* 10803 */         logWarn(e.getMessage(), (Throwable)e);
/* 10804 */         sendNormalServerMessage("Unable to find a village with that name: " + toJoin);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleListRecruites() {
/* 10812 */     if (this.player.isDead()) {
/*       */       
/* 10814 */       sendNormalServerMessage("You need to be alive to show the recruit list");
/*       */       
/*       */       return;
/*       */     } 
/* 10818 */     Village vill = this.player.getCitizenVillage();
/* 10819 */     if (vill == null) {
/*       */       
/* 10821 */       sendNormalServerMessage("You are not a member of any village");
/*       */       
/*       */       return;
/*       */     } 
/* 10825 */     Citizen citizen = vill.getCitizen(this.player.getWurmId());
/* 10826 */     if (citizen == null) {
/*       */       
/* 10828 */       sendNormalServerMessage("You are not a citizen of a village.");
/*       */       return;
/*       */     } 
/* 10831 */     VillageRecruitee[] recruits = vill.getRecruitees();
/* 10832 */     if (recruits.length == 0) {
/*       */       
/* 10834 */       sendNormalServerMessage("You have no recruits on the list.");
/*       */       
/*       */       return;
/*       */     } 
/*       */     
/* 10839 */     for (int i = 0; i < recruits.length; i++)
/*       */     {
/* 10841 */       sendNormalServerMessage(recruits[i].getRecruiteeName());
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleUnRecruiteMessage(String message) {
/* 10848 */     if (this.player.isDead()) {
/*       */       
/* 10850 */       sendNormalServerMessage("You need to be alive to alter the recruit list");
/*       */       
/*       */       return;
/*       */     } 
/* 10854 */     Village vill = this.player.getCitizenVillage();
/* 10855 */     if (vill == null) {
/*       */       
/* 10857 */       sendNormalServerMessage("You are not a member of any village");
/*       */       
/*       */       return;
/*       */     } 
/* 10861 */     Citizen citizen = vill.getCitizen(this.player.getWurmId());
/* 10862 */     if (citizen == null) {
/*       */       
/* 10864 */       sendNormalServerMessage("You are not a citizen of a village.");
/*       */       
/*       */       return;
/*       */     } 
/* 10868 */     if (!citizen.getRole().mayInviteCitizens()) {
/*       */       
/* 10870 */       sendNormalServerMessage("You are not allowed to invite or uninvite players to your village.");
/*       */       
/*       */       return;
/*       */     } 
/* 10874 */     StringTokenizer tokens = new StringTokenizer(message);
/* 10875 */     tokens.nextToken();
/* 10876 */     if (!tokens.hasMoreTokens()) {
/*       */       
/* 10878 */       sendNormalServerMessage("You must include the name of the player you want to remove from the list.");
/*       */       
/*       */       return;
/*       */     } 
/* 10882 */     String name = tokens.nextToken();
/* 10883 */     long pid = -10L;
/*       */     
/* 10885 */     pid = Players.getInstance().getWurmIdByPlayerName(name);
/* 10886 */     if (pid == -1L) {
/*       */       
/* 10888 */       sendNormalServerMessage("Unable to find a player by that name: " + name);
/*       */       
/*       */       return;
/*       */     } 
/* 10892 */     if (vill.removeRecruitee(pid))
/*       */     {
/* 10894 */       sendNormalServerMessage("Removed " + name + " from the recruiting list.");
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleRecruitMessage(String message) {
/* 10901 */     if (this.player.isDead()) {
/*       */       
/* 10903 */       sendNormalServerMessage("You need to be alive to alter the recruit list");
/*       */       
/*       */       return;
/*       */     } 
/* 10907 */     Village vill = this.player.getCitizenVillage();
/* 10908 */     if (vill == null) {
/*       */       
/* 10910 */       sendNormalServerMessage("You are not a member of any village");
/*       */       
/*       */       return;
/*       */     } 
/* 10914 */     Citizen citizen = vill.getCitizen(this.player.getWurmId());
/* 10915 */     if (citizen == null) {
/*       */       
/* 10917 */       sendNormalServerMessage("You are not a citizen of a village.");
/*       */       
/*       */       return;
/*       */     } 
/* 10921 */     if (!citizen.getRole().mayInviteCitizens()) {
/*       */       
/* 10923 */       sendNormalServerMessage("You are not allowed to invite players to your village.");
/*       */       
/*       */       return;
/*       */     } 
/* 10927 */     if (!Servers.localServer.challengeServer)
/*       */     {
/* 10929 */       if (this.player.getSaveFile().getPaymentExpire() <= 0L && citizen.getRole().getStatus() == 2) {
/*       */         
/* 10931 */         sendNormalServerMessage("You are not allowed to invite players to your settlement. Since you were never a premium player your account may be deleted and the settlement may end up without mayor.");
/*       */         
/*       */         return;
/*       */       } 
/*       */     }
/* 10936 */     StringTokenizer tokens = new StringTokenizer(message);
/* 10937 */     tokens.nextToken();
/* 10938 */     if (!tokens.hasMoreTokens()) {
/*       */       
/* 10940 */       sendNormalServerMessage("You must include the name of the player you want to add to the list.");
/*       */ 
/*       */       
/*       */       return;
/*       */     } 
/*       */     
/* 10946 */     String name = tokens.nextToken();
/* 10947 */     long pid = -10L;
/*       */     
/* 10949 */     pid = Players.getInstance().getWurmIdByPlayerName(name);
/* 10950 */     if (pid == -1L) {
/*       */       
/* 10952 */       sendNormalServerMessage("Unable to find a player by that name: " + name);
/*       */       
/*       */       return;
/*       */     } 
/* 10956 */     if (Players.getInstance().getKingdomForPlayer(pid) != this.player.getKingdomId()) {
/*       */       
/* 10958 */       sendNormalServerMessage(name + " is not the same kingdom as you.");
/*       */       
/*       */       return;
/*       */     } 
/*       */     
/* 10963 */     if (vill.addVillageRecruitee(name, pid)) {
/* 10964 */       sendNormalServerMessage("Added player " + name + " to the list.");
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleVillageInviteMessage(String message) {
/* 10970 */     if (!this.player.isDead()) {
/*       */       
/* 10972 */       StringTokenizer tokens = new StringTokenizer(message);
/* 10973 */       tokens.nextToken();
/* 10974 */       if (!tokens.hasMoreTokens()) {
/*       */         
/* 10976 */         String[] parts = message.split(" ");
/* 10977 */         if (parts.length > 0) {
/*       */           
/* 10979 */           String rm = StringUtil.format("You must include the name of the player you want to invite, %s <name>.", new Object[] { parts[0] });
/*       */ 
/*       */           
/* 10982 */           sendNormalServerMessage(rm);
/*       */         }
/*       */         else {
/*       */           
/* 10986 */           String m = "You must include the name of the player you want to invite, /vinvite <name>.";
/* 10987 */           sendNormalServerMessage("You must include the name of the player you want to invite, /vinvite <name>.");
/*       */         } 
/*       */         return;
/*       */       } 
/* 10991 */       String toInvite = tokens.nextToken();
/* 10992 */       Village invitingVillage = this.player.getCitizenVillage();
/* 10993 */       if (invitingVillage == null) {
/*       */         
/* 10995 */         sendNormalServerMessage("You are not part of a village.");
/*       */         return;
/*       */       } 
/* 10998 */       Citizen citizen = invitingVillage.getCitizen(this.player.getWurmId());
/* 10999 */       if (citizen == null) {
/*       */         
/* 11001 */         sendNormalServerMessage("You are not a citizen of a village.");
/*       */         
/*       */         return;
/*       */       } 
/* 11005 */       if (!citizen.getRole().mayInviteCitizens()) {
/*       */         
/* 11007 */         sendNormalServerMessage("You are not allowed to invite players to your village.");
/*       */         return;
/*       */       } 
/* 11010 */       if (!Servers.localServer.challengeServer)
/*       */       {
/* 11012 */         if ((this.player.getSaveFile().getPaymentExpire() <= 0L && citizen.getRole().getStatus() == 2) || (Servers.localServer.entryServer && !Server.getInstance().isPS())) {
/*       */           
/* 11014 */           sendNormalServerMessage("You are not allowed to invite players to your settlement. Since you were never a premium player your account may be deleted and the settlement may end up without mayor.");
/*       */           
/*       */           return;
/*       */         } 
/*       */       }
/*       */       try {
/* 11020 */         Player target = Players.getInstance().getPlayer(toInvite);
/* 11021 */         if (this.player.getKingdomId() == target.getKingdomId()) {
/*       */           
/* 11023 */           Village targetVillage = Villages.getVillageForCreature((Creature)target);
/* 11024 */           if (targetVillage == null) {
/*       */             
/* 11026 */             if (!target.isGuest()) {
/*       */               
/* 11028 */               if (target.isPlayer() && target.mayChangeVillageInMillis() > 0L) {
/*       */                 
/* 11030 */                 sendNormalServerMessage(target.getName() + " may not change village until " + 
/* 11031 */                     Server.getTimeFor(target.mayChangeVillageInMillis()) + " has elapsed.");
/*       */               } else {
/*       */                 
/* 11034 */                 Methods.sendJoinVillageQuestion((Creature)this.player, (Creature)target);
/*       */               } 
/*       */             } else {
/*       */               
/* 11038 */               sendAlertServerMessage("You just tried to invite a guest. This should not be possible and has been logged.");
/* 11039 */               logWarn(this.player.getName() + " has managed to invite a guest. This should not be possible, so cheating is involved.");
/*       */             }
/*       */           
/*       */           } else {
/*       */             
/* 11044 */             sendNormalServerMessage(target.getName() + " is already part of a village.");
/*       */           } 
/*       */         } else {
/* 11047 */           logWarn(this.player.getName() + " tried to invite ENEMY " + target.getName() + " as villager!");
/*       */         }
/*       */       
/* 11050 */       } catch (NoSuchPlayerException nsp) {
/*       */         
/* 11052 */         sendNormalServerMessage("Unable to find a player with the name: " + toInvite);
/*       */       } 
/*       */     } else {
/*       */       
/* 11056 */       sendNormalServerMessage("You can not invite someone when you are dead.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageVillageChat(String message) {
/* 11064 */     if (!this.player.isDead()) {
/*       */       
/* 11066 */       Village lVillage = this.player.getCitizenVillage();
/* 11067 */       if (lVillage == null) {
/* 11068 */         sendNormalServerMessage("You are not the citizen of a village or homestead.");
/*       */       } else {
/*       */         
/* 11071 */         StringTokenizer tokens = new StringTokenizer(message);
/* 11072 */         tokens.nextToken();
/* 11073 */         String toSend = "";
/* 11074 */         if (tokens.hasMoreTokens())
/* 11075 */           toSend = tokens.nextToken(); 
/* 11076 */         while (tokens.hasMoreTokens())
/* 11077 */           toSend = toSend + ' ' + tokens.nextToken(); 
/* 11078 */         toSend = drunkGarble(toSend);
/* 11079 */         lVillage.broadCastMessage(new Message((Creature)this.player, (byte)3, "Village", "<" + this.player
/* 11080 */               .getName() + "> " + toSend), lVillage
/* 11081 */             .twitChat());
/*       */       } 
/*       */     } else {
/*       */       
/* 11085 */       sendNormalServerMessage("Nobody can hear you now.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleMessageTeamChat(String message) {
/* 11093 */     if (!this.player.isDead())
/*       */     {
/* 11095 */       if (this.invulnerable) {
/*       */         
/* 11097 */         sendAlertServerMessage("You may not use team chat until you have moved and lost invulnerability.");
/*       */       }
/*       */       else {
/*       */         
/* 11101 */         StringTokenizer tokens = new StringTokenizer(message);
/* 11102 */         tokens.nextToken();
/* 11103 */         String toSend = "";
/* 11104 */         if (tokens.hasMoreTokens())
/* 11105 */           toSend = tokens.nextToken(); 
/* 11106 */         while (tokens.hasMoreTokens())
/* 11107 */           toSend = toSend + ' ' + tokens.nextToken(); 
/* 11108 */         toSend = drunkGarble(toSend);
/* 11109 */         Team g = this.player.getTeam();
/* 11110 */         if (g != null) {
/*       */           
/* 11112 */           g.sendTeamMessage((Creature)this.player, toSend);
/*       */         } else {
/*       */           
/* 11115 */           sendNormalServerMessage("You are not part of a team.");
/*       */         } 
/*       */       } 
/*       */     }
/*       */   }
/*       */   
/*       */   private void handleMessageRarity(String message) {
/* 11122 */     StringTokenizer tokens = new StringTokenizer(message);
/* 11123 */     tokens.nextToken();
/* 11124 */     if (tokens.hasMoreTokens()) {
/*       */       
/* 11126 */       String param = LoginHandler.raiseFirstLetter(tokens.nextToken());
/* 11127 */       if (param.startsWith("1") || param.startsWith("R") || param.startsWith("r")) {
/* 11128 */         this.player.setNextActionRarity((byte)1);
/* 11129 */       } else if (param.startsWith("2") || param.startsWith("S") || param.startsWith("s")) {
/* 11130 */         this.player.setNextActionRarity((byte)2);
/* 11131 */       } else if (param.startsWith("3") || param.startsWith("F") || param.startsWith("f")) {
/* 11132 */         this.player.setNextActionRarity((byte)3);
/*       */       } else {
/*       */         
/* 11135 */         sendNormalServerMessage("Value is a number between 1 and 3 or one of the words rare, supreme or fantastic (first character is used)");
/* 11136 */         sendNormalServerMessage("and it is used to make the next action rarity that value.");
/*       */       }
/*       */     
/*       */     } else {
/*       */       
/* 11141 */       sendNormalServerMessage("Usage: /rarity value.");
/* 11142 */       sendNormalServerMessage("Where value is used to make the next action rarity that value.");
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleMessageTeamInvite(String message) {
/* 11148 */     String[] words = message.split(" ");
/* 11149 */     if (words.length != 2) {
/*       */       
/* 11151 */       sendNormalServerMessage("The correct usage is: /tinvite <name>");
/*       */       
/*       */       return;
/*       */     } 
/* 11155 */     String targetName = LoginHandler.raiseFirstLetter(words[1]);
/*       */ 
/*       */     
/* 11158 */     if (this.player.getTeam() == null) {
/*       */       
/* 11160 */       sendNormalServerMessage("You are not part of a team");
/*       */       
/*       */       return;
/*       */     } 
/* 11164 */     if (!this.player.mayInviteTeam()) {
/*       */       
/* 11166 */       sendNormalServerMessage("You do not have the permission to invite other players to the team.");
/*       */       
/*       */       return;
/*       */     } 
/* 11170 */     if (this.player.getName().equalsIgnoreCase(targetName)) {
/*       */       
/* 11172 */       sendNormalServerMessage("You cannot invite yourself");
/*       */       
/*       */       return;
/*       */     } 
/* 11176 */     Player targetPlayer = Players.getInstance().getPlayerOrNull(targetName);
/* 11177 */     if (targetPlayer == null) {
/*       */       
/* 11179 */       sendNormalServerMessage("Unable to find a player by that name.");
/*       */       
/*       */       return;
/*       */     } 
/* 11183 */     if (targetPlayer.getTeam() != null && this.player.getTeam().equals(targetPlayer.getTeam())) {
/*       */       
/* 11185 */       sendNormalServerMessage(targetName + " is already part of your team!");
/*       */       
/*       */       return;
/*       */     } 
/* 11189 */     if (targetPlayer.getKingdomId() != this.player.getKingdomId() || !targetPlayer.acceptsInvitations()) {
/*       */       
/* 11191 */       sendNormalServerMessage(targetName + " needs to type /invitations first.");
/*       */       
/*       */       return;
/*       */     } 
/*       */     
/*       */     try {
/* 11197 */       TeamManagementQuestion question = new TeamManagementQuestion((Creature)this.player, "Expanding the team", "Inviting " + targetPlayer.getName(), false, targetPlayer.getWurmId(), false, false);
/* 11198 */       question.sendQuestion();
/*       */     }
/* 11200 */     catch (NoSuchPlayerException|NoSuchCreatureException e) {
/*       */       
/* 11202 */       sendNormalServerMessage(targetName + " needs to type /invitations first.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageGetIP(String message, int power) {
/* 11212 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 11221 */       StringTokenizer tokens = new StringTokenizer(message);
/* 11222 */       tokens.nextToken();
/*       */       
/* 11224 */       String kname = "";
/* 11225 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 11227 */         kname = LoginHandler.raiseFirstLetter(tokens.nextToken());
/* 11228 */         Players.getInstance().sendIpsToPlayer(this.player, kname);
/*       */       }
/*       */       else {
/*       */         
/* 11232 */         sendNormalServerMessage("Specify a playername please.");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageRename(String message, int power) {
/* 11243 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 11252 */       StringTokenizer tokens = new StringTokenizer(message);
/* 11253 */       tokens.nextToken();
/* 11254 */       String oldname = "Unknown";
/* 11255 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 11257 */         oldname = tokens.nextToken().trim();
/* 11258 */         oldname = LoginHandler.raiseFirstLetter(oldname);
/* 11259 */         String newname = "Unknown";
/* 11260 */         if (tokens.hasMoreTokens()) {
/*       */           
/* 11262 */           newname = tokens.nextToken().trim();
/* 11263 */           String password = "Unknown";
/* 11264 */           if (tokens.hasMoreTokens()) {
/*       */             
/* 11266 */             password = tokens.nextToken().trim();
/*       */             
/* 11268 */             if (password.length() >= 6) {
/*       */ 
/*       */               
/*       */               try {
/* 11272 */                 if (newname.length() > 2) {
/*       */                   
/* 11274 */                   if (Deities.isNameOkay(newname)) {
/*       */                     
/* 11276 */                     if (Players.getInstance().doesPlayerNameExist(newname))
/*       */                     {
/* 11278 */                       sendNormalServerMessage("The name " + newname + " is already in use.");
/*       */                     
/*       */                     }
/*       */                     else
/*       */                     {
/* 11283 */                       newname = LoginHandler.raiseFirstLetter(newname);
/* 11284 */                       LoginServerWebConnection lsw = new LoginServerWebConnection();
/* 11285 */                       String toReturn = lsw.renamePlayer(oldname, newname, password, this.player
/* 11286 */                           .getPower());
/*       */                       
/* 11288 */                       sendNormalServerMessage("You try to change the name of " + oldname + " to " + newname + " and set the password to '" + password + "'.");
/*       */ 
/*       */                       
/* 11291 */                       sendNormalServerMessage("The result is:");
/* 11292 */                       sendNormalServerMessage(toReturn);
/* 11293 */                       logger.info(this.player.getName() + " changed the name of " + oldname + " to " + newname + '.');
/*       */                       
/* 11295 */                       if (this.player.getLogger() != null) {
/* 11296 */                         this.player.getLogger().log(Level.INFO, this.player
/*       */                             
/* 11298 */                             .getName() + " changed the name of " + oldname + " to " + newname + '.');
/*       */                       }
/*       */                       
/*       */                       try {
/* 11302 */                         Player p = Players.getInstance().getPlayer(newname);
/* 11303 */                         p.refreshVisible();
/*       */                       }
/* 11305 */                       catch (NoSuchPlayerException noSuchPlayerException) {}
/*       */                     
/*       */                     }
/*       */                   
/*       */                   }
/*       */                   else {
/*       */                     
/* 11312 */                     sendNormalServerMessage("The name  " + newname + " is illegal.");
/*       */                   } 
/*       */                 } else {
/* 11315 */                   sendNormalServerMessage("The name  must contain at least 3 letters.");
/*       */                 } 
/* 11317 */               } catch (Exception ex) {
/*       */                 
/* 11319 */                 logWarn(this.player.getName() + " failed to change the name of " + oldname + " to " + newname + ": " + ex
/*       */                     
/* 11321 */                     .getMessage(), ex);
/* 11322 */                 sendNormalServerMessage("You FAILED to change the name of " + oldname + " to " + newname + ' ' + ex
/* 11323 */                     .getMessage());
/*       */               } 
/*       */             } else {
/*       */               
/* 11327 */               sendNormalServerMessage("Please choose a password longer than 5 letters.");
/*       */             } 
/*       */           } else {
/* 11330 */             sendNormalServerMessage("Syntax: #rename <oldname> <newname> <newpassword>");
/*       */           } 
/*       */         } else {
/* 11333 */           sendNormalServerMessage("Syntax: #rename <oldname> <newname> <newpassword>");
/*       */         } 
/*       */       } else {
/* 11336 */         sendNormalServerMessage("Syntax: #rename <oldname> <newname> <newpassword>");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageReadLog(String message, int power) {
/* 11353 */     if (power >= 5) {
/*       */       
/* 11355 */       StringTokenizer tokens = new StringTokenizer(message);
/* 11356 */       tokens.nextToken();
/*       */       
/* 11358 */       int start = 50;
/*       */       
/*       */       try {
/* 11361 */         String name = tokens.nextToken().trim();
/* 11362 */         if (tokens.hasMoreTokens()) {
/*       */           
/* 11364 */           String am = tokens.nextToken().trim();
/* 11365 */           start = Math.abs(Integer.parseInt(am));
/*       */         } 
/* 11367 */         PlayerInfo pinf = PlayerInfoFactory.createPlayerInfo(name);
/* 11368 */         if (pinf != null && pinf.loaded) {
/*       */           
/* 11370 */           if (pinf.getPower() == 5) {
/*       */             
/* 11372 */             sendAlertServerMessage("Peekaboo!");
/*       */           } else {
/*       */ 
/*       */             
/*       */             try {
/*       */               
/* 11378 */               FileReader fr = new FileReader(new File(pinf.getName() + ".log"));
/* 11379 */               BufferedReader br = new BufferedReader(fr);
/* 11380 */               LinkedList<String> lines = new LinkedList<>();
/* 11381 */               String tmp = br.readLine();
/* 11382 */               while (tmp != null) {
/*       */                 
/* 11384 */                 lines.add(tmp);
/* 11385 */                 tmp = br.readLine();
/*       */               } 
/* 11387 */               br.close();
/* 11388 */               if (!lines.isEmpty()) {
/*       */ 
/*       */ 
/*       */                 
/* 11392 */                 start = lines.size() - start;
/*       */ 
/*       */ 
/*       */ 
/*       */                 
/* 11397 */                 if (start < 0)
/*       */                 {
/* 11399 */                   start = 0;
/*       */                 }
/* 11401 */                 int end = start + 50;
/* 11402 */                 if (end > lines.size()) {
/* 11403 */                   end = lines.size();
/*       */                 }
/* 11405 */                 sendSafeServerMessage("Reading entry " + start + " to " + end);
/* 11406 */                 for (int x = start; x < end; x++)
/*       */                 {
/* 11408 */                   sendNormalServerMessage(lines.get(x));
/*       */                 }
/*       */               } else {
/*       */                 
/* 11412 */                 sendNormalServerMessage("The log is empty");
/*       */               }
/*       */             
/* 11415 */             } catch (IOException iox) {
/*       */               
/* 11417 */               sendAlertServerMessage("An error occurred: " + iox.getMessage());
/*       */             } 
/*       */           } 
/*       */         } else {
/*       */           
/* 11422 */           sendAlertServerMessage("No such Player");
/*       */         } 
/* 11424 */       } catch (Exception ex) {
/*       */         
/* 11426 */         sendAlertServerMessage("Make sure of the syntax #readlog playername <no of lines from the end>:" + ex
/* 11427 */             .getMessage());
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessageAddRegalia(String message, int power) {
/* 11434 */     if (power >= 5) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 11443 */       StringTokenizer tokens = new StringTokenizer(message);
/* 11444 */       tokens.nextToken();
/* 11445 */       String pname = "Unknown";
/* 11446 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 11448 */         pname = tokens.nextToken().trim();
/*       */         
/*       */         try {
/* 11451 */           pname = LoginHandler.raiseFirstLetter(pname);
/* 11452 */           Player p = Players.getInstance().getPlayer(pname);
/*       */           
/* 11454 */           if (p.isKing()) {
/*       */             
/* 11456 */             Methods.rewardRegalia((Creature)p);
/* 11457 */             sendNormalServerMessage("You bestow the royal regalia on " + p.getName() + ".");
/* 11458 */             p.getCommunicator().sendSafeServerMessage("You receive the royal regalia!");
/* 11459 */             this.player.getLogger().log(Level.INFO, "Added regalia to " + p.getName());
/*       */           } else {
/*       */             
/* 11462 */             sendNormalServerMessage(p.getName() + " is not king.");
/*       */           } 
/* 11464 */         } catch (NoSuchPlayerException nsp) {
/*       */           
/* 11466 */           sendNormalServerMessage("The player " + pname + " could not be found.");
/*       */         } 
/*       */       } else {
/*       */         
/* 11470 */         sendNormalServerMessage("Syntax: #addregalia <playername>.");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageAddTitle(String message, int power) {
/* 11480 */     if (power >= 3) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 11489 */       StringTokenizer tokens = new StringTokenizer(message);
/* 11490 */       tokens.nextToken();
/* 11491 */       String pname = "Unknown";
/* 11492 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 11494 */         pname = tokens.nextToken().trim();
/*       */         
/*       */         try {
/* 11497 */           pname = LoginHandler.raiseFirstLetter(pname);
/* 11498 */           Player p = Players.getInstance().getPlayer(pname);
/* 11499 */           Titles.Title title = getTitle(tokens, p.getSex(), 218);
/*       */           
/* 11501 */           if (title != null) {
/*       */             
/* 11503 */             p.addTitle(title);
/* 11504 */             sendNormalServerMessage("You bestow the title " + title
/* 11505 */                 .getName((p.getSex() == 0)) + " on " + p.getName() + ".");
/*       */           } else {
/*       */             
/* 11508 */             sendNormalServerMessage("The value could not be parsed into an title.");
/*       */           } 
/* 11510 */         } catch (NoSuchPlayerException nsp) {
/*       */           
/* 11512 */           sendNormalServerMessage("The player " + pname + " could not be found.");
/*       */         } 
/*       */       } else {
/*       */         
/* 11516 */         sendNormalServerMessage("Syntax: #addtitle <playername> [<title|titleid>].");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageParticipation(String message) {}
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageRiftParticipation(String message, int power) {}
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageRemoveTitle(String message, int power) {
/* 11540 */     if (power >= 3) {
/*       */       
/* 11542 */       StringTokenizer tokens = new StringTokenizer(message);
/* 11543 */       tokens.nextToken();
/* 11544 */       String pname = "Unknown";
/* 11545 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 11547 */         pname = tokens.nextToken().trim();
/*       */         
/*       */         try {
/* 11550 */           pname = LoginHandler.raiseFirstLetter(pname);
/* 11551 */           Player p = Players.getInstance().getPlayer(pname);
/* 11552 */           Titles.Title title = getTitle(tokens, p.getSex(), 191);
/*       */           
/* 11554 */           if (title != null) {
/*       */             
/* 11556 */             p.removeTitle(title);
/* 11557 */             if (p.getTitle() == title)
/* 11558 */               p.setTitle(null); 
/* 11559 */             sendNormalServerMessage("You remove the title " + title
/* 11560 */                 .getName((p.getSex() == 0)) + " from " + p.getName() + ".");
/*       */           } else {
/*       */             
/* 11563 */             sendNormalServerMessage("The value could not be parsed into an title.");
/*       */           } 
/* 11565 */         } catch (NoSuchPlayerException nsp) {
/*       */           
/* 11567 */           sendNormalServerMessage("The player " + pname + " could not be found.");
/*       */         } 
/*       */       } else {
/*       */         
/* 11571 */         sendNormalServerMessage("Syntax: #removetitle <playername> [<title|titleid>].");
/*       */       } 
/*       */     } 
/*       */   }
/*       */   
/*       */   private Titles.Title getTitle(StringTokenizer tokens, byte sex, int defaultTitleId) {
/* 11577 */     int newtitle = 191;
/* 11578 */     String titleString = "";
/* 11579 */     if (tokens.hasMoreTokens()) {
/*       */       
/* 11581 */       titleString = titleString + tokens.nextToken();
/* 11582 */       while (tokens.hasMoreTokens()) {
/* 11583 */         titleString = titleString + ' ' + tokens.nextToken();
/*       */       }
/*       */     } else {
/* 11586 */       return Titles.Title.getTitle(defaultTitleId);
/*       */     } 
/* 11588 */     Titles.Title title = null;
/*       */     
/*       */     try {
/* 11591 */       newtitle = Integer.parseInt(titleString);
/* 11592 */       title = Titles.Title.getTitle(newtitle);
/*       */     }
/* 11594 */     catch (NumberFormatException nfe) {
/*       */ 
/*       */       
/* 11597 */       title = Titles.Title.getTitle(titleString, (sex == 0));
/*       */     } 
/* 11599 */     return title;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageRespawn(String message, int power) {
/* 11608 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 11617 */       StringTokenizer tokens = new StringTokenizer(message);
/* 11618 */       tokens.nextToken();
/* 11619 */       String pname = "Unknown";
/* 11620 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 11622 */         pname = tokens.nextToken().trim();
/* 11623 */         pname = LoginHandler.raiseFirstLetter(pname);
/* 11624 */         Player p = null;
/*       */         
/*       */         try {
/* 11627 */           p = Players.getInstance().getPlayer(pname);
/*       */           
/* 11629 */           if (p.isDead())
/*       */           {
/* 11631 */             p.spawn(127);
/* 11632 */             sendNormalServerMessage("You revive " + pname + '.');
/*       */           }
/*       */           else
/*       */           {
/* 11636 */             sendNormalServerMessage(pname + " is not dead yet.");
/*       */           }
/*       */         
/* 11639 */         } catch (NoSuchPlayerException nsp) {
/*       */           
/* 11641 */           sendNormalServerMessage(pname + " is not online.");
/*       */         } 
/*       */       } else {
/*       */         
/* 11645 */         sendNormalServerMessage("Syntax: #respawn <playername>");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageLocateItem(String message, int power) {
/* 11655 */     if (power >= 5) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 11664 */       StringTokenizer tokens = new StringTokenizer(message);
/* 11665 */       tokens.nextToken();
/* 11666 */       int templateId = -1;
/*       */       
/* 11668 */       if (tokens.hasMoreTokens()) {
/*       */         
/*       */         try {
/*       */           
/* 11672 */           String tid = tokens.nextToken().trim();
/* 11673 */           templateId = Integer.parseInt(tid);
/* 11674 */           sendNormalServerMessage(EndGameItems.locateEndGameItem(templateId, (Creature)this.player));
/*       */         }
/* 11676 */         catch (Exception ex) {
/*       */ 
/*       */           
/* 11679 */           logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/*       */         } 
/*       */       }
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageResetWarnings(String message, int power) throws IOException {
/* 11692 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 11701 */       StringTokenizer tokens = new StringTokenizer(message);
/* 11702 */       tokens.nextToken();
/* 11703 */       String bname = "";
/*       */       
/*       */       try {
/* 11706 */         bname = tokens.nextToken().trim();
/* 11707 */         bname = LoginHandler.raiseFirstLetter(bname);
/*       */       }
/* 11709 */       catch (Exception ex) {
/*       */         
/* 11711 */         ex.printStackTrace();
/*       */       } 
/*       */       
/* 11714 */       PlayerInfo pinf = null;
/* 11715 */       Player play = null;
/*       */       
/*       */       try {
/* 11718 */         play = Players.getInstance().getPlayer(bname);
/* 11719 */         pinf = play.getSaveFile();
/*       */       }
/* 11721 */       catch (NoSuchPlayerException nsp) {
/*       */         
/* 11723 */         pinf = PlayerInfoFactory.createPlayerInfo(bname);
/* 11724 */         pinf.load();
/*       */       } 
/*       */       
/*       */       try {
/* 11728 */         pinf.resetWarnings();
/*       */         
/* 11730 */         sendSafeServerMessage("You have officially removed the warnings for " + bname + '.');
/* 11731 */         if (play != null) {
/* 11732 */           play.getCommunicator().sendSafeServerMessage("Your warnings have just been officially removed.");
/*       */         }
/*       */         
/* 11735 */         if (this.player.getLogger() != null) {
/* 11736 */           this.player.getLogger().log(Level.INFO, this.player
/* 11737 */               .getName() + " removes warnings for " + bname + '.');
/*       */         }
/* 11739 */       } catch (IOException iox) {
/*       */         
/* 11741 */         logInfo(this.player.getName() + " fails to reset warnings for " + bname + '.', iox);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageStartLibX(String message, int power) {
/* 11753 */     if (power >= 3)
/*       */     {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 11762 */       if (Servers.localServer.HOMESERVER) {
/*       */         
/* 11764 */         sendNormalServerMessage("Use #startx instead for home servers.");
/*       */       }
/*       */       else {
/*       */         
/* 11768 */         StringTokenizer tokens = new StringTokenizer(message);
/* 11769 */         tokens.nextToken();
/* 11770 */         int startX = Servers.localServer.SPAWNPOINTLIBX;
/*       */         
/*       */         try {
/* 11773 */           String stx = tokens.nextToken().trim();
/* 11774 */           logInfo("Setting start tile x for HOTS to " + stx + '.');
/* 11775 */           sendNormalServerMessage("Setting start tile x for HOTS to " + stx + '.');
/* 11776 */           startX = Integer.parseInt(stx);
/* 11777 */           Servers.localServer.SPAWNPOINTLIBX = startX;
/*       */         }
/* 11779 */         catch (Exception exception) {}
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageStartLibY(String message, int power) {
/* 11793 */     if (power >= 3)
/*       */     {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 11802 */       if (Servers.localServer.HOMESERVER) {
/*       */         
/* 11804 */         sendNormalServerMessage("Use #starty instead for home servers.");
/*       */       }
/*       */       else {
/*       */         
/* 11808 */         StringTokenizer tokens = new StringTokenizer(message);
/* 11809 */         tokens.nextToken();
/* 11810 */         int startY = Servers.localServer.SPAWNPOINTLIBY;
/*       */         
/*       */         try {
/* 11813 */           String sty = tokens.nextToken().trim();
/* 11814 */           logInfo("Setting start tile y for HOTS to " + sty + '.');
/* 11815 */           sendNormalServerMessage("Setting start tile y for HOTS to " + sty + '.');
/* 11816 */           startY = Integer.parseInt(sty);
/* 11817 */           Servers.localServer.SPAWNPOINTLIBY = startY;
/*       */         }
/* 11819 */         catch (Exception exception) {}
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageSetStartMolRehan(int power) {
/* 11832 */     if (power >= 3)
/*       */     {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 11841 */       if (Servers.localServer.HOMESERVER) {
/*       */         
/* 11843 */         sendNormalServerMessage("Unused on home.");
/*       */       }
/*       */       else {
/*       */         
/* 11847 */         Server.setMolRehanX((short)(this.player.getCurrentTile()).tilex);
/* 11848 */         Server.setMolRehanY((short)(this.player.getCurrentTile()).tiley);
/* 11849 */         sendNormalServerMessage("Teleportpoints set to " + Server.getMolRehanX() + ',' + 
/* 11850 */             Server.getMolRehanY());
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageStartMolX(String message, int power) {
/* 11861 */     if (power >= 3)
/*       */     {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 11870 */       if (Servers.localServer.HOMESERVER) {
/*       */         
/* 11872 */         sendNormalServerMessage("Use #startx instead for home servers.");
/*       */       }
/*       */       else {
/*       */         
/* 11876 */         StringTokenizer tokens = new StringTokenizer(message);
/* 11877 */         tokens.nextToken();
/* 11878 */         int startX = Servers.localServer.SPAWNPOINTMOLX;
/*       */         
/*       */         try {
/* 11881 */           String stx = tokens.nextToken().trim();
/* 11882 */           logInfo("Setting start tile x for MolRehan to " + stx + '.');
/* 11883 */           sendNormalServerMessage("Setting start tile x for MolRehan to " + stx + '.');
/* 11884 */           startX = Integer.parseInt(stx);
/* 11885 */           Servers.localServer.SPAWNPOINTMOLX = startX;
/*       */         }
/* 11887 */         catch (Exception exception) {}
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageStartMolY(String message, int power) {
/* 11901 */     if (power >= 3)
/*       */     {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 11910 */       if (Servers.localServer.HOMESERVER) {
/*       */         
/* 11912 */         sendNormalServerMessage("Use #starty instead for home servers.");
/*       */       }
/*       */       else {
/*       */         
/* 11916 */         StringTokenizer tokens = new StringTokenizer(message);
/* 11917 */         tokens.nextToken();
/* 11918 */         int startY = Servers.localServer.SPAWNPOINTMOLY;
/*       */         
/*       */         try {
/* 11921 */           String sty = tokens.nextToken().trim();
/* 11922 */           logInfo("Setting start tile y for MolRehan to " + sty + '.');
/* 11923 */           sendNormalServerMessage("Setting start tile y for MolRehan to " + sty + '.');
/* 11924 */           startY = Integer.parseInt(sty);
/* 11925 */           Servers.localServer.SPAWNPOINTMOLY = startY;
/*       */         }
/* 11927 */         catch (Exception exception) {}
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageMute(String message, int power) {
/* 11941 */     if (power >= 2 || this.player.mayMute()) {
/*       */       
/* 11943 */       StringTokenizer tokens = new StringTokenizer(message);
/* 11944 */       tokens.nextToken();
/* 11945 */       String bname = "";
/* 11946 */       String reason = "";
/* 11947 */       long expiry = 0L;
/* 11948 */       int hours = 0;
/* 11949 */       boolean ok = true;
/* 11950 */       if (tokens.hasMoreTokens()) {
/*       */ 
/*       */         
/*       */         try {
/* 11954 */           bname = tokens.nextToken().trim();
/* 11955 */           bname = LoginHandler.raiseFirstLetter(bname);
/* 11956 */           if (this.player.getLogger() != null) {
/* 11957 */             this.player.getLogger().log(Level.INFO, "Trying to mute player " + bname + '.');
/*       */           }
/* 11959 */         } catch (Exception ex) {
/*       */           
/* 11961 */           ok = false;
/*       */         }
/*       */       
/*       */       } else {
/*       */         
/* 11966 */         ok = false;
/*       */       } 
/* 11968 */       if (tokens.hasMoreTokens()) {
/*       */         
/*       */         try
/*       */         {
/* 11972 */           hours = Integer.parseInt(tokens.nextToken().trim());
/* 11973 */           expiry = System.currentTimeMillis() + hours * 3600000L;
/* 11974 */           if (hours == 0)
/*       */           {
/* 11976 */             ok = false;
/*       */           }
/*       */         }
/* 11979 */         catch (Exception ex)
/*       */         {
/* 11981 */           ok = false;
/*       */         }
/*       */       
/*       */       } else {
/*       */         
/* 11986 */         ok = false;
/*       */       } 
/* 11988 */       if (tokens.hasMoreTokens()) {
/*       */ 
/*       */         
/*       */         try {
/* 11992 */           while (tokens.hasMoreTokens())
/* 11993 */             reason = reason + tokens.nextToken() + ' '; 
/* 11994 */           if (reason.length() < 4)
/*       */           {
/* 11996 */             sendAlertServerMessage("The reason " + reason + " seems a bit short. Please explain a bit more.");
/*       */             
/* 11998 */             ok = false;
/*       */           }
/*       */         
/* 12001 */         } catch (Exception ex) {
/*       */           
/* 12003 */           ok = false;
/*       */         }
/*       */       
/*       */       } else {
/*       */         
/* 12008 */         ok = false;
/*       */       } 
/* 12010 */       if (!ok) {
/*       */         
/* 12012 */         sendAlertServerMessage("Failed to mute the player. Make sure you use the syntax #mute <name> <hours> <reason> like this: #mute Griefer 2 bad language.");
/*       */       }
/*       */       else {
/*       */         
/* 12016 */         Player p = null;
/*       */         
/*       */         try {
/* 12019 */           p = Players.getInstance().getPlayer(bname);
/* 12020 */           if (p.getPower() < this.player.getPower() || (this.player
/* 12021 */             .mayMute() && p.getPower() == this.player.getPower())) {
/*       */             
/* 12023 */             p.mute(true, reason, expiry);
/* 12024 */             Players.addMgmtMessage(this.player.getName(), "mutes " + bname + " for " + hours + " hours. Reason: " + reason);
/*       */             
/* 12026 */             Message mess = new Message((Creature)this.player, (byte)9, "MGMT", "<" + this.player.getName() + "> mutes " + bname + " for " + hours + " hours. Reason: " + reason, muteMsgRed, muteMsgGreen, muteMsgBlue);
/*       */ 
/*       */ 
/*       */             
/* 12030 */             Server.getInstance().addMessage(mess);
/* 12031 */             sendNormalServerMessage("You have muted " + p.getName() + " for " + hours + " hours.");
/* 12032 */             p.getCommunicator().sendAlertServerMessage("You have been muted by " + this.player
/* 12033 */                 .getName() + " for " + hours + " hours and cannot shout anymore. Reason: " + reason);
/*       */             
/* 12035 */             if (this.player.getLogger() != null) {
/* 12036 */               this.player.getLogger().log(Level.INFO, this.player
/*       */                   
/* 12038 */                   .getName() + " muted " + bname + " for " + hours + " hours. Reason: " + reason);
/*       */             }
/* 12040 */             logInfo(this.player.getName() + " muted " + bname + ", reason " + reason);
/*       */             
/* 12042 */             WcGlobalModeration wcgm = new WcGlobalModeration(WurmId.getNextWCCommandId(), this.player.getName(), (byte)this.player.getPower(), true, false, false, false, false, hours, 0, bname, reason);
/*       */             
/* 12044 */             if (Servers.localServer.LOGINSERVER) {
/*       */               
/* 12046 */               wcgm.sendFromLoginServer();
/* 12047 */               Trello.addMessage(this.player.getName(), bname, reason, hours);
/*       */             } else {
/*       */               
/* 12050 */               wcgm.sendToLoginServer();
/*       */             } 
/*       */           } else {
/* 12053 */             sendNormalServerMessage("You are too weak to mute " + p.getName() + '!');
/*       */           } 
/* 12055 */         } catch (NoSuchPlayerException nsp) {
/*       */           
/* 12057 */           sendNormalServerMessage("No player online found on server with the name " + bname + ". So muting globally.");
/*       */           
/* 12059 */           WcGlobalModeration wcgm = new WcGlobalModeration(WurmId.getNextWCCommandId(), this.player.getName(), (byte)this.player.getPower(), true, false, false, false, false, hours, 0, bname, reason);
/*       */           
/* 12061 */           if (Servers.localServer.LOGINSERVER) {
/*       */             
/* 12063 */             wcgm.sendFromLoginServer();
/* 12064 */             Trello.addMessage(this.player.getName(), bname, reason, hours);
/*       */           } else {
/*       */             
/* 12067 */             wcgm.sendToLoginServer();
/* 12068 */           }  Players.addMgmtMessage(this.player.getName(), "mutes " + bname + " for " + hours + " hours. Reason: " + reason);
/*       */           
/* 12070 */           Message mess = new Message((Creature)this.player, (byte)9, "MGMT", "<" + this.player.getName() + "> mutes " + bname + " for " + hours + " hours. Reason: " + reason, muteMsgRed, muteMsgGreen, muteMsgBlue);
/*       */ 
/*       */ 
/*       */           
/* 12074 */           Server.getInstance().addMessage(mess);
/*       */         } 
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageToggleMounts(int power) {
/* 12085 */     if (power >= 3) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 12094 */       Constants.enabledMounts = !Constants.enabledMounts;
/* 12095 */       if (Constants.enabledMounts) {
/* 12096 */         sendSafeServerMessage("Okay, mounts, driving and horse spawning is now effective.");
/*       */       } else {
/* 12098 */         sendSafeServerMessage("Okay, mounts, driving and horse spawning no longer work. You may still drive and ride if you boarded.");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageNow() {
/* 12111 */     sendSafeServerMessage("Now=" + System.currentTimeMillis());
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageWurmDate(String message) {
/* 12123 */     StringTokenizer tokens = new StringTokenizer(message);
/* 12124 */     tokens.nextToken();
/* 12125 */     if (tokens.hasMoreTokens()) {
/*       */       
/* 12127 */       String ttime = tokens.nextToken();
/*       */       
/*       */       try {
/* 12130 */         long wurmtime = Long.parseLong(ttime);
/* 12131 */         sendNormalServerMessage("That Wurm Date is " + WurmCalendar.getDateFor(wurmtime));
/* 12132 */         long wurmcurrent = WurmCalendar.currentTime;
/* 12133 */         long wurmdiff = wurmcurrent - wurmtime;
/* 12134 */         if (wurmdiff < 0L) {
/* 12135 */           sendNormalServerMessage("Approx real time until that date: " + Server.getTimeFor(-wurmdiff / 8L));
/*       */         } else {
/* 12137 */           sendNormalServerMessage("Approx real time since that date: " + Server.getTimeFor(wurmdiff / 8L));
/*       */         } 
/* 12139 */       } catch (Exception ex) {
/*       */         
/* 12141 */         sendNormalServerMessage("Not a proper number.");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageHarvest(String message) {
/* 12162 */     StringTokenizer tokens = new StringTokenizer(message);
/* 12163 */     tokens.nextToken();
/* 12164 */     sendNormalServerMessage("Note: Secs=" + WurmCalendar.getCurrentTime());
/* 12165 */     if (!tokens.hasMoreTokens()) {
/*       */       
/* 12167 */       sendNormalServerMessage("Needs a param. Range is 1-" + 
/* 12168 */           WurmHarvestables.getMaxHarvestId() + ".");
/*       */     }
/*       */     else {
/*       */       
/* 12172 */       String harvest = tokens.nextToken();
/*       */       
/*       */       try {
/* 12175 */         int eventId = Integer.parseInt(harvest);
/* 12176 */         if (eventId < 1 || eventId > WurmHarvestables.getMaxHarvestId()) {
/*       */           
/* 12178 */           sendNormalServerMessage("Not a proper harvest number. Range is 1-" + 
/* 12179 */               WurmHarvestables.getMaxHarvestId() + ".");
/*       */         }
/* 12181 */         else if (!tokens.hasMoreTokens()) {
/*       */ 
/*       */           
/* 12184 */           WurmHarvestables.Harvestable harvestable = WurmHarvestables.getHarvestable(eventId);
/* 12185 */           if (harvestable != null) {
/* 12186 */             sendNormalServerMessage(harvestable.getHarvestEvent());
/*       */           }
/*       */         } else {
/*       */           
/* 12190 */           String ttime = tokens.nextToken();
/*       */           
/*       */           try {
/* 12193 */             long newHarvestTime = Long.parseLong(ttime);
/*       */ 
/*       */             
/* 12196 */             if (newHarvestTime < WurmCalendar.getCurrentTime() - 4838400L) {
/*       */               
/* 12198 */               sendNormalServerMessage("cannot change as new data is over a wurm month ago...");
/*       */             }
/* 12200 */             else if (newHarvestTime > WurmCalendar.getCurrentTime() + 29030400L) {
/*       */               
/* 12202 */               sendNormalServerMessage("cannot change as new data is over a wurm year in furure...");
/*       */             }
/*       */             else {
/*       */               
/* 12206 */               WurmHarvestables.Harvestable harvestable = WurmHarvestables.getHarvestable(eventId);
/* 12207 */               if (harvestable != null)
/*       */               {
/* 12209 */                 harvestable.setSeasonStart(newHarvestTime, true);
/*       */                 
/* 12211 */                 sendNormalServerMessage(harvestable.getHarvestEvent());
/*       */               }
/*       */             
/*       */             } 
/* 12215 */           } catch (Exception ex) {
/*       */             
/* 12217 */             sendNormalServerMessage("Not a proper wurm time.");
/*       */           }
/*       */         
/*       */         } 
/* 12221 */       } catch (Exception ex) {
/*       */         
/* 12223 */         sendNormalServerMessage("Not a proper harvest number.");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageRealTime(String message) {
/* 12237 */     StringTokenizer tokens = new StringTokenizer(message);
/* 12238 */     tokens.nextToken();
/* 12239 */     if (tokens.hasMoreTokens()) {
/*       */       
/* 12241 */       String ttime = tokens.nextToken();
/*       */       
/*       */       try {
/* 12244 */         long l = Long.parseLong(ttime);
/* 12245 */         sendNormalServerMessage("That is " + new Date(l));
/* 12246 */         if (l > System.currentTimeMillis()) {
/* 12247 */           sendNormalServerMessage("Time until that date: " + Server.getTimeFor(l - System.currentTimeMillis()));
/*       */         } else {
/* 12249 */           sendNormalServerMessage("Time since that date: " + Server.getTimeFor(System.currentTimeMillis() - l));
/*       */         } 
/* 12251 */       } catch (Exception ex) {
/*       */         
/* 12253 */         sendNormalServerMessage("Not a proper number.");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private boolean handleHashMessageRespond(String message) {
/* 12263 */     if (this.player.mayHearDevTalk() || this.player.mayHearMgmtTalk()) {
/*       */       
/* 12265 */       StringTokenizer tokens = new StringTokenizer(message);
/* 12266 */       tokens.nextToken();
/* 12267 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 12269 */         String tabName = tokens.nextToken().trim();
/* 12270 */         if (tokens.hasMoreTokens()) {
/*       */           
/* 12272 */           String whom = tokens.nextToken().trim();
/*       */ 
/*       */           
/* 12275 */           if (tabName.equalsIgnoreCase("GM") && this.player.mayHearDevTalk()) {
/*       */ 
/*       */             
/* 12278 */             this.player.respondGMTab(whom, "");
/* 12279 */             return true;
/*       */           } 
/* 12281 */           if (tabName.equalsIgnoreCase("MGMT")) {
/*       */             
/* 12283 */             this.player.respondMGMTTab(whom, "");
/* 12284 */             return true;
/*       */           } 
/*       */         } 
/*       */       } 
/*       */     } 
/* 12289 */     return false;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageSetServer(String message, int power) {
/* 12298 */     if (power >= 2) {
/*       */       
/*       */       try {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */         
/* 12309 */         StringTokenizer tokens = new StringTokenizer(message);
/* 12310 */         tokens.nextToken();
/* 12311 */         String pname = "Unknown";
/* 12312 */         pname = tokens.nextToken().trim();
/* 12313 */         pname = LoginHandler.raiseFirstLetter(pname);
/* 12314 */         PlayerInfo info = PlayerInfoFactory.createPlayerInfo(pname);
/* 12315 */         if (info != null) {
/*       */ 
/*       */           
/*       */           try {
/* 12319 */             info.load();
/*       */             
/* 12321 */             if (tokens.hasMoreTokens())
/*       */             {
/* 12323 */               int number = Integer.parseInt(tokens.nextToken());
/* 12324 */               info.setCurrentServer(number);
/* 12325 */               sendSafeServerMessage("Okay, set the current server of " + pname + " to " + number);
/*       */               
/* 12327 */               sendSafeServerMessage("Make sure to do this BOTH on the login server and the actual current server!");
/*       */             }
/*       */             else
/*       */             {
/* 12331 */               sendAlertServerMessage("Make sure of the syntax #setserver playername servernumber");
/*       */             }
/*       */           
/* 12334 */           } catch (IOException iox) {
/*       */             
/* 12336 */             sendAlertServerMessage("Failure when loading " + pname + ". Try setting to the previous server.");
/*       */           }
/*       */         
/*       */         } else {
/*       */           
/* 12341 */           sendSafeServerMessage(pname + " does not exist on this server.");
/*       */         } 
/* 12343 */       } catch (Exception ex) {
/*       */         
/* 12345 */         sendAlertServerMessage("Make sure of the syntax #setserver playername servernumber");
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageOverrideShop(String message, int power) {
/* 12356 */     if (power >= 3) {
/*       */       
/*       */       try {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */         
/* 12367 */         StringTokenizer tokens = new StringTokenizer(message);
/* 12368 */         tokens.nextToken();
/* 12369 */         String pname = "Unknown";
/* 12370 */         pname = tokens.nextToken().trim();
/* 12371 */         pname = LoginHandler.raiseFirstLetter(pname);
/* 12372 */         PlayerInfo info = PlayerInfoFactory.createPlayerInfo(pname);
/* 12373 */         if (info != null) {
/*       */           
/* 12375 */           info.setOverRideShop(Boolean.parseBoolean(tokens.nextToken()));
/* 12376 */           sendSafeServerMessage("Okay, set the flag of " + pname + " to " + info.overRideShop);
/*       */         } else {
/*       */           
/* 12379 */           sendSafeServerMessage(pname + " does not exist on this server.");
/*       */         } 
/* 12381 */       } catch (Exception ex) {
/*       */         
/* 12383 */         sendAlertServerMessage("Make sure of the syntax #overrideshop playername <true|false>:" + ex
/* 12384 */             .getMessage());
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageBannedIps(int power) {
/* 12394 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 12403 */       KingdomIp[] kips = KingdomIp.getAllKips();
/* 12404 */       for (KingdomIp kip : kips) {
/*       */         
/* 12406 */         long last = kip.getLastLogout();
/* 12407 */         if (last == 0L) {
/* 12408 */           sendNormalServerMessage(kip.getIpAddress() + " " + 
/* 12409 */               Kingdoms.getNameFor(kip.getKingdom()) + " time=Still logged on");
/*       */         } else {
/* 12411 */           sendNormalServerMessage(kip.getIpAddress() + " " + 
/* 12412 */               Kingdoms.getNameFor(kip.getKingdom()) + " time=" + 
/* 12413 */               Server.getTimeFor(System.currentTimeMillis() - last));
/*       */         } 
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageCheckZones(int power) {
/* 12423 */     if (power >= 5)
/*       */     {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 12432 */       ErrorChecks.checkZones((Creature)this.player);
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageCheckCreatures(String message, int power) {
/* 12442 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 12451 */       StringTokenizer tokens = new StringTokenizer(message);
/* 12452 */       tokens.nextToken();
/* 12453 */       String toCheck = "";
/* 12454 */       if (tokens.hasMoreTokens())
/*       */       {
/* 12456 */         toCheck = tokens.nextToken().trim();
/*       */       }
/* 12458 */       ErrorChecks.checkCreatures((Creature)this.player, toCheck);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageCheckItems(String message, int power) {
/* 12468 */     if (power >= 5) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 12477 */       StringTokenizer tokens = new StringTokenizer(message);
/* 12478 */       tokens.nextToken();
/* 12479 */       String toCheck = "";
/* 12480 */       if (tokens.hasMoreTokens())
/*       */       {
/* 12482 */         toCheck = tokens.nextToken().trim();
/*       */       }
/* 12484 */       ErrorChecks.checkItems((Creature)this.player, toCheck);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageReloadItems(String message, int power) {
/* 12494 */     if (power >= 4) {
/*       */ 
/*       */ 
/*       */       
/* 12498 */       if (this.player.getLogger() != null) {
/* 12499 */         this.player.getLogger().info(message);
/*       */       }
/*       */       
/* 12502 */       StringTokenizer tokens = new StringTokenizer(message);
/* 12503 */       tokens.nextToken();
/* 12504 */       if (tokens.hasMoreTokens()) {
/*       */ 
/*       */         
/*       */         try {
/* 12508 */           long wurmid = Long.parseLong(tokens.nextToken().trim());
/* 12509 */           if (Items.reloadAllSubItems(this.player, wurmid)) {
/* 12510 */             sendNormalServerMessage("Finished reloading all items for " + wurmid + ".");
/*       */           }
/* 12512 */         } catch (NumberFormatException e) {
/*       */           
/* 12514 */           sendNormalServerMessage("Usage: #reloadItems <wurmId> - checks for all subitems of the given itemId and forces them back into that item.");
/*       */         }
/*       */       
/*       */       } else {
/*       */         
/* 12519 */         sendNormalServerMessage("Usage: #reloadItems <wurmId> - checks for all subitems of the given itemId and forces them back into that item.");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageOnFire(int power) {
/* 12529 */     if (power >= 2)
/*       */     {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 12538 */       if (this.player.isOnFire()) {
/*       */         
/* 12540 */         sendSafeServerMessage("You are no longer on fire.");
/* 12541 */         this.player.isOnFire = false;
/*       */       }
/*       */       else {
/*       */         
/* 12545 */         sendSafeServerMessage("You are now on fire!");
/* 12546 */         this.player.isOnFire = true;
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageVeSpeed(String message, int power) {
/* 12557 */     if (power >= 5) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 12566 */       StringTokenizer tokens = new StringTokenizer(message);
/* 12567 */       tokens.nextToken();
/*       */       
/* 12569 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 12571 */         String speed = tokens.nextToken().trim();
/*       */         
/*       */         try {
/* 12574 */           short speedb = Short.parseShort(speed);
/* 12575 */           if (this.player.isVehicleCommander()) {
/*       */             
/* 12577 */             this.player.getMovementScheme().addMountSpeed(speedb);
/* 12578 */             sendSafeServerMessage("Vehicle speed now " + speed);
/*       */           } else {
/*       */             
/* 12581 */             sendSafeServerMessage("Not commanding.");
/*       */           } 
/* 12583 */         } catch (Exception exception) {}
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageLagStatus(int power) {
/* 12595 */     if (power >= 5) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 12604 */       int x = (int)((System.currentTimeMillis() - Server.getStartTime()) / 1000L);
/* 12605 */       int y = Server.getSecondsUptime();
/* 12606 */       sendSafeServerMessage("The server has been up " + x + " seconds, and ticked " + y + " seconds (" + (x / y * 100.0F) + "%).");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageAddReimbursement(String message, int power) {
/* 12617 */     if (power >= 5) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 12626 */       StringTokenizer tokens = new StringTokenizer(message);
/* 12627 */       tokens.nextToken();
/* 12628 */       String pname = "Unknown";
/* 12629 */       pname = tokens.nextToken().trim();
/* 12630 */       pname = LoginHandler.raiseFirstLetter(pname);
/*       */       
/* 12632 */       String smonths = "0";
/* 12633 */       boolean ok = false;
/* 12634 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 12636 */         smonths = tokens.nextToken().trim();
/*       */         
/* 12638 */         String sdays = "0";
/* 12639 */         if (tokens.hasMoreTokens()) {
/*       */           
/* 12641 */           sdays = tokens.nextToken().trim();
/* 12642 */           String ssilvers = "0";
/* 12643 */           if (tokens.hasMoreTokens()) {
/*       */             
/* 12645 */             ssilvers = tokens.nextToken().trim();
/* 12646 */             String detail = "PI" + System.currentTimeMillis();
/* 12647 */             if (tokens.hasMoreTokens()) {
/*       */               
/* 12649 */               detail = tokens.nextToken().trim();
/* 12650 */               boolean det = false;
/* 12651 */               if (detail.toLowerCase().equals("true")) {
/* 12652 */                 det = true;
/*       */               }
/*       */               try {
/* 12655 */                 int months = Integer.parseInt(smonths);
/* 12656 */                 int days = Integer.parseInt(sdays);
/* 12657 */                 int silvers = Integer.parseInt(ssilvers);
/* 12658 */                 if (months >= 0 && days >= 0 && silvers >= 0 && (months != 0 || days != 0 || silvers != 0 || det))
/*       */                 {
/*       */                   
/* 12661 */                   LoginServerWebConnection lsw = new LoginServerWebConnection();
/* 12662 */                   sendSafeServerMessage(lsw.addReimb(this.player.getName(), pname, months, silvers, days, det));
/*       */                   
/* 12664 */                   ok = true;
/*       */                 }
/*       */               
/* 12667 */               } catch (Exception ex) {
/*       */                 
/* 12669 */                 sendAlertServerMessage("Error: " + ex.getMessage());
/* 12670 */                 sendAlertServerMessage("Syntax: #addreimb name months days silvers setbok");
/*       */               } 
/*       */             } 
/*       */           } 
/*       */         } 
/*       */       } 
/* 12676 */       if (!ok) {
/* 12677 */         sendAlertServerMessage("Make sure #addreimb name months days silvers setbok:" + message);
/*       */       }
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageAddMoney(String message, int power) {
/* 12687 */     if (power >= 5 || (!Servers.localServer.testServer && power >= 3)) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 12697 */       StringTokenizer tokens = new StringTokenizer(message);
/* 12698 */       tokens.nextToken();
/* 12699 */       String pname = "Unknown";
/* 12700 */       pname = tokens.nextToken().trim();
/* 12701 */       pname = LoginHandler.raiseFirstLetter(pname);
/*       */       
/* 12703 */       String smonths = "0";
/* 12704 */       boolean ok = false;
/* 12705 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 12707 */         smonths = tokens.nextToken().trim();
/*       */         
/* 12709 */         String sdays = "0";
/* 12710 */         if (tokens.hasMoreTokens()) {
/*       */           
/* 12712 */           sdays = tokens.nextToken().trim();
/* 12713 */           String ssilvers = "0";
/* 12714 */           if (tokens.hasMoreTokens()) {
/*       */             
/* 12716 */             ssilvers = tokens.nextToken().trim();
/* 12717 */             String detail = "PI" + System.currentTimeMillis();
/* 12718 */             if (tokens.hasMoreTokens()) {
/*       */               
/* 12720 */               detail = tokens.nextToken().trim();
/* 12721 */               while (tokens.hasMoreTokens()) {
/* 12722 */                 detail = detail + ' ' + tokens.nextToken();
/*       */               }
/*       */               try {
/* 12725 */                 int months = Integer.parseInt(smonths);
/* 12726 */                 int days = Integer.parseInt(sdays);
/* 12727 */                 int silvers = Integer.parseInt(ssilvers);
/* 12728 */                 if (months >= 0 && days >= 0 && (months != 0 || days != 0)) {
/*       */                   
/* 12730 */                   LoginServerWebConnection lsw = new LoginServerWebConnection();
/* 12731 */                   if (lsw.addPlayingTime((Creature)this.player, pname, months, days, detail)) {
/*       */                     
/* 12733 */                     ok = true;
/* 12734 */                     sendSafeServerMessage("Added " + months + " months, and " + days + " days to " + pname + " with detail " + detail + '.');
/*       */                     
/* 12736 */                     this.player.getLogger().log(Level.INFO, "Added " + months + " months, and " + days + " days to " + pname + " with detail " + detail + '.');
/*       */                   }
/*       */                   else {
/*       */                     
/* 12740 */                     sendAlertServerMessage("Failed to add playing time.");
/*       */                   } 
/* 12742 */                 }  if (silvers > 0) {
/*       */                   
/* 12744 */                   LoginServerWebConnection lsw = new LoginServerWebConnection();
/* 12745 */                   if (lsw.addMoney((Creature)this.player, pname, (silvers * 10000), detail)) {
/*       */                     
/* 12747 */                     ok = true;
/* 12748 */                     sendSafeServerMessage("Added " + silvers + " to " + pname + " with detail " + detail + '.');
/*       */                     
/* 12750 */                     this.player.getLogger().log(Level.INFO, "Added " + silvers + " to " + pname + " with detail " + detail + '.');
/*       */                   }
/*       */                   else {
/*       */                     
/* 12754 */                     sendAlertServerMessage("Failed to add money.");
/*       */                   } 
/*       */                 } 
/* 12757 */               } catch (Exception ex) {
/*       */                 
/* 12759 */                 sendAlertServerMessage("Error: " + ex.getMessage());
/* 12760 */                 sendAlertServerMessage("Syntax: #addmoney name months days silvers detail");
/*       */               } 
/*       */             } 
/*       */           } 
/*       */         } 
/*       */       } 
/* 12766 */       if (!ok) {
/* 12767 */         sendAlertServerMessage("Make sure #addmoney name months days silvers detail:" + message);
/*       */       }
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageTimeMod(String message, int power) {
/* 12777 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 12786 */       StringTokenizer tokens = new StringTokenizer(message);
/* 12787 */       tokens.nextToken();
/* 12788 */       String hours = "";
/* 12789 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 12791 */         hours = tokens.nextToken().trim();
/*       */         
/*       */         try {
/* 12794 */           int t = Integer.parseInt(hours);
/* 12795 */           if (t > -100 && t < 100) {
/*       */             
/* 12797 */             this.timeMod = (t * 60);
/* 12798 */             sendAlertServerMessage("Your time modificator of " + t + " should be effective within a few minutes.");
/*       */           }
/*       */           else {
/*       */             
/* 12802 */             sendAlertServerMessage("Please use a time mod between -100 and 100.");
/*       */           } 
/* 12804 */         } catch (Exception exception) {}
/*       */       
/*       */       }
/*       */       else {
/*       */         
/* 12809 */         sendAlertServerMessage("Syntax #timemod <hours>");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageFindBoat(String message, int power) throws NoSuchItemException {
/* 12820 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 12829 */       StringTokenizer tokens = new StringTokenizer(message);
/* 12830 */       tokens.nextToken();
/* 12831 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 12833 */         String pname = "Unknown";
/* 12834 */         pname = tokens.nextToken().trim();
/* 12835 */         if (pname.length() < 1) {
/* 12836 */           sendNormalServerMessage("Too short search string.");
/*       */         } else {
/*       */           
/* 12839 */           Set<Item> boats = Items.getItemsWithDesc(pname, true);
/* 12840 */           for (Iterator<Item> it = boats.iterator(); it.hasNext(); ) {
/*       */             
/* 12842 */             Item boat = it.next();
/* 12843 */             sendNormalServerMessage(boat.getDescription() + ", " + boat.getName() + " (id:" + boat
/* 12844 */                 .getWurmId() + ") at tile " + boat
/* 12845 */                 .getTileX() + ", " + boat.getTileY());
/*       */           } 
/*       */         } 
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessageForceRiftLoot(String message, int power) {
/* 12854 */     if (power >= 5) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 12863 */       GMForceSpawnRiftLootQuestion gfsrlq = new GMForceSpawnRiftLootQuestion((Creature)this.player);
/* 12864 */       gfsrlq.sendQuestion();
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageFindFish(String message, boolean newFish) {
/*       */     Point[] points;
/* 12877 */     StringTokenizer tokens = new StringTokenizer(message);
/* 12878 */     tokens.nextToken();
/*       */     
/* 12880 */     if (newFish) {
/*       */       
/* 12882 */       ArrayList<Point> allPoints = new ArrayList<>();
/* 12883 */       int season = WurmCalendar.getSeasonNumber();
/* 12884 */       points = MethodsFishing.getSpecialSpots(this.player.getTileX(), this.player.getTileY(), season);
/* 12885 */       sendAlertServerMessage("New fishing spots");
/*       */       
/* 12887 */       for (int i = 0; i < 2048; i += 128) {
/*       */         
/* 12889 */         for (int j = 0; j < 2048; j += 128) {
/* 12890 */           for (Point p : MethodsFishing.getSpecialSpots(i, j, season))
/* 12891 */             allPoints.add(p); 
/*       */         } 
/*       */       } 
/* 12894 */       for (Point p : allPoints)
/*       */       {
/* 12896 */         String fishName = ItemTemplateFactory.getInstance().getTemplateName(p.getH());
/* 12897 */         sendNormalServerMessage(fishName + " @ " + p.getX() + "," + p.getY());
/*       */       }
/*       */     
/*       */     }
/*       */     else {
/*       */       
/* 12903 */       points = Fish.getRareSpots(this.player.getTileX(), this.player.getTileY());
/* 12904 */       sendAlertServerMessage("Old fishing spots");
/*       */     } 
/* 12906 */     for (Point point : points) {
/*       */       
/* 12908 */       String fishName = ItemTemplateFactory.getInstance().getTemplateName(point.getH());
/* 12909 */       sendNormalServerMessage(fishName + " @ " + point.getX() + "," + point.getY());
/*       */     } 
/* 12911 */     if (points.length == 0) {
/* 12912 */       sendNormalServerMessage("No rare fish places found");
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageWorth(String message, int power) {
/* 12921 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 12930 */       StringTokenizer tokens = new StringTokenizer(message);
/* 12931 */       tokens.nextToken();
/* 12932 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 12934 */         String pname = "Unknown";
/* 12935 */         pname = tokens.nextToken().trim();
/* 12936 */         pname = LoginHandler.raiseFirstLetter(pname);
/*       */         
/*       */         try {
/* 12939 */           Player p = Players.getInstance().getPlayer(pname);
/* 12940 */           sendNormalServerMessage(p.getName() + " is worth " + p.getRoyalLevels() + " royal levels.");
/*       */           
/* 12942 */           this.player.getLogger().log(Level.INFO, "Checked royal levels for " + pname);
/*       */         }
/* 12944 */         catch (NoSuchPlayerException nsp) {
/*       */           
/* 12946 */           sendAlertServerMessage("No player with that name online.");
/*       */         } 
/*       */       } else {
/*       */         
/* 12950 */         sendAlertServerMessage("Provide a name");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageTestWeb(String message, int power) {
/* 12960 */     if (power >= 5) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 12969 */       StringTokenizer tokens = new StringTokenizer(message);
/* 12970 */       tokens.nextToken();
/* 12971 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 12973 */         String pname = "Unknown";
/* 12974 */         pname = tokens.nextToken().trim();
/* 12975 */         pname = LoginHandler.raiseFirstLetter(pname);
/* 12976 */         LoginServerWebConnection lsw = new LoginServerWebConnection();
/* 12977 */         lsw.testAdding(pname);
/*       */       } else {
/*       */         
/* 12980 */         sendAlertServerMessage("Provide a name");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessagePlayerStatuses(int power) {
/* 12989 */     if (power >= 5)
/*       */     {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 12998 */       Players.getInstance().sendPlayerStatus(this.player);
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageReload(String message, int power) {
/* 13008 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13017 */       StringTokenizer tokens = new StringTokenizer(message);
/* 13018 */       tokens.nextToken();
/* 13019 */       String pname = "Unknown";
/* 13020 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 13022 */         pname = tokens.nextToken().trim();
/*       */         
/*       */         try {
/* 13025 */           long id = Long.parseLong(pname);
/* 13026 */           if (WurmId.getType(id) == 1) {
/*       */             
/*       */             try {
/*       */               
/* 13030 */               Creature c = Creatures.getInstance().getCreature(id);
/* 13031 */               sendNormalServerMessage("Retrieved the creature.");
/* 13032 */               if (c.getCurrentTile() != null) {
/*       */                 
/* 13034 */                 c.setNewTile(null, 0.0F, true);
/* 13035 */                 sendNormalServerMessage("Set the creature to null tile.");
/*       */               } else {
/*       */                 
/* 13038 */                 sendNormalServerMessage("The creature had null tile.");
/* 13039 */               }  Zones.getZone(c.getTileX(), c.getTileY(), c.isOnSurface()).addCreature(id);
/*       */               
/* 13041 */               sendNormalServerMessage("Added creature to world again.");
/*       */             }
/* 13043 */             catch (NoSuchCreatureException nsc) {
/*       */               
/*       */               try
/*       */               {
/*       */                 
/* 13048 */                 Creatures.getInstance().loadOfflineCreature(id);
/* 13049 */                 sendNormalServerMessage("Load the creature from offline.");
/* 13050 */                 Creature c = Creatures.getInstance().getCreature(id);
/* 13051 */                 if (c.getCurrentTile() != null) {
/*       */                   
/* 13053 */                   c.setNewTile(null, 0.0F, true);
/* 13054 */                   sendNormalServerMessage("Set the creature to null tile.");
/*       */                 } else {
/*       */                   
/* 13057 */                   sendNormalServerMessage("The creature had null tile.");
/* 13058 */                 }  Zones.getZone(c.getTileX(), c.getTileY(), c.isOnSurface()).addCreature(id);
/* 13059 */                 sendNormalServerMessage("Added creature to world again.");
/*       */               }
/* 13061 */               catch (NoSuchCreatureException nsc1)
/*       */               {
/* 13063 */                 sendNormalServerMessage("Failed to load it from offline.");
/* 13064 */                 sendNormalServerMessage(nsc1.getMessage());
/*       */               }
/*       */             
/* 13067 */             } catch (Exception ex) {
/*       */               
/* 13069 */               sendNormalServerMessage(ex.getMessage());
/*       */             }
/*       */           
/*       */           }
/* 13073 */         } catch (Exception ex) {
/*       */           
/* 13075 */           pname = LoginHandler.raiseFirstLetter(pname);
/* 13076 */           PlayerInfo pinf = PlayerInfoFactory.createPlayerInfo(pname);
/* 13077 */           if (pinf != null) {
/*       */             
/* 13079 */             pinf.loaded = false;
/*       */             
/*       */             try {
/* 13082 */               pinf.load();
/* 13083 */               sendNormalServerMessage("Reloaded " + pname + '.');
/* 13084 */               WcRefreshCommand wcr = new WcRefreshCommand(WurmId.getNextWCCommandId(), pname);
/*       */               
/* 13086 */               wcr.sendToLoginServer();
/*       */             }
/* 13088 */             catch (IOException iuox) {
/*       */               
/* 13090 */               sendNormalServerMessage("Exception when reloading " + pname + '.');
/*       */             }
/*       */           
/*       */           } else {
/*       */             
/* 13095 */             sendNormalServerMessage(pname + " could not be found.");
/*       */           } 
/*       */         } 
/*       */       } else {
/*       */         
/* 13100 */         sendNormalServerMessage("Syntax: #reload <creatureId or playername>");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageRedeem(int power) {
/* 13109 */     if (power >= 3) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13118 */       RedeemQuestion rq = new RedeemQuestion((Creature)this.player, "Redeem inventory", "Who do you wish to redeem items from?");
/*       */       
/* 13120 */       rq.sendQuestion();
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageAnnounce(String message, int power) {
/* 13130 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13139 */       StringTokenizer tokens = new StringTokenizer(message);
/* 13140 */       tokens.nextToken();
/* 13141 */       String toSend = "";
/* 13142 */       if (tokens.hasMoreTokens())
/* 13143 */         toSend = tokens.nextToken(); 
/* 13144 */       while (tokens.hasMoreTokens())
/* 13145 */         toSend = toSend + ' ' + tokens.nextToken(); 
/* 13146 */       Message mess = new Message((Creature)this.player, (byte)1, ":Event", "<" + this.player.getName() + "> " + toSend);
/*       */       
/* 13148 */       Server.getInstance().addMessage(mess);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageBroadcast(String message, int power) {
/* 13158 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13167 */       StringTokenizer tokens = new StringTokenizer(message);
/* 13168 */       tokens.nextToken();
/* 13169 */       String toSend = "";
/* 13170 */       if (tokens.hasMoreTokens())
/* 13171 */         toSend = tokens.nextToken(); 
/* 13172 */       while (tokens.hasMoreTokens())
/* 13173 */         toSend = toSend + ' ' + tokens.nextToken(); 
/* 13174 */       Message mess = new Message((Creature)this.player, (byte)5, ":Event", "<" + this.player.getName() + "> " + toSend);
/*       */       
/* 13176 */       Server.getInstance().addMessage(mess);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageTestAffinity(int power) {
/* 13185 */     if (power >= 3 && Servers.localServer.testServer) {
/*       */       
/* 13187 */       int nextaff = 1;
/* 13188 */       Skill skill = null;
/* 13189 */       int sknum = SkillSystem.getRandomSkillNum();
/*       */       
/*       */       try {
/* 13192 */         skill = this.player.getSkills().getSkill(sknum);
/* 13193 */         nextaff = skill.affinity + 1;
/*       */       }
/* 13195 */       catch (NoSuchSkillException noSuchSkillException) {
/*       */ 
/*       */       
/*       */       }
/* 13199 */       catch (Exception exception) {}
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13204 */       Affinities.setAffinity(this.player.getWurmId(), sknum, nextaff, false);
/* 13205 */       if (nextaff > 1) {
/* 13206 */         this.player.setAffString("You realize that your affinity for " + 
/* 13207 */             SkillSystem.getNameFor(sknum).toLowerCase() + " has grown stronger.");
/*       */       } else {
/* 13209 */         this.player.setAffString("You realize that you have developed an affinity for " + 
/* 13210 */             SkillSystem.getNameFor(sknum).toLowerCase() + ".");
/*       */       } 
/*       */     } 
/*       */   }
/*       */   
/*       */   private void handleHashMessageTestFragments(String message, int power) {
/* 13216 */     if (power >= 5 && Servers.localServer.testServer) {
/*       */       
/* 13218 */       StringTokenizer tokens = new StringTokenizer(message);
/* 13219 */       tokens.nextToken();
/*       */       
/* 13221 */       int identifyPower = -1;
/* 13222 */       if (tokens.hasMoreTokens()) {
/* 13223 */         identifyPower = Integer.parseInt(tokens.nextToken());
/*       */       }
/* 13225 */       for (int i = 0; i < 3; i++) {
/*       */ 
/*       */         
/*       */         try {
/* 13229 */           Item it = ItemFactory.createItem(1307, 90.0F, "System");
/* 13230 */           it.setRealTemplate(8);
/* 13231 */           it.setAuxData((byte)1);
/* 13232 */           if (identifyPower > 0) {
/*       */             
/* 13234 */             it.setData1(1);
/* 13235 */             it.setData2(identifyPower);
/*       */           } 
/*       */           
/* 13238 */           this.player.getInventory().insertItem(it);
/*       */         }
/* 13240 */         catch (FailedException|NoSuchTemplateException failedException) {}
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageTestColors(String message, int power) {
/* 13253 */     if (power >= 3 && Servers.isThisATestServer()) {
/*       */       
/* 13255 */       StringTokenizer tokens = new StringTokenizer(message);
/* 13256 */       tokens.nextToken();
/* 13257 */       String toSend = "";
/*       */       
/* 13259 */       List<MulticolorLineSegment> msla = new ArrayList<>();
/* 13260 */       MulticolorLineSegment msl = new MulticolorLineSegment(this.player.getName(), (byte)3);
/*       */       
/* 13262 */       msla.add(msl);
/* 13263 */       while (tokens.hasMoreTokens()) {
/*       */         
/* 13265 */         toSend = tokens.nextToken();
/* 13266 */         msla.add(new MulticolorLineSegment(toSend + " ", 
/* 13267 */               (byte)Server.rand.nextInt(15)));
/*       */       } 
/* 13269 */       sendColoredMessage("Testing colors", msla);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageHelp(int power) {
/* 13278 */     if (power >= 1 || this.player.mayMute() || this.player.mayAppointPlayerAssistant())
/*       */     {
/* 13280 */       sendDeityHelp(power);
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageUniques(int power) {
/* 13289 */     if (power >= 5) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13298 */       Creature[] crets = Creatures.getInstance().getCreatures();
/* 13299 */       int nums = 0;
/* 13300 */       for (int x = 0; x < crets.length; x++) {
/*       */         
/* 13302 */         if (crets[x].isUnique()) {
/*       */           
/* 13304 */           nums++;
/* 13305 */           sendNormalServerMessage(crets[x].getName() + " at " + crets[x].getTileX() + ", " + crets[x]
/* 13306 */               .getTileY() + " z=" + crets[x].getPositionZ());
/*       */         } 
/*       */       } 
/* 13309 */       sendNormalServerMessage("Found " + nums + " creatures.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageTilePollLog(int power) {
/* 13318 */     if (power >= 5) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13327 */       TilePoller.logTilePolling = !TilePoller.logTilePolling;
/* 13328 */       TilePoller.sentTilePollMessages = 0;
/* 13329 */       sendNormalServerMessage("TilePollLogging is now " + TilePoller.logTilePolling);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageInvulnerable(int power) {
/* 13338 */     if (power >= 3)
/*       */     {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13347 */       if (this.player.GMINVULN) {
/*       */         
/* 13349 */         this.player.GMINVULN = false;
/* 13350 */         sendNormalServerMessage("You are now no longer invulnerable.");
/*       */       }
/*       */       else {
/*       */         
/* 13354 */         this.player.GMINVULN = true;
/* 13355 */         sendNormalServerMessage("You are now invulnerable again.");
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageChangeEmail(String message, int power) {
/* 13366 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13375 */       StringTokenizer tokens = new StringTokenizer(message);
/* 13376 */       tokens.nextToken();
/* 13377 */       String pname = "Unknown";
/* 13378 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 13380 */         pname = tokens.nextToken().trim();
/* 13381 */         pname = LoginHandler.raiseFirstLetter(pname);
/* 13382 */         String email = "Unknown";
/* 13383 */         if (tokens.hasMoreTokens()) {
/*       */           
/* 13385 */           email = tokens.nextToken().trim();
/* 13386 */           sendNormalServerMessage("You try to change the email of " + pname + " to '" + email + "' - result:");
/*       */           
/* 13388 */           LoginServerWebConnection lsw = new LoginServerWebConnection();
/* 13389 */           sendNormalServerMessage(lsw.changeEmail(this.player.getName(), pname, email, null, this.player
/* 13390 */                 .getPower(), (this.player.getSaveFile()).pwQuestion, (this.player.getSaveFile()).pwAnswer));
/* 13391 */           if (this.player.getLogger() != null) {
/* 13392 */             this.player.getLogger().log(Level.INFO, this.player
/* 13393 */                 .getName() + " changed the email of " + pname + " to " + email);
/*       */           }
/*       */         } else {
/* 13396 */           sendNormalServerMessage("Syntax: #changeemail <name> <newemail>");
/*       */         } 
/*       */       } else {
/* 13399 */         sendNormalServerMessage("Syntax: #changeemail <name> <newemail>");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageChangePassword(String message, int power) {
/* 13409 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13418 */       StringTokenizer tokens = new StringTokenizer(message);
/* 13419 */       tokens.nextToken();
/* 13420 */       String pname = "Unknown";
/* 13421 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 13423 */         pname = tokens.nextToken().trim();
/* 13424 */         pname = LoginHandler.raiseFirstLetter(pname);
/* 13425 */         String password = "Unknown";
/* 13426 */         if (tokens.hasMoreTokens()) {
/*       */           
/* 13428 */           password = tokens.nextToken().trim();
/* 13429 */           if (password.length() >= 6) {
/*       */             
/* 13431 */             sendNormalServerMessage("You try to change the password of " + pname + " to '" + password + "' - result:");
/*       */             
/* 13433 */             LoginServerWebConnection lsw = new LoginServerWebConnection();
/* 13434 */             sendNormalServerMessage(lsw.changePassword(this.player.getName(), pname, password, this.player
/* 13435 */                   .getPower()));
/* 13436 */             if (this.player.getLogger() != null) {
/* 13437 */               this.player.getLogger().log(Level.INFO, this.player
/* 13438 */                   .getName() + " changed the password of " + pname);
/*       */             }
/*       */           } else {
/* 13441 */             sendNormalServerMessage("The password needs at least 6 characters.");
/*       */           } 
/*       */         } else {
/* 13444 */           sendNormalServerMessage("Syntax: #changepassword <name> <newpassword>");
/*       */         } 
/*       */       } else {
/* 13447 */         sendNormalServerMessage("Syntax: #changepassword <name> <newpassword>");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageToggleCA(String message) {
/* 13457 */     if (this.player.mayAppointPlayerAssistant()) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13466 */       StringTokenizer tokens = new StringTokenizer(message);
/* 13467 */       tokens.nextToken();
/* 13468 */       String pname = "Unknown";
/* 13469 */       pname = tokens.nextToken().trim();
/* 13470 */       Players.appointCA((Creature)this.player, pname);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageSetMuter(String message, int power) {
/* 13481 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13490 */       StringTokenizer tokens = new StringTokenizer(message);
/* 13491 */       tokens.nextToken();
/* 13492 */       String pname = "Unknown";
/* 13493 */       pname = tokens.nextToken().trim();
/* 13494 */       Players.appointCM((Creature)this.player, pname);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessagePrintRanks(int power) {
/* 13504 */     if (power >= 5)
/*       */     {
/* 13506 */       Players.printRanks();
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageShowMuted(int power) {
/* 13515 */     if (power >= 2 || this.player.mayMute()) {
/*       */       
/* 13517 */       Ban[] bips = Players.getInstance().getPlayersMuted();
/* 13518 */       if (bips.length > 0) {
/*       */         
/* 13520 */         sendNormalServerMessage("PLAYERS MUTED:");
/* 13521 */         for (int x = 0; x < bips.length; x++) {
/*       */           
/* 13523 */           long daytime = Math.max(0L, bips[x].getExpiry() - System.currentTimeMillis());
/* 13524 */           sendNormalServerMessage(bips[x].getIdentifier() + ", " + Server.getTimeFor(daytime) + ", " + bips[x]
/* 13525 */               .getReason());
/*       */         } 
/*       */       } else {
/*       */         
/* 13529 */         sendNormalServerMessage("NO PLAYERS MUTED.");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageShowMuters(int power) {
/* 13538 */     if (power >= 2 || this.player.mayMute()) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13547 */       String[] muters = Players.getInstance().getMuters();
/* 13548 */       if (muters.length > 0) {
/*       */         
/* 13550 */         sendNormalServerMessage("These people may mute other players except the gms:");
/* 13551 */         for (int x = 0; x < muters.length; x++)
/*       */         {
/* 13553 */           sendNormalServerMessage(muters[x]);
/*       */         }
/*       */       } else {
/*       */         
/* 13557 */         sendNormalServerMessage("Only the gms may mute other players.");
/*       */       } 
/*       */     } 
/*       */   }
/*       */   
/*       */   private void handleHashMessageShowDevTalkers(int power) {
/* 13563 */     if (power >= 2 || this.player.mayHearDevTalk()) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13572 */       String[] devTalkers = Players.getInstance().getDevTalkers();
/* 13573 */       if (devTalkers.length > 0) {
/*       */         
/* 13575 */         sendNormalServerMessage("These people may hear GM Tab:");
/* 13576 */         for (int x = 0; x < devTalkers.length; x++)
/*       */         {
/* 13578 */           sendNormalServerMessage(devTalkers[x]);
/*       */         }
/*       */       } else {
/*       */         
/* 13582 */         sendNormalServerMessage("Noone can hear GM Tab?");
/*       */       } 
/*       */     } 
/*       */   }
/*       */   
/*       */   private void handleHashMessageShowCas(int power) {
/* 13588 */     if (power >= 2 || this.player.mayMute()) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13597 */       String[] cas = Players.getInstance().getCAs();
/* 13598 */       if (cas.length > 0) {
/*       */         
/* 13600 */         sendNormalServerMessage("These people are CAs:");
/* 13601 */         for (int x = 0; x < cas.length; x++)
/*       */         {
/* 13603 */           sendNormalServerMessage(cas[x]);
/*       */         }
/*       */       } else {
/*       */         
/* 13607 */         sendNormalServerMessage("No CAs?");
/*       */       } 
/*       */     } 
/*       */   }
/*       */   
/*       */   private void handleHashMessageShowHeros(String message, int power) {
/* 13613 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13622 */       StringTokenizer tokens = new StringTokenizer(message);
/* 13623 */       tokens.nextToken();
/* 13624 */       byte checkForPower = 1;
/*       */       
/* 13626 */       if (tokens.hasMoreTokens()) {
/*       */         
/*       */         try {
/*       */           
/* 13630 */           checkForPower = Byte.parseByte(tokens.nextToken().trim());
/*       */         }
/* 13632 */         catch (Exception exception) {}
/*       */       }
/*       */ 
/*       */ 
/*       */       
/* 13637 */       if (checkForPower < 0 || checkForPower > 5) {
/*       */         
/* 13639 */         sendSafeServerMessage("Power must be between 0 and 5 inclusive.");
/*       */       }
/* 13641 */       else if (power >= checkForPower) {
/*       */ 
/*       */         
/* 13644 */         sendSafeServerMessage(WcGetHeroes.getHeroes(checkForPower));
/*       */ 
/*       */         
/* 13647 */         WcGetHeroes wcg = new WcGetHeroes(this.player.getWurmId(), checkForPower);
/* 13648 */         wcg.sendFromLoginServer();
/*       */       } else {
/*       */         
/* 13651 */         sendSafeServerMessage("You are not allowed to check for that power.");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageUnmute(String message, int power) {
/* 13662 */     if (power >= 2 || this.player.mayMute()) {
/*       */       
/* 13664 */       StringTokenizer tokens = new StringTokenizer(message);
/* 13665 */       tokens.nextToken();
/* 13666 */       String pname = "Unknown";
/* 13667 */       pname = tokens.nextToken().trim();
/* 13668 */       pname = LoginHandler.raiseFirstLetter(pname);
/*       */       
/* 13670 */       Player p = null;
/*       */ 
/*       */       
/*       */       try {
/*       */         try {
/* 13675 */           PlayerInfo pinf = PlayerInfoFactory.createPlayerInfo(pname);
/* 13676 */           pinf.load();
/* 13677 */           if (pinf.wurmId > 0L) {
/*       */             
/* 13679 */             pinf.setMuted(false, "", 0L);
/* 13680 */             sendNormalServerMessage("You have given " + pname + " the voice back.");
/*       */           } else {
/*       */             
/* 13683 */             sendNormalServerMessage("No player found with the name " + pname);
/*       */           } 
/* 13685 */         } catch (IOException iOException) {}
/*       */ 
/*       */ 
/*       */         
/* 13689 */         p = Players.getInstance().getPlayer(pname);
/* 13690 */         if (p != null) {
/* 13691 */           p.getCommunicator().sendAlertServerMessage("You have been given your voice back and can shout again.");
/*       */         }
/*       */       }
/* 13694 */       catch (NoSuchPlayerException noSuchPlayerException) {}
/*       */ 
/*       */ 
/*       */       
/* 13698 */       sendNormalServerMessage("Unmuting globally.");
/*       */       
/* 13700 */       WcGlobalModeration wcgm = new WcGlobalModeration(WurmId.getNextWCCommandId(), this.player.getName(), (byte)this.player.getPower(), false, true, false, false, false, 0, 0, pname, "");
/*       */       
/* 13702 */       if (Servers.localServer.LOGINSERVER) {
/*       */         
/* 13704 */         wcgm.sendFromLoginServer();
/* 13705 */         Trello.addMessage(this.player.getName(), pname, "", 0);
/*       */       } else {
/*       */         
/* 13708 */         wcgm.sendToLoginServer();
/* 13709 */       }  Players.addMgmtMessage(this.player.getName(), "unmutes " + pname);
/* 13710 */       Message mess = new Message((Creature)this.player, (byte)9, "MGMT", "<" + this.player.getName() + "> unmutes " + pname, muteMsgRed, muteMsgGreen, muteMsgBlue);
/*       */ 
/*       */       
/* 13713 */       Server.getInstance().addMessage(mess);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageCheckAffinity(String message, int power) {
/* 13723 */     if (power >= 5) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13732 */       StringTokenizer tokens = new StringTokenizer(message);
/*       */       
/* 13734 */       tokens.nextToken();
/* 13735 */       String pname = "Unknown";
/*       */       
/*       */       try {
/* 13738 */         pname = tokens.nextToken().trim();
/* 13739 */         pname = LoginHandler.raiseFirstLetter(pname);
/* 13740 */         Player p = Players.getInstance().getPlayer(pname);
/*       */         
/* 13742 */         Affinity[] affs = Affinities.getAffinities(p.getWurmId());
/* 13743 */         if (affs.length == 0) {
/* 13744 */           sendNormalServerMessage(p.getName() + " has no affinity.");
/*       */         } else {
/* 13746 */           for (int x = 0; x < affs.length; x++)
/*       */           {
/* 13748 */             sendNormalServerMessage(SkillSystem.getNameFor((affs[x]).skillNumber) + ':' + (affs[x]).number);
/*       */           }
/*       */         }
/*       */       
/* 13752 */       } catch (NoSuchPlayerException nsp) {
/*       */         
/* 13754 */         sendSafeServerMessage("No player found with the name " + pname);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageMuteWarn(String message, int power) {
/* 13765 */     if (power >= 2 || this.player.mayMute()) {
/*       */       
/* 13767 */       StringTokenizer tokens = new StringTokenizer(message);
/*       */       
/* 13769 */       tokens.nextToken();
/* 13770 */       String pname = "Unknown";
/* 13771 */       pname = tokens.nextToken().trim();
/* 13772 */       pname = LoginHandler.raiseFirstLetter(pname);
/* 13773 */       StringBuilder reason = new StringBuilder();
/* 13774 */       while (tokens.hasMoreTokens()) {
/*       */         
/* 13776 */         reason.append(tokens.nextToken());
/* 13777 */         reason.append(' ');
/*       */       } 
/* 13779 */       String reas = reason.toString();
/*       */       
/*       */       try {
/* 13782 */         Player p = Players.getInstance().getPlayer(pname);
/* 13783 */         if (this.player.getLogger() != null)
/* 13784 */           this.player.getLogger().log(Level.INFO, this.player
/* 13785 */               .getName() + " mutewarns " + pname + " (" + reas + ")"); 
/* 13786 */         Players.addMgmtMessage(this.player.getName(), "mutewarns " + pname + " (" + reas + ")");
/* 13787 */         Message mess = new Message((Creature)this.player, (byte)9, "MGMT", "<" + this.player.getName() + "> mutewarns " + pname + " (" + reas + ")", muteMsgRed, muteMsgGreen, muteMsgBlue);
/*       */ 
/*       */         
/* 13790 */         WcGlobalModeration wcgm = new WcGlobalModeration(WurmId.getNextWCCommandId(), this.player.getName(), (byte)this.player.getPower(), false, false, true, false, false, 0, 0, pname, reas);
/*       */         
/* 13792 */         if (Servers.localServer.LOGINSERVER) {
/*       */           
/* 13794 */           wcgm.sendFromLoginServer();
/* 13795 */           Trello.addMessage(this.player.getName(), pname, reas, 0);
/*       */         } else {
/*       */           
/* 13798 */           wcgm.sendToLoginServer();
/* 13799 */         }  Server.getInstance().addMessage(mess);
/* 13800 */         if (p.getPower() <= power)
/*       */         {
/* 13802 */           p.getCommunicator()
/* 13803 */             .sendAlertServerMessage(this.player
/* 13804 */               .getName() + " issues a warning that you may be muted. Be silent for a while and try to understand why or change the subject of your conversation please.");
/*       */           
/* 13806 */           if (!reas.isEmpty())
/* 13807 */             p.getCommunicator().sendAlertServerMessage("The reason for this is '" + reas + "'"); 
/* 13808 */           this.player.getCommunicator().sendSafeServerMessage("You warn " + p
/* 13809 */               .getName() + " that " + p.getHeSheItString() + " may be muted.");
/* 13810 */           this.player.getCommunicator().sendSafeServerMessage("The reason you gave was '" + reas + "'.");
/*       */         
/*       */         }
/*       */         else
/*       */         {
/* 13815 */           sendNormalServerMessage("You threaten " + pname + " with muting!");
/* 13816 */           p.getCommunicator().sendNormalServerMessage(this.player
/* 13817 */               .getName() + " tried to threaten you with muting!");
/* 13818 */           if (!reas.isEmpty()) {
/* 13819 */             p.getCommunicator().sendNormalServerMessage("The formal reason for this is '" + reas + "'");
/*       */           }
/*       */         }
/*       */       
/* 13823 */       } catch (NoSuchPlayerException nsp) {
/*       */         
/* 13825 */         sendSafeServerMessage("No player found with the name " + pname + ". Warning globally.");
/* 13826 */         Players.addMgmtMessage(this.player.getName(), "mutewarns " + pname + " (" + reas + ")");
/* 13827 */         Message mess = new Message((Creature)this.player, (byte)9, "MGMT", "<" + this.player.getName() + "> mutewarns " + pname + " (" + reas + ")", muteMsgRed, muteMsgGreen, muteMsgBlue);
/*       */         
/* 13829 */         Server.getInstance().addMessage(mess);
/*       */         
/* 13831 */         WcGlobalModeration wcgm = new WcGlobalModeration(WurmId.getNextWCCommandId(), this.player.getName(), (byte)this.player.getPower(), false, false, true, false, false, 0, 0, pname, reas);
/*       */         
/* 13833 */         if (Servers.localServer.LOGINSERVER) {
/*       */           
/* 13835 */           wcgm.sendFromLoginServer();
/* 13836 */           Trello.addMessage(this.player.getName(), pname, reas, 0);
/*       */         } else {
/*       */           
/* 13839 */           wcgm.sendToLoginServer();
/* 13840 */         }  Players.addMgmtMessage(this.player.getName(), "mutewarns " + pname + " (" + reas + ")");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageItemPosition(String message, int power) {
/* 13851 */     if (power >= 3) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 13860 */       StringTokenizer tokens = new StringTokenizer(message);
/* 13861 */       tokens.nextToken();
/* 13862 */       long wurmid = -1L;
/* 13863 */       if (tokens.hasMoreTokens()) {
/*       */ 
/*       */         
/*       */         try {
/* 13867 */           String wid = tokens.nextToken().trim();
/* 13868 */           wurmid = Long.parseLong(wid);
/* 13869 */           Item checked = Items.getItem(wurmid);
/* 13870 */           long owner = checked.getOwnerId();
/* 13871 */           if (owner == -10L) {
/*       */             
/* 13873 */             sendNormalServerMessage(checked.getName() + " is at " + (
/* 13874 */                 (int)checked.getPosX() >> 2) + ',' + (
/* 13875 */                 (int)checked.getPosY() >> 2) + " surfaced=" + checked.isOnSurface() + '.');
/*       */ 
/*       */             
/*       */             try {
/* 13879 */               owner = checked.lastOwner;
/* 13880 */               if (owner != -10L)
/*       */               {
/* 13882 */                 Creature c = Server.getInstance().getCreature(owner);
/* 13883 */                 sendNormalServerMessage(checked.getName() + " was dropped by " + c
/* 13884 */                     .getName() + '.');
/*       */               }
/*       */             
/* 13887 */             } catch (NoSuchPlayerException nsp) {
/*       */               
/*       */               try
/*       */               {
/* 13891 */                 PlayerInfo pinf = PlayerInfoFactory.createPlayerInfo(
/* 13892 */                     Players.getInstance().getNameFor(owner));
/* 13893 */                 pinf.load();
/* 13894 */                 sendNormalServerMessage(checked.getName() + " was dropped by " + pinf
/* 13895 */                     .getName() + '.');
/*       */               }
/* 13897 */               catch (NoSuchPlayerException nsp2)
/*       */               {
/* 13899 */                 sendNormalServerMessage(checked.getName() + " was dropped by unknown player or creature.");
/*       */               
/*       */               }
/* 13902 */               catch (IOException iox)
/*       */               {
/* 13904 */                 sendNormalServerMessage("An IO error occured when trying to retrieve the last owner for this object.");
/*       */               }
/*       */             
/* 13907 */             } catch (NoSuchCreatureException nsc) {
/*       */               
/* 13909 */               sendNormalServerMessage(checked.getName() + " is carried by an unknown, maybe dead creature.");
/*       */             } 
/*       */           } else {
/*       */ 
/*       */             
/*       */             try {
/*       */ 
/*       */               
/* 13917 */               Creature c = Server.getInstance().getCreature(owner);
/* 13918 */               sendNormalServerMessage(checked.getName() + " is carried by " + c.getName() + " at " + c
/* 13919 */                   .getTileX() + ',' + c.getTileY() + " surfaced=" + c
/* 13920 */                   .isOnSurface() + '.');
/*       */             }
/* 13922 */             catch (NoSuchPlayerException nsp) {
/*       */               
/*       */               try
/*       */               {
/* 13926 */                 PlayerInfo pinf = PlayerInfoFactory.createPlayerInfo(
/* 13927 */                     Players.getInstance().getNameFor(owner));
/* 13928 */                 pinf.load();
/* 13929 */                 sendNormalServerMessage(checked.getName() + " is carried by " + pinf
/* 13930 */                     .getName() + '.');
/*       */               }
/* 13932 */               catch (NoSuchPlayerException nsp2)
/*       */               {
/* 13934 */                 sendNormalServerMessage(checked.getName() + " is carried by unknown player with id " + owner + ". This is weird.");
/*       */ 
/*       */               
/*       */               }
/* 13938 */               catch (IOException iox)
/*       */               {
/* 13940 */                 sendNormalServerMessage("An IO error occured when trying to retrieve the owner for this object.");
/*       */               }
/*       */             
/* 13943 */             } catch (NoSuchCreatureException nsc) {
/*       */               
/* 13945 */               sendNormalServerMessage(checked.getName() + " is carried by an unknown, maybe dead creature.");
/*       */             }
/*       */           
/*       */           }
/*       */         
/* 13950 */         } catch (NoSuchItemException ex) {
/*       */           
/* 13952 */           sendNormalServerMessage(wurmid + " could not be found, probably deleted.");
/*       */         } 
/*       */       } else {
/*       */         
/* 13956 */         sendNormalServerMessage("Syntax: #itempos <id>");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessagePLimit(String message, int power) {
/* 13966 */     if (power >= 2) {
/*       */       
/* 13968 */       if (!Servers.localServer.playerLimitOverridable) {
/*       */         
/* 13970 */         sendNormalServerMessage("The player limit was set through command line so it can't be overriden from within the game.");
/*       */         return;
/*       */       } 
/* 13973 */       StringTokenizer tokens = new StringTokenizer(message);
/* 13974 */       tokens.nextToken();
/* 13975 */       int limit = Servers.localServer.pLimit;
/* 13976 */       if (tokens.hasMoreTokens()) {
/*       */ 
/*       */         
/*       */         try {
/* 13980 */           String limp = tokens.nextToken().trim();
/* 13981 */           logInfo(this.player.getName() + " setting playerlimit " + limp + '.');
/* 13982 */           sendNormalServerMessage("The old limit was " + limit + " - new will be " + limp + " " + '.');
/*       */           
/* 13984 */           limit = Integer.parseInt(limp);
/* 13985 */           Servers.localServer.pLimit = limit;
/* 13986 */           Servers.localServer.saveNewGui(Servers.localServer.id);
/*       */         }
/* 13988 */         catch (Exception ex) {
/*       */           
/* 13990 */           sendNormalServerMessage("You need to provide a number..");
/*       */         } 
/*       */       } else {
/*       */         
/* 13994 */         sendNormalServerMessage("The limit is " + limit + '.');
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageAddFakeMoney(String message, int power) {
/* 14004 */     if (power >= 3 && Servers.localServer.testServer) {
/*       */       
/* 14006 */       StringTokenizer tokens = new StringTokenizer(message);
/* 14007 */       tokens.nextToken();
/* 14008 */       long amount = 0L;
/*       */       
/*       */       try {
/* 14011 */         String am = tokens.nextToken().trim();
/* 14012 */         amount = Math.abs(Long.parseLong(am));
/* 14013 */         Change c = Economy.getEconomy().getChangeFor(amount);
/* 14014 */         sendNormalServerMessage("Creating amount " + c.getChangeString());
/* 14015 */         Item[] coinsArr = Economy.getEconomy().getCoinsFor(amount);
/* 14016 */         long owner = -10L;
/* 14017 */         long parent = -10L;
/* 14018 */         if (tokens.hasMoreTokens()) {
/*       */           
/* 14020 */           String own = tokens.nextToken().trim();
/* 14021 */           owner = Long.parseLong(own);
/* 14022 */           if (tokens.hasMoreTokens()) {
/*       */             
/* 14024 */             String par = tokens.nextToken().trim();
/* 14025 */             parent = Long.parseLong(par);
/*       */           } 
/*       */         } 
/* 14028 */         for (int x = 0; x < coinsArr.length; x++)
/*       */         {
/* 14030 */           if (owner > -10L)
/* 14031 */             coinsArr[x].setOwnerId(owner); 
/* 14032 */           if (parent > -10L)
/* 14033 */             coinsArr[x].setParentId(parent, this.player.isOnSurface()); 
/* 14034 */           sendAddToInventory(coinsArr[x], -1L, -1L, coinsArr[x]
/* 14035 */               .getValue());
/*       */         }
/*       */       
/* 14038 */       } catch (Exception ex) {
/*       */         
/* 14040 */         sendNormalServerMessage("Fail: " + ex.getMessage());
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageResetGuards(int power) {
/* 14050 */     if (power >= 5) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 14059 */       int nums = Creatures.getInstance().resetGuardSkills();
/* 14060 */       this.player.getCommunicator().sendNormalServerMessage("Reset " + nums + " guards skills.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageNoXmas(int power) {
/* 14069 */     if (power >= 5)
/*       */     {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 14078 */       Zones.removeChristmasEffect((Creature)this.player);
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageXmasLight(int power) {
/* 14087 */     if (power >= 5) {
/*       */       
/*       */       try {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */         
/* 14098 */         Item temp = ItemFactory.createItem(344, 1.0F, this.player.getPosX(), this.player
/* 14099 */             .getPosY(), 180.0F, true, (byte)0, -10L, null);
/*       */         
/* 14101 */         Zones.sendChristmasEffect((Creature)this.player, temp);
/*       */       }
/* 14103 */       catch (Exception ex22) {
/*       */         
/* 14105 */         sendAlertServerMessage("Failed to create temp marker: " + ex22.getMessage());
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageToggleEpic(int power) {
/* 14115 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 14124 */       PortalQuestion.epicPortalsEnabled = !PortalQuestion.epicPortalsEnabled;
/* 14125 */       WcOpenEpicPortal wccom = new WcOpenEpicPortal(WurmId.getNextWCCommandId(), PortalQuestion.epicPortalsEnabled);
/*       */       
/* 14127 */       if (Servers.localServer.LOGINSERVER) {
/* 14128 */         wccom.sendFromLoginServer();
/*       */       } else {
/* 14130 */         wccom.sendToLoginServer();
/* 14131 */       }  sendNormalServerMessage("Okay, portals enabled=" + PortalQuestion.epicPortalsEnabled + ".");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageMac(String message, int power) {
/* 14140 */     if (power > 1) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 14149 */       StringTokenizer tokens = new StringTokenizer(message);
/* 14150 */       tokens.nextToken();
/* 14151 */       String name = "";
/* 14152 */       if (tokens.hasMoreTokens()) {
/* 14153 */         name = tokens.nextToken();
/*       */       }
/* 14155 */       if (name != null && !name.isEmpty()) {
/*       */         
/*       */         try {
/*       */           
/* 14159 */           Player p = Players.getInstance().getPlayer(LoginHandler.raiseFirstLetter(name));
/* 14160 */           sendNormalServerMessage(p.getName() + " mac address=" + (p.getCommunicator()).macAddr);
/*       */         }
/* 14162 */         catch (NoSuchPlayerException ex) {
/*       */           
/* 14164 */           sendNormalServerMessage("No such player: " + name);
/*       */         } 
/*       */       }
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageResetPlayer(String message, int power) {
/* 14177 */     if (power >= 3) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 14186 */       StringTokenizer tokens = new StringTokenizer(message);
/* 14187 */       tokens.nextToken();
/* 14188 */       String name = "";
/* 14189 */       if (tokens.hasMoreTokens())
/* 14190 */         name = tokens.nextToken(); 
/* 14191 */       PlayerInfo p = PlayerInfoFactory.createPlayerInfo(name);
/*       */       
/*       */       try {
/* 14194 */         p.load();
/* 14195 */         if (p.wurmId > 0L)
/*       */         {
/* 14197 */           Players.getInstance().resetPlayer(p.wurmId);
/* 14198 */           WcResetCommand wccom = new WcResetCommand(WurmId.getNextWCCommandId(), p.wurmId);
/* 14199 */           wccom.sendToLoginServer();
/* 14200 */           sendNormalServerMessage("Okay, reset " + p.getName() + ". Skills are at max 20 and no realdeath anymore.");
/*       */ 
/*       */           
/*       */           try {
/* 14204 */             Player pla = Players.getInstance().getPlayer(p.wurmId);
/* 14205 */             pla.getCommunicator().sendAlertServerMessage("Your skills were reset to max 20 and you are no longer a champion.");
/*       */           
/*       */           }
/* 14208 */           catch (NoSuchPlayerException noSuchPlayerException) {}
/*       */         
/*       */         }
/*       */ 
/*       */       
/*       */       }
/* 14214 */       catch (IOException iOException) {}
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageGm(String message, int power) {
/* 14227 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 14236 */       StringTokenizer tokens = new StringTokenizer(message);
/* 14237 */       tokens.nextToken();
/* 14238 */       String toSend = "";
/* 14239 */       if (tokens.hasMoreTokens())
/* 14240 */         toSend = tokens.nextToken(); 
/* 14241 */       while (tokens.hasMoreTokens())
/* 14242 */         toSend = toSend + ' ' + tokens.nextToken(); 
/* 14243 */       if (toSend.trim().length() > 1) {
/*       */         
/* 14245 */         Message mess = new Message((Creature)this.player, (byte)11, "GM", "<" + this.player.getName() + "> " + toSend);
/*       */ 
/*       */         
/* 14248 */         Players.addGmMessage(this.player.getName(), toSend);
/* 14249 */         Server.getInstance().addMessage(mess);
/*       */         
/* 14251 */         WCGmMessage wccom = new WCGmMessage(WurmId.getNextWCCommandId(), this.player.getName(), "(" + Servers.localServer.getAbbreviation() + ") " + toSend, false);
/* 14252 */         if (Servers.localServer.LOGINSERVER) {
/* 14253 */           wccom.sendFromLoginServer();
/*       */         } else {
/* 14255 */           wccom.sendToLoginServer();
/*       */         } 
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageStartY(String message, int power) {
/* 14266 */     if (power >= 3) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 14275 */       StringTokenizer tokens = new StringTokenizer(message);
/* 14276 */       tokens.nextToken();
/* 14277 */       int startY = Servers.localServer.SPAWNPOINTJENNY;
/*       */       
/*       */       try {
/* 14280 */         String sty = tokens.nextToken().trim();
/* 14281 */         logInfo("Setting start tile y to " + sty + '.');
/* 14282 */         sendNormalServerMessage("Setting start tile y to " + sty + '.');
/* 14283 */         startY = Integer.parseInt(sty);
/* 14284 */         Servers.localServer.SPAWNPOINTJENNY = startY;
/* 14285 */         Servers.localServer.updateSpawns();
/*       */       }
/* 14287 */       catch (Exception exception) {}
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageStartX(String message, int power) {
/* 14300 */     if (power >= 3) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 14309 */       StringTokenizer tokens = new StringTokenizer(message);
/* 14310 */       tokens.nextToken();
/* 14311 */       int startX = Servers.localServer.SPAWNPOINTJENNX;
/*       */       
/*       */       try {
/* 14314 */         String stx = tokens.nextToken().trim();
/* 14315 */         logInfo("Setting start tile x to " + stx + '.');
/* 14316 */         sendNormalServerMessage("Setting start tile x to " + stx + '.');
/* 14317 */         startX = Integer.parseInt(stx);
/* 14318 */         Servers.localServer.SPAWNPOINTJENNX = startX;
/*       */         
/* 14320 */         Servers.localServer.updateSpawns();
/*       */       }
/* 14322 */       catch (Exception exception) {}
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageSlate(int power) {
/* 14334 */     if (power >= 5)
/*       */     {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 14343 */       for (int x = 200; x < Zones.worldTileSizeX - 200; x++) {
/*       */         
/* 14345 */         for (int y = 200; y < Zones.worldTileSizeY - 200; y++) {
/*       */           
/* 14347 */           int tile = Server.caveMesh.getTile(x, y);
/* 14348 */           if (Tiles.decodeType(tile) == Tiles.Tile.TILE_CAVE_WALL_MARBLE.id) {
/*       */             
/* 14350 */             sendNormalServerMessage("Marble at " + x + "," + y);
/*       */           }
/* 14352 */           else if (Tiles.decodeType(tile) == Tiles.Tile.TILE_CAVE_WALL_SLATE.id) {
/*       */             
/* 14354 */             sendNormalServerMessage("Slate at " + x + "," + y);
/*       */           } 
/*       */         } 
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageEnableBoats(int power) {
/* 14366 */     if (power >= 5)
/*       */     {
/* 14368 */       CreationEntryCreator.createBoatEntries();
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageLoadItemFromHell(String message, int power) throws Exception {
/* 14379 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 14388 */       StringTokenizer tokens = new StringTokenizer(message);
/*       */       
/* 14390 */       tokens.nextToken();
/* 14391 */       long itemid = 0L;
/*       */       
/*       */       try {
/* 14394 */         String id = tokens.nextToken().trim();
/*       */         
/* 14396 */         if (this.player.getLogger() != null)
/* 14397 */           this.player.getLogger().log(Level.INFO, this.player
/* 14398 */               .getName() + " trying to load item ." + id + '.'); 
/* 14399 */         itemid = Long.parseLong(id);
/*       */       }
/* 14401 */       catch (Exception exception) {}
/*       */ 
/*       */ 
/*       */       
/* 14405 */       Item toLoad = null;
/*       */       
/*       */       try {
/* 14408 */         toLoad = Items.getItem(itemid);
/*       */       }
/* 14410 */       catch (NoSuchItemException nsi) {
/*       */ 
/*       */         
/*       */         try {
/* 14414 */           DbItem dbItem = new DbItem(itemid);
/* 14415 */           Items.putItem((Item)dbItem);
/* 14416 */           this.player.getCommunicator().sendNormalServerMessage("Tried to load non-loaded item." + itemid + '.');
/*       */         }
/* 14418 */         catch (NoSuchItemException nsii) {
/*       */ 
/*       */           
/*       */           try {
/* 14422 */             DbItem dbItem = new DbItem(itemid, true);
/* 14423 */             Items.putItem((Item)dbItem);
/* 14424 */             this.player.getCommunicator().sendNormalServerMessage("Tried to load frozen item." + itemid + '.');
/*       */           }
/* 14426 */           catch (NoSuchItemException nsi2) {
/*       */             
/* 14428 */             toLoad = null;
/*       */           } 
/*       */         } 
/*       */       } 
/* 14432 */       if (toLoad == null) {
/*       */         
/*       */         try {
/*       */           
/* 14436 */           DbItem dbItem = new DbItem(itemid);
/* 14437 */           Items.putItem((Item)dbItem);
/* 14438 */           this.player.getCommunicator().sendNormalServerMessage("Tried to load non-loaded item." + itemid + '.');
/*       */         }
/* 14440 */         catch (NoSuchItemException nsi) {
/*       */ 
/*       */           
/*       */           try {
/* 14444 */             DbItem dbItem = new DbItem(itemid, true);
/* 14445 */             Items.putItem((Item)dbItem);
/* 14446 */             this.player.getCommunicator().sendNormalServerMessage("Tried to load frozen item." + itemid + '.');
/*       */           }
/* 14448 */           catch (NoSuchItemException nsi2) {
/*       */             
/* 14450 */             toLoad = null;
/*       */           } 
/*       */         } 
/*       */       }
/* 14454 */       if (toLoad != null) {
/*       */         
/* 14456 */         if (toLoad.getTemplateId() == 1310) {
/*       */           
/* 14458 */           sendNormalServerMessage("Stored creature detected, summoning creature instead.");
/* 14459 */           if (toLoad.getParent() != null) {
/*       */             
/* 14461 */             toLoad.getParent().setName("creature cage [Empty]");
/* 14462 */             toLoad.getParent().setAuxData((byte)0);
/* 14463 */             CargoTransportationMethods.updateItemModel(toLoad.getParent());
/*       */           } 
/* 14465 */           Creature getCreature = Creatures.getInstance().getCreature(toLoad.getData());
/* 14466 */           Creatures cstat = Creatures.getInstance();
/* 14467 */           getCreature.getStatus().setDead(false);
/* 14468 */           cstat.removeCreature(getCreature);
/* 14469 */           cstat.addCreature(getCreature, false);
/* 14470 */           getCreature.putInWorld();
/* 14471 */           CreatureBehaviour.blinkTo(getCreature, this.player.getPosX(), this.player.getPosY(), this.player.getLayer(), this.player.getPositionZ(), this.player.getBridgeId(), this.player.getFloorLevel());
/*       */           
/* 14473 */           getCreature.save();
/* 14474 */           getCreature.savePosition(toLoad.getZoneId());
/* 14475 */           Items.destroyItem(toLoad.getWurmId());
/*       */         } 
/* 14477 */         if (toLoad.isRoadMarker())
/* 14478 */           toLoad.setWhatHappened(" loaded from hell by " + this.player.getName()); 
/* 14479 */         toLoad.setIsPlanted(false);
/* 14480 */         toLoad.setTransferred(false);
/* 14481 */         toLoad.setBanked(false);
/* 14482 */         if (!WurmMail.isItemInMail(itemid))
/* 14483 */           toLoad.setMailed(false); 
/* 14484 */         if (toLoad.getZoneId() >= 0) {
/*       */           
/*       */           try {
/*       */             
/* 14488 */             Zone z = Zones.getZone((int)toLoad.getPosX() >> 2, 
/* 14489 */                 (int)toLoad.getPosY() >> 2, toLoad.isOnSurface());
/* 14490 */             z.removeItem(toLoad);
/* 14491 */             sendNormalServerMessage(toLoad.getName() + " (" + itemid + ") was removed from " + (
/* 14492 */                 (int)toLoad.getPosX() >> 2) + ',' + (
/* 14493 */                 (int)toLoad.getPosY() >> 2) + ", surf=" + toLoad.isOnSurface());
/*       */           }
/* 14495 */           catch (NoSuchZoneException nsz) {
/*       */             
/* 14497 */             sendNormalServerMessage(toLoad.getName() + " (" + itemid + ") was not on " + (
/* 14498 */                 (int)toLoad.getPosX() >> 2) + ',' + (
/* 14499 */                 (int)toLoad.getPosY() >> 2) + ", surf=" + toLoad.isOnSurface());
/*       */           } 
/*       */         }
/*       */         
/*       */         try {
/* 14504 */           Item parent = toLoad.getParent();
/* 14505 */           parent.dropItem(itemid, true);
/* 14506 */           sendNormalServerMessage(toLoad.getName() + " (" + itemid + ") was removed from " + parent.getName() + '.');
/*       */         
/*       */         }
/* 14509 */         catch (NoSuchItemException noSuchItemException) {}
/*       */ 
/*       */         
/* 14512 */         if (this.player.getLogger() != null)
/* 14513 */           this.player.getLogger().log(Level.INFO, this.player
/* 14514 */               .getName() + " loaded item " + toLoad.getName() + "( " + itemid + ")."); 
/* 14515 */         this.player.getInventory().insertItem(toLoad);
/*       */       } else {
/*       */         
/* 14518 */         sendNormalServerMessage("Item was null?");
/*       */       } 
/*       */     } 
/*       */   }
/*       */   
/*       */   private void handleHashMessageShowPersonalGoals(String message, int power) {
/* 14524 */     if (power < 4) {
/*       */       return;
/*       */     }
/*       */     
/* 14528 */     if (this.player.getLogger() != null) {
/* 14529 */       this.player.getLogger().info("Show personal goals: " + message);
/*       */     }
/*       */     
/* 14532 */     StringTokenizer tokens = new StringTokenizer(message);
/* 14533 */     tokens.nextToken();
/*       */     
/*       */     try {
/* 14536 */       String name = tokens.nextToken().trim();
/* 14537 */       PlayerInfo player = PlayerInfoFactory.getPlayerInfoWithName(name);
/* 14538 */       if (player == null) {
/*       */         
/* 14540 */         sendNormalServerMessage("No player named \"" + name + "\" found online or offline on this server. Check your spelling. If the spelling is correct, have they been on this server before?");
/*       */         
/*       */         return;
/*       */       } 
/*       */       
/* 14545 */       (new PersonalGoalsListQuestion((Creature)this.player, player.wurmId)).sendQuestion();
/*       */ 
/*       */       
/*       */       return;
/* 14549 */     } catch (Exception ex) {
/*       */       
/* 14551 */       sendNormalServerMessage("Something went wrong with the input.");
/* 14552 */       sendNormalServerMessage(ex.toString());
/*       */       return;
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessageGetAchievementData(String message, int power) {
/* 14559 */     if (power < 2) {
/*       */       return;
/*       */     }
/*       */     
/* 14563 */     if (this.player.getLogger() != null) {
/* 14564 */       this.player.getLogger().info("Get achievement data: " + message);
/*       */     }
/*       */     
/* 14567 */     StringTokenizer tokens = new StringTokenizer(message);
/*       */     
/* 14569 */     tokens.nextToken();
/*       */     
/*       */     try {
/* 14572 */       String name = tokens.nextToken().trim();
/*       */       
/* 14574 */       PlayerInfo player = PlayerInfoFactory.getPlayerInfoWithName(name);
/* 14575 */       if (player == null) {
/*       */         
/* 14577 */         sendNormalServerMessage("No player named \"" + name + "\" found online or offline on this server. Check your spelling. If the spelling is correct, have they been on this server before?");
/*       */         
/*       */         return;
/*       */       } 
/* 14581 */       Achievement[] achs = Achievements.getAchievements(player.wurmId);
/*       */       
/* 14583 */       int target = Integer.parseInt(tokens.nextToken()); Achievement[] arrayOfAchievement1;
/*       */       int i;
/*       */       byte b;
/* 14586 */       for (arrayOfAchievement1 = achs, i = arrayOfAchievement1.length, b = 0; b < i; ) { Achievement a = arrayOfAchievement1[b];
/*       */         
/* 14588 */         if (a.getAchievement() != target) {
/*       */           b++; continue;
/*       */         } 
/* 14591 */         sendNormalServerMessage(name + " has " + a.getCounter() + " of the achievement " + a.getTemplate().getName() + "(" + target + ")");
/*       */         
/*       */         return; }
/*       */       
/* 14595 */       sendNormalServerMessage(name + " seemingly has none of the achievement with the number " + target);
/*       */       
/*       */       return;
/* 14598 */     } catch (Exception ex) {
/*       */       
/* 14600 */       sendNormalServerMessage("Something went wrong with the input.");
/* 14601 */       sendNormalServerMessage(ex.toString());
/*       */       return;
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageCreaturePos(int power) {
/* 14611 */     if (power >= 3) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 14620 */       CreaturePos.logCreaturePos = !CreaturePos.logCreaturePos;
/* 14621 */       sendNormalServerMessage("Creature pos logging enabled=" + CreaturePos.logCreaturePos);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageBoats(int power) {
/* 14642 */     if (power >= 3) {
/*       */       
/* 14644 */       acceptsBoatTransfers = !acceptsBoatTransfers;
/* 14645 */       sendNormalServerMessage("Boat transfers enabled=" + acceptsBoatTransfers);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageLocate(String message, int power) {
/* 14655 */     if (power >= 5) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 14664 */       StringTokenizer tokens = new StringTokenizer(message);
/*       */       
/* 14666 */       tokens.nextToken();
/*       */       
/*       */       try {
/* 14669 */         String name = tokens.nextToken().trim();
/* 14670 */         this.player.getLogger().log(Level.INFO, "Trying to locate " + name + '.');
/* 14671 */         Creature[] crets = Creatures.getInstance().getCreaturesWithName(name);
/* 14672 */         for (int x = 0; x < crets.length;) {
/*       */           
/* 14674 */           if (x < 100) {
/*       */             
/* 14676 */             sendNormalServerMessage(crets[x].getName() + ':' + 
/* 14677 */                 (crets[x].getCurrentTile()).tilex + ", " + (crets[x].getCurrentTile()).tiley);
/*       */ 
/*       */             
/*       */             x++;
/*       */           } 
/*       */         } 
/* 14683 */       } catch (Exception exception) {}
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageLocateHorses(String message, int power) {
/* 14692 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 14701 */       StringTokenizer tokens = new StringTokenizer(message);
/*       */       
/* 14703 */       tokens.nextToken();
/*       */       
/*       */       try {
/* 14706 */         String name = tokens.nextToken().trim();
/* 14707 */         if (name.length() < 5 || name.equalsIgnoreCase("horse")) {
/*       */           
/* 14709 */           sendNormalServerMessage("Name must be longer than 5 and not be 'horse'!");
/*       */         }
/*       */         else {
/*       */           
/* 14713 */           this.player.getLogger().log(Level.INFO, "Trying to locate horse " + name + '.');
/* 14714 */           Creature[] crets = Creatures.getInstance().getHorsesWithName(name);
/* 14715 */           if (crets.length == 0)
/*       */           {
/* 14717 */             sendNormalServerMessage("No horse found with name containing '" + name + "'");
/*       */           }
/*       */           else
/*       */           {
/* 14721 */             for (int x = 0; x < crets.length;) {
/*       */               
/* 14723 */               if (x < 100) {
/*       */                 
/* 14725 */                 sendNormalServerMessage(crets[x].getName() + ':' + 
/* 14726 */                     (crets[x].getCurrentTile()).tilex + ", " + (crets[x].getCurrentTile()).tiley + ", " + crets[x]
/* 14727 */                     .getCurrentTile().isOnSurface());
/*       */                 
/*       */                 x++;
/*       */               } 
/*       */             } 
/* 14732 */             sendNormalServerMessage("--- End of list ---");
/*       */           }
/*       */         
/*       */         } 
/* 14736 */       } catch (Exception exception) {}
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageLocateAvatars(String message, int power) {
/* 14745 */     this.player.getLogger().log(Level.INFO, "Trying to locate all the avatars on teh current server.");
/*       */     
/* 14747 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 14756 */       Creature[] avatars = Creatures.getInstance().getCreaturesWithName("avatar");
/* 14757 */       if (avatars.length == 0) {
/*       */         
/* 14759 */         sendNormalServerMessage("No avatars were found on this server");
/*       */         
/*       */         return;
/*       */       } 
/* 14763 */       for (Creature avatar : avatars) {
/*       */         
/* 14765 */         sendNormalServerMessage(StringUtil.format("Name:%s, ID:%d, x:%d, y:%d", new Object[] { avatar
/*       */                 
/* 14767 */                 .getName(), Long.valueOf(avatar.getWurmId()), 
/* 14768 */                 Integer.valueOf((avatar.getCurrentTile()).tilex), 
/* 14769 */                 Integer.valueOf((avatar.getCurrentTile()).tiley) }));
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageShowBans(int power) {
/* 14779 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 14788 */       Ban[] bips = Players.getInstance().getBans();
/* 14789 */       if (bips.length > 0) {
/*       */         
/* 14791 */         sendNormalServerMessage("IPS BANNED LOCALLY:");
/* 14792 */         for (int x = 0; x < bips.length; x++) {
/*       */           
/* 14794 */           long daytime = bips[x].getExpiry() - System.currentTimeMillis();
/* 14795 */           sendNormalServerMessage(bips[x].getIdentifier() + ", " + Server.getTimeFor(daytime) + ", " + bips[x]
/* 14796 */               .getReason());
/*       */         } 
/*       */       } else {
/*       */         
/* 14800 */         sendNormalServerMessage("NO IPS BANNED LOCALLY.");
/*       */       } 
/*       */       try {
/* 14803 */         LoginServerWebConnection c = new LoginServerWebConnection();
/* 14804 */         bips = c.getIpsBanned();
/* 14805 */         if (bips.length > 0) {
/*       */           
/* 14807 */           sendNormalServerMessage("IPS BANNED ON LOGINSERVER:");
/* 14808 */           for (int x = 0; x < bips.length; x++) {
/*       */             
/* 14810 */             long daytime = bips[x].getExpiry() - System.currentTimeMillis();
/* 14811 */             sendNormalServerMessage(bips[x].getIdentifier() + ", " + Server.getTimeFor(daytime) + ", " + bips[x]
/* 14812 */                 .getReason());
/*       */           } 
/*       */         } else {
/*       */           
/* 14816 */           sendNormalServerMessage("NO IPS BANNED ON LOGIN SERVER.");
/*       */         } 
/* 14818 */       } catch (Exception e) {
/*       */         
/* 14820 */         sendAlertServerMessage("Failed to get banned ips from login server:" + e.getMessage());
/* 14821 */         logInfo(this.player.getName() + " retrieving banned ips from login server failed: " + e
/* 14822 */             .getMessage(), e);
/*       */       } 
/* 14824 */       bips = Players.getInstance().getPlayersBanned();
/* 14825 */       if (bips.length > 0) {
/*       */         
/* 14827 */         sendNormalServerMessage("PLAYERS BANNED LOCALLY:");
/* 14828 */         for (int x = 0; x < bips.length; x++) {
/*       */           
/* 14830 */           long daytime = bips[x].getExpiry() - System.currentTimeMillis();
/* 14831 */           sendNormalServerMessage(bips[x].getIdentifier() + ", " + Server.getTimeFor(daytime) + ", " + bips[x]
/* 14832 */               .getReason());
/*       */         } 
/*       */       } else {
/*       */         
/* 14836 */         sendNormalServerMessage("NO PLAYERS BANNED LOCALLY.");
/*       */       } 
/*       */       try {
/* 14839 */         LoginServerWebConnection c = new LoginServerWebConnection();
/* 14840 */         bips = c.getPlayersBanned();
/* 14841 */         if (bips.length > 0) {
/*       */           
/* 14843 */           sendNormalServerMessage("PLAYERS BANNED ON LOGINSERVER:");
/* 14844 */           for (int x = 0; x < bips.length; x++) {
/*       */             
/* 14846 */             long daytime = bips[x].getExpiry() - System.currentTimeMillis();
/* 14847 */             sendNormalServerMessage(bips[x].getIdentifier() + ", " + Server.getTimeFor(daytime) + ", " + bips[x]
/* 14848 */                 .getReason());
/*       */           } 
/*       */         } else {
/*       */           
/* 14852 */           sendNormalServerMessage("NO PLAYERS BANNED ON LOGIN SERVER.");
/*       */         } 
/* 14854 */       } catch (Exception e) {
/*       */         
/* 14856 */         sendAlertServerMessage("Failed to get banned players from login server:" + e.getMessage());
/* 14857 */         logInfo(this.player.getName() + " retrieving banned players from login server failed: " + e
/* 14858 */             .getMessage(), e);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageCheckEigc(int power) {
/* 14868 */     if (power >= 2) {
/*       */       
/* 14870 */       sendSafeServerMessage("The following eigc clients exist:");
/* 14871 */       Eigc.sendAllClientInfo(this);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageInvisible(int power) {
/* 14932 */     if (power >= 1)
/*       */     {
/* 14934 */       if ((this.player.getStatus()).visible) {
/*       */         
/* 14936 */         this.player.setVisible(false);
/* 14937 */         sendSafeServerMessage("You are now invisible. Only gms can see you. Some actions and emotes may still be visible though.");
/*       */       }
/*       */       else {
/*       */         
/* 14941 */         this.player.setVisible(true);
/* 14942 */         sendSafeServerMessage("You are now visible again.");
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessagePardon(String message, int power) throws IOException {
/* 14954 */     if (power >= 2) {
/*       */       
/* 14956 */       StringTokenizer tokens = new StringTokenizer(message);
/* 14957 */       tokens.nextToken();
/* 14958 */       String bname = "";
/*       */       
/*       */       try {
/* 14961 */         bname = tokens.nextToken().trim();
/* 14962 */         bname = LoginHandler.raiseFirstLetter(bname);
/* 14963 */         logInfo("Trying to pardon player " + bname + '.');
/*       */       }
/* 14965 */       catch (Exception ex) {
/*       */         
/* 14967 */         ex.printStackTrace();
/*       */       } 
/*       */       
/* 14970 */       PlayerInfo pinf = null;
/*       */       
/*       */       try {
/* 14973 */         Player p = Players.getInstance().getPlayer(bname);
/* 14974 */         pinf = p.getSaveFile();
/*       */       }
/* 14976 */       catch (NoSuchPlayerException nsp) {
/*       */         
/* 14978 */         pinf = PlayerInfoFactory.createPlayerInfo(bname);
/* 14979 */         pinf.load();
/*       */       } 
/* 14981 */       if (pinf.isBanned()) {
/*       */         
/* 14983 */         pinf.setBanned(false, "", 0L);
/* 14984 */         String bip = pinf.getIpaddress();
/* 14985 */         Players.getInstance().removeBan(bip);
/* 14986 */         sendSafeServerMessage("You have gratiously pardoned " + bname + " and the ipaddress " + bip);
/* 14987 */         logInfo(this.player.getName() + " pardons player " + bname + " and ipaddress " + bip + '.');
/*       */         
/* 14989 */         if (this.player.getLogger() != null)
/* 14990 */           this.player.getLogger().log(Level.INFO, this.player.getName() + " pardons " + bname); 
/* 14991 */         if (!message.startsWith("#pardonhere")) {
/*       */ 
/*       */           
/*       */           try {
/* 14995 */             LoginServerWebConnection c = new LoginServerWebConnection();
/* 14996 */             sendSafeServerMessage(c.removeBannedIp(bip));
/*       */           }
/* 14998 */           catch (Exception e) {
/*       */             
/* 15000 */             sendAlertServerMessage("Failed to remove ip ban on login server:" + e.getMessage());
/* 15001 */             logInfo(this.player.getName() + " removing ip ban " + bip + " on login server failed: " + e
/* 15002 */                 .getMessage(), e);
/*       */           } 
/*       */           
/*       */           try {
/* 15006 */             LoginServerWebConnection c = new LoginServerWebConnection();
/* 15007 */             sendSafeServerMessage(c.pardonban(bname));
/*       */           }
/* 15009 */           catch (Exception e) {
/*       */             
/* 15011 */             sendAlertServerMessage("Failed to pardon on login server:" + e.getMessage());
/* 15012 */             logInfo(this.player.getName() + " pardoning " + bname + "on login server failed: " + e
/* 15013 */                 .getMessage(), e);
/*       */           } 
/*       */         } 
/*       */       } 
/*       */     } 
/*       */   }
/*       */   
/*       */   private void handleHashMessagePardonSteamId(String message, int power) {
/*       */     SteamIdBan steamIdBan;
/* 15022 */     if (power < 2)
/* 15023 */       return;  StringTokenizer tokens = new StringTokenizer(message);
/* 15024 */     tokens.nextToken();
/* 15025 */     SteamId identifier = tokens.hasMoreTokens() ? SteamId.fromAnyString(tokens.nextToken()) : null;
/* 15026 */     if (identifier == null) {
/*       */       
/* 15028 */       sendAlertServerMessage("Usage: #pardonsteamid <steamid>");
/*       */       return;
/*       */     } 
/* 15031 */     Ban ban = Players.getInstance().getBannedIp(identifier.toString());
/* 15032 */     if (ban == null)
/* 15033 */       steamIdBan = new SteamIdBan(identifier, "", 0L); 
/* 15034 */     if (Players.getInstance().removeBan((Ban)steamIdBan)) {
/* 15035 */       sendSafeServerMessage("You have pardoned " + identifier);
/*       */     } else {
/* 15037 */       sendAlertServerMessage("That id is either not banned or an error occurred. Check logs.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessagePardonIp(String message, int power) {
/* 15046 */     if (power >= 2) {
/*       */       
/* 15048 */       StringTokenizer tokens = new StringTokenizer(message);
/* 15049 */       tokens.nextToken();
/* 15050 */       String ip = "";
/*       */       
/*       */       try {
/* 15053 */         ip = tokens.nextToken().trim();
/* 15054 */         logInfo("Trying to pardon ip " + ip + '.');
/*       */       }
/* 15056 */       catch (Exception exception) {}
/*       */ 
/*       */ 
/*       */       
/* 15060 */       Ban bip = Players.getInstance().getBannedIp(ip);
/* 15061 */       if (bip != null) {
/*       */         
/* 15063 */         if (Players.getInstance().removeBan(ip)) {
/*       */           
/* 15065 */           sendSafeServerMessage("You have gratiously pardoned the ipaddress " + ip);
/* 15066 */           logInfo(this.player.getName() + " pardons ipaddress " + ip + '.');
/* 15067 */           if (this.player.getLogger() != null) {
/* 15068 */             this.player.getLogger().log(Level.INFO, this.player.getName() + " pardons " + ip);
/*       */           }
/*       */         } else {
/* 15071 */           sendAlertServerMessage("Failed to unban ip " + ip + '.');
/* 15072 */         }  if (!message.startsWith("#pardoniphere")) {
/*       */           try
/*       */           {
/*       */             
/* 15076 */             LoginServerWebConnection c = new LoginServerWebConnection();
/* 15077 */             sendSafeServerMessage(c.removeBannedIp(ip));
/*       */           }
/* 15079 */           catch (Exception e)
/*       */           {
/* 15081 */             sendAlertServerMessage("Failed to remove ip ban on login server:" + e.getMessage());
/* 15082 */             logInfo(this.player.getName() + " removing ip ban " + bip + " on login server failed: " + e
/* 15083 */                 .getMessage(), e);
/*       */           }
/*       */         
/*       */         }
/*       */       } else {
/*       */         
/* 15089 */         bip = Players.getInstance().getBannedIp("/" + ip);
/* 15090 */         if (bip != null)
/*       */         {
/* 15092 */           if (Players.getInstance().removeBan("/" + ip)) {
/*       */             
/* 15094 */             sendSafeServerMessage("You have gratiously pardoned the ipaddress " + ip);
/* 15095 */             logInfo(this.player.getName() + " pardons ipaddress " + ip + '.');
/* 15096 */             if (this.player.getLogger() != null) {
/* 15097 */               this.player.getLogger().log(Level.INFO, this.player.getName() + " pardons " + ip);
/*       */             }
/*       */           } else {
/* 15100 */             sendAlertServerMessage("Failed to unban ip /" + ip + '.');
/*       */           }  } 
/* 15102 */         if (!message.startsWith("#pardoniphere")) {
/*       */           
/*       */           try {
/*       */             
/* 15106 */             LoginServerWebConnection c = new LoginServerWebConnection();
/* 15107 */             sendSafeServerMessage(c.removeBannedIp("/" + ip));
/*       */           }
/* 15109 */           catch (Exception e) {
/*       */             
/* 15111 */             sendAlertServerMessage("Failed to remove ip ban on login server:" + e.getMessage());
/* 15112 */             logInfo(this.player.getName() + " removing ip ban " + bip + " on login server failed: " + e
/* 15113 */                 .getMessage(), e);
/*       */           } 
/*       */         }
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageGetWarnings(String message, int power) throws IOException {
/* 15127 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 15136 */       StringTokenizer tokens = new StringTokenizer(message);
/* 15137 */       tokens.nextToken();
/* 15138 */       String bname = "";
/*       */       
/*       */       try {
/* 15141 */         bname = tokens.nextToken().trim();
/* 15142 */         bname = LoginHandler.raiseFirstLetter(bname);
/*       */       }
/* 15144 */       catch (Exception ex) {
/*       */         
/* 15146 */         ex.printStackTrace();
/*       */       } 
/*       */       
/* 15149 */       PlayerInfo pinf = null;
/* 15150 */       Player play = null;
/*       */       
/*       */       try {
/* 15153 */         play = Players.getInstance().getPlayer(bname);
/* 15154 */         pinf = play.getSaveFile();
/*       */       }
/* 15156 */       catch (NoSuchPlayerException nsp) {
/*       */         
/* 15158 */         pinf = PlayerInfoFactory.createPlayerInfo(bname);
/* 15159 */         pinf.load();
/*       */       } 
/* 15161 */       long lastWarned = pinf.getLastWarned();
/* 15162 */       String wst = pinf.getWarningStats(lastWarned);
/* 15163 */       sendSafeServerMessage(wst);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageWarn(String message, int power) throws IOException {
/* 15174 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 15183 */       StringTokenizer tokens = new StringTokenizer(message);
/* 15184 */       tokens.nextToken();
/* 15185 */       String bname = "";
/*       */       
/*       */       try {
/* 15188 */         bname = tokens.nextToken().trim();
/* 15189 */         bname = LoginHandler.raiseFirstLetter(bname);
/*       */       }
/* 15191 */       catch (Exception ex) {
/*       */         
/* 15193 */         logInfo(this.player.getName() + " warning " + bname + " " + ex.getMessage());
/*       */       } 
/*       */       
/* 15196 */       PlayerInfo pinf = null;
/* 15197 */       Player play = null;
/*       */       
/*       */       try {
/* 15200 */         play = Players.getInstance().getPlayer(bname);
/* 15201 */         pinf = play.getSaveFile();
/*       */       }
/* 15203 */       catch (NoSuchPlayerException nsp) {
/*       */         
/* 15205 */         pinf = PlayerInfoFactory.createPlayerInfo(bname);
/* 15206 */         pinf.load();
/*       */       } 
/* 15208 */       long lastWarned = pinf.getLastWarned();
/*       */       
/*       */       try {
/* 15211 */         pinf.warn();
/* 15212 */         String wst = pinf.getWarningStats(lastWarned);
/* 15213 */         sendSafeServerMessage("You have officially warned " + bname + ". " + wst);
/* 15214 */         if (play != null)
/*       */         {
/* 15216 */           play.getCommunicator()
/* 15217 */             .sendAlertServerMessage("You have just received an official warning. Too many of these will get you banned from the game.", (byte)1);
/*       */         }
/*       */         
/* 15220 */         if (this.player.getLogger() != null) {
/* 15221 */           this.player.getLogger().log(Level.INFO, this.player.getName() + " warns " + bname + '.');
/*       */         }
/*       */         
/* 15224 */         WcGlobalModeration wcgm = new WcGlobalModeration(WurmId.getNextWCCommandId(), this.player.getName(), (byte)this.player.getPower(), false, false, false, false, true, 0, 0, pinf.getName(), "You have just received an official warning. Too many of these will get you banned from the game.");
/*       */         
/* 15226 */         if (Servers.localServer.LOGINSERVER) {
/* 15227 */           wcgm.sendFromLoginServer();
/*       */         } else {
/* 15229 */           wcgm.sendToLoginServer();
/*       */         } 
/* 15231 */       } catch (IOException iox) {
/*       */         
/* 15233 */         logInfo(this.player.getName() + " fails to warn " + bname + '.', iox);
/* 15234 */         sendSafeServerMessage("A server error occured. The warning was probably not registered.");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageClientInfo(String message, int power) throws IOException {
/* 15247 */     if (power >= 1) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 15256 */       StringTokenizer tokens = new StringTokenizer(message);
/* 15257 */       tokens.nextToken();
/* 15258 */       String bname = "";
/*       */       
/*       */       try {
/* 15261 */         bname = tokens.nextToken().trim();
/* 15262 */         bname = LoginHandler.raiseFirstLetter(bname);
/*       */       }
/* 15264 */       catch (Exception ex) {
/*       */         
/* 15266 */         sendSafeServerMessage("Usage: #showclientinfo [player]");
/*       */         return;
/*       */       } 
/* 15269 */       Player play = null;
/*       */       
/*       */       try {
/* 15272 */         play = Players.getInstance().getPlayer(bname);
/*       */       }
/* 15274 */       catch (NoSuchPlayerException nsp) {
/*       */         
/* 15276 */         logInfo(this.player.getName() + " failed to check client info of " + bname);
/* 15277 */         sendSafeServerMessage("Player " + bname + " not found.");
/*       */         
/*       */         return;
/*       */       } 
/* 15281 */       sendSafeServerMessage("Player: " + bname);
/* 15282 */       sendSafeServerMessage("Client version: " + play.getClientVersion());
/* 15283 */       sendSafeServerMessage("Client system: " + play.getClientSystem());
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageStaffClientInfo(int power) throws IOException {
/* 15295 */     if (power >= 4)
/*       */     {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 15304 */       for (Player p : Players.getInstance().getPlayers()) {
/*       */         
/* 15306 */         if (p.getPower() > 0 || p.mayMute() || p.isPlayerAssistant())
/*       */         {
/* 15308 */           sendSafeServerMessage("Player: " + p.getName() + ", Client Version: " + p.getClientVersion());
/*       */         }
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageCreatePortals(int power) {
/* 15319 */     if (power >= 5)
/*       */     {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 15328 */       createFreedomPortals();
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageTradeCheat(int power) {
/* 15337 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */       
/* 15341 */       if (this.player.getLogger() != null) {
/* 15342 */         this.player.getLogger().info("Toggling Trade Cheat");
/*       */       }
/* 15344 */       Server.allowTradeCheat = !Server.allowTradeCheat;
/* 15345 */       sendNormalServerMessage("Server allows tradecheats=" + Server.allowTradeCheat);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessageTriggerAchievement(int power, String message) {
/* 15351 */     if (power >= 5) {
/*       */       
/* 15353 */       StringTokenizer tokens = new StringTokenizer(message);
/* 15354 */       tokens.nextToken();
/*       */       
/*       */       try {
/* 15357 */         String targetName = tokens.nextToken().trim();
/* 15358 */         int achievementNum = Integer.parseInt(tokens.nextToken());
/* 15359 */         targetName = LoginHandler.raiseFirstLetter(targetName);
/*       */         
/* 15361 */         Player p = Players.getInstance().getPlayerOrNull(targetName);
/* 15362 */         if (p != null)
/*       */         {
/*       */ 
/*       */           
/* 15366 */           if (this.player.getLogger() != null) {
/* 15367 */             this.player.getLogger().info("Triggering achievement " + achievementNum + " for player " + p.getName());
/*       */           }
/* 15369 */           Achievements.triggerAchievement(p.getWurmId(), achievementNum);
/* 15370 */           sendSafeServerMessage("Achievement " + achievementNum + " successfully triggered for player + " + p.getName() + ".");
/*       */         }
/*       */         else
/*       */         {
/* 15374 */           sendSafeServerMessage("Unable to find player " + targetName + ".");
/*       */         }
/*       */       
/* 15377 */       } catch (Exception ex) {
/*       */         
/* 15379 */         sendSafeServerMessage("Usage: #triggerAchievement [player] [achievementNum]");
/*       */         return;
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessageOnline(int power, String message) {
/* 15387 */     if (power >= 2) {
/*       */       
/* 15389 */       StringTokenizer tokens = new StringTokenizer(message);
/* 15390 */       tokens.nextToken();
/*       */       
/*       */       try {
/* 15393 */         String targetName = tokens.nextToken().trim();
/* 15394 */         PlayerState ps = PlayerInfoFactory.getPlayerState(targetName);
/* 15395 */         if (ps == null)
/*       */         {
/* 15397 */           sendNormalServerMessage("Unable to find player " + targetName + ".");
/*       */         }
/* 15399 */         else if (ps.getState() == PlayerOnlineStatus.ONLINE)
/*       */         {
/* 15401 */           sendNormalServerMessage(targetName + " is online. Current server is " + ps.getServerName() + ".");
/*       */         }
/*       */         else
/*       */         {
/* 15405 */           long totalTime = System.currentTimeMillis() - ps.getLastLogout();
/* 15406 */           long second = totalTime / 1000L % 60L;
/* 15407 */           long minute = totalTime / 60000L % 60L;
/* 15408 */           long hour = totalTime / 3600000L % 24L;
/* 15409 */           long day = totalTime / 86400000L;
/*       */           
/* 15411 */           String time = String.format("%dd %02d:%02d:%02d", new Object[] { Long.valueOf(day), Long.valueOf(hour), Long.valueOf(minute), Long.valueOf(second) });
/* 15412 */           sendNormalServerMessage(targetName + " is offline. Last known server is " + ps.getServerName() + ". Last logout time is " + time + " ago.");
/*       */         }
/*       */       
/* 15415 */       } catch (Exception ex) {
/*       */         
/* 15417 */         sendSafeServerMessage("Usage: #online [playerName]");
/*       */         return;
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageMeditation(int power) {
/* 15428 */     if (power >= 5) {
/*       */       
/* 15430 */       int found = 0;
/* 15431 */       for (int nums = 0; nums < 1000; nums++) {
/*       */ 
/*       */         
/*       */         try {
/* 15435 */           int tx = Zones.safeTileX(Server.rand.nextInt((this.player.getCurrentTile()).tilex - 100 + Server.rand
/* 15436 */                 .nextInt(200)));
/* 15437 */           int ty = Zones.safeTileY(Server.rand.nextInt((this.player.getCurrentTile()).tiley - 100 + Server.rand
/* 15438 */                 .nextInt(200)));
/* 15439 */           float height = Zones.calculateHeight(((tx << 2) + 2), ((ty << 2) + 2), true) * 10.0F;
/* 15440 */           byte path = Cults.getPathFor(tx, ty, 0, (int)height);
/* 15441 */           if (path != 0)
/*       */           {
/* 15443 */             sendNormalServerMessage(found++ + " - Tile " + tx + "," + ty + ":" + 
/* 15444 */                 Cults.getPathNameFor(path));
/*       */           }
/*       */         }
/* 15447 */         catch (NoSuchZoneException noSuchZoneException) {}
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageHighscore(String message, int power) {
/* 15462 */     if (power >= 3) {
/*       */       
/* 15464 */       StringTokenizer tokens = new StringTokenizer(message);
/* 15465 */       tokens.nextToken();
/*       */       
/* 15467 */       String hstype = "";
/*       */       
/*       */       try {
/* 15470 */         hstype = tokens.nextToken();
/* 15471 */         ChallengeSummary.createHighScorePage(Integer.parseInt(hstype));
/*       */       }
/* 15473 */       catch (Exception ex) {
/*       */         
/* 15475 */         sendNormalServerMessage(message + " does not compute! " + ex.getMessage());
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageWarTargets(int power) {
/* 15486 */     if (power >= 5)
/*       */     {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 15495 */       for (Item i : Items.getWarTargets())
/*       */       {
/* 15497 */         sendNormalServerMessage(i.getName() + " at " + i.getTileX() + "," + i.getTileY());
/*       */       }
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageAlerts(int power) {
/* 15507 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 15516 */       AlertServerMessageQuestion asm = new AlertServerMessageQuestion((Creature)this.player, "Changing alert messages", "What should the server alerts be?", -10L);
/*       */       
/* 15518 */       asm.sendQuestion();
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageCalcCreatures(int power) {
/* 15527 */     if (power >= 2)
/*       */     {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 15536 */       Zones.calcCreatures((Creature)this.player);
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageOffline(int power) {
/* 15545 */     if (power >= 2)
/*       */     {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 15554 */       Creatures.getInstance().sendOfflineCreatures(this, (power >= 2));
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageGetIps(int power) {
/* 15563 */     if (power >= 2)
/*       */     {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 15572 */       Players.getInstance().sendIpsToPlayer(this.player);
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageWho(String message, int power) {
/* 15582 */     if (power >= 2) {
/*       */       
/* 15584 */       StringTokenizer tokens = new StringTokenizer(message);
/* 15585 */       tokens.nextToken();
/*       */       
/* 15587 */       String kname = "";
/*       */       
/*       */       try {
/* 15590 */         kname = tokens.nextToken().toLowerCase();
/* 15591 */         if (kname.equals("j")) {
/* 15592 */           sendWho((byte)1);
/* 15593 */         } else if (kname.equals("h")) {
/* 15594 */           sendWho((byte)3);
/* 15595 */         } else if (kname.equals("m")) {
/* 15596 */           sendWho((byte)2);
/*       */         } 
/* 15598 */       } catch (Exception ex) {
/*       */         
/* 15600 */         sendNormalServerMessage("Use '#who J' to retrieve players online from Jenn-Kellon, H for HOTS, M for Mol-Rehan.");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageToggleGlobalChat(int power) {
/* 15610 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 15619 */       if (Servers.localServer.isChallengeServer()) {
/*       */         
/* 15621 */         sendNormalServerMessage("You can not enable global chat on this server.");
/*       */         return;
/*       */       } 
/* 15624 */       if (gchatdisabled) {
/*       */         
/* 15626 */         gchatdisabled = false;
/* 15627 */         sendNormalServerMessage("Global chat is enabled.");
/* 15628 */         Players.addGmMessage(this.player.getName(), "Enabled global chat");
/*       */       }
/*       */       else {
/*       */         
/* 15632 */         gchatdisabled = true;
/* 15633 */         sendNormalServerMessage("Global chat is disabled.");
/* 15634 */         Players.addGmMessage(this.player.getName(), "Disabled global chat");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageSoundSpam(int power) {
/* 15644 */     if (power >= 2) {
/*       */       
/* 15646 */       int t = Server.rand.nextInt(20);
/* 15647 */       for (int a = 0; a < t; a++) {
/*       */         
/* 15649 */         int x = Server.rand.nextInt(100);
/* 15650 */         int y = Server.rand.nextInt(100);
/* 15651 */         String soundName = "sound.ambient.day.crickets";
/* 15652 */         int n = Server.rand.nextInt(20);
/* 15653 */         if (n == 1) {
/* 15654 */           soundName = "sound.ambient.night.crickets";
/* 15655 */         } else if (n == 2) {
/* 15656 */           soundName = "sound.ambient.night.crickets";
/* 15657 */         } else if (n == 3) {
/* 15658 */           soundName = "sound.forest.creak.loud";
/* 15659 */         } else if (n == 4) {
/* 15660 */           soundName = "sound.forest.leafrustle";
/* 15661 */         } else if (n == 5) {
/* 15662 */           soundName = "sound.ambient.rain.heavy";
/* 15663 */         } else if (n == 6) {
/* 15664 */           soundName = "sound.arrow.aim";
/* 15665 */         } else if (n == 7) {
/* 15666 */           soundName = "sound.arrow.shot";
/* 15667 */         } else if (n == 8) {
/* 15668 */           soundName = "sound.arrow.stuck.ground";
/* 15669 */         } else if (n == 9) {
/* 15670 */           soundName = "sound.arrow.miss";
/* 15671 */         } else if (n == 10) {
/* 15672 */           soundName = "sound.birdsong.bird5";
/* 15673 */         } else if (n == 11) {
/* 15674 */           soundName = "sound.birdsong.bird1";
/* 15675 */         } else if (n == 12) {
/* 15676 */           soundName = "sound.birdsong.bird7";
/* 15677 */         } else if (n == 13) {
/* 15678 */           soundName = "sound.birdsong.bird8";
/* 15679 */         } else if (n == 14) {
/* 15680 */           soundName = "sound.work.carpentry.carvingknife";
/* 15681 */         } else if (n == 15) {
/* 15682 */           soundName = "sound.birdsong.crows";
/* 15683 */         } else if (n == 16) {
/* 15684 */           soundName = "sound.work.carpentry.rasp";
/* 15685 */         } else if (n == 17) {
/* 15686 */           soundName = "sound.death.bear";
/* 15687 */         } else if (n == 18) {
/* 15688 */           soundName = "sound.death.dragon";
/* 15689 */         } else if (n == 19) {
/* 15690 */           soundName = "sound.work.smithing.metal";
/* 15691 */         }  SoundPlayer.playSound(soundName, (this.player.getCurrentTile()).tilex - 50 + x, 
/* 15692 */             (this.player.getCurrentTile()).tiley - 50 + y, true, this.player.getPositionZ() + this.player.getAltOffZ());
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void showCreatureList() {
/* 15700 */     Map<Integer, Integer> crets = Creatures.getInstance().getCreatureTypeList();
/* 15701 */     for (Integer key : crets.keySet()) {
/*       */ 
/*       */       
/*       */       try {
/* 15705 */         CreatureTemplate template = CreatureTemplateFactory.getInstance().getTemplate(key.intValue());
/* 15706 */         int maxCreatures = Servers.localServer.maxCreatures;
/*       */         
/* 15708 */         String messageStr = "Creature: %s Count: %d Current %%: %.2f Max %%: %.2f%s";
/* 15709 */         int currentCount = ((Integer)crets.get(key)).intValue();
/* 15710 */         float currentPercentage = currentCount / maxCreatures * 100.0F;
/* 15711 */         float maxPercentage = template.getMaxPercentOfCreatures() * 100.0F;
/* 15712 */         int popCap = template.getMaxPopulationOfCreatures();
/*       */         
/* 15714 */         String popMessage = template.usesMaxPopulation() ? StringUtil.format(" Population limit: %d.", new Object[] {
/* 15715 */               Integer.valueOf(popCap)
/*       */             }) : ".";
/* 15717 */         String newMessage = StringUtil.format("Creature: %s Count: %d Current %%: %.2f Max %%: %.2f%s", new Object[] { template
/* 15718 */               .getName(), 
/* 15719 */               Integer.valueOf(currentCount), 
/* 15720 */               Float.valueOf(currentPercentage), 
/* 15721 */               Float.valueOf(maxPercentage), popMessage });
/*       */         
/* 15723 */         sendNormalServerMessage(newMessage);
/*       */       }
/* 15725 */       catch (NoSuchCreatureTemplateException e) {
/*       */ 
/*       */         
/* 15728 */         logWarn(e.getMessage(), (Throwable)e);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleShowCreatureList(String message, int power) {
/* 15735 */     if (power < 4) {
/*       */       return;
/*       */     }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/* 15744 */     StringTokenizer tokens = new StringTokenizer(message);
/* 15745 */     tokens.nextToken();
/*       */     
/* 15747 */     if (!tokens.hasMoreTokens()) {
/*       */       
/* 15749 */       showCreatureList();
/*       */     }
/*       */     else {
/*       */       
/* 15753 */       String token = tokens.nextToken();
/* 15754 */       if (token.equals("corrupt")) {
/*       */         
/* 15756 */         Creature[] creatures = Creatures.getInstance().getCreatures();
/* 15757 */         Map<Integer, Integer> corruptedByType = new HashMap<>();
/* 15758 */         for (Creature cret : creatures) {
/*       */           
/* 15760 */           if (cret.hasTrait(22)) {
/*       */             
/* 15762 */             Integer key = Integer.valueOf(cret.getTemplate().getTemplateId());
/* 15763 */             if (corruptedByType.containsKey(key)) {
/*       */               
/* 15765 */               Integer val = corruptedByType.get(key);
/* 15766 */               Integer nVal = Integer.valueOf(val.intValue() + 1);
/* 15767 */               corruptedByType.put(key, nVal);
/*       */             }
/*       */             else {
/*       */               
/* 15771 */               corruptedByType.put(key, Integer.valueOf(1));
/*       */             } 
/*       */           } 
/*       */         } 
/* 15775 */         if (corruptedByType.isEmpty()) {
/*       */           
/* 15777 */           sendNormalServerMessage("No corrupt animals on the server.");
/*       */           return;
/*       */         } 
/* 15780 */         for (Integer key : corruptedByType.keySet()) {
/*       */ 
/*       */           
/*       */           try {
/* 15784 */             CreatureTemplate template = CreatureTemplateFactory.getInstance().getTemplate(key.intValue());
/*       */             
/* 15786 */             String messageStr = "Creature: %s Corrupted count: %d";
/* 15787 */             Integer val = corruptedByType.get(key);
/*       */             
/* 15789 */             sendNormalServerMessage(StringUtil.format("Creature: %s Corrupted count: %d", new Object[] { template
/* 15790 */                     .getName(), 
/* 15791 */                     Integer.valueOf(val.intValue()) }));
/*       */           }
/* 15793 */           catch (NoSuchCreatureTemplateException e) {
/*       */ 
/*       */             
/* 15796 */             logWarn(e.getMessage(), (Throwable)e);
/*       */           } 
/*       */         } 
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageKick(String message, int power) {
/* 15811 */     if (power >= 2) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 15820 */       StringTokenizer tokens = new StringTokenizer(message);
/*       */       
/* 15822 */       tokens.nextToken();
/* 15823 */       String pname = "Unknown";
/*       */       
/*       */       try {
/* 15826 */         pname = tokens.nextToken().trim();
/* 15827 */         pname = LoginHandler.raiseFirstLetter(pname);
/* 15828 */         Player p = Players.getInstance().getPlayer(pname);
/* 15829 */         if (this.player.getLogger() != null)
/* 15830 */           this.player.getLogger().log(Level.INFO, this.player.getName() + " kicking " + pname); 
/* 15831 */         if (p.getPower() < power || p == this.player) {
/*       */           
/* 15833 */           if (p.hasLink()) {
/*       */             
/* 15835 */             p.getCommunicator().sendShutDown("Disconnected by GM.", true);
/* 15836 */             p.setSecondsToLogout(5);
/*       */           } else {
/*       */             
/* 15839 */             Players.getInstance().logoutPlayer(p);
/*       */           } 
/*       */         } else {
/*       */           
/* 15843 */           sendNormalServerMessage("You cannot kick " + pname + '!');
/* 15844 */           p.getCommunicator().sendNormalServerMessage(this.player
/* 15845 */               .getName() + " tried to kick you from the game!");
/*       */         }
/*       */       
/* 15848 */       } catch (NoSuchPlayerException nsp) {
/*       */         
/* 15850 */         sendSafeServerMessage("No player found with the name " + pname);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageAllowAll(int power) {
/* 15860 */     if (power >= 3) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 15869 */       Server.getInstance().broadCastAlert("The server is now open for connections.");
/* 15870 */       Constants.maintaining = false;
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageShutdown(int power) {
/* 15879 */     if (power >= 3) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 15888 */       Server.getInstance().broadCastAlert("The server is put in maintenance mode. Please log off immediately.");
/*       */       
/* 15890 */       Constants.maintaining = true;
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessageDumpXml(int power) {
/* 15896 */     if (power < 3) {
/*       */       return;
/*       */     }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/* 15905 */     if (Servers.localServer.LOGINSERVER) {
/*       */       
/* 15907 */       EpicXmlWriter.dumpEntities(Server.getEpicMap());
/* 15908 */       this.player.getCommunicator().sendNormalServerMessage("Xml dumped.");
/*       */     }
/*       */     else {
/*       */       
/* 15912 */       this.player.getCommunicator().sendNormalServerMessage("Do this on the login server...");
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessageElevate(int power, String message) {
/* 15918 */     if (power <= 3) {
/*       */       return;
/*       */     }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/* 15927 */     if (Servers.localServer.LOGINSERVER) {
/*       */       
/* 15929 */       StringTokenizer tokenizer = new StringTokenizer(message);
/* 15930 */       tokenizer.nextToken();
/* 15931 */       if (!tokenizer.hasMoreTokens()) {
/*       */         
/* 15933 */         sendSafeServerMessage("The name of the deity to elevate must be included.");
/*       */         return;
/*       */       } 
/* 15936 */       String name = tokenizer.nextToken();
/* 15937 */       if (HexMap.VALREI.elevateDemigod(1L, name)) {
/* 15938 */         sendSafeServerMessage("Done!");
/*       */       } else {
/* 15940 */         sendSafeServerMessage("Failed..");
/*       */       } 
/*       */     } else {
/* 15943 */       this.player.getCommunicator().sendNormalServerMessage("Do this on the login server...");
/*       */     } 
/*       */   } private void handleHashMessageNeMission(int power, String message) {
/*       */     String entityName;
/*       */     int number;
/* 15948 */     if (power < 3) {
/*       */       return;
/*       */     }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/* 15957 */     StringTokenizer tokenizer = new StringTokenizer(message);
/* 15958 */     tokenizer.nextToken();
/* 15959 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 15961 */       sendSafeServerMessage("The name of the deity to generate a mission for must be included.");
/*       */       return;
/*       */     } 
/* 15964 */     String rawEntityName = tokenizer.nextToken();
/*       */ 
/*       */ 
/*       */     
/*       */     try {
/* 15969 */       number = Integer.parseInt(rawEntityName);
/* 15970 */       entityName = Deities.getDeityName(number);
/*       */     }
/* 15972 */     catch (Exception e) {
/*       */       
/* 15974 */       entityName = rawEntityName.substring(0, 1).toUpperCase() + rawEntityName.substring(1).toLowerCase();
/* 15975 */       number = Deities.getEntityNumber(entityName);
/*       */     } 
/* 15977 */     boolean found = false;
/*       */     
/* 15979 */     if (number > 0) {
/*       */       
/* 15981 */       EpicServerStatus es = new EpicServerStatus();
/* 15982 */       int time = 259200;
/* 15983 */       if (!Servers.localServer.EPIC)
/* 15984 */         time = 604800; 
/* 15985 */       if (EpicServerStatus.getCurrentScenario() == null)
/* 15986 */         EpicServerStatus.loadLocalEntries(); 
/* 15987 */       if (EpicServerStatus.getCurrentScenario() != null) {
/* 15988 */         es.generateNewMissionForEpicEntity(number, entityName, -1, time, 
/* 15989 */             EpicServerStatus.getCurrentScenario().getScenarioName(), EpicServerStatus.getCurrentScenario()
/* 15990 */             .getScenarioNumber(), 
/* 15991 */             EpicServerStatus.getCurrentScenario().getScenarioQuest(), true);
/*       */       }
/*       */       else {
/*       */         
/* 15995 */         this.player.getCommunicator().sendNormalServerMessage("Failed to find and use the current scenario. Making something up...");
/*       */         
/* 15997 */         es.generateNewMissionForEpicEntity(number, entityName, 0, 259200, "The secret scenario", 1, "The secret quest", true);
/*       */       } 
/*       */       
/* 16000 */       found = true;
/*       */     } 
/* 16002 */     if (!found) {
/* 16003 */       this.player.getCommunicator().sendNormalServerMessage("Failed to locate deity called " + rawEntityName + "...");
/*       */     } else {
/* 16005 */       this.player.getCommunicator().sendSafeServerMessage("Generated new mission for " + entityName + ".");
/*       */     } 
/*       */   }
/*       */   
/*       */   private void handleHashMessageToggleEnableMission(int power, String message) {
/* 16010 */     if (power < 3) {
/*       */       return;
/*       */     }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/* 16019 */     StringTokenizer tokenizer = new StringTokenizer(message);
/* 16020 */     tokenizer.nextToken();
/* 16021 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16023 */       sendSafeServerMessage("The name of the mission to toggle on/off must be included.");
/*       */       return;
/*       */     } 
/* 16026 */     String missionName = tokenizer.nextToken();
/* 16027 */     boolean found = false;
/* 16028 */     for (Mission mission : Missions.getAllMissions()) {
/*       */       
/* 16030 */       if (mission.getName().equalsIgnoreCase(missionName)) {
/*       */         
/* 16032 */         mission.setInactive(!mission.isInactive());
/* 16033 */         this.player.getCommunicator().sendSafeServerMessage("Mission " + missionName + " active=" + (
/* 16034 */             !mission.isInactive() ? 1 : 0));
/* 16035 */         found = true;
/*       */         break;
/*       */       } 
/*       */     } 
/* 16039 */     if (!found) {
/* 16040 */       this.player.getCommunicator().sendNormalServerMessage("Failed to locate mission with that name...");
/*       */     }
/*       */   }
/*       */   
/*       */   private void handleHashMessageToggleFlag(int power, String message) {
/* 16045 */     if (power < 3)
/*       */       return; 
/* 16047 */     if (!this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/* 16057 */     if (!Servers.localServer.LOGINSERVER) {
/*       */       
/* 16059 */       sendSafeServerMessage("This command needs to be used on the login server.");
/*       */       return;
/*       */     } 
/* 16062 */     StringTokenizer tokenizer = new StringTokenizer(message);
/* 16063 */     tokenizer.nextToken();
/* 16064 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16066 */       sendSafeServerMessage("The name of the player to toggle flag for for must be included.");
/*       */       
/*       */       return;
/*       */     } 
/* 16070 */     String playerName = tokenizer.nextToken();
/* 16071 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16073 */       sendSafeServerMessage("The flag number to toggle must be included.");
/*       */       return;
/*       */     } 
/* 16076 */     String flagString = tokenizer.nextToken();
/* 16077 */     int flagNumber = -1;
/*       */     
/*       */     try {
/* 16080 */       flagNumber = Integer.parseInt(flagString);
/*       */     }
/* 16082 */     catch (Exception ex) {
/*       */       
/* 16084 */       sendSafeServerMessage("The flag number " + flagString + " doesn't seem to be a number.");
/*       */       return;
/*       */     } 
/* 16087 */     if ((flagNumber >= 64 && flagNumber > 82) || (flagNumber < 64 && flagNumber > 63) || flagNumber < 0) {
/*       */ 
/*       */       
/* 16090 */       sendSafeServerMessage("The flag number " + flagString + " is not a valid flag.");
/*       */       return;
/*       */     } 
/* 16093 */     PlayerInfo target = PlayerInfoFactory.getPlayerInfoWithName(playerName);
/* 16094 */     if (target != null) {
/*       */       
/* 16096 */       target.setFlag(flagNumber, !target.isFlagSet(flagNumber));
/* 16097 */       String toggleMessage = StringUtil.format("Toggled local flag: %s for: %s.", new Object[] { Boolean.toString(target.isFlagSet(flagNumber)), playerName });
/* 16098 */       sendSafeServerMessage(toggleMessage);
/* 16099 */       if (Servers.localServer.id != target.getCurrentServer()) {
/*       */         
/* 16101 */         LoginServerWebConnection lsw = new LoginServerWebConnection(target.getCurrentServer());
/* 16102 */         if (lsw.setPlayerFlag(target.wurmId, flagNumber, target.isFlagSet(flagNumber))) {
/*       */           
/* 16104 */           sendSafeServerMessage("Also set the flag on server " + target.getCurrentServer() + " to " + target.isFlagSet(flagNumber));
/*       */         } else {
/*       */           
/* 16107 */           sendSafeServerMessage("Failed to set the flag on server " + target.getCurrentServer());
/*       */         } 
/*       */       } 
/*       */     } 
/*       */   }
/*       */   
/*       */   private void handleHashMessageToggleCCFP(int power, String message) {
/* 16114 */     if (!this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/* 16123 */     this.player.setFlag(52, !this.player.hasFlag(52));
/* 16124 */     sendSafeServerMessage("Visibility of the CCFP Bar switched " + (this.player.hasFlag(52) ? "off." : "on."));
/*       */     
/* 16126 */     this.player.getStatus().sendHunger();
/*       */   } private void handleHashMessageFlattenRock(int power, String message) {
/*       */     int North, South, West, East, extra;
/* 16129 */     if (power < 3)
/*       */       return; 
/* 16131 */     if (!this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/* 16144 */     StringTokenizer tokenizer = new StringTokenizer(message);
/*       */     
/* 16146 */     tokenizer.nextToken();
/*       */ 
/*       */ 
/*       */     
/* 16150 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16152 */       sendSafeServerMessage("You must have at least the size of the area included. (MISSING N/E/S/W)");
/*       */       
/*       */       return;
/*       */     } 
/*       */     
/*       */     try {
/* 16158 */       North = Integer.parseInt(tokenizer.nextToken());
/* 16159 */       if (North < 0) {
/* 16160 */         sendSafeServerMessage("The NORTH value may not be negative!");
/*       */         
/*       */         return;
/*       */       } 
/* 16164 */     } catch (NumberFormatException nfe) {
/*       */       
/* 16166 */       sendSafeServerMessage("The NORTH value must be an integer!");
/*       */       
/*       */       return;
/*       */     } 
/*       */     
/* 16171 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16173 */       sendSafeServerMessage("You must have at least the size of the area included. (MISSING E/S/W)");
/*       */       
/*       */       return;
/*       */     } 
/*       */     try {
/* 16178 */       East = Integer.parseInt(tokenizer.nextToken());
/* 16179 */       if (East < 0) {
/* 16180 */         sendSafeServerMessage("The EAST value may not be negative!");
/*       */         
/*       */         return;
/*       */       } 
/* 16184 */     } catch (NumberFormatException nfe) {
/*       */       
/* 16186 */       sendSafeServerMessage("The EAST value must be an integer!");
/*       */       
/*       */       return;
/*       */     } 
/*       */     
/* 16191 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16193 */       sendSafeServerMessage("You must have at least the size of the area included. (MISSING S/W");
/*       */       
/*       */       return;
/*       */     } 
/*       */     try {
/* 16198 */       South = Integer.parseInt(tokenizer.nextToken());
/* 16199 */       if (South < 0) {
/* 16200 */         sendSafeServerMessage("The SOUTH value may not be negative!");
/*       */         
/*       */         return;
/*       */       } 
/* 16204 */     } catch (NumberFormatException nfe) {
/*       */       
/* 16206 */       sendSafeServerMessage("The SOUTH value must be an integer!");
/*       */       
/*       */       return;
/*       */     } 
/*       */     
/* 16211 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16213 */       sendSafeServerMessage("You must have at least the size of the area included. (MISSING W)");
/*       */       
/*       */       return;
/*       */     } 
/*       */     try {
/* 16218 */       West = Integer.parseInt(tokenizer.nextToken());
/* 16219 */       if (West < 0) {
/* 16220 */         sendSafeServerMessage("The WEST value may not be negative!");
/*       */         
/*       */         return;
/*       */       } 
/* 16224 */     } catch (NumberFormatException nfe) {
/*       */       
/* 16226 */       sendSafeServerMessage("The WEST value must be an integer!");
/*       */       
/*       */       return;
/*       */     } 
/*       */     
/* 16231 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16233 */       extra = 0;
/*       */     } else {
/*       */ 
/*       */       
/*       */       try {
/* 16238 */         extra = Integer.parseInt(tokenizer.nextToken());
/*       */       }
/* 16240 */       catch (NumberFormatException nfe) {
/*       */         
/* 16242 */         sendSafeServerMessage("The Extra slopes value must be an integer!");
/*       */         
/*       */         return;
/*       */       } 
/*       */     } 
/*       */     
/* 16248 */     float minDirt = 0.0F;
/* 16249 */     int startX = this.player.getTileX() - West;
/* 16250 */     int startY = this.player.getTileY() - North;
/* 16251 */     int endX = this.player.getTileX() + East;
/* 16252 */     int endY = this.player.getTileY() + South;
/*       */     
/* 16254 */     Terraforming.flattenImmediately((Creature)this.player, startX, endX, startY, endY, minDirt, extra, true);
/*       */   } private void handleHashMessageFlattenDirt(int power, String message) {
/*       */     int North, South, West, East, extra;
/*       */     float minDirt;
/* 16258 */     if (power < 3)
/*       */       return; 
/* 16260 */     if (!this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/* 16273 */     StringTokenizer tokenizer = new StringTokenizer(message);
/*       */     
/* 16275 */     tokenizer.nextToken();
/*       */ 
/*       */ 
/*       */     
/* 16279 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16281 */       sendSafeServerMessage("You must have at least the size of the area included. (MISSING N/E/S/W)");
/*       */       
/*       */       return;
/*       */     } 
/*       */     
/*       */     try {
/* 16287 */       North = Integer.parseInt(tokenizer.nextToken());
/* 16288 */       if (North < 0) {
/* 16289 */         sendSafeServerMessage("The NORTH value may not be negative!");
/*       */         
/*       */         return;
/*       */       } 
/* 16293 */     } catch (NumberFormatException nfe) {
/*       */       
/* 16295 */       sendSafeServerMessage("The NORTH value must be an integer!");
/*       */       
/*       */       return;
/*       */     } 
/*       */     
/* 16300 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16302 */       sendSafeServerMessage("You must have at least the size of the area included. (MISSING E/S/W)");
/*       */       
/*       */       return;
/*       */     } 
/*       */     try {
/* 16307 */       East = Integer.parseInt(tokenizer.nextToken());
/* 16308 */       if (East < 0) {
/* 16309 */         sendSafeServerMessage("The EAST value may not be negative!");
/*       */         
/*       */         return;
/*       */       } 
/* 16313 */     } catch (NumberFormatException nfe) {
/*       */       
/* 16315 */       sendSafeServerMessage("The EAST value must be an integer!");
/*       */       
/*       */       return;
/*       */     } 
/*       */     
/* 16320 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16322 */       sendSafeServerMessage("You must have at least the size of the area included. (MISSING S/W");
/*       */       
/*       */       return;
/*       */     } 
/*       */     try {
/* 16327 */       South = Integer.parseInt(tokenizer.nextToken());
/* 16328 */       if (South < 0) {
/* 16329 */         sendSafeServerMessage("The SOUTH value may not be negative!");
/*       */         
/*       */         return;
/*       */       } 
/* 16333 */     } catch (NumberFormatException nfe) {
/*       */       
/* 16335 */       sendSafeServerMessage("The SOUTH value must be an integer!");
/*       */       
/*       */       return;
/*       */     } 
/*       */     
/* 16340 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16342 */       sendSafeServerMessage("You must have at least the size of the area included. (MISSING W)");
/*       */       
/*       */       return;
/*       */     } 
/*       */     try {
/* 16347 */       West = Integer.parseInt(tokenizer.nextToken());
/* 16348 */       if (West < 0) {
/* 16349 */         sendSafeServerMessage("The WEST value may not be negative!");
/*       */         
/*       */         return;
/*       */       } 
/* 16353 */     } catch (NumberFormatException nfe) {
/*       */       
/* 16355 */       sendSafeServerMessage("The WEST value must be an integer!");
/*       */       
/*       */       return;
/*       */     } 
/*       */     
/* 16360 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16362 */       extra = 0;
/*       */     } else {
/*       */ 
/*       */       
/*       */       try {
/* 16367 */         extra = Integer.parseInt(tokenizer.nextToken());
/*       */       }
/* 16369 */       catch (NumberFormatException nfe) {
/*       */         
/* 16371 */         sendSafeServerMessage("The Extra slopes value must be an integer!");
/*       */         
/*       */         return;
/*       */       } 
/*       */     } 
/*       */     
/* 16377 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16379 */       minDirt = 1.0F;
/*       */     } else {
/*       */ 
/*       */       
/*       */       try {
/* 16384 */         int temp = Integer.parseInt(tokenizer.nextToken());
/* 16385 */         minDirt = temp / 10.0F;
/*       */       }
/* 16387 */       catch (NumberFormatException nfe) {
/*       */         
/* 16389 */         sendSafeServerMessage("The Minimum Dirt value must be an integer!");
/*       */         
/*       */         return;
/*       */       } 
/*       */     } 
/* 16394 */     int startX = this.player.getTileX() - West;
/* 16395 */     int startY = this.player.getTileY() - North;
/* 16396 */     int endX = this.player.getTileX() + East;
/* 16397 */     int endY = this.player.getTileY() + South;
/*       */     
/* 16399 */     Terraforming.flattenImmediately((Creature)this.player, startX, endX, startY, endY, minDirt, extra, false);
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageGenerateDeadVillage(int power, String message) {
/* 16405 */     if (power < 5) {
/*       */       return;
/*       */     }
/* 16408 */     if (this.player.hasLink()) {
/*       */ 
/*       */ 
/*       */       
/* 16412 */       if (this.player.getLogger() != null) {
/* 16413 */         this.player.getLogger().info(message);
/*       */       }
/*       */       
/* 16416 */       String[] splits = message.split(" ");
/* 16417 */       int num = 1;
/* 16418 */       if (splits.length > 1) {
/*       */         
/*       */         try {
/*       */           
/* 16422 */           num = Integer.parseInt(splits[1]);
/*       */         }
/* 16424 */         catch (NumberFormatException nfe) {
/*       */           
/* 16426 */           sendSafeServerMessage("Usage: #generateDeadVillage [num]");
/*       */           
/*       */           return;
/*       */         } 
/*       */       }
/*       */       
/*       */       try {
/* 16433 */         for (int i = 0; i < num; i++) {
/* 16434 */           Villages.generateDeadVillage(this.player, (num <= 5));
/*       */         }
/* 16436 */       } catch (IOException e) {
/*       */         
/* 16438 */         sendSafeServerMessage("Failed to generate dead village because of an error: " + e.getMessage());
/*       */         
/*       */         return;
/*       */       } 
/* 16442 */       sendSafeServerMessage("Alright, successfully completed generation for " + num + " dead villages.");
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessagePayGms(int power, String message) {
/* 16448 */     if (power < 3)
/*       */       return; 
/* 16450 */     if (!this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/* 16459 */     if (!Servers.localServer.LOGINSERVER) {
/*       */       
/* 16461 */       sendSafeServerMessage("This command needs to be used on the login server.");
/*       */       
/*       */       return;
/*       */     } 
/* 16465 */     for (PlayerInfo target : PlayerInfoFactory.getPlayerInfos()) {
/*       */       
/* 16467 */       if (target.isFlagSet(48)) {
/*       */         
/* 16469 */         String payMessage = StringUtil.format("Paying 10s to %s.", new Object[] { target.getName() });
/* 16470 */         sendSafeServerMessage(payMessage);
/* 16471 */         LoginServerWebConnection lsw = new LoginServerWebConnection();
/* 16472 */         if (lsw.addMoney((Creature)this.player, target.getName(), 100000L, "GMPay " + target.wurmId + " " + System.currentTimeMillis()))
/*       */         {
/* 16474 */           sendSafeServerMessage("Properly added.");
/*       */         }
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessageToggleQA(int power, String message) {
/* 16482 */     if (power < 3)
/*       */       return; 
/* 16484 */     if (!this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/* 16493 */     StringTokenizer tokenizer = new StringTokenizer(message);
/* 16494 */     tokenizer.nextToken();
/* 16495 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16497 */       sendSafeServerMessage("The name of the player to toggle QA for must be included.");
/*       */       
/*       */       return;
/*       */     } 
/* 16501 */     String playerName = tokenizer.nextToken();
/*       */     
/*       */     try {
/* 16504 */       Player target = Players.getInstance().getPlayer(playerName);
/* 16505 */       if (target.hasLink())
/*       */       {
/* 16507 */         Logger pLogger = this.player.getLogger();
/* 16508 */         if (pLogger == null) {
/*       */           
/* 16510 */           sendSafeServerMessage("Unable to log this event so aborting.");
/*       */           return;
/*       */         } 
/* 16513 */         target.setFlag(26, !target.isQAAccount());
/* 16514 */         String toggleMessage = StringUtil.format("Toggled QA status: %s for: %s.", new Object[] {
/*       */               
/* 16516 */               Boolean.toString(target.isQAAccount()), playerName
/*       */             });
/* 16518 */         sendSafeServerMessage(toggleMessage);
/* 16519 */         pLogger.log(Level.INFO, toggleMessage);
/*       */       }
/*       */       else
/*       */       {
/* 16523 */         toggleQAInInfo(power, playerName);
/*       */       }
/*       */     
/* 16526 */     } catch (NoSuchPlayerException nsp) {
/*       */       
/* 16528 */       toggleQAInInfo(power, playerName);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void toggleQAInInfo(int power, String playerName) {
/* 16534 */     if (power < 3)
/*       */       return; 
/* 16536 */     if (!this.player.hasLink())
/*       */       return; 
/* 16538 */     Logger pLogger = this.player.getLogger();
/* 16539 */     if (pLogger == null) {
/*       */       
/* 16541 */       sendSafeServerMessage("Unable to log this event so aborting.");
/*       */       
/*       */       return;
/*       */     } 
/*       */     
/*       */     try {
/* 16547 */       PlayerInfo info = PlayerInfoFactory.getPlayerInfoWithName(playerName);
/* 16548 */       if (info != null)
/*       */       {
/*       */         
/*       */         try {
/* 16552 */           info.load();
/*       */         }
/* 16554 */         catch (IOException ie) {
/*       */           
/* 16556 */           String warning = "Unable to load player data for %s.";
/* 16557 */           sendSafeServerMessage(StringUtil.format("Unable to load player data for %s.", new Object[] { playerName }));
/* 16558 */           logWarn("Failed to load PlayerInfo when toggling QA flag.", ie);
/*       */           return;
/*       */         } 
/* 16561 */         info.setFlag(26, !info.isQAAccount());
/*       */         
/* 16563 */         info.save();
/* 16564 */         String toggleMessage = StringUtil.format("Toggled QA status: %s for: %s.", new Object[] {
/* 16565 */               Boolean.toString(info.isQAAccount()), playerName });
/* 16566 */         sendSafeServerMessage(toggleMessage);
/* 16567 */         pLogger.log(Level.INFO, toggleMessage);
/*       */       }
/*       */       else
/*       */       {
/* 16571 */         String warning = "Unable to find player data for: %s.";
/* 16572 */         sendSafeServerMessage(StringUtil.format("Unable to find player data for: %s.", new Object[] { playerName }));
/*       */       }
/*       */     
/* 16575 */     } catch (IOException ie) {
/*       */       
/* 16577 */       String warning = "Failed to save flag for offline player %s.";
/* 16578 */       sendSafeServerMessage(StringUtil.format("Failed to save flag for offline player %s.", new Object[] { playerName }));
/* 16579 */       logWarn("Failed to save PlayerInfo when toggling QA flag.", ie);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessageMaxCreatures(int power, String message) {
/* 16585 */     if (power < 3)
/*       */       return; 
/* 16587 */     if (!this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/* 16597 */     StringTokenizer tokenizer = new StringTokenizer(message);
/* 16598 */     tokenizer.nextToken();
/* 16599 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16601 */       sendSafeServerMessage("The number of max creatures is " + Servers.localServer.maxCreatures + ". Current number of creatures is " + 
/* 16602 */           Creatures.getInstance().getNumberOfCreatures() + " (agg creatures:" + 
/* 16603 */           Creatures.getInstance().getNumberOfAgg() + ").");
/*       */       
/*       */       return;
/*       */     } 
/* 16607 */     String newVal = tokenizer.nextToken();
/*       */ 
/*       */     
/*       */     try {
/* 16611 */       int newcreatures = Integer.parseInt(newVal);
/* 16612 */       Servers.localServer.maxCreatures = newcreatures;
/* 16613 */       sendSafeServerMessage("The new number of max creatures is " + Servers.localServer.maxCreatures);
/* 16614 */       Servers.localServer.saveNewGui(Servers.localServer.id);
/*       */     }
/* 16616 */     catch (NumberFormatException nfe) {
/*       */       
/* 16618 */       sendAlertServerMessage("The number of max creatures can not be " + newVal + ". Provide a valid whole number.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageChangeModel(int power, String message) {
/* 16631 */     if (power < 1)
/*       */       return; 
/* 16633 */     StringTokenizer tokenizer = new StringTokenizer(message);
/* 16634 */     tokenizer.nextToken();
/* 16635 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16637 */       if (power < 2) {
/* 16638 */         sendSafeServerMessage("Usage: #changemodel <model>");
/*       */       } else {
/*       */         
/* 16641 */         sendSafeServerMessage("Usage: #changemodel <model> (player) (duration)");
/* 16642 */         sendSafeServerMessage("Specifying a player and duration puts an illusion on that player.");
/*       */       } 
/* 16644 */       sendSafeServerMessage("Use '#changemodel list' to see a list of models. This list is very long. Not all items have models.");
/*       */       return;
/*       */     } 
/* 16647 */     String modelName = tokenizer.nextToken();
/*       */     
/* 16649 */     if (modelName.equals("list")) {
/*       */       
/* 16651 */       sendSafeServerMessage("Creatures:");
/* 16652 */       StringBuilder buf = new StringBuilder();
/* 16653 */       for (CreatureTemplate t : CreatureTemplateFactory.getInstance().getTemplates()) {
/*       */         
/* 16655 */         if (buf.length() > 120) {
/*       */           
/* 16657 */           sendSafeServerMessage(buf.toString().substring(0, buf.length() - 1));
/* 16658 */           buf = new StringBuilder();
/*       */         } 
/* 16660 */         buf.append(t.getName().replace(" ", "_")).append(" ");
/*       */       } 
/* 16662 */       sendSafeServerMessage(buf.toString());
/* 16663 */       buf = new StringBuilder();
/* 16664 */       sendSafeServerMessage("Items:");
/* 16665 */       for (ItemTemplate t : ItemTemplateFactory.getInstance().getTemplates()) {
/*       */         
/* 16667 */         if (buf.length() > 120) {
/*       */           
/* 16669 */           sendNormalServerMessage(buf.toString());
/* 16670 */           buf = new StringBuilder();
/*       */         } 
/* 16672 */         buf.append(t.getName().replace(" ", "_")).append(" ");
/*       */       } 
/* 16674 */       sendSafeServerMessage(buf.toString().substring(0, buf.length() - 1));
/*       */       
/*       */       return;
/*       */     } 
/* 16678 */     if (modelName.equals("gmdark") && power > 1) {
/*       */       
/* 16680 */       this.player.setModelName("model.creature.gmdark");
/* 16681 */       sendSafeServerMessage("This isn't even your final form, is it?");
/*       */       return;
/*       */     } 
/* 16684 */     if (modelName.equals("gmnormal") || modelName.equals("normal")) {
/*       */       
/* 16686 */       this.player.setModelName("Human");
/* 16687 */       sendSafeServerMessage("You return to normal.");
/*       */       
/*       */       return;
/*       */     } 
/* 16691 */     String model = modelName;
/*       */     
/* 16693 */     if (!modelName.contains(".")) {
/*       */       
/* 16695 */       model = CreatureTemplateFactory.getInstance().getModelNameOrNull(modelName.replace("_", " "));
/* 16696 */       if (model == null)
/* 16697 */         model = ItemTemplateFactory.getInstance().getModelNameOrNull(modelName.replace("_", " ")); 
/* 16698 */       if (model == null) {
/*       */         
/* 16700 */         sendSafeServerMessage("Model not found: " + modelName);
/*       */         
/*       */         return;
/*       */       } 
/*       */     } 
/* 16705 */     if (power >= 2 && tokenizer.hasMoreTokens()) {
/*       */       
/* 16707 */       if (Servers.isThisAPvpServer() && power < 4) {
/*       */         
/* 16709 */         sendSafeServerMessage("You cannot use this command on PvP server.");
/*       */         
/*       */         return;
/*       */       } 
/* 16713 */       String playerName = tokenizer.nextToken();
/* 16714 */       Player targetPlayer = Players.getInstance().getPlayerOrNull(playerName);
/* 16715 */       if (targetPlayer == null) {
/*       */         
/* 16717 */         sendSafeServerMessage("Player not found: " + playerName);
/*       */         
/*       */         return;
/*       */       } 
/* 16721 */       if (targetPlayer.getPower() >= this.player.getPower()) {
/* 16722 */         targetPlayer.getCommunicator().sendAlertServerMessage(this.player.getName() + " is attempting to change your model to " + model, (byte)1);
/*       */       }
/* 16724 */       String timeString = tokenizer.nextToken();
/* 16725 */       int time = Integer.parseInt(timeString);
/* 16726 */       if (time <= 0 || time > 3600) {
/*       */         
/* 16728 */         sendSafeServerMessage("Duration must be between 1 and 3600 seconds.");
/*       */         return;
/*       */       } 
/* 16731 */       if (targetPlayer.getSpellEffects() != null) {
/*       */         
/* 16733 */         targetPlayer.getSpellEffects().addSpellEffect(new SpellEffect(targetPlayer.getWurmId(), (byte)72, 100.0F, time, (byte)9, (byte)0, true));
/*       */ 
/*       */         
/* 16736 */         targetPlayer.setModelName(model);
/* 16737 */         sendSafeServerMessage("You bestow an illusion upon " + targetPlayer.getName() + " for " + time + " seconds.");
/* 16738 */         targetPlayer.getCommunicator().sendSafeServerMessage("You feel quite different.", (byte)2);
/*       */       } 
/*       */     } else {
/*       */       
/* 16742 */       this.player.setModelName(model);
/*       */     } 
/*       */   }
/*       */   
/*       */   private void handleHashMessageGMLight(int power, String message) {
/* 16747 */     if (power <= 1)
/*       */       return; 
/* 16749 */     this.player.toggleGMLight();
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessageIsQA(int power, String message) {
/* 16754 */     if (power < 3)
/*       */       return; 
/* 16756 */     if (!this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/* 16766 */     StringTokenizer tokenizer = new StringTokenizer(message);
/* 16767 */     tokenizer.nextToken();
/* 16768 */     if (!tokenizer.hasMoreTokens()) {
/*       */       
/* 16770 */       sendSafeServerMessage("The name of the player to check QA status for must be included.");
/*       */       
/*       */       return;
/*       */     } 
/* 16774 */     String playerName = tokenizer.nextToken();
/*       */ 
/*       */     
/*       */     try {
/* 16778 */       Player target = Players.getInstance().getPlayer(playerName);
/* 16779 */       String returnMessage = "%s QA status: %s";
/* 16780 */       sendSafeServerMessage(StringUtil.format("%s QA status: %s", new Object[] { playerName, 
/* 16781 */               Boolean.toString(target.isQAAccount()) }));
/*       */     }
/* 16783 */     catch (NoSuchPlayerException nsp) {
/*       */       
/* 16785 */       isQAInfo(power, playerName);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void isQAInfo(int power, String playerName) {
/* 16791 */     if (power < 3)
/*       */       return; 
/* 16793 */     if (!this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/* 16803 */     PlayerInfo info = PlayerInfoFactory.getPlayerInfoWithName(playerName);
/* 16804 */     if (info != null) {
/*       */ 
/*       */       
/*       */       try {
/* 16808 */         info.load();
/* 16809 */         String returnMessage = "%s QA status: %s";
/* 16810 */         sendSafeServerMessage(StringUtil.format("%s QA status: %s", new Object[] { playerName, 
/* 16811 */                 Boolean.toString(info.isQAAccount()) }));
/*       */       }
/* 16813 */       catch (IOException ie) {
/*       */         
/* 16815 */         String warning = "Unable to load player data for %s.";
/* 16816 */         sendSafeServerMessage(StringUtil.format("Unable to load player data for %s.", new Object[] { playerName }));
/* 16817 */         logWarn("Failed to load PlayerInfo when checking QA flag.", ie);
/*       */ 
/*       */         
/*       */         return;
/*       */       } 
/*       */     } else {
/* 16823 */       String warning = "Unable to find player data for: %s.";
/* 16824 */       sendSafeServerMessage(StringUtil.format("Unable to find player data for: %s.", new Object[] { playerName }));
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageWatchPlayer(String message) {
/* 16837 */     if (!this.player.isDead() && !this.player.isMute()) {
/*       */       
/* 16839 */       StringTokenizer tokens = new StringTokenizer(message);
/* 16840 */       tokens.nextToken();
/* 16841 */       String targetName = "";
/* 16842 */       long tId = -10L;
/* 16843 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 16845 */         targetName = tokens.nextToken().trim();
/* 16846 */         targetName = LoginHandler.raiseFirstLetter(targetName);
/* 16847 */         tId = PlayerInfoFactory.getWurmId(targetName);
/* 16848 */         if (tId == -10L) {
/*       */           
/* 16850 */           sendSafeServerMessage("Unknown player " + targetName + ".");
/*       */ 
/*       */           
/*       */           return;
/*       */         } 
/*       */       } else {
/* 16856 */         sendSafeServerMessage("Need a player's name to watch.");
/*       */         return;
/*       */       } 
/* 16859 */       String reason = "";
/* 16860 */       if (tokens.hasMoreTokens())
/* 16861 */         reason = tokens.nextToken(); 
/* 16862 */       while (tokens.hasMoreTokens())
/* 16863 */         reason = reason + ' ' + tokens.nextToken(); 
/* 16864 */       if (reason.isEmpty()) {
/*       */         
/* 16866 */         sendSafeServerMessage("Needs a reason to watch player " + targetName + ".");
/*       */         
/*       */         return;
/*       */       } 
/* 16870 */       createWatchTicket(tId, targetName, reason);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void createWatchTicket(long playerId, String playerName, String reason) {
/* 16878 */     Ticket ticket = new Ticket(Tickets.getNextTicketNo(), System.currentTimeMillis(), playerId, playerName, (byte)11, Servers.getLocalServerId(), true, 0L, (byte)5, (byte)2, "", reason, true, (short)0, true);
/*       */ 
/*       */     
/* 16881 */     ticket.save();
/* 16882 */     Tickets.addTicket(ticket, false);
/* 16883 */     Tickets.addTicketToSend(ticket);
/* 16884 */     ticket.sendTicketGlobal();
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageResetAppointments(String message) {
/* 16896 */     String[] words = message.split(" ");
/* 16897 */     if (words.length != 2) {
/*       */       
/* 16899 */       sendNormalServerMessage("Usage: #resetappointments <kingdomId>");
/*       */       return;
/*       */     } 
/* 16902 */     byte kId = Byte.parseByte(words[1]);
/* 16903 */     if (kId == 0) {
/*       */       
/* 16905 */       sendNormalServerMessage("Usage: #resetappointments <kingdomId>");
/*       */       return;
/*       */     } 
/* 16908 */     King.getCurrentAppointments(kId).resetAppointments(kId);
/* 16909 */     sendNormalServerMessage("Appointments reset.");
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageClearAppointments(String message) {
/* 16921 */     String[] words = message.split(" ");
/* 16922 */     if (words.length != 2) {
/*       */       
/* 16924 */       sendNormalServerMessage("Usage: #clearappointments <player>");
/*       */       return;
/*       */     } 
/*       */     try {
/* 16928 */       Player p = Players.getInstance().getPlayer(words[1]);
/* 16929 */       (p.getSaveFile()).appointments = 0L;
/* 16930 */       sendNormalServerMessage("Appointments cleared.");
/*       */     }
/* 16932 */     catch (NoSuchPlayerException nsp) {
/*       */       
/* 16934 */       sendNormalServerMessage("That player is not online.");
/*       */       return;
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageGive(String message) {
/* 16948 */     String[] words = message.split(" ");
/* 16949 */     if (words.length < 2 || words.length > 4) {
/*       */       
/* 16951 */       sendNormalServerMessage("Correct usage is: #give <ID> [ql] [amount]");
/*       */       
/*       */       return;
/*       */     } 
/*       */     
/* 16956 */     int[] itemData = { 0, 50, 1 };
/*       */     
/* 16958 */     for (int i = 0; i < words.length - 1; i++) {
/*       */ 
/*       */       
/*       */       try {
/* 16962 */         itemData[i] = Integer.parseInt(words[i + 1]);
/*       */       
/*       */       }
/* 16965 */       catch (NumberFormatException e) {
/*       */         
/* 16967 */         sendNormalServerMessage("You can only use numbers for the ID, ql or amount");
/*       */         
/*       */         return;
/*       */       } 
/*       */     } 
/*       */     
/* 16973 */     itemData[0] = Math.max(itemData[0], 0);
/*       */ 
/*       */     
/* 16976 */     itemData[1] = Math.max(itemData[1], 1);
/* 16977 */     itemData[1] = Math.min(itemData[1], 99);
/* 16978 */     itemData[2] = Math.max(itemData[2], 1);
/* 16979 */     itemData[2] = Math.min(itemData[2], 99);
/*       */ 
/*       */     
/* 16982 */     Item item = null;
/*       */ 
/*       */     
/*       */     try {
/* 16986 */       for (int j = 0; j < itemData[2]; j++)
/*       */       {
/* 16988 */         item = ItemFactory.createItem(itemData[0], itemData[1], this.player.getName());
/* 16989 */         this.player.getInventory().insertItem(item);
/*       */       }
/*       */     
/* 16992 */     } catch (NoSuchTemplateException|FailedException e) {
/*       */       
/* 16994 */       sendNormalServerMessage("This item id does not exist!");
/*       */       
/*       */       return;
/*       */     } 
/* 16998 */     sendNormalServerMessage("You magically create " + itemData[2] + " " + item.getName() + " with a quality of " + itemData[1]);
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public final boolean stillLoggingIn() {
/* 17005 */     return this.justLoggedIn;
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void respondEigcTeamMute(String muted, int teamId, byte muteState) {
/*       */     try {
/* 17012 */       Player p = Players.getInstance().getPlayer(LoginHandler.raiseFirstLetter(muted));
/* 17013 */       if (p != null) {
/*       */ 
/*       */ 
/*       */         
/* 17017 */         int soundSourceId = Math.abs(generateSoundSourceId(p.getWurmId()));
/* 17018 */         p.getCommunicator().sendEigcMute(soundSourceId, teamId, muteState);
/* 17019 */         if (muteState == 0)
/*       */         {
/* 17021 */           p.getCommunicator().sendSafeServerMessage("Voice team chat enabled.");
/* 17022 */           this.player.getCommunicator().sendSafeServerMessage(muted + " now has enabled voice team chat.");
/*       */         }
/*       */         else
/*       */         {
/* 17026 */           p.getCommunicator().sendSafeServerMessage("Voice team chat disabled.");
/* 17027 */           this.player.getCommunicator().sendSafeServerMessage(muted + " had voice team chat disabled.");
/*       */         }
/*       */       
/*       */       } 
/* 17031 */     } catch (NoSuchPlayerException nsp) {
/*       */       
/* 17033 */       sendAlertServerMessage("No such player: " + muted);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendEigcMute(int soundSourceId, int teamId, byte muteState) {
/* 17039 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 17043 */         ByteBuffer bb = this.connection.getBuffer();
/* 17044 */         bb.put((byte)123);
/* 17045 */         bb.putInt(Math.abs(soundSourceId));
/* 17046 */         bb.putInt(teamId);
/* 17047 */         bb.put(muteState);
/* 17048 */         this.connection.flush();
/*       */       }
/* 17050 */       catch (Exception ex) {
/*       */         
/* 17052 */         logInfo(this.player.getName() + " could not send team invite" + teamId + " due to : " + ex.getMessage(), ex);
/* 17053 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void respondEigcTeamInvite(int teamId, String inviter, String invited) {
/*       */     try {
/* 17062 */       Player p = Players.getInstance().getPlayer(LoginHandler.raiseFirstLetter(invited));
/* 17063 */       if (p != null) {
/*       */         
/* 17065 */         if (p.getKingdomId() == this.player.getKingdomId()) {
/*       */           
/* 17067 */           EigcClient client = Eigc.getClientWithId(p.getEigcId());
/* 17068 */           if (client != null)
/*       */           {
/* 17070 */             p.getCommunicator().sendTeamInvite(teamId, inviter);
/* 17071 */             p.getCommunicator().sendSafeServerMessage("You have been invited by " + inviter + " to join his voice chat team.");
/*       */             
/* 17073 */             this.player.getCommunicator().sendSafeServerMessage("You invite " + invited + " to join your voice chat team.");
/*       */ 
/*       */           
/*       */           }
/*       */           else
/*       */           {
/*       */             
/* 17080 */             sendAlertServerMessage("No such player: " + invited);
/*       */           }
/*       */         
/*       */         } else {
/*       */           
/* 17085 */           sendAlertServerMessage("No such player: " + invited);
/*       */         }
/*       */       
/*       */       } else {
/*       */         
/* 17090 */         sendAlertServerMessage("No such player: " + invited);
/*       */       }
/*       */     
/* 17093 */     } catch (NoSuchPlayerException nsp) {
/*       */       
/* 17095 */       sendAlertServerMessage("No such player: " + invited);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendTeamInvite(int teamId, String inviter) {
/* 17101 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 17105 */         ByteBuffer bb = this.connection.getBuffer();
/* 17106 */         bb.put((byte)104);
/* 17107 */         bb.putInt(teamId);
/* 17108 */         byte[] inviterStringArr = inviter.getBytes("UTF-8");
/* 17109 */         bb.put((byte)inviterStringArr.length);
/* 17110 */         bb.put(inviterStringArr);
/* 17111 */         this.connection.flush();
/*       */       }
/* 17113 */       catch (Exception ex) {
/*       */         
/* 17115 */         logInfo(this.player.getName() + " could not send team invite" + teamId + " due to : " + ex.getMessage(), ex);
/* 17116 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private void respondEigcName(String playerNameAsked) {
/* 17123 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/* 17125 */       String eigcName = "garbage";
/*       */       
/*       */       try {
/* 17128 */         Player p = Players.getInstance().getPlayer(LoginHandler.raiseFirstLetter(playerNameAsked));
/* 17129 */         if (p != null) {
/*       */           
/* 17131 */           if (p.getKingdomId() == this.player.getKingdomId()) {
/*       */             
/* 17133 */             EigcClient client = Eigc.getClientForPlayer(playerNameAsked);
/* 17134 */             if (client != null) {
/*       */               
/* 17136 */               eigcName = client.getClientId();
/*       */             } else {
/*       */               
/* 17139 */               sendAlertServerMessage(playerNameAsked + " has no active chat client.");
/*       */             } 
/*       */           } else {
/*       */             
/* 17143 */             sendAlertServerMessage("No such player: " + playerNameAsked);
/*       */           }
/*       */         
/*       */         } else {
/*       */           
/* 17148 */           sendAlertServerMessage("No such player: " + playerNameAsked);
/*       */         }
/*       */       
/* 17151 */       } catch (NoSuchPlayerException nsp) {
/*       */         
/* 17153 */         sendAlertServerMessage("No such player: " + playerNameAsked);
/*       */       } 
/*       */       
/*       */       try {
/* 17157 */         byte[] tempStringArr = eigcName.getBytes("UTF-8");
/* 17158 */         ByteBuffer bb = this.connection.getBuffer();
/* 17159 */         bb.put((byte)-1);
/* 17160 */         bb.put((byte)tempStringArr.length);
/* 17161 */         bb.put(tempStringArr);
/* 17162 */         this.connection.flush();
/* 17163 */         logInfo(this.player.getName() + " responded eigc name " + eigcName + " to : " + this.player.getName());
/*       */       }
/* 17165 */       catch (Exception ex) {
/*       */         
/* 17167 */         logInfo(this.player.getName() + " could not send eigc name " + eigcName + " due to : " + ex.getMessage(), ex);
/*       */         
/* 17169 */         this.player.setLink(false);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void respondEigcPlayerName(String eigcIdAsked) {
/* 17176 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/* 17178 */       EigcClient client = Eigc.getClientWithId(eigcIdAsked);
/* 17179 */       if (client != null) {
/*       */         
/* 17181 */         String pname = client.getPlayerName();
/* 17182 */         if (!pname.isEmpty()) {
/*       */           
/*       */           try {
/* 17185 */             byte[] tempStringArr = pname.getBytes("UTF-8");
/* 17186 */             ByteBuffer bb = this.connection.getBuffer();
/* 17187 */             bb.put((byte)-2);
/* 17188 */             bb.put((byte)tempStringArr.length);
/* 17189 */             bb.put(tempStringArr);
/* 17190 */             this.connection.flush();
/*       */           }
/* 17192 */           catch (Exception ex) {
/*       */             
/* 17194 */             logInfo(this.player.getName() + " could not send eigc name " + pname + " due to : " + ex.getMessage(), ex);
/*       */             
/* 17196 */             this.player.setLink(false);
/*       */           } 
/*       */         } else {
/* 17199 */           sendAlertServerMessage("No player is using that chat id.");
/*       */         } 
/*       */       } else {
/* 17202 */         sendAlertServerMessage("No chat client with that chat id.");
/*       */       } 
/*       */     } 
/*       */   }
/*       */   
/*       */   private void respondEigcLogin(String eigcIdAsked) {
/* 17208 */     if (this.player != null && this.player.hasLink())
/*       */     {
/* 17210 */       if (Constants.isEigcEnabled) {
/*       */         
/* 17212 */         this.player.setEigcClientId(Eigc.addPlayer(this.player.getName()));
/* 17213 */         EigcClient client = Eigc.getClientWithId(this.player.getEigcId());
/* 17214 */         if (client != null) {
/*       */           
/* 17216 */           String password = client.getPassword();
/*       */ 
/*       */ 
/*       */           
/* 17220 */           int soundSourceId = Math.abs(generateSoundSourceId(this.player.getWurmId()));
/* 17221 */           logInfo(this.player.getName() + " sending eigc client id " + client.getClientId() + ", password " + password + " soundSource " + soundSourceId);
/*       */ 
/*       */           
/*       */           try {
/* 17225 */             byte[] tempStringArr = client.getClientId().getBytes("UTF-8");
/* 17226 */             ByteBuffer bb = this.connection.getBuffer();
/* 17227 */             bb.put((byte)-3);
/* 17228 */             bb.put((byte)tempStringArr.length);
/* 17229 */             bb.put(tempStringArr);
/*       */             
/* 17231 */             byte[] pwStringArr = password.getBytes("UTF-8");
/* 17232 */             bb.put((byte)pwStringArr.length);
/* 17233 */             bb.put(pwStringArr);
/*       */             
/* 17235 */             bb.putInt(soundSourceId);
/*       */             
/* 17237 */             byte[] srvIdStringArr = Eigc.URL_PROXIMITY.getBytes("UTF-8");
/* 17238 */             bb.put((byte)srvIdStringArr.length);
/* 17239 */             bb.put(srvIdStringArr);
/*       */             
/* 17241 */             byte[] domainStringArr = Eigc.URL_SIP_REGISTRAR.getBytes("UTF-8");
/* 17242 */             bb.put((byte)domainStringArr.length);
/* 17243 */             bb.put(domainStringArr);
/*       */             
/* 17245 */             byte[] sbgURIStringArr = Eigc.URL_SIP_PROXY.getBytes("UTF-8");
/* 17246 */             bb.put((byte)sbgURIStringArr.length);
/* 17247 */             bb.put(sbgURIStringArr);
/*       */             
/* 17249 */             this.connection.flush();
/* 17250 */             setEigcServiceState(client.getServiceBundle());
/*       */           }
/* 17252 */           catch (Exception ex) {
/*       */             
/* 17254 */             logInfo(this.player.getName() + " could not login for name " + this.player.getName() + " due to : " + ex
/* 17255 */                 .getMessage(), ex);
/* 17256 */             this.player.setLink(false);
/*       */           } 
/*       */         } else {
/*       */           
/* 17260 */           sendNormalServerMessage("Failed to allocate a voice client. The server may be provisioning new accounts. You may try logging in again soon.");
/*       */         } 
/*       */       } else {
/* 17263 */         sendNormalServerMessage("Ingame voice chat is not enabled on this server.");
/*       */       } 
/*       */     }
/*       */   }
/*       */   
/*       */   public final void updateEigcInfo(EigcClient client) {
/* 17269 */     if (this.player != null && this.player.hasLink())
/*       */     {
/* 17271 */       if (Constants.isEigcEnabled) {
/*       */         
/* 17273 */         if (client != null) {
/*       */           
/* 17275 */           String password = client.getPassword();
/* 17276 */           int soundSourceId = generateSoundSourceId(this.player.getWurmId());
/*       */ 
/*       */ 
/*       */           
/*       */           try {
/* 17281 */             byte[] tempStringArr = client.getClientId().getBytes("UTF-8");
/* 17282 */             ByteBuffer bb = this.connection.getBuffer();
/* 17283 */             bb.put((byte)-3);
/* 17284 */             bb.put((byte)tempStringArr.length);
/* 17285 */             bb.put(tempStringArr);
/*       */             
/* 17287 */             byte[] pwStringArr = password.getBytes("UTF-8");
/* 17288 */             bb.put((byte)pwStringArr.length);
/* 17289 */             bb.put(pwStringArr);
/*       */             
/* 17291 */             bb.putInt(soundSourceId);
/*       */             
/* 17293 */             byte[] srvIdStringArr = Eigc.URL_PROXIMITY.getBytes("UTF-8");
/* 17294 */             bb.put((byte)srvIdStringArr.length);
/* 17295 */             bb.put(srvIdStringArr);
/*       */             
/* 17297 */             byte[] domainStringArr = Eigc.URL_SIP_REGISTRAR.getBytes("UTF-8");
/* 17298 */             bb.put((byte)domainStringArr.length);
/* 17299 */             bb.put(domainStringArr);
/*       */             
/* 17301 */             byte[] sbgURIStringArr = Eigc.URL_SIP_PROXY.getBytes("UTF-8");
/* 17302 */             bb.put((byte)sbgURIStringArr.length);
/* 17303 */             bb.put(sbgURIStringArr);
/*       */             
/* 17305 */             this.connection.flush();
/* 17306 */             setEigcServiceState(client.getServiceBundle());
/*       */           }
/* 17308 */           catch (Exception ex) {
/*       */             
/* 17310 */             logInfo(this.player.getName() + " could not login for name " + this.player.getName() + " due to : " + ex
/* 17311 */                 .getMessage(), ex);
/* 17312 */             this.player.setLink(false);
/*       */           } 
/*       */         } else {
/*       */           
/* 17316 */           sendNormalServerMessage("Failed to allocate a voice client. The server may be provisioning new accounts. You may try logging in again soon.");
/*       */         } 
/*       */       } else {
/* 17319 */         sendNormalServerMessage("Ingame voice chat is not enabled on this server.");
/*       */       } 
/*       */     }
/*       */   }
/*       */   
/*       */   public void setEigcServiceState(String serviceString) {
/* 17325 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/* 17327 */       byte serviceState = 0;
/* 17328 */       if (serviceString.contains("proximity"))
/* 17329 */         serviceState = (byte)(serviceState + 1); 
/* 17330 */       if (serviceString.contains("team"))
/* 17331 */         serviceState = (byte)(serviceState + 2); 
/* 17332 */       if (serviceString.contains("p2p"))
/* 17333 */         serviceState = (byte)(serviceState + 8); 
/* 17334 */       if (serviceString.contains("lecture"))
/* 17335 */         serviceState = (byte)(serviceState + 4); 
/* 17336 */       if (serviceString.contains("hifi")) {
/* 17337 */         serviceState = (byte)(serviceState + 16);
/*       */       }
/*       */       try {
/* 17340 */         ByteBuffer bb = this.connection.getBuffer();
/* 17341 */         bb.put((byte)-8);
/* 17342 */         bb.put(serviceState);
/* 17343 */         this.connection.flush();
/*       */       }
/* 17345 */       catch (Exception ex) {
/*       */         
/* 17347 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 17348 */         this.player.setLink(false);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private String drunkGarble(String string) {
/* 17355 */     String garbledString = string;
/* 17356 */     if (this.player.isUndead()) {
/*       */       
/* 17358 */       StringTokenizer st = new StringTokenizer(string);
/* 17359 */       while (st.hasMoreTokens()) {
/*       */         
/* 17361 */         String s = st.nextToken();
/* 17362 */         if (Server.rand.nextBoolean()) {
/*       */           
/* 17364 */           if (string.length() > 6) {
/*       */             
/* 17366 */             int start = Server.rand.nextInt(s.length() - 6);
/* 17367 */             if (Server.rand.nextBoolean()) {
/* 17368 */               garbledString = s.substring(0, start) + "HRR"; continue;
/*       */             } 
/* 17370 */             garbledString = "HSS" + s.substring(start + 6, s.length());
/*       */           } 
/*       */           
/*       */           continue;
/*       */         } 
/* 17375 */         if (string.length() > 5) {
/*       */           
/* 17377 */           int start = Server.rand.nextInt(s.length() - 5);
/* 17378 */           if (Server.rand.nextBoolean()) {
/* 17379 */             garbledString = "UUH" + s.substring(start + 5, s.length()); continue;
/*       */           } 
/* 17381 */           garbledString = s.substring(0, start) + "GHH*";
/*       */         } 
/*       */       } 
/*       */     } 
/*       */     
/* 17386 */     if (this.player.getAlcohol() > 50.0F)
/*       */     {
/* 17388 */       if (Server.rand.nextInt(Math.max(2, 10 - (int)(this.player.getAlcohol() / 10.0F))) == 0)
/*       */       {
/* 17390 */         if (Server.rand.nextBoolean()) {
/*       */           
/* 17392 */           if (string.length() > 6)
/*       */           {
/* 17394 */             int start = Server.rand.nextInt(string.length() - 6);
/* 17395 */             if (Server.rand.nextInt(2) == 0) {
/* 17396 */               garbledString = string.substring(0, start) + "*burp*" + string.substring(start + 6, string.length());
/*       */             } else {
/* 17398 */               garbledString = string.substring(0, start) + "*BURP*" + string.substring(start + 6, string.length());
/*       */             }
/*       */           
/*       */           }
/*       */         
/* 17403 */         } else if (string.length() > 5) {
/*       */           
/* 17405 */           int start = Server.rand.nextInt(string.length() - 5);
/* 17406 */           if (Server.rand.nextInt(2) == 0) {
/* 17407 */             garbledString = string.substring(0, start) + "*hic*" + string.substring(start + 5, string.length());
/*       */           } else {
/* 17409 */             garbledString = string.substring(0, start) + "*HIC*" + string.substring(start + 5, string.length());
/*       */           } 
/*       */         } 
/*       */       }
/*       */     }
/* 17414 */     return garbledString;
/*       */   }
/*       */ 
/*       */   
/*       */   private void tryInsertBankItem(Item aSubjectItem, Item target, Bank bank, Item inventory) {
/* 17419 */     if (target.isNoPut()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 17425 */       if (target.isBodyPart()) {
/*       */         
/* 17427 */         boolean found = false;
/* 17428 */         for (int x = 0; x < (target.getBodySpaces()).length; x++) {
/* 17429 */           if (target.getBodySpaces()[x] == target.getPlace())
/* 17430 */             found = true; 
/* 17431 */         }  if (!found)
/*       */         {
/* 17433 */           if (target.getPlace() != 13 && target.getPlace() != 14)
/*       */             return; 
/*       */         }
/*       */       } 
/* 17437 */       Item targetParent = null;
/* 17438 */       targetParent = Items.getItem(target.getParentId());
/* 17439 */       if (targetParent != null && targetParent.isNoPut())
/*       */         return; 
/* 17441 */       Item topParent = null;
/*       */       
/*       */       try {
/* 17444 */         topParent = Items.getItem(target.getTopParent());
/* 17445 */         if (topParent.isNoPut()) {
/*       */           return;
/*       */         }
/* 17448 */       } catch (NoSuchItemException nsi) {
/*       */         
/* 17450 */         logWarn(nsi.getMessage(), (Throwable)nsi);
/*       */       } 
/* 17452 */       if (target.isLockable() && target.getLockId() != -10L) {
/*       */         
/*       */         try {
/*       */           
/* 17456 */           Item lock = Items.getItem(target.getLockId());
/*       */           
/* 17458 */           long[] keyIds = lock.getKeyIds();
/* 17459 */           for (int x = 0; x < keyIds.length; x++) {
/*       */             
/* 17461 */             if (aSubjectItem.getWurmId() == keyIds[x]) {
/*       */               return;
/*       */             }
/*       */           } 
/* 17465 */         } catch (NoSuchItemException nsi) {
/*       */           
/* 17467 */           logWarn(target.getWurmId() + ": item has a set lock but the lock does not exist?:" + target
/* 17468 */               .getLockId(), (Throwable)nsi);
/*       */         } 
/*       */       }
/* 17471 */       if (targetParent != null && targetParent.isLockable() && targetParent.getLockId() != -10L) {
/*       */         
/*       */         try {
/*       */           
/* 17475 */           Item lock = Items.getItem(targetParent.getLockId());
/* 17476 */           long[] keyIds = lock.getKeyIds();
/* 17477 */           for (int x = 0; x < keyIds.length; x++) {
/*       */             
/* 17479 */             if (aSubjectItem.getWurmId() == keyIds[x]) {
/*       */               return;
/*       */             }
/*       */           } 
/* 17483 */         } catch (NoSuchItemException nsi) {
/*       */           
/* 17485 */           logWarn(targetParent.getWurmId() + ": item has a set lock but the lock does not exist?:" + targetParent
/* 17486 */               .getLockId(), (Throwable)nsi);
/*       */         } 
/*       */       }
/*       */       
/* 17490 */       if (target.testInsertItem(aSubjectItem)) {
/*       */         
/* 17492 */         sendRemoveFromInventory(aSubjectItem, bank.id);
/* 17493 */         bank.removeItem(aSubjectItem);
/* 17494 */         aSubjectItem.removeWatcher((Creature)this.player, false);
/*       */         
/* 17496 */         target.insertItem(aSubjectItem);
/* 17497 */         aSubjectItem.setLastMaintained(WurmCalendar.currentTime);
/*       */         
/*       */         return;
/*       */       } 
/*       */       
/* 17502 */       Item cont = Items.getItem(target.getParentId());
/* 17503 */       if (!cont.isBodyPart())
/*       */       {
/* 17505 */         if (cont.testInsertItem(aSubjectItem)) {
/*       */           
/* 17507 */           sendRemoveFromInventory(aSubjectItem, bank.id);
/* 17508 */           bank.removeItem(aSubjectItem);
/* 17509 */           aSubjectItem.removeWatcher((Creature)this.player, false);
/* 17510 */           cont.insertItem(aSubjectItem);
/* 17511 */           aSubjectItem.setLastMaintained(WurmCalendar.currentTime);
/*       */           
/*       */           return;
/*       */         } 
/*       */         
/* 17516 */         this.player.getCommunicator().sendNormalServerMessage("The " + aSubjectItem
/* 17517 */             .getName() + " will not fit in the " + cont.getName() + '.');
/*       */       
/*       */       }
/*       */     
/*       */     }
/* 17522 */     catch (NoSuchItemException nsi) {
/*       */       
/* 17524 */       logWarn(nsi.getMessage(), (Throwable)nsi);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void sendHelp() {
/* 17572 */     sendHelpMessage("Current available commands:");
/*       */     
/* 17574 */     sendHelpMessage("/addfriend <friendsname> <category> - add someone to your friends list remotely.");
/* 17575 */     sendHelpMessage("/afk [<message>] - toggles Away-From-Keyboard mode, with optional message.");
/* 17576 */     sendHelpMessage("/alliance <message> - alliance chat.");
/* 17577 */     sendHelpMessage("/almanac - shows the harvestables using the reports in almanac(s) in your inventory.");
/* 17578 */     sendHelpMessage("/attackers - shows who you have been fighting the last five minutes.");
/* 17579 */     sendHelpMessage("/ca - toggles messages to the community assistant window");
/* 17580 */     sendHelpMessage("/caringfor - shows list of creatures you are caring for.");
/* 17581 */     if (this.player.isKing())
/* 17582 */       sendHelpMessage("/challenge - sends you a popup where you can answer challenges to your sovereignty."); 
/* 17583 */     sendHelpMessage("/champs - shows the Champion Eternal Records.");
/*       */     
/* 17585 */     sendHelpMessage("/clear - clears the current tab.");
/* 17586 */     sendHelpMessage("/clear <tabName> - clears the specified tab on event side (e.g. /clear combat).");
/* 17587 */     sendHelpMessage("/converts - shows the number of times you can change kingdom");
/* 17588 */     sendHelpMessage("/fatigue - displays how much time you have left to perform fatiguing tasks.");
/* 17589 */     sendHelpMessage("/fl - shows your current combat focus level");
/* 17590 */     sendHelpMessage("/fsleep - freezes or thaws the consumption of sleep bonus. May be toggled every 5 minutes. This toggle is reset every server restart or you change server.");
/*       */     
/* 17592 */     sendHelpMessage("/ignore <player> - makes you unable to hear that player. It also adds to mute vote if used by many people at the same time.");
/* 17593 */     sendHelpMessage("/ignore - shows ignore list");
/* 17594 */     sendHelpMessage("/invitations - allows you to receive an invitation from another player to join their kingdom or religion.");
/*       */ 
/*       */ 
/*       */     
/* 17598 */     sendHelpMessage("/kingdoms - displays kingdom influence on this server.");
/*       */     
/* 17600 */     if (this.player.isChampion())
/* 17601 */       sendHelpMessage("/lives - shows the number of respawns you have left"); 
/* 17602 */     sendHelpMessage("/lotime - shows how long until you leave the game if you lose link");
/* 17603 */     sendHelpMessage("/me <emote> - replaces '/me ' with your name and sends the rest to players in the vicinity.");
/* 17604 */     sendHelpMessage("/mission - displays the last instructions received");
/* 17605 */     sendHelpMessage("/openchat <channel> - channel is one of [k]ingdom, [g]lobal kingdom or [t]rade.");
/* 17606 */     sendHelpMessage("/password <oldpassword> <newpassword> - changes your password.");
/* 17607 */     sendHelpMessage("/playtime - shows information about the time you have played.");
/* 17608 */     sendHelpMessage("/poll - In Game poll.");
/* 17609 */     sendHelpMessage("/reputation - shows your current reputation. Reputation is affected by attacking other players and stealing.");
/* 17610 */     sendHelpMessage("/random <number> - broadcasts a random number up to max <number> a few tiles.");
/* 17611 */     sendHelpMessage("/rank - shows your current battle rank.");
/* 17612 */     sendHelpMessage("/ranks - shows top battle ranks.");
/*       */     
/* 17614 */     sendHelpMessage("/refer - A premium account player may give away free silver coins or playing time once.");
/* 17615 */     sendHelpMessage("/release corpse - normally people from your kingdom may not loot your corpse. If you issue this command they may.");
/*       */     
/* 17617 */     sendHelpMessage("/remove <person> - removes person from your friends list");
/* 17618 */     sendHelpMessage("/respawn - sends a dialogue offering you to respawn when you are dead.");
/* 17619 */     sendHelpMessage("/revoke <villagename> - removes you as a citizen from the village.");
/* 17620 */     sendHelpMessage("/shout <message> - kingdom chat");
/* 17621 */     if (this.player.canSignIn()) {
/*       */       
/* 17623 */       sendHelpMessage("/signin [<message>] - signs you in.");
/* 17624 */       sendHelpMessage("/signout [<message>] - signs you out.");
/*       */     } 
/* 17626 */     sendHelpMessage("/sleep - shows how long you have left of sleep bonus.");
/* 17627 */     sendHelpMessage("/snipe <person> - (premium only) will mute the player if enough people issue this command at roughly the same time. You have only one snipe per time period.");
/*       */     
/* 17629 */     sendHelpMessage("/stopcaring - frees all the animal husbandry slots for caring.");
/* 17630 */     sendHelpMessage("/stuck - helps you getting out from trees your are stuck in.");
/* 17631 */     sendHelpMessage("/suicide - kills you. You will lose some skill!");
/* 17632 */     sendHelpMessage("/support <message> - opens up a support ticket window so you can add extra details before sending.");
/* 17633 */     sendHelpMessage("/team <message> - team chat");
/* 17634 */     sendHelpMessage("/tell <person> <message> - tells someone something ingame.");
/* 17635 */     sendHelpMessage("/time - shows current game time.");
/* 17636 */     sendHelpMessage("/tinvite <person> - invites a player to your team.");
/* 17637 */     sendHelpMessage("/title - displays the title you are currently using.");
/* 17638 */     sendHelpMessage("/titles - gives the option to select an active title among your available titles.");
/* 17639 */     sendHelpMessage("/toggleccfp - toggle visibility of the ccfp bar.");
/* 17640 */     sendHelpMessage("/tutorial - start the in-game tutorial.");
/* 17641 */     sendHelpMessage("/tweet - sends your tweet to the village twitter if enabled.");
/* 17642 */     sendHelpMessage("/uptime - shows the time since the last reboot");
/* 17643 */     sendHelpMessage("/village <message> - village chat");
/* 17644 */     sendHelpMessage("/vinvite <name> - Sends a village invite to the named player.");
/* 17645 */     sendHelpMessage("/villageinvite <name> - Sends a village invite to the named player.");
/* 17646 */     sendHelpMessage("/vteleport - Allows you to use your one free village teleport.");
/* 17647 */     sendHelpMessage("/vote <citizen> - vote for a citizen to become mayor");
/* 17648 */     sendHelpMessage("/warnings - shows information about your official moderation warnings.");
/* 17649 */     sendHelpMessage("/weather - Gives information about wind direction and speed");
/* 17650 */     sendHelpMessage("/who - shows logged on people");
/* 17651 */     sendHelpMessage("/recruit <playername> - Adds a player to your village recruit list.");
/* 17652 */     sendHelpMessage("/unrecruit <playername> - Removes a player from your village recruit list.");
/* 17653 */     sendHelpMessage("/listrecruits - Show your village recruitment list.");
/* 17654 */     sendHelpMessage("/join player <playername> - Attempts to join the village of the player, must be on the village recruitment list.");
/* 17655 */     sendHelpMessage("/join village <villagename> - Attempts to join the village, must be on the village recruitment list.");
/* 17656 */     sendHelpMessage("/mykingdoms - Displays the kingdoms you are currently affiliated with on Chaos and Epic");
/* 17657 */     ServerTweaksHandler.sendHelp(this.player);
/*       */     
/* 17659 */     sendHelpMessage("/help or /?- this message");
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void sendChangelog() {
/* 17668 */     if (Servers.isThisATestServer() && (
/* 17669 */       Servers.getLocalServerId() == 3001 || Servers.getLocalServerId() == 3002 || 
/* 17670 */       Servers.getLocalServerId() == 63505)) {
/*       */       
/* 17672 */       WurmInfo2 info = new WurmInfo2((Creature)this.player);
/* 17673 */       info.sendQuestion();
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void sendInfo() {
/* 17683 */     if (Servers.isThisATestServer() && (
/* 17684 */       Servers.getLocalServerId() == 3001 || Servers.getLocalServerId() == 3002 || 
/* 17685 */       Servers.getLocalServerId() == 63505)) {
/*       */       
/* 17687 */       WurmInfo info = new WurmInfo((Creature)this.player);
/* 17688 */       info.sendQuestion();
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void sendNews() {
/* 17698 */     if (Servers.isThisATestServer() && (
/* 17699 */       Servers.getLocalServerId() == 3001 || Servers.getLocalServerId() == 3002 || 
/* 17700 */       Servers.getLocalServerId() == 63505)) {
/*       */       
/* 17702 */       NewsInfo info = new NewsInfo((Creature)this.player);
/* 17703 */       info.sendQuestion();
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void sendDeityHelp(int power) {
/* 17709 */     sendHelpMessage("Current available commands:");
/* 17710 */     if (this.player.mayMute() || power >= 1) {
/*       */       
/* 17712 */       sendHelpMessage("#chat <int color> - colors your chat so that players understand that it is formal. The color is optional and you'll get orange otherwise, also second parmeter can be r.g.b values.");
/* 17713 */       if (power == 1)
/* 17714 */         sendHelpMessage("#invis - toggles invisibility"); 
/*       */     } 
/* 17716 */     if (this.player.mayMute() || power >= 2) {
/*       */       
/* 17718 */       sendHelpMessage("#mute <playername> <hours> <reason> - the player cannot communicate except with tell.");
/* 17719 */       sendHelpMessage("#unmute <playername> - pardons a mute.");
/* 17720 */       sendHelpMessage("#mutewarn <playername> (reason) - sends a warning that a player may be muted. The reason is optional.");
/* 17721 */       sendHelpMessage("#showmuters - displays a list of the people who can mute apart from the gms.");
/* 17722 */       sendHelpMessage("#showmuted - displays a list of the people who are muted.");
/* 17723 */       sendHelpMessage("#showcas - displays a list of the ca.");
/*       */     } 
/* 17725 */     if (power >= 2 || this.player.mayHearDevTalk())
/*       */     {
/* 17727 */       sendHelpMessage("#showdevtalkers - displays a list of the people who can see the GM Tab.");
/*       */     }
/* 17729 */     if (power >= 2) {
/*       */       
/* 17731 */       sendHelpMessage("#alerts - lets you change periodic messages from the server.");
/* 17732 */       sendHelpMessage("#announce - announces a blue system wide message.");
/* 17733 */       sendHelpMessage("#ban <playername> <days> <reason> - bans the player and the ipaddress. You must provide the number of days and a reason.");
/* 17734 */       sendHelpMessage("#banhere|#baniphere|#pardonhere|pardoniphere <playername> - bancontrol for the current server only");
/* 17735 */       sendHelpMessage("#banip <ipaddress> <days> <reason> - bans the ipaddress and kicks anyone from it. You must provide the number of days and a reason.");
/* 17736 */       sendHelpMessage("#bansteamid <steamid/player> <days> <reason> - bans the steamId");
/* 17737 */       sendHelpMessage("#kips - displays kingdom IP addresses and time since last logout.");
/* 17738 */       sendHelpMessage("#broadcast - broadcasts a system wide message.");
/* 17739 */       sendHelpMessage("#calcCreatures - Calculates number of creatures on surface, in caves, are visible, and offline, Use with care - lag prone.");
/* 17740 */       sendHelpMessage("#changeemail <playername> <newemail> - changes the email of a single player character.");
/* 17741 */       sendHelpMessage("#changemodel <model> - change character model (gmdark or gmnormal)");
/* 17742 */       sendHelpMessage("#changepassword <playername> <newpassword> - changes the password of a player.");
/* 17743 */       sendHelpMessage("#checkCreatures - error checks the positions of creatures. Will return dislocated guards for instance. May provide a name like 'templar' to check only those. Use with care - lag prone and may cause instant spawns.");
/* 17744 */       sendHelpMessage("#checkclients [<name> [true]]- sends a message to all clients that they should relaunch if they run an old client version.");
/* 17745 */       sendHelpMessage("             if <name> is specified then just send a message to the specified player to get a list of loaded classes.");
/* 17746 */       sendHelpMessage("             if [true] is specified then the list of loaded classes is NOT filted upon its return.");
/* 17747 */       sendHelpMessage("#findboat <name> - lets you find a boat with part of the name in it. May be processor heavy so if you notice lag, use with care!");
/* 17748 */       sendHelpMessage("#getAchievementData <playername> <achievement id>");
/* 17749 */       sendHelpMessage("#getip <playername> - displays the players ip address and any other accounts from the same address.");
/* 17750 */       sendHelpMessage("#getips - displays the current players with ip addresses.");
/* 17751 */       sendHelpMessage("#getwarnings <playername> - displays info about the player's warnings.");
/* 17752 */       sendHelpMessage("#gm - send a GM message to login server.");
/* 17753 */       sendHelpMessage("#gmlight - togles personal light on/off when you are invisible.");
/* 17754 */       sendHelpMessage("#hideme [GM] - hides (GM) name in MGMT and GM Tab list, if GM is specified then just the GM tab is done.");
/* 17755 */       sendHelpMessage("#invis - toggles invisibility");
/* 17756 */       sendHelpMessage("#kick <playername> - kicks the player");
/* 17757 */       sendHelpMessage("#loadItem <long id> - loads item with id, (removing from the owner).");
/* 17758 */       sendHelpMessage("#locateavatars - locates all avatars on the server and tells you where they are. It could cause lag, so use sparingly.");
/* 17759 */       sendHelpMessage("#locatehorse <string> - return the location of horses whose name contains the supplied argument string.");
/* 17760 */       sendHelpMessage("#offline - shows offline creatures with location.");
/* 17761 */       sendHelpMessage("#onfire - toggles player fire.");
/* 17762 */       sendHelpMessage("#online <playername> - returns the current status and server of the given player");
/* 17763 */       sendHelpMessage("#pardon <playername> - pardons the player and the ipaddress");
/* 17764 */       sendHelpMessage("#pardonip <ipaddress> - pardons the ipaddress");
/* 17765 */       sendHelpMessage("#pardonsteamid <steamid> - pardons the steamid");
/* 17766 */       sendHelpMessage("#plimit <new number> - the number when the server no longer accepts free players. It will always let premiums in though.");
/* 17767 */       sendHelpMessage("#reload <creatureId or playername> - reload a player or creature when bugged.");
/* 17768 */       sendHelpMessage("#rename <oldname> <newname> <password> - renames the player. The player must be LOGGED OFF.");
/* 17769 */       sendHelpMessage("#resetwarnings <playername> - resets the players warnings to 0.");
/* 17770 */       sendHelpMessage("#respawn <playername> - respawns a dead player at the start.");
/* 17771 */       sendHelpMessage("#setmuter <name> - gives or removes the ability to a normal player to mute other players.");
/* 17772 */       sendHelpMessage("#setreputation <playername> <new reputation> - sets the reputation of a player.");
/* 17773 */       sendHelpMessage("#setserver <playername> <serverid> - tells this server that the player is on the server with the number specified.");
/* 17774 */       sendHelpMessage("#showbans - displays current bans");
/* 17775 */       sendHelpMessage("#showheros [power] - displays a list of the people with power (defaults to Hero).");
/* 17776 */       if (power < 3)
/* 17777 */         sendHelpMessage("#showme - shows (GM) name in MGMT Tab list."); 
/* 17778 */       sendHelpMessage("#soundspam - spams area around you with random sounds for testing.");
/* 17779 */       sendHelpMessage("#timemod <hours> - modifies your current time with the number of hours. Can be negative.");
/* 17780 */       sendHelpMessage("#toggleEpic - toggles epic portals");
/* 17781 */       sendHelpMessage("#toggleglobal - toggles global chat.");
/* 17782 */       sendHelpMessage("#warn <playername> - the player receives an official warning.");
/* 17783 */       sendHelpMessage("#watch <playername> <description> - creates a 'watch' ticket.");
/* 17784 */       sendHelpMessage("#who [J|H|M] - sends a list of players online from Jenn-kellon, HOTS, or Mol-Rehan respectively");
/* 17785 */       sendHelpMessage("#worth <name> - helps debug royal level kills on pvp servers.");
/*       */     } 
/* 17787 */     if (power >= 3) {
/*       */       
/* 17789 */       sendHelpMessage("#addmoney <name months days silvers detail> - adds prem or silver to a players account. Detail needs to be any unique string like paypal id or 'reimburseXox22332'. Example: #addmoney rolf 0 2 2 add2days2silverrolf");
/* 17790 */       sendHelpMessage("#addtitle <name> [<title id>] - adds the default title Clairvoyant to bug reporters. title id is optional.");
/* 17791 */       sendHelpMessage("#allowall - opens the server for new connections. (leaves maintenance mode).");
/* 17792 */       sendHelpMessage("#artist <name> <sound> <graphics> - toggle artist privileges. example:  #artist mrb false true.");
/* 17793 */       sendHelpMessage("#creaturepos - toggles creature position logging.");
/* 17794 */       sendHelpMessage("#devtalk <name> - toggles the ability to a normal player to hear the gm chat.");
/* 17795 */       sendHelpMessage("#dumpxml - generates a new epic xml on the login server.");
/* 17796 */       sendHelpMessage("#invuln - toggles invulnerability mode.");
/* 17797 */       sendHelpMessage("#itempos <id> - checks the position of an item.");
/* 17798 */       sendHelpMessage("#maxcreatures <newvalue> - sets the number of max creature to a new value.");
/* 17799 */       sendHelpMessage("#newmission <deityname> - generates a new epic mission for the provided deity.");
/* 17800 */       sendHelpMessage("#overrideshop <name> <true|false> - if set to true the player may use the shop even though he has had previous payment reversals.");
/* 17801 */       sendHelpMessage("#readlog - Reads and displays the player's log from the server filesystem. TODO. ");
/* 17802 */       sendHelpMessage("#redeem - functionality to retrieve items from banned players.");
/* 17803 */       sendHelpMessage("#registermail - registers player email in list.");
/* 17804 */       sendHelpMessage("#removetitle <name> [<title id>] - removes the default title Community Assistant. title id is optional.");
/* 17805 */       sendHelpMessage("#resetplayer <name> - resets the players skills and faith to max 20. Also removes champion/realdeath.");
/* 17806 */       sendHelpMessage("#sdown - displays a message that the server is shutting down and rejects new connections. Does not shut down (enters maintenance mode).");
/* 17807 */       sendHelpMessage("#startx <number> - sets the tile X where new players (Jenn-Kellon, or for home servers all players) start to the number given.");
/* 17808 */       sendHelpMessage("#starty <number> - sets the tile Y where new players (Jenn-Kellon, or for home servers all players) start to the number given.");
/* 17809 */       sendHelpMessage("#togglemission <missionname> - enables or disables the mission with the name supplied.");
/* 17810 */       sendHelpMessage("#togglemounts - enables or disables riding, driving and horse spawning.");
/* 17811 */       sendHelpMessage("#toggleqa <name> - toggles the QA status on or off for the account.");
/* 17812 */       sendHelpMessage("#toggleflag <name> <flagid> - toggles the flag on or off for the account.");
/* 17813 */       sendHelpMessage("#isqa <name> - Checks if account has QA status.");
/* 17814 */       sendHelpMessage("#getStoredCreatures - List the WurmID and names of stored creatures on this server.");
/* 17815 */       if (Servers.localServer.testServer) {
/*       */         
/* 17817 */         sendHelpMessage("#addfakemo value <owner> <parent> - adds fake money to your inventory with the optionally provided owner and parent item.");
/*       */       }
/*       */       else {
/*       */         
/* 17821 */         sendHelpMessage("#addmoney name months days silvers detail - adds to a players account. Detail is the paypal transaction id.");
/*       */       } 
/*       */     } 
/* 17824 */     if (power >= 4) {
/*       */       
/* 17826 */       sendHelpMessage("#flattenRock <N>, <E>, <S>, <W>, [Extra Distance Below] ");
/* 17827 */       sendHelpMessage("              - Custom sized flatten zone. Flattens to rock instead of dirt.");
/* 17828 */       sendHelpMessage("#flattenDirt <N>, <E>, <S>, <W>, [Extra Distance Below], [Min Dirt Distance to Rock]");
/* 17829 */       sendHelpMessage("              - Pretty self-explanatory.");
/* 17830 */       sendHelpMessage("#setpower <player> <power>, sets the power of a player. 0=Normal, 1=Hero, 2=Demigod, 3=High-god, 4=Arch, 5=Dev.");
/* 17831 */       sendHelpMessage("#listdens, shows a list of all unique dens.");
/* 17832 */       sendHelpMessage("#removeden <templateID>, removes a unique den with a certain template ID");
/* 17833 */       sendHelpMessage("#reloadItems <wurmId> - checks for all subitems of the given itemId and forces them back into that item.");
/* 17834 */       sendHelpMessage("#showPersonalGoals <playerName> - Shows the current (and old) personal goals of the player");
/*       */     } 
/* 17836 */     if (power >= 5) {
/*       */       
/* 17838 */       sendHelpMessage("#addreimb name months days silvers setbok - adds to a players reimbursement pool.");
/* 17839 */       sendHelpMessage("#addregalia name - adds kingdom regalia.");
/* 17840 */       sendHelpMessage("#checkItems - error checks the positions of items. Use with care - lag prone.");
/* 17841 */       sendHelpMessage("#checkZones - Error checks the surface and cave zones. TODO. ");
/* 17842 */       sendHelpMessage("#createportals - create Freedom Portals. TODO. ");
/* 17843 */       sendHelpMessage("#enableboats - create boat entriess. TODO. ");
/* 17844 */       sendHelpMessage("#findfish - lists the close special fish spots.");
/* 17845 */       if (Servers.isThisATestServer())
/* 17846 */         sendHelpMessage("#findoldfish - lists the old close rare fish spots."); 
/* 17847 */       sendHelpMessage("#lagstatus - gives the count in real seconds from startup versus the number of seconds ticked.");
/* 17848 */       sendHelpMessage("#locate <string> - return the location of creature with name containing the supplied argument string.");
/* 17849 */       sendHelpMessage("#locateitem <templateid> - return the location of the end game item with that id.");
/* 17850 */       sendHelpMessage("#noxmas - remove Christmas light effect from player. ");
/* 17851 */       sendHelpMessage("#playerstatuses - shows how long until a player should leave the world, or if they should be logged off already.");
/* 17852 */       sendHelpMessage("#removeknownrecipes [player] [recipeId]");
/* 17853 */       sendHelpMessage("           - removes all known recieps from specified player (if just player specified)");
/* 17854 */       sendHelpMessage("             OR the specified recipe from all players (if just recipe specified)");
/* 17855 */       sendHelpMessage("             OR the specified recipe from the specified player (if both specified).");
/* 17856 */       sendHelpMessage("#removeNamedRecipe [player or recipeId] [\"remove\"]");
/* 17857 */       sendHelpMessage("           - show recipe/player from named list ");
/* 17858 */       sendHelpMessage("             OR remove entry from named list (if 2nd param is \"remove\").");
/* 17859 */       sendHelpMessage("#uniques - shows all unique creatures. Caution prone to lag. TODO");
/* 17860 */       sendHelpMessage("#vespeed <speed> - sets vehicle speed (0-255).");
/* 17861 */       sendHelpMessage("#date <date> - show the date in real date.");
/* 17862 */       sendHelpMessage("#wurmdate <wurmdate> - show the date in wurm calendar format.");
/* 17863 */       sendHelpMessage("#xmaslight - create Christmas light effect at current location.");
/* 17864 */       sendHelpMessage("#dumpcavewater - creates a png image of the cave water types (waterCaveTypes.png)");
/* 17865 */       sendHelpMessage("#dumpcreatures - creates a png image of the map with creatures on it.");
/* 17866 */       sendHelpMessage("#dumpmarkers - creates a png image of the map for markers.");
/* 17867 */       sendHelpMessage("#dumproutes - creates a png image of the map for routes.");
/* 17868 */       sendHelpMessage("#dumpsurfacewater - creates a png image of the surface water types (waterSurfaceTypes.png)");
/* 17869 */       sendHelpMessage("#give <id> [ql] [amount] - gives you an item with the specified parameters. Use id 176 for ebony wand.");
/* 17870 */       sendHelpMessage("#generateDeadVillage [number] - generates a number of dead villages for archaeology purposes. A number more than 5 will not return info about the villages, just if it was successful or not.");
/*       */     } 
/*       */     
/* 17873 */     if (this.player.mayAppointPlayerAssistant())
/*       */     {
/* 17875 */       sendHelpMessage("#toggleca <name> - toggles the community assistant flag for the named player.");
/*       */     }
/* 17877 */     sendHelpMessage("#help - this message");
/*       */   }
/*       */ 
/*       */   
/*       */   private void createFreedomPortals() {
/* 17882 */     if (hasCreated) {
/*       */       
/* 17884 */       sendNormalServerMessage("Already done.");
/*       */       
/*       */       return;
/*       */     } 
/* 17888 */     hasCreated = true;
/* 17889 */     int x = 0;
/* 17890 */     int y = 0;
/* 17891 */     while (x < Zones.worldTileSizeX) {
/*       */       
/* 17893 */       x += Server.rand.nextInt(200);
/* 17894 */       y = 0;
/* 17895 */       while (y < Zones.worldTileSizeY) {
/*       */         
/* 17897 */         y += Server.rand.nextInt(200);
/*       */         
/*       */         try {
/* 17900 */           Item portal = ItemFactory.createItem(637, Server.rand.nextFloat() * 100.0F, (x << 2), (y << 2), Server.rand
/* 17901 */               .nextFloat() * 360.0F, true, (byte)0, -10L, null);
/* 17902 */           portal.setData1(5);
/* 17903 */           sendNormalServerMessage(x + "," + y);
/*       */         }
/* 17905 */         catch (Exception ex) {
/*       */           
/* 17907 */           logInfo(ex.getMessage(), ex);
/*       */         } 
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private boolean mayMoveToInventory(Item item) {
/* 17916 */     boolean toReturn = false;
/*       */     
/*       */     try {
/* 17919 */       if (item.getParent() != null && item.getParent().isTraded()) {
/* 17920 */         return false;
/*       */       }
/* 17922 */     } catch (NoSuchItemException noSuchItemException) {}
/*       */ 
/*       */     
/* 17925 */     if (item.getOwnerId() == this.player.getWurmId())
/* 17926 */       toReturn = true; 
/* 17927 */     return toReturn;
/*       */   }
/*       */ 
/*       */   
/*       */   private void sendZones() {
/* 17932 */     Zones.calculateZones(false);
/* 17933 */     Kingdom[] kingdoms = Kingdoms.getAllKingdoms();
/* 17934 */     for (Kingdom kingdom : kingdoms) {
/*       */       
/* 17936 */       if (kingdom.existsHere())
/*       */       {
/* 17938 */         sendNormalServerMessage("Percent controlled by " + kingdom.getName() + ": " + twoDecimals
/* 17939 */             .format(Zones.getPercentLandForKingdom(kingdom.getId())));
/*       */       }
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendMessage(Message message) {
/* 17946 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 17952 */       byte[] tempStringArr = message.getMessage().getBytes("UTF-8");
/* 17953 */       byte[] window = message.getWindow().getBytes();
/* 17954 */       ByteBuffer bb = this.connection.getBuffer();
/* 17955 */       bb.put((byte)99);
/* 17956 */       bb.put((byte)window.length);
/* 17957 */       bb.put(window);
/* 17958 */       bb.put((byte)message.getRed());
/* 17959 */       bb.put((byte)message.getGreen());
/* 17960 */       bb.put((byte)message.getBlue());
/* 17961 */       bb.putShort((short)tempStringArr.length);
/* 17962 */       bb.put(tempStringArr);
/* 17963 */       bb.put((byte)0);
/* 17964 */       this.connection.flush();
/*       */     }
/* 17966 */     catch (Exception ex) {
/*       */       
/* 17968 */       logInfo(this.player.getName() + " could not send a message '" + message + "' due to : " + ex.getMessage(), ex);
/*       */       
/* 17970 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendMgmtMessage(long time, String sender, String message) {
/* 17976 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 17982 */       String fd = this.df.format(new Date(time));
/* 17983 */       byte[] tempStringArr = (fd + " <" + sender + "> " + message).getBytes("UTF-8");
/* 17984 */       byte[] window = mgmt;
/* 17985 */       ByteBuffer bb = this.connection.getBuffer();
/* 17986 */       bb.put((byte)99);
/* 17987 */       bb.put((byte)window.length);
/* 17988 */       bb.put(window);
/* 17989 */       bb.put((byte)-56);
/* 17990 */       bb.put((byte)-56);
/* 17991 */       bb.put((byte)-56);
/* 17992 */       bb.putShort((short)tempStringArr.length);
/* 17993 */       bb.put(tempStringArr);
/* 17994 */       bb.put((byte)0);
/* 17995 */       this.connection.flush();
/*       */     }
/* 17997 */     catch (Exception ex) {
/*       */       
/* 17999 */       logInfo(this.player.getName() + " could not send a MGMT message '" + message + "' due to : " + ex.getMessage(), ex);
/*       */       
/* 18001 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendGmMessage(long time, String sender, String message) {
/* 18007 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 18013 */       String fd = this.df.format(new Date(time));
/* 18014 */       byte[] tempStringArr = (fd + " <" + sender + "> " + message).getBytes("UTF-8");
/* 18015 */       byte[] window = gms;
/* 18016 */       if (message.contains(" movement too "))
/* 18017 */         window = "Warn".getBytes(); 
/* 18018 */       if (message.startsWith("Debug:"))
/* 18019 */         window = "Debug".getBytes(); 
/* 18020 */       if (sender.equals("Roads"))
/* 18021 */         window = "Roads".getBytes(); 
/* 18022 */       ByteBuffer bb = this.connection.getBuffer();
/* 18023 */       bb.put((byte)99);
/* 18024 */       bb.put((byte)window.length);
/* 18025 */       bb.put(window);
/* 18026 */       bb.put((byte)-56);
/* 18027 */       bb.put((byte)-56);
/* 18028 */       bb.put((byte)-56);
/* 18029 */       bb.putShort((short)tempStringArr.length);
/* 18030 */       bb.put(tempStringArr);
/* 18031 */       bb.put((byte)0);
/* 18032 */       this.connection.flush();
/*       */     }
/* 18034 */     catch (Exception ex) {
/*       */       
/* 18036 */       logInfo(this.player.getName() + " could not send a GM message '" + message + "' due to : " + ex.getMessage(), ex);
/*       */       
/* 18038 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAllianceMessage(String message) {
/* 18044 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 18050 */       byte[] tempStringArr = message.getBytes("UTF-8");
/*       */ 
/*       */ 
/*       */       
/* 18054 */       ByteBuffer bb = this.connection.getBuffer();
/* 18055 */       bb.put((byte)99);
/* 18056 */       bb.put((byte)alliance.length);
/* 18057 */       bb.put(alliance);
/* 18058 */       bb.put((byte)-1);
/* 18059 */       bb.put((byte)-1);
/* 18060 */       bb.put((byte)-1);
/* 18061 */       bb.putShort((short)tempStringArr.length);
/* 18062 */       bb.put(tempStringArr);
/* 18063 */       bb.put((byte)0);
/* 18064 */       this.connection.flush();
/*       */     }
/* 18066 */     catch (Exception ex) {
/*       */       
/* 18068 */       logInfo(this.player.getName() + " could not send a message '" + message + "' due to : " + ex.getMessage(), ex);
/*       */       
/* 18070 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendClearWindowMessage(String window) {
/* 18080 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 18084 */         byte[] tempStringArr = window.getBytes("UTF-8");
/* 18085 */         ByteBuffer bb = this.connection.getBuffer();
/* 18086 */         bb.put((byte)-65);
/* 18087 */         bb.put((byte)tempStringArr.length);
/* 18088 */         bb.put(tempStringArr);
/* 18089 */         this.connection.flush();
/*       */       }
/* 18091 */       catch (Exception ex) {
/*       */         
/* 18093 */         logInfo(this.player.getName() + " could not send a clear window message '" + window + "' due to : " + ex.getMessage(), ex);
/*       */         
/* 18095 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendColoredMessageCombat(List<MulticolorLineSegment> segments) {
/* 18102 */     sendColoredMessageCombat(segments, (byte)0);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendColoredMessageCombat(List<MulticolorLineSegment> segments, byte onScreenType) {
/* 18107 */     sendColoredMessage(combat, segments, onScreenType);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendColoredMessageEvent(List<MulticolorLineSegment> segments) {
/* 18112 */     sendColoredMessageEvent(segments, (byte)0);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendColoredMessageEvent(List<MulticolorLineSegment> segments, byte onScreenType) {
/* 18117 */     sendColoredMessage(event, segments, onScreenType);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendColoredMessage(String title, List<MulticolorLineSegment> segments) {
/* 18122 */     sendColoredMessage(title, segments, (byte)0);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendColoredMessage(String title, List<MulticolorLineSegment> segments, byte onScreenType) {
/*       */     try {
/* 18128 */       byte[] titleStringArr = title.getBytes("UTF-8");
/* 18129 */       sendColoredMessage(titleStringArr, segments, onScreenType);
/*       */     }
/* 18131 */     catch (UnsupportedEncodingException e) {
/*       */       
/* 18133 */       logInfo(this.player.getName() + " could not send a multicolor message due to : " + e.getMessage(), e);
/* 18134 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendColoredMessage(byte[] tabName, List<MulticolorLineSegment> segments, byte onScreenType) {
/* 18140 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 18146 */       ByteBuffer bb = this.connection.getBuffer();
/* 18147 */       bb.put((byte)45);
/* 18148 */       bb.put((byte)tabName.length);
/* 18149 */       bb.put(tabName);
/* 18150 */       bb.putShort((short)segments.size());
/* 18151 */       boolean firstSegment = true;
/* 18152 */       for (MulticolorLineSegment segment : segments) {
/*       */         
/* 18154 */         String text = segment.getText();
/* 18155 */         byte color = segment.getColor();
/* 18156 */         if (segment instanceof CreatureLineSegment) {
/*       */           
/* 18158 */           CreatureLineSegment cretSegment = (CreatureLineSegment)segment;
/* 18159 */           text = cretSegment.getText((Creature)this.player);
/* 18160 */           color = cretSegment.getColor((Creature)this.player);
/*       */         } 
/*       */         
/* 18163 */         if (firstSegment) {
/*       */           
/* 18165 */           text = StringUtilities.raiseFirstLetterOnly(text);
/* 18166 */           firstSegment = false;
/*       */         } 
/* 18168 */         byte[] tempStringArr = text.getBytes("UTF-8");
/*       */         
/* 18170 */         bb.putShort((short)tempStringArr.length);
/* 18171 */         bb.put(tempStringArr);
/* 18172 */         bb.put(color);
/*       */       } 
/* 18174 */       bb.put(onScreenType);
/* 18175 */       this.connection.flush();
/*       */     }
/* 18177 */     catch (Exception ex) {
/*       */       
/* 18179 */       logInfo(this.player.getName() + " could not send a multicolor message due to : " + ex.getMessage(), ex);
/* 18180 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendSystemMessage(String message) {
/* 18186 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 18190 */         byte[] tempStringArr = message.getBytes("UTF-8");
/*       */ 
/*       */ 
/*       */         
/* 18194 */         ByteBuffer bb = this.connection.getBuffer();
/* 18195 */         bb.put((byte)99);
/* 18196 */         bb.put((byte)system.length);
/* 18197 */         bb.put(system);
/* 18198 */         bb.put((byte)102);
/* 18199 */         bb.put((byte)-72);
/* 18200 */         bb.put((byte)120);
/* 18201 */         bb.putShort((short)tempStringArr.length);
/* 18202 */         bb.put(tempStringArr);
/* 18203 */         bb.put((byte)0);
/* 18204 */         this.connection.flush();
/*       */       }
/* 18206 */       catch (Exception ex) {
/*       */         
/* 18208 */         logInfo(this.player.getName() + " could not send a message '" + message + "' due to : " + ex.getMessage(), ex);
/*       */         
/* 18210 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendHelpMessage(String message) {
/* 18217 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 18221 */         byte[] tempStringArr = message.getBytes("UTF-8");
/*       */ 
/*       */ 
/*       */         
/* 18225 */         ByteBuffer bb = this.connection.getBuffer();
/* 18226 */         bb.put((byte)99);
/* 18227 */         bb.put((byte)help.length);
/* 18228 */         bb.put(help);
/* 18229 */         bb.put((byte)102);
/* 18230 */         bb.put((byte)-72);
/* 18231 */         bb.put((byte)120);
/* 18232 */         bb.putShort((short)tempStringArr.length);
/* 18233 */         bb.put(tempStringArr);
/* 18234 */         bb.put((byte)0);
/* 18235 */         this.connection.flush();
/*       */       }
/* 18237 */       catch (Exception ex) {
/*       */         
/* 18239 */         logInfo(this.player.getName() + " could not send a message '" + message + "' due to : " + ex.getMessage(), ex);
/*       */         
/* 18241 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendSafeServerMessage(String message) {
/* 18248 */     sendServerMessage(message, 102, 184, 120);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendSafeServerMessage(String message, byte messageType) {
/* 18253 */     sendServerMessage(message, 102, 184, 120, messageType);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendNormalServerMessage(String message) {
/* 18258 */     sendServerMessage(message, 255, 255, 255);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendNormalServerMessage(String message, byte messageType) {
/* 18263 */     sendServerMessage(message, 255, 255, 255, messageType);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendServerMessage(String message, int r, int g, int b) {
/* 18268 */     sendServerMessage(message, r, g, b, (byte)0);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendServerMessage(String message, int r, int g, int b, byte messageType) {
/* 18273 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */ 
/*       */         
/* 18279 */         byte[] tempStringArr = StringUtilities.raiseFirstLetterOnly(message).getBytes("UTF-8");
/*       */ 
/*       */ 
/*       */         
/* 18283 */         ByteBuffer bb = this.connection.getBuffer();
/* 18284 */         bb.put((byte)99);
/* 18285 */         bb.put((byte)event.length);
/* 18286 */         bb.put(event);
/* 18287 */         bb.put((byte)r);
/* 18288 */         bb.put((byte)g);
/* 18289 */         bb.put((byte)b);
/* 18290 */         bb.putShort((short)tempStringArr.length);
/* 18291 */         bb.put(tempStringArr);
/* 18292 */         bb.put(messageType);
/* 18293 */         this.connection.flush();
/*       */       }
/* 18295 */       catch (Exception ex) {
/*       */         
/* 18297 */         logInfo(this.player.getName() + " could not send a message '" + message + "' due to : " + ex.getMessage(), ex);
/*       */         
/* 18299 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendCombatNormalMessage(String message) {
/* 18306 */     sendCombatNormalMessage(message, (byte)0);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendCombatNormalMessage(String message, byte messageType) {
/* 18311 */     sendCombatServerMessage(message, (byte)-1, (byte)-1, (byte)-1, messageType);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendCombatAlertMessage(String message) {
/* 18316 */     sendCombatServerMessage(message, (byte)-1, (byte)-106, (byte)10, (byte)0);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendCombatSafeMessage(String message) {
/* 18321 */     sendCombatServerMessage(message, (byte)102, (byte)-72, (byte)120, (byte)0);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendCombatServerMessage(String message, byte r, byte g, byte b) {
/* 18326 */     sendCombatServerMessage(message, r, g, b, (byte)0);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendCombatServerMessage(String message, byte r, byte g, byte b, byte messageType) {
/* 18331 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 18335 */         byte[] tempStringArr = StringUtilities.raiseFirstLetterOnly(message).getBytes("UTF-8");
/*       */ 
/*       */ 
/*       */         
/* 18339 */         ByteBuffer bb = this.connection.getBuffer();
/* 18340 */         bb.put((byte)99);
/* 18341 */         bb.put((byte)combat.length);
/* 18342 */         bb.put(combat);
/* 18343 */         bb.put(r);
/* 18344 */         bb.put(g);
/* 18345 */         bb.put(b);
/* 18346 */         bb.putShort((short)tempStringArr.length);
/* 18347 */         bb.put(tempStringArr);
/* 18348 */         bb.put(messageType);
/* 18349 */         this.connection.flush();
/*       */       }
/* 18351 */       catch (Exception ex) {
/*       */         
/* 18353 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 18354 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendDeathServerMessage(String message, byte r, byte g, byte b) {
/* 18361 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 18365 */         byte[] tempStringArr = StringUtilities.raiseFirstLetterOnly(message).getBytes("UTF-8");
/* 18366 */         ByteBuffer bb = this.connection.getBuffer();
/* 18367 */         bb.put((byte)99);
/* 18368 */         bb.put((byte)deaths.length);
/* 18369 */         bb.put(deaths);
/* 18370 */         bb.put(r);
/* 18371 */         bb.put(g);
/* 18372 */         bb.put(b);
/* 18373 */         bb.putShort((short)tempStringArr.length);
/* 18374 */         bb.put(tempStringArr);
/* 18375 */         bb.put((byte)0);
/* 18376 */         this.connection.flush();
/*       */       }
/* 18378 */       catch (Exception ex) {
/*       */         
/* 18380 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 18381 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAlertServerMessage(String message) {
/* 18388 */     sendAlertServerMessage(message, (byte)0);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAlertServerMessage(String message, byte messageType) {
/* 18393 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 18397 */         byte[] tempStringArr = StringUtilities.raiseFirstLetterOnly(message).getBytes("UTF-8");
/*       */ 
/*       */ 
/*       */         
/* 18401 */         ByteBuffer bb = this.connection.getBuffer();
/* 18402 */         bb.put((byte)99);
/* 18403 */         bb.put((byte)event.length);
/* 18404 */         bb.put(event);
/* 18405 */         bb.put((byte)-1);
/* 18406 */         bb.put((byte)-106);
/* 18407 */         bb.put((byte)10);
/* 18408 */         bb.putShort((short)tempStringArr.length);
/* 18409 */         bb.put(tempStringArr);
/* 18410 */         bb.put(messageType);
/* 18411 */         this.connection.flush();
/*       */       }
/* 18413 */       catch (Exception ex) {
/*       */         
/* 18415 */         logInfo(this.player.getName() + ": " + ex.getMessage(), ex);
/* 18416 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendLogMessage(String message) {
/* 18427 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 18431 */         byte[] tempStringArr = message.getBytes("UTF-8");
/* 18432 */         ByteBuffer bb = this.connection.getBuffer();
/* 18433 */         bb.put((byte)99);
/* 18434 */         bb.put((byte)logs.length);
/* 18435 */         bb.put(logs);
/* 18436 */         bb.put((byte)-1);
/* 18437 */         bb.put((byte)-1);
/* 18438 */         bb.put((byte)-1);
/* 18439 */         bb.putShort((short)tempStringArr.length);
/* 18440 */         bb.put(tempStringArr);
/* 18441 */         bb.put((byte)0);
/* 18442 */         this.connection.flush();
/*       */       }
/* 18444 */       catch (Exception e) {
/*       */         
/* 18446 */         logInfo(this.player.getName() + ": " + e.getMessage(), e);
/* 18447 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddToInventory(Item item, long inventoryWindow, long rootid, int price) {
/* 18454 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 18458 */         if (item.isPlacedOnParent() && item.getTopParentOrNull() != null && item
/* 18459 */           .getTopParentOrNull().getTemplate().isContainerWithSubItems() && item
/* 18460 */           .getTopParentOrNull().getOwnerId() == -10L && this.player
/* 18461 */           .getPower() < 1) {
/*       */           return;
/*       */         }
/* 18464 */         boolean calcCorrectBulkWeight = item.isCrate();
/* 18465 */         if (item.isBulkItem()) {
/*       */           
/* 18467 */           Item parent = item.getParentOrNull();
/* 18468 */           if (parent != null && parent.isCrate())
/* 18469 */             calcCorrectBulkWeight = true; 
/*       */         } 
/* 18471 */         int weight = item.getFullWeight(calcCorrectBulkWeight);
/*       */         
/* 18473 */         ByteBuffer bb = this.connection.getBuffer();
/*       */ 
/*       */         
/* 18476 */         bb.put((byte)76);
/* 18477 */         bb.putLong(inventoryWindow);
/* 18478 */         long parentId = 0L;
/* 18479 */         if (item.isBanked()) {
/* 18480 */           parentId = inventoryWindow;
/* 18481 */         } else if (rootid != 0L && item.getParentId() > 0L) {
/* 18482 */           parentId = item.getParentId();
/* 18483 */         }  bb.putLong(parentId);
/* 18484 */         bb.putLong(item.getWurmId());
/* 18485 */         bb.putShort(item.getImageNumber());
/*       */ 
/*       */         
/* 18488 */         byte[] tempStringArr = item.getName().getBytes("UTF-8");
/* 18489 */         bb.put((byte)tempStringArr.length);
/* 18490 */         bb.put(tempStringArr);
/*       */ 
/*       */         
/* 18493 */         tempStringArr = item.getHoverText().getBytes("UTF-8");
/* 18494 */         bb.put((byte)tempStringArr.length);
/* 18495 */         bb.put(tempStringArr);
/*       */         
/* 18497 */         if (item.descIsName()) {
/* 18498 */           tempStringArr = "".getBytes("UTF-8");
/*       */         } else {
/* 18500 */           tempStringArr = item.getDescription().getBytes("UTF-8");
/* 18501 */         }  bb.put((byte)tempStringArr.length);
/* 18502 */         bb.put(tempStringArr);
/* 18503 */         bb.putFloat(item.getQualityLevel());
/* 18504 */         bb.putFloat(item.getDamage());
/* 18505 */         bb.putInt(weight);
/* 18506 */         bb.put((byte)((item.color == -1) ? 0 : 1));
/* 18507 */         if (item.color != -1) {
/*       */           
/* 18509 */           bb.put((byte)WurmColor.getColorRed(item.color));
/* 18510 */           bb.put((byte)WurmColor.getColorGreen(item.color));
/* 18511 */           bb.put((byte)WurmColor.getColorBlue(item.color));
/*       */         } 
/* 18513 */         bb.put((byte)((price >= 0) ? 1 : 0));
/* 18514 */         if (price >= 0)
/*       */         {
/* 18516 */           bb.putInt(price);
/*       */         }
/* 18518 */         int templateId = -10;
/* 18519 */         if (item.isRepairable() && item.creationState == 0) {
/*       */           
/* 18521 */           if (!item.isNewbieItem() && !item.isChallengeNewbieItem()) {
/* 18522 */             templateId = MethodsItems.getImproveTemplateId(item);
/*       */           }
/* 18524 */         } else if (item.creationState != 0) {
/* 18525 */           templateId = MethodsItems.getItemForImprovement(MethodsItems.getImproveMaterial(item), item.creationState);
/* 18526 */         }  if (item.getTemplateId() == 1307)
/*       */         {
/* 18528 */           if (item.getData1() <= 0)
/*       */           {
/* 18530 */             if (item.getAuxData() >= 65) {
/* 18531 */               templateId = 441;
/*       */             } else {
/* 18533 */               templateId = 97;
/*       */             }  } 
/*       */         }
/* 18536 */         if (templateId != -10L) {
/*       */ 
/*       */           
/*       */           try {
/* 18540 */             ItemTemplate temp = ItemTemplateFactory.getInstance().getTemplate(templateId);
/* 18541 */             bb.put((byte)1);
/* 18542 */             bb.putShort(temp.imageNumber);
/*       */           }
/* 18544 */           catch (NoSuchTemplateException nst) {
/*       */             
/* 18546 */             bb.put((byte)0);
/*       */           } 
/*       */         } else {
/*       */           
/* 18550 */           bb.put((byte)0);
/* 18551 */         }  boolean isContainer = (item.isHollow() && !item.isSealedByPlayer());
/*       */ 
/*       */ 
/*       */         
/* 18555 */         boolean toolbeltIgnoreContents = (item.getTemplateId() == 1346 || item.getTemplateId() == 1344);
/* 18556 */         bb.putShort(ItemTypeUtilites.calcProfile(false, item.isBodyPartAttached(), isContainer, item.isNoDrop(), item
/* 18557 */               .isTwoHanded(), item.isInventoryGroup(), item.doesShowSlopes(), toolbeltIgnoreContents));
/* 18558 */         bb.put(item.getMaterial());
/* 18559 */         bb.put(item.getTemperatureState(item.getTemperature()));
/* 18560 */         bb.put(item.getRarity());
/* 18561 */         bb.put(item.getAuxData());
/* 18562 */         this.connection.flush();
/*       */ 
/*       */         
/* 18565 */         if (item.isHollow() && item.getItemCount() > 0 && !item.isSealedByPlayer())
/*       */         {
/*       */           
/* 18568 */           if (!item.isEmpty(false) || !item.isNoPut())
/*       */           {
/* 18570 */             if (item.isViewableBy((Creature)this.player))
/*       */             {
/* 18572 */               sendHasMoreItems(inventoryWindow, item.getWurmId());
/*       */             }
/*       */           }
/*       */         }
/*       */       }
/* 18577 */       catch (Exception ex) {
/*       */         
/* 18579 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */     
/* 18583 */     if (item.isDye() || item.getTemplateId() == 1392) {
/* 18584 */       sendUpdateInventoryItemColor(item);
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendUpdateInventoryItem(Item item, long inventoryWindow, int price) {
/* 18609 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 18613 */         boolean calcCorrectBulkWeight = item.isCrate();
/* 18614 */         if (item.isBulkItem()) {
/*       */           
/* 18616 */           Item parent = item.getParentOrNull();
/* 18617 */           if (parent != null && parent.isCrate()) {
/* 18618 */             calcCorrectBulkWeight = true;
/*       */           }
/*       */         } 
/* 18621 */         byte[] tempStringArr = item.getName().getBytes("UTF-8");
/*       */         
/* 18623 */         ByteBuffer bb = this.connection.getBuffer();
/* 18624 */         bb.put((byte)68);
/* 18625 */         bb.putLong(inventoryWindow);
/* 18626 */         bb.putLong(item.getWurmId());
/* 18627 */         long parentId = -1L;
/*       */ 
/*       */ 
/*       */         
/* 18631 */         if (item.getParentId() > 0L) {
/* 18632 */           parentId = item.getParentId();
/* 18633 */         } else if (item.getOwnerId() != this.player.getWurmId()) {
/* 18634 */           parentId = item.getWurmId();
/*       */         } 
/*       */ 
/*       */ 
/*       */ 
/*       */         
/* 18640 */         bb.putLong(parentId);
/* 18641 */         bb.put((byte)tempStringArr.length);
/* 18642 */         bb.put(tempStringArr);
/* 18643 */         if (item.descIsName()) {
/* 18644 */           tempStringArr = "".getBytes("UTF-8");
/*       */         } else {
/* 18646 */           tempStringArr = item.getDescription().getBytes("UTF-8");
/* 18647 */         }  bb.put((byte)tempStringArr.length);
/* 18648 */         bb.put(tempStringArr);
/* 18649 */         bb.putFloat(item.getQualityLevel());
/* 18650 */         bb.putFloat(item.getDamage());
/* 18651 */         int weight = item.getFullWeight(calcCorrectBulkWeight);
/* 18652 */         bb.putInt(weight);
/* 18653 */         bb.put((byte)((item.color == -1) ? 0 : 1));
/* 18654 */         if (item.color != -1) {
/*       */           
/* 18656 */           bb.put((byte)WurmColor.getColorRed(item.color));
/* 18657 */           bb.put((byte)WurmColor.getColorGreen(item.color));
/* 18658 */           bb.put((byte)WurmColor.getColorBlue(item.color));
/*       */         } 
/* 18660 */         bb.put((byte)((price >= 0) ? 1 : 0));
/* 18661 */         if (price >= 0)
/*       */         {
/* 18663 */           bb.putInt(price);
/*       */         }
/* 18665 */         int templateId = -10;
/* 18666 */         if (item.isRepairable() && item.creationState == 0) {
/*       */           
/* 18668 */           if (!item.isNewbieItem() && !item.isChallengeNewbieItem()) {
/* 18669 */             templateId = MethodsItems.getImproveTemplateId(item);
/*       */           }
/* 18671 */         } else if (item.creationState != 0) {
/* 18672 */           templateId = MethodsItems.getItemForImprovement(MethodsItems.getImproveMaterial(item), item.creationState);
/* 18673 */         }  if (item.getTemplateId() == 1307)
/*       */         {
/* 18675 */           if (item.getData1() <= 0)
/*       */           {
/* 18677 */             if (item.getAuxData() >= 65) {
/* 18678 */               templateId = 441;
/*       */             } else {
/* 18680 */               templateId = 97;
/*       */             }  } 
/*       */         }
/* 18683 */         if (templateId != -10L) {
/*       */ 
/*       */           
/*       */           try {
/* 18687 */             ItemTemplate temp = ItemTemplateFactory.getInstance().getTemplate(templateId);
/* 18688 */             bb.put((byte)1);
/* 18689 */             bb.putShort(temp.imageNumber);
/*       */           }
/* 18691 */           catch (NoSuchTemplateException nst) {
/*       */             
/* 18693 */             bb.put((byte)0);
/*       */           } 
/*       */         } else {
/*       */           
/* 18697 */           bb.put((byte)0);
/* 18698 */         }  bb.put(item.getTemperatureState(item.getTemperature()));
/* 18699 */         bb.put(item.getRarity());
/* 18700 */         bb.put(item.getMaterial());
/* 18701 */         bb.putShort(item.getImageNumber());
/*       */         
/* 18703 */         this.connection.flush();
/*       */       }
/* 18705 */       catch (Exception ex) {
/*       */         
/* 18707 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */     
/* 18711 */     if (item.isDye() || item.getTemplateId() == 1392) {
/* 18712 */       sendUpdateInventoryItemColor(item);
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendUpdateInventoryItem(Item item) {
/* 18718 */     long inventoryWindow = item.getTopParent();
/* 18719 */     if (item.isInside(new int[] { 1333, 1334 })) {
/*       */       
/* 18721 */       Item parentBags = item.getFirstParent(new int[] { 1333, 1334 });
/* 18722 */       sendUpdateInventoryItem(item, parentBags.getWurmId(), -1);
/*       */     } 
/* 18724 */     Item parentWindow = item.recursiveParentCheck();
/* 18725 */     if (parentWindow != null && parentWindow != item)
/*       */     {
/* 18727 */       sendUpdateInventoryItem(item, parentWindow.getWurmId(), -1);
/*       */     }
/* 18729 */     if (this.player == null)
/* 18730 */       logWarn("Player is null ", new Exception()); 
/* 18731 */     if (item.getOwnerId() == this.player.getWurmId())
/* 18732 */       inventoryWindow = -1L; 
/* 18733 */     sendUpdateInventoryItem(item, inventoryWindow, -1);
/* 18734 */     if (item.isTraded()) {
/* 18735 */       item.getTradeWindow().updateItem(item);
/*       */     }
/*       */   }
/*       */   
/*       */   public void sendUpdateKingdomId() {
/* 18740 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */     
/*       */     try {
/* 18745 */       ByteBuffer bb = this.connection.getBuffer();
/* 18746 */       bb.put((byte)-37);
/* 18747 */       bb.put(this.player.getKingdomId());
/* 18748 */       this.connection.flush();
/*       */     }
/* 18750 */     catch (Exception ex) {
/*       */       
/* 18752 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendUpdateInventoryItemData(Item item) {}
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendUpdateInventoryItemParent(Item item) {}
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendUpdateInventoryItemCustomName(Item item) {}
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendUpdateInventoryItemColor(Item item) {
/* 18786 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 18790 */         long inventoryWindow = item.getTopParent();
/*       */         
/* 18792 */         if (item.getOwnerId() == this.player.getWurmId())
/* 18793 */           inventoryWindow = -1L; 
/* 18794 */         ByteBuffer bb = this.connection.getBuffer();
/* 18795 */         bb.put((byte)-7);
/* 18796 */         bb.putLong(inventoryWindow);
/* 18797 */         bb.putLong(item.getWurmId());
/* 18798 */         bb.put((byte)4);
/*       */         
/* 18800 */         if (item.getTemplateId() == 1392) {
/*       */           
/* 18802 */           bb.put(127);
/* 18803 */           bb.put(127);
/* 18804 */           bb.put(127);
/*       */         }
/*       */         else {
/*       */           
/* 18808 */           bb.put((byte)WurmColor.getColorRed(item.getColor()));
/* 18809 */           bb.put((byte)WurmColor.getColorGreen(item.getColor()));
/* 18810 */           bb.put((byte)WurmColor.getColorBlue(item.getColor()));
/*       */         } 
/*       */         
/* 18813 */         this.connection.flush();
/*       */       }
/* 18815 */       catch (Exception ex) {
/*       */         
/* 18817 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 18818 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendUpdateInventoryItemType(Item item) {}
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendUpdateInventoryItemPrice(Item item) {}
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendUpdateInventoryItemTemperature(Item item) {
/* 18850 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 18854 */         long inventoryWindow = item.getTopParent();
/*       */         
/* 18856 */         if (item.getOwnerId() == this.player.getWurmId())
/* 18857 */           inventoryWindow = -1L; 
/* 18858 */         ByteBuffer bb = this.connection.getBuffer();
/* 18859 */         bb.put((byte)-7);
/* 18860 */         bb.putLong(inventoryWindow);
/* 18861 */         bb.putLong(item.getWurmId());
/* 18862 */         bb.put((byte)7);
/*       */ 
/*       */         
/* 18865 */         byte tempState = item.getTemperatureState(item.getTemperature());
/* 18866 */         bb.put(tempState);
/* 18867 */         byte[] name = item.getName().getBytes("UTF-8");
/* 18868 */         bb.putShort((short)name.length);
/* 18869 */         bb.put(name);
/* 18870 */         this.connection.flush();
/*       */       }
/* 18872 */       catch (Exception ex) {
/*       */         
/* 18874 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */ 
/*       */     
/* 18879 */     if (item.isTraded()) {
/* 18880 */       item.getTradeWindow().updateItem(item);
/*       */     }
/*       */   }
/*       */   
/*       */   public void sendRemoveFromInventory(Item item, long inventoryWindow) {
/* 18885 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */         
/* 18897 */         ByteBuffer bb = this.connection.getBuffer();
/* 18898 */         bb.put((byte)-10);
/* 18899 */         bb.putLong(inventoryWindow);
/* 18900 */         bb.putLong(item.getWurmId());
/* 18901 */         this.connection.flush();
/*       */       }
/* 18903 */       catch (Exception ex) {
/*       */         
/* 18905 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendRemoveFromInventory(Item item) {
/* 18914 */     if (this.player != null) {
/*       */       
/* 18916 */       long inventoryWindow = item.getTopParent();
/* 18917 */       if (item.getOwnerId() == this.player.getWurmId())
/* 18918 */         inventoryWindow = -1L; 
/* 18919 */       if (item.isInside(new int[] { 1333, 1334 })) {
/*       */         
/* 18921 */         Item parentBags = item.getFirstParent(new int[] { 1333, 1334 });
/* 18922 */         sendRemoveFromInventory(item, parentBags.getWurmId());
/*       */       } 
/* 18924 */       Item parentWindow = item.recursiveParentCheck();
/* 18925 */       if (parentWindow != null && parentWindow != item)
/*       */       {
/* 18927 */         sendRemoveFromInventory(item, parentWindow.getWurmId());
/*       */       }
/* 18929 */       sendRemoveFromInventory(item, inventoryWindow);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void sendWho(byte kingdom) {
/* 18935 */     Player[] players = Players.getInstance().getPlayers();
/* 18936 */     this.player.getCommunicator().sendNormalServerMessage("Players in " + Kingdoms.getNameFor(kingdom) + ':');
/* 18937 */     for (int x = 0; x < players.length; x++) {
/*       */       
/* 18939 */       if (players[x].getKingdomId() == kingdom)
/* 18940 */         this.player.getCommunicator().sendNormalServerMessage(players[x].getName()); 
/*       */     } 
/* 18942 */     for (ServerEntry entry : Servers.getAllServers()) {
/*       */       
/* 18944 */       if (entry.id != Servers.localServer.id)
/*       */       {
/* 18946 */         this.player.getCommunicator().sendNormalServerMessage(entry.name + ": " + entry.currentPlayers + "/" + entry.pLimit);
/*       */       }
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveMapAnnotation(long id, byte type, String server) {
/* 18953 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 18957 */         ByteBuffer bb = this.connection.getBuffer();
/* 18958 */         bb.put((byte)-43);
/* 18959 */         bb.put((byte)1);
/* 18960 */         bb.putLong(id);
/* 18961 */         bb.put(type);
/* 18962 */         byte[] serverBytes = server.getBytes("UTF-8");
/* 18963 */         bb.putShort((short)serverBytes.length);
/* 18964 */         bb.put(serverBytes);
/* 18965 */         this.connection.flush();
/*       */       }
/* 18967 */       catch (Exception ex) {
/*       */         
/* 18969 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendClearMapAnnotationsOfType(byte type) {
/* 18976 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 18980 */         ByteBuffer bb = this.connection.getBuffer();
/* 18981 */         bb.put((byte)-43);
/* 18982 */         bb.put((byte)3);
/* 18983 */         bb.put(type);
/*       */         
/* 18985 */         this.connection.flush();
/*       */       }
/* 18987 */       catch (Exception ex) {
/*       */         
/* 18989 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private void sendMapAnnotationPermissions() {
/* 18996 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 19000 */         ByteBuffer bb = this.connection.getBuffer();
/* 19001 */         bb.put((byte)-43);
/* 19002 */         bb.put((byte)2);
/* 19003 */         boolean isMayor = this.player.isAllowedToEditVillageMap();
/* 19004 */         boolean isAllianceMayor = this.player.isAllowedToEditAllianceMap();
/* 19005 */         bb.put(isMayor ? 1 : 0);
/* 19006 */         bb.put(isAllianceMayor ? 1 : 0);
/* 19007 */         this.connection.flush();
/*       */       }
/* 19009 */       catch (Exception ex) {
/*       */         
/* 19011 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendMapAnnotations(MapAnnotation[] annotations) {
/* 19018 */     if (annotations == null)
/*       */       return; 
/* 19020 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 19024 */         ByteBuffer bb = this.connection.getBuffer();
/* 19025 */         bb.put((byte)-43);
/* 19026 */         bb.put((byte)0);
/* 19027 */         bb.putShort((short)annotations.length);
/* 19028 */         for (int i = 0; i < annotations.length; i++) {
/*       */           
/* 19030 */           bb.putLong(annotations[i].getId());
/* 19031 */           bb.put(annotations[i].getType());
/* 19032 */           byte[] serverBytes = annotations[i].getServer().getBytes("UTF-8");
/* 19033 */           bb.putShort((short)serverBytes.length);
/* 19034 */           bb.put(serverBytes);
/* 19035 */           bb.putShort((short)annotations[i].getXPos());
/* 19036 */           bb.putShort((short)annotations[i].getYPos());
/* 19037 */           byte[] nameBytes = annotations[i].getName().getBytes("UTF-8");
/* 19038 */           bb.putShort((short)nameBytes.length);
/* 19039 */           bb.put(nameBytes);
/* 19040 */           bb.put(annotations[i].getIcon());
/*       */         } 
/*       */         
/* 19043 */         this.connection.flush();
/*       */       }
/* 19045 */       catch (Exception ex) {
/*       */         
/* 19047 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendMapInfo() {
/* 19054 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 19058 */         ByteBuffer bb = this.connection.getBuffer();
/* 19059 */         String nameToUse = Servers.localServer.mapname;
/* 19060 */         if (nameToUse == null || nameToUse.isEmpty())
/* 19061 */           nameToUse = Servers.localServer.getName(); 
/* 19062 */         byte[] tempStringArr = nameToUse.getBytes("UTF-8");
/* 19063 */         bb.put((byte)-45);
/* 19064 */         bb.put((byte)tempStringArr.length);
/* 19065 */         bb.put(tempStringArr);
/* 19066 */         bb.put((byte)(Servers.localServer.isChallengeServer() ? 2 : (Servers.localServer.EPIC ? 1 : 0)));
/* 19067 */         this.connection.flush();
/*       */       }
/* 19069 */       catch (Exception ex) {
/*       */         
/* 19071 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendOpenInventoryWindow(long inventoryWindow, String title) {
/* 19078 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 19082 */         if (inventoryWindow == 5390755858690L) {
/*       */           
/*       */           try {
/*       */             
/* 19086 */             if (this.player.getPower() <= 0) {
/*       */               
/* 19088 */               Item container = Items.getItem(inventoryWindow);
/* 19089 */               if (container.getAuxData() != 23)
/*       */               {
/* 19091 */                 String d = "";
/* 19092 */                 if (this.player.getDeity() != null)
/* 19093 */                   d = this.player.getDeity().getName(); 
/* 19094 */                 Item key = ItemFactory.createItem(794, 99.0F, d);
/* 19095 */                 if (this.player.getDeity() != null)
/* 19096 */                   key.setAuxData((byte)this.player.getDeity().getNumber()); 
/* 19097 */                 key.setData1(577);
/* 19098 */                 container.insertItem(key, true);
/* 19099 */                 container.setAuxData((byte)23);
/*       */               }
/*       */             
/*       */             } 
/* 19103 */           } catch (Exception exception) {}
/*       */         }
/*       */ 
/*       */ 
/*       */         
/* 19108 */         ByteBuffer bb = this.connection.getBuffer();
/* 19109 */         byte[] tempStringArr = title.getBytes("UTF-8");
/* 19110 */         bb.put((byte)116);
/* 19111 */         bb.putLong(inventoryWindow);
/* 19112 */         bb.put((byte)tempStringArr.length);
/* 19113 */         bb.put(tempStringArr);
/* 19114 */         this.connection.flush();
/*       */       }
/* 19116 */       catch (Exception ex) {
/*       */         
/* 19118 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 19119 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendOpenWindowByTypeID(byte id) {
/* 19126 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 19130 */         ByteBuffer bb = this.connection.getBuffer();
/* 19131 */         bb.put((byte)-44);
/* 19132 */         bb.put(id);
/* 19133 */         this.connection.flush();
/*       */       }
/* 19135 */       catch (Exception ex) {
/*       */         
/* 19137 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 19138 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendOpenManageRecruitWindowWithData(String description) {
/* 19145 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 19149 */         ByteBuffer bb = this.connection.getBuffer();
/* 19150 */         bb.put((byte)-42);
/* 19151 */         bb.put((byte)0);
/* 19152 */         byte[] descriptionBytes = description.getBytes("UTF-8");
/* 19153 */         bb.putShort((short)descriptionBytes.length);
/* 19154 */         bb.put(descriptionBytes);
/* 19155 */         this.connection.flush();
/*       */       }
/* 19157 */       catch (Exception ex) {
/*       */         
/* 19159 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 19160 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendOpenInventoryContainer(long containerId) {
/* 19167 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */         
/* 19172 */         ByteBuffer bb = this.connection.getBuffer();
/* 19173 */         bb.put((byte)58);
/* 19174 */         bb.putLong(containerId);
/* 19175 */         this.connection.flush();
/*       */       }
/* 19177 */       catch (Exception ex) {
/*       */         
/* 19179 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public boolean sendCloseInventoryWindow(long inventoryWindow) {
/* 19190 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */ 
/*       */         
/* 19196 */         ByteBuffer bb = this.connection.getBuffer();
/* 19197 */         bb.put((byte)120);
/* 19198 */         bb.putLong(inventoryWindow);
/* 19199 */         this.connection.flush();
/*       */       }
/* 19201 */       catch (Exception ex) {
/*       */         
/* 19203 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 19204 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */     
/*       */     try {
/* 19209 */       return this.player.removeItemWatched(Items.getItem(inventoryWindow));
/*       */     }
/* 19211 */     catch (NoSuchItemException nsi) {
/*       */       
/* 19213 */       return true;
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public static int generateSoundSourceId(long playerId) {
/* 19219 */     return (int)(playerId & 0xFFFFFFFFFFFFFFFFL);
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendNewCreature(long id, String name, String model, float x, float y, float z, long onBridge, float rot, byte layer, boolean onGround, boolean floating, boolean isSolid, byte kingdomId, long face, byte blood, boolean isUndead, boolean isCopy, byte modtype) {
/* 19227 */     sendNewCreature(id, name, "", model, x, y, z, onBridge, rot, layer, onGround, floating, isSolid, kingdomId, face, blood, isUndead, isCopy, modtype);
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendNewCreature(long id, String name, String hoverText, String model, float x, float y, float z, long onBridge, float rot, byte layer, boolean onGround, boolean floating, boolean isHoverable, byte kingdomId, long face, byte blood, boolean isUndead, boolean isCopy, byte modtype) {
/* 19235 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 19239 */         byte[] tempStringArr = model.getBytes("UTF-8");
/*       */ 
/*       */         
/* 19242 */         ByteBuffer bb = this.connection.getBuffer();
/*       */         
/* 19244 */         bb.put((byte)108);
/* 19245 */         bb.putLong(id);
/*       */         
/* 19247 */         bb.put((byte)tempStringArr.length);
/* 19248 */         bb.put(tempStringArr);
/* 19249 */         bb.put((byte)(isHoverable ? 1 : 0));
/*       */         
/* 19251 */         bb.putFloat(y);
/* 19252 */         bb.putFloat(x);
/* 19253 */         bb.putLong(onBridge);
/* 19254 */         if (rot > 10000.0F) {
/*       */ 
/*       */           
/* 19257 */           rot %= 360.0F;
/*       */         }
/* 19259 */         else if (rot < 0.0F) {
/*       */           
/* 19261 */           rot = Math.abs(rot % 360.0F);
/*       */         } 
/* 19263 */         bb.putFloat(rot);
/* 19264 */         if (onGround) {
/*       */           
/* 19266 */           if (Structure.isGroundFloorAtPosition(x, y, (layer == 0)))
/*       */           {
/* 19268 */             bb.putFloat(z + 0.1F);
/*       */           }
/*       */           else
/*       */           {
/* 19272 */             bb.putFloat(-3000.0F);
/*       */           }
/*       */         
/*       */         } else {
/*       */           
/* 19277 */           bb.putFloat(z);
/*       */         } 
/*       */ 
/*       */         
/* 19281 */         tempStringArr = name.getBytes("UTF-8");
/* 19282 */         bb.put((byte)tempStringArr.length);
/* 19283 */         bb.put(tempStringArr);
/*       */ 
/*       */         
/* 19286 */         tempStringArr = hoverText.getBytes("UTF-8");
/* 19287 */         bb.put((byte)tempStringArr.length);
/* 19288 */         bb.put(tempStringArr);
/*       */ 
/*       */         
/* 19291 */         if (floating) {
/* 19292 */           bb.put((byte)1);
/*       */         } else {
/* 19294 */           bb.put((byte)0);
/*       */         } 
/*       */ 
/*       */         
/* 19298 */         bb.put(layer);
/* 19299 */         if ((WurmId.getType(id) == 0 || isCopy) && !isUndead) {
/*       */           
/* 19301 */           bb.put((byte)1);
/*       */         }
/*       */         else {
/*       */           
/* 19305 */           bb.put((byte)0);
/*       */         } 
/* 19307 */         bb.put((byte)0);
/* 19308 */         bb.put(kingdomId);
/* 19309 */         bb.putLong(face);
/* 19310 */         if ((WurmId.getType(id) == 0 || isCopy) && !isUndead)
/*       */         {
/*       */           
/* 19313 */           bb.putInt(Math.abs(generateSoundSourceId(id)));
/*       */         }
/* 19315 */         bb.put(blood);
/* 19316 */         bb.put(modtype);
/* 19317 */         bb.put((byte)0);
/* 19318 */         this.connection.flush();
/* 19319 */         if (this.player.getVehicle() == id) {
/* 19320 */           this.player.getMovementScheme().resumeSpeedModifier();
/*       */         }
/* 19322 */       } catch (NullPointerException np) {
/*       */         
/* 19324 */         logWarn(this.player.getName() + ':' + np.getMessage(), np);
/* 19325 */         this.player.setLink(false);
/*       */       }
/* 19327 */       catch (Exception ex) {
/*       */         
/* 19329 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendMoveCreature(long id, float x, float y, int rot, boolean keepMoving) {
/* 19384 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 19388 */         ByteBuffer bb = this.connection.getBuffer();
/* 19389 */         bb.put((byte)36);
/* 19390 */         bb.putLong(id);
/* 19391 */         bb.putFloat(y);
/* 19392 */         bb.putFloat(x);
/*       */         
/* 19394 */         bb.put((byte)rot);
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */         
/* 19400 */         this.connection.flush();
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/*       */       }
/* 19420 */       catch (NullPointerException np) {
/*       */         
/* 19422 */         logWarn(this.player.getName() + ':' + " creatureId: " + id + ' ' + np.getMessage(), np);
/* 19423 */         this.player.setLink(false);
/*       */       }
/* 19425 */       catch (Exception ex) {
/*       */         
/* 19427 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendMoveCreatureAndSetZ(long id, float x, float y, float z, int rot) {
/* 19434 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 19438 */         ByteBuffer bb = this.connection.getBuffer();
/* 19439 */         bb.put((byte)72);
/* 19440 */         bb.putLong(id);
/* 19441 */         bb.putFloat(z);
/*       */         
/* 19443 */         bb.putFloat(x);
/* 19444 */         bb.put((byte)rot);
/* 19445 */         bb.putFloat(y);
/* 19446 */         this.connection.flush();
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/*       */       }
/* 19465 */       catch (NullPointerException np) {
/*       */         
/* 19467 */         logWarn(this.player.getName() + ':' + " creatureId: " + id + ' ' + np.getMessage(), np);
/* 19468 */         this.player.setLink(false);
/*       */       }
/* 19470 */       catch (Exception ex) {
/*       */         
/* 19472 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendCreatureChangedLayer(long wurmid, byte newlayer) {
/* 19479 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */ 
/*       */         
/* 19485 */         ByteBuffer bb = this.connection.getBuffer();
/* 19486 */         bb.put((byte)30);
/* 19487 */         bb.putLong(wurmid);
/* 19488 */         bb.put(newlayer);
/* 19489 */         this.connection.flush();
/*       */       }
/* 19491 */       catch (Exception ex) {
/*       */         
/* 19493 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendDeleteCreature(long id) {
/* 19500 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */         
/* 19508 */         ByteBuffer bb = this.connection.getBuffer();
/* 19509 */         bb.put((byte)14);
/* 19510 */         bb.putLong(id);
/* 19511 */         this.connection.flush();
/*       */       }
/* 19513 */       catch (NullPointerException np) {
/*       */         
/* 19515 */         logWarn(this.player.getName() + ':' + " creatureId: " + id + ' ' + np.getMessage(), np);
/* 19516 */         this.player.setLink(false);
/*       */       }
/* 19518 */       catch (Exception ex) {
/*       */         
/* 19520 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendTileStripFar(short xStart, short yStart, int width, int height) {
/* 19527 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 19531 */         ByteBuffer bb = this.connection.getBuffer();
/* 19532 */         bb.put((byte)103);
/* 19533 */         bb.putShort(xStart);
/* 19534 */         bb.putShort(yStart);
/* 19535 */         bb.putShort((short)width);
/* 19536 */         bb.putShort((short)height); int x;
/* 19537 */         for (x = 0; x < width; x++) {
/*       */           
/* 19539 */           for (int y = 0; y < height; y++) {
/*       */             
/* 19541 */             int xx = (xStart + x) * 16;
/* 19542 */             int yy = (yStart + y) * 16;
/* 19543 */             if (xx < 0 || xx >= 1 << Constants.meshSize || yy < 0 || yy >= 1 << Constants.meshSize) {
/*       */               
/* 19545 */               xx = 0;
/* 19546 */               yy = 0;
/*       */             } 
/* 19548 */             bb.putShort(Tiles.decodeHeight(Server.surfaceMesh.data[xx | yy << Constants.meshSize]));
/*       */           } 
/*       */         } 
/* 19551 */         for (x = 0; x < width; x++) {
/*       */           
/* 19553 */           int ms = Constants.meshSize - 4;
/* 19554 */           for (int y = 0; y < height; y++) {
/*       */             
/* 19556 */             int xx = xStart + x;
/* 19557 */             int yy = yStart + y;
/* 19558 */             if (xx < 0 || xx >= 1 << ms || yy < 0 || yy >= 1 << ms) {
/*       */               
/* 19560 */               xx = 0;
/* 19561 */               yy = 0;
/*       */             } 
/* 19563 */             bb.put(Server.surfaceMesh.getDistantTerrainTypes()[xx | yy << ms]);
/*       */           } 
/*       */         } 
/*       */         
/* 19567 */         this.connection.flush();
/*       */       }
/* 19569 */       catch (Exception ex) {
/*       */         
/* 19571 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendTileDoor(short tilex, short tiley, boolean openHole) throws IOException {
/* 19578 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 19582 */         ByteBuffer bb = this.connection.getBuffer();
/* 19583 */         bb.put((byte)73);
/* 19584 */         bb.put(Features.Feature.SURFACEWATER.isEnabled() ? 1 : 0);
/* 19585 */         bb.put(this.player.isSendExtraBytes() ? 1 : 0);
/* 19586 */         bb.putShort(tiley);
/* 19587 */         bb.putShort((short)1);
/* 19588 */         bb.putShort((short)1);
/* 19589 */         bb.putShort(tilex);
/* 19590 */         if (openHole) {
/*       */ 
/*       */ 
/*       */           
/* 19594 */           bb.putInt(Tiles.encode(Tiles.decodeHeight(Server.surfaceMesh.data[tilex | tiley << Constants.meshSize]), Tiles.Tile.TILE_HOLE.id, (byte)0));
/*       */ 
/*       */         
/*       */         }
/*       */         else {
/*       */ 
/*       */           
/* 19601 */           bb.putInt(Server.surfaceMesh.data[tilex | tiley << Constants.meshSize]);
/*       */         } 
/* 19603 */         if (Features.Feature.SURFACEWATER.isEnabled())
/* 19604 */           bb.putShort((short)Water.getSurfaceWater(tilex, tiley)); 
/* 19605 */         if (this.player.isSendExtraBytes())
/* 19606 */           bb.put(Server.getClientSurfaceFlags(tilex, tiley)); 
/* 19607 */         this.connection.flush();
/*       */       }
/* 19609 */       catch (Exception ex) {
/*       */         
/* 19611 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 19612 */         this.player.setLink(false);
/* 19613 */         throw new IOException(this.player.getName() + ':' + ex.getMessage());
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendTileStrip(short xStart, short yStart, int width, int height) throws IOException {
/* 19620 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/* 19622 */       if (width < 1 || height < 1) {
/* 19623 */         logInfo(this.player.getName() + ':' + " Width=" + width + ", Height=" + height, new Exception("Bad CMD_TILESTRIP params."));
/*       */       }
/*       */       
/*       */       try {
/* 19627 */         ByteBuffer bb = this.connection.getBuffer();
/* 19628 */         bb.put((byte)73);
/* 19629 */         bb.put(Features.Feature.SURFACEWATER.isEnabled() ? 1 : 0);
/* 19630 */         bb.put(this.player.isSendExtraBytes() ? 1 : 0);
/* 19631 */         bb.putShort(yStart);
/* 19632 */         bb.putShort((short)width);
/* 19633 */         bb.putShort((short)height);
/* 19634 */         bb.putShort(xStart);
/*       */ 
/*       */ 
/*       */         
/* 19638 */         for (int x = 0; x < width; x++) {
/*       */           
/* 19640 */           for (int y = 0; y < height; y++) {
/*       */             
/* 19642 */             int tempTileX = xStart + x;
/* 19643 */             int tempTileY = yStart + y;
/* 19644 */             if (tempTileX < 0 || tempTileX >= 1 << Constants.meshSize || tempTileY < 0 || tempTileY >= 1 << Constants.meshSize) {
/*       */ 
/*       */               
/* 19647 */               tempTileX = 0;
/* 19648 */               tempTileY = 0;
/*       */             } 
/* 19650 */             bb.putInt(Server.surfaceMesh.data[tempTileX | tempTileY << Constants.meshSize]);
/* 19651 */             if (Features.Feature.SURFACEWATER.isEnabled())
/* 19652 */               bb.putShort((short)Water.getSurfaceWater(tempTileX, tempTileY)); 
/* 19653 */             if (this.player.isSendExtraBytes())
/* 19654 */               bb.put(Server.getClientSurfaceFlags(tempTileX, tempTileY)); 
/*       */           } 
/*       */         } 
/* 19657 */         this.connection.flush();
/*       */       }
/* 19659 */       catch (Exception ex) {
/*       */         
/* 19661 */         this.player.setLink(false);
/* 19662 */         throw new IOException(this.player.getName() + ':' + ex.getMessage());
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendCaveStrip(short xStart, short yStart, int width, int height) {
/* 19669 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */         
/* 19674 */         ByteBuffer bb = this.connection.getBuffer();
/* 19675 */         bb.put((byte)102);
/* 19676 */         bb.put(Features.Feature.CAVEWATER.isEnabled() ? 1 : 0);
/* 19677 */         bb.put(this.player.isSendExtraBytes() ? 1 : 0);
/* 19678 */         bb.putShort(xStart);
/* 19679 */         bb.putShort(yStart);
/* 19680 */         bb.putShort((short)width);
/* 19681 */         bb.putShort((short)height);
/* 19682 */         boolean onSurface = this.player.isOnSurface();
/*       */ 
/*       */ 
/*       */         
/* 19686 */         for (int x = 0; x < width; x++) {
/*       */           
/* 19688 */           for (int y = 0; y < height; y++) {
/*       */             
/* 19690 */             int xx = xStart + x;
/* 19691 */             int yy = yStart + y;
/*       */             
/* 19693 */             if (xx < 0 || xx >= Zones.worldTileSizeX || yy < 0 || yy >= Zones.worldTileSizeY) {
/*       */               
/* 19695 */               bb.putInt(emptyRock);
/* 19696 */               xx = 0;
/* 19697 */               yy = 0;
/*       */             }
/* 19699 */             else if (!onSurface) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */               
/* 19705 */               bb.putInt(Server.caveMesh.data[xx | yy << Constants.meshSize]);
/*       */ 
/*       */ 
/*       */             
/*       */             }
/* 19710 */             else if (Tiles.isSolidCave(Tiles.decodeType(Server.caveMesh.data[xx | yy << Constants.meshSize]))) {
/*       */               
/* 19712 */               bb.putInt(getDummyWall(xx, yy));
/*       */             }
/*       */             else {
/*       */               
/* 19716 */               bb.putInt(Server.caveMesh.data[xx | yy << Constants.meshSize]);
/*       */             } 
/* 19718 */             if (Features.Feature.CAVEWATER.isEnabled())
/* 19719 */               bb.putShort((short)Water.getCaveWater(xx, yy)); 
/* 19720 */             if (this.player.isSendExtraBytes())
/* 19721 */               bb.put(Server.getClientCaveFlags(xx, yy)); 
/*       */           } 
/*       */         } 
/* 19724 */         this.connection.flush();
/*       */       }
/* 19726 */       catch (Exception ex) {
/*       */         
/* 19728 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private int getDummyWall(int tilex, int tiley) {
/* 19735 */     return Tiles.encode(
/* 19736 */         Tiles.decodeHeight(Server.caveMesh.data[tilex | tiley << Constants.meshSize]), Tiles.Tile.TILE_CAVE_WALL.id, 
/*       */         
/* 19738 */         Tiles.decodeData(Server.caveMesh.data[tilex | tiley << Constants.meshSize]));
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private boolean isCaveWallHidden(int tilex, int tiley) {
/* 19744 */     if (!isCaveWallSolid(tilex, tiley))
/* 19745 */       return false; 
/* 19746 */     if (!isCaveWallSolid(tilex, tiley - 1))
/* 19747 */       return false; 
/* 19748 */     if (!isCaveWallSolid(tilex + 1, tiley))
/* 19749 */       return false; 
/* 19750 */     if (!isCaveWallSolid(tilex, tiley + 1))
/* 19751 */       return false; 
/* 19752 */     if (!isCaveWallSolid(tilex - 1, tiley))
/* 19753 */       return false; 
/* 19754 */     return true;
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private boolean isCaveWallSolid(int tilex, int tiley) {
/* 19760 */     if (tilex < 0 || tilex >= Zones.worldTileSizeX || tiley < 0 || tiley >= Zones.worldTileSizeY)
/* 19761 */       return true; 
/* 19762 */     if (Tiles.isSolidCave(Tiles.decodeType(Server.caveMesh.data[tilex | tiley << Constants.meshSize])))
/* 19763 */       return true; 
/* 19764 */     return false;
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendUpdateSelectBar(long toUpdate, boolean keepSelection) {
/* 19769 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 19773 */         ByteBuffer buffer = this.connection.getBuffer();
/* 19774 */         buffer.put((byte)-23);
/* 19775 */         if (!keepSelection) {
/* 19776 */           buffer.put((byte)1);
/*       */         } else {
/* 19778 */           buffer.put((byte)2);
/* 19779 */         }  buffer.putLong(toUpdate);
/*       */         
/* 19781 */         this.connection.flush();
/*       */       }
/* 19783 */       catch (Exception ex) {
/*       */         
/* 19785 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAvailableSelectBarActions(byte requestId, List<ActionEntry> availableActions) {
/* 19792 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 19796 */         ByteBuffer bb = this.connection.getBuffer();
/* 19797 */         bb.put((byte)-23);
/* 19798 */         bb.put((byte)0);
/* 19799 */         bb.put(requestId);
/* 19800 */         bb.put((byte)availableActions.size());
/* 19801 */         for (Iterator<ActionEntry> it = availableActions.iterator(); it.hasNext(); ) {
/*       */           
/* 19803 */           ActionEntry entry = it.next();
/* 19804 */           bb.putShort(entry.getNumber());
/*       */           
/* 19806 */           if (entry.isQuickSkillLess()) {
/* 19807 */             bb.put((byte)1); continue;
/*       */           } 
/* 19809 */           bb.put((byte)0);
/*       */         } 
/*       */         
/* 19812 */         this.connection.flush();
/*       */       }
/* 19814 */       catch (Exception ex) {
/*       */         
/* 19816 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 19817 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAvailableActions(byte requestId, List<ActionEntry> availableActions, String helpstring) {
/* 19824 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 19828 */         ByteBuffer bb = this.connection.getBuffer();
/* 19829 */         bb.put((byte)20);
/* 19830 */         bb.put(requestId);
/* 19831 */         bb.put((byte)availableActions.size());
/* 19832 */         for (Iterator<ActionEntry> it = availableActions.iterator(); it.hasNext(); ) {
/*       */           
/* 19834 */           ActionEntry entry = it.next();
/* 19835 */           bb.putShort(entry.getNumber());
/* 19836 */           String actionString = entry.getActionString();
/*       */           
/* 19838 */           byte[] arrayOfByte = actionString.getBytes("UTF-8");
/* 19839 */           bb.put((byte)arrayOfByte.length);
/* 19840 */           bb.put(arrayOfByte);
/* 19841 */           if (entry.isQuickSkillLess()) {
/* 19842 */             bb.put((byte)1); continue;
/*       */           } 
/* 19844 */           bb.put((byte)0);
/*       */         } 
/*       */         
/* 19847 */         byte[] tempStringArr = helpstring.getBytes("UTF-8");
/* 19848 */         bb.put((byte)tempStringArr.length);
/* 19849 */         bb.put(tempStringArr);
/* 19850 */         this.connection.flush();
/*       */       }
/* 19852 */       catch (Exception ex) {
/*       */         
/* 19854 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 19855 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendItem(Item item, long creatureId, boolean onGroundLevel) {
/* 19868 */     if (this.player != null && this.player.hasLink())
/*       */     {
/* 19870 */       if (item.getTemplateId() != 520) {
/*       */         
/*       */         try {
/* 19873 */           long id = item.getWurmId();
/* 19874 */           boolean insidePlaceableContainer = item.isInsidePlaceableContainer();
/* 19875 */           ByteBuffer bb = this.connection.getBuffer();
/* 19876 */           if (creatureId <= 0L) {
/* 19877 */             bb.put((byte)-9);
/*       */           } else {
/*       */             
/* 19880 */             bb.put((byte)75);
/* 19881 */             bb.putLong(creatureId);
/*       */           } 
/* 19883 */           bb.putLong(id);
/* 19884 */           if (insidePlaceableContainer) {
/*       */             
/* 19886 */             bb.putFloat(item.getPosXRaw());
/* 19887 */             bb.putFloat(item.getPosYRaw());
/*       */           }
/*       */           else {
/*       */             
/* 19891 */             bb.putFloat(item.getPosX());
/* 19892 */             bb.putFloat(item.getPosY());
/*       */           } 
/*       */           
/* 19895 */           bb.putFloat(item.getRotation());
/* 19896 */           if (insidePlaceableContainer) {
/* 19897 */             bb.putFloat(item.getPosZRaw());
/* 19898 */           } else if (item.isFloating() && item.getPosZ() <= 0.0F) {
/*       */             
/* 19900 */             if (item.getCurrentQualityLevel() < 10.0F) {
/* 19901 */               bb.putFloat(-3000.0F);
/*       */             } else {
/* 19903 */               bb.putFloat(0.0F);
/*       */             } 
/* 19905 */           } else if (item.isArtifact()) {
/* 19906 */             bb.putFloat(item.getPosZ() + 0.05F);
/* 19907 */           } else if (item.getTemplate().hovers() && item.getPosZ() > 0.0F) {
/* 19908 */             bb.putFloat(item.getPosZ());
/* 19909 */           } else if (item.getFloorLevel() > 0 || !onGroundLevel || item.onBridge() != -10L) {
/* 19910 */             bb.putFloat(item.getPosZ());
/*       */           } else {
/* 19912 */             bb.putFloat(-3000.0F);
/*       */           } 
/*       */           
/* 19915 */           byte[] tempStringArr = item.getName().getBytes("UTF-8");
/* 19916 */           bb.put((byte)tempStringArr.length);
/* 19917 */           bb.put(tempStringArr);
/*       */ 
/*       */           
/* 19920 */           tempStringArr = item.getHoverText().getBytes("UTF-8");
/* 19921 */           bb.put((byte)tempStringArr.length);
/* 19922 */           bb.put(tempStringArr);
/*       */ 
/*       */           
/* 19925 */           tempStringArr = item.getModelName().getBytes("UTF-8");
/* 19926 */           bb.put((byte)tempStringArr.length);
/* 19927 */           bb.put(tempStringArr);
/*       */           
/* 19929 */           bb.put((byte)(item.isOnSurface() ? 0 : -1));
/*       */           
/* 19931 */           bb.put(item.getMaterial());
/*       */ 
/*       */ 
/*       */           
/* 19935 */           if (item.descIsName()) {
/* 19936 */             tempStringArr = "".getBytes("UTF-8");
/*       */           } else {
/* 19938 */             tempStringArr = item.getDescription().getBytes("UTF-8");
/* 19939 */           }  bb.put((byte)tempStringArr.length);
/* 19940 */           bb.put(tempStringArr);
/* 19941 */           bb.putShort(item.getImageNumber());
/* 19942 */           if (item.getTemplateId() == 177) {
/* 19943 */             bb.put((byte)0);
/*       */           } else {
/*       */             
/* 19946 */             bb.put((byte)1);
/* 19947 */             bb.putFloat(item.getQualityLevel());
/* 19948 */             bb.putFloat(item.getDamage());
/*       */           } 
/* 19950 */           bb.putFloat(item.getSizeMod());
/* 19951 */           bb.putLong(item.onBridge());
/* 19952 */           bb.put(item.getRarity());
/* 19953 */           bb.put(insidePlaceableContainer ? 2 : ((item
/* 19954 */               .getTemplate().hasViewableSubItems() && item.getTemplateId() != 1437) ? 1 : 0));
/* 19955 */           if (insidePlaceableContainer) {
/* 19956 */             bb.putLong(item.getParentId());
/*       */           }
/* 19958 */           if (item.hasExtraData()) {
/*       */ 
/*       */             
/* 19961 */             bb.put((byte)1);
/* 19962 */             bb.putInt(item.getExtra1());
/* 19963 */             bb.putInt(item.getExtra2());
/*       */           } else {
/*       */             
/* 19966 */             bb.put((byte)0);
/*       */           } 
/* 19968 */           this.connection.flush();
/* 19969 */           if (Features.Feature.HIGHWAYS.isEnabled() && item.getTemplateId() == 1112)
/*       */           {
/* 19971 */             sendWaystoneData(item);
/*       */           }
/*       */         }
/* 19974 */         catch (Exception ex) {
/*       */           
/* 19976 */           logWarn("Failed to send item: " + this.player.getName() + ':' + item.getWurmId() + ", " + ex
/* 19977 */               .getMessage(), ex);
/* 19978 */           this.player.setLink(false);
/*       */         } 
/*       */       }
/*       */     }
/*       */   }
/*       */   
/*       */   public void sendChangeModelName(Item item) {
/* 19985 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/* 19987 */       if (Features.Feature.HIGHWAYS.isEnabled() && item.getTemplateId() == 1112) {
/*       */ 
/*       */         
/* 19990 */         sendWaystoneData(item);
/*       */         
/*       */         return;
/*       */       } 
/*       */       try {
/* 19995 */         long id = item.getWurmId();
/* 19996 */         byte[] temp = item.getModelName().getBytes("UTF-8");
/* 19997 */         ByteBuffer bb = this.connection.getBuffer();
/* 19998 */         bb.put((byte)-48);
/* 19999 */         bb.putLong(id);
/* 20000 */         bb.put((byte)temp.length);
/* 20001 */         bb.put(temp);
/* 20002 */         this.connection.flush();
/*       */       }
/* 20004 */       catch (Exception ex) {
/*       */         
/* 20006 */         logWarn("Failed to change model for item: " + this.player.getName() + ':' + item.getWurmId() + ", " + ex
/* 20007 */             .getMessage(), ex);
/* 20008 */         this.player.setLink(false);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendWaystoneData(Item waystone) {
/* 20015 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */         
/* 20020 */         Node node = Routes.getNode(waystone.getWurmId());
/* 20021 */         if (node != null)
/*       */         {
/* 20023 */           byte dirs = waystone.getAuxData();
/* 20024 */           byte count = (byte)MethodsHighways.numberOfSetBits(dirs);
/* 20025 */           ByteBuffer bb = this.connection.getBuffer();
/* 20026 */           bb.put((byte)-56);
/* 20027 */           bb.putLong(waystone.getWurmId());
/* 20028 */           bb.put(count);
/* 20029 */           sendWaystoneDirInfo(bb, node, dirs, (byte)1);
/* 20030 */           sendWaystoneDirInfo(bb, node, dirs, (byte)2);
/* 20031 */           sendWaystoneDirInfo(bb, node, dirs, (byte)4);
/* 20032 */           sendWaystoneDirInfo(bb, node, dirs, (byte)8);
/* 20033 */           sendWaystoneDirInfo(bb, node, dirs, (byte)16);
/* 20034 */           sendWaystoneDirInfo(bb, node, dirs, (byte)32);
/* 20035 */           sendWaystoneDirInfo(bb, node, dirs, (byte)64);
/* 20036 */           sendWaystoneDirInfo(bb, node, dirs, -128);
/* 20037 */           this.connection.flush();
/*       */         }
/*       */       
/* 20040 */       } catch (Exception ex) {
/*       */         
/* 20042 */         logWarn("Failed to send waystone data: " + this.player.getName() + ':' + waystone.getWurmId() + ", " + ex
/* 20043 */             .getMessage(), ex);
/* 20044 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private void sendWaystoneDirInfo(ByteBuffer bb, Node node, byte dirs, byte dir) throws Exception {
/* 20051 */     if (MethodsHighways.hasLink(dirs, dir)) {
/*       */ 
/*       */       
/* 20054 */       byte cd = MethodsHighways.convertLink(dir);
/*       */       
/* 20056 */       byte colour = 0;
/* 20057 */       short pathDistance = -1;
/* 20058 */       Route route = node.getRoute(dir);
/* 20059 */       if (route == null) {
/*       */ 
/*       */         
/* 20062 */         colour = 1;
/*       */       }
/*       */       else {
/*       */         
/* 20066 */         pathDistance = route.isOnHighwayPath(this.player);
/* 20067 */         colour = 3;
/*       */         
/* 20069 */         if (pathDistance > -1)
/* 20070 */           colour = (byte)(colour | 0x10); 
/*       */       } 
/* 20072 */       String village = "";
/* 20073 */       short distance = 0;
/* 20074 */       if (pathDistance > -1) {
/*       */         
/* 20076 */         village = this.player.getHighwayPathDestination();
/* 20077 */         distance = pathDistance;
/*       */       }
/*       */       else {
/*       */         
/* 20081 */         ClosestVillage closestVillage = node.getClosestVillage(dir);
/* 20082 */         if (closestVillage != null) {
/*       */           
/* 20084 */           village = closestVillage.getName();
/* 20085 */           distance = closestVillage.getDistance();
/*       */         } 
/*       */       } 
/*       */       
/* 20089 */       bb.put(cd);
/* 20090 */       bb.put(colour);
/* 20091 */       sendByteStringLength(village, bb);
/* 20092 */       bb.putShort(distance);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public boolean sendShowLinks(boolean markerType, HighwayPos currentHighwayPos, byte[] glows) {
/* 20101 */     if (this.player != null && this.player.hasLink() && Features.Feature.HIGHWAYS.isEnabled()) {
/*       */       
/* 20103 */       HighwayPos westHighwayPos = MethodsHighways.getNewHighwayPosLinked(currentHighwayPos, (byte)64);
/* 20104 */       HighwayPos northwestHighwayPos = MethodsHighways.getNewHighwayPosLinked(currentHighwayPos, -128);
/* 20105 */       HighwayPos northHighwayPos = MethodsHighways.getNewHighwayPosLinked(currentHighwayPos, (byte)1);
/* 20106 */       if (westHighwayPos == null || northwestHighwayPos == null || northHighwayPos == null) {
/* 20107 */         return false;
/*       */       }
/*       */       try {
/* 20110 */         ByteBuffer bb = this.connection.getBuffer();
/* 20111 */         bb.put((byte)-57);
/* 20112 */         bb.put((byte)0);
/*       */ 
/*       */         
/* 20115 */         bb.put((byte)4);
/* 20116 */         showHighwayPos(bb, currentHighwayPos);
/* 20117 */         showHighwayPos(bb, westHighwayPos);
/* 20118 */         showHighwayPos(bb, northwestHighwayPos);
/* 20119 */         showHighwayPos(bb, northHighwayPos);
/*       */         
/* 20121 */         for (int x = 0; x < glows.length; x++)
/*       */         {
/* 20123 */           bb.put(glows[x]);
/*       */         }
/* 20125 */         this.connection.flush();
/* 20126 */         return true;
/*       */       }
/* 20128 */       catch (Exception ex) {
/*       */         
/* 20130 */         logWarn("Failed to send the link information: " + this.player.getName() + ", " + ex
/* 20131 */             .getMessage(), ex);
/* 20132 */         this.player.setLink(false);
/*       */       } 
/*       */     } 
/* 20135 */     return false;
/*       */   }
/*       */ 
/*       */   
/*       */   public boolean sendShowProtection(boolean markerType, HighwayPos currentHighwayPos, HighwayPos[] protectedHPs) {
/* 20140 */     if (this.player != null && this.player.hasLink() && Features.Feature.HIGHWAYS.isEnabled()) {
/*       */       
/*       */       try {
/*       */         
/* 20144 */         ByteBuffer bb = this.connection.getBuffer();
/* 20145 */         bb.put((byte)-57);
/* 20146 */         bb.put((byte)2);
/*       */ 
/*       */         
/* 20149 */         bb.put((byte)(protectedHPs.length + 1));
/* 20150 */         showHighwayPos(bb, currentHighwayPos);
/* 20151 */         for (int x = 0; x < protectedHPs.length; x++)
/*       */         {
/* 20153 */           showHighwayPos(bb, protectedHPs[x]);
/*       */         }
/* 20155 */         this.connection.flush();
/* 20156 */         return true;
/*       */       }
/* 20158 */       catch (Exception ex) {
/*       */         
/* 20160 */         logWarn("Failed to send the protection information: " + this.player.getName() + ", " + ex
/* 20161 */             .getMessage(), ex);
/* 20162 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/* 20165 */     return false;
/*       */   }
/*       */ 
/*       */   
/*       */   private void showHighwayPos(ByteBuffer bb, HighwayPos highwayPos) {
/* 20170 */     bb.putShort((short)highwayPos.getTilex());
/* 20171 */     bb.putShort((short)highwayPos.getTiley());
/* 20172 */     bb.put((byte)(highwayPos.isOnSurface() ? 1 : 0));
/* 20173 */     bb.putLong(highwayPos.getBridgeId());
/* 20174 */     bb.put((byte)highwayPos.getFloorLevel());
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendHideLinks() {
/* 20179 */     if (this.player != null && this.player.hasLink() && Features.Feature.HIGHWAYS.isEnabled()) {
/*       */       
/*       */       try {
/*       */         
/* 20183 */         ByteBuffer bb = this.connection.getBuffer();
/* 20184 */         bb.put((byte)-57);
/* 20185 */         bb.put((byte)1);
/* 20186 */         this.connection.flush();
/*       */       }
/* 20188 */       catch (Exception ex) {
/*       */         
/* 20190 */         logWarn("Failed to hide the link and protection: " + this.player.getName() + ", " + ex
/* 20191 */             .getMessage(), ex);
/* 20192 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRename(Item item, String newName, String newModelName) {
/* 20199 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20203 */         long id = item.getWurmId();
/*       */         
/* 20205 */         byte[] tempStringArr = newName.getBytes("UTF-8");
/* 20206 */         ByteBuffer bb = this.connection.getBuffer();
/* 20207 */         bb.put((byte)44);
/* 20208 */         bb.putLong(id);
/* 20209 */         bb.put((byte)tempStringArr.length);
/* 20210 */         bb.put(tempStringArr);
/* 20211 */         tempStringArr = newModelName.getBytes("UTF-8");
/* 20212 */         bb.put((byte)tempStringArr.length);
/* 20213 */         bb.put(tempStringArr);
/* 20214 */         bb.put(item.getMaterial());
/* 20215 */         if (item.descIsName()) {
/* 20216 */           tempStringArr = "".getBytes("UTF-8");
/*       */         } else {
/* 20218 */           tempStringArr = item.getDescription().getBytes("UTF-8");
/* 20219 */         }  bb.put((byte)tempStringArr.length);
/* 20220 */         bb.put(tempStringArr);
/* 20221 */         bb.putShort(item.getImageNumber());
/* 20222 */         bb.put(item.getRarity());
/* 20223 */         this.connection.flush();
/*       */       }
/* 20225 */       catch (Exception ex) {
/*       */         
/* 20227 */         logWarn("Failed to rename item: " + this.player.getName() + ':' + item.getWurmId() + ", " + ex
/* 20228 */             .getMessage(), ex);
/* 20229 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveItem(Item item) {
/* 20236 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */         
/* 20241 */         ByteBuffer bb = this.connection.getBuffer();
/* 20242 */         bb.put((byte)10);
/* 20243 */         bb.putLong(item.getWurmId());
/* 20244 */         this.connection.flush();
/*       */       }
/* 20246 */       catch (Exception ex) {
/*       */         
/* 20248 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 20249 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendAddSkill(int id, int parentSkillId, String name, float value, float maxValue, int affinities) {
/* 20257 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20261 */         byte[] tempStringArr = name.getBytes("UTF-8");
/* 20262 */         ByteBuffer bb = this.connection.getBuffer();
/* 20263 */         bb.put((byte)124);
/*       */         
/* 20265 */         bb.putLong(BigInteger.valueOf(parentSkillId).shiftLeft(32).longValue() + 18L);
/* 20266 */         bb.putLong(BigInteger.valueOf(id).shiftLeft(32).longValue() + 18L);
/*       */         
/* 20268 */         bb.put((byte)tempStringArr.length);
/* 20269 */         bb.put(tempStringArr);
/* 20270 */         bb.putFloat(value);
/* 20271 */         bb.putFloat(maxValue);
/* 20272 */         if (this.player.getPaymentExpire() > 0L) {
/* 20273 */           bb.put((byte)affinities);
/*       */         } else {
/* 20275 */           bb.put((byte)0);
/* 20276 */         }  this.connection.flush();
/*       */       }
/* 20278 */       catch (Exception ex) {
/*       */         
/* 20280 */         logInfo(this.player.getName() + ':' + " skillId: " + id + ' ' + ex.getMessage(), ex);
/* 20281 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendUpdateSkill(int id, float value, int affinities) {
/* 20288 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20292 */         ByteBuffer bb = this.connection.getBuffer();
/* 20293 */         bb.put((byte)66);
/* 20294 */         bb.putLong((id << 32L) + 18L);
/* 20295 */         bb.putFloat(value);
/*       */         
/* 20297 */         if (this.player.getPaymentExpire() > 0L) {
/* 20298 */           bb.put((byte)affinities);
/*       */         } else {
/* 20300 */           bb.put((byte)0);
/* 20301 */         }  this.connection.flush();
/*       */       }
/* 20303 */       catch (Exception ex) {
/*       */         
/* 20305 */         logInfo(this.player.getName() + ':' + " skillId: " + id + ' ' + ex.getMessage(), ex);
/* 20306 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendActionControl(long creatureId, String actionString, boolean start, int timeLeft) {
/* 20313 */     if (this.player != null && this.player.hasLink()) {
/*       */       try {
/*       */         byte[] tempStringArr;
/*       */ 
/*       */         
/* 20318 */         if (start) {
/* 20319 */           tempStringArr = actionString.getBytes("UTF-8");
/*       */         } else {
/* 20321 */           tempStringArr = "".getBytes("UTF-8");
/* 20322 */         }  ByteBuffer bb = this.connection.getBuffer();
/* 20323 */         bb.put((byte)-12);
/*       */         
/* 20325 */         bb.put((byte)tempStringArr.length);
/* 20326 */         bb.put(tempStringArr);
/*       */         
/* 20328 */         bb.putShort((short)Math.min(timeLeft, 65535));
/* 20329 */         bb.putLong(creatureId);
/* 20330 */         this.connection.flush();
/*       */       }
/* 20332 */       catch (Exception ex) {
/*       */         
/* 20334 */         logInfo(this.player.getName() + ':' + " creatureId: " + creatureId + ' ' + ex.getMessage(), ex);
/*       */         
/* 20336 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddEffect(long id, short type, float x, float y, float z, byte layer) {
/* 20343 */     sendAddEffect(id, -10L, type, x, y, z, layer, null, -1.0F, 0.0F);
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendAddEffect(long id, short type, float x, float y, float z, byte layer, String effectString, float timeout, float rotationOffset) {
/* 20349 */     sendAddEffect(id, -10L, type, x, y, z, layer, effectString, timeout, rotationOffset);
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendAddEffect(long id, long target, short type, float x, float y, float z, byte layer, String effectString, float timeout, float rotationOffset) {
/* 20355 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20359 */         ByteBuffer bb = this.connection.getBuffer();
/* 20360 */         bb.put((byte)64);
/* 20361 */         bb.putLong(id);
/* 20362 */         bb.putShort(type);
/* 20363 */         bb.putFloat(x);
/* 20364 */         bb.putFloat(y);
/* 20365 */         bb.putFloat(z);
/* 20366 */         bb.put(layer);
/* 20367 */         if (type == 27 && effectString != null) {
/*       */           
/* 20369 */           byte[] tempStringArr = effectString.getBytes("UTF-8");
/* 20370 */           bb.put((byte)tempStringArr.length);
/* 20371 */           bb.put(tempStringArr);
/* 20372 */           bb.putFloat(timeout);
/* 20373 */           bb.putFloat(rotationOffset);
/*       */         } 
/* 20375 */         this.connection.flush();
/*       */       }
/* 20377 */       catch (Exception ex) {
/*       */         
/* 20379 */         logInfo(this.player.getName() + ':' + " effectId: " + id + " targetId: " + target + ' ' + ex
/* 20380 */             .getMessage(), ex);
/* 20381 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendAddComplexEffect(long id, long target, short type, float x, float y, float z, byte layer, float radiusMeters, float lengthMeters, int direction, byte kingdomTemplateId, byte epicEntityId) {
/* 20390 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20394 */         ByteBuffer bb = this.connection.getBuffer();
/* 20395 */         bb.put((byte)95);
/* 20396 */         bb.putLong(id);
/* 20397 */         bb.putLong(target);
/* 20398 */         bb.putShort(type);
/* 20399 */         bb.putFloat(x);
/* 20400 */         bb.putFloat(y);
/* 20401 */         bb.putFloat(z);
/* 20402 */         bb.put(layer);
/* 20403 */         bb.putFloat(radiusMeters);
/* 20404 */         bb.putFloat(lengthMeters);
/* 20405 */         bb.putInt(direction);
/* 20406 */         bb.put(kingdomTemplateId);
/* 20407 */         bb.put(epicEntityId);
/* 20408 */         this.connection.flush();
/*       */       }
/* 20410 */       catch (Exception ex) {
/*       */         
/* 20412 */         logInfo(this.player.getName() + ':' + " effectId: " + id + " targetId: " + target + ' ' + ex
/* 20413 */             .getMessage(), ex);
/* 20414 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveEffect(long id) {
/* 20421 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20425 */         ByteBuffer bb = this.connection.getBuffer();
/* 20426 */         bb.put((byte)37);
/* 20427 */         bb.putLong(id);
/* 20428 */         this.connection.flush();
/*       */       }
/* 20430 */       catch (Exception ex) {
/*       */         
/* 20432 */         logInfo(this.player.getName() + ':' + " effectId: " + id + ' ' + ex.getMessage(), ex);
/* 20433 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   protected void sendStamina(int stamina, int damage) {
/* 20440 */     if (this.player != null && this.player.hasLink() && !this.player.isTransferring()) {
/*       */       
/*       */       try {
/*       */         
/* 20444 */         ByteBuffer bb = this.connection.getBuffer();
/* 20445 */         bb.put((byte)90);
/* 20446 */         stamina = (int)((stamina & 0xFFFE) | this.newSeed >> this.newSeedPointer++ & 0x1L);
/*       */         
/* 20448 */         bb.putShort((short)stamina);
/* 20449 */         bb.putShort((short)damage);
/* 20450 */         this.connection.flush();
/* 20451 */         if (this.newSeedPointer == 32)
/*       */         {
/* 20453 */           this.connection.encryptRandom.setSeed(this.newSeed & 0xFFFFFFFFFFFFFFFFL);
/* 20454 */           this.connection.changeProtocol(this.newSeed);
/* 20455 */           this.newSeedPointer = 0;
/* 20456 */           this.newSeed = (Server.rand.nextInt() & Integer.MAX_VALUE);
/*       */         }
/*       */       
/* 20459 */       } catch (Exception ex) {
/*       */         
/* 20461 */         logInfo(this.player.getName() + ':' + " stamina: " + stamina + ' ' + ex.getMessage(), ex);
/* 20462 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   protected void sendThirst(int thirst) {
/* 20469 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20473 */         ByteBuffer bb = this.connection.getBuffer();
/* 20474 */         bb.put((byte)105);
/* 20475 */         bb.putShort((short)thirst);
/* 20476 */         this.connection.flush();
/*       */       }
/* 20478 */       catch (Exception ex) {
/*       */         
/* 20480 */         logInfo(this.player.getName() + ':' + " thirst: " + thirst + ' ' + ex.getMessage(), ex);
/* 20481 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendHunger(int hunger, float nutrition, float calories, float carbs, float fats, float proteins) {
/* 20488 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20492 */         ByteBuffer bb = this.connection.getBuffer();
/* 20493 */         bb.put((byte)61);
/*       */         
/* 20495 */         bb.putShort((short)hunger);
/* 20496 */         bb.put((byte)(int)(nutrition * 100.0F));
/* 20497 */         if (!this.player.hasFlag(52)) {
/*       */           
/* 20499 */           bb.put((byte)(int)calories);
/* 20500 */           bb.put((byte)(int)carbs);
/* 20501 */           bb.put((byte)(int)fats);
/* 20502 */           bb.put((byte)(int)proteins);
/*       */         } 
/* 20504 */         this.connection.flush();
/*       */       }
/* 20506 */       catch (Exception ex) {
/*       */         
/* 20508 */         logInfo(this.player.getName() + ':' + " hunger: " + hunger + ' ' + ex.getMessage(), ex);
/* 20509 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   protected void sendWeight(byte weight) {
/* 20521 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20525 */         ByteBuffer bb = this.connection.getBuffer();
/* 20526 */         bb.put((byte)5);
/* 20527 */         bb.put(weight);
/* 20528 */         this.connection.flush();
/*       */       }
/* 20530 */       catch (Exception ex) {
/*       */         
/* 20532 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 20533 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   protected void sendSpeedModifier(float speedModifier) {
/* 20540 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20544 */         this.numberSpeedModsSent++;
/* 20545 */         ByteBuffer bb = this.connection.getBuffer();
/* 20546 */         bb.put((byte)32);
/* 20547 */         bb.putFloat(speedModifier);
/* 20548 */         this.connection.flush();
/*       */       }
/* 20550 */       catch (Exception ex) {
/*       */         
/* 20552 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   protected void sendTimeLeft(short tenthOfSeconds) {
/* 20564 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20568 */         ByteBuffer bb = this.connection.getBuffer();
/* 20569 */         bb.put((byte)87);
/* 20570 */         bb.putShort(tenthOfSeconds);
/* 20571 */         this.connection.flush();
/*       */       }
/* 20573 */       catch (Exception ex) {
/*       */         
/* 20575 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendSingleBuildMarker(long structureId, int tilex, int tiley, byte layer) {
/* 20582 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20586 */         ByteBuffer bb = this.connection.getBuffer();
/* 20587 */         bb.put((byte)96);
/* 20588 */         bb.putLong(structureId);
/* 20589 */         bb.put(layer);
/* 20590 */         bb.put((byte)1);
/* 20591 */         bb.putShort((short)tilex);
/* 20592 */         bb.putShort((short)tiley);
/* 20593 */         this.connection.flush();
/*       */       }
/* 20595 */       catch (Exception ex) {
/*       */         
/* 20597 */         logInfo(this.player.getName() + ':' + " structureId: " + structureId + ' ' + ex.getMessage(), ex);
/* 20598 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendMultipleBuildMarkers(long structureId, VolaTile[] tiles, byte layer) {
/* 20605 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20609 */         ByteBuffer bb = this.connection.getBuffer();
/* 20610 */         bb.put((byte)96);
/* 20611 */         bb.putLong(structureId);
/*       */         
/* 20613 */         bb.put(layer);
/* 20614 */         bb.put((byte)tiles.length);
/* 20615 */         for (int x = 0; x < tiles.length; x++) {
/*       */           
/* 20617 */           bb.putShort((short)tiles[x].getTileX());
/* 20618 */           bb.putShort((short)tiles[x].getTileY());
/*       */         } 
/* 20620 */         this.connection.flush();
/*       */       }
/* 20622 */       catch (Exception ex) {
/*       */         
/* 20624 */         logInfo(this.player.getName() + ':' + " structureId: " + structureId + ' ' + ex.getMessage(), ex);
/* 20625 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendAddStructure(String name, short centerTilex, short centerTiley, long structureId, byte structureType, byte layer) {
/* 20633 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20637 */         ByteBuffer bb = this.connection.getBuffer();
/* 20638 */         bb.put((byte)112);
/* 20639 */         bb.putLong(structureId);
/* 20640 */         bb.put(structureType);
/* 20641 */         byte[] tempStringArr = name.getBytes("UTF-8");
/* 20642 */         bb.put((byte)tempStringArr.length);
/* 20643 */         bb.put(tempStringArr);
/* 20644 */         bb.putShort(centerTiley);
/* 20645 */         bb.putShort(centerTilex);
/* 20646 */         bb.put(layer);
/* 20647 */         this.connection.flush();
/*       */       }
/* 20649 */       catch (Exception ex) {
/*       */         
/* 20651 */         logInfo(this.player.getName() + ':' + " structureId: " + structureId + ' ' + ex.getMessage(), ex);
/* 20652 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveStructure(long structureId) {
/* 20659 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20663 */         ByteBuffer bb = this.connection.getBuffer();
/* 20664 */         bb.put((byte)48);
/* 20665 */         bb.putLong(structureId);
/* 20666 */         this.connection.flush();
/*       */       }
/* 20668 */       catch (Exception ex) {
/*       */         
/* 20670 */         logInfo(this.player.getName() + ':' + " structureId: " + structureId + ' ' + ex.getMessage(), ex);
/* 20671 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   protected void sendUpdateFence(Fence fence) {
/* 20683 */     sendRemoveFence(fence);
/* 20684 */     sendAddFence(fence);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveFloor(long structureId, Floor floor) {
/* 20689 */     if (this.player == null)
/*       */       return; 
/* 20691 */     if (!this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */     try {
/* 20695 */       ByteBuffer bb = this.connection.getBuffer();
/* 20696 */       bb.put((byte)77);
/* 20697 */       bb.putLong(structureId);
/* 20698 */       bb.putShort((short)floor.getTileX());
/* 20699 */       bb.putShort((short)floor.getTileY());
/* 20700 */       bb.putShort((short)floor.getHeightOffset());
/* 20701 */       bb.put(floor.getLayer());
/* 20702 */       bb.put(floor.getType().getCode());
/* 20703 */       this.connection.flush();
/*       */     }
/* 20705 */     catch (Exception ex) {
/*       */       
/* 20707 */       logInfo(this.player.getName() + ':' + " structureId: " + structureId + ' ' + ex.getMessage(), ex);
/* 20708 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddFloor(long structureId, Floor floor) {
/* 20714 */     if (this.player == null)
/*       */       return; 
/* 20716 */     if (!this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */     try {
/* 20720 */       ByteBuffer bb = this.connection.getBuffer();
/* 20721 */       bb.put((byte)82);
/* 20722 */       bb.putLong(structureId);
/* 20723 */       bb.putShort((short)floor.getTileX());
/* 20724 */       bb.putShort((short)floor.getTileY());
/* 20725 */       bb.putShort((short)floor.getHeightOffset());
/* 20726 */       bb.put(floor.getType().getCode());
/* 20727 */       bb.put(floor.getMaterial().getCode());
/* 20728 */       bb.put(floor.getFloorState().getCode());
/* 20729 */       bb.put(floor.getLayer());
/* 20730 */       bb.put(floor.getDir());
/*       */ 
/*       */       
/* 20733 */       this.connection.flush();
/*       */     }
/* 20735 */     catch (Exception ex) {
/*       */       
/* 20737 */       logInfo(this.player.getName() + ':' + " structureId: " + structureId + ' ' + ex.getMessage(), ex);
/* 20738 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveBridgePart(long structureId, BridgePart bridgePart) {
/* 20744 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20748 */         ByteBuffer bb = this.connection.getBuffer();
/* 20749 */         bb.put((byte)-25);
/* 20750 */         bb.put((byte)4);
/* 20751 */         bb.putLong(structureId);
/* 20752 */         bb.putShort((short)bridgePart.getTileX());
/* 20753 */         bb.putShort((short)bridgePart.getTileY());
/* 20754 */         bb.putShort((short)bridgePart.getRealHeight());
/* 20755 */         bb.put(bridgePart.getLayer());
/* 20756 */         this.connection.flush();
/*       */       }
/* 20758 */       catch (Exception ex) {
/*       */         
/* 20760 */         logInfo(this.player.getName() + ':' + " structureId: " + structureId + ' ' + ex.getMessage(), ex);
/* 20761 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddBridgePart(long structureId, BridgePart bridgePart) {
/* 20768 */     if (this.player == null)
/*       */       return; 
/* 20770 */     if (!this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */     try {
/* 20774 */       ByteBuffer bb = this.connection.getBuffer();
/* 20775 */       bb.put((byte)-25);
/* 20776 */       bb.put((byte)3);
/* 20777 */       bb.putLong(structureId);
/* 20778 */       bb.putShort((short)bridgePart.getTileX());
/* 20779 */       bb.putShort((short)bridgePart.getTileY());
/* 20780 */       bb.putShort((short)bridgePart.getRealHeight());
/* 20781 */       bb.put(bridgePart.getType().getCode());
/* 20782 */       bb.put(bridgePart.getMaterial().getCode());
/* 20783 */       bb.put(bridgePart.getBridgePartState().getCode());
/* 20784 */       bb.put(bridgePart.getDir());
/* 20785 */       bb.put(bridgePart.getSlope());
/* 20786 */       bb.put(bridgePart.getRoadType());
/* 20787 */       bb.put(bridgePart.getLayer());
/* 20788 */       this.connection.flush();
/*       */     }
/* 20790 */     catch (Exception ex) {
/*       */       
/* 20792 */       logInfo(this.player.getName() + ':' + " structureId: " + structureId + ' ' + ex.getMessage(), ex);
/* 20793 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddWall(long structureId, Wall wall) {
/* 20799 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20803 */         ByteBuffer bb = this.connection.getBuffer();
/* 20804 */         bb.put((byte)49);
/* 20805 */         bb.putLong(structureId);
/* 20806 */         bb.putShort((short)Math.min(wall.getStartY(), wall.getEndY()));
/* 20807 */         bb.putShort((short)Math.min(wall.getStartX(), wall.getEndX()));
/*       */         
/* 20809 */         if (wall.isHorizontal()) {
/* 20810 */           bb.put((byte)0);
/*       */         } else {
/* 20812 */           bb.put((byte)1);
/* 20813 */         }  if (wall.isFinished()) {
/* 20814 */           bb.put((wall.getType()).value);
/*       */         } else {
/* 20816 */           bb.put(StructureTypeEnum.PLAN.value);
/* 20817 */         }  byte[] tempStringArr = wall.getMaterialString().getBytes();
/* 20818 */         bb.put((byte)tempStringArr.length);
/* 20819 */         bb.put(tempStringArr);
/* 20820 */         bb.put((byte)((wall.getColor() == -1) ? 0 : 1));
/* 20821 */         if (wall.getColor() != -1) {
/*       */           
/* 20823 */           bb.put((byte)WurmColor.getColorRed(wall.getColor()));
/* 20824 */           bb.put((byte)WurmColor.getColorGreen(wall.getColor()));
/* 20825 */           bb.put((byte)WurmColor.getColorBlue(wall.getColor()));
/*       */         } 
/* 20827 */         bb.putShort((short)wall.getHeight());
/* 20828 */         bb.put(wall.getLayer());
/* 20829 */         bb.put((byte)(wall.getWallOrientationFlag() ? 1 : 0));
/*       */         
/* 20831 */         Door door = wall.getDoor();
/* 20832 */         if (door != null && !door.getName().isEmpty())
/* 20833 */           sendByteStringLength(door.getName(), bb); 
/* 20834 */         this.connection.flush();
/*       */       }
/* 20836 */       catch (Exception ex) {
/*       */         
/* 20838 */         logInfo(this.player.getName() + ':' + " structureId: " + structureId + ' ' + ex.getMessage(), ex);
/* 20839 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendPassable(boolean passable, Door door) {
/* 20846 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20850 */         Wall wall = door.getWall();
/* 20851 */         ByteBuffer bb = this.connection.getBuffer();
/* 20852 */         bb.put((byte)125);
/* 20853 */         bb.putLong(door.getStructureId());
/* 20854 */         bb.putShort((short)Math.min(wall.getStartX(), wall.getEndX()));
/* 20855 */         bb.putShort((short)Math.min(wall.getStartY(), wall.getEndY()));
/*       */         
/* 20857 */         if (passable) {
/* 20858 */           bb.put((byte)1);
/*       */         } else {
/* 20860 */           bb.put((byte)0);
/* 20861 */         }  if (wall.isHorizontal()) {
/* 20862 */           bb.put((byte)0);
/*       */         } else {
/* 20864 */           bb.put((byte)1);
/* 20865 */         }  bb.putShort((short)(door.getFloorLevel() * 30));
/*       */ 
/*       */ 
/*       */ 
/*       */         
/* 20870 */         bb.put(door.getLayer());
/*       */         
/* 20872 */         this.connection.flush();
/*       */       }
/* 20874 */       catch (NoSuchWallException nsw) {
/*       */         
/*       */         return;
/*       */       }
/* 20878 */       catch (Exception ex) {
/*       */         
/* 20880 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 20881 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendOpenDoor(Door door) {
/* 20888 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20892 */         Wall wall = door.getWall();
/* 20893 */         ByteBuffer bb = this.connection.getBuffer();
/* 20894 */         bb.put((byte)122);
/* 20895 */         bb.putLong(door.getStructureId());
/* 20896 */         bb.putShort((short)Math.min(wall.getStartX(), wall.getEndX()));
/* 20897 */         bb.putShort((short)Math.min(wall.getStartY(), wall.getEndY()));
/* 20898 */         if (wall.isHorizontal()) {
/* 20899 */           bb.put((byte)0);
/*       */         } else {
/* 20901 */           bb.put((byte)1);
/* 20902 */         }  bb.putShort((short)(door.getFloorLevel() * 30));
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */         
/* 20908 */         bb.put(door.getLayer());
/* 20909 */         bb.put(door.canBeOpenedBy((Creature)getPlayer(), false) ? 1 : 0);
/* 20910 */         this.connection.flush();
/*       */       }
/* 20912 */       catch (NoSuchWallException nsw) {
/*       */         
/*       */         return;
/*       */       }
/* 20916 */       catch (Exception ex) {
/*       */         
/* 20918 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 20919 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendCloseDoor(Door door) {
/* 20926 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20930 */         Wall wall = door.getWall();
/* 20931 */         ByteBuffer bb = this.connection.getBuffer();
/* 20932 */         bb.put(127);
/* 20933 */         bb.putLong(door.getStructureId());
/* 20934 */         bb.putShort((short)Math.min(wall.getStartX(), wall.getEndX()));
/* 20935 */         bb.putShort((short)Math.min(wall.getStartY(), wall.getEndY()));
/* 20936 */         if (wall.isHorizontal()) {
/* 20937 */           bb.put((byte)0);
/*       */         } else {
/* 20939 */           bb.put((byte)1);
/* 20940 */         }  bb.putShort((short)(door.getFloorLevel() * 30));
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */         
/* 20946 */         bb.put(door.getLayer());
/* 20947 */         this.connection.flush();
/*       */       }
/* 20949 */       catch (NoSuchWallException nsw) {
/*       */         
/*       */         return;
/*       */       }
/* 20953 */       catch (Exception ex) {
/*       */         
/* 20955 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 20956 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendStartMoving() {
/* 20963 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 20967 */         ByteBuffer bb = this.connection.getBuffer();
/* 20968 */         bb.put((byte)-28);
/* 20969 */         this.connection.flush();
/*       */       }
/* 20971 */       catch (Exception ex) {
/*       */         
/* 20973 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendBml(int width, int height, boolean resizeable, boolean closeable, String content, int r, int g, int b, String title) {
/* 21004 */     sendBml((short)-10, width, height, 0.5F, 0.5F, resizeable, closeable, content, r, g, b, title);
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendBml(int width, int height, float xLoc, float yLoc, boolean resizeable, boolean closeable, String content, int r, int g, int b, String title) {
/* 21010 */     sendBml((short)-10, width, height, xLoc, yLoc, resizeable, closeable, content, r, g, b, title);
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendBml(short id, int width, int height, float xLoc, float yLoc, boolean resizeable, boolean closeable, String content, int r, int g, int b, String title) {
/* 21016 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */         
/* 21021 */         byte[] tempStringArr = title.getBytes("UTF-8");
/* 21022 */         ByteBuffer bb = this.connection.getBuffer();
/* 21023 */         bb.put((byte)106);
/* 21024 */         bb.put((byte)1);
/* 21025 */         bb.putShort(id);
/* 21026 */         bb.put((byte)tempStringArr.length);
/* 21027 */         bb.put(tempStringArr);
/* 21028 */         bb.putShort((short)width);
/* 21029 */         bb.putShort((short)height);
/* 21030 */         bb.putFloat(xLoc);
/* 21031 */         bb.putFloat(yLoc);
/* 21032 */         tempStringArr = content.getBytes("UTF-8");
/*       */         
/* 21034 */         bb.put(resizeable ? 1 : 0);
/*       */         
/* 21036 */         bb.put(closeable ? 1 : 0);
/* 21037 */         bb.put((byte)r);
/* 21038 */         bb.put((byte)g);
/* 21039 */         bb.put((byte)b);
/*       */ 
/*       */ 
/*       */ 
/*       */         
/* 21044 */         int gap = 20;
/* 21045 */         int maxCap = bb.capacity() - 20;
/* 21046 */         int maxParts = 1;
/*       */ 
/*       */         
/* 21049 */         if (bb.remaining() - 20 >= tempStringArr.length) {
/*       */ 
/*       */           
/* 21052 */           bb.put((byte)maxParts);
/* 21053 */           bb.putShort((short)tempStringArr.length);
/* 21054 */           bb.put(tempStringArr);
/* 21055 */           this.connection.flush();
/*       */         
/*       */         }
/*       */         else {
/*       */ 
/*       */           
/* 21061 */           int pLen = bb.remaining() - 20;
/* 21062 */           int left = tempStringArr.length - pLen;
/* 21063 */           for (maxParts = 2;; maxParts++) {
/*       */             
/* 21065 */             left -= maxCap;
/* 21066 */             if (left < 0)
/*       */               break; 
/*       */           } 
/* 21069 */           int pStart = 0;
/* 21070 */           bb.put((byte)maxParts);
/*       */           
/* 21072 */           bb.putShort((short)pLen);
/* 21073 */           bb.put(tempStringArr, pStart, pLen);
/* 21074 */           this.connection.flush();
/*       */           
/* 21076 */           for (int pNo = 2; pNo <= maxParts; pNo++)
/*       */           {
/* 21078 */             pStart += pLen;
/* 21079 */             pLen = Math.min(maxCap, tempStringArr.length - pStart);
/* 21080 */             bb = this.connection.getBuffer();
/* 21081 */             bb.put((byte)106);
/* 21082 */             bb.put((byte)pNo);
/* 21083 */             bb.putShort((short)pLen);
/* 21084 */             bb.put(tempStringArr, pStart, pLen);
/* 21085 */             this.connection.flush();
/*       */           }
/*       */         
/*       */         } 
/* 21089 */       } catch (Exception ex) {
/*       */         
/* 21091 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 21092 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendChangeStructureName(long structureId, String newName) {
/* 21099 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21103 */         byte[] tempStringArr = newName.getBytes("UTF-8");
/* 21104 */         ByteBuffer bb = this.connection.getBuffer();
/* 21105 */         bb.put((byte)47);
/* 21106 */         bb.put((byte)0);
/* 21107 */         bb.putLong(structureId);
/* 21108 */         bb.put((byte)tempStringArr.length);
/* 21109 */         bb.put(tempStringArr);
/* 21110 */         this.connection.flush();
/*       */       }
/* 21112 */       catch (Exception ex) {
/*       */         
/* 21114 */         logInfo(this.player.getName() + ':' + " structureId: " + structureId + ' ' + ex.getMessage(), ex);
/* 21115 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendChangeModelName(long creatureId, String newName) {
/* 21122 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21126 */         byte[] tempStringArr = newName.getBytes("UTF-8");
/* 21127 */         ByteBuffer bb = this.connection.getBuffer();
/* 21128 */         bb.put((byte)47);
/* 21129 */         bb.put((byte)3);
/* 21130 */         bb.putLong(creatureId);
/* 21131 */         bb.put((byte)tempStringArr.length);
/* 21132 */         bb.put(tempStringArr);
/* 21133 */         this.connection.flush();
/*       */       }
/* 21135 */       catch (Exception ex) {
/*       */         
/* 21137 */         logInfo(this.player.getName() + ':' + " modelname: " + newName + ' ' + ex.getMessage(), ex);
/* 21138 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendUseBinoculars() {
/* 21145 */     sendClientFeature((byte)1, true);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendStopUseBinoculars() {
/* 21150 */     sendClientFeature((byte)1, false);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendToggle(int toggle, boolean set) {
/* 21155 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21159 */         ByteBuffer bb = this.connection.getBuffer();
/* 21160 */         bb.put((byte)62);
/* 21161 */         bb.put((byte)toggle);
/* 21162 */         bb.put((byte)(set ? 1 : 0));
/* 21163 */         this.connection.flush();
/*       */       }
/* 21165 */       catch (Exception ex) {
/*       */         
/* 21167 */         logInfo("Problem sending toggle (" + toggle + ',' + set + ") to " + this.player.getName() + " due to :" + ex
/* 21168 */             .getMessage(), ex);
/* 21169 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendBridgeId(long creatureId, long bridgeId) {
/* 21176 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21180 */         ByteBuffer bb = this.connection.getBuffer();
/* 21181 */         bb.put((byte)-21);
/* 21182 */         bb.putLong(creatureId);
/* 21183 */         bb.putLong(bridgeId);
/* 21184 */         this.connection.flush();
/*       */       }
/* 21186 */       catch (Exception ex) {
/*       */         
/* 21188 */         logInfo(this.player.getName() + " problem sending bridge Id due to :" + ex
/* 21189 */             .getMessage(), ex);
/* 21190 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendTeleport(boolean aLocal) {
/* 21197 */     sendTeleport(aLocal, true, (byte)0);
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendTeleport(boolean aLocal, boolean disembark, byte startCommandingType) {
/* 21202 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/* 21204 */       this.player.setTeleportCounter(this.player.getTeleportCounter() + 1);
/*       */       
/* 21206 */       this.player.setTeleporting(true);
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/*       */       try {
/* 21220 */         ByteBuffer bb = this.connection.getBuffer();
/* 21221 */         bb.put((byte)51);
/* 21222 */         bb.putFloat(this.player.getStatus().getPositionX());
/* 21223 */         bb.putFloat(this.player.getStatus().getPositionY());
/* 21224 */         bb.putFloat(this.player.getStatus().getPositionZ());
/* 21225 */         bb.putFloat(this.player.getStatus().getRotation());
/* 21226 */         bb.put((byte)(aLocal ? 1 : 0));
/*       */         
/* 21228 */         bb.put((byte)(this.player.isOnSurface() ? 0 : -1));
/* 21229 */         bb.put((byte)(disembark ? 1 : 0));
/* 21230 */         bb.put(startCommandingType);
/* 21231 */         bb.putInt(this.player.getTeleportCounter());
/* 21232 */         this.connection.flush();
/*       */ 
/*       */ 
/*       */         
/* 21236 */         this.currentmove = null;
/* 21237 */         this.moves = 1;
/* 21238 */         this.receivedTicks = false;
/*       */         
/* 21240 */         sendWeather();
/*       */       }
/* 21242 */       catch (Exception ex) {
/*       */         
/* 21244 */         this.player.setLink(false);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendStartTrading(Creature opponent) {
/* 21251 */     Trade trade = this.player.getTrade();
/* 21252 */     if (trade != null)
/*       */     {
/* 21254 */       if (this.player != null && this.player.hasLink()) {
/*       */         
/*       */         try {
/*       */           
/* 21258 */           String name = opponent.getName();
/* 21259 */           byte[] tempStringArr = name.getBytes("UTF-8");
/* 21260 */           ByteBuffer bb = this.connection.getBuffer();
/* 21261 */           bb.put((byte)119);
/* 21262 */           bb.put((byte)tempStringArr.length);
/* 21263 */           bb.put(tempStringArr);
/* 21264 */           if (trade.creatureOne == this.player) {
/*       */             
/* 21266 */             bb.putLong(1L);
/* 21267 */             bb.putLong(2L);
/* 21268 */             bb.putLong(3L);
/* 21269 */             bb.putLong(4L);
/*       */           }
/*       */           else {
/*       */             
/* 21273 */             bb.putLong(2L);
/* 21274 */             bb.putLong(1L);
/* 21275 */             bb.putLong(4L);
/* 21276 */             bb.putLong(3L);
/*       */           } 
/* 21278 */           this.connection.flush();
/*       */         }
/* 21280 */         catch (Exception ex) {
/*       */           
/* 21282 */           logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 21283 */           this.player.setLink(false);
/*       */         } 
/*       */       }
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendCloseTradeWindow() {
/* 21291 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21295 */         ByteBuffer bb = this.connection.getBuffer();
/* 21296 */         bb.put((byte)121);
/* 21297 */         this.connection.flush();
/*       */       }
/* 21299 */       catch (Exception ex) {
/*       */         
/* 21301 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 21302 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private void reallySendTradeAgree() {
/* 21309 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21313 */         ByteBuffer bb = this.connection.getBuffer();
/* 21314 */         bb.put((byte)42);
/* 21315 */         bb.put((byte)(this.tradeAgreeToSend ? 1 : 0));
/* 21316 */         this.connection.flush();
/* 21317 */         this.shouldSendTradeAgree = false;
/*       */       }
/* 21319 */       catch (Exception ex) {
/*       */         
/* 21321 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 21322 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendTradeAgree(Creature agreer, boolean agree) {
/* 21329 */     boolean me = false;
/* 21330 */     if (this.player.equals(agreer))
/* 21331 */       me = true; 
/* 21332 */     if (me && agree)
/*       */       return; 
/* 21334 */     this.shouldSendTradeAgree = true;
/* 21335 */     this.tradeAgreeToSend = agree;
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendTradeChanged(int id) {
/* 21340 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21344 */         ByteBuffer bb = this.connection.getBuffer();
/* 21345 */         bb.put((byte)91);
/* 21346 */         bb.putInt(id);
/* 21347 */         this.connection.flush();
/*       */       }
/* 21349 */       catch (Exception ex) {
/*       */         
/* 21351 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 21352 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddFence(Fence fence) {
/* 21359 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21363 */         ByteBuffer bb = this.connection.getBuffer();
/* 21364 */         bb.put((byte)12);
/* 21365 */         bb.putShort((short)fence.getTileX());
/* 21366 */         bb.putShort((short)fence.getTileY());
/* 21367 */         bb.put(fence.getDir().getCode());
/* 21368 */         bb.putShort((short)fence.getType().ordinal());
/* 21369 */         bb.put((byte)(fence.isFinished() ? 1 : 0));
/* 21370 */         bb.put((byte)((fence.getColor() == -1) ? 0 : 1));
/* 21371 */         if (fence.getColor() != -1) {
/*       */           
/* 21373 */           bb.put((byte)WurmColor.getColorRed(fence.getColor()));
/* 21374 */           bb.put((byte)WurmColor.getColorGreen(fence.getColor()));
/* 21375 */           bb.put((byte)WurmColor.getColorBlue(fence.getColor()));
/*       */         } 
/* 21377 */         bb.putShort((short)fence.getHeightOffset());
/* 21378 */         bb.put(fence.getLayer());
/*       */         
/* 21380 */         FenceGate gate = FenceGate.getFenceGate(fence.getId());
/* 21381 */         if (gate != null && !gate.getName().isEmpty())
/* 21382 */           sendByteStringLength(gate.getName(), bb); 
/* 21383 */         this.connection.flush();
/*       */       }
/* 21385 */       catch (Exception ex) {
/*       */         
/* 21387 */         logInfo(this.player.getName() + " adding fence: " + fence + " :" + ex.getMessage(), ex);
/* 21388 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveFence(Fence fence) {
/* 21395 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21399 */         ByteBuffer bb = this.connection.getBuffer();
/* 21400 */         bb.put((byte)13);
/* 21401 */         bb.putShort((short)fence.getTileX());
/* 21402 */         bb.putShort((short)fence.getTileY());
/* 21403 */         bb.put(fence.getDir().getCode());
/* 21404 */         bb.putShort((short)fence.getHeightOffset());
/* 21405 */         bb.put(fence.getLayer());
/* 21406 */         this.connection.flush();
/*       */       }
/* 21408 */       catch (Exception ex) {
/*       */         
/* 21410 */         logInfo(this.player.getName() + " problem removing fence: " + fence + " due to :" + ex.getMessage(), ex);
/* 21411 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendOpenFence(Fence fence, boolean passable, boolean changePassable) {
/* 21418 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21422 */         ByteBuffer bb = this.connection.getBuffer();
/* 21423 */         bb.put((byte)83);
/* 21424 */         bb.putShort((short)fence.getTileX());
/* 21425 */         bb.putShort((short)fence.getTileY());
/* 21426 */         bb.put(fence.getDir().getCode());
/* 21427 */         bb.put((byte)1);
/* 21428 */         if (changePassable) {
/* 21429 */           bb.put((byte)(passable ? 1 : 0));
/*       */         } else {
/* 21431 */           bb.put((byte)2);
/* 21432 */         }  bb.putShort((short)fence.getHeightOffset());
/* 21433 */         bb.put(fence.getLayer());
/* 21434 */         this.connection.flush();
/*       */       }
/* 21436 */       catch (Exception ex) {
/*       */         
/* 21438 */         logInfo(this.player.getName() + " problem opening fence: " + fence + " due to :" + ex.getMessage(), ex);
/* 21439 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendCloseFence(Fence fence, boolean passable, boolean changePassable) {
/* 21446 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21450 */         ByteBuffer bb = this.connection.getBuffer();
/* 21451 */         bb.put((byte)83);
/* 21452 */         bb.putShort((short)fence.getTileX());
/* 21453 */         bb.putShort((short)fence.getTileY());
/* 21454 */         bb.put(fence.getDir().getCode());
/* 21455 */         bb.put((byte)0);
/* 21456 */         if (changePassable) {
/* 21457 */           bb.put((byte)(passable ? 1 : 0));
/*       */         } else {
/* 21459 */           bb.put((byte)2);
/* 21460 */         }  bb.putShort((short)fence.getHeightOffset());
/* 21461 */         bb.put(fence.getLayer());
/* 21462 */         this.connection.flush();
/*       */       }
/* 21464 */       catch (Exception ex) {
/*       */         
/* 21466 */         logInfo(this.player.getName() + " problem closing fence: " + fence + " due to :" + ex.getMessage(), ex);
/* 21467 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendOpenMineDoor(MineDoorPermission door) {
/* 21474 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21478 */         ByteBuffer bb = this.connection.getBuffer();
/* 21479 */         bb.put((byte)-60);
/* 21480 */         bb.putShort((short)door.getTileX());
/* 21481 */         bb.putShort((short)door.getTileY());
/* 21482 */         this.connection.flush();
/*       */       }
/* 21484 */       catch (Exception ex) {
/*       */         
/* 21486 */         logInfo(this.player.getName() + " problem opening mine door: " + door + " due to :" + ex.getMessage(), ex);
/* 21487 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendCloseMineDoor(MineDoorPermission door) {
/* 21494 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21498 */         ByteBuffer bb = this.connection.getBuffer();
/* 21499 */         bb.put((byte)-61);
/* 21500 */         bb.putShort((short)door.getTileX());
/* 21501 */         bb.putShort((short)door.getTileY());
/* 21502 */         this.connection.flush();
/*       */       }
/* 21504 */       catch (Exception ex) {
/*       */         
/* 21506 */         logInfo(this.player.getName() + " problem closing mine door: " + door + " due to :" + ex.getMessage(), ex);
/* 21507 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddMineDoor(MineDoorPermission door) {
/* 21514 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21518 */         ByteBuffer bb = this.connection.getBuffer();
/* 21519 */         bb.put((byte)-58);
/* 21520 */         bb.putShort((short)door.getTileX());
/* 21521 */         bb.putShort((short)door.getTileY());
/* 21522 */         bb.put(Tiles.decodeType(Server.surfaceMesh.getTile(door.getTileX(), door.getTileY())));
/* 21523 */         this.connection.flush();
/*       */       }
/* 21525 */       catch (Exception ex) {
/*       */         
/* 21527 */         logInfo(this.player.getName() + " problem adding mine door: " + door + " due to :" + ex.getMessage(), ex);
/* 21528 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveMineDoor(MineDoorPermission door) {
/* 21535 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21539 */         ByteBuffer bb = this.connection.getBuffer();
/* 21540 */         bb.put((byte)-59);
/* 21541 */         bb.putShort((short)door.getTileX());
/* 21542 */         bb.putShort((short)door.getTileY());
/* 21543 */         this.connection.flush();
/*       */       }
/* 21545 */       catch (Exception ex) {
/*       */         
/* 21547 */         logInfo(this.player.getName() + " problem removing mine door: " + door + " due to :" + ex.getMessage(), ex);
/* 21548 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */   
/*       */   public void sendSound(Sound sound) {
/* 21554 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21558 */         String name = sound.getName();
/* 21559 */         byte[] tempStringArr = name.getBytes("UTF-8");
/* 21560 */         ByteBuffer bb = this.connection.getBuffer();
/* 21561 */         bb.put((byte)86);
/* 21562 */         bb.put((byte)tempStringArr.length);
/* 21563 */         bb.put(tempStringArr);
/* 21564 */         bb.putFloat(sound.getPosX());
/* 21565 */         bb.putFloat(sound.getPosY());
/* 21566 */         bb.putFloat(sound.getPosZ());
/* 21567 */         bb.putFloat(sound.getPitch());
/* 21568 */         bb.putFloat(sound.getVolume());
/* 21569 */         bb.putFloat(sound.getPriority());
/* 21570 */         this.connection.flush();
/*       */       }
/* 21572 */       catch (Exception ex) {
/*       */         
/* 21574 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 21575 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendMusic(Sound sound) {
/* 21582 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21586 */         String name = sound.getName();
/* 21587 */         byte[] tempStringArr = name.getBytes("UTF-8");
/* 21588 */         ByteBuffer bb = this.connection.getBuffer();
/* 21589 */         bb.put((byte)115);
/* 21590 */         bb.put((byte)tempStringArr.length);
/* 21591 */         bb.put(tempStringArr);
/* 21592 */         bb.putFloat(sound.getPosX());
/* 21593 */         bb.putFloat(sound.getPosY());
/* 21594 */         bb.putFloat(sound.getPosZ());
/* 21595 */         bb.putFloat(sound.getPitch());
/* 21596 */         bb.putFloat(sound.getVolume());
/* 21597 */         bb.putFloat(sound.getPriority());
/* 21598 */         this.connection.flush();
/*       */       }
/* 21600 */       catch (Exception ex) {
/*       */         
/* 21602 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 21603 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   protected void sendStatus(String status) {
/* 21610 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21614 */         byte[] tempStringArr = status.getBytes("UTF-8");
/* 21615 */         ByteBuffer bb = this.connection.getBuffer();
/* 21616 */         bb.put((byte)-18);
/* 21617 */         bb.put((byte)tempStringArr.length);
/* 21618 */         bb.put(tempStringArr);
/* 21619 */         this.connection.flush();
/*       */       }
/* 21621 */       catch (Exception ex) {
/*       */         
/* 21623 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 21624 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddWound(Wound wound, Item bodyPart) {
/* 21631 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21635 */         ByteBuffer bb = this.connection.getBuffer();
/*       */ 
/*       */         
/* 21638 */         bb.put((byte)76);
/* 21639 */         if (this.player == wound.getCreature()) {
/* 21640 */           bb.putLong(-1L);
/*       */         } else {
/*       */           
/* 21643 */           Item body = wound.getCreature().getBody().getBodyItem();
/* 21644 */           bb.putLong(body.getWurmId());
/*       */         } 
/* 21646 */         long parentId = bodyPart.getWurmId();
/* 21647 */         bb.putLong(parentId);
/* 21648 */         bb.putLong(wound.getWurmId());
/* 21649 */         bb.putShort((short)wound.getWoundIconId());
/*       */ 
/*       */         
/* 21652 */         byte[] tempStringArr = wound.getName().getBytes("UTF-8");
/* 21653 */         bb.put((byte)tempStringArr.length);
/* 21654 */         bb.put(tempStringArr);
/*       */ 
/*       */ 
/*       */         
/* 21658 */         tempStringArr = "".getBytes("UTF-8");
/* 21659 */         bb.put((byte)tempStringArr.length);
/* 21660 */         bb.put(tempStringArr);
/*       */         
/* 21662 */         tempStringArr = wound.getDescription().getBytes("UTF-8");
/* 21663 */         bb.put((byte)tempStringArr.length);
/* 21664 */         bb.put(tempStringArr);
/* 21665 */         bb.putFloat(100.0F);
/* 21666 */         bb.putFloat(wound.getSeverity() * 0.0015259022F);
/* 21667 */         bb.putInt(0);
/* 21668 */         bb.put((byte)0);
/* 21669 */         bb.put((byte)0);
/* 21670 */         bb.put((byte)0);
/* 21671 */         bb.putShort(ItemTypeUtilites.calcProfile(true, false, false, false, false, false, false, false));
/* 21672 */         bb.put((byte)0);
/* 21673 */         bb.put((byte)0);
/* 21674 */         bb.put((byte)0);
/* 21675 */         this.connection.flush();
/*       */       }
/* 21677 */       catch (Exception ex) {
/*       */         
/* 21679 */         logInfo(this.player.getName() + ':' + wound.getWoundString(), ex);
/*       */         
/* 21681 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveWound(Wound wound) {
/* 21688 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21692 */         ByteBuffer bb = this.connection.getBuffer();
/* 21693 */         bb.put((byte)-10);
/* 21694 */         if (this.player == wound.getCreature()) {
/* 21695 */           bb.putLong(-1L);
/*       */         } else {
/*       */           
/* 21698 */           Item body = wound.getCreature().getBody().getBodyItem();
/* 21699 */           bb.putLong(body.getWurmId());
/*       */         } 
/* 21701 */         bb.putLong(wound.getWurmId());
/* 21702 */         this.connection.flush();
/*       */       }
/* 21704 */       catch (Exception ex) {
/*       */         
/* 21706 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 21707 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendUpdateWound(Wound wound, Item bodyPart) {
/* 21714 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21718 */         byte[] tempStringArr = wound.getName().getBytes("UTF-8");
/*       */         
/* 21720 */         ByteBuffer bb = this.connection.getBuffer();
/* 21721 */         bb.put((byte)68);
/*       */         
/* 21723 */         if (this.player == wound.getCreature()) {
/* 21724 */           bb.putLong(-1L);
/*       */         } else {
/*       */           
/* 21727 */           Item body = wound.getCreature().getBody().getBodyItem();
/* 21728 */           bb.putLong(body.getWurmId());
/*       */         } 
/* 21730 */         bb.putLong(wound.getWurmId());
/* 21731 */         long parentId = bodyPart.getWurmId();
/* 21732 */         bb.putLong(parentId);
/* 21733 */         bb.put((byte)tempStringArr.length);
/* 21734 */         bb.put(tempStringArr);
/* 21735 */         tempStringArr = wound.getDescription().getBytes("UTF-8");
/* 21736 */         bb.put((byte)tempStringArr.length);
/* 21737 */         bb.put(tempStringArr);
/* 21738 */         bb.putFloat(100.0F);
/* 21739 */         bb.putFloat(wound.getSeverity() * 0.0015259022F);
/* 21740 */         bb.putInt(0);
/*       */         
/* 21742 */         bb.put((byte)0);
/* 21743 */         bb.put((byte)0);
/* 21744 */         bb.put((byte)0);
/* 21745 */         bb.put((byte)0);
/* 21746 */         bb.put((byte)0);
/* 21747 */         bb.put((byte)0);
/* 21748 */         bb.putShort((short)wound.getWoundIconId());
/*       */         
/* 21750 */         this.connection.flush();
/*       */       }
/* 21752 */       catch (Exception ex) {
/*       */         
/* 21754 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 21755 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendSelfToLocal() {
/* 21762 */     if (this.player != null && this.player.hasLink()) {
/*       */ 
/*       */       
/*       */       try {
/* 21766 */         byte[] tempStringArr = this.player.getName().getBytes("UTF-8");
/* 21767 */         ByteBuffer bb = this.connection.getBuffer();
/* 21768 */         bb.put((byte)-13);
/* 21769 */         bb.put((byte)local.length);
/* 21770 */         bb.put(local);
/* 21771 */         bb.put((byte)tempStringArr.length);
/* 21772 */         bb.put(tempStringArr);
/* 21773 */         bb.putLong(this.player.getWurmId());
/* 21774 */         this.connection.flush();
/*       */       }
/* 21776 */       catch (Exception ex) {
/*       */         
/* 21778 */         logWarn(this.player.getName() + ':' + ex.getMessage(), ex);
/* 21779 */         this.player.setLink(false);
/*       */       } 
/* 21781 */       changeAttitude(this.player.getWurmId(), (this.player.getCitizenVillage() != null) ? 1 : 7);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendAddFriend(String name, long wurmid) {
/* 21788 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21792 */         byte[] tempStringArr = name.getBytes("UTF-8");
/* 21793 */         ByteBuffer bb = this.connection.getBuffer();
/* 21794 */         bb.put((byte)-13);
/* 21795 */         bb.put((byte)friends.length);
/* 21796 */         bb.put(friends);
/* 21797 */         bb.put((byte)tempStringArr.length);
/* 21798 */         bb.put(tempStringArr);
/* 21799 */         bb.putLong(wurmid);
/* 21800 */         this.connection.flush();
/*       */       }
/* 21802 */       catch (Exception ex) {
/*       */         
/* 21804 */         logWarn(this.player.getName() + ':' + " wurmId " + wurmid + ' ' + ex.getMessage(), ex);
/* 21805 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveFriend(String name) {
/* 21812 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21816 */         byte[] tempStringArr = name.getBytes("UTF-8");
/* 21817 */         ByteBuffer bb = this.connection.getBuffer();
/* 21818 */         bb.put((byte)114);
/* 21819 */         bb.put((byte)friends.length);
/* 21820 */         bb.put(friends);
/* 21821 */         bb.put((byte)tempStringArr.length);
/* 21822 */         bb.put(tempStringArr);
/* 21823 */         this.connection.flush();
/*       */       }
/* 21825 */       catch (Exception ex) {
/*       */         
/* 21827 */         logWarn(this.player.getName() + ':' + ex.getMessage(), ex);
/* 21828 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddAlly(String name, long wurmid) {
/* 21835 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21839 */         byte[] tempStringArr = name.getBytes("UTF-8");
/* 21840 */         ByteBuffer bb = this.connection.getBuffer();
/* 21841 */         bb.put((byte)-13);
/* 21842 */         bb.put((byte)alliance.length);
/* 21843 */         bb.put(alliance);
/* 21844 */         bb.put((byte)tempStringArr.length);
/* 21845 */         bb.put(tempStringArr);
/* 21846 */         bb.putLong(wurmid);
/* 21847 */         this.connection.flush();
/*       */       }
/* 21849 */       catch (Exception ex) {
/*       */         
/* 21851 */         logWarn(this.player.getName() + ':' + " wurmId " + wurmid + ' ' + ex.getMessage(), ex);
/* 21852 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveAlly(String name) {
/* 21859 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21863 */         byte[] tempStringArr = name.getBytes("UTF-8");
/* 21864 */         ByteBuffer bb = this.connection.getBuffer();
/* 21865 */         bb.put((byte)114);
/* 21866 */         bb.put((byte)alliance.length);
/* 21867 */         bb.put(alliance);
/* 21868 */         bb.put((byte)tempStringArr.length);
/* 21869 */         bb.put(tempStringArr);
/* 21870 */         this.connection.flush();
/*       */       }
/* 21872 */       catch (Exception ex) {
/*       */         
/* 21874 */         logWarn(this.player.getName() + ':' + ex.getMessage(), ex);
/* 21875 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddVillager(String name, long wurmid) {
/* 21882 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21886 */         byte[] tempStringArr = name.getBytes("UTF-8");
/* 21887 */         ByteBuffer bb = this.connection.getBuffer();
/* 21888 */         bb.put((byte)-13);
/* 21889 */         bb.put((byte)village.length);
/* 21890 */         bb.put(village);
/* 21891 */         bb.put((byte)tempStringArr.length);
/* 21892 */         bb.put(tempStringArr);
/* 21893 */         bb.putLong(wurmid);
/* 21894 */         this.connection.flush();
/*       */       }
/* 21896 */       catch (Exception ex) {
/*       */         
/* 21898 */         logWarn(this.player.getName() + ':' + " wurmId " + wurmid + ' ' + ex.getMessage(), ex);
/* 21899 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveVillager(String name) {
/* 21906 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21910 */         byte[] tempStringArr = name.getBytes("UTF-8");
/* 21911 */         ByteBuffer bb = this.connection.getBuffer();
/* 21912 */         bb.put((byte)114);
/* 21913 */         bb.put((byte)village.length);
/* 21914 */         bb.put(village);
/* 21915 */         bb.put((byte)tempStringArr.length);
/* 21916 */         bb.put(tempStringArr);
/* 21917 */         this.connection.flush();
/*       */       }
/* 21919 */       catch (Exception ex) {
/*       */         
/* 21921 */         logWarn(this.player.getName() + ':' + ex.getMessage(), ex);
/* 21922 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddLocal(String name, long wurmid) {
/* 21929 */     if (this.player != null && this.player.hasLink())
/*       */     {
/* 21931 */       if (!this.player.isUndead()) {
/*       */         
/*       */         try {
/* 21934 */           byte[] tempStringArr = name.getBytes("UTF-8");
/* 21935 */           ByteBuffer bb = this.connection.getBuffer();
/* 21936 */           bb.put((byte)-13);
/* 21937 */           bb.put((byte)local.length);
/* 21938 */           bb.put(local);
/* 21939 */           bb.put((byte)tempStringArr.length);
/* 21940 */           bb.put(tempStringArr);
/* 21941 */           bb.putLong(wurmid);
/* 21942 */           this.connection.flush();
/*       */         }
/* 21944 */         catch (Exception ex) {
/*       */           
/* 21946 */           logWarn(this.player.getName() + ':' + " wurmId " + wurmid + ' ' + ex.getMessage(), ex);
/* 21947 */           this.player.setLink(false);
/*       */         } 
/*       */       }
/*       */     }
/*       */   }
/*       */   
/*       */   public void sendRemoveLocal(String name) {
/* 21954 */     if (this.player != null && this.player.hasLink())
/*       */     {
/* 21956 */       if (!this.player.isUndead()) {
/*       */         
/*       */         try {
/* 21959 */           if (!Servers.localServer.isChaosServer() || this.player.isPaying())
/*       */           {
/* 21961 */             byte[] tempStringArr = name.getBytes("UTF-8");
/* 21962 */             ByteBuffer bb = this.connection.getBuffer();
/* 21963 */             bb.put((byte)114);
/* 21964 */             bb.put((byte)local.length);
/* 21965 */             bb.put(local);
/* 21966 */             bb.put((byte)tempStringArr.length);
/* 21967 */             bb.put(tempStringArr);
/* 21968 */             this.connection.flush();
/*       */           }
/*       */         
/* 21971 */         } catch (Exception ex) {
/*       */           
/* 21973 */           logWarn(this.player.getName() + ':' + ex.getMessage(), ex);
/* 21974 */           this.player.setLink(false);
/*       */         } 
/*       */       }
/*       */     }
/*       */   }
/*       */   
/*       */   public void sendAddTeam(String name, long wurmid) {
/* 21981 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 21985 */         byte[] tempStringArr = name.getBytes("UTF-8");
/* 21986 */         ByteBuffer bb = this.connection.getBuffer();
/* 21987 */         bb.put((byte)-13);
/* 21988 */         bb.put((byte)team.length);
/* 21989 */         bb.put(team);
/* 21990 */         bb.put((byte)tempStringArr.length);
/* 21991 */         bb.put(tempStringArr);
/* 21992 */         bb.putLong(wurmid);
/* 21993 */         this.connection.flush();
/*       */       }
/* 21995 */       catch (Exception ex) {
/*       */         
/* 21997 */         logWarn(this.player.getName() + ':' + " wurmId " + wurmid + ' ' + ex.getMessage(), ex);
/* 21998 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveTeam(String name) {
/* 22005 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 22009 */         byte[] tempStringArr = name.getBytes("UTF-8");
/* 22010 */         ByteBuffer bb = this.connection.getBuffer();
/* 22011 */         bb.put((byte)114);
/* 22012 */         bb.put((byte)team.length);
/* 22013 */         bb.put(team);
/* 22014 */         bb.put((byte)tempStringArr.length);
/* 22015 */         bb.put(tempStringArr);
/* 22016 */         this.connection.flush();
/*       */       }
/* 22018 */       catch (Exception ex) {
/*       */         
/* 22020 */         logWarn(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22021 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddGm(String name, long wurmid) {
/* 22028 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 22032 */         byte[] tempStringArr = name.getBytes("UTF-8");
/* 22033 */         ByteBuffer bb = this.connection.getBuffer();
/* 22034 */         bb.put((byte)-13);
/* 22035 */         bb.put((byte)gms.length);
/* 22036 */         bb.put(gms);
/* 22037 */         bb.put((byte)tempStringArr.length);
/* 22038 */         bb.put(tempStringArr);
/* 22039 */         bb.putLong(wurmid);
/* 22040 */         this.connection.flush();
/*       */       }
/* 22042 */       catch (Exception ex) {
/*       */         
/* 22044 */         logWarn(this.player.getName() + ':' + " wurmId " + wurmid + ' ' + ex.getMessage(), ex);
/* 22045 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddPa(String name, long wurmid) {
/* 22052 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 22056 */         byte[] tempStringArr = name.getBytes("UTF-8");
/* 22057 */         ByteBuffer bb = this.connection.getBuffer();
/* 22058 */         bb.put((byte)-13);
/* 22059 */         bb.put((byte)pas.length);
/* 22060 */         bb.put(pas);
/* 22061 */         bb.put((byte)tempStringArr.length);
/* 22062 */         bb.put(tempStringArr);
/* 22063 */         bb.putLong(wurmid);
/* 22064 */         this.connection.flush();
/*       */       }
/* 22066 */       catch (Exception ex) {
/*       */         
/* 22068 */         logWarn(this.player.getName() + ':' + " wurmId " + wurmid + ' ' + ex.getMessage(), ex);
/* 22069 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveGm(String name) {
/* 22076 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 22082 */       byte[] tempStringArr = name.getBytes("UTF-8");
/* 22083 */       ByteBuffer bb = this.connection.getBuffer();
/* 22084 */       bb.put((byte)114);
/* 22085 */       bb.put((byte)gms.length);
/* 22086 */       bb.put(gms);
/* 22087 */       bb.put((byte)tempStringArr.length);
/* 22088 */       bb.put(tempStringArr);
/* 22089 */       this.connection.flush();
/*       */     }
/* 22091 */     catch (Exception ex) {
/*       */       
/* 22093 */       logWarn(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22094 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveMgmt(String name) {
/* 22100 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 22106 */       byte[] tempStringArr = name.getBytes("UTF-8");
/* 22107 */       ByteBuffer bb = this.connection.getBuffer();
/* 22108 */       bb.put((byte)114);
/* 22109 */       bb.put((byte)mgmt.length);
/* 22110 */       bb.put(mgmt);
/* 22111 */       bb.put((byte)tempStringArr.length);
/* 22112 */       bb.put(tempStringArr);
/* 22113 */       this.connection.flush();
/*       */     }
/* 22115 */     catch (Exception ex) {
/*       */       
/* 22117 */       logWarn(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22118 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddMgmt(String name, long wurmid) {
/* 22124 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 22130 */       byte[] tempStringArr = name.getBytes("UTF-8");
/* 22131 */       ByteBuffer bb = this.connection.getBuffer();
/* 22132 */       bb.put((byte)-13);
/* 22133 */       bb.put((byte)mgmt.length);
/* 22134 */       bb.put(mgmt);
/* 22135 */       bb.put((byte)tempStringArr.length);
/* 22136 */       bb.put(tempStringArr);
/* 22137 */       bb.putLong(wurmid);
/* 22138 */       this.connection.flush();
/*       */     }
/* 22140 */     catch (Exception ex) {
/*       */       
/* 22142 */       logWarn(this.player.getName() + ':' + " wurmId " + wurmid + ' ' + ex.getMessage(), ex);
/* 22143 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemovePa(String name) {
/* 22149 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 22155 */       byte[] tempStringArr = name.getBytes("UTF-8");
/* 22156 */       ByteBuffer bb = this.connection.getBuffer();
/* 22157 */       bb.put((byte)114);
/* 22158 */       bb.put((byte)pas.length);
/* 22159 */       bb.put(pas);
/* 22160 */       bb.put((byte)tempStringArr.length);
/* 22161 */       bb.put(tempStringArr);
/* 22162 */       this.connection.flush();
/*       */     }
/* 22164 */     catch (Exception ex) {
/*       */       
/* 22166 */       logWarn(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22167 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void changeAttitude(long creatureId, byte status) {
/* 22173 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 22179 */       ByteBuffer bb = this.connection.getBuffer();
/* 22180 */       bb.put((byte)6);
/* 22181 */       bb.putLong(creatureId);
/* 22182 */       bb.put(status);
/* 22183 */       this.connection.flush();
/*       */     }
/* 22185 */     catch (Exception ex) {
/*       */       
/* 22187 */       logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22188 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendWeather() {
/* 22194 */     this.shouldSendWeather = true;
/* 22195 */     if (this.player != null && this.player.hasLink())
/*       */     {
/* 22197 */       if (!this.connection.isWriting())
/*       */       {
/* 22199 */         checkSendWeather();
/*       */       }
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendSpecificWeather(float fogLevel) {
/* 22211 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 22217 */       ByteBuffer bb = this.connection.getBuffer();
/* 22218 */       bb.put((byte)46);
/* 22219 */       bb.putFloat(Server.getWeather().getCloudiness());
/* 22220 */       bb.putFloat(fogLevel);
/* 22221 */       bb.putFloat(Server.getWeather().getRain());
/*       */ 
/*       */       
/* 22224 */       bb.putFloat(Server.getWeather().getWindRotation());
/* 22225 */       bb.putFloat(Server.getWeather().getWindPower());
/* 22226 */       this.connection.flush();
/*       */     }
/* 22228 */     catch (Exception ex) {
/*       */       
/* 22230 */       logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22231 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void checkSendWeather() {
/* 22237 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */     
/* 22241 */     if (this.shouldSendWeather && !this.player.isInFogZone) {
/*       */       
/*       */       try {
/* 22244 */         this.shouldSendWeather = false;
/* 22245 */         ByteBuffer bb = this.connection.getBuffer();
/* 22246 */         bb.put((byte)46);
/* 22247 */         bb.putFloat(Server.getWeather().getCloudiness());
/* 22248 */         bb.putFloat(Server.getWeather().getFog());
/* 22249 */         bb.putFloat(Server.getWeather().getRain());
/*       */ 
/*       */         
/* 22252 */         bb.putFloat(Server.getWeather().getWindRotation());
/* 22253 */         bb.putFloat(Server.getWeather().getWindPower());
/* 22254 */         this.connection.flush();
/*       */ 
/*       */       
/*       */       }
/* 22258 */       catch (Exception ex) {
/*       */         
/* 22260 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22261 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */   
/*       */   public void sendDead() {
/* 22267 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 22273 */       ByteBuffer bb = this.connection.getBuffer();
/* 22274 */       bb.put((byte)65);
/* 22275 */       this.connection.flush();
/*       */     }
/* 22277 */     catch (Exception ex) {
/*       */       
/* 22279 */       logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22280 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendClimb(boolean climbing) {
/* 22286 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 22292 */       ByteBuffer bb = this.connection.getBuffer();
/* 22293 */       bb.put((byte)79);
/* 22294 */       bb.put((byte)(climbing ? 1 : 0));
/* 22295 */       this.connection.flush();
/*       */     }
/* 22297 */     catch (Exception ex) {
/*       */       
/* 22299 */       logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22300 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendReconnect(String ip, int port, String session) {
/* 22311 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 22317 */       ByteBuffer bb = this.connection.getBuffer();
/* 22318 */       bb.put((byte)23);
/* 22319 */       byte[] tempStringArr = ip.getBytes("UTF-8");
/* 22320 */       bb.put((byte)tempStringArr.length);
/* 22321 */       bb.put(tempStringArr);
/* 22322 */       bb.putInt(port);
/* 22323 */       tempStringArr = session.getBytes("UTF-8");
/* 22324 */       bb.put((byte)tempStringArr.length);
/* 22325 */       bb.put(tempStringArr);
/* 22326 */       this.connection.flush();
/*       */     }
/* 22328 */     catch (Exception ex) {
/*       */       
/* 22330 */       logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22331 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   protected void sendHasMoreItems(long inventoryId, long wurmid) {
/* 22337 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 22343 */       ByteBuffer bb = this.connection.getBuffer();
/* 22344 */       bb.put((byte)29);
/* 22345 */       bb.putLong(inventoryId);
/* 22346 */       bb.putLong(wurmid);
/* 22347 */       this.connection.flush();
/*       */     }
/* 22349 */     catch (Exception ex) {
/*       */       
/* 22351 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendIsEmpty(long inventoryId, long wurmid) {
/* 22357 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 22363 */       ByteBuffer bb = this.connection.getBuffer();
/* 22364 */       bb.put((byte)-16);
/* 22365 */       bb.putLong(inventoryId);
/* 22366 */       bb.putLong(wurmid);
/* 22367 */       this.connection.flush();
/*       */     }
/* 22369 */     catch (Exception ex) {
/*       */       
/* 22371 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   protected void sendCompass(Item item) {
/* 22377 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 22383 */       ByteBuffer bb = this.connection.getBuffer();
/* 22384 */       bb.put((byte)-30);
/* 22385 */       bb.put((byte)0);
/* 22386 */       if (item == null) {
/* 22387 */         bb.put((byte)0);
/*       */       } else {
/*       */         
/* 22390 */         float qualityLevel = item.getCurrentQualityLevel();
/* 22391 */         if (item.getSpellSpeedBonus() != 0.0F) {
/*       */           
/* 22393 */           float ench = item.getSpellSpeedBonus() / 100.0F;
/* 22394 */           float diff = Math.min(20.0F, 100.0F - qualityLevel);
/* 22395 */           qualityLevel += diff * ench;
/*       */         } 
/* 22397 */         bb.put((byte)(int)Math.max(1.0F, qualityLevel));
/*       */       } 
/* 22399 */       this.connection.flush();
/*       */     }
/* 22401 */     catch (Exception ex) {
/*       */       
/* 22403 */       logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22404 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   protected void sendToolbelt(Item item) {
/* 22410 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 22416 */       ByteBuffer bb = this.connection.getBuffer();
/* 22417 */       bb.put((byte)-30);
/* 22418 */       bb.put((byte)2);
/* 22419 */       if (item == null) {
/* 22420 */         bb.put((byte)0);
/*       */       } else {
/*       */         
/* 22423 */         bb.put((byte)(int)Math.max(1.0F, item.getCurrentQualityLevel() + (item.getRarity() * 10)));
/*       */       } 
/* 22425 */       this.connection.flush();
/*       */     }
/* 22427 */     catch (Exception ex) {
/*       */       
/* 22429 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void sendClientFeature(byte feature, boolean on) {
/* 22435 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 22441 */       ByteBuffer bb = this.connection.getBuffer();
/* 22442 */       bb.put((byte)-30);
/* 22443 */       bb.put(feature);
/* 22444 */       if (on) {
/* 22445 */         bb.put((byte)1);
/*       */       } else {
/* 22447 */         bb.put((byte)0);
/* 22448 */       }  this.connection.flush();
/*       */     }
/* 22450 */     catch (Exception ex) {
/*       */       
/* 22452 */       logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22453 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendServerTime() {
/* 22472 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 22476 */         ByteBuffer bb = this.connection.getBuffer();
/* 22477 */         bb.put((byte)107);
/* 22478 */         bb.putLong(System.currentTimeMillis());
/* 22479 */         bb.putLong(WurmCalendar.currentTime + this.timeMod);
/* 22480 */         this.connection.flush();
/*       */       }
/* 22482 */       catch (Exception ex) {
/*       */         
/* 22484 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22485 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendAttachEffect(long targetId, byte effectType, byte data0, byte data1, byte data2, byte dimension) {
/* 22493 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 22497 */         ByteBuffer bb = this.connection.getBuffer();
/* 22498 */         bb.put((byte)109);
/*       */ 
/*       */         
/* 22501 */         bb.putLong(targetId);
/* 22502 */         bb.put(effectType);
/*       */ 
/*       */         
/* 22505 */         bb.put(data0);
/*       */ 
/*       */ 
/*       */         
/* 22509 */         bb.put(data1);
/*       */         
/* 22511 */         bb.put(data2);
/*       */         
/* 22513 */         bb.put(dimension);
/*       */ 
/*       */ 
/*       */ 
/*       */         
/* 22518 */         this.connection.flush();
/*       */       }
/* 22520 */       catch (Exception ex) {
/*       */         
/* 22522 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22523 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveEffect(long targetId, byte effectType) {
/* 22530 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 22534 */         ByteBuffer bb = this.connection.getBuffer();
/* 22535 */         bb.put((byte)18);
/* 22536 */         bb.putLong(targetId);
/* 22537 */         bb.put(effectType);
/* 22538 */         this.connection.flush();
/*       */ 
/*       */       
/*       */       }
/* 22542 */       catch (Exception ex) {
/*       */         
/* 22544 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22545 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendWieldItem(long creatureId, byte slot, String modelname, byte rarity, int colorRed, int colorGreen, int colorBlue, int secondaryColorRed, int secondaryColorGreen, int secondaryColorBlue) {
/* 22554 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 22558 */         if (creatureId == -1L || WurmId.getType(creatureId) == 0)
/*       */         {
/* 22560 */           ByteBuffer bb = this.connection.getBuffer();
/* 22561 */           bb.put((byte)101);
/* 22562 */           bb.putLong(creatureId);
/* 22563 */           bb.put(slot);
/* 22564 */           byte[] tempStringArr = modelname.getBytes("UTF-8");
/* 22565 */           bb.putShort((short)tempStringArr.length);
/* 22566 */           bb.put(tempStringArr);
/* 22567 */           bb.put(rarity);
/* 22568 */           bb.putFloat(colorRed);
/* 22569 */           bb.putFloat(colorGreen);
/* 22570 */           bb.putFloat(colorBlue);
/* 22571 */           bb.putFloat(secondaryColorRed);
/* 22572 */           bb.putFloat(secondaryColorGreen);
/* 22573 */           bb.putFloat(secondaryColorBlue);
/* 22574 */           this.connection.flush();
/*       */         }
/*       */       
/* 22577 */       } catch (Exception ex) {
/*       */         
/* 22579 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22580 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendUseItem(long creatureId, String modelname, byte rarity, int colorRed, int colorGreen, int colorBlue, int secondaryColorRed, int secondaryColorGreen, int secondaryColorBlue) {
/* 22589 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 22593 */         if (creatureId == -1L || WurmId.getType(creatureId) == 0)
/*       */         {
/* 22595 */           ByteBuffer bb = this.connection.getBuffer();
/* 22596 */           bb.put((byte)110);
/* 22597 */           bb.putLong(creatureId);
/* 22598 */           byte[] tempStringArr = modelname.getBytes("UTF-8");
/* 22599 */           bb.putShort((short)tempStringArr.length);
/* 22600 */           bb.put(tempStringArr);
/* 22601 */           bb.put(rarity);
/* 22602 */           bb.putFloat(colorRed);
/* 22603 */           bb.putFloat(colorGreen);
/* 22604 */           bb.putFloat(colorBlue);
/* 22605 */           bb.putFloat(secondaryColorRed);
/* 22606 */           bb.putFloat(secondaryColorGreen);
/* 22607 */           bb.putFloat(secondaryColorBlue);
/* 22608 */           this.connection.flush();
/*       */         }
/*       */       
/* 22611 */       } catch (Exception ex) {
/*       */         
/* 22613 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22614 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddToCreationWindow(Item target) {
/* 22621 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 22625 */         ByteBuffer bb = this.connection.getBuffer();
/* 22626 */         bb.put((byte)-46);
/* 22627 */         bb.put((byte)1);
/* 22628 */         byte[] nameBytes = target.getName().getBytes("UTF-8");
/* 22629 */         bb.putShort((short)nameBytes.length);
/* 22630 */         bb.put(nameBytes);
/*       */         
/* 22632 */         bb.putLong(target.getWurmId());
/* 22633 */         bb.putFloat(target.getQualityLevel());
/* 22634 */         bb.putFloat(target.getDamage());
/* 22635 */         bb.putFloat(target.getWeightGrams() / 1000.0F);
/* 22636 */         bb.putShort(target.getImageNumber());
/*       */         
/* 22638 */         this.connection.flush();
/*       */       }
/* 22640 */       catch (Exception ex) {
/*       */         
/* 22642 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22643 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddWallToCreationWindow(Wall wall, long toReplace) {
/* 22650 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 22654 */         if (wall.isFinished())
/*       */           return; 
/* 22656 */         ByteBuffer bb = this.connection.getBuffer();
/* 22657 */         bb.put((byte)-46);
/* 22658 */         bb.put((byte)10);
/*       */         
/* 22660 */         bb.putLong(toReplace);
/* 22661 */         String name = (wall.getType() == StructureTypeEnum.PLAN) ? wall.getName() : ("Unfinished " + wall.getName());
/* 22662 */         byte[] nameBytes = name.getBytes("UTF-8");
/*       */         
/* 22664 */         bb.putShort((short)nameBytes.length);
/* 22665 */         bb.put(nameBytes);
/* 22666 */         bb.putLong(wall.getId());
/* 22667 */         bb.putFloat(wall.getQualityLevel());
/* 22668 */         bb.putFloat(wall.getDamage());
/* 22669 */         bb.putShort((short)60);
/* 22670 */         this.connection.flush();
/*       */       }
/* 22672 */       catch (Exception ex) {
/*       */         
/* 22674 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22675 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddFenceToCreationWindow(Fence fence, long toReplace) {
/* 22682 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 22686 */         ByteBuffer bb = this.connection.getBuffer();
/* 22687 */         bb.put((byte)-46);
/* 22688 */         bb.put((byte)8);
/*       */         
/* 22690 */         bb.putLong(toReplace);
/* 22691 */         byte[] nameBytes = WallConstants.getName(fence.getType()).getBytes("UTF-8");
/*       */         
/* 22693 */         bb.putShort((short)nameBytes.length);
/* 22694 */         bb.put(nameBytes);
/* 22695 */         bb.putLong(fence.getId());
/* 22696 */         bb.putFloat(fence.getQualityLevel());
/* 22697 */         bb.putFloat(fence.getDamage());
/* 22698 */         bb.putShort((short)60);
/* 22699 */         this.connection.flush();
/*       */       }
/* 22701 */       catch (Exception ex) {
/*       */         
/* 22703 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22704 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddFloorRoofToCreationWindow(Floor floor, long toReplace) {
/* 22711 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/* 22713 */       if (floor.getFloorState() == StructureConstants.FloorState.COMPLETED) {
/*       */         return;
/*       */       }
/*       */       try {
/* 22717 */         String name = StringUtil.format("%s %s", new Object[] { floor.getName(), "plan" });
/* 22718 */         if (floor.getFloorState() == StructureConstants.FloorState.BUILDING) {
/*       */           
/* 22720 */           RoofFloorEnum en = RoofFloorEnum.getByFloorType(floor);
/* 22721 */           if (en == RoofFloorEnum.UNKNOWN)
/*       */             return; 
/* 22723 */           name = StringUtil.format("%s %s", new Object[] { "Unfinished", StringUtil.toLowerCase(en.getName()) });
/*       */         } 
/* 22725 */         ByteBuffer bb = this.connection.getBuffer();
/* 22726 */         bb.put((byte)-46);
/* 22727 */         bb.put((byte)11);
/* 22728 */         bb.putLong(toReplace);
/* 22729 */         byte[] nameBytes = name.getBytes("UTF-8");
/*       */         
/* 22731 */         bb.putShort((short)nameBytes.length);
/* 22732 */         bb.put(nameBytes);
/* 22733 */         bb.putLong(floor.getId());
/* 22734 */         bb.putFloat(floor.getQualityLevel());
/* 22735 */         bb.putFloat(floor.getDamage());
/* 22736 */         bb.putShort((short)60);
/* 22737 */         this.connection.flush();
/*       */       }
/* 22739 */       catch (Exception ex) {
/*       */         
/* 22741 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22742 */         this.player.setLink(false);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddTileBorderToCreationWindow(long tileBorder) {
/* 22749 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 22753 */         ByteBuffer bb = this.connection.getBuffer();
/* 22754 */         bb.put((byte)-46);
/* 22755 */         bb.put((byte)7);
/* 22756 */         byte[] name = "Tile Border".getBytes("UTF-8");
/* 22757 */         bb.put((byte)name.length);
/* 22758 */         bb.put(name);
/* 22759 */         bb.putLong(tileBorder);
/* 22760 */         bb.putShort((short)60);
/* 22761 */         this.connection.flush();
/*       */       }
/* 22763 */       catch (Exception ex) {
/*       */         
/* 22765 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22766 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddBridgePartToCreationWindow(BridgePart bridgePart, long toReplace) {
/* 22773 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/* 22775 */       if (bridgePart.getBridgePartState() == BridgeConstants.BridgeState.COMPLETED) {
/*       */         return;
/*       */       }
/*       */       try {
/* 22779 */         String name = bridgePart.getFullName();
/* 22780 */         byte[] nameBytes = name.getBytes("UTF-8");
/*       */         
/* 22782 */         ByteBuffer bb = this.connection.getBuffer();
/* 22783 */         bb.put((byte)-46);
/* 22784 */         bb.put((byte)12);
/* 22785 */         bb.putLong(toReplace);
/*       */         
/* 22787 */         bb.putShort((short)nameBytes.length);
/* 22788 */         bb.put(nameBytes);
/* 22789 */         bb.putLong(bridgePart.getId());
/* 22790 */         bb.putFloat(bridgePart.getQualityLevel());
/* 22791 */         bb.putFloat(bridgePart.getDamage());
/* 22792 */         bb.putShort(BridgePartEnum.getByBridgePartType(bridgePart).getIcon());
/* 22793 */         this.connection.flush();
/*       */       }
/* 22795 */       catch (Exception ex) {
/*       */         
/* 22797 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22798 */         this.player.setLink(false);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveFromCreationWindow(long itemId) {
/* 22805 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 22809 */         ByteBuffer bb = this.connection.getBuffer();
/* 22810 */         bb.put((byte)-46);
/* 22811 */         bb.put((byte)2);
/* 22812 */         bb.putLong(itemId);
/* 22813 */         this.connection.flush();
/*       */       }
/* 22815 */       catch (Exception ex) {
/*       */         
/* 22817 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22818 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendTileBorderCreationList(long borderId, long toolId) {
/* 22825 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 22829 */         Item tool = Items.getItem(toolId);
/* 22830 */         if (tool.getTemplateId() == 62 || tool.getTemplateId() == 63 || tool
/* 22831 */           .getTemplateId() == 493)
/*       */         {
/* 22833 */           if (CreationWindowMethods.createFenceListBuffer(this.connection, borderId))
/*       */           {
/* 22835 */             this.connection.flush();
/*       */           }
/*       */         }
/* 22838 */         else if (Fence.getFlowerbedType(tool.getTemplateId()) != StructureConstantsEnum.FENCE_PLAN_WOODEN)
/*       */         {
/*       */           
/* 22841 */           if (CreationWindowMethods.createFlowerbedBuffer(this.connection, tool, borderId, this.player))
/*       */           {
/*       */             
/* 22844 */             this.connection.flush();
/*       */           }
/*       */         }
/* 22847 */         else if (tool.getTemplateId() == 266)
/*       */         {
/*       */           
/* 22850 */           if (CreationWindowMethods.createHedgeCreationBuffer(this.connection, tool, borderId, this.player))
/*       */           {
/*       */             
/* 22853 */             this.connection.flush();
/*       */           }
/*       */         }
/*       */       
/* 22857 */       } catch (NoSuchItemException nsi) {
/*       */         
/* 22859 */         logWarn("Unable to find item with id: " + toolId, (Throwable)nsi);
/*       */       }
/* 22861 */       catch (UnsupportedEncodingException uee) {
/*       */         
/* 22863 */         logWarn("Unhandled encoding", uee);
/*       */       }
/* 22865 */       catch (IOException ioe) {
/*       */         
/* 22867 */         logWarn("IO exception when sending fence creation list", ioe);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public final void sendFinishedFenceAction(long id) {
/* 22875 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 22879 */         ByteBuffer bb = this.connection.getBuffer();
/* 22880 */         bb.put((byte)-46);
/* 22881 */         bb.put((byte)9);
/* 22882 */         bb.putLong(id);
/* 22883 */         this.connection.flush();
/*       */       }
/* 22885 */       catch (Exception ex) {
/*       */         
/* 22887 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22888 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public final void sendFinishedWallAction(long id) {
/* 22895 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 22899 */         ByteBuffer bb = this.connection.getBuffer();
/* 22900 */         bb.put((byte)-46);
/* 22901 */         bb.put((byte)9);
/* 22902 */         bb.putLong(id);
/* 22903 */         this.connection.flush();
/*       */       }
/* 22905 */       catch (Exception ex) {
/*       */         
/* 22907 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22908 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public final void sendFinishedRoofFloorAction(long id) {
/* 22915 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 22919 */         ByteBuffer bb = this.connection.getBuffer();
/* 22920 */         bb.put((byte)-46);
/* 22921 */         bb.put((byte)9);
/* 22922 */         bb.putLong(id);
/* 22923 */         this.connection.flush();
/*       */       }
/* 22925 */       catch (Exception ex) {
/*       */         
/* 22927 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 22928 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private void sendRoofFloorCreationList(long targetId, long toolId) {
/* 22935 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */         
/* 22940 */         Floor floor = RoofFloorEnum.getFloorOrRoofFromId(targetId);
/* 22941 */         if (floor == null || floor.isFinished()) {
/*       */           return;
/*       */         }
/* 22944 */         Structure structure = Structures.getStructure(floor.getStructureId());
/* 22945 */         if (!structure.isFinalized()) {
/*       */           return;
/*       */         }
/* 22948 */         if (floor.getFloorState() == StructureConstants.FloorState.PLANNING) {
/*       */           List<RoofFloorEnum> list;
/* 22950 */           if (toolId == -10L)
/*       */             return; 
/* 22952 */           Item tool = Items.getItem(toolId);
/*       */ 
/*       */           
/* 22955 */           if (floor.getType() != StructureConstants.FloorType.ROOF) {
/* 22956 */             list = RoofFloorEnum.getFloorByToolAndType(tool, floor.getType());
/*       */           } else {
/* 22958 */             list = RoofFloorEnum.getRoofsByTool(tool);
/*       */           } 
/* 22960 */           String catName = LoginHandler.raiseFirstLetter(
/* 22961 */               StringUtil.format("%s%s", new Object[] { floor.getType().getName(), "s" }));
/*       */           
/* 22963 */           ByteBuffer bb = this.connection.getBuffer();
/* 22964 */           bb.put((byte)-46);
/* 22965 */           bb.put((byte)0);
/* 22966 */           bb.put((byte)0);
/* 22967 */           bb.putShort((short)1);
/*       */           
/* 22969 */           byte[] cateBytes = catName.getBytes("UTF-8");
/* 22970 */           bb.put((byte)cateBytes.length);
/* 22971 */           bb.put(cateBytes);
/* 22972 */           bb.putShort((short)list.size());
/*       */           
/* 22974 */           for (RoofFloorEnum en : list) {
/*       */             
/* 22976 */             boolean canBuild = RoofFloorEnum.canBuildFloorRoof(floor, en, (Creature)this.player);
/* 22977 */             String name = en.getName();
/* 22978 */             byte[] namebytes = name.getBytes("UTF-8");
/* 22979 */             bb.put((byte)namebytes.length);
/* 22980 */             bb.put(namebytes);
/* 22981 */             bb.putShort(en.getIcon());
/* 22982 */             short chance = (short)(canBuild ? 100 : 0);
/* 22983 */             bb.putShort(chance);
/* 22984 */             bb.putShort(en.getActionId());
/*       */           } 
/*       */           
/* 22987 */           this.connection.flush();
/*       */         }
/* 22989 */         else if (floor.getFloorState() == StructureConstants.FloorState.BUILDING) {
/*       */           
/* 22991 */           RoofFloorEnum en = RoofFloorEnum.getByFloorType(floor);
/* 22992 */           if (en == RoofFloorEnum.UNKNOWN)
/*       */             return; 
/* 22994 */           Item tool = null;
/* 22995 */           boolean hasValidTool = false;
/* 22996 */           if (toolId != -10L) {
/*       */             
/*       */             try {
/*       */               
/* 23000 */               tool = Items.getItem(toolId);
/* 23001 */               hasValidTool = en.isValidTool(tool);
/*       */             }
/* 23003 */             catch (NoSuchItemException noSuchItemException) {}
/*       */           }
/*       */ 
/*       */ 
/*       */ 
/*       */           
/* 23009 */           String neededItemsCat = "Item(s) needed in inventory";
/* 23010 */           ByteBuffer bb = this.connection.getBuffer();
/* 23011 */           bb.put((byte)-46);
/* 23012 */           bb.put((byte)0);
/* 23013 */           bb.put((byte)1);
/* 23014 */           bb.putShort((short)(hasValidTool ? 1 : 2));
/*       */           
/* 23016 */           if (!hasValidTool) {
/*       */             
/* 23018 */             String toolsCat = "Needed tool in crafting window";
/* 23019 */             byte[] toolByte = "Needed tool in crafting window".getBytes("UTF-8");
/* 23020 */             bb.put((byte)toolByte.length);
/* 23021 */             bb.put(toolByte);
/* 23022 */             int[] tools = RoofFloorEnum.getValidToolsForMaterial(en.getMaterial());
/* 23023 */             bb.putShort((short)tools.length);
/* 23024 */             for (int tid : tools) {
/*       */               
/* 23026 */               ItemTemplate template = ItemTemplateFactory.getInstance().getTemplate(tid);
/* 23027 */               String name = getFenceMaterialName(template);
/* 23028 */               byte[] namebytes = name.getBytes("UTF-8");
/* 23029 */               bb.put((byte)namebytes.length);
/* 23030 */               bb.put(namebytes);
/* 23031 */               bb.putShort(template.getImageNumber());
/* 23032 */               short chance = 1;
/* 23033 */               bb.putShort((short)1);
/* 23034 */               bb.putShort((short)169);
/*       */             } 
/*       */           } 
/*       */           
/* 23038 */           byte[] catBytes = "Item(s) needed in inventory".getBytes("UTF-8");
/* 23039 */           bb.put((byte)catBytes.length);
/* 23040 */           bb.put(catBytes);
/* 23041 */           List<BuildMaterial> needed = RoofFloorEnum.getMaterialsNeeded(floor);
/* 23042 */           bb.putShort((short)needed.size());
/* 23043 */           for (int i = 0; i < needed.size(); i++) {
/*       */             
/* 23045 */             BuildMaterial mat = needed.get(i);
/* 23046 */             ItemTemplate template = ItemTemplateFactory.getInstance().getTemplate(mat.getTemplateId());
/* 23047 */             String name = getFenceMaterialName(template);
/* 23048 */             byte[] namebytes = name.getBytes("UTF-8");
/* 23049 */             bb.put((byte)namebytes.length);
/* 23050 */             bb.put(namebytes);
/* 23051 */             bb.putShort(template.getImageNumber());
/* 23052 */             short chance = (short)mat.getNeededQuantity();
/* 23053 */             bb.putShort(chance);
/* 23054 */             bb.putShort(en.getActionId());
/*       */           } 
/*       */           
/* 23057 */           this.connection.flush();
/*       */         }
/*       */       
/* 23060 */       } catch (NoSuchItemException noSuchItemException) {
/*       */ 
/*       */       
/*       */       }
/* 23064 */       catch (Exception ex) {
/*       */         
/* 23066 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 23067 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private void sendBridgePartCreationList(long targetId, long toolId) {
/* 23074 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 23078 */         BridgePart bridgePart = BridgePartEnum.getBridgePartFromId(targetId);
/* 23079 */         if (bridgePart == null || bridgePart.isFinished()) {
/*       */           return;
/*       */         }
/* 23082 */         Structure structure = Structures.getStructure(bridgePart.getStructureId());
/* 23083 */         if (!structure.isFinalized()) {
/*       */           return;
/*       */         }
/*       */ 
/*       */         
/* 23088 */         BridgePartEnum en = BridgePartEnum.getByBridgePartType(bridgePart);
/* 23089 */         if (en == BridgePartEnum.UNKNOWN)
/*       */           return; 
/* 23091 */         Item tool = null;
/* 23092 */         boolean hasValidTool = false;
/* 23093 */         if (toolId != -10L) {
/*       */           
/*       */           try {
/*       */             
/* 23097 */             tool = Items.getItem(toolId);
/* 23098 */             hasValidTool = en.isValidTool(tool);
/*       */           }
/* 23100 */           catch (NoSuchItemException noSuchItemException) {}
/*       */         }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */         
/* 23107 */         BuildAllMaterials needed = BridgePartEnum.getMaterialsNeeded(bridgePart);
/*       */         
/* 23109 */         ByteBuffer bb = this.connection.getBuffer();
/* 23110 */         bb.put((byte)-46);
/* 23111 */         bb.put((byte)0);
/*       */ 
/*       */         
/* 23114 */         bb.put((byte)1);
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */         
/* 23120 */         short cats = (short)(needed.getStageCount() + 1);
/* 23121 */         bb.putShort(cats);
/*       */         
/* 23123 */         if (!hasValidTool) {
/*       */           
/* 23125 */           String toolsCat = "Needed tool in crafting window";
/* 23126 */           byte[] toolByte = "Needed tool in crafting window".getBytes("UTF-8");
/* 23127 */           bb.put((byte)toolByte.length);
/* 23128 */           bb.put(toolByte);
/*       */           
/* 23130 */           int[] tools = BridgePartEnum.getValidToolsForMaterial(en.getMaterial());
/*       */           
/* 23132 */           bb.putShort((short)tools.length);
/* 23133 */           for (int tid : tools)
/*       */           {
/* 23135 */             ItemTemplate template = ItemTemplateFactory.getInstance().getTemplate(tid);
/* 23136 */             String name = getFenceMaterialName(template);
/* 23137 */             byte[] namebytes = name.getBytes("UTF-8");
/* 23138 */             bb.put((byte)namebytes.length);
/* 23139 */             bb.put(namebytes);
/* 23140 */             bb.putShort(template.getImageNumber());
/* 23141 */             short chance = 1;
/* 23142 */             bb.putShort((short)1);
/* 23143 */             bb.putShort((short)169);
/*       */           }
/*       */         
/*       */         }
/*       */         else {
/*       */           
/* 23149 */           String neededItemsCat = "Item(s) needed in inventory";
/* 23150 */           byte[] catBytes = "Item(s) needed in inventory".getBytes("UTF-8");
/* 23151 */           bb.put((byte)catBytes.length);
/* 23152 */           bb.put(catBytes);
/*       */           
/* 23154 */           List<BuildMaterial> wanted = needed.getCurrentRequiredMaterials();
/* 23155 */           bb.putShort((short)wanted.size());
/* 23156 */           for (BuildMaterial mat : wanted) {
/*       */             
/* 23158 */             ItemTemplate template = ItemTemplateFactory.getInstance().getTemplate(mat.getTemplateId());
/* 23159 */             String name = getFenceMaterialName(template);
/* 23160 */             byte[] namebytes = name.getBytes("UTF-8");
/* 23161 */             bb.put((byte)namebytes.length);
/* 23162 */             bb.put(namebytes);
/* 23163 */             bb.putShort(template.getImageNumber());
/* 23164 */             short chance = 1;
/* 23165 */             bb.putShort((short)1);
/* 23166 */             bb.putShort((short)169);
/*       */           } 
/*       */         } 
/*       */         
/* 23170 */         for (BuildStageMaterials bsm : needed.getBuildStageMaterials()) {
/*       */           
/* 23172 */           byte[] catBytes = bsm.getStageName().getBytes("UTF-8");
/* 23173 */           bb.put((byte)catBytes.length);
/* 23174 */           bb.put(catBytes);
/*       */           
/* 23176 */           bb.putShort((short)bsm.getRequiredMaterials().size());
/* 23177 */           for (BuildMaterial mat : bsm.getRequiredMaterials()) {
/*       */             
/* 23179 */             ItemTemplate template = ItemTemplateFactory.getInstance().getTemplate(mat.getTemplateId());
/* 23180 */             String name = getFenceMaterialName(template);
/* 23181 */             byte[] namebytes = name.getBytes("UTF-8");
/* 23182 */             bb.put((byte)namebytes.length);
/* 23183 */             bb.put(namebytes);
/* 23184 */             bb.putShort(template.getImageNumber());
/* 23185 */             short chance = (short)mat.getNeededQuantity();
/* 23186 */             bb.putShort(chance);
/* 23187 */             bb.putShort((short)169);
/*       */           } 
/*       */         } 
/*       */         
/* 23191 */         this.connection.flush();
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/*       */       }
/* 23198 */       catch (Exception ex) {
/*       */         
/* 23200 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 23201 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private void sendWallCreationList(long wallId, long toolId) {
/* 23208 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 23212 */         Wall wall = Wall.getWall(wallId);
/* 23213 */         if (wall == null || wall.isFinished())
/*       */           return; 
/* 23215 */         Structure structure = Structures.getStructure(wall.getStructureId());
/* 23216 */         if (!structure.isFinalized()) {
/*       */           return;
/*       */         }
/* 23219 */         if (wall.getType() == StructureTypeEnum.PLAN)
/*       */         {
/*       */           
/* 23222 */           if (CreationWindowMethods.createWallPlanBuffer(this.connection, structure, wall, this.player, toolId))
/*       */           {
/*       */             
/* 23225 */             this.connection.flush();
/*       */           
/*       */           }
/*       */         
/*       */         }
/* 23230 */         else if (CreationWindowMethods.createWallBuildingBuffer(this.connection, wall, this.player, toolId))
/*       */         {
/* 23232 */           this.connection.flush();
/*       */         }
/*       */       
/*       */       }
/* 23236 */       catch (NoSuchStructureException nse) {
/*       */         
/* 23238 */         logWarn("No structure found for wall.", (Throwable)nse);
/*       */       }
/* 23240 */       catch (Exception ex) {
/*       */         
/* 23242 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 23243 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private void sendFenceCreationList(long fenceId, long toolId) {
/* 23250 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 23254 */         Fence fence = Fence.getFence(fenceId);
/* 23255 */         if (fence == null) {
/*       */           return;
/*       */         }
/*       */         
/* 23259 */         boolean hasCorrectTool = false;
/* 23260 */         if (toolId != -10L) {
/*       */           
/*       */           try {
/*       */             
/* 23264 */             Item tool = Items.getItem(toolId);
/* 23265 */             if (MethodsStructure.isCorrectToolForBuilding((Creature)this.player, tool.getTemplateId()))
/*       */             {
/* 23267 */               hasCorrectTool = true;
/*       */             }
/*       */           }
/* 23270 */           catch (NoSuchItemException noSuchItemException) {}
/*       */         }
/*       */ 
/*       */ 
/*       */ 
/*       */         
/* 23276 */         String category = "Total materials needed";
/* 23277 */         String toolCat = "Needed tool in crafting window";
/* 23278 */         String currStage = "Item(s) needed in inventory";
/*       */         
/* 23280 */         ByteBuffer bb = this.connection.getBuffer();
/* 23281 */         bb.put((byte)-46);
/* 23282 */         bb.put((byte)0);
/* 23283 */         bb.put((byte)1);
/* 23284 */         bb.putShort((short)(hasCorrectTool ? 2 : 3));
/*       */         
/* 23286 */         if (!hasCorrectTool) {
/*       */           
/* 23288 */           byte[] toolByte = "Needed tool in crafting window".getBytes("UTF-8");
/* 23289 */           bb.put((byte)toolByte.length);
/* 23290 */           bb.put(toolByte);
/* 23291 */           int[] correctTools = MethodsStructure.getCorrectToolsForBuildingFences();
/* 23292 */           bb.putShort((short)correctTools.length);
/* 23293 */           for (int i = 0; i < correctTools.length; i++) {
/*       */             
/* 23295 */             ItemTemplate template = ItemTemplateFactory.getInstance().getTemplate(correctTools[i]);
/* 23296 */             String name = getFenceMaterialName(template);
/* 23297 */             byte[] namebytes = name.getBytes("UTF-8");
/* 23298 */             bb.put((byte)namebytes.length);
/* 23299 */             bb.put(namebytes);
/* 23300 */             bb.putShort(template.getImageNumber());
/* 23301 */             short chance = 1;
/* 23302 */             bb.putShort((short)1);
/* 23303 */             bb.putShort((short)170);
/*       */           } 
/*       */         } 
/*       */         
/* 23307 */         byte[] curr = "Item(s) needed in inventory".getBytes("UTF-8");
/* 23308 */         bb.put((byte)curr.length);
/* 23309 */         bb.put(curr);
/*       */         
/* 23311 */         int[] currNeeds = Fence.getItemTemplatesNeededForFence(fence);
/* 23312 */         if (currNeeds.length == 1 && currNeeds[0] == -1) {
/* 23313 */           bb.putShort((short)0);
/*       */         } else {
/*       */           
/* 23316 */           bb.putShort((short)currNeeds.length);
/* 23317 */           for (int i = 0; i < currNeeds.length; i++) {
/*       */             
/* 23319 */             ItemTemplate template = ItemTemplateFactory.getInstance().getTemplate(currNeeds[i]);
/* 23320 */             String name = getFenceMaterialName(template);
/* 23321 */             byte[] namebytes = name.getBytes("UTF-8");
/* 23322 */             bb.put((byte)namebytes.length);
/* 23323 */             bb.put(namebytes);
/* 23324 */             bb.putShort(template.getImageNumber());
/* 23325 */             short chance = 1;
/* 23326 */             bb.putShort((short)1);
/* 23327 */             bb.putShort((short)170);
/*       */           } 
/*       */         } 
/* 23330 */         byte[] catBytes = "Total materials needed".getBytes("UTF-8");
/* 23331 */         bb.put((byte)catBytes.length);
/* 23332 */         bb.put(catBytes);
/*       */         
/* 23334 */         int[] needed = Fence.getConstructionMaterialsNeededTotal(fence);
/* 23335 */         if (needed.length == 1 && needed[0] == -1) {
/* 23336 */           bb.putShort((short)0);
/*       */         } else {
/*       */           
/* 23339 */           bb.putShort((short)(needed.length / 2));
/* 23340 */           for (int i = 0; i < needed.length; i += 2) {
/*       */             
/* 23342 */             ItemTemplate template = ItemTemplateFactory.getInstance().getTemplate(needed[i]);
/* 23343 */             String name = getFenceMaterialName(template);
/* 23344 */             byte[] namebytes = name.getBytes("UTF-8");
/* 23345 */             bb.put((byte)namebytes.length);
/* 23346 */             bb.put(namebytes);
/* 23347 */             bb.putShort(template.getImageNumber());
/* 23348 */             short chance = (short)needed[i + 1];
/* 23349 */             bb.putShort(chance);
/* 23350 */             bb.putShort((short)170);
/*       */           } 
/*       */         } 
/*       */         
/* 23354 */         this.connection.flush();
/*       */       }
/* 23356 */       catch (Exception ex) {
/*       */         
/* 23358 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 23359 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private static String getFenceMaterialName(ItemTemplate template) {
/* 23366 */     if (template.getTemplateId() == 218)
/* 23367 */       return "small iron " + template.getName(); 
/* 23368 */     if (template.getTemplateId() == 217) {
/* 23369 */       return "large iron " + template.getName();
/*       */     }
/* 23371 */     return template.getName();
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendPartialCreationList(long sourceId, long targetId) {
/* 23376 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */         
/* 23381 */         Optional<Item> optSource = Items.getItemOptional(sourceId);
/* 23382 */         if (!optSource.isPresent()) {
/*       */           return;
/*       */         }
/*       */ 
/*       */         
/* 23387 */         Item source = optSource.get();
/*       */         
/* 23389 */         Item target = null;
/*       */         
/* 23391 */         if (targetId != -10L) {
/*       */ 
/*       */           
/* 23394 */           Optional<Item> optTarget = Items.getItemOptional(targetId);
/* 23395 */           if (!optTarget.isPresent()) {
/*       */             return;
/*       */           }
/*       */           
/* 23399 */           target = optTarget.get();
/*       */         } 
/*       */         
/* 23402 */         if (targetId != -10L) {
/*       */ 
/*       */           
/* 23405 */           if (!CreationWindowMethods.createCreationListBuffer(this.connection, source, target, this.player))
/*       */           {
/*       */             return;
/*       */           }
/*       */         }
/*       */         else {
/*       */           
/* 23412 */           if (!source.isUnfinished()) {
/*       */             return;
/*       */           }
/* 23415 */           if (!CreationWindowMethods.createUnfinishedCreationListBuffer(this.connection, source, this.player)) {
/*       */             return;
/*       */           }
/*       */         } 
/*       */ 
/*       */ 
/*       */         
/* 23422 */         this.connection.flush();
/*       */       
/*       */       }
/* 23425 */       catch (Exception ex) {
/*       */         
/* 23427 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 23428 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendStopUseItem(long creatureId) {
/* 23435 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 23439 */         if (creatureId == -1L || WurmId.getType(creatureId) == 0)
/*       */         {
/* 23441 */           ByteBuffer bb = this.connection.getBuffer();
/* 23442 */           bb.put((byte)71);
/* 23443 */           bb.putLong(creatureId);
/* 23444 */           this.connection.flush();
/*       */         }
/*       */       
/* 23447 */       } catch (Exception ex) {
/*       */         
/* 23449 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 23450 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddCaveWallToCreationWindow(long caveWallId, byte type, long toReplace) {
/* 23457 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */ 
/*       */         
/* 23463 */         Tiles.Tile theTile = Tiles.getTile(type);
/* 23464 */         ByteBuffer bb = this.connection.getBuffer();
/* 23465 */         bb.put((byte)-46);
/* 23466 */         bb.put((byte)10);
/*       */         
/* 23468 */         bb.putLong(toReplace);
/* 23469 */         String name = theTile.getName();
/* 23470 */         byte[] nameBytes = name.getBytes("UTF-8");
/*       */         
/* 23472 */         bb.putShort((short)nameBytes.length);
/* 23473 */         bb.put(nameBytes);
/* 23474 */         bb.putLong(caveWallId);
/* 23475 */         bb.putFloat(-1.0F);
/* 23476 */         bb.putFloat(-1.0F);
/* 23477 */         bb.putShort((short)60);
/* 23478 */         this.connection.flush();
/*       */       }
/* 23480 */       catch (Exception ex) {
/*       */         
/* 23482 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 23483 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private void sendCaveCreationList(long caveTileId, long toolId) {
/* 23490 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */         
/* 23495 */         int tilex = Tiles.decodeTileX(caveTileId);
/* 23496 */         int tiley = Tiles.decodeTileY(caveTileId);
/*       */         
/* 23498 */         int tile = Server.caveMesh.getTile(tilex, tiley);
/* 23499 */         byte type = Tiles.decodeType(tile);
/*       */         
/* 23501 */         if (type != Tiles.Tile.TILE_CAVE_WALL_REINFORCED.id && !CaveWallBehaviour.isPartlyClad(type)) {
/*       */           return;
/*       */         }
/* 23504 */         if (type == Tiles.Tile.TILE_CAVE_WALL_REINFORCED.id)
/*       */         {
/*       */           
/* 23507 */           if (CreationWindowMethods.createCaveReinforcedBuffer(this.connection, this.player, toolId))
/*       */           {
/*       */             
/* 23510 */             this.connection.flush();
/*       */           
/*       */           }
/*       */         
/*       */         }
/* 23515 */         else if (CreationWindowMethods.createCaveCladdingBuffer(this.connection, tilex, tiley, tile, type, this.player, toolId))
/*       */         {
/* 23517 */           this.connection.flush();
/*       */         }
/*       */       
/*       */       }
/* 23521 */       catch (Exception ex) {
/*       */         
/* 23523 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 23524 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRepaint(long wurmid, byte r, byte g, byte b, byte alpha, byte paintType) {
/* 23531 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 23535 */         ByteBuffer bb = this.connection.getBuffer();
/* 23536 */         bb.put((byte)92);
/* 23537 */         bb.putLong(wurmid);
/* 23538 */         bb.put(r);
/* 23539 */         bb.put(g);
/* 23540 */         bb.put(b);
/* 23541 */         bb.put(alpha);
/* 23542 */         bb.put(paintType);
/* 23543 */         this.connection.flush();
/*       */       }
/* 23545 */       catch (Exception ex) {
/*       */         
/* 23547 */         logInfo(this.player.getName() + ':' + " wurmId " + wurmid + ' ' + ex.getMessage(), ex);
/* 23548 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendResize(long wurmid, byte xscaleMod, byte yscaleMod, byte zscaleMod) {
/* 23555 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 23559 */         ByteBuffer bb = this.connection.getBuffer();
/* 23560 */         bb.put((byte)74);
/* 23561 */         bb.putLong(wurmid);
/* 23562 */         bb.put(xscaleMod);
/* 23563 */         bb.put(yscaleMod);
/* 23564 */         bb.put(zscaleMod);
/* 23565 */         this.connection.flush();
/*       */       }
/* 23567 */       catch (Exception ex) {
/*       */         
/* 23569 */         logInfo(this.player.getName() + ':' + " wurmId " + wurmid + ' ' + ex.getMessage(), ex);
/* 23570 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendNewMovingItem(long id, String name, String model, float x, float y, float z, long onBridge, float rot, byte layer, boolean onGround, boolean floating, boolean isHoverable, byte material, byte rarity) {
/* 23580 */     sendNewMovingItem(id, name, "", model, x, y, z, onBridge, rot, layer, onGround, floating, isHoverable, material, rarity);
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendNewMovingItem(long id, String name, String hoverText, String model, float x, float y, float z, long onBridge, float rot, byte layer, boolean onGround, boolean floating, boolean isHoverable, byte material, byte rarity) {
/* 23587 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 23591 */         byte[] tempStringArr = model.getBytes("UTF-8");
/*       */ 
/*       */ 
/*       */         
/* 23595 */         ByteBuffer bb = this.connection.getBuffer();
/*       */         
/* 23597 */         bb.put((byte)108);
/*       */         
/* 23599 */         bb.putLong(id);
/* 23600 */         bb.put((byte)tempStringArr.length);
/* 23601 */         bb.put(tempStringArr);
/* 23602 */         bb.put((byte)(isHoverable ? 1 : 0));
/* 23603 */         bb.putFloat(y);
/* 23604 */         bb.putFloat(x);
/* 23605 */         bb.putLong(onBridge);
/* 23606 */         bb.putFloat(rot);
/* 23607 */         if (onGround) {
/*       */           
/* 23609 */           if (Structure.isGroundFloorAtPosition(x, y, (layer == 0)))
/*       */           {
/* 23611 */             bb.putFloat(z + 0.1F);
/*       */           }
/*       */           else
/*       */           {
/* 23615 */             bb.putFloat(-3000.0F);
/*       */           }
/*       */         
/*       */         } else {
/*       */           
/* 23620 */           bb.putFloat(z);
/*       */         } 
/*       */ 
/*       */         
/* 23624 */         tempStringArr = name.getBytes("UTF-8");
/* 23625 */         bb.put((byte)tempStringArr.length);
/* 23626 */         bb.put(tempStringArr);
/*       */ 
/*       */         
/* 23629 */         tempStringArr = hoverText.getBytes("UTF-8");
/* 23630 */         bb.put((byte)tempStringArr.length);
/* 23631 */         bb.put(tempStringArr);
/*       */         
/* 23633 */         if (floating) {
/* 23634 */           bb.put((byte)1);
/*       */         } else {
/* 23636 */           bb.put((byte)0);
/*       */         } 
/* 23638 */         bb.put(layer);
/* 23639 */         bb.put((byte)2);
/*       */         
/* 23641 */         bb.put(material);
/* 23642 */         bb.put((byte)0);
/*       */         
/* 23644 */         bb.putLong(0L);
/*       */         
/* 23646 */         bb.put((byte)0);
/*       */         
/* 23648 */         bb.put((byte)0);
/* 23649 */         bb.put(rarity);
/* 23650 */         this.connection.flush();
/* 23651 */         if (this.player.getVehicle() == id) {
/* 23652 */           this.player.getMovementScheme().resumeSpeedModifier();
/*       */         }
/* 23654 */       } catch (NullPointerException np) {
/*       */         
/* 23656 */         logWarn(this.player.getName() + ':' + " itemId: " + id + ' ' + np.getMessage(), np);
/* 23657 */         this.player.setLink(false);
/*       */       }
/* 23659 */       catch (Exception ex) {
/*       */         
/* 23661 */         logWarn(this.player.getName() + ':' + " itemId: " + id + ' ' + ex.getMessage(), ex);
/* 23662 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendMoveMovingItem(long id, float x, float y, int rot) {
/* 23669 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 23673 */         ByteBuffer bb = this.connection.getBuffer();
/*       */         
/* 23675 */         bb.put((byte)36);
/* 23676 */         bb.putLong(id);
/* 23677 */         bb.putFloat(y);
/* 23678 */         bb.putFloat(x);
/* 23679 */         bb.put((byte)rot);
/*       */         
/* 23681 */         this.connection.flush();
/*       */       }
/* 23683 */       catch (NullPointerException np) {
/*       */         
/* 23685 */         logWarn(this.player.getName() + ':' + " itemId: " + id + ' ' + np.getMessage(), np);
/* 23686 */         this.player.setLink(false);
/*       */       }
/* 23688 */       catch (Exception ex) {
/*       */         
/* 23690 */         logInfo(this.player.getName() + ':' + " itemId: " + id + ' ' + ex.getMessage(), ex);
/* 23691 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendMoveMovingItemAndSetZ(long id, float x, float y, int rot) {
/* 23698 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 23702 */         ByteBuffer bb = this.connection.getBuffer();
/*       */         
/* 23704 */         bb.put((byte)36);
/* 23705 */         bb.putLong(id);
/* 23706 */         bb.putFloat(y);
/* 23707 */         bb.putFloat(x);
/* 23708 */         bb.put((byte)rot);
/*       */         
/* 23710 */         this.connection.flush();
/*       */       }
/* 23712 */       catch (NullPointerException np) {
/*       */         
/* 23714 */         logWarn(this.player.getName() + ':' + " itemId: " + id + ' ' + np.getMessage(), np);
/* 23715 */         this.player.setLink(false);
/*       */       }
/* 23717 */       catch (Exception ex) {
/*       */         
/* 23719 */         logInfo(this.player.getName() + ':' + " itemId: " + id + ' ' + ex.getMessage(), ex);
/* 23720 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendMoveMovingItemAndSetZ(long id, float x, float y, float z, int rot) {
/* 23737 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 23741 */         ByteBuffer bb = this.connection.getBuffer();
/*       */         
/* 23743 */         bb.put((byte)72);
/*       */         
/* 23745 */         bb.putLong(id);
/* 23746 */         bb.putFloat(z);
/* 23747 */         bb.putFloat(x);
/* 23748 */         bb.put((byte)rot);
/* 23749 */         bb.putFloat(y);
/* 23750 */         this.connection.flush();
/*       */       }
/* 23752 */       catch (NullPointerException np) {
/*       */         
/* 23754 */         logWarn(this.player.getName() + ':' + " itemId: " + id + ' ' + np.getMessage(), np);
/* 23755 */         this.player.setLink(false);
/*       */       }
/* 23757 */       catch (Exception ex) {
/*       */         
/* 23759 */         logInfo(this.player.getName() + ':' + " itemId: " + id + ' ' + ex.getMessage(), ex);
/* 23760 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendMovingItemChangedLayer(long wurmid, byte newlayer) {
/* 23773 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */         
/* 23778 */         ByteBuffer bb = this.connection.getBuffer();
/* 23779 */         bb.put((byte)30);
/* 23780 */         bb.putLong(wurmid);
/* 23781 */         bb.put(newlayer);
/* 23782 */         this.connection.flush();
/*       */       }
/* 23784 */       catch (Exception ex) {
/*       */         
/* 23786 */         logInfo(this.player.getName() + ':' + " wurmId " + wurmid + ' ' + ex.getMessage(), ex);
/* 23787 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendNewFace(long wurmid, long newFace) {
/* 23800 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */         
/* 23805 */         ByteBuffer bb = this.connection.getBuffer();
/* 23806 */         bb.put((byte)52);
/* 23807 */         bb.putLong(wurmid);
/* 23808 */         bb.putLong(newFace);
/* 23809 */         this.connection.flush();
/*       */       }
/* 23811 */       catch (Exception ex) {
/*       */         
/* 23813 */         logInfo(this.player.getName() + ':' + " wurmId " + wurmid + ' ' + ex.getMessage(), ex);
/* 23814 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendCustomizeFace(long oldFace, long itemId) {
/* 23827 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 23831 */         ByteBuffer bb = this.connection.getBuffer();
/* 23832 */         bb.put((byte)2);
/* 23833 */         bb.putLong(oldFace);
/* 23834 */         bb.putLong(itemId);
/* 23835 */         this.connection.flush();
/*       */       }
/* 23837 */       catch (Exception ex) {
/*       */         
/* 23839 */         logInfo(this.player.getName() + ':' + " itemId: " + itemId + ' ' + ex.getMessage(), ex);
/* 23840 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendDeleteMovingItem(long id) {
/* 23847 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */ 
/*       */         
/* 23853 */         ByteBuffer bb = this.connection.getBuffer();
/* 23854 */         bb.put((byte)14);
/* 23855 */         bb.putLong(id);
/* 23856 */         this.connection.flush();
/*       */       }
/* 23858 */       catch (NullPointerException np) {
/*       */         
/* 23860 */         logWarn(this.player.getName() + ':' + " itemId: " + id + ' ' + np.getMessage(), np);
/* 23861 */         this.player.setLink(false);
/*       */       }
/* 23863 */       catch (Exception ex) {
/*       */         
/* 23865 */         logInfo(this.player.getName() + ':' + " itemId: " + id + ' ' + ex.getMessage(), ex);
/* 23866 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendShutDown(String reason, boolean requested) {
/* 23877 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 23881 */         ByteBuffer bb = this.connection.getBuffer();
/* 23882 */         bb.put((byte)4);
/* 23883 */         byte[] tempStringArr = reason.getBytes("UTF-8");
/* 23884 */         bb.putShort((short)tempStringArr.length);
/* 23885 */         bb.put(tempStringArr);
/* 23886 */         bb.put(requested ? 1 : 0);
/* 23887 */         this.connection.flush();
/*       */       }
/* 23889 */       catch (Exception ex) {
/*       */         
/* 23891 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 23892 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void attachCreature(long source, long target, float offx, float offy, float offz, int seatId) {
/* 23900 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */ 
/*       */         
/* 23906 */         ByteBuffer bb = this.connection.getBuffer();
/* 23907 */         bb.put((byte)111);
/* 23908 */         bb.putLong(source);
/* 23909 */         bb.putLong(target);
/* 23910 */         bb.putFloat(offx);
/* 23911 */         bb.putFloat(offy);
/* 23912 */         bb.putFloat(offz);
/* 23913 */         bb.put((byte)seatId);
/*       */         
/* 23915 */         this.connection.flush();
/*       */       }
/* 23917 */       catch (Exception ex) {
/*       */         
/* 23919 */         logInfo(this.player.getName() + ':' + " sourceId: " + source + ' ' + ex.getMessage(), ex);
/* 23920 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void setVehicleController(long playerId, long targetId, float offx, float offy, float offz, float maxDepth, float maxHeight, float maxHeightDiff, float vehicleRotation, int seatId) {
/* 23929 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 23933 */         ByteBuffer bb = this.connection.getBuffer();
/* 23934 */         bb.put((byte)63);
/* 23935 */         bb.putLong(playerId);
/* 23936 */         bb.putLong(targetId);
/* 23937 */         bb.putFloat(offx);
/* 23938 */         bb.putFloat(offy);
/* 23939 */         bb.putFloat(offz);
/* 23940 */         bb.putFloat(maxDepth);
/* 23941 */         bb.putFloat(maxHeight);
/* 23942 */         bb.putFloat(maxHeightDiff);
/* 23943 */         bb.putFloat(vehicleRotation);
/* 23944 */         bb.put((byte)seatId);
/* 23945 */         this.connection.flush();
/*       */       }
/* 23947 */       catch (Exception ex) {
/*       */         
/* 23949 */         logInfo(this.player.getName() + ':' + " targetId: " + targetId + ' ' + ex.getMessage(), ex);
/* 23950 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendAnimation(long creatureId, String animationName, boolean looping, boolean freezeAtFinish) {
/* 23958 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 23962 */         ByteBuffer bb = this.connection.getBuffer();
/* 23963 */         bb.put((byte)24);
/* 23964 */         bb.putLong(creatureId);
/*       */ 
/*       */ 
/*       */ 
/*       */         
/* 23969 */         byte[] tempStringArr = animationName.getBytes("UTF-8");
/* 23970 */         bb.put((byte)tempStringArr.length);
/* 23971 */         bb.put(tempStringArr);
/* 23972 */         if (looping) {
/* 23973 */           bb.put((byte)1);
/*       */         } else {
/* 23975 */           bb.put((byte)0);
/* 23976 */         }  if (freezeAtFinish) {
/* 23977 */           bb.put((byte)1);
/*       */         } else {
/* 23979 */           bb.put((byte)0);
/*       */         } 
/* 23981 */         this.connection.flush();
/*       */       }
/* 23983 */       catch (Exception ex) {
/*       */         
/* 23985 */         logInfo(this.player.getName() + ':' + " creatureId: " + creatureId + ' ' + ex.getMessage(), ex);
/*       */         
/* 23987 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendAnimation(long creatureId, String animationName, boolean looping, boolean freezeAtFinish, long targetId) {
/* 23995 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 23999 */         ByteBuffer bb = this.connection.getBuffer();
/* 24000 */         bb.put((byte)88);
/* 24001 */         bb.putLong(creatureId);
/*       */ 
/*       */ 
/*       */ 
/*       */         
/* 24006 */         byte[] tempStringArr = animationName.getBytes("UTF-8");
/* 24007 */         bb.put((byte)tempStringArr.length);
/* 24008 */         bb.put(tempStringArr);
/* 24009 */         if (looping) {
/* 24010 */           bb.put((byte)1);
/*       */         } else {
/* 24012 */           bb.put((byte)0);
/* 24013 */         }  if (freezeAtFinish) {
/* 24014 */           bb.put((byte)1);
/*       */         } else {
/* 24016 */           bb.put((byte)0);
/* 24017 */         }  bb.putLong(targetId);
/* 24018 */         this.connection.flush();
/*       */       }
/* 24020 */       catch (Exception ex) {
/*       */         
/* 24022 */         logInfo(this.player.getName() + ':' + " creatureId: " + creatureId + ' ' + ex.getMessage(), ex);
/*       */         
/* 24024 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendStance(long creatureId, byte stance) {
/* 24031 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24035 */         ByteBuffer bb = this.connection.getBuffer();
/* 24036 */         bb.put((byte)85);
/* 24037 */         bb.putLong(creatureId);
/* 24038 */         bb.put(stance);
/* 24039 */         this.connection.flush();
/*       */       }
/* 24041 */       catch (Exception ex) {
/*       */         
/* 24043 */         logInfo(this.player.getName() + ':' + " creatureId: " + creatureId + ' ' + ex.getMessage(), ex);
/*       */         
/* 24045 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendCombatOptions(byte[] options, short tenthsOfSeconds) {
/* 24052 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24056 */         ByteBuffer bb = this.connection.getBuffer();
/* 24057 */         bb.put((byte)98);
/* 24058 */         bb.put((byte)options.length);
/* 24059 */         bb.put(options);
/* 24060 */         bb.putShort(tenthsOfSeconds);
/* 24061 */         this.connection.flush();
/*       */       }
/* 24063 */       catch (NullPointerException np) {
/*       */         
/* 24065 */         logWarn(this.player.getName() + ':' + np.getMessage(), np);
/* 24066 */         this.player.setLink(false);
/*       */       }
/* 24068 */       catch (Exception ex) {
/*       */         
/* 24070 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 24071 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   protected void sendCombatStatus(float distanceToTarget, float footing, byte stance) {
/* 24078 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24082 */         ByteBuffer bb = this.connection.getBuffer();
/* 24083 */         bb.put((byte)-14);
/* 24084 */         bb.putFloat(distanceToTarget);
/* 24085 */         bb.putFloat(footing);
/* 24086 */         bb.put(stance);
/* 24087 */         this.connection.flush();
/*       */       }
/* 24089 */       catch (NullPointerException np) {
/*       */         
/* 24091 */         logWarn(this.player.getName() + ':' + np.getMessage(), np);
/* 24092 */         this.player.setLink(false);
/*       */       }
/* 24094 */       catch (Exception ex) {
/*       */         
/* 24096 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 24097 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   protected void sendStunned(boolean stunned) {
/* 24104 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24108 */         ByteBuffer bb = this.connection.getBuffer();
/* 24109 */         bb.put((byte)28);
/* 24110 */         if (stunned) {
/* 24111 */           bb.put((byte)1);
/*       */         } else {
/* 24113 */           bb.put((byte)0);
/* 24114 */         }  this.connection.flush();
/*       */       }
/* 24116 */       catch (Exception ex) {
/*       */         
/* 24118 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 24119 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendSpecialMove(short move, String movename) {
/* 24126 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24130 */         byte[] tempStringArr = movename.getBytes("UTF-8");
/* 24131 */         ByteBuffer bb = this.connection.getBuffer();
/* 24132 */         bb.put((byte)-17);
/* 24133 */         bb.putShort(move);
/* 24134 */         bb.put((byte)tempStringArr.length);
/* 24135 */         bb.put(tempStringArr);
/* 24136 */         this.connection.flush();
/*       */       }
/* 24138 */       catch (Exception ex) {
/*       */         
/* 24140 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 24141 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendToggleShield(boolean on) {
/* 24148 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24152 */         ByteBuffer bb = this.connection.getBuffer();
/* 24153 */         bb.put((byte)-17);
/* 24154 */         bb.putShort((short)105);
/* 24155 */         if (on) {
/* 24156 */           bb.put((byte)1);
/*       */         } else {
/* 24158 */           bb.put((byte)0);
/* 24159 */         }  this.connection.flush();
/*       */       }
/* 24161 */       catch (Exception ex) {
/*       */         
/* 24163 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 24164 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   protected void sendTarget(long id) {
/* 24171 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24175 */         ByteBuffer bb = this.connection.getBuffer();
/* 24176 */         bb.put((byte)25);
/* 24177 */         bb.putLong(id);
/* 24178 */         this.connection.flush();
/*       */       }
/* 24180 */       catch (Exception ex) {
/*       */         
/* 24182 */         logInfo(this.player.getName() + ':' + " id " + id + ' ' + ex.getMessage(), ex);
/* 24183 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   protected void sendFightStyle(byte style) {
/* 24190 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24194 */         ByteBuffer bb = this.connection.getBuffer();
/* 24195 */         bb.put((byte)26);
/* 24196 */         bb.put(style);
/* 24197 */         this.connection.flush();
/*       */       }
/* 24199 */       catch (Exception ex) {
/*       */         
/* 24201 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 24202 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void setCreatureDamage(long wurmid, float damagePercent) {
/* 24209 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24213 */         ByteBuffer bb = this.connection.getBuffer();
/* 24214 */         bb.put((byte)11);
/* 24215 */         bb.putLong(wurmid);
/* 24216 */         bb.putFloat(damagePercent);
/* 24217 */         this.connection.flush();
/*       */       }
/* 24219 */       catch (Exception ex) {
/*       */         
/* 24221 */         logInfo(this.player.getName() + ':' + " wurmId " + wurmid + ' ' + ex.getMessage(), ex);
/* 24222 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendWindImpact(byte windimpact) {
/* 24229 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24233 */         ByteBuffer bb = this.connection.getBuffer();
/* 24234 */         bb.put((byte)117);
/* 24235 */         bb.put(windimpact);
/* 24236 */         this.connection.flush();
/* 24237 */         if (this.player.getSecondsPlayed() > 120.0F && !this.player.isTeleporting() && this.player.transferCounter == 0) {
/* 24238 */           this.player.sentWind = System.currentTimeMillis();
/*       */         
/*       */         }
/*       */       
/*       */       }
/* 24243 */       catch (Exception ex) {
/*       */         
/* 24245 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 24246 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendMountSpeed(short mountSpeed) {
/* 24253 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24257 */         ByteBuffer bb = this.connection.getBuffer();
/* 24258 */         bb.put((byte)60);
/* 24259 */         bb.putShort(mountSpeed);
/* 24260 */         this.connection.flush();
/* 24261 */         if (this.player.getSecondsPlayed() > 120.0F && !this.player.isTeleporting() && this.player.transferCounter == 0) {
/* 24262 */           this.player.sentMountSpeed = System.currentTimeMillis();
/*       */         
/*       */         }
/*       */       
/*       */       }
/* 24267 */       catch (Exception ex) {
/*       */         
/* 24269 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 24270 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRotate(long itemId, float rotation) {
/* 24277 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24281 */         ByteBuffer bb = this.connection.getBuffer();
/* 24282 */         bb.put((byte)67);
/* 24283 */         bb.putLong(itemId);
/* 24284 */         bb.putFloat(rotation);
/* 24285 */         this.connection.flush();
/*       */       }
/* 24287 */       catch (Exception ex) {
/*       */         
/* 24289 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 24290 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAck(float xpos, float ypos) {
/* 24297 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24301 */         ByteBuffer bb = this.connection.getBuffer();
/* 24302 */         bb.put((byte)3);
/* 24303 */         bb.putFloat(xpos);
/* 24304 */         bb.putFloat(ypos);
/* 24305 */         this.connection.flush();
/*       */       }
/* 24307 */       catch (Exception ex) {
/*       */         
/* 24309 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 24310 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddSpellEffect(SpellEffectsEnum effect, int duration, float power) {
/* 24317 */     sendAddStatusEffect(effect, duration);
/* 24318 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24322 */         ByteBuffer bb = this.connection.getBuffer();
/* 24323 */         bb.put((byte)7);
/* 24324 */         bb.putLong(effect.getId());
/* 24325 */         byte[] tempStringArr = effect.getName().getBytes("UTF-8");
/* 24326 */         bb.put((byte)tempStringArr.length);
/* 24327 */         bb.put(tempStringArr);
/* 24328 */         bb.put((byte)0);
/* 24329 */         bb.put(effect.getEffectType());
/* 24330 */         bb.put(effect.getInfluence());
/* 24331 */         bb.putInt(duration);
/* 24332 */         bb.putFloat(power);
/* 24333 */         this.connection.flush();
/*       */       }
/* 24335 */       catch (Exception ex) {
/*       */         
/* 24337 */         logInfo(this.player.getName() + ':' + " id " + effect.getId() + ' ' + ex.getMessage(), ex);
/* 24338 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddSpellEffect(long id, SpellEffectsEnum effect, int duration, float power) {
/* 24345 */     sendAddStatusEffect(id, effect, duration);
/* 24346 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24350 */         ByteBuffer bb = this.connection.getBuffer();
/* 24351 */         bb.put((byte)7);
/* 24352 */         bb.putLong(id);
/* 24353 */         byte[] tempStringArr = effect.getName().getBytes("UTF-8");
/* 24354 */         bb.put((byte)tempStringArr.length);
/* 24355 */         bb.put(tempStringArr);
/* 24356 */         bb.put((byte)0);
/* 24357 */         bb.put(effect.getEffectType());
/* 24358 */         bb.put(effect.getInfluence());
/* 24359 */         bb.putInt(duration);
/* 24360 */         bb.putFloat(power);
/* 24361 */         this.connection.flush();
/*       */       }
/* 24363 */       catch (Exception ex) {
/*       */         
/* 24365 */         logInfo(this.player.getName() + ':' + " id " + effect.getId() + ' ' + ex.getMessage(), ex);
/* 24366 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendAddSpellEffect(long id, String name, byte type, byte effectType, byte influence, int duration, float power) {
/* 24375 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24379 */         ByteBuffer bb = this.connection.getBuffer();
/* 24380 */         bb.put((byte)7);
/* 24381 */         bb.putLong(id);
/* 24382 */         byte[] tempStringArr = name.getBytes("UTF-8");
/* 24383 */         bb.put((byte)tempStringArr.length);
/* 24384 */         bb.put(tempStringArr);
/* 24385 */         bb.put(type);
/* 24386 */         bb.put(effectType);
/* 24387 */         bb.put(influence);
/* 24388 */         bb.putInt(duration);
/* 24389 */         bb.putFloat(power);
/* 24390 */         this.connection.flush();
/*       */       }
/* 24392 */       catch (Exception ex) {
/*       */         
/* 24394 */         logInfo(this.player.getName() + ':' + " id " + id + ' ' + ex.getMessage(), ex);
/* 24395 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddStatusEffect(long id, SpellEffectsEnum effect, int duration, String name) {
/* 24402 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24406 */         ByteBuffer bb = this.connection.getBuffer();
/* 24407 */         bb.put((byte)-47);
/* 24408 */         bb.put((byte)0);
/* 24409 */         bb.putLong(id);
/* 24410 */         bb.putInt(effect.getTypeId());
/* 24411 */         bb.putInt(effect.isSendDuration() ? duration : -1);
/* 24412 */         sendByteStringLength(name, bb);
/* 24413 */         this.connection.flush();
/*       */       }
/* 24415 */       catch (Exception ex) {
/*       */         
/* 24417 */         logInfo(this.player.getName() + ':' + " id " + effect.getId() + ' ' + ex.getMessage(), ex);
/* 24418 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddStatusEffect(long id, SpellEffectsEnum effect, int duration) {
/* 24425 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24429 */         ByteBuffer bb = this.connection.getBuffer();
/* 24430 */         bb.put((byte)-47);
/* 24431 */         bb.put((byte)0);
/* 24432 */         bb.putLong(id);
/* 24433 */         bb.putInt(effect.getTypeId());
/* 24434 */         bb.putInt(effect.isSendDuration() ? duration : -1);
/* 24435 */         this.connection.flush();
/*       */       }
/* 24437 */       catch (Exception ex) {
/*       */         
/* 24439 */         logInfo(this.player.getName() + ':' + " id " + effect.getId() + ' ' + ex.getMessage(), ex);
/* 24440 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddStatusEffect(SpellEffectsEnum effect, int duration, String name) {
/* 24447 */     if (!effect.isSendToBuffBar())
/*       */       return; 
/* 24449 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24453 */         ByteBuffer bb = this.connection.getBuffer();
/* 24454 */         bb.put((byte)-47);
/* 24455 */         bb.put((byte)0);
/* 24456 */         bb.putLong(effect.getId());
/* 24457 */         bb.putInt(effect.getTypeId());
/* 24458 */         bb.putInt(effect.isSendDuration() ? duration : -1);
/* 24459 */         sendByteStringLength(name, bb);
/* 24460 */         this.connection.flush();
/*       */       }
/* 24462 */       catch (Exception ex) {
/*       */         
/* 24464 */         logInfo(this.player.getName() + ':' + " id " + effect.getId() + ' ' + ex.getMessage(), ex);
/* 24465 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAddStatusEffect(SpellEffectsEnum effect, int duration) {
/* 24472 */     if (!effect.isSendToBuffBar())
/*       */       return; 
/* 24474 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24478 */         ByteBuffer bb = this.connection.getBuffer();
/* 24479 */         bb.put((byte)-47);
/* 24480 */         bb.put((byte)0);
/* 24481 */         bb.putLong(effect.getId());
/* 24482 */         bb.putInt(effect.getTypeId());
/* 24483 */         bb.putInt(effect.isSendDuration() ? duration : -1);
/* 24484 */         this.connection.flush();
/*       */       }
/* 24486 */       catch (Exception ex) {
/*       */         
/* 24488 */         logInfo(this.player.getName() + ':' + " id " + effect.getId() + ' ' + ex.getMessage(), ex);
/* 24489 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveFromStatusEffectBar(long id) {
/* 24496 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24500 */         ByteBuffer bb = this.connection.getBuffer();
/* 24501 */         bb.put((byte)-47);
/* 24502 */         bb.put((byte)1);
/* 24503 */         bb.putLong(id);
/* 24504 */         this.connection.flush();
/*       */       }
/* 24506 */       catch (Exception ex) {
/*       */         
/* 24508 */         logInfo(this.player.getName() + ':' + " id " + id + ' ' + ex.getMessage(), ex);
/* 24509 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private void sendAvailServer(byte direction, boolean avail) {
/* 24516 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24520 */         ByteBuffer bb = this.connection.getBuffer();
/* 24521 */         bb.put((byte)59);
/* 24522 */         bb.put(direction);
/* 24523 */         bb.put(avail ? 1 : 0);
/* 24524 */         this.connection.flush();
/*       */       }
/* 24526 */       catch (Exception ex) {
/*       */         
/* 24528 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 24529 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendRemoveSpellEffect(long id, SpellEffectsEnum spellEffect) {
/* 24556 */     if (spellEffect != null && spellEffect.isSendToBuffBar())
/* 24557 */       sendRemoveFromStatusEffectBar(id); 
/* 24558 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24562 */         ByteBuffer bb = this.connection.getBuffer();
/* 24563 */         bb.put((byte)17);
/* 24564 */         bb.putLong(id);
/* 24565 */         this.connection.flush();
/*       */       }
/* 24567 */       catch (Exception ex) {
/*       */         
/* 24569 */         logInfo(this.player.getName() + ':' + " id " + id + ' ' + ex.getMessage(), ex);
/* 24570 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendRemoveSpellEffect(SpellEffectsEnum effect) {
/* 24578 */     if (effect == null) {
/*       */       return;
/*       */     }
/* 24581 */     if (effect.isSendToBuffBar())
/* 24582 */       sendRemoveFromStatusEffectBar(effect.getId()); 
/* 24583 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24587 */         ByteBuffer bb = this.connection.getBuffer();
/* 24588 */         bb.put((byte)17);
/* 24589 */         bb.putLong(effect.getId());
/* 24590 */         this.connection.flush();
/*       */       }
/* 24592 */       catch (Exception ex) {
/*       */         
/* 24594 */         logInfo(this.player.getName() + ':' + " id " + effect.getId() + ' ' + ex.getMessage(), ex);
/* 24595 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendFocusLevel(long targetId) {
/* 24614 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24618 */         ByteBuffer bb = this.connection.getBuffer();
/* 24619 */         bb.put((byte)50);
/* 24620 */         bb.put(this.player.getFightlevel());
/* 24621 */         bb.putLong(targetId);
/* 24622 */         byte[] descStringArr = this.player.getFightlevelString().getBytes("UTF-8");
/* 24623 */         bb.put((byte)descStringArr.length);
/* 24624 */         bb.put(descStringArr);
/* 24625 */         this.connection.flush();
/*       */       }
/* 24627 */       catch (Exception ex) {
/*       */         
/* 24629 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 24630 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendAddAreaSpellEffect(int tilex, int tiley, int layer, byte type, int floorLevel, int heightOffset, boolean loop) {
/* 24638 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24642 */         ByteBuffer bb = this.connection.getBuffer();
/* 24643 */         bb.put((byte)-4);
/* 24644 */         bb.putShort((short)tilex);
/* 24645 */         bb.putShort((short)tiley);
/* 24646 */         bb.put((byte)layer);
/* 24647 */         bb.put(type);
/* 24648 */         bb.putShort((short)heightOffset);
/* 24649 */         bb.put(loop ? 1 : 0);
/* 24650 */         bb.put((byte)floorLevel);
/* 24651 */         this.connection.flush();
/*       */       }
/* 24653 */       catch (Exception ex) {
/*       */         
/* 24655 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 24656 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveAreaSpellEffect(int tilex, int tiley, int layer) {
/* 24663 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24667 */         ByteBuffer bb = this.connection.getBuffer();
/* 24668 */         bb.put((byte)-5);
/* 24669 */         bb.putShort((short)tilex);
/* 24670 */         bb.putShort((short)tiley);
/* 24671 */         bb.put((byte)layer);
/* 24672 */         this.connection.flush();
/*       */       }
/* 24674 */       catch (Exception ex) {
/*       */         
/* 24676 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 24677 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendMissionState(long wurmId, String name, String description, String creator, float state, long start, long endDate, long expires, boolean restartable, byte difficulty, String rewards) {
/* 24686 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */ 
/*       */ 
/*       */         
/* 24692 */         ByteBuffer bb = this.connection.getBuffer();
/* 24693 */         bb.put((byte)33);
/* 24694 */         bb.putLong(wurmId);
/*       */         
/* 24696 */         byte[] nameStringArr = name.getBytes("UTF-8");
/* 24697 */         bb.put((byte)nameStringArr.length);
/* 24698 */         bb.put(nameStringArr);
/*       */         
/* 24700 */         byte[] descStringArr = description.getBytes("UTF-8");
/* 24701 */         bb.putShort((short)descStringArr.length);
/* 24702 */         bb.put(descStringArr);
/*       */         
/* 24704 */         byte[] creStringArr = creator.getBytes("UTF-8");
/* 24705 */         bb.put((byte)creStringArr.length);
/* 24706 */         bb.put(creStringArr);
/*       */         
/* 24708 */         bb.putLong(start);
/*       */         
/* 24710 */         bb.putLong(endDate);
/*       */ 
/*       */         
/* 24713 */         bb.putLong(expires);
/* 24714 */         bb.put((byte)(restartable ? 1 : 0));
/* 24715 */         bb.putFloat(state);
/* 24716 */         bb.put(difficulty);
/* 24717 */         byte[] rewardsStringArr = rewards.getBytes("UTF-8");
/* 24718 */         bb.putShort((short)rewardsStringArr.length);
/* 24719 */         bb.put(rewardsStringArr);
/*       */         
/* 24721 */         this.connection.flush();
/*       */       }
/* 24723 */       catch (Exception ex) {
/*       */         
/* 24725 */         logInfo(this.player.getName() + ':' + " wurmId " + wurmId + ' ' + ex.getMessage(), ex);
/* 24726 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveMissionState(long wurmId) {
/* 24733 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24737 */         ByteBuffer bb = this.connection.getBuffer();
/* 24738 */         bb.put((byte)113);
/* 24739 */         bb.putLong(wurmId);
/* 24740 */         this.connection.flush();
/*       */       }
/* 24742 */       catch (Exception ex) {
/*       */         
/* 24744 */         logInfo(this.player.getName() + ':' + " wurmId " + wurmId + ' ' + ex.getMessage(), ex);
/* 24745 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendDamageState(long wurmid, byte damage) {
/* 24752 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24756 */         ByteBuffer bb = this.connection.getBuffer();
/* 24757 */         bb.put((byte)22);
/*       */         
/* 24759 */         bb.putLong(wurmid);
/* 24760 */         bb.put(damage);
/* 24761 */         this.connection.flush();
/*       */       }
/* 24763 */       catch (Exception ex) {
/*       */         
/* 24765 */         logInfo(this.player.getName() + ':' + " wurmId " + wurmid + ' ' + ex.getMessage(), ex);
/* 24766 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendNewProjectile(long id, byte type, String modelName, String name, byte material, Vector3f startingPosition, Vector3f startingVelocity, Vector3f endingPosition, float rotation, boolean surface) {
/* 24774 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24778 */         ByteBuffer bb = this.connection.getBuffer();
/* 24779 */         bb.put((byte)35);
/* 24780 */         bb.put((byte)-1);
/*       */         
/* 24782 */         bb.put(type);
/* 24783 */         byte[] modelStringArr = modelName.getBytes("UTF-8");
/* 24784 */         bb.put((byte)modelStringArr.length);
/* 24785 */         bb.put(modelStringArr);
/*       */         
/* 24787 */         byte[] nStringArr = name.getBytes("UTF-8");
/* 24788 */         bb.put((byte)nStringArr.length);
/* 24789 */         bb.put(nStringArr);
/* 24790 */         bb.putLong(id);
/* 24791 */         bb.put(material);
/*       */         
/* 24793 */         bb.putFloat(startingPosition.x);
/* 24794 */         bb.putFloat(startingPosition.y);
/* 24795 */         bb.putFloat(startingPosition.z);
/*       */         
/* 24797 */         bb.putFloat(startingVelocity.x);
/* 24798 */         bb.putFloat(startingVelocity.y);
/* 24799 */         bb.putFloat(startingVelocity.z);
/*       */         
/* 24801 */         bb.putFloat(endingPosition.x);
/* 24802 */         bb.putFloat(endingPosition.y);
/* 24803 */         bb.putFloat(endingPosition.z);
/*       */         
/* 24805 */         bb.putFloat(rotation);
/* 24806 */         bb.put(surface ? 0 : -1);
/* 24807 */         this.connection.flush();
/*       */       }
/* 24809 */       catch (Exception ex) {
/*       */         
/* 24811 */         logInfo(this.player.getName() + ':' + " id " + id + ' ' + ex.getMessage(), ex);
/* 24812 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendProjectile(long id, byte type, String modelName, String name, byte material, float startX, float startY, float startH, float rot, byte layer, float endX, float endY, float endH, long sourceId, long targetId, float projectedSecondsInAir, float actualSecondsInAir) {
/* 24822 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24826 */         ByteBuffer bb = this.connection.getBuffer();
/* 24827 */         bb.put((byte)35);
/* 24828 */         bb.put(type);
/*       */         
/* 24830 */         byte[] modelStringArr = modelName.getBytes("UTF-8");
/* 24831 */         bb.put((byte)modelStringArr.length);
/* 24832 */         bb.put(modelStringArr);
/*       */         
/* 24834 */         byte[] nStringArr = name.getBytes("UTF-8");
/* 24835 */         bb.put((byte)nStringArr.length);
/* 24836 */         bb.put(nStringArr);
/* 24837 */         bb.putLong(id);
/* 24838 */         bb.put(material);
/* 24839 */         bb.putFloat(startX);
/* 24840 */         bb.putFloat(startY);
/* 24841 */         bb.putFloat(startH);
/* 24842 */         bb.putFloat(rot);
/* 24843 */         bb.put(layer);
/* 24844 */         bb.putFloat(endX);
/* 24845 */         bb.putFloat(endY);
/* 24846 */         bb.putFloat(endH);
/* 24847 */         bb.putLong(sourceId);
/* 24848 */         bb.putLong(targetId);
/* 24849 */         bb.putFloat(projectedSecondsInAir);
/* 24850 */         bb.putFloat(actualSecondsInAir);
/* 24851 */         this.connection.flush();
/*       */       }
/* 24853 */       catch (Exception ex) {
/*       */         
/* 24855 */         logInfo(this.player.getName() + ':' + " id " + id + ' ' + ex.getMessage(), ex);
/* 24856 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendPlonk(short plonkId) {
/* 24863 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24867 */         ByteBuffer bb = this.connection.getBuffer();
/* 24868 */         bb.put((byte)-49);
/* 24869 */         bb.putShort(plonkId);
/* 24870 */         this.connection.flush();
/*       */       }
/* 24872 */       catch (Exception ex) {
/*       */         
/* 24874 */         logWarn("Failed to send plonk: " + plonkId + " to player: " + this.player.getName(), ex);
/* 24875 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendWallDamageState(long houseId, long wurmid, byte damage) {
/* 24882 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24886 */         ByteBuffer bb = this.connection.getBuffer();
/* 24887 */         bb.put((byte)34);
/* 24888 */         bb.putLong(houseId);
/* 24889 */         bb.putLong(wurmid);
/* 24890 */         bb.put(damage);
/* 24891 */         this.connection.flush();
/*       */       }
/* 24893 */       catch (Exception ex) {
/*       */         
/* 24895 */         logInfo(this.player.getName() + ':' + " wurmId " + wurmid + ' ' + ex.getMessage(), ex);
/* 24896 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendItemTemplateList(int itemId, String modelName) {
/* 24903 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24907 */         ByteBuffer bb = this.connection.getBuffer();
/* 24908 */         bb.put((byte)78);
/* 24909 */         bb.putInt(itemId);
/*       */         
/* 24911 */         byte[] modelNameStringArr = modelName.getBytes("UTF-8");
/* 24912 */         bb.put((byte)modelNameStringArr.length);
/* 24913 */         bb.put(modelNameStringArr);
/* 24914 */         this.connection.flush();
/*       */       }
/* 24916 */       catch (Exception ex) {
/*       */         
/* 24918 */         logInfo(this.player.getName() + ':' + " itemId " + itemId + ' ' + ex.getMessage(), ex);
/* 24919 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendHorseWear(long wurmId, int itemId, byte material, byte slot, byte aux_data) {
/* 24926 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24930 */         ByteBuffer bb = this.connection.getBuffer();
/* 24931 */         bb.put((byte)-31);
/* 24932 */         bb.putLong(wurmId);
/* 24933 */         bb.putInt(itemId);
/* 24934 */         bb.put(material);
/* 24935 */         bb.put(slot);
/* 24936 */         bb.put(aux_data);
/* 24937 */         this.connection.flush();
/*       */       }
/* 24939 */       catch (Exception ex) {
/*       */         
/* 24941 */         logInfo(this.player.getName() + ':' + " wurmId " + wurmId + ' ' + ex.getMessage(), ex);
/* 24942 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveHorseWear(long wurmId, int itemId, byte slot) {
/* 24949 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 24953 */         ByteBuffer bb = this.connection.getBuffer();
/* 24954 */         bb.put((byte)55);
/* 24955 */         bb.putLong(wurmId);
/* 24956 */         bb.putInt(itemId);
/* 24957 */         bb.put(slot);
/* 24958 */         this.connection.flush();
/*       */       }
/* 24960 */       catch (Exception ex) {
/*       */         
/* 24962 */         logInfo(this.player.getName() + ':' + " wurmId " + wurmId + ' ' + ex.getMessage(), ex);
/* 24963 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendWearItem(long wurmId, int itemId, byte bodyPart, float red, float green, float blue, float secondaryRed, float secondaryGreen, float secondaryBlue, byte material, byte rarity) {
/* 24998 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 25002 */         ByteBuffer bb = this.connection.getBuffer();
/* 25003 */         bb.put((byte)21);
/* 25004 */         bb.putLong(wurmId);
/* 25005 */         bb.putInt(itemId);
/* 25006 */         bb.put(bodyPart);
/* 25007 */         bb.put((byte)1);
/* 25008 */         bb.putFloat(red);
/* 25009 */         bb.putFloat(green);
/* 25010 */         bb.putFloat(blue);
/* 25011 */         bb.putFloat(secondaryRed);
/* 25012 */         bb.putFloat(secondaryGreen);
/* 25013 */         bb.putFloat(secondaryBlue);
/* 25014 */         bb.put(material);
/* 25015 */         bb.put(rarity);
/* 25016 */         this.connection.flush();
/*       */ 
/*       */ 
/*       */       
/*       */       }
/* 25021 */       catch (Exception ex) {
/*       */         
/* 25023 */         logInfo(this.player.getName() + ':' + " wurmId " + wurmId + ' ' + ex.getMessage(), ex);
/* 25024 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendRemoveWearItem(long wurmId, byte bodyPart) {
/* 25031 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 25035 */         ByteBuffer bb = this.connection.getBuffer();
/* 25036 */         bb.put((byte)27);
/* 25037 */         bb.putLong(wurmId);
/* 25038 */         bb.put(bodyPart);
/* 25039 */         this.connection.flush();
/*       */       }
/* 25041 */       catch (Exception ex) {
/*       */         
/* 25043 */         logInfo(this.player.getName() + ':' + " wurmId " + wurmId + ' ' + ex.getMessage(), ex);
/* 25044 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendHasTarget(long wurmId, boolean hasTarget) {
/* 25051 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 25055 */         ByteBuffer bb = this.connection.getBuffer();
/* 25056 */         bb.put((byte)53);
/* 25057 */         bb.putLong(wurmId);
/* 25058 */         bb.put((byte)(hasTarget ? 1 : 0));
/* 25059 */         this.connection.flush();
/*       */       }
/* 25061 */       catch (Exception ex) {
/*       */         
/* 25063 */         logInfo(this.player.getName() + ':' + " wurmId " + wurmId + ' ' + ex.getMessage(), ex);
/* 25064 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public final Player getPlayer() {
/* 25078 */     return this.player;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public final void setPlayer(Player aPlayer) {
/* 25091 */     this.player = aPlayer;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public final PlayerMove getCurrentmove() {
/* 25101 */     return this.currentmove;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public final void setAvailableMoves(int aAvailableMoves) {
/* 25112 */     this.availableMoves = aAvailableMoves;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public final int getMoves() {
/* 25122 */     return this.moves;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   protected final void setMoves(int aMoves) {
/* 25133 */     this.moves = aMoves;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   final boolean hasReceivedTicks() {
/* 25143 */     return this.receivedTicks;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public static int getNumcommands() {
/* 25153 */     return numcommands;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public static int getPrevcommand() {
/* 25163 */     return prevcommand;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public static int getLastcommand() {
/* 25173 */     return lastcommand;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public static long getCommandAction() {
/* 25183 */     return commandAction;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public static String getCommandMessage() {
/* 25193 */     return commandMessage;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public final boolean isInvulnerable() {
/* 25203 */     return this.invulnerable;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public String toString() {
/* 25212 */     return "Communicator [Player: " + this.player + ", Conn: " + this.connection + ']';
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendRemoveWall(long structureId, Wall wall) {
/* 25221 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 25225 */         ByteBuffer bb = this.connection.getBuffer();
/* 25226 */         bb.put((byte)54);
/* 25227 */         bb.putLong(structureId);
/* 25228 */         bb.putShort((short)Math.min(wall.getStartX(), wall.getEndX()));
/* 25229 */         bb.putShort((short)Math.min(wall.getStartY(), wall.getEndY()));
/* 25230 */         bb.putShort((short)wall.getHeight());
/* 25231 */         if (wall.isHorizontal()) {
/* 25232 */           bb.put((byte)0);
/*       */         } else {
/* 25234 */           bb.put((byte)1);
/* 25235 */         }  bb.put(wall.getLayer());
/* 25236 */         this.connection.flush();
/*       */       }
/* 25238 */       catch (Exception ex) {
/*       */         
/* 25240 */         logInfo(this.player.getName() + ':' + " structureId: " + structureId + ' ' + ex.getMessage(), ex);
/* 25241 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void setGroundOffset(int offset, boolean immediately) {
/* 25248 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 25252 */         ByteBuffer bb = this.connection.getBuffer();
/* 25253 */         bb.put((byte)94);
/* 25254 */         bb.putInt(offset);
/* 25255 */         bb.put(immediately ? 1 : 0);
/* 25256 */         this.connection.flush();
/*       */       }
/* 25258 */       catch (Exception ex) {
/*       */         
/* 25260 */         logInfo(this.player.getName() + ':' + " offset " + offset + ' ' + ex.getMessage(), ex);
/* 25261 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAchievementList(Achievement[] achievements) {
/* 25268 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 25272 */         int visible = 0;
/* 25273 */         for (int x = 0; x < achievements.length; x++) {
/* 25274 */           if (!achievements[x].isInVisible())
/* 25275 */             visible++; 
/* 25276 */         }  ByteBuffer bb = this.connection.getBuffer();
/* 25277 */         bb.put((byte)100);
/* 25278 */         bb.putInt(visible);
/* 25279 */         for (int i = 0; i < achievements.length; i++) {
/*       */           
/* 25281 */           if (!achievements[i].isInVisible()) {
/*       */             
/* 25283 */             AchievementTemplate template = achievements[i].getTemplate();
/* 25284 */             bb.putInt(achievements[i].getAchievement());
/*       */             
/* 25286 */             byte[] aNameStringArr = template.getName().getBytes("UTF-8");
/* 25287 */             bb.put((byte)aNameStringArr.length);
/* 25288 */             bb.put(aNameStringArr);
/*       */             
/* 25290 */             String adesc = template.getDescription();
/*       */             
/* 25292 */             adesc = adesc.replace("COUNTER", "[" + achievements[i].getCounter() + "]");
/* 25293 */             byte[] aDescStringArr = adesc.getBytes("UTF-8");
/* 25294 */             bb.put((byte)aDescStringArr.length);
/* 25295 */             bb.put(aDescStringArr);
/*       */             
/* 25297 */             bb.put(template.getType());
/* 25298 */             bb.putLong(achievements[i].getDateAchieved().getTime());
/* 25299 */             bb.putInt(achievements[i].getCounter());
/*       */           } 
/*       */         } 
/* 25302 */         this.connection.flush();
/*       */       }
/* 25304 */       catch (Exception ex) {
/*       */         
/* 25306 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 25307 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendAchievement(Achievement achievement, boolean isNew) {
/* 25314 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 25318 */         ByteBuffer bb = this.connection.getBuffer();
/* 25319 */         bb.put((byte)38);
/* 25320 */         bb.put((byte)(isNew ? 1 : 0));
/* 25321 */         bb.put((byte)(achievement.isPlaySoundOnUpdate() ? 1 : 0));
/* 25322 */         bb.putInt(achievement.getAchievement());
/* 25323 */         AchievementTemplate template = achievement.getTemplate();
/* 25324 */         byte[] aNameStringArr = template.getName().getBytes("UTF-8");
/* 25325 */         bb.put((byte)aNameStringArr.length);
/* 25326 */         bb.put(aNameStringArr);
/*       */         
/* 25328 */         String adesc = template.getDescription();
/*       */         
/* 25330 */         adesc.replace("COUNTER", "[" + achievement.getCounter() + "]");
/* 25331 */         byte[] aDescStringArr = adesc.getBytes("UTF-8");
/* 25332 */         bb.put((byte)aDescStringArr.length);
/* 25333 */         bb.put(aDescStringArr);
/*       */         
/* 25335 */         bb.put(template.getType());
/* 25336 */         bb.putLong(achievement.getDateAchieved().getTime());
/* 25337 */         bb.putInt(achievement.getCounter());
/* 25338 */         this.connection.flush();
/*       */       }
/* 25340 */       catch (Exception ex) {
/*       */         
/* 25342 */         logInfo(this.player.getName() + ':' + " achievement: " + achievement + ' ' + ex.getMessage(), ex);
/* 25343 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private void sendRecipeNameList(Recipe[] recipes) {
/* 25350 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/* 25352 */       int chunk = 1;
/*       */       
/*       */       try {
/* 25355 */         ByteBuffer bb = this.connection.getBuffer();
/* 25356 */         bb.put((byte)-55);
/* 25357 */         bb.put((byte)0);
/* 25358 */         bb.put((byte)chunk);
/* 25359 */         bb.putShort((short)recipes.length);
/*       */         
/* 25361 */         for (Recipe localRecipe : recipes) {
/*       */           
/* 25363 */           Recipe recipe = localRecipe;
/* 25364 */           if (this.player.getPower() == 5) {
/*       */ 
/*       */             
/* 25367 */             Recipe playerRecipe = RecipesByPlayer.getPlayerKnownRecipeOrNull(this.player.getWurmId(), recipe.getRecipeId());
/* 25368 */             if (playerRecipe != null)
/* 25369 */               recipe = playerRecipe; 
/*       */           } 
/* 25371 */           Ingredient i = recipe.getResultItem();
/* 25372 */           if (i == null) {
/* 25373 */             logger.warning("Result item missing for " + recipe.getName() + " (" + recipe.getRecipeId() + ")");
/*       */           } else {
/*       */             
/* 25376 */             bb.putShort(recipe.getRecipeId());
/* 25377 */             sendByteStringLength(recipe.getName(), bb);
/*       */             
/* 25379 */             if (this.player.getPower() == 5) {
/* 25380 */               bb.put((byte)1);
/*       */             } else {
/* 25382 */               bb.put(RecipesByPlayer.isKnownRecipe(this.player.getWurmId(), recipe.getRecipeId()) ? 1 : 0);
/* 25383 */             }  bb.put(recipe.getRecipeColourCode(this.player.getWurmId()));
/* 25384 */             bb.putShort(i.getIcon());
/* 25385 */             bb.put(recipe.isLootable() ? 1 : 0);
/* 25386 */             bb.put(RecipesByPlayer.isFavourite(this.player.getWurmId(), recipe.getRecipeId()) ? 1 : 0);
/* 25387 */             sendByteStringLength(RecipesByPlayer.getNotes(this.player.getWurmId(), recipe.getRecipeId()), bb);
/*       */           } 
/*       */         } 
/* 25390 */         for (Recipe localRecipe : recipes) {
/*       */           
/* 25392 */           Recipe recipe = localRecipe;
/* 25393 */           if (this.player.getPower() == 5) {
/*       */ 
/*       */             
/* 25396 */             Recipe playerRecipe = RecipesByPlayer.getPlayerKnownRecipeOrNull(this.player.getWurmId(), recipe.getRecipeId());
/* 25397 */             if (playerRecipe != null)
/* 25398 */               recipe = playerRecipe; 
/*       */           } 
/* 25400 */           ByteBuffer bbc = ByteBuffer.allocate(65534);
/* 25401 */           sendCookbookRecipe(recipe, bbc);
/*       */ 
/*       */           
/* 25404 */           bbc.flip();
/* 25405 */           byte[] bytes = new byte[bbc.remaining()];
/* 25406 */           bbc.get(bytes);
/*       */           
/* 25408 */           if (bb.remaining() - 10 <= bytes.length) {
/*       */ 
/*       */             
/* 25411 */             this.connection.flush();
/* 25412 */             bb = this.connection.getBuffer();
/* 25413 */             bb.put((byte)-55);
/* 25414 */             bb.put((byte)0);
/* 25415 */             bb.put((byte)++chunk);
/*       */           } 
/* 25417 */           bb.put(bytes);
/*       */         } 
/* 25419 */         this.connection.flush();
/*       */       }
/* 25421 */       catch (Exception ex) {
/*       */         
/* 25423 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 25424 */         this.player.setLink(false);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendCookbookRecipe(Recipe recipe) {
/* 25436 */     if (this.player != null && this.player.hasLink() && recipe != null) {
/*       */       
/*       */       try {
/*       */         
/* 25440 */         ByteBuffer bb = this.connection.getBuffer();
/* 25441 */         bb.put((byte)-55);
/* 25442 */         bb.put((byte)1);
/* 25443 */         sendCookbookRecipe(recipe, bb);
/* 25444 */         this.connection.flush();
/*       */       }
/* 25446 */       catch (Exception ex) {
/*       */         
/* 25448 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 25449 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendCookbookRecipe(Recipe recipe, ByteBuffer bb) throws Exception {
/* 25462 */     bb.putShort(recipe.getRecipeId());
/* 25463 */     sendByteStringLength(recipe.getName(), bb);
/* 25464 */     bb.put(recipe.getRecipeColourCode(this.player.getWurmId()));
/* 25465 */     bb.putShort(recipe.getResultItem().getIcon());
/* 25466 */     bb.put(recipe.isLootable() ? 1 : 0);
/* 25467 */     bb.put(RecipesByPlayer.isFavourite(this.player.getWurmId(), recipe.getRecipeId()) ? 1 : 0);
/* 25468 */     sendByteStringLength(RecipesByPlayer.getNotes(this.player.getWurmId(), recipe.getRecipeId()), bb);
/*       */     
/* 25470 */     sendByteStringLength(recipe.getSkillName(), bb);
/*       */     
/* 25472 */     if (!recipe.hasCooker()) {
/* 25473 */       bb.put((byte)0);
/*       */     } else {
/*       */       
/* 25476 */       Set<ItemTemplate> cookers = recipe.getCookerTemplates();
/* 25477 */       bb.put((byte)cookers.size());
/* 25478 */       for (ItemTemplate cooker : cookers) {
/*       */         
/* 25480 */         sendByteStringLength(cooker.getName(), bb);
/* 25481 */         bb.putShort(cooker.getImageNumber());
/*       */       } 
/*       */     } 
/*       */     
/* 25485 */     if (!recipe.hasContainer()) {
/* 25486 */       bb.put((byte)0);
/*       */     } else {
/*       */       
/* 25489 */       Set<ItemTemplate> containers = recipe.getContainerTemplates();
/* 25490 */       bb.put((byte)containers.size());
/* 25491 */       for (ItemTemplate container : containers) {
/*       */         
/* 25493 */         sendByteStringLength(container.getName(), bb);
/* 25494 */         bb.putShort(container.getImageNumber());
/*       */       } 
/*       */     } 
/*       */     
/* 25498 */     if (!recipe.hasActiveItem()) {
/* 25499 */       bb.put((byte)0);
/*       */     }
/*       */     else {
/*       */       
/* 25503 */       if (recipe.getActiveItem().getTemplate().isTool()) {
/* 25504 */         bb.put((byte)2);
/*       */       } else {
/* 25506 */         bb.put((byte)1);
/* 25507 */       }  sendCookbookIngredient(recipe, recipe.getActiveItem(), bb);
/*       */     } 
/*       */ 
/*       */     
/* 25511 */     if (!recipe.hasTargetItem()) {
/* 25512 */       bb.put((byte)0);
/*       */     } else {
/*       */       
/* 25515 */       bb.put((byte)1);
/* 25516 */       sendCookbookIngredient(recipe, recipe.getTargetItem(), bb);
/*       */     } 
/*       */     
/* 25519 */     IngredientGroup[] groups = recipe.getGroups();
/* 25520 */     bb.put((byte)groups.length);
/* 25521 */     for (IngredientGroup ig : groups) {
/*       */       
/* 25523 */       bb.put(ig.getGroupType());
/* 25524 */       Ingredient[] ingredients = ig.getIngredients();
/* 25525 */       bb.put((byte)ingredients.length);
/* 25526 */       for (Ingredient ingredient : ingredients)
/*       */       {
/* 25528 */         sendCookbookIngredient(recipe, ingredient, bb);
/*       */       }
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void sendCookbookIngredient(Recipe recipe, Ingredient ingredient, ByteBuffer bb) throws Exception {
/* 25543 */     byte colourCode = 0;
/* 25544 */     boolean linkKnown = false;
/* 25545 */     String linkNotes = "";
/* 25546 */     String name = Recipes.getIngredientName(ingredient);
/* 25547 */     Recipe[] recipes = Recipes.getRecipesByResult(ingredient);
/* 25548 */     bb.putShort(ingredient.getTemplate().getImageNumber());
/*       */     
/* 25550 */     if (recipes.length > 0) {
/*       */       
/* 25552 */       if (recipes.length == 1) {
/*       */         
/* 25554 */         sendByteStringLength(name, bb);
/* 25555 */         bb.put((byte)1);
/*       */ 
/*       */       
/*       */       }
/* 25559 */       else if (name.equals("any fish") || name.equals("any veg") || name.equals("fish fillet")) {
/*       */         
/* 25561 */         sendByteStringLength(name, bb);
/* 25562 */         bb.put((byte)(recipes.length + 1));
/* 25563 */         bb.putShort((short)-1);
/* 25564 */         sendByteStringLength("raw " + name, bb);
/* 25565 */         bb.put((byte)4);
/* 25566 */         bb.put((byte)0);
/* 25567 */         bb.put((byte)0);
/* 25568 */         sendByteStringLength(linkNotes, bb);
/*       */       }
/*       */       else {
/*       */         
/* 25572 */         if (name.startsWith("any ")) {
/* 25573 */           sendByteStringLength(name, bb);
/*       */         } else {
/* 25575 */           sendByteStringLength("any " + name, bb);
/* 25576 */         }  bb.put((byte)recipes.length);
/*       */       } 
/*       */       
/* 25579 */       for (int x = 0; x < recipes.length; x++)
/*       */       {
/* 25581 */         bb.putShort(recipes[x].getRecipeId());
/* 25582 */         if (recipes.length == 1) {
/* 25583 */           sendByteStringLength(name, bb);
/*       */         } else {
/* 25585 */           sendByteStringLength(recipes[x].getName(), bb);
/* 25586 */         }  colourCode = recipes[x].getRecipeColourCode(this.player.getWurmId());
/* 25587 */         bb.put(colourCode);
/* 25588 */         if (this.player.getPower() == 5) {
/* 25589 */           linkKnown = true;
/*       */         } else {
/* 25591 */           linkKnown = ((colourCode & 0x10) == 0);
/* 25592 */         }  bb.put(linkKnown ? 1 : 0);
/* 25593 */         bb.put((byte)0);
/* 25594 */         sendByteStringLength(linkNotes, bb);
/*       */       }
/*       */     
/*       */     } else {
/*       */       
/* 25599 */       sendByteStringLength(name, bb);
/* 25600 */       bb.put((byte)0);
/* 25601 */       if (name.contains("any ")) {
/* 25602 */         bb.put((byte)4);
/*       */       } else {
/* 25604 */         bb.put((byte)0);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void sendPermissionsAddedManually(String playerName, long pid) {
/* 25617 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 25621 */         ByteBuffer bb = this.connection.getBuffer();
/* 25622 */         bb.put((byte)-26);
/* 25623 */         bb.put((byte)1);
/* 25624 */         bb.putLong(pid);
/* 25625 */         sendByteStringLength(playerName, bb);
/* 25626 */         this.connection.flush();
/*       */       }
/* 25628 */       catch (Exception ex) {
/*       */         
/* 25630 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 25631 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public final void sendPermissionsApplyChangesFailed(int questionId, String reason) {
/* 25645 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 25649 */         ByteBuffer bb = this.connection.getBuffer();
/* 25650 */         bb.put((byte)-26);
/* 25651 */         bb.put((byte)2);
/* 25652 */         bb.putInt(questionId);
/* 25653 */         sendByteStringLength(reason, bb);
/* 25654 */         this.connection.flush();
/*       */       }
/* 25656 */       catch (Exception ex) {
/*       */         
/* 25658 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 25659 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public final void sendHidePermissions() {
/* 25671 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 25675 */         ByteBuffer bb = this.connection.getBuffer();
/* 25676 */         bb.put((byte)-26);
/* 25677 */         bb.put((byte)4);
/* 25678 */         this.connection.flush();
/*       */       }
/* 25680 */       catch (Exception ex) {
/*       */         
/* 25682 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 25683 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public final void sendShowPermissions(int questionId, boolean hasBackButton, String objectType, String objectName, String ownerName, boolean isOwner, boolean canChangeOwner, boolean isManaged, boolean isManageEnabled, String mayManageText, String mayManageHover, String warningText, String messageOnTick, String questionOnTick, String messageUnTick, String questionUnTick, String allowAlliesText, String allowCitizensText, String allowKingdomText, String allowEveryoneText, String allowRolePermissionText, String[] header1, String[] header2, String[] hover, String[] trustedNames, long[] trustedIds, String[] friendNames, long[] friendIds, String mySettlement, String[] citizenNames, long[] citizenIds, String[] permittedNames, long[] permittedIds, boolean[][] allowed) {
/* 25704 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 25708 */         ByteBuffer bb = this.connection.getBuffer();
/* 25709 */         bb.put((byte)-26);
/* 25710 */         bb.put((byte)0);
/* 25711 */         bb.putInt(questionId);
/*       */         
/* 25713 */         byte flags = 0;
/* 25714 */         if (hasBackButton)
/*       */         {
/* 25716 */           flags = (byte)(flags + 1); } 
/* 25717 */         if (isOwner)
/*       */         {
/* 25719 */           flags = (byte)(flags + 2); } 
/* 25720 */         if (canChangeOwner)
/*       */         {
/* 25722 */           flags = (byte)(flags + 4); } 
/* 25723 */         if (isManaged)
/*       */         {
/* 25725 */           flags = (byte)(flags + 8); } 
/* 25726 */         if (isManageEnabled)
/*       */         {
/* 25728 */           flags = (byte)(flags + 16); } 
/* 25729 */         bb.put(flags);
/* 25730 */         sendByteStringLength(objectType, bb);
/* 25731 */         sendByteStringLength(objectName, bb);
/* 25732 */         sendByteStringLength(ownerName, bb);
/* 25733 */         sendByteStringLength(mayManageText, bb);
/* 25734 */         sendByteStringLength(mayManageHover, bb);
/* 25735 */         sendByteStringLength(warningText, bb);
/* 25736 */         sendByteStringLength(messageOnTick, bb);
/* 25737 */         sendByteStringLength(questionOnTick, bb);
/* 25738 */         sendByteStringLength(messageUnTick, bb);
/* 25739 */         sendByteStringLength(questionUnTick, bb);
/* 25740 */         sendByteStringLength(allowAlliesText, bb);
/* 25741 */         sendByteStringLength(allowCitizensText, bb);
/* 25742 */         sendByteStringLength(allowKingdomText, bb);
/* 25743 */         sendByteStringLength(allowEveryoneText, bb);
/* 25744 */         sendByteStringLength(allowRolePermissionText, bb);
/*       */         
/* 25746 */         bb.putInt(header1.length); int x;
/* 25747 */         for (x = 0; x < header1.length; x++) {
/*       */           
/* 25749 */           sendByteStringLength(header1[x], bb);
/* 25750 */           sendByteStringLength(header2[x], bb);
/* 25751 */           sendByteStringLength(hover[x], bb);
/*       */         } 
/*       */         
/* 25754 */         bb.putInt(trustedNames.length);
/* 25755 */         for (x = 0; x < trustedNames.length; x++) {
/*       */           
/* 25757 */           sendByteStringLength(trustedNames[x], bb);
/* 25758 */           bb.putLong(trustedIds[x]);
/*       */         } 
/*       */         
/* 25761 */         bb.putInt(friendNames.length);
/* 25762 */         for (x = 0; x < friendNames.length; x++) {
/*       */           
/* 25764 */           sendByteStringLength(friendNames[x], bb);
/* 25765 */           bb.putLong(friendIds[x]);
/*       */         } 
/*       */         
/* 25768 */         bb.putInt(citizenNames.length);
/* 25769 */         if (citizenNames.length > 0)
/* 25770 */           sendByteStringLength(mySettlement, bb); 
/* 25771 */         for (x = 0; x < citizenNames.length; x++) {
/*       */           
/* 25773 */           sendByteStringLength(citizenNames[x], bb);
/* 25774 */           bb.putLong(citizenIds[x]);
/*       */         } 
/*       */         
/* 25777 */         bb.putInt(permittedNames.length);
/* 25778 */         for (x = 0; x < permittedNames.length; x++) {
/*       */           
/* 25780 */           sendByteStringLength(permittedNames[x], bb);
/* 25781 */           bb.putLong(permittedIds[x]);
/*       */           
/* 25783 */           for (int y = 0; y < header1.length; y++)
/*       */           {
/* 25785 */             bb.put((byte)(allowed[x][y] ? 1 : 0));
/*       */           }
/*       */         } 
/* 25788 */         this.connection.flush();
/*       */       }
/* 25790 */       catch (Exception ex) {
/*       */         
/* 25792 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 25793 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendPersonalGoalsList(Map<AchievementTemplate, Boolean> goals) {
/* 25800 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 25804 */         ByteBuffer bb = this.connection.getBuffer();
/* 25805 */         bb.put((byte)-39);
/* 25806 */         bb.put((byte)0);
/* 25807 */         bb.putInt(goals.size());
/* 25808 */         for (Map.Entry<AchievementTemplate, Boolean> goal : goals.entrySet()) {
/*       */           
/* 25810 */           bb.putInt(((AchievementTemplate)goal.getKey()).getNumber());
/* 25811 */           String name = ((AchievementTemplate)goal.getKey()).getName();
/* 25812 */           if (((AchievementTemplate)goal.getKey()).isInvisible())
/* 25813 */             name = "Personal goal"; 
/* 25814 */           byte[] aNameStringArr = name.getBytes("UTF-8");
/* 25815 */           bb.put((byte)aNameStringArr.length);
/* 25816 */           bb.put(aNameStringArr);
/*       */           
/* 25818 */           String adesc = ((AchievementTemplate)goal.getKey()).getRequirement();
/* 25819 */           byte[] aDescStringArr = adesc.getBytes("UTF-8");
/* 25820 */           bb.put((byte)aDescStringArr.length);
/* 25821 */           bb.put(aDescStringArr);
/* 25822 */           bb.put(((AchievementTemplate)goal.getKey()).getType());
/* 25823 */           bb.put((byte)(((Boolean)goal.getValue()).booleanValue() ? 1 : 0));
/*       */         } 
/* 25825 */         this.connection.flush();
/*       */       }
/* 25827 */       catch (Exception ex) {
/*       */         
/* 25829 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 25830 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void updatePersonalGoal(Achievement achievement, boolean finished) {
/* 25837 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 25841 */         ByteBuffer bb = this.connection.getBuffer();
/* 25842 */         bb.put((byte)-40);
/* 25843 */         bb.putInt(achievement.getAchievement());
/*       */         
/* 25845 */         bb.put((byte)(finished ? 1 : 0));
/*       */         
/* 25847 */         this.connection.flush();
/*       */       }
/* 25849 */       catch (Exception ex) {
/*       */         
/* 25851 */         logInfo(this.player.getName() + ':' + " achievement: " + achievement + ' ' + ex.getMessage(), ex);
/* 25852 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public final void sendShowPersonalGoalWindow(boolean show) {
/* 25859 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 25863 */         ByteBuffer bb = this.connection.getBuffer();
/* 25864 */         bb.put((byte)-41);
/* 25865 */         bb.put((byte)(show ? 1 : 0));
/*       */         
/* 25867 */         this.connection.flush();
/*       */       }
/* 25869 */       catch (Exception ex) {
/*       */         
/* 25871 */         logInfo(this.player.getName() + ':' + " show personal goals: ", ex);
/* 25872 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public final void sendNewKingdom(byte kingdom, String kingdomName, String suffix) {
/* 25880 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 25884 */         ByteBuffer bb = this.connection.getBuffer();
/* 25885 */         bb.put((byte)39);
/* 25886 */         bb.put(kingdom);
/*       */         
/* 25888 */         byte[] kingdomNameStringArr = kingdomName.getBytes("UTF-8");
/* 25889 */         bb.put((byte)kingdomNameStringArr.length);
/* 25890 */         bb.put(kingdomNameStringArr);
/*       */         
/* 25892 */         byte[] suffixStringArr = suffix.getBytes("UTF-8");
/* 25893 */         bb.put((byte)suffixStringArr.length);
/* 25894 */         bb.put(suffixStringArr);
/*       */         
/* 25896 */         this.connection.flush();
/*       */       }
/* 25898 */       catch (Exception ex) {
/*       */         
/* 25900 */         logInfo(this.player.getName() + ':' + " kingdomName " + kingdomName + ' ' + ex.getMessage(), ex);
/* 25901 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public final void sendAllKingdoms() {
/* 25908 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 25912 */         Kingdom[] allKingdom = Kingdoms.getAllKingdoms();
/* 25913 */         int numberOfKindoms = allKingdom.length;
/*       */         
/* 25915 */         ByteBuffer bb = this.connection.getBuffer();
/*       */ 
/*       */         
/* 25918 */         bb.put((byte)40);
/* 25919 */         bb.putInt(numberOfKindoms);
/*       */         
/* 25921 */         for (int i = 0; i < allKingdom.length; i++) {
/*       */           
/* 25923 */           bb.put(allKingdom[i].getId());
/*       */           
/* 25925 */           byte[] kingdomNameStringArr = allKingdom[i].getName().getBytes("UTF-8");
/* 25926 */           bb.put((byte)kingdomNameStringArr.length);
/* 25927 */           bb.put(kingdomNameStringArr);
/*       */           
/* 25929 */           byte[] suffixStringArr = allKingdom[i].getSuffix().getBytes("UTF-8");
/* 25930 */           bb.put((byte)suffixStringArr.length);
/* 25931 */           bb.put(suffixStringArr);
/*       */         } 
/* 25933 */         this.connection.flush();
/*       */       }
/* 25935 */       catch (Exception ex) {
/*       */         
/* 25937 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 25938 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public final void sendOwnTitles() {
/*       */     try {
/* 25948 */       ByteBuffer bb = this.connection.getBuffer();
/* 25949 */       bb.put((byte)-33);
/* 25950 */       if (this.player.getTitle() != null || (Features.Feature.COMPOUND_TITLES
/* 25951 */         .isEnabled() && this.player.getSecondTitle() != null)) {
/* 25952 */         sendShortStringLength(this.player.getTitleString(), bb);
/*       */       } else {
/* 25954 */         sendShortStringLength("", bb);
/* 25955 */       }  if (this.player.getCultist() != null) {
/*       */         
/* 25957 */         sendShortStringLength(this.player.getCultist().getCultistTitle(), bb);
/*       */       } else {
/*       */         
/* 25960 */         sendShortStringLength("", bb);
/* 25961 */       }  this.connection.flush();
/*       */     }
/* 25963 */     catch (Exception ex) {
/*       */       
/* 25965 */       logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 25966 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public final void sendSleepInfo() {
/*       */     try {
/* 25975 */       int sleepBonus = this.player.getSaveFile().getSleepLeft();
/* 25976 */       ByteBuffer bb = this.connection.getBuffer();
/* 25977 */       bb.put((byte)1);
/* 25978 */       bb.put((byte)((this.player.getSaveFile()).frozenSleep ? 0 : 1));
/* 25979 */       bb.putInt(sleepBonus);
/* 25980 */       this.connection.flush();
/*       */     }
/* 25982 */     catch (Exception ex) {
/*       */       
/* 25984 */       logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 25985 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendClearFriendsList() {
/* 25994 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 25998 */         ByteBuffer bb = this.connection.getBuffer();
/* 25999 */         bb.put((byte)89);
/* 26000 */         bb.put(PlayerOnlineStatus.DELETE_ME.getId());
/* 26001 */         this.connection.flush();
/*       */       }
/* 26003 */       catch (Exception ex) {
/*       */         
/* 26005 */         logInfo(this.player.getName() + " could not send empty friends list due to : " + ex.getMessage(), ex);
/* 26006 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendFriend(PlayerState playerState) {
/* 26013 */     sendFriend(playerState, false, "");
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendFriend(PlayerState playerState, String note) {
/* 26018 */     sendFriend(playerState, true, note);
/*       */   }
/*       */ 
/*       */   
/*       */   private void sendFriend(PlayerState playerState, boolean withNote, String note) {
/* 26023 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 26027 */         ByteBuffer bb = this.connection.getBuffer();
/* 26028 */         bb.put((byte)89);
/*       */         
/* 26030 */         bb.put(playerState.getState().getId());
/* 26031 */         sendByteStringLength(playerState.getPlayerName(), bb);
/* 26032 */         bb.putLong(playerState.getWhenStateChanged());
/* 26033 */         sendByteStringLength(playerState.getServerName(), bb);
/* 26034 */         if (withNote)
/* 26035 */           sendByteStringLength(note, bb); 
/* 26036 */         this.connection.flush();
/*       */       }
/* 26038 */       catch (Exception ex) {
/*       */         
/* 26040 */         logWarn(this.player.getName() + ':' + " wurmId " + this.player.getWurmId() + ' ' + ex.getMessage(), ex);
/* 26041 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendRarityEvent() {
/*       */     try {
/* 26050 */       ByteBuffer bb = this.connection.getBuffer();
/* 26051 */       bb.put((byte)56);
/* 26052 */       this.connection.flush();
/* 26053 */       sendServerMessage("You have a moment of inspiration...", 255, 200, 20);
/*       */     }
/* 26055 */     catch (Exception ex) {
/*       */       
/* 26057 */       logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 26058 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendClearTickets() {
/* 26067 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 26071 */         ByteBuffer bb = this.connection.getBuffer();
/* 26072 */         bb.put((byte)-34);
/* 26073 */         bb.putInt(0);
/* 26074 */         this.connection.flush();
/*       */       }
/* 26076 */       catch (Exception ex) {
/*       */         
/* 26078 */         logInfo(this.player.getName() + " could not send empty ticket list due to : " + ex.getMessage(), ex);
/* 26079 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendTicket(Ticket ticket) {
/* 26086 */     sendTickets(new Ticket[] { ticket });
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendTickets(Ticket[] tickets) {
/* 26092 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 26096 */         ByteBuffer bb = this.connection.getBuffer();
/* 26097 */         bb.put((byte)-34);
/* 26098 */         bb.putInt(tickets.length);
/* 26099 */         for (int x = 0; x < tickets.length; x++) {
/*       */           
/* 26101 */           Ticket ticket = tickets[x];
/* 26102 */           bb.putLong(ticket.getWurmId());
/* 26103 */           bb.put(ticket.getTicketGroup(this.player));
/* 26104 */           sendByteStringLength(ticket.getTicketSummary(this.player), bb);
/* 26105 */           bb.put(ticket.getColourCode(this.player));
/* 26106 */           sendShortStringLength(ticket.getShortDescription(), bb);
/*       */           
/* 26108 */           TicketAction[] ticketActions = ticket.getTicketActions(this.player);
/* 26109 */           bb.put((byte)ticketActions.length);
/* 26110 */           for (TicketAction ticketAction : ticketActions) {
/*       */             
/* 26112 */             bb.putInt(ticketAction.getActionNo());
/* 26113 */             sendByteStringLength(ticketAction.getLine(this.player), bb);
/* 26114 */             sendByteStringLength(ticketAction.getNotePlus(this.player), bb);
/*       */           } 
/*       */         } 
/* 26117 */         this.connection.flush();
/*       */       }
/* 26119 */       catch (Exception ex) {
/*       */         
/* 26121 */         logInfo(this.player.getName() + " could not send tickets due to : " + ex.getMessage(), ex);
/* 26122 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendTicket(Ticket ticket, @Nullable TicketAction ticketAction) {
/* 26130 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 26134 */         ByteBuffer bb = this.connection.getBuffer();
/* 26135 */         bb.put((byte)-34);
/* 26136 */         bb.putInt(1);
/* 26137 */         bb.putLong(ticket.getWurmId());
/* 26138 */         bb.put(ticket.getTicketGroup(this.player));
/* 26139 */         sendByteStringLength(ticket.getTicketSummary(this.player), bb);
/* 26140 */         bb.put(ticket.getColourCode(this.player));
/* 26141 */         sendShortStringLength(ticket.getDescription(), bb);
/*       */         
/* 26143 */         if (ticketAction == null) {
/*       */           
/* 26145 */           bb.put((byte)0);
/*       */         }
/*       */         else {
/*       */           
/* 26149 */           bb.put((byte)1);
/* 26150 */           bb.putInt(ticketAction.getActionNo());
/* 26151 */           sendByteStringLength(ticketAction.getLine(this.player), bb);
/* 26152 */           sendByteStringLength(ticketAction.getNotePlus(this.player), bb);
/*       */         } 
/* 26154 */         this.connection.flush();
/*       */       }
/* 26156 */       catch (Exception ex) {
/*       */         
/* 26158 */         logInfo(this.player.getName() + " could not send tickets due to : " + ex.getMessage(), ex);
/* 26159 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void removeTicket(Ticket ticket) {
/* 26166 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 26170 */         ByteBuffer bb = this.connection.getBuffer();
/* 26171 */         bb.put((byte)-36);
/* 26172 */         bb.putInt(1);
/* 26173 */         bb.putLong(ticket.getWurmId());
/* 26174 */         this.connection.flush();
/*       */       }
/* 26176 */       catch (Exception ex) {
/*       */         
/* 26178 */         logInfo(this.player.getName() + " could not remove ticket due to : " + ex.getMessage(), ex);
/* 26179 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendWater(int tilex, int tiley, int layer, int height) {
/* 26186 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 26190 */         ByteBuffer bb = this.connection.getBuffer();
/* 26191 */         bb.put((byte)-19);
/* 26192 */         bb.putShort((short)tilex);
/* 26193 */         bb.putShort((short)tiley);
/* 26194 */         bb.put((byte)layer);
/* 26195 */         bb.putShort((short)height);
/* 26196 */         this.connection.flush();
/*       */       }
/* 26198 */       catch (Exception ex) {
/*       */         
/* 26200 */         logInfo(this.player.getName() + " could not send water due to : " + ex.getMessage(), ex);
/* 26201 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendCreationsList() {
/* 26208 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 26214 */       if (!CreationWindowMethods.sendAllCraftingRecipes(this.connection, this.player))
/*       */       {
/*       */         return;
/*       */       }
/*       */     }
/* 26219 */     catch (Exception ex) {
/*       */       
/* 26221 */       String errorMessage = StringUtil.format("Failed to send creations list to %s.", new Object[] { this.player
/* 26222 */             .getName() });
/* 26223 */       logInfo(errorMessage, ex);
/*       */       
/* 26225 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendActionResult(boolean success) {
/* 26231 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 26237 */       ByteBuffer bb = this.connection.getBuffer();
/* 26238 */       bb.put((byte)-46);
/* 26239 */       bb.put((byte)5);
/* 26240 */       bb.put((byte)(success ? 1 : 0));
/* 26241 */       this.connection.flush();
/*       */     }
/* 26243 */     catch (Exception ex) {
/*       */       
/* 26245 */       String errorMessage = StringUtil.format("Failed to send action result to %s.", new Object[] { this.player
/* 26246 */             .getName() });
/* 26247 */       logInfo(errorMessage, ex);
/* 26248 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendUpdateGroundItem(Item item) {
/* 26254 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 26260 */       ByteBuffer bb = this.connection.getBuffer();
/* 26261 */       bb.put((byte)-46);
/* 26262 */       bb.put((byte)6);
/* 26263 */       bb.putLong(item.getWurmId());
/* 26264 */       bb.putFloat(item.getQualityLevel());
/* 26265 */       bb.putFloat(item.getWeightGrams() / 1000.0F);
/* 26266 */       bb.putFloat(item.getDamage());
/* 26267 */       this.connection.flush();
/*       */     }
/* 26269 */     catch (Exception ex) {
/*       */       
/* 26271 */       String errorMessage = StringUtil.format("Failed to send update to %s.", new Object[] { this.player
/* 26272 */             .getName() });
/* 26273 */       logInfo(errorMessage, ex);
/* 26274 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void updateCreatureRarity(long creatureId, byte rarity) {
/* 26280 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 26286 */       ByteBuffer bb = this.connection.getBuffer();
/* 26287 */       bb.put((byte)-54);
/* 26288 */       bb.putLong(creatureId);
/* 26289 */       bb.put(rarity);
/* 26290 */       this.connection.flush();
/*       */     }
/* 26292 */     catch (Exception ex) {
/*       */       
/* 26294 */       String errorMessage = StringUtil.format("Failed to send rarity to %s.", new Object[] { this.player.getName() });
/* 26295 */       logInfo(errorMessage, ex);
/* 26296 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendShowDeedPlan(int qId, String deedName, int tokenX, int tokenY, int startX, int startY, int endX, int endY, int perimSize) {
/* 26303 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 26309 */       ByteBuffer bb = this.connection.getBuffer();
/* 26310 */       bb.put((byte)-51);
/* 26311 */       bb.put((byte)0);
/* 26312 */       bb.putInt(qId);
/* 26313 */       sendByteStringLength(deedName, bb);
/* 26314 */       bb.putInt(tokenX);
/* 26315 */       bb.putInt(tokenY);
/* 26316 */       bb.putInt(startX);
/* 26317 */       bb.putInt(startY);
/* 26318 */       bb.putInt(endX);
/* 26319 */       bb.putInt(endY);
/* 26320 */       bb.putInt(perimSize);
/* 26321 */       this.connection.flush();
/*       */     }
/* 26323 */     catch (Exception ex) {
/*       */       
/* 26325 */       String errorMessage = StringUtil.format("Failed to send show deed plan to %s.", new Object[] { this.player
/* 26326 */             .getName() });
/* 26327 */       logInfo(errorMessage, ex);
/* 26328 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   static String readByteString(ByteBuffer bb) throws Exception {
/* 26334 */     int len = bb.get() & 0xFF;
/* 26335 */     byte[] bytes = new byte[len];
/* 26336 */     bb.get(bytes);
/* 26337 */     return new String(bytes, "UTF-8");
/*       */   }
/*       */ 
/*       */   
/*       */   static String readShortString(ByteBuffer bb) throws Exception {
/* 26342 */     int len = bb.getShort();
/* 26343 */     byte[] bytes = new byte[len];
/* 26344 */     bb.get(bytes);
/* 26345 */     return new String(bytes, "UTF-8");
/*       */   }
/*       */ 
/*       */   
/*       */   static void sendByteStringLength(String toSend, ByteBuffer bb) throws Exception {
/* 26350 */     byte[] toSendStringArr = toSend.getBytes("UTF-8");
/* 26351 */     bb.put((byte)toSendStringArr.length);
/* 26352 */     bb.put(toSendStringArr);
/*       */   }
/*       */ 
/*       */   
/*       */   static void sendShortStringLength(String toSend, ByteBuffer bb) throws Exception {
/* 26357 */     byte[] toSendStringArr = toSend.getBytes("UTF-8");
/* 26358 */     bb.putShort((short)toSendStringArr.length);
/* 26359 */     bb.put(toSendStringArr);
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private static void flushSocketConnectionNoErrors(SocketConnection aConnection) {
/* 26377 */     if (aConnection == null || !aConnection.isWriting()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 26383 */       aConnection.flush();
/*       */     }
/* 26385 */     catch (Exception exception) {}
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendValreiMapDataList(Collection<ValreiMapData> datas) {
/* 26392 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */     
/* 26396 */     if (datas != null && !datas.isEmpty())
/*       */     {
/* 26398 */       for (ValreiMapData d : datas)
/*       */       {
/* 26400 */         sendValreiMapData(d);
/*       */       }
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendValreiMapDataList(List<ValreiMapData> datas) {
/* 26407 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */     
/* 26411 */     if (datas != null && !datas.isEmpty())
/*       */     {
/* 26413 */       for (ValreiMapData d : datas)
/*       */       {
/* 26415 */         sendValreiMapData(d);
/*       */       }
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendValreiMapDataTimeUpdate(ValreiMapData data) {
/* 26422 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 26428 */       ByteBuffer bb = this.connection.getBuffer();
/* 26429 */       bb.put((byte)-50);
/* 26430 */       bb.put((byte)4);
/*       */       
/* 26432 */       bb.putLong(data.getEntityId());
/* 26433 */       bb.putLong(data.getTimeRemaining());
/*       */       
/* 26435 */       this.connection.flush();
/*       */     }
/* 26437 */     catch (Exception ex) {
/*       */       
/* 26439 */       logWarn("Failed sending ValreiMapData time update for  " + data.getName(), ex);
/* 26440 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void createValreiItemMessage(ValreiMapData data, ByteBuffer bb) throws UnsupportedEncodingException {
/* 26446 */     bb.put((byte)1);
/* 26447 */     bb.putLong(data.getEntityId());
/* 26448 */     bb.putInt(data.getType());
/* 26449 */     bb.putInt(data.getHexId());
/*       */     
/* 26451 */     String name = data.getName();
/* 26452 */     byte[] nameBytes = name.getBytes("UTF-8");
/* 26453 */     bb.putShort((short)nameBytes.length);
/* 26454 */     bb.put(nameBytes);
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   private void createValreiDemigodMessage(ValreiMapData data, ByteBuffer bb) throws UnsupportedEncodingException {
/* 26460 */     bb.put((byte)2);
/*       */     
/* 26462 */     bb.putLong(data.getEntityId());
/* 26463 */     bb.putInt(data.getType());
/* 26464 */     bb.putInt(data.getHexId());
/*       */ 
/*       */ 
/*       */     
/* 26468 */     bb.putFloat(data.getBodyStr());
/* 26469 */     bb.putFloat(data.getBodySta());
/* 26470 */     bb.putFloat(data.getBodyCon());
/* 26471 */     bb.putFloat(data.getMindLog());
/* 26472 */     bb.putFloat(data.getMindSpe());
/* 26473 */     bb.putFloat(data.getSoulStr());
/* 26474 */     bb.putFloat(data.getSoulDep());
/*       */     
/* 26476 */     List<CollectedValreiItem> coll = data.getCarried();
/*       */     
/* 26478 */     int count = 0;
/* 26479 */     if (coll != null)
/* 26480 */       count = coll.size(); 
/* 26481 */     bb.putInt(count);
/* 26482 */     for (int i = 0; i < count; i++) {
/*       */       
/* 26484 */       CollectedValreiItem collItem = coll.get(i);
/*       */       
/* 26486 */       byte[] arrayOfByte = collItem.getName().getBytes("UTF-8");
/* 26487 */       bb.putShort((short)arrayOfByte.length);
/* 26488 */       bb.put(arrayOfByte);
/* 26489 */       bb.putInt(collItem.getType());
/*       */     } 
/*       */     
/* 26492 */     String name = data.getName();
/* 26493 */     byte[] nameBytes = name.getBytes("UTF-8");
/* 26494 */     bb.putShort((short)nameBytes.length);
/* 26495 */     bb.put(nameBytes);
/*       */   }
/*       */ 
/*       */   
/*       */   private void createValreiAllyMessage(ValreiMapData data, ByteBuffer bb) throws UnsupportedEncodingException {
/* 26500 */     bb.put((byte)3);
/*       */     
/* 26502 */     bb.putLong(data.getEntityId());
/* 26503 */     bb.putInt(data.getType());
/* 26504 */     bb.putInt(data.getHexId());
/*       */ 
/*       */ 
/*       */     
/* 26508 */     bb.putFloat(data.getBodyStr());
/* 26509 */     bb.putFloat(data.getBodySta());
/* 26510 */     bb.putFloat(data.getBodyCon());
/* 26511 */     bb.putFloat(data.getMindLog());
/* 26512 */     bb.putFloat(data.getMindSpe());
/* 26513 */     bb.putFloat(data.getSoulStr());
/* 26514 */     bb.putFloat(data.getSoulDep());
/*       */     
/* 26516 */     List<CollectedValreiItem> coll = data.getCarried();
/*       */     
/* 26518 */     int count = 0;
/* 26519 */     if (coll != null)
/* 26520 */       count = coll.size(); 
/* 26521 */     bb.putInt(count);
/* 26522 */     for (int i = 0; i < count; i++) {
/*       */       
/* 26524 */       CollectedValreiItem collItem = coll.get(i);
/*       */       
/* 26526 */       byte[] nameBytes = collItem.getName().getBytes("UTF-8");
/* 26527 */       bb.putShort((short)nameBytes.length);
/* 26528 */       bb.put(nameBytes);
/* 26529 */       bb.putInt(collItem.getType());
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void createValreiStandardMessage(ValreiMapData data, ByteBuffer bb) throws UnsupportedEncodingException {
/* 26535 */     bb.put((byte)0);
/*       */     
/* 26537 */     bb.putLong(data.getEntityId());
/* 26538 */     bb.putInt(data.getType());
/* 26539 */     bb.putInt(data.getHexId());
/*       */ 
/*       */ 
/*       */     
/* 26543 */     bb.putFloat(data.getBodyStr());
/* 26544 */     bb.putFloat(data.getBodySta());
/* 26545 */     bb.putFloat(data.getBodyCon());
/* 26546 */     bb.putFloat(data.getMindLog());
/* 26547 */     bb.putFloat(data.getMindSpe());
/* 26548 */     bb.putFloat(data.getSoulStr());
/* 26549 */     bb.putFloat(data.getSoulDep());
/*       */     
/* 26551 */     bb.putLong(data.getTimeRemaining());
/* 26552 */     bb.putInt(data.getTargetHexId());
/*       */     
/* 26554 */     List<CollectedValreiItem> coll = data.getCarried();
/*       */     
/* 26556 */     int count = 0;
/* 26557 */     if (coll != null)
/* 26558 */       count = coll.size(); 
/* 26559 */     bb.putInt(count);
/* 26560 */     for (int i = 0; i < count; i++) {
/*       */       
/* 26562 */       CollectedValreiItem collItem = coll.get(i);
/*       */       
/* 26564 */       byte[] nameBytes = collItem.getName().getBytes("UTF-8");
/* 26565 */       bb.putShort((short)nameBytes.length);
/* 26566 */       bb.put(nameBytes);
/* 26567 */       bb.putInt(collItem.getType());
/*       */     } 
/*       */     
/* 26570 */     if (data.isCustomGod()) {
/*       */       
/* 26572 */       String name = data.getName();
/* 26573 */       byte[] nameBytes = name.getBytes("UTF-8");
/* 26574 */       bb.putShort((short)nameBytes.length);
/* 26575 */       bb.put(nameBytes);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendValreiMapData(ValreiMapData data) {
/* 26581 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 26587 */       ByteBuffer bb = this.connection.getBuffer();
/* 26588 */       bb.put((byte)-50);
/* 26589 */       if (data.isItem()) {
/*       */         
/* 26591 */         createValreiItemMessage(data, bb);
/*       */       }
/* 26593 */       else if (data.isDemiGod()) {
/*       */         
/* 26595 */         createValreiDemigodMessage(data, bb);
/*       */       }
/* 26597 */       else if (data.isAlly() || data.isSentinel()) {
/*       */         
/* 26599 */         createValreiAllyMessage(data, bb);
/*       */       }
/*       */       else {
/*       */         
/* 26603 */         createValreiStandardMessage(data, bb);
/*       */       } 
/*       */ 
/*       */       
/* 26607 */       this.connection.flush();
/*       */     
/*       */     }
/* 26610 */     catch (Exception ex) {
/*       */       
/* 26612 */       logWarn("Failed sending ValreiMapData. ", ex);
/* 26613 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendViableVillageRecruitmentAds() {
/* 26619 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 26625 */       RecruitmentAd[] ads = RecruitmentAds.getKingdomAds(this.player.getKingdomId());
/* 26626 */       if (ads == null) {
/*       */         return;
/*       */       }
/* 26629 */       for (RecruitmentAd ad : ads)
/*       */       {
/*       */         try
/*       */         {
/* 26633 */           Village adVillage = Villages.getVillage(ad.getVillageId());
/* 26634 */           PlayerInfo contact = PlayerInfoFactory.getPlayerInfoWithWurmId(ad.getContactId());
/*       */           
/* 26636 */           if (contact == null) {
/* 26637 */             throw new NoSuchPlayerException("No player with id: " + ad.getContactId());
/*       */           }
/* 26639 */           boolean isOnline = PlayerInfoFactory.isPlayerOnline(ad.getContactId());
/* 26640 */           byte[] vName = adVillage.getName().getBytes("UTF-8");
/* 26641 */           byte[] pName = contact.getName().getBytes("UTF-8");
/* 26642 */           byte[] description = ad.getDescription().getBytes("UTF-8");
/* 26643 */           ByteBuffer bb = this.connection.getBuffer();
/* 26644 */           bb.put((byte)-42);
/* 26645 */           bb.put((byte)1);
/* 26646 */           bb.putInt(ad.getVillageId());
/* 26647 */           bb.putShort((short)vName.length);
/* 26648 */           bb.put(vName);
/*       */           
/* 26650 */           bb.putShort((short)pName.length);
/* 26651 */           bb.put(pName);
/* 26652 */           bb.put(isOnline ? 1 : 0);
/*       */           
/* 26654 */           bb.putShort((short)description.length);
/* 26655 */           bb.put(description);
/*       */           
/* 26657 */           this.connection.flush();
/*       */         }
/* 26659 */         catch (NoSuchVillageException nsv)
/*       */         {
/* 26661 */           logWarn("No village for ad with village id: " + ad.getVillageId() + " :" + nsv.getMessage(), (Throwable)nsv);
/*       */         
/*       */         }
/* 26664 */         catch (NoSuchPlayerException nsp)
/*       */         {
/* 26666 */           logWarn("No contact for ad with village id: " + ad.getVillageId() + " :" + nsp.getMessage(), (Throwable)nsp);
/*       */         }
/*       */       
/*       */       }
/*       */     
/* 26671 */     } catch (Exception ex) {
/*       */       
/* 26673 */       logWarn("Failed sending village recruitment ads. ", ex);
/* 26674 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendPortalQuestion() {
/* 26680 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 26686 */       ByteBuffer bb = this.connection.getBuffer();
/* 26687 */       bb.put((byte)-20);
/* 26688 */       this.connection.flush();
/*       */     }
/* 26690 */     catch (Exception ex) {
/*       */       
/* 26692 */       String errorMessage = StringUtil.format("Failed to send portal command to %s.", new Object[] { this.player
/* 26693 */             .getName() });
/* 26694 */       logInfo(errorMessage, ex);
/* 26695 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendOpenPlanWindow(String planName, byte planDirection, byte planLength, byte planWidth, Point start, Point end, byte planMaterial, String planCustom) {
/* 26704 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 26710 */       ByteBuffer bb = this.connection.getBuffer();
/* 26711 */       bb.put((byte)-25);
/* 26712 */       bb.put((byte)1);
/* 26713 */       sendByteStringLength(planName, bb);
/* 26714 */       bb.put(planDirection);
/* 26715 */       bb.put(planLength);
/* 26716 */       bb.put(planWidth);
/* 26717 */       bb.putInt(start.getX());
/* 26718 */       bb.putInt(start.getY());
/* 26719 */       bb.putInt(start.getH());
/* 26720 */       bb.putInt(end.getX());
/* 26721 */       bb.putInt(end.getY());
/* 26722 */       bb.putInt(end.getH());
/* 26723 */       bb.put(planMaterial);
/* 26724 */       sendByteStringLength(planCustom, bb);
/* 26725 */       this.connection.flush();
/*       */     }
/* 26727 */     catch (Exception ex) {
/*       */       
/* 26729 */       String errorMessage = StringUtil.format("Failed to send open bridge plan window to %s.", new Object[] { this.player
/* 26730 */             .getName() });
/* 26731 */       logInfo(errorMessage, ex);
/* 26732 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendClosePlanWindow() {
/* 26738 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 26744 */       ByteBuffer bb = this.connection.getBuffer();
/* 26745 */       bb.put((byte)-25);
/* 26746 */       bb.put((byte)2);
/* 26747 */       this.connection.flush();
/*       */     }
/* 26749 */     catch (Exception ex) {
/*       */       
/* 26751 */       String errorMessage = StringUtil.format("Failed to send close bridge plan window to %s.", new Object[] { this.player
/* 26752 */             .getName() });
/* 26753 */       logInfo(errorMessage, ex);
/* 26754 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendTargetStatus(long targetId, byte statusType, float statusLevel) {
/* 26760 */     if (this.player == null || !this.player.hasLink()) {
/*       */       return;
/*       */     }
/*       */ 
/*       */     
/*       */     try {
/* 26766 */       ByteBuffer bb = this.connection.getBuffer();
/* 26767 */       bb.put((byte)-27);
/* 26768 */       bb.putLong(targetId);
/* 26769 */       bb.put(statusType);
/* 26770 */       bb.putFloat(statusLevel);
/* 26771 */       this.connection.flush();
/*       */     }
/* 26773 */     catch (Exception ex) {
/*       */       
/* 26775 */       String errorMessage = StringUtil.format("Failed to send conquer status command to %s.", new Object[] { this.player
/* 26776 */             .getName() });
/* 26777 */       logInfo(errorMessage, ex);
/* 26778 */       this.player.setLink(false);
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private static void logInfo(String msg) {
/* 26787 */     logger.info(msg);
/*       */   }
/*       */   
/*       */   private static void logInfo(String msg, Throwable thrown) {
/* 26791 */     logger.log(Level.INFO, msg, thrown);
/*       */   }
/*       */ 
/*       */   
/*       */   private static void logWarn(String msg) {
/* 26796 */     logger.warning(msg);
/*       */   }
/*       */   
/*       */   private static void logWarn(String msg, Throwable thrown) {
/* 26800 */     logger.log(Level.WARNING, msg, thrown);
/*       */   }
/*       */ 
/*       */   
/*       */   public int getAvailableMoves() {
/* 26805 */     return this.availableMoves;
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageListWildHives(String message) {
/* 26817 */     StringTokenizer tokens = new StringTokenizer(message);
/* 26818 */     tokens.nextToken();
/* 26819 */     if (tokens.hasMoreTokens()) {
/*       */ 
/*       */       
/* 26822 */       sendNormalServerMessage("List of hives that have two queens!.");
/* 26823 */       int wildcount = 0;
/* 26824 */       Item[] wildhives = Zones.getHives(1239);
/* 26825 */       for (Item hive : wildhives) {
/*       */         
/* 26827 */         if (hive.hasTwoQueens()) {
/*       */           
/* 26829 */           sendNormalServerMessage("Wild hive @ " + hive.getTileX() + "," + hive.getTileY() + " has two queens.");
/* 26830 */           wildcount++;
/*       */         } 
/*       */       } 
/* 26833 */       int domesticcount = 0;
/* 26834 */       Item[] hives = Zones.getHives(1175);
/* 26835 */       for (Item hive : hives) {
/*       */         
/* 26837 */         if (hive.hasTwoQueens()) {
/*       */           
/* 26839 */           sendNormalServerMessage("Domestic hive @ " + hive.getTileX() + "," + hive.getTileY() + " has two queens.");
/* 26840 */           domesticcount++;
/*       */         } 
/*       */       } 
/* 26843 */       sendNormalServerMessage("Found " + wildcount + " wild hives and " + domesticcount + " domestic hives with two queens.");
/*       */     
/*       */     }
/*       */     else {
/*       */       
/* 26848 */       sendNormalServerMessage("List of wild hives and any honey in them!.");
/* 26849 */       int totalHoney = 0;
/* 26850 */       int totalwax = 0;
/*       */       
/* 26852 */       Item[] hives = Zones.getHives(1239);
/* 26853 */       for (Item hive : hives) {
/*       */ 
/*       */         
/* 26856 */         int honey = 0;
/* 26857 */         int wax = 0;
/* 26858 */         Item[] items = hive.getItemsAsArray();
/* 26859 */         for (Item item : items) {
/*       */           
/* 26861 */           if (item.getTemplateId() == 70) {
/* 26862 */             honey += item.getWeightGrams();
/* 26863 */           } else if (item.getTemplateId() == 1254) {
/* 26864 */             wax += item.getWeightGrams();
/*       */           } 
/* 26866 */         }  sendNormalServerMessage("Wild hive @ " + hive.getTileX() + "," + hive.getTileY() + " honey:" + honey + " and " + wax + " beeswax and has " + hive
/* 26867 */             .getAuxData() + " queens.");
/* 26868 */         totalHoney += honey;
/* 26869 */         totalwax += wax;
/*       */       } 
/* 26871 */       sendNormalServerMessage("Found " + hives.length + " wild hives and " + totalHoney + " total honey and " + totalwax + " total wax.");
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageRemoveWildHives() {
/* 26884 */     Item[] hives = Zones.getHives(1239);
/* 26885 */     for (Item hive : hives) {
/*       */       
/* 26887 */       sendNormalServerMessage("Removing Wild Hive @ " + hive.getTileX() + "," + hive.getTileY());
/* 26888 */       Server.setCheckHive(hive.getTileX(), hive.getTileY(), false);
/* 26889 */       Item[] items = hive.getItemsAsArray();
/* 26890 */       for (Item item : items)
/*       */       {
/* 26892 */         Items.destroyItem(item.getWurmId());
/*       */       }
/* 26894 */       Items.destroyItem(hive.getWurmId());
/*       */     } 
/* 26896 */     sendNormalServerMessage("Removed " + hives.length + " wild hives.");
/* 26897 */     if (Servers.isThisATestServer()) {
/* 26898 */       Players.getInstance().sendGmMessage(null, "System", "Debug: Removed " + hives.length + " wild hives.", false);
/*       */     }
/*       */   }
/*       */   
/*       */   private void handleHashMessageRemoveKnownRecipes(String message) {
/* 26903 */     if (this.player.hasLink()) {
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */       
/* 26912 */       StringTokenizer tokens = new StringTokenizer(message);
/* 26913 */       tokens.nextToken();
/* 26914 */       String targetName = "";
/* 26915 */       long tId = -10L;
/* 26916 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 26918 */         targetName = tokens.nextToken().trim();
/*       */ 
/*       */         
/*       */         try {
/* 26922 */           short recipeId = Short.parseShort(targetName);
/* 26923 */           Recipe recipe = Recipes.getRecipeById(recipeId);
/* 26924 */           if (recipe == null) {
/* 26925 */             sendNormalServerMessage("Recipe " + recipeId + " not found!");
/* 26926 */           } else if (!recipe.isKnown()) {
/* 26927 */             sendNormalServerMessage("Recipe " + recipeId + " is known to all and thus cannot be remoed!");
/*       */           } else {
/*       */             
/* 26930 */             RecipesByPlayer.deleteRecipesByNumber(recipeId);
/* 26931 */             sendSafeServerMessage("Removed recipe " + recipeId + " from everyone!");
/* 26932 */             if (Servers.isThisATestServer())
/* 26933 */               Players.getInstance().sendGmMessage(null, "System", "Debug: Removed known recipe of " + recipeId + " from all.", false); 
/* 26934 */             sendNormalServerMessage("Note: players will have to relog for cookbook to be updated.");
/*       */           } 
/*       */           
/*       */           return;
/* 26938 */         } catch (NumberFormatException numberFormatException) {
/*       */ 
/*       */ 
/*       */           
/* 26942 */           targetName = LoginHandler.raiseFirstLetter(targetName);
/* 26943 */           tId = PlayerInfoFactory.getWurmId(targetName);
/* 26944 */           if (tId == -10L) {
/*       */             
/* 26946 */             sendSafeServerMessage("Unknown player " + targetName + "."); return;
/*       */           } 
/*       */         } 
/*       */       } 
/* 26950 */       if (tId != -10L) {
/*       */         
/* 26952 */         if (tokens.hasMoreTokens())
/*       */         {
/* 26954 */           String srecipe = tokens.nextToken().trim();
/*       */           
/*       */           try {
/* 26957 */             short recipeId = Short.parseShort(srecipe);
/* 26958 */             Recipe recipe = Recipes.getRecipeById(recipeId);
/* 26959 */             if (recipe == null) {
/*       */               
/* 26961 */               sendNormalServerMessage("Recipe " + recipeId + " not found!");
/*       */               return;
/*       */             } 
/* 26964 */             if (recipe.isKnown()) {
/*       */               
/* 26966 */               sendNormalServerMessage("Recipe " + recipeId + " is known to all and thus cannot be removed!");
/*       */               
/*       */               return;
/*       */             } 
/*       */             
/* 26971 */             RecipesByPlayer.removeRecipeForPlayer(tId, recipeId);
/* 26972 */             sendSafeServerMessage("Removed recipe " + recipeId + " from " + targetName + ".");
/* 26973 */             if (Servers.isThisATestServer()) {
/* 26974 */               Players.getInstance().sendGmMessage(null, "System", "Debug: Removed recipe " + recipeId + " from " + targetName + ".", false);
/*       */             }
/* 26976 */             sendNormalServerMessage("Note: player will have to relog for cookbook to be updated.");
/*       */ 
/*       */             
/*       */             try {
/* 26980 */               Player p = Players.getInstance().getPlayer(targetName);
/* 26981 */               p.getCommunicator().sendNormalServerMessage("Please relog so your cookbook can be updated!", (byte)2);
/*       */             }
/* 26983 */             catch (NoSuchPlayerException noSuchPlayerException) {}
/*       */ 
/*       */ 
/*       */ 
/*       */           
/*       */           }
/* 26989 */           catch (NumberFormatException nfe) {
/*       */             
/* 26991 */             sendNormalServerMessage("Failed to parse the recipe id!");
/*       */           }
/*       */         
/*       */         }
/*       */         else
/*       */         {
/* 26997 */           RecipesByPlayer.deleteRecipesForPlayer(tId);
/* 26998 */           sendSafeServerMessage("Removed known recipes for " + targetName + ".");
/* 26999 */           if (Servers.isThisATestServer())
/* 27000 */             Players.getInstance().sendGmMessage(null, "System", "Debug: Removed known recipes for " + targetName + ".", false); 
/* 27001 */           sendNormalServerMessage("Note: players will have to relog for cookbook to be updated.");
/*       */         }
/*       */       
/*       */       } else {
/*       */         
/* 27006 */         sendNormalServerMessage("usage: #removeknownrecipes [player] [recipeId]");
/* 27007 */         sendNormalServerMessage("    removes all known recieps from specified player ");
/* 27008 */         sendNormalServerMessage("    OR the specified recipe from all players.");
/* 27009 */         sendNormalServerMessage("    OR the specified recipe from the specified player.");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessageRemoveNamedRecipe(String message) {
/* 27016 */     if (this.player.hasLink()) {
/*       */ 
/*       */ 
/*       */       
/* 27020 */       if (this.player.getLogger() != null) {
/* 27021 */         this.player.getLogger().info(message);
/*       */       }
/* 27023 */       StringTokenizer tokens = new StringTokenizer(message);
/* 27024 */       tokens.nextToken();
/* 27025 */       String targetName = "";
/* 27026 */       short recipeId = -1;
/* 27027 */       long tId = -10L;
/* 27028 */       Recipe recipe = null;
/* 27029 */       String namer = null;
/*       */       
/* 27031 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 27033 */         targetName = tokens.nextToken().trim();
/*       */ 
/*       */         
/*       */         try {
/* 27037 */           recipeId = Short.parseShort(targetName);
/* 27038 */           recipe = Recipes.getRecipeById(recipeId);
/* 27039 */           if (recipe == null) {
/*       */             
/* 27041 */             sendSafeServerMessage("Recipe " + recipeId + " not found!");
/*       */             
/*       */             return;
/*       */           } 
/* 27045 */           namer = Recipes.getRecipeNamer(recipeId);
/* 27046 */           if (namer == null) {
/*       */             
/* 27048 */             sendSafeServerMessage("Recipe (" + recipeId + ") has no namer.");
/*       */             
/*       */             return;
/*       */           } 
/* 27052 */         } catch (NumberFormatException nfe) {
/*       */ 
/*       */           
/* 27055 */           namer = LoginHandler.raiseFirstLetter(targetName);
/* 27056 */           tId = PlayerInfoFactory.getWurmId(namer);
/* 27057 */           if (tId == -10L) {
/*       */             
/* 27059 */             sendSafeServerMessage("Unknown player " + targetName + ".");
/*       */             return;
/*       */           } 
/* 27062 */           recipeId = Recipes.getNamedRecipe(namer);
/* 27063 */           if (recipeId == 0) {
/*       */             
/* 27065 */             sendSafeServerMessage("Player (" + namer + ") has no named recipes.");
/*       */             return;
/*       */           } 
/* 27068 */           recipe = Recipes.getRecipeById(recipeId);
/* 27069 */           if (recipe == null) {
/*       */             
/* 27071 */             sendSafeServerMessage("Recipe " + recipeId + " not found!");
/*       */             
/*       */             return;
/*       */           } 
/*       */         } 
/* 27076 */         String remove = "";
/* 27077 */         if (tokens.hasMoreTokens())
/*       */         {
/* 27079 */           remove = tokens.nextToken().trim();
/*       */         }
/* 27081 */         if (remove.equalsIgnoreCase("remove"))
/*       */         {
/* 27083 */           Recipes.removeRecipeNamer(recipeId);
/* 27084 */           sendNormalServerMessage("Removed namer (" + namer + ") from recipe (" + recipeId + ").");
/* 27085 */           if (Servers.isThisATestServer())
/* 27086 */             Players.getInstance().sendGmMessage(null, "System", "Debug: Removed named recipe " + recipeId + " from player " + namer + ".", false); 
/* 27087 */           sendNormalServerMessage("Note: player will have to relog for cookbook to be updated.");
/*       */ 
/*       */           
/*       */           try {
/* 27091 */             Player p = Players.getInstance().getPlayer(targetName);
/* 27092 */             p.getCommunicator().sendNormalServerMessage("Please relog so your cookbook can be updated!", (byte)2);
/*       */           }
/* 27094 */           catch (NoSuchPlayerException noSuchPlayerException) {}
/*       */ 
/*       */         
/*       */         }
/*       */         else
/*       */         {
/*       */ 
/*       */           
/* 27102 */           sendNormalServerMessage("Player (" + namer + ") has " + recipe.getName() + " (" + recipeId + ") named after them.");
/*       */         }
/*       */       
/*       */       } else {
/*       */         
/* 27107 */         sendNormalServerMessage("usage: #removeNamedRecipe [player or recipeId] [\"remove\"]");
/* 27108 */         sendNormalServerMessage("    show recipe/player from named list ");
/* 27109 */         sendNormalServerMessage("    OR remove entry from named list (if 2nd param is \"remove\").");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessageWindPower(String message) {
/* 27116 */     if (this.player.hasLink()) {
/*       */       
/* 27118 */       StringTokenizer tokens = new StringTokenizer(message);
/* 27119 */       tokens.nextToken();
/* 27120 */       String newPower = "";
/* 27121 */       if (tokens.hasMoreTokens()) {
/* 27122 */         newPower = tokens.nextToken();
/*       */       }
/*       */       
/*       */       try {
/* 27126 */         float pow = Float.parseFloat(newPower);
/* 27127 */         if (pow < 0.0F || pow > 1.0F) {
/*       */           
/* 27129 */           sendNormalServerMessage("Usage: #setwindpower [-0.5 to 0.5]");
/*       */           
/*       */           return;
/*       */         } 
/* 27133 */         Server.getWeather().setWindOnly(Server.getWeather().getWindRotation(), pow, Server.getWeather().getWindDir());
/* 27134 */         sendWeather();
/* 27135 */         sendNormalServerMessage("New wind power successfully set to " + newPower + ".");
/*       */       }
/* 27137 */       catch (NumberFormatException e) {
/*       */         
/* 27139 */         sendNormalServerMessage("Usage: #setwindpower [-0.5 to 0.5]");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessageShowMe(String message) {
/* 27146 */     if (this.player.hasLink()) {
/*       */       
/* 27148 */       StringTokenizer tokens = new StringTokenizer(message);
/* 27149 */       tokens.nextToken();
/*       */       
/* 27151 */       String tabName = tokens.hasMoreTokens() ? tokens.nextToken() : "";
/* 27152 */       boolean justGM = tabName.equalsIgnoreCase("GM");
/*       */       
/* 27154 */       if (justGM) {
/* 27155 */         sendNormalServerMessage("You are now visible to all in GM Tab");
/*       */       } else {
/* 27157 */         sendNormalServerMessage("You are now visible to all in GM and MGMT Tabs");
/* 27158 */       }  Players.getInstance().sendToTabs(this.player, true, justGM);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessageHideMe(String message) {
/* 27164 */     if (this.player.hasLink()) {
/*       */       
/* 27166 */       StringTokenizer tokens = new StringTokenizer(message);
/* 27167 */       tokens.nextToken();
/*       */       
/* 27169 */       String tabName = tokens.hasMoreTokens() ? tokens.nextToken() : "";
/* 27170 */       boolean justGM = tabName.equalsIgnoreCase("GM");
/*       */       
/* 27172 */       if (justGM) {
/* 27173 */         sendNormalServerMessage("You are now invisible to all of lower power than you are in GM Tab.");
/*       */       } else {
/* 27175 */         sendNormalServerMessage("You are now invisible to all of lower power than you are in GM Tab and all in MGMT Tab.");
/* 27176 */       }  Players.getInstance().sendToTabs(this.player, false, justGM);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessageSetAffinityChance(String message) {
/* 27182 */     if (this.player.hasLink()) {
/*       */       
/* 27184 */       StringTokenizer tokens = new StringTokenizer(message);
/* 27185 */       tokens.nextToken();
/*       */       
/* 27187 */       if (tokens.hasMoreTokens()) {
/*       */         
/* 27189 */         int oldChance = Player.newAffinityChance;
/* 27190 */         int newChance = Integer.parseInt(tokens.nextToken());
/* 27191 */         newChance = Math.max(Math.min(10000, newChance), 100);
/* 27192 */         Player.newAffinityChance = newChance;
/* 27193 */         sendNormalServerMessage("Affinity chance now set to 1 / " + newChance + " from 1 / " + oldChance + ".");
/* 27194 */         Skill.affinityDebug.log(Level.INFO, getPlayer() + " changed affinity chance to 1/" + newChance + " from 1/" + oldChance + ".");
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessageGetAffinityStats() {
/* 27201 */     if (this.player.hasLink())
/*       */     {
/* 27203 */       sendNormalServerMessage("Total of " + Skill.getTotalAffinityChecks() + " affinity checks since last restart with a total of " + 
/* 27204 */           Skill.getTotalAffinitiesGiven() + " affinities given since last restart. Current affinity chance is 1 / " + Player.newAffinityChance + ".");
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleHashMessageTestSpecial(String message) {
/* 27214 */     if (Servers.isThisATestServer() && this.player != null && this.player.hasLink() && this.player.getPower() == 5) {
/*       */ 
/*       */ 
/*       */       
/* 27218 */       StringTokenizer tokens = new StringTokenizer(message);
/* 27219 */       tokens.nextToken();
/* 27220 */       if (!tokens.hasMoreTokens()) {
/*       */         
/* 27222 */         sendSafeServerMessage("Command usage is: #testspecial <special> where special is one of: xmas, easter, wurm, halloween or none");
/*       */         return;
/*       */       } 
/* 27225 */       String special = tokens.nextToken();
/* 27226 */       if (special.equals("xmas") || WurmCalendar.isTestChristmas())
/*       */       {
/* 27228 */         sendServerMessage("There is a delay before santas arrive / depart, please wait!", 255, 177, 40);
/*       */       }
/* 27230 */       WurmCalendar.toggleSpecial(special);
/* 27231 */       sendServerMessage("You will been to relog to see the new mappings!", 255, 177, 40);
/*       */     } 
/*       */   }
/*       */   
/*       */   private void handleHashMessageListDens() {
/* 27236 */     Logger playerLogger = this.player.getLogger();
/* 27237 */     if (playerLogger != null) {
/* 27238 */       playerLogger.log(Level.INFO, "Player attempted to use the #listdens command to see all the unique dens");
/*       */     }
/* 27240 */     Map<Integer, Den> dens = Dens.getDens();
/* 27241 */     if (dens.size() == 0) {
/* 27242 */       sendSafeServerMessage("There are no unique dens on this server.");
/*       */       
/*       */       return;
/*       */     } 
/* 27246 */     sendSafeServerMessage("The following dens have been found:");
/*       */     
/* 27248 */     String basicInfo = "%d: At x=%d, y=%d, belonging to template ID: %d. ";
/* 27249 */     String templateInfo = "Template ID is a %s. ";
/* 27250 */     String aliveInfo = "Creature is %salive. ";
/* 27251 */     String wurmIdInfo = "Wurmid: %d";
/* 27252 */     String templateNotFoundInfo = "This template ID is unknown.";
/* 27253 */     String multipleCreaturesInfo = "Multiple living creatures with this template ID were found.";
/*       */     
/* 27255 */     int i = 1;
/* 27256 */     for (Den d : dens.values()) {
/*       */ 
/*       */       
/* 27259 */       StringBuilder sb = new StringBuilder(String.format("%d: At x=%d, y=%d, belonging to template ID: %d. ", new Object[] { Integer.valueOf(i), Integer.valueOf(d.getTilex()), Integer.valueOf(d.getTiley()), Integer.valueOf(d.getTemplateId()) }));
/*       */ 
/*       */       
/*       */       try {
/* 27263 */         CreatureTemplate template = CreatureTemplateFactory.getInstance().getTemplate(d.getTemplateId());
/* 27264 */         sb.append(String.format("Template ID is a %s. ", new Object[] { template.getName() }));
/*       */         
/* 27266 */         Creature creature = Creatures.getInstance().getUniqueCreatureWithTemplate(d.getTemplateId());
/*       */         
/* 27268 */         if (creature != null) {
/* 27269 */           sb.append(String.format("Creature is %salive. ", new Object[] { "" }));
/* 27270 */           sb.append(String.format("Wurmid: %d", new Object[] { Long.valueOf(creature.getWurmId()) }));
/*       */         } else {
/*       */           
/* 27273 */           sb.append(String.format("Creature is %salive. ", new Object[] { "not " }));
/*       */         }
/*       */       
/*       */       }
/* 27277 */       catch (NoSuchCreatureTemplateException ex) {
/* 27278 */         sb.append("This template ID is unknown.");
/* 27279 */       } catch (UnsupportedOperationException ex) {
/* 27280 */         sb.append("Multiple living creatures with this template ID were found.");
/*       */       } 
/* 27282 */       sendSafeServerMessage(sb.toString());
/* 27283 */       i++;
/*       */     } 
/*       */   }
/*       */   
/*       */   private void handleHashMessageRemoveDen(String message) {
/*       */     int templateId;
/* 27289 */     StringTokenizer tokens = new StringTokenizer(message);
/* 27290 */     if (tokens.countTokens() != 2) {
/* 27291 */       sendSafeServerMessage("Command usage is: #removeden <templateID>");
/*       */       
/*       */       return;
/*       */     } 
/* 27295 */     tokens.nextToken();
/* 27296 */     String requestedTemplateId = tokens.nextToken();
/*       */ 
/*       */     
/* 27299 */     Logger playerLogger = this.player.getLogger();
/* 27300 */     if (playerLogger != null) {
/* 27301 */       playerLogger.log(Level.INFO, "Player attempted to delete a unique den with ID: " + requestedTemplateId);
/*       */     }
/*       */     try {
/* 27304 */       templateId = Integer.parseInt(requestedTemplateId);
/* 27305 */     } catch (NumberFormatException ex) {
/* 27306 */       sendSafeServerMessage("The template id: " + requestedTemplateId + " is not a valid number.");
/*       */       
/*       */       return;
/*       */     } 
/* 27310 */     Dens.deleteDen(templateId);
/* 27311 */     sendSafeServerMessage("Den with template ID: " + templateId + " has been deleted.");
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleHashMessageJournalInfo(String message) {
/* 27316 */     StringTokenizer tokens = new StringTokenizer(message);
/* 27317 */     if (tokens.countTokens() != 2) {
/*       */       
/* 27319 */       sendSafeServerMessage("Command usage is: #journalinfo <name>");
/*       */       
/*       */       return;
/*       */     } 
/* 27323 */     tokens.nextToken();
/* 27324 */     String name = tokens.nextToken();
/* 27325 */     PlayerJournal.sendJournalInfoBML(this.player, (PlayerInfoFactory.getPlayerInfoWithName(name)).wurmId);
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleTestFish(String message) {
/* 27330 */     if (Servers.isThisATestServer() && this.player != null && this.player.hasLink() && this.player.getPower() == 5) {
/*       */       
/* 27332 */       StringTokenizer tokens = new StringTokenizer(message);
/* 27333 */       if (tokens.countTokens() < 2) {
/*       */         
/* 27335 */         sendSafeServerMessage("Command usage is: #testfish <fishname> [ql]");
/*       */         
/*       */         return;
/*       */       } 
/* 27339 */       tokens.nextToken();
/*       */       
/* 27341 */       String fishName = tokens.nextToken().toLowerCase();
/*       */       
/* 27343 */       FishEnums.FishData fd = FishEnums.FishData.fromName(fishName);
/* 27344 */       if (fd == null) {
/*       */         
/* 27346 */         sendSafeServerMessage("Unknown fish name " + fishName + ".");
/*       */         
/*       */         return;
/*       */       } 
/* 27350 */       float ql = 100.0F;
/* 27351 */       if (tokens.hasMoreTokens()) {
/*       */ 
/*       */         
/* 27354 */         String str = tokens.nextToken();
/*       */         
/*       */         try {
/* 27357 */           float newql = Float.parseFloat(str);
/* 27358 */           ql = Math.max(Math.min(newql, 100.0F), 1.0F);
/*       */         }
/* 27360 */         catch (NumberFormatException ex) {
/*       */           
/* 27362 */           sendSafeServerMessage("The ql (" + str + ") is not a valid number, so using 100ql.");
/*       */         } 
/*       */       } 
/*       */       
/* 27366 */       float dist = 1.5F;
/* 27367 */       Point4f mid = MethodsFishing.calcSpot(this.player.getPosX(), this.player.getPosY(), this.player.getStatus().getRotation(), 1.5F);
/* 27368 */       float angle = Creature.normalizeAngle(this.player.getStatus().getRotation() - 60.0F);
/* 27369 */       Point4f start = MethodsFishing.calcSpot(mid.getPosX(), mid.getPosY(), angle, 10.0F);
/*       */       
/* 27371 */       Point4f end = MethodsFishing.calcSpot(start.getPosX(), start.getPosY(), start.getRot(), 12.0F);
/* 27372 */       Creature fish = MethodsFishing.makeFishCreature((Creature)this.player, start, fishName, ql, (byte)fd.getTypeId(), 1.0F, end);
/* 27373 */       if (fish == null) {
/*       */         
/* 27375 */         sendSafeServerMessage("Cannot make that fish? " + fishName + ".");
/*       */         
/*       */         return;
/*       */       } 
/*       */       
/* 27380 */       MethodsFishing.addMarker((Creature)this.player, fish.getName() + " start", start);
/* 27381 */       MethodsFishing.addMarker((Creature)this.player, fish.getName() + " end", end);
/* 27382 */       sendSafeServerMessage(fishName + " starts its journey.");
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private StructureConstants.Pair<String, Byte> validatePower(String requestedPower, int ownPower) {
/* 27388 */     String error = "";
/* 27389 */     byte newPower = 0;
/*       */     try {
/* 27391 */       newPower = Byte.parseByte(requestedPower);
/*       */       
/* 27393 */       if (newPower < 0 || newPower > 5) {
/*       */         
/* 27395 */         error = "Could not set power. Power: " + requestedPower + " is not recognized. Only use numbers between 0 and 5";
/*       */       
/*       */       }
/* 27398 */       else if (newPower > ownPower) {
/* 27399 */         error = "You can't set powers above your level";
/*       */       } 
/* 27401 */     } catch (NumberFormatException e) {
/* 27402 */       error = "Could not set power. Power: " + requestedPower + " is not recognized. Only use numbers between 0 and 5";
/* 27403 */     } catch (Exception e) {
/* 27404 */       error = "Could not set power. Unknown exception: " + e.getMessage();
/*       */     } 
/*       */     
/* 27407 */     return new StructureConstants.Pair(error, Byte.valueOf(newPower));
/*       */   }
/*       */   
/*       */   private String getPowerName(int power) {
/* 27411 */     String powString = "normal adventurer";
/*       */     
/* 27413 */     if (power == 1) {
/* 27414 */       powString = "hero";
/* 27415 */     } else if (power == 2) {
/* 27416 */       powString = "demigod";
/* 27417 */     } else if (power == 3) {
/* 27418 */       powString = "high god";
/* 27419 */     } else if (power == 4) {
/* 27420 */       powString = "arch angel";
/* 27421 */     } else if (power == 5) {
/* 27422 */       powString = "implementor";
/*       */     } 
/* 27424 */     return powString;
/*       */   }
/*       */   
/*       */   private void handleHashMessageSetPower(String message) {
/* 27428 */     Logger playerLogger = this.player.getLogger();
/* 27429 */     StringTokenizer tokens = new StringTokenizer(message);
/*       */     
/* 27431 */     if (tokens.countTokens() != 3) {
/* 27432 */       sendSafeServerMessage("Command usage is: #setpower <player> <power>, where the power is a number between 0 to 5");
/*       */       
/*       */       return;
/*       */     } 
/* 27436 */     tokens.nextToken();
/*       */     
/* 27438 */     String playerName = LoginHandler.raiseFirstLetter(tokens.nextToken());
/* 27439 */     String requestedPower = tokens.nextToken();
/*       */     
/* 27441 */     StructureConstants.Pair<String, Byte> errorAndPower = validatePower(requestedPower, this.player.getPower());
/* 27442 */     if (!((String)errorAndPower.getKey()).equals("")) {
/*       */       
/* 27444 */       sendSafeServerMessage((String)errorAndPower.getKey());
/*       */       
/*       */       return;
/*       */     } 
/* 27448 */     byte newPower = ((Byte)errorAndPower.getValue()).byteValue();
/* 27449 */     boolean crossServer = false;
/* 27450 */     int destServer = -1;
/*       */     
/* 27452 */     if (playerLogger != null) {
/* 27453 */       playerLogger.log(Level.INFO, "Tried to set the power of " + playerName + " to level" + newPower);
/*       */     }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/* 27461 */     boolean isLoggedIn = true;
/* 27462 */     Player p = null;
/*       */     try {
/* 27464 */       p = Players.getInstance().getPlayer(playerName);
/* 27465 */     } catch (NoSuchPlayerException ex) {
/* 27466 */       isLoggedIn = false;
/*       */     } 
/*       */ 
/*       */     
/* 27470 */     if (isLoggedIn) {
/* 27471 */       if (p.getPower() > this.player.getPower()) {
/* 27472 */         sendSafeServerMessage("They are more powerful than you. You cannot set their power.");
/*       */         return;
/*       */       } 
/*       */       try {
/* 27476 */         p.setPower(newPower);
/* 27477 */       } catch (IOException e) {
/* 27478 */         sendSafeServerMessage("Could not set power. Error with saving the new power.");
/* 27479 */         if (e.getMessage() != null && !e.getMessage().equals("")) {
/* 27480 */           sendSafeServerMessage("Exception: " + e.getMessage());
/*       */         }
/*       */         return;
/*       */       } 
/*       */     } else {
/*       */       try {
/* 27486 */         PlayerInfo pinf = PlayerInfoFactory.createPlayerInfo(playerName);
/* 27487 */         PlayerState pstate = PlayerInfoFactory.getPlayerState(playerName);
/* 27488 */         if (pstate == null) {
/* 27489 */           sendSafeServerMessage("Player: " + playerName + " could not be found");
/*       */           return;
/*       */         } 
/* 27492 */         if (pstate.getServerId() != Servers.localServer.id) {
/* 27493 */           sendSafeServerMessage("User is not on your server. Trying set status globally...");
/* 27494 */           crossServer = true;
/* 27495 */           destServer = pstate.getServerId();
/*       */         }
/*       */         else {
/*       */           
/* 27499 */           pinf.load();
/* 27500 */           if (pinf.getPower() > this.player.getPower()) {
/* 27501 */             sendSafeServerMessage("You can't set powers above your level");
/*       */             return;
/*       */           } 
/* 27504 */           pinf.setPower(newPower);
/* 27505 */           pinf.save();
/*       */         } 
/* 27507 */       } catch (IOException e) {
/*       */         
/* 27509 */         sendSafeServerMessage("Could not set power. Error with loading or saving data for player: " + playerName + ". Player might never have visited this server.");
/*       */ 
/*       */         
/*       */         return;
/*       */       } 
/*       */     } 
/*       */ 
/*       */     
/* 27517 */     if (crossServer) {
/*       */       
/* 27519 */       WcSetPower wsp = new WcSetPower(playerName, newPower, getPlayerName(false), this.player.getPower(), "");
/* 27520 */       wsp.sendToServer(destServer);
/*       */       return;
/*       */     } 
/* 27523 */     String powString = getPowerName(newPower);
/*       */     
/* 27525 */     if (p != null && p.hasLink()) {
/* 27526 */       p.getCommunicator().sendSafeServerMessage("Your status has been set by " + getPlayerName(false) + " to " + powString + "!");
/*       */     }
/* 27528 */     sendSafeServerMessage("You set the power of " + playerName + " to the status of " + powString + ".");
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendValreiFightList(int listPage) {
/* 27533 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 27537 */         ByteBuffer bb = this.connection.getBuffer();
/* 27538 */         ArrayList<ValreiFightHistory> fights = ValreiFightHistoryManager.getInstance().get10Fights(listPage);
/* 27539 */         int totalPages = ValreiFightHistoryManager.getInstance().getNumberOfFights() / 10;
/*       */         
/* 27541 */         bb.put((byte)-62);
/* 27542 */         bb.put((byte)0);
/* 27543 */         bb.putInt(totalPages);
/* 27544 */         bb.putInt(listPage);
/* 27545 */         if (fights == null) {
/* 27546 */           bb.put((byte)0);
/*       */         } else {
/*       */           
/* 27549 */           bb.put((byte)fights.size());
/*       */           
/* 27551 */           for (ValreiFightHistory f : fights) {
/*       */             
/* 27553 */             bb.putLong(f.getFightId());
/* 27554 */             sendShortStringLength(f.getPreviewString(), bb);
/*       */           } 
/*       */         } 
/*       */         
/* 27558 */         this.connection.flush();
/*       */       }
/* 27560 */       catch (Exception ex) {
/*       */         
/* 27562 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 27563 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendValreiFightDetails(long fightId) {
/* 27570 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 27574 */         ByteBuffer bb = this.connection.getBuffer();
/* 27575 */         ValreiFightHistory fight = ValreiFightHistoryManager.getInstance().getFight(fightId);
/* 27576 */         int totalActions = fight.getTotalActions() + 1;
/*       */         
/* 27578 */         HashMap<Long, ValreiFightHistory.ValreiFighter> fighters = fight.getFighters();
/*       */         
/* 27580 */         bb.put((byte)-62);
/* 27581 */         bb.put((byte)1);
/* 27582 */         bb.putLong(fight.getFightId());
/* 27583 */         bb.putLong(fight.getFightTime());
/*       */ 
/*       */ 
/*       */         
/* 27587 */         long fighter1 = ValreiConstants.getFightActionActor(fight.getFightAction(0));
/* 27588 */         long fighter2 = ValreiConstants.getFightActionActor(fight.getFightAction(1));
/* 27589 */         bb.putLong(fighter1);
/* 27590 */         sendByteStringLength(((ValreiFightHistory.ValreiFighter)fighters.get(Long.valueOf(fighter1))).getName(), bb);
/* 27591 */         bb.putLong(fighter2);
/* 27592 */         sendByteStringLength(((ValreiFightHistory.ValreiFighter)fighters.get(Long.valueOf(fighter2))).getName(), bb);
/*       */         
/* 27594 */         bb.putInt(totalActions);
/*       */ 
/*       */         
/* 27597 */         for (int i = 0; i < totalActions; i++) {
/*       */           
/* 27599 */           ValreiConstants.ValreiFightAction tempAction = fight.getFightAction(i);
/* 27600 */           bb.putShort(tempAction.getActionId());
/* 27601 */           bb.put((byte)(tempAction.getActionData()).length);
/* 27602 */           bb.put(tempAction.getActionData());
/*       */         } 
/*       */         
/* 27605 */         this.connection.flush();
/*       */       }
/* 27607 */       catch (Exception ex) {
/*       */         
/* 27609 */         logInfo(this.player.getName() + ':' + ex.getMessage(), ex);
/* 27610 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendCancelPlacingItem() {
/* 27617 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/* 27619 */       this.player.setPlacingItem(false);
/*       */       
/*       */       try {
/* 27622 */         ByteBuffer bb = this.connection.getBuffer();
/* 27623 */         bb.put((byte)-63);
/* 27624 */         bb.putLong(-10L);
/*       */         
/* 27626 */         this.connection.flush();
/*       */       }
/* 27628 */       catch (Exception ex) {
/*       */         
/* 27630 */         this.player.setLink(false);
/*       */       } 
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendPlaceItem(Item item) {
/* 27637 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 27641 */         long id = item.getWurmId();
/*       */         
/* 27643 */         ByteBuffer bb = this.connection.getBuffer();
/* 27644 */         bb.put((byte)-63);
/* 27645 */         bb.putLong(id);
/*       */         
/* 27647 */         byte[] tempStringArr = item.getName().getBytes("UTF-8");
/* 27648 */         bb.put((byte)tempStringArr.length);
/* 27649 */         bb.put(tempStringArr);
/* 27650 */         tempStringArr = item.getModelName().getBytes("UTF-8");
/* 27651 */         bb.put((byte)tempStringArr.length);
/* 27652 */         bb.put(tempStringArr);
/*       */         
/* 27654 */         bb.put(item.getMaterial());
/* 27655 */         bb.putFloat(item.getSizeMod());
/* 27656 */         bb.put(item.getRarity());
/*       */         
/* 27658 */         this.connection.flush();
/* 27659 */         if (logger.isLoggable(Level.FINER))
/*       */         {
/* 27661 */           logger.finer(this.player.getName() + " sent item to place " + item.getName() + " - " + item.getWurmId());
/*       */         }
/*       */       }
/* 27664 */       catch (Exception ex) {
/*       */         
/* 27666 */         logWarn("Failed to send item to place: " + this.player.getName() + ':' + item.getWurmId() + ", " + ex
/* 27667 */             .getMessage(), ex);
/* 27668 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_PLACE_ITEM(ByteBuffer bb) throws Exception {
/* 27675 */     long itemId = bb.getLong();
/* 27676 */     long parentId = bb.getLong();
/* 27677 */     float xPos = bb.getFloat();
/* 27678 */     float yPos = bb.getFloat();
/* 27679 */     float zPos = bb.getFloat();
/* 27680 */     float rotation = bb.getFloat();
/*       */     
/* 27682 */     MethodsItems.handlePlaceItem((Creature)this.player, itemId, parentId, xPos, yPos, zPos, rotation);
/*       */   }
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_OPENCLOSE_WINDOW(ByteBuffer bb) throws Exception {
/* 27687 */     boolean opened = (bb.get() == 0);
/* 27688 */     short windowId = bb.getShort();
/*       */     
/* 27690 */     switch (windowId) {
/*       */       
/*       */       case 20:
/* 27693 */         PlayerTutorial.firePlayerTrigger(this.player.getWurmId(), opened ? PlayerTutorial.PlayerTrigger.ENABLED_INVENTORY : PlayerTutorial.PlayerTrigger.DISABLED_INVENTORY);
/*       */         break;
/*       */       case 40:
/* 27696 */         if (opened)
/* 27697 */           PlayerTutorial.firePlayerTrigger(this.player.getWurmId(), PlayerTutorial.PlayerTrigger.ENABLED_CREATION); 
/*       */         break;
/*       */       case 26:
/* 27700 */         if (opened) {
/* 27701 */           PlayerTutorial.firePlayerTrigger(this.player.getWurmId(), PlayerTutorial.PlayerTrigger.ENABLED_CHARACTER);
/*       */         }
/*       */         break;
/*       */     } 
/*       */   }
/*       */   
/*       */   private void reallyHandle_CMD_PERSONAL_GOAL_LIST(ByteBuffer bb) throws Exception {
/* 27708 */     byte parentId, tutorialId, cmdType = bb.get();
/*       */     
/* 27710 */     switch (cmdType) {
/*       */       
/*       */       case 5:
/* 27713 */         parentId = bb.get();
/* 27714 */         tutorialId = bb.get();
/* 27715 */         if (parentId >= 0) {
/* 27716 */           PlayerTutorial.startNewTutorial(this.player, PlayerTutorial.TutorialType.values()[parentId], tutorialId); break;
/*       */         } 
/* 27718 */         PlayerTutorial.startNewTutorial(this.player, PlayerTutorial.TutorialType.values()[tutorialId], 0);
/*       */         break;
/*       */     } 
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendOpenWindow(short windowId, boolean blink) {
/* 27734 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 27738 */         ByteBuffer bb = this.connection.getBuffer();
/* 27739 */         bb.put((byte)-66);
/* 27740 */         bb.put((byte)0);
/* 27741 */         bb.putShort(windowId);
/* 27742 */         bb.put((byte)(blink ? 1 : 0));
/*       */         
/* 27744 */         this.connection.flush();
/*       */       }
/* 27746 */       catch (Exception ex) {
/*       */         
/* 27748 */         logWarn("Failed to send open window: " + this.player.getName() + ":" + windowId + ", " + ex.getMessage(), ex);
/* 27749 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendCloseWindow(short windowId) {
/* 27763 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 27767 */         ByteBuffer bb = this.connection.getBuffer();
/* 27768 */         bb.put((byte)-66);
/* 27769 */         bb.put((byte)1);
/* 27770 */         bb.putShort(windowId);
/*       */         
/* 27772 */         this.connection.flush();
/*       */       }
/* 27774 */       catch (Exception ex) {
/*       */         
/* 27776 */         logWarn("Failed to send close window: " + this.player.getName() + ":" + windowId + ", " + ex.getMessage(), ex);
/* 27777 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendToggleQuickbarBtn(short buttonId, boolean enabled) {
/* 27792 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 27796 */         ByteBuffer bb = this.connection.getBuffer();
/* 27797 */         bb.put((byte)-66);
/* 27798 */         bb.put(enabled ? 4 : 3);
/* 27799 */         bb.putShort(buttonId);
/*       */         
/* 27801 */         this.connection.flush();
/*       */       }
/* 27803 */       catch (Exception ex) {
/*       */         
/* 27805 */         logWarn("Failed to send toggle quickbar btn: " + this.player.getName() + ":" + buttonId + ", " + ex.getMessage(), ex);
/* 27806 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendToggleAllQuickbarBtns(boolean enabled) {
/* 27820 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 27824 */         ByteBuffer bb = this.connection.getBuffer();
/* 27825 */         bb.put((byte)-66);
/* 27826 */         bb.put(enabled ? 6 : 5);
/*       */         
/* 27828 */         this.connection.flush();
/*       */       }
/* 27830 */       catch (Exception ex) {
/*       */         
/* 27832 */         logWarn("Failed to send toggle all quickbar btn: " + this.player.getName() + ", " + ex.getMessage(), ex);
/* 27833 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void reallyHandle_CMD_FISH(ByteBuffer bb) throws Exception {
/*       */     float posX, posY;
/* 27845 */     byte subCommand = bb.get();
/* 27846 */     if (this.player.getPower() >= 5 && Servers.isThisATestServer())
/* 27847 */       sendNormalServerMessage("CMD_FISH<-" + MethodsFishing.fromCommand(subCommand)); 
/* 27848 */     switch (subCommand) {
/*       */ 
/*       */ 
/*       */       
/*       */       case 9:
/* 27853 */         posX = bb.getFloat();
/* 27854 */         posY = bb.getFloat();
/* 27855 */         MethodsFishing.fromClient((Creature)this.player, subCommand, posX, posY);
/*       */         return;
/*       */ 
/*       */       
/*       */       case 10:
/*       */       case 11:
/* 27861 */         MethodsFishing.fromClient((Creature)this.player, subCommand, -1.0F, -1.0F);
/*       */         return;
/*       */ 
/*       */ 
/*       */       
/*       */       case 27:
/* 27867 */         MethodsFishing.fromClient((Creature)this.player, subCommand, -1.0F, -1.0F);
/*       */         return;
/*       */ 
/*       */       
/*       */       case 26:
/* 27872 */         posX = bb.getFloat();
/* 27873 */         posY = bb.getFloat();
/* 27874 */         MethodsFishing.fromClient((Creature)this.player, subCommand, posX, posY);
/*       */         return;
/*       */     } 
/*       */ 
/*       */     
/* 27879 */     logWarn("Bad sub command for CMD_FISH: " + this.player.getName() + ':' + subCommand + ", ");
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendFishCasted(long playerId, float posX, float posY, byte floatType) {
/* 27887 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 27891 */         ByteBuffer bb = this.connection.getBuffer();
/* 27892 */         bb.put((byte)-64);
/* 27893 */         bb.put((byte)9);
/* 27894 */         bb.putLong(playerId);
/* 27895 */         bb.putFloat(posX);
/* 27896 */         bb.putFloat(posY);
/* 27897 */         bb.put(floatType);
/* 27898 */         this.connection.flush();
/* 27899 */         if (this.player.getPower() >= 5 && Servers.isThisATestServer()) {
/* 27900 */           sendNormalServerMessage("CMD_FISH->" + MethodsFishing.fromCommand((byte)9));
/*       */         }
/* 27902 */       } catch (Exception ex) {
/*       */         
/* 27904 */         logWarn("Failed to send rod casted for " + playerId + " : " + this.player.getName() + ':' + ", " + ex.getMessage(), ex);
/* 27905 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendSpearStrike(long playerId, float posX, float posY) {
/* 27912 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 27916 */         ByteBuffer bb = this.connection.getBuffer();
/* 27917 */         bb.put((byte)-64);
/* 27918 */         bb.put((byte)26);
/* 27919 */         bb.putLong(playerId);
/* 27920 */         bb.putFloat(posX);
/* 27921 */         bb.putFloat(posY);
/* 27922 */         this.connection.flush();
/* 27923 */         if (this.player.getPower() >= 5 && Servers.isThisATestServer()) {
/* 27924 */           sendNormalServerMessage("CMD_FISH->" + MethodsFishing.fromCommand((byte)26));
/*       */         }
/* 27926 */       } catch (Exception ex) {
/*       */         
/* 27928 */         logWarn("Failed to send rod casted for " + playerId + " : " + this.player.getName() + ':' + ", " + ex.getMessage(), ex);
/* 27929 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendFishStart(float minRadius, float maxRadius, byte rodType, byte rodMaterial, byte reelType, byte reelMaterial, byte floatType, byte baitType) {
/* 27948 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 27952 */         ByteBuffer bb = this.connection.getBuffer();
/* 27953 */         bb.put((byte)-64);
/* 27954 */         bb.put((byte)0);
/*       */         
/* 27956 */         bb.putFloat(minRadius);
/* 27957 */         bb.putFloat(maxRadius);
/* 27958 */         bb.put(rodType);
/* 27959 */         bb.put(rodMaterial);
/* 27960 */         bb.put(reelType);
/* 27961 */         bb.put(reelMaterial);
/* 27962 */         bb.put(floatType);
/* 27963 */         bb.put(baitType);
/* 27964 */         bb.put((byte)0);
/* 27965 */         this.connection.flush();
/* 27966 */         if (this.player.getPower() >= 5 && Servers.isThisATestServer()) {
/* 27967 */           sendNormalServerMessage("CMD_FISH->" + MethodsFishing.fromCommand((byte)0));
/*       */         }
/* 27969 */       } catch (Exception ex) {
/*       */         
/* 27971 */         logWarn("Failed to send start rod fishing: " + this.player.getName() + ':' + ", " + ex.getMessage(), ex);
/* 27972 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendFishBite(byte fishType, long fishId, long playerId) {
/* 27983 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 27987 */         ByteBuffer bb = this.connection.getBuffer();
/* 27988 */         bb.put((byte)-64);
/* 27989 */         bb.put((byte)1);
/* 27990 */         bb.putLong(playerId);
/* 27991 */         bb.put(fishType);
/* 27992 */         bb.putLong(fishId);
/* 27993 */         this.connection.flush();
/* 27994 */         if (this.player.getPower() >= 5 && Servers.isThisATestServer()) {
/* 27995 */           sendNormalServerMessage("CMD_FISH->" + MethodsFishing.fromCommand((byte)1));
/*       */         }
/* 27997 */       } catch (Exception ex) {
/*       */         
/* 27999 */         logWarn("Failed to send fish bite: " + this.player.getName() + ':' + ", " + ex.getMessage(), ex);
/* 28000 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendSpearHit(byte fishType, long fishId) {
/* 28010 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 28014 */         ByteBuffer bb = this.connection.getBuffer();
/* 28015 */         bb.put((byte)-64);
/* 28016 */         bb.put((byte)22);
/* 28017 */         bb.put(fishType);
/* 28018 */         bb.putLong(fishId);
/* 28019 */         this.connection.flush();
/* 28020 */         if (this.player.getPower() >= 5 && Servers.isThisATestServer()) {
/* 28021 */           sendNormalServerMessage("CMD_FISH->" + MethodsFishing.fromCommand((byte)22));
/*       */         }
/* 28023 */       } catch (Exception ex) {
/*       */         
/* 28025 */         logWarn("Failed to send spear hit: " + this.player.getName() + ':' + ", " + ex.getMessage(), ex);
/* 28026 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendFishSubCommand(byte subCommand, long playerId) {
/* 28040 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 28044 */         ByteBuffer bb = this.connection.getBuffer();
/* 28045 */         bb.put((byte)-64);
/* 28046 */         bb.put(subCommand);
/* 28047 */         bb.putLong(playerId);
/* 28048 */         this.connection.flush();
/* 28049 */         if (this.player.getPower() >= 5 && Servers.isThisATestServer()) {
/* 28050 */           sendNormalServerMessage("CMD_FISH->" + MethodsFishing.fromCommand(subCommand));
/*       */         }
/* 28052 */       } catch (Exception ex) {
/*       */         
/* 28054 */         logWarn("Failed to send fish sub command: " + this.player.getName() + ':' + ", " + ex.getMessage(), ex);
/* 28055 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendSpearStart() {
/* 28065 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 28069 */         ByteBuffer bb = this.connection.getBuffer();
/* 28070 */         bb.put((byte)-64);
/* 28071 */         bb.put((byte)20);
/*       */         
/* 28073 */         bb.put((byte)0);
/* 28074 */         this.connection.flush();
/* 28075 */         if (this.player.getPower() >= 5 && Servers.isThisATestServer()) {
/* 28076 */           sendNormalServerMessage("CMD_FISH->" + MethodsFishing.fromCommand((byte)20));
/*       */         }
/* 28078 */       } catch (Exception ex) {
/*       */         
/* 28080 */         logWarn("Failed to send start spear fishing: " + this.player.getName() + ':' + ", " + ex.getMessage(), ex);
/* 28081 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendSpearStrike(float posX, float posY) {
/* 28093 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 28097 */         ByteBuffer bb = this.connection.getBuffer();
/* 28098 */         bb.put((byte)-64);
/* 28099 */         bb.put((byte)26);
/* 28100 */         bb.putFloat(posX);
/* 28101 */         bb.putFloat(posY);
/* 28102 */         this.connection.flush();
/* 28103 */         if (this.player.getPower() >= 5 && Servers.isThisATestServer()) {
/* 28104 */           sendNormalServerMessage("CMD_FISH->" + MethodsFishing.fromCommand((byte)26));
/*       */         }
/* 28106 */       } catch (Exception ex) {
/*       */         
/* 28108 */         logWarn("Failed to send spear strike: " + this.player.getName() + ':' + ", " + ex.getMessage(), ex);
/* 28109 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */   
/*       */   public void sendPersonalJournalTier(byte tierId, String tierName, String tierHover, boolean tierCompleted, int[] achievementIds, boolean[] achievementsCompleted) {
/* 28117 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 28121 */         ByteBuffer bb = this.connection.getBuffer();
/* 28122 */         bb.put((byte)-39);
/* 28123 */         bb.put((byte)1);
/* 28124 */         bb.put(tierId);
/* 28125 */         bb.put(tierCompleted ? 1 : 0);
/* 28126 */         sendShortStringLength(tierName, bb);
/* 28127 */         sendShortStringLength(tierHover, bb);
/* 28128 */         bb.putInt(achievementIds.length);
/* 28129 */         for (int i = 0; i < achievementIds.length; i++) {
/*       */           
/* 28131 */           AchievementTemplate temp = Achievement.getTemplate(achievementIds[i]);
/* 28132 */           if (temp == null) {
/*       */             
/* 28134 */             logger.warning("AchievementTemplate for ID# " + achievementIds[i] + " is null");
/*       */           }
/*       */           else {
/*       */             
/* 28138 */             bb.putInt(temp.getNumber());
/* 28139 */             sendShortStringLength(temp.getName(), bb);
/* 28140 */             boolean completed = (achievementsCompleted[i] || tierCompleted);
/* 28141 */             sendShortStringLength(completed ? temp.getDescription() : temp.getRequirement(), bb);
/* 28142 */             bb.put(completed ? -1 : (byte)(int)(temp.getProgressFor(this.player.getWurmId()) * 100.0F));
/*       */           } 
/* 28144 */         }  this.connection.flush();
/*       */       }
/* 28146 */       catch (Exception ex) {
/*       */         
/* 28148 */         logWarn("Failed to send journal tier addition: " + this.player.getName() + ':' + ", " + ex.getMessage(), ex);
/* 28149 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendPersonalJournalTierUpdate(byte tierId, boolean tierCompleted, String tierHover) {
/* 28156 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 28160 */         ByteBuffer bb = this.connection.getBuffer();
/* 28161 */         bb.put((byte)-39);
/* 28162 */         bb.put((byte)2);
/* 28163 */         bb.put(tierId);
/* 28164 */         bb.put(tierCompleted ? 1 : 0);
/* 28165 */         sendShortStringLength(tierHover, bb);
/* 28166 */         this.connection.flush();
/*       */       }
/* 28168 */       catch (Exception ex) {
/*       */         
/* 28170 */         logWarn("Failed to send journal tier update: " + this.player.getName() + ':' + ", " + ex.getMessage(), ex);
/* 28171 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendPersonalJournalAchvUpdate(byte tierId, int achievementId, boolean achievementCompleted) {
/* 28178 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 28182 */         AchievementTemplate temp = Achievement.getTemplate(achievementId);
/* 28183 */         if (temp == null)
/*       */           return; 
/* 28185 */         byte progress = (byte)(int)(temp.getProgressFor(this.player.getWurmId()) * 100.0F);
/*       */         
/* 28187 */         ByteBuffer bb = this.connection.getBuffer();
/* 28188 */         bb.put((byte)-39);
/* 28189 */         bb.put((byte)3);
/* 28190 */         bb.putInt(achievementId);
/* 28191 */         sendShortStringLength(temp.getName(), bb);
/* 28192 */         sendShortStringLength(achievementCompleted ? temp.getDescription() : temp.getRequirement(), bb);
/* 28193 */         bb.put((achievementCompleted || progress >= 100) ? -1 : progress);
/* 28194 */         this.connection.flush();
/*       */       }
/* 28196 */       catch (Exception ex) {
/*       */         
/* 28198 */         logWarn("Failed to send journal tier update: " + this.player.getName() + ':' + ", " + ex.getMessage(), ex);
/* 28199 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */   
/*       */   public void sendPersonalJournalTutorial(byte parentId, byte tutorialId, String tutName) {
/* 28206 */     if (this.player != null && this.player.hasLink()) {
/*       */       
/*       */       try {
/*       */         
/* 28210 */         ByteBuffer bb = this.connection.getBuffer();
/* 28211 */         bb.put((byte)-39);
/* 28212 */         bb.put((byte)4);
/* 28213 */         bb.put(parentId);
/* 28214 */         bb.put(tutorialId);
/* 28215 */         sendShortStringLength(tutName, bb);
/* 28216 */         this.connection.flush();
/*       */       }
/* 28218 */       catch (Exception ex) {
/*       */         
/* 28220 */         logWarn("Failed to send journal tutorial: " + this.player.getName() + ':' + ", " + ex.getMessage(), ex);
/* 28221 */         this.player.setLink(false);
/*       */       } 
/*       */     }
/*       */   }
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */   
/*       */   private void handleGetStoredCreatures(String message) {
/* 28233 */     String msgHelp = "Examples  #getStoredCreatures <Creature Actual Name (E.g. Dalehard or Bison)>. #getStoredCreatures <Creature Template Name(E.g. Foal or Bull)>. #getStoredCreatures * this is a wildcard and will display all creatures.";
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */     
/*       */     try {
/* 28241 */       if (this.player.getLogger() != null) {
/* 28242 */         this.player.getLogger().info(message);
/*       */       }
/* 28244 */       StringTokenizer tokens = new StringTokenizer(message);
/* 28245 */       tokens.nextToken();
/* 28246 */       String name = tokens.nextToken().trim();
/* 28247 */       if (name.equals("help"))
/*       */       {
/* 28249 */         sendNormalServerMessage(msgHelp);
/*       */       }
/* 28251 */       if (name.equals(""))
/*       */       {
/* 28253 */         sendNormalServerMessage(msgHelp);
/*       */       }
/* 28255 */       for (Item item : Items.getAllItems()) {
/*       */         
/* 28257 */         if (item.getData() != -10L) {
/*       */           
/* 28259 */           if (item.getTemplateId() == 1310)
/*       */           {
/* 28261 */             if (item.isInside(new int[] { 1311 }))
/*       */             {
/*       */               
/*       */               try {
/* 28265 */                 Creature getCreature = Creatures.getInstance().getCreature(item.getData());
/* 28266 */                 String templateNameWithoutSpace = getCreature.getTemplate().getName().trim().replaceAll("\\s", "");
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */ 
/*       */                 
/* 28282 */                 String fm = "Found " + getCreature.getName() + " Color = " + getCreature.getColourName() + ", WurmID for stored creature item = " + item.getWurmId() + ", Parent WurmID = " + item.getParent().getWurmId() + ", Parent Name = " + item.getParent().getName() + ", Parent Type = " + item.getParent().getTemplate().getName() + ", TileX = " + item.getTileX() + ", TileY = " + item.getTileY();
/* 28283 */                 if (templateNameWithoutSpace.equals(name))
/*       */                 {
/* 28285 */                   sendNormalServerMessage(fm);
/*       */                 }
/* 28287 */                 else if (getCreature.getNameWithoutPrefixes().equals(name))
/*       */                 {
/* 28289 */                   sendNormalServerMessage(fm);
/*       */                 }
/* 28291 */                 else if (name.equals("*"))
/*       */                 {
/* 28293 */                   sendNormalServerMessage(fm);
/*       */                 }
/*       */               
/* 28296 */               } catch (NoSuchCreatureException|NoSuchItemException nsce) {
/*       */                 
/* 28298 */                 String msg = nsce.getMessage() + item.getTileX() + ", " + item.getTileY();
/* 28299 */                 logger.log(Level.WARNING, msg);
/*       */               }
/*       */             
/*       */             }
/*       */             else
/*       */             {
/* 28305 */               String msg = "Found Stored Creature outside of cage. " + item.getTileX() + ", " + item.getTileY();
/* 28306 */               logger.log(Level.WARNING, msg);
/* 28307 */               sendNormalServerMessage(msg);
/*       */             }
/*       */           
/*       */           }
/*       */         } else {
/*       */           
/* 28313 */           String msg = "Found Stored Creature with NOID. " + item.getTileX() + ", " + item.getTileY();
/* 28314 */           logger.log(Level.WARNING, msg);
/* 28315 */           sendNormalServerMessage(msg);
/*       */         }
/*       */       
/*       */       } 
/* 28319 */     } catch (NoSuchElementException ex) {
/*       */       
/* 28321 */       sendNormalServerMessage(msgHelp);
/*       */     } 
/*       */   }
/*       */ 
/*       */   
/*       */   private void handleDestroyAllCreatures() {
/* 28327 */     if (!Servers.isThisATestServer()) {
/*       */       
/* 28329 */       sendNormalServerMessage("This command can only be ran on a test server.");
/*       */       return;
/*       */     } 
/* 28332 */     if (this.player.getPower() < 5) {
/*       */       
/* 28334 */       sendNormalServerMessage("You lack the required power level to execute this command.");
/*       */       
/*       */       return;
/*       */     } 
/*       */     try {
/* 28339 */       int count = 0;
/* 28340 */       for (Creature cret : Creatures.getInstance().getCreatures()) {
/*       */         
/* 28342 */         if (!cret.isPlayer()) {
/*       */           
/* 28344 */           cret.destroy();
/* 28345 */           count++;
/*       */         } 
/*       */       } 
/* 28348 */       sendNormalServerMessage("Destroyed " + count + " creatures.");
/*       */     }
/* 28350 */     catch (NoSuchElementException ex) {
/*       */       
/* 28352 */       ex.printStackTrace();
/*       */     } 
/*       */   }
/*       */ }


/* Location:              C:\Users\leo\Desktop\server.jar!\com\wurmonline\server\creatures\Communicator.class
 * Java compiler version: 8 (52.0)
 * JD-Core Version:       1.1.3
 */